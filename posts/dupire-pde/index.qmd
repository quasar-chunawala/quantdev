---
title: "A short note on the Dupire PDE"
author: "Quasar"
date: "2025-10-01"
categories: [Volatility Modeling]      
image: "image.jpg"
toc: true
toc-depth: 3
---

# Introduction

If the Black-Scholes model were good, the implied volatility $\hat{\sigma}$ parameter would be the same for all call option market prices. However, in reality, Black-Scholes implied volatility depends strongly on strike $K$, and maturity $T$. 

In Dupire's 1993 paper, he proposes the following dynamics for the spot process:

$$
dS_t = r(t)S_t dt + \sigma_{LV}(t, S_t) S_t dW_t^{Q}
$$ {#eq-local-volatility-model}

where $\sigma_{LV}(t,S_t)$ is a deterministic function of the variables $(S_t,t)$.

The function $\sigma_{LV}(t,s)$ such that the call option prices are given by the model in @eq-local-volatility-model coinicide with the market option prices $\hat{C}(K,T)$ is called **local volatility**.

# Derivation of the Dupire PDE

Recall, that the Fokker-Planck PDE describes the dynamics of the transition probability density forward in time. We represent the transition probability density function by $p(x,t)$. Were we to be more rigorous, we should write $p(x,t|x_0, t_0)$. The call option price has a similar representation. It is a function of strike $K$ and expiration $T$, given the current spot value $S_t$ and current time $t$. So, its a function $C(K,T | S_t, t)$; we can suppress the variables $(S_t, t)$ and write $C(K,T)$. This is standard terminology in the industry. 

The call option payoff at maturity $T$ is given by:

$$
\begin{aligned}
C(K,T|S_T,T) = (S_T - K)^{+}
\end{aligned}
$$

We can't exactly apply Ito's formula, but there is the Tanaka-Meyer formula - an implication of which is that we can use Ito's lemma for the absolute value function and the maximum function.  

$$
\begin{aligned}
d(S_T - K)^{+} &= \frac{\partial }{\partial S_T}(S_T - K)^{+}dS_T + \frac{1}{2}\frac{\partial^2}{\partial S_T^2} (S_T - K)^{+} dS_T^2 
\end{aligned}
$$

We can write:

$$
\begin{align*}
\frac{\partial}{\partial S_T}(S_T - K)^{+} = 1_{S_T > K} \frac{\partial}{\partial S_T} (S_T - K) = 1_{S_T > K}
\end{align*}
$$

Now, we calculate the second derivative:

$$
\begin{align*}
\frac{\partial}{\partial^2 S_T}(S_T - K)^{+} = \frac{\partial}{\partial S_T} 1_{S_T > K} = \delta(S_T - K)
\end{align*}
$$

The indicator function goes from $0$ to $1$ at $K$, so the derivative at $K$ is $\infty$ and $0$ otherwise, and this is basically the definition of the Dirac-Delta function. Now, we can substitute these derivatives into the Tanaka formula and get:

$$
\begin{align*}
d(S_T - K)^{+} &= 1_{S_T > K} dS_T + \frac{1}{2}\delta(S_T - K)dS_T^2 
\end{align*}
$$

Next, let's calculate the partial derivatives of the payoff with respect to $K$. We have:

$$
\begin{align*}
\frac{\partial}{\partial K}(S_T - K)^{+} = 1_{S_T > K} \frac{\partial}{\partial K} (S_T - K) = -1_{S_T > K}
\end{align*}
$$

Differentiating this result again with respect to $K$:

$$
\begin{align*}
\frac{\partial^2}{\partial K^2} (S_T - K)^{+} &= - \frac{\partial}{\partial K} 1_{S_T > K} \\
&= -\frac{\partial}{\partial K}1_{S_T - K > 0} \\
&= -\frac{\partial}{\partial K}H(S_T - K) 
\end{align*}
$$

Define $y = (S_T - K)$. We have:

$$
\begin{align*}
\frac{\partial^2}{\partial K^2} (S_T - K)^{+} &=  -\frac{\partial}{\partial K}H(S_T - K) \\
&=-\frac{\partial H(y)}{\partial y}\cdot \frac{\partial y}{\partial K}\\
&=-\delta(y)\frac{\partial}{\partial K}(S_T - K)\\
&=\delta(S_T - K)
\end{align*}
$$

Now, substituting for $dS_T$ and $dS_T^2$ in Ito's lemma, we have:

$$
\begin{align*}
d(S_T - K)^{+} &= 1_{S_T > K}(rS_T dT + \sigma(S_T, T)S_TdW_T) + \frac{1}{2}\delta(S_T - K) \sigma(S_T,T)^2 S_T^2 dT\\
&= \left(rS_T 1_{S_T > K} + \frac{1}{2}\delta(S_T - K)\sigma(S_T,T)^2 S_T^2 \right)dT + 1_{S_T > K} \sigma(S_T, T) S_T dW_T
\end{align*}
$$

Taking expectations on both sides, the $dB_T$ becomes zero. So, we have:

$$
\begin{align*}
\mathbb{E}^{\mathbb{Q}}\left[d(S_T - K)^{+}\right] =\mathbb{E}^{Q}\left[rS_T1_{S_T > K} + \frac{1}{2}\sigma(S_T,T)^2 S_T^2\right]dT
\end{align*}
$$

We are left with just the $dT$ term. Now, we can shift $dT$ to the LHS (interchange expectation and the derivative) to get:

$$
\begin{align*}
\frac{\partial}{\partial T}\mathbb{E}^{Q}\left[d(S_T - K)^{+}\right] &=\mathbb{E}^{Q}\left[rS_T1_{S_T > K} + \frac{1}{2}\sigma(S_T,T)^2 S_T^2\right]\\
&= rS_T \mathbb{E}^{Q}\left[1_{S_T > K}\right] + \frac{1}{2}\mathbb{E}^{Q}\left[\sigma(S_T,T)^2 S_T^2\right]
\end{align*}
$$

Let's try to express the first term on the RHS by the call option price. We can write the payoff as:

$$
\begin{align*}
(S_T - K)1_{S_T > K}  = S_T 1_{S_T > K} - K 1_{S_T > K}
\end{align*}
$$

Now, we can rearrange the terms to get what we want:

$$
\begin{align*}
S_T1_{S_T > K} = (S_T - K) 1_{S_T > K} + K1_{S_T > K}
\end{align*}
$$

We now take expectation on both sides, so we get:

$$
\begin{align*}
\mathbb{E}^Q[S_T 1_{S_T > K}] &= \mathbb{E}^{Q}[(S_T - K)1_{S_T > K}] + K\mathbb{E}^{Q}[1_{S_T > K}]
\end{align*}
$$

Recall that:

$$
\begin{align*}
C_{K,T} &= e^{-rT} \mathbb{E}^{Q}[(S_T - K)1_{S_T > K}] \\
\implies e^{rT} C(K,T) &= \mathbb{E}^{Q}[(S_T - K)1_{S_T > K}] 
\end{align*}
$$

So, our first expression is then the undiscounted value of the call option. Now, the second expression has got the indicator or the heavyside function, which we know is the derivative of the payoff. Let's reproduce the risk-neutral valuation formula. 

$$
\begin{align*}
\frac{\partial}{\partial K} C_{K,T} &= e^{-rT} \mathbb{E}^{Q}\left[\frac{\partial}{\partial K} (S_T - K)^{+}\right]\\
&= - e^{-rT} \mathbb{E}^{Q}[1_{S_T > K}]
\end{align*}
$$ {#eq-first-derivative-wrt-strike}

So, we can replace the second expectation term $\mathbb{E}^{Q}[1_{S_T > K}]$ by $-e^{rT}\frac{\partial C_{K,T}}{\partial K}$. So, we have:

$$
\begin{align*}
\mathbb{E}^Q[S_T 1_{S_T > K}] &= e^{rT}C(K,T) - Ke^{rT}\frac{\partial C}{\partial K} 
\end{align*}
$$

Let's move to the second expectation term:

$$
\begin{align*}
\frac{\partial}{\partial T}\mathbb{E}^{Q}\left[d(S_T - K)^{+}\right] &= re^{rT}C(K,T) - rKe^{rT}\frac{\partial C}{\partial K} + \frac{1}{2}\mathbb{E}^Q\left[\sigma(T,S_T)^2 S_T^2 \delta(S_T - K)\right]
\end{align*}
$$ {#eq-primary-expression-2}

We know that:

$$
\begin{align*}
\mathbb{E}[X | Y=y_0] &= \int_{-\infty}^{\infty} x f_{X|Y=y_0}(x) dx\\
&=\int_{\mathbb{R}} x \frac{f_{X,Y}(x,y_0)}{f_Y(y_0)} dx\\
&= \int_{\mathbb{R}} x \frac{\int_{\mathbb{R}}1_{Y=y_0}f_{X,Y}(x,y)dy}{f_Y(y_0)} dx\\
&= \frac{\int\int_{\mathbb{R}^2}xf_{X,Y}(x,y)\cdot 1_{Y=y_0}dx dy}{\int_{R}f_{X,Y}(x,y_0) dx}\\
&= \frac{\int\int_{\mathbb{R}^2}xf_{X,Y}(x,y)\cdot 1_{Y=y_0}dx \cdot dy}{\int \int_{\mathbb{R}^2}1_{Y=y_0} \cdot f_{X,Y}(x,y) dx \cdot dy}\\
&= \frac{\mathbb{E}[X\cdot 1_{Y=y_0}]}{\mathbb{E}[1_{Y=y_0}]}
\end{align*}
$$

So, 

$$
\mathbb{E}[X | Y=y_0] \cdot \mathbb{E}[1_{Y=y_0}] = \mathbb{E}[X\cdot 1_{Y=y_0}]
$$

Using this result, we may write:

$$
\begin{align*}
\mathbb{E}^Q [\sigma(T,S_T)^2 S_T^2 \delta(S_T - K)] &= \mathbb{E}^Q[\sigma(T,S_T)^2 S_T^2 | S_T = K] \cdot \mathbb{E}^Q[\delta(S_T - K)]\\
&= K^2 \mathbb{E}^Q[\sigma(T,S_T)^2 | S_T = K]  \cdot \mathbb{E}^Q[\delta(S_T - K)]
\end{align*}
$$ {#eq-intermediate-result-1}

Now, taking the second derivative of the call option price with respect to the strike $K$, we have:

$$
\begin{align*}
C_{K,T} &= e^{-rT}\mathbb{E}^Q[(S_T - K)^{+}]\\
\frac{\partial^2 C}{\partial K^2}  &= e^{-rT}\mathbb{E}^Q\left[\frac{\partial^2}{\partial K^2} (S_T - K)^{+}\right]\\
&= e^{-rT} \mathbb{E}^Q[\delta(S_T - K)]\\
e^{rT}\frac{\partial^2 C_{K,T}}{\partial K^2} &= \mathbb{E}^Q[\delta(S_T - K)]
\end{align*}
$$ {#eq-second-derivative-wrt-strike}

So, the second expression in the RHS of @eq-intermediate-result-1 becomes:

$$
\begin{align*}
\mathbb{E}^Q [\sigma(T,S_T)^2 S_T^2 \delta(S_T - K)]  &= K^2 \mathbb{E}^Q[\sigma(T,S_T)^2 | S_T = K]  \cdot \mathbb{E}^Q[\delta(S_T - K)] \\
&= K^2 \mathbb{E}^Q[\sigma(T,S_T)^2 | S_T = K]  \cdot e^{rT} \frac{\partial^2 C}{\partial K^2} 
\end{align*}
$$

So, our primary expression in @eq-primary-expression-2 becomes:

$$
\begin{align*}
\frac{\partial}{\partial T}\mathbb{E}^Q[(S_T - K)^+] &= re^{rT} C(K,T) - rKe^{rT} \frac{\partial C}{\partial K} \\&+ \frac{1}{2}K^2 \mathbb{E}^Q[\sigma(T,S_T)^2 | S_T = K]  \cdot e^{rT} \frac{\partial^2 C}{\partial K^2} 
\end{align*}
$$ {#eq-time-derivative}

Let $C^u(K,T|S,t)$ denote the undiscounted call option price. Since $C^u(K,T|S,t) = \mathbb{E}^Q[(S_T - K)^{+}]$, we can write the above PDE as:

$$
\begin{align*}
\frac{\partial C^u_{K,T}}{\partial T}&= rC^u_{K,T} - rK \frac{\partial C^u_{K,T}}{\partial K} \\&+ \frac{1}{2}K^2 \mathbb{E}^Q[\sigma(T,S_T)^2 | S_T = K]  \cdot \frac{\partial^2 C^u_{K,T}}{\partial K^2} 
\end{align*}
$$

Rearranging we have:

$$
\begin{align*}
\mathbb{E}^Q[\sigma(T, S_T)^2 | S_T = K] 
= \frac{\frac{\partial C^u_{K,T}}{\partial T} + rK\frac{\partial C^u_{K,T}}{\partial K} - rC^u_{K,T}}{\frac{1}{2}K^2 \frac{\partial^2 C^u_{K,T}}{\partial K^2}}
\end{align*}
$$ {#eq-dupire-formula-in-terms-of-undiscounted-call-option-price-1}

$\sigma^2(S_T, T)$ is the instantaneous variance at $(S_T,T)$. We can write it's conditional expectation as a function of the variables $(K,T)$, since it is an integral over the state space of $S_T$, so $S_T$ is integrated out and we will have a function of $K$ for each $T$.

### The theory of local volatility

::: {#def-local-volatility}
### Local Volatility

The local variance $\sigma_{K,T}^2(S_t,t)$ is defined as the reisk-neutral expectation of the squared instantaneous volatility at $(S_T,T)$ conditional on $S_T = K$ and time $t$ information $\mathcal{F}_t$:

$$
\boxed{\sigma_{K,T}^2(S_t,t) \stackrel{def}{=} \mathbf{E}^{Q}[\sigma^2(S_T,T,\cdot)|S_T = K, \mathcal{F}_t]= \int_{-\infty}^{\infty} \sigma(s,T)^2 f_{S_T|S_T = K}(s) ds}
$$

Then local volatility is given by:

$$
\sigma_{K,T} \stackrel{def}{=} \sqrt{\sigma_{K,T}^2(S_t,t)}
$$
:::

Thus, intuitively, we can think of the local volatility $\sigma_{K,T}(S_t,t)$ is the market's consensus for instantaneous volatility for a market level $K$ at some future date $T$. Since, it is implied from the observed option prices, the LVS gives the fair value of the asset price volatility for future market levels and times. 

This definition of local volatility has two implications: first, the use market's view on future volatility expressed by the expectation operator clarifies that all sources of risk from stochastic volatility are integrated out. Instead, the evolution of volatility is compressed into a single funtion that is deterministic in $S_t,t$.

To put it differently, the concept of local volatility assumes 

So, we have:

$$
\boxed{
    \sigma_{LV}^2(K,T) = \frac{\frac{\partial C^u_{K,T}}{\partial T} + rK\frac{\partial C^u_{K,T}}{\partial K} - rC^u_{K,T}}{\frac{1}{2}K^2 \frac{\partial^2 C^u_{K,T}}{\partial K^2}}
}
$$ {#eq-dupire-formula-in-terms-of-undiscounted-call-option-price}

We can also relabel the parameters to define the function in terms of time $t$ and stock price $S$:

$$
\boxed{
    \mathbb{E}^Q[\sigma(t, S)^2 | S_t = S] = \sigma_{LV}^2(K,T) |_{K=S, T=t} =\left.\frac{\frac{\partial C^u_{K,T}}{\partial T} + rK\frac{\partial C^u_{K,T}}{\partial K} - rC^u_{K,T}}{\frac{1}{2}K^2 \frac{\partial^2 C^u_{K,T}}{\partial K^2}}\right\vert_{K=S,T=t}
}
$$ {#eq-dupire-formula-in-time-and-stock-price-terms}

## Digression - Breeden-Litzenberger Formula

Assume that $(S_t,t\geq 0)$ is a markov process with the density $p(t,s,T,S_T)$ conditioned on $S_t = s$. Then:

$$
\begin{align*}
C(s,t,T,K) &= e^{-r(T-t)}\int_0^\infty p(t,s,T,S_T) (S_T - K)^{+} dS_T \\
&=  e^{-r(T-t)}\int_K^\infty p(t,s,T,y) (y - K) dy \\
\end{align*}
$$ {#eq-first-derivative-of-call-option-price}

Differentiating with respect to $K$, we have:

$$
\begin{align*}
\frac{\partial C}{\partial K} &= e^{-r(T-t)}\left[\left.p(t,s,T,y) (y - K)\right\vert_{y=\infty} - \left.p(t,s,T,y) (y - K)\right\vert_{y=K} + \int_{K}^\infty p(t,s,T,y) \frac{\partial}{\partial K}(y-k)dy\right] \\
&= -e^{-r(T-t)} \int_{K}^\infty p(t,s,T,y) dy
\end{align*}
$$

Differentiating again with respect to $K$ and applying the Leibnitz rule:

$$
\begin{align*}
\frac{\partial^2 C}{\partial K^2} &= - e^{-r(T-t)} [ p(t,s,T,y)|_{y=\infty} -  p(t,s,T,y)|_{y=K}]\\
&= e^{-r(T-t)}p(t,s,T,K)
\end{align*}
$$

Finally, we have:

$$
\boxed{\frac{\partial^2 C}{\partial K^2} = e^{-r(T-t)}p(t,s,T,K)}
$$ {#eq-breeden-litzenberger-formula}


[Breeden & Litzenberger(1978)](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2642349), showed that this second-order partial derivative can be used to approximate the option-implied risk-neutral probability that the underlying asset price $S$ will be equal to the strike $K$ at maturity.

## No-arbitrage conditions

The volatility surface, or equivalently the Call prices surface cannot have any arbitrary shape. Peter Carr has shown that static arbitrage is avoided in a set of option prices, if the calendar spread and butterfly spread arbitrages are avoided.

### Calendar spread condition

Calendar spread arbitrage is usually expressed as the monotonicity of the European call option prices $C$ with respect to the maturity $T$. I closely follow the derivation in [Fengler(2005)](https://core.ac.uk/reader/6978470).

::: {#prp-calendar-spread}

### Calendar Arbitrage

Define forward-moneyness $k \stackrel{def}{=} K/F(t,T)$, where the forward price is given by $F(t,T) = S_t e^{\int_t^T r(u)du}$ and total variance as $\nu^2(k,\tau) = \hat{\sigma}^2(k,\tau)\tau$.

If $\nu^2(k,\tau_i)$ is a strictly increasing function of $\tau_i = T_i - t$, $i=1,2$, there is no calendar arbitrage.
:::

*Proof.*

Given two expiry dates $t < T_1 < T_2$, construct in $t$, the following calendar spread in two calls with the same forward-moneyness: a long position in a call $C_t(K_2, T_2)$ and a short position in $C_t(K_1,T_1)$ call. The forward-moneyness requirement implies that:

$$
\begin{align*}
\frac{K_1}{F(t,T_1)} &= \frac{K_2}{F(t,T_2)}\\
K_1 &= e^{-\int_{T_1}^{T_2}r(u)du} K_2
\end{align*}
$$ {#eq-forward-moneyness-condition}

In $T_1$, if $S_{T_1} \leq K_1$ the short option position struck at $K_1$ expires worthless while $C_{T_1}(K_2,T_2)\geq 0$, because it still has some time-value of money. Otherwise, the entire portfolio is worth $C_{T_1}(K_2,T_2) - (S_{T_1} - K_1)$. But, @eq-forward-moneyness-condition implies that the portfolio is worth $C_{T_1}(K_2,T_2) -  (S_{T_1} - K_2 e^{-\int_{T_1}^{T_2} r(u) du})$ which equals $P_{T_1}(K_2,T_2)$ by put-call parity. Thus, the payoff of this portfolio is always non-negative. 

In order to preclude arbitrage, at time $t \leq T_1 < T_2$ we must have:

$$
\begin{align*}
C_t(K_2,T_2) - C_t(K_1,T_1) &> 0\\
C_t(K_2,T_2) &> C_t(K_1,T_1)
\end{align*}
$$ 

Multiplying by $e^{\int_0^{T_2} r_u du}$ and dividing by $K_2$ yields:

$$
\begin{align*}
\frac{e^{\int_0^{T_2} r_u du}C_t(K_2,T_2)}{K_2} &> \frac{e^{\int_0^{T_2} r_u du}C_t(K_1,T_1)}{K_2}\\
&= \frac{e^{\int_0^{T_2} r_u du}C_t(K_1,T_1)}{K_1 e^{\int_{T_1}^{T_2}r_u du}}\\
\end{align*}
$$

So, we have the condition:

$$
\begin{align*}
\boxed{\frac{e^{\int_0^{T_2} r_u du}C_t(K_2,T_2)}{K_2} >  \frac{e^{\int_0^{T_1} r_u du}C_t(K_1,T_1)}{K_1}}
\end{align*}
$$ {#eq-undiscounted-call-option-price-scaled-by-strike}

Finally, we observe that the function:

$$
\begin{align*}
f(k,\nu^2) &\stackrel{def}{=} \frac{e^{\int_{0}^T r_u du}C_t^{BS}(K,T)}{K}\\
&= \frac{F(0,T)\Phi(d_{+})}{K} - \Phi(d_{-})\\
&= k^{-1}\Phi(d_{+}) - \Phi(d_{-})
\end{align*}
$$

is a function in $k$ and $\nu^2$ only, and, for a fixed $k$, is a strictly monotone increasing function in $\nu^2$, since 

$$
\begin{align*}
d_{\pm} &= \frac{\ln(\frac{1}{k})\pm \frac{\nu^2}{2}}{\sqrt{\nu^2}}\\
\frac{\partial d_{+}}{\partial \nu^2} &=\frac{\sqrt{\nu^2} \cdot \frac{1}{2} - \left(-\ln k + \frac{\nu^2}{2}\right)\cdot \frac{1}{2\sqrt{\nu^2}}}{\nu^2}\\
&= \frac{\frac{\sqrt{\nu^2}}{2} - \frac{d_{+}}{2}}{\nu^2}\\
\frac{\partial d_{-}}{\partial \nu^2} &= \frac{-\frac{\sqrt{\nu^2}}{2} - \frac{d_{-}}{2}}{\nu^2}\\
\frac{\partial d_{+}}{\partial \nu^2} - \frac{\partial d_{-}}{\partial \nu^2} &= \frac{1}{2\sqrt{\nu^2}}
\end{align*}
$$

Also observe that:

$$
\begin{align*}
\frac{\phi(d_{+})}{\phi(d_{-})} &= \exp\left[-\frac{1}{2}(d_{+}^2 - d_{-}^2)\right]\\
&= \exp\left[-\frac{1}{2}(d_{+} + d_{-})(d_{+} - d_{-})\right]\\
&= \exp\left[-\frac{1}{2}\left(\frac{-\ln k + \nu^2/2}{\sqrt{\nu^2}} + \frac{-\ln k - \nu^2/2}{\sqrt{\nu^2}}\right)\left(\frac{-\ln k + \nu^2/2}{\sqrt{\nu^2}} - \frac{-\ln k - \nu^2/2}{\sqrt{\nu^2}}\right)\right]\\
&= \exp\left[\left(\frac{\ln k}{\sqrt{\nu^2}}\right)\sqrt{\nu^2}\right]\\
&= k
\end{align*}
$$

So, $\phi(d_{+}) = k \phi(d_{-})$. Also, recall that $d_{+} = d_{-} + \sqrt{\nu^2}$. Putting it all together, we have:

$$
\begin{align*}
\frac{\partial f}{\partial \nu^2} &= k^{-1}\phi(d_{+}) (\partial d_{+}/\partial \nu^2) - \phi(d_{-})(\partial d_{-}/\partial \nu^2) \\
&= \phi(d_{-}) \cdot \left(\frac{\partial d_{+}}{\partial \nu^2} - \frac{\partial d_{-}}{\partial \nu^2}\right)\\
&= \phi(d_{-})\frac{1}{2\sqrt{\nu^2}} > 0, \quad \forall \nu^2 \in (0,\infty)
\end{align*}
$$

We conclude that $f$ is strictly monotonically increasing in $\nu^2$. So, if total variance $\nu^2 = \sigma^2(k,\tau)$ is increasing, $f(k,\nu^2)$, that is the undiscounted call option price scaled by the strike price $K$ is increasing and from @eq-undiscounted-call-option-price-scaled-by-strike, it follows that there is no calendar arbitrage. 

The equation @eq-undiscounted-call-option-price-scaled-by-strike is the discrete version of the calendar spread no-arbitrage condition. We can also 
$\blacksquare$

### Butterfly spread arbitrage

We can write:

$$
\begin{align*}
\frac{\partial^2 C}{\partial K^2} = \lim_{\epsilon \to 0} \frac{C(K-\epsilon,T) - 2C(K,T) + C(K+\epsilon, T)}{\epsilon^2}
\end{align*}
$$

Consider the European payoff consisting of $\frac{1}{\epsilon^2}$ calls of strike $K - \epsilon$, $1/\epsilon^2$ calls of strike $K+\epsilon$ and $-2/\epsilon^2$ calls of strike $K$ - this is known as the butterfly spread. 

The payout at maturity as a function of $S_T$ has a triangular shape whose surface area is unity : it vanishes for $S_T \leq K - \epsilon$ and $S_T \geq K + \epsilon$ and is equal to $1/\epsilon$ for $S_T = K$. For $\epsilon \to 0$, it becomes a Dirac-Delta function. It either vanishes or is strictly positive dependending on $S_T$. Hence, its price at inception must be positive. 

Options prices are arbitraged well-enough that butterfly spreads do not have negative prices : the denominator in the Dupire formula is positive. 

By the Breeden-Litzenberger formula @eq-breeden-litzenberger-formula, $\frac{d^2 C(K,T)}{dK^2}$ is related to the probability density of $S_T$, which must be positive. Hence, the condition $\frac{d^2 C(K,T)}{dK^2} > 0$ is equivalent to requiring that the market implied risk-beutral probabilities are not negative. Violation of the positivity of $d^2 C/dK^2$ is called butterfly-spread arbitrage.

### Call option price bounds

From @eq-first-derivative-of-call-option-price, we have:

$$
\frac{\partial C}{\partial K} = -e^{-r\tau} \int_{K}^{\infty}p(s,t,y,T)dy
$$

From the positivity of the integral $\int_{K}^{\infty}p(s,t,y,T)dy > 0$, we must have:

$$
\frac{\partial C}{\partial K} \leq 0
$$ 

Further, using the fact $\int_{-\infty}^{\infty}p(s,t,y,T)dy = 1$, we have:

$$
\begin{align*}
e^{-r\tau}\int_{K}^{\infty}p(s,t,y,T)dy &\leq e^{-r\tau} \int_{K}^{\infty}p(s,t,y,T)dy = e^{-r\tau} \\
-e^{-r\tau}\int_{K}^{\infty}p(s,t,y,T)dy \frac{\partial C}{\partial K}\geq -e^{-r\tau}
\end{align*}
$$

Putting it together, we have:

$$
\boxed{-e^{-r\tau} \leq \frac{\partial C}{\partial K} \leq 0}
$$ {#eq-no-arbitrage-bounds-on-first-derivative-wrt-strike}

The option price is a decreasing and convex function of the strike $K$.

## Dupire PDE in terms of forward moneyness

Let the log forward-moneyness be defined as $y = \ln(K/F)$. We need to transform the derivatives of the Dupire formula in terms of forward-moneyness.

The deterministic local volatility function is given by:

$$
\sigma_{K,T}^2(S_t,t) = \frac{\frac{\partial C^u_{K,T}}{\partial T} + rK\frac{\partial C^u_{K,T}}{\partial K} - rC^u_{K,T}}{\frac{1}{2}K^2 \frac{\partial^2 C^u_{K,T}}{\partial K^2}}
$$

The first derivative with respect to time $T$ is obtained using the total derivative rule. Imagine that the undiscounted call option price is a function of two intermediate variables $a,b$ which are in turn a function of $T$. That is, $C^u = C^u(a(T),b(T))$. Then:

$$
\begin{align*}
\frac{\partial C^u}{\partial T}({a(T),b(T)}) &= \left.\frac{\partial C^u}{\partial a}\right\vert_{b} \cdot \frac{\partial a}{\partial T} + \left.\frac{\partial C^u}{\partial b}\right\vert_{a}  \cdot \frac{\partial b}{\partial T}  
\end{align*}
$$

where $\vert_{a}$ indicates that $a$ is treated as a constant. For the undiscounted call option price $C^u = C^u(y(K,T),T)$, so $a(T) = y(K,T)$ and $b(T) = T$. So, we have:

$$
\begin{align*}
\frac{\partial C^u}{\partial T}({y(K,T),T}) &= \left.\frac{\partial C^u}{\partial y}\right\vert_{T} \cdot \frac{\partial y}{\partial T} + \left.\frac{\partial C^u}{\partial T}\right\vert_{y}  \cdot \frac{\partial T}{\partial T} \\
 &= \left.\frac{\partial C^u}{\partial y}\right\vert_{T} \cdot \frac{\partial y}{\partial T} + \left.\frac{\partial C^u}{\partial T}\right\vert_{y}  \\
\end{align*}
$$

Now, 

$$
\begin{align*}
y(K,T) &= (-rT)+\ln\left(\frac{K}{S_0}\right)\\
\frac{\partial y}{\partial T} &= (-r)
\end{align*}
$$

Thus,

$$
\frac{\partial C^u}{\partial T} = -r\left.\frac{\partial C^u}{\partial y}\right\vert_{T}  + \left.\frac{\partial C^u}{\partial T}\right\vert_{y}  \\
$$ {#eq-dupire-formula-in-forward-moneyness-terms-1}

Using the chain rule, the first derivative with respect to $K$ is:

$$
\begin{align*}
\frac{\partial C^u}{\partial K} &= \frac{\partial C^u}{\partial y} \cdot \frac{\partial y}{\partial K} \\
&= \frac{\partial C^u}{\partial y} \cdot \frac{\partial }{\partial K} \ln\left(\frac{K}{F_t}\right)\\
&= \frac{\partial C^u}{\partial y} \cdot \frac{F}{K} \cdot \frac{\partial}{\partial K} \left(\frac{K}{F_t}\right)\\
&= \frac{1}{K} \frac{\partial C^u}{\partial y}
\end{align*}
$$ {#eq-dupire-formula-in-forward-moneyness-terms-2}

Differentiating again with respect to $K$, we have:

$$
\begin{align*}
\frac{\partial^2 C^u}{\partial K^2} &= \frac{\partial}{\partial K} \left(\frac{1}{K} \frac{\partial C^u}{\partial y}\right) \\
&= -\frac{1}{K^2} \frac{\partial C^u}{\partial y} + \frac{1}{K} \frac{\partial}{\partial K} \left(\frac{\partial C^u}{\partial y}\right)\\
&= -\frac{1}{K^2} \frac{\partial C^u}{\partial y} + \frac{1}{K} \frac{\partial}{\partial y} \left(\frac{\partial C^u}{\partial y}\right)\frac{\partial y}{\partial K}\\
&= -\frac{1}{K^2} \frac{\partial C^u}{\partial y} + \frac{1}{K^2}\frac{\partial^2 C^u}{\partial y^2}\\
&=\frac{1}{K^2}\left(\frac{\partial^2 C^u}{\partial y^2} - \frac{\partial C^u}{\partial y}\right)
\end{align*}
$$ {#eq-dupire-formula-in-forward-moneyness-terms-3}

Substituting @eq-dupire-formula-in-forward-moneyness-terms-1, @eq-dupire-formula-in-forward-moneyness-terms-2 and @eq-dupire-formula-in-forward-moneyness-terms-3 in the expression for local volatility, we have:

$$
\begin{align*}
\sigma_{K,T}^2(S_t,t) &= \frac{-r \left.\frac{\partial C^u_{y,T}}{\partial y}\right\vert_{T} + \left.\frac{\partial C^u_{y,T}}{\partial T}\right\vert_{y} + rK\frac{\partial C^u_{y,T}}{\partial y} \cdot \frac{1}{K} - rC^u_{y,T}}{\frac{1}{2}K^2 \frac{1}{K^2}\cdot \left(\frac{\partial^2 C^u}{\partial y^2} - \frac{\partial C^u}{\partial y}\right)}\\
&= \frac{ \left.\frac{\partial C^u_{y,T}}{\partial T}\right\vert_{y} +  - rC^u_{y,T}}{\frac{1}{2} \left(\frac{\partial^2 C^u}{\partial y^2} - \frac{\partial C^u}{\partial y}\right)}\\
\frac{\partial C^u_{y,T}}{\partial T} &= rC^u_{y,T} + \frac{\sigma_{y,T}^2}{2}\left(\frac{\partial^2 C^u_{y,T}}{\partial y^2} - \frac{\partial C^u_{y,T}}{\partial y}\right)
\end{align*}
$$

## Local volatility in terms of implied volatility

Since options can also be quoted in terms of implied volatility, the local volatility may also be expressed in terms of the total variance $w(y,T)$. Define:

$$
w(y,T) = \Sigma^2(y,T) T
$$

where $\Sigma(y,T)$ is the Black-Scholes implied volatility as a function of forward-moneyness and time-to-maturity $T$.

We know that the Black-Scholes formula for the future value of the call-option price is:

$$
C_{BS}(y,w) = F\left(\Phi\left(-\frac{y}{\sqrt{w}}+\frac{\sqrt{w}}{2}\right) - e^y\Phi\left(-\frac{y}{\sqrt{w}}-\frac{\sqrt{w}}{2}\right)\right)
$$

Differentiating with respect to $w$, we have:

$$
\begin{aligned}
\frac{\partial C_{BS}}{\partial w} & =F_{T}\left\{\phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right)\frac{\partial }{\partial w}\left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right) -e^{y} \phi \left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\frac{\partial }{\partial w}\left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\right\}\\
 & =F_{T}\left\{\phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right)\left(\frac{y}{2w^{3/2}} +\frac{1}{4w^{1/2}}\right) -e^{y} \phi \left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\left(\frac{y}{2w^{3/2}} -\frac{1}{4w^{1/2}}\right)\right\}\\
 & =F_{T}\left\{\phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right)\left(\frac{y}{2w^{3/2}} +\frac{1}{4w^{1/2}}\right) -\left(\frac{y}{2w^{3/2}} -\frac{1}{4w^{1/2}}\right)\right\}\\
 & =F_{T} \phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right) \cdotp \frac{1}{2w^{1/2}}
\end{aligned}
$$ {#eq-BS-derivative-wrt-w}

Differentiating again with respect to $w$:

$$
\begin{aligned}
\frac{\partial ^{2} C_{BS}}{\partial w^{2}} & =F_{T}\frac{\partial }{\partial w}\left( \phi ( d_{+}) \cdotp \frac{1}{2w^{1/2}}\right)\\
 & =F_{T}\left[\frac{1}{2w^{1/2}}\frac{\partial }{\partial w}( \phi ( d_{+})) +\phi ( d_{+})\frac{\partial }{\partial w}\left(\frac{1}{2w^{1/2}}\right)\right]\\
 & =F_{T}\left[\frac{1}{2w^{1/2}} \phi ( d_{+})\frac{\partial }{\partial w}\left( -\frac{d_{+}^{2}}{2}\right) -\phi ( d_{+})\frac{1}{4w^{3/2}}\right]\\
 & =F_{T}\frac{\phi ( d_{+})}{2w^{1/2}}\left[\frac{\partial }{\partial w}\left( -\frac{d_{+}^{2}}{2}\right) -\frac{1}{2w}\right]\\
 & =\frac{\partial C_{BS}}{\partial w}\left[ -d_{+}\frac{\partial d_{+}}{\partial w} -\frac{1}{2w}\right]\\
 & =\frac{\partial C_{BS}}{\partial w}\left[ -\left( -\frac{y}{w^{1/2}} +\frac{w^{1/2}}{2}\right)\left(\frac{y}{2w^{3/2}} +\frac{1}{4w^{1/2}}\right) -\frac{1}{2w}\right]\\
 & =\frac{\partial C_{BS}}{\partial w}\left[\frac{y^{2}}{2w^{2}} +\frac{y}{4w} -\frac{y}{4w} -\frac{1}{8} -\frac{1}{2w}\right]\\
 & =\frac{\partial C_{BS}}{\partial w}\left(\frac{y^{2}}{2w^{2}} -\frac{1}{2w} -\frac{1}{8}\right)
\end{aligned}
$$ {#eq-BS-second-derivative-wrt-w}

Also, the mixed partial $\partial_{wy} C_{BS}$ is given by:

$$
\begin{aligned}
\frac{\partial ^{2} C_{BS}}{\partial w\partial y} & =\frac{F_{T}}{2w^{1/2}}\frac{\partial }{\partial y}\left\{\phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right)\right\}\\
 & =\frac{F_{T}}{2w^{1/2}} \phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right)\frac{\partial }{\partial y}\left( -\frac{d_{+}^{2}}{2}\right)\\
 & =\frac{\partial C_{BS}}{\partial w}\frac{\partial }{\partial d_{+}}\left( -\frac{d_{+}^{2}}{2}\right)\frac{\partial d_{+}}{\partial y}\\
 & =-\frac{\partial C_{BS}}{\partial w}\left( -\frac{y}{w^{1/2}} +\frac{w^{1/2}}{2}\right)\left( -\frac{1}{\sqrt{w}}\right)\\
 & =\frac{\partial C_{BS}}{\partial w}\left(\frac{1}{2} -\frac{y}{w}\right)
\end{aligned}
$$ {#eq-BS-mixed-partial-derivative-wrt-wy}

Additionally, the partial derivatives of the Black-Scholes formula with respect to $y$ are:

$$
\begin{aligned}
\frac{\partial C_{BS}}{\partial y} & =F_{T}\frac{\partial }{\partial y}\left\{\Phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right) -e^{y} \Phi \left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\right\}\\
 & =F_{T} \cdot \left[ \phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right)\frac{\partial d_{+}}{\partial y} -e^{y} \Phi \left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\right]\\
 & -F_{T}\left[ e^{y} \phi \left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\frac{\partial d_{-}}{\partial y}\right]\\
 & =F_{T} \cdot \left[ \phi \left( -\frac{y}{\sqrt{w}} +\frac{\sqrt{w}}{2}\right)\left( -\frac{1}{\sqrt{w}}\right) -e^{y} \Phi \left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\right]\\
 & -F_{T}\left[ e^{y} \phi \left( -\frac{y}{\sqrt{w}} -\frac{\sqrt{w}}{2}\right)\left( -\frac{1}{\sqrt{w}}\right)\right]\\
 & =-\frac{F_{T}}{\sqrt{w}} \cdot \left[ \phi ( d_{+}) -e^{y} \phi ( d_{-})\right]\\
 & -F_{T} e^{y} \Phi ( d_{-})\\
 & =-F_{T} e^{y} \Phi ( d_{-})
\end{aligned}
$$  {#eq-BS-partial-derivative-wrt-y}

Also:

$$
\begin{aligned}
\frac{\partial ^{2} C_{BS}}{\partial y^{2}} & =-F_{T}\frac{\partial }{\partial y}\left( e^{y} \Phi ( d_{-})\right)\\
 & =-F_{T}\left( e^{y} \Phi ( d_{-}) +e^{y} \phi ( d_{-})\frac{\partial d_{-}}{\partial y}\right)\\
 & =-F_{T} e^{y} \Phi ( d_{-}) +\frac{F_{T} e^{y} \phi ( d_{-})}{\sqrt{w}}\\
 & =\frac{\partial C_{BS}}{\partial y} +2\frac{\partial C_{BS}}{\partial w}
\end{aligned}
$$ {#eq-BS-second-partial-derivative-wrt-y}

Now, the undiscounted call option price $C^u(y,T) = C_{BS}(y(T),w(y,T))$ is a function of the intermediate variables $(y,w)$. So, we may write:

$$
\begin{aligned}
C^u(y,T) &= C_{BS}(w(y),y)\\
C^u_y(y,T) &= (C_{BS})_w \cdot w_y + (C_{BS})_y
\end{aligned}
$$

$$
\begin{aligned}
C_{yy} &= \frac{\partial}{\partial y}\left((C_{BS})_w \cdot w_y + (C_{BS})_y\right)\\
&=\frac{\partial}{\partial y}\left[(C_{BS})_w \cdot w_y\right] + \frac{\partial}{\partial y}((C_{BS})_y)\\
&=\left[\frac{\partial}{\partial y}\{(C_{BS})_w\} \cdot w_y + (C_{BS})_w \cdot w_{yy}\right] + (C_{BS})_{yy} + (C_{BS})_{yw} \cdot w_y\\
&=\left[\{(C_{BS})_{ww} \cdot w_y + (C_{BS})_{wy}\} \cdot w_y + (C_{BS})_w \cdot w_{yy}\right] + (C_{BS})_{yy} + (C_{BS})_{yw} \cdot w_y\\
&= (C_{BS})_{yy} + 2(C_{BS})_{wy} \cdot w_y + (C_{BS})_{ww} \cdot (w_y)^2 + (C_{BS})_w \cdot w_{yy}
\end{aligned}
$$

$$
\begin{align*}
\left.\frac{\partial C_u(y,T)}{\partial T}\right|_y &= \left.\frac{\partial C_{BS}(w(y,T),T)}{\partial T}\right|_{w} \cdot \frac{\partial T}{\partial T} + \frac{\partial C_{BS}}{\partial w} \cdot \frac{\partial w}{\partial T}\\
&= rC_{BS} + \frac{\partial C_{BS}}{\partial w} \cdot \frac{\partial w}{\partial T}\\
\end{align*}
$$

where the last equality follows from the fact that the only explicit dependence of the option price on $T$ is through the forward price $F_T = S_0 \exp(\int_0^T r dt)$.

Substituting these results in the Dupire's formula:

$$
\begin{align*}
\frac{\partial C^u(y,T)}{\partial T} &= rC^u(y,T) + \frac{\sigma^2(y,T)}{2}\left(\frac{\partial^2 C_u(y,T)}{\partial y^2} - \frac{\partial C_u(y,T)}{\partial y}\right)\\
rC_{BS} + (C_{BS})_w \cdot w_T &= rC_{BS} + \sigma_{LV}^2/2((C_{BS})_{yy} + 2(C_{BS})_{wy} \cdot w_y + (C_{BS})_{ww} \cdot (w_y)^2 + (C_{BS})_w \cdot w_{yy}- (C_{BS})_y)\\
(C_{BS})_w \cdot w_T &= \sigma_{LV}^2/2[((C_{BS})_{yy} - (C_{BS})_y) + 2(C_{BS})_{wy} \cdot w_y  + (C_{BS})_{ww} \cdot (w_y)^2 + (C_{BS})_w \cdot w_{yy}-(C_{BS})_w \cdot w_y]\\
(C_{BS})_w \cdot w_T &= \sigma_{LV}^2/2[2(C_{BS})_w + 2(C_{BS})_w \left(\frac{1}{2} - \frac{y}{w}\right)\cdot w_y + \left(\frac{y^{2}}{2w^{2}} -\frac{1}{2w} -\frac{1}{8}\right)(C_{BS})_w (w_y)^2 + (C_{BS})_w \cdot w_{yy}-(C_{BS})_w \cdot w_y]\\
w_T &= \sigma_{LV}^2/2[2 + 2 \left(\frac{1}{2} - \frac{y}{w}\right)\cdot w_y + \left(\frac{y^{2}}{2w^{2}} -\frac{1}{2w} -\frac{1}{8}\right)(w_y)^2 + w_{yy}-  w_y]\\
\sigma_{LV}^2 &= \frac{w_T}{1 - \frac{y}{w}w_y + \frac{1}{4}\left(\frac{y^2}{2w^2} - \frac{1}{w} - \frac{1}{4}\right)(w_y)^2 + \frac{1}{2} w_{yy}}
\end{align*}
$$

This gives us our final result:

$$
\boxed{\sigma_{LV}^2 = \frac{\frac{\partial w}{\partial T}}{1 - \frac{y}{w}\frac{\partial w}{\partial y} + \frac{1}{4}\left(\frac{y^2}{2w^2} - \frac{1}{w} - \frac{1}{4}\right)(\frac{\partial w}{\partial y})^2 + \frac{1}{2} \frac{\partial^2 w}{\partial y^2}}}
$$ {#eq-local-vol-in-terms-of-implied-vol}

## Implied variance is the average of local variance over the life of the option when there is no skew

If the implied volatility $\Sigma$ is independent of the strike, then the skew $\frac{\partial w}{\partial y}$ is zero. 

So, the Dupire's formula becomes:

$$
\begin{align*}
\sigma_{LV}^2(w,T) &= \frac{\partial w}{\partial T}\\
\Sigma^2(T) T &= \int_{R} \sigma_{LV}^2 (w,T) dT\\
\Sigma^2(T) &= \frac{1}{T}\int_{R} \sigma_{LV}^2 (w,T) dT\\
\end{align*}
$$



## References

- [A note sufficient conditions for no arbitrage](https://engineering.nyu.edu/sites/default/files/2018-09/CarrFinResearchLetters2005.pdf), *Peter Carr and Dilip Madan*
- [The volatility surface - A practitioner's guide](https://www.amazon.co.uk/Volatility-Surface-Practitioners-Guide-Finance/dp/0471792519/ref=sr_1_1?crid=3VZ8L0LIO7J24&dib=eyJ2IjoiMSJ9.mJ-yHScvO5YUgkVfwPorn8L9K4zyd5H6qIeL1SxlWPs.CMG7pEJaZU-9EsEoRoz9P2TmJo7AyVECPpkvNcTETbQ&dib_tag=se&keywords=jim+gatheral&qid=1760024387&sprefix=JIm+Gatheral%2Caps%2C92&sr=8-1&ufe=app_do%3Aamzn1.fos.95fd378e-6299-4723-b1f1-3952ffba15af), *Jim Gatheral*