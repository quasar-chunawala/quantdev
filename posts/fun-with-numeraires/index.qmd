---
title: "Fun with numeraires!"
author: "Quasar"
date: "2024-11-28"
categories: [Stochastic Calculus]      
image: "image.jpg"
toc: true
toc-depth: 3
comments:
  giscus: 
    repo: quasar-chunawala/quantdev
---

## Introduction

A proficiency in the change-of-measure technique is useful to the working quant. An excellent summary of the important results is the note [Girsanov, Numeraires and all that](https://www.researchgate.net/publication/361692645_Girsanov_Numeraires_and_All_That), by Andrew Lesniewski. In this post, I would like to derive relevant results and then we can enjoy pricing some payoffs together!

## Girsanov Theorem

:::{#thm-Girsanov-theorem}

### Girsanov Theorem

Let $(W^{\mathbb{P}},t\geq 0)$ be a $\mathbb{P}$ standard brownian motion on $(\Omega,\mathcal{F},\mathbb{P})$ and let $\phi$ be any adapted process. Choose fixed $T$ and defined the process $L$ on $[0,T]$ by:

$$
\begin{align*}
dL_t = \phi_t L_t dW^{\mathbb{P}}_t
\end{align*}
$$ {#eq-dynamics-of-Lt}

$$
\begin{align*}
L_0 = 1
\end{align*}
$$ {#eq-initial-condition}

that is:

$$
\begin{align*}
L_t = \exp\left(\int_0^t \phi_s dW^{\mathbb{P}}_s - \int_0^t \phi^2_s ds\right)
\end{align*}
$$ {#eq-likelihood-process}

Assume that:

$$
\begin{align*}
\mathbb{E}^{\mathbb{P}}[L_T] = 1
\end{align*}
$$ {#eq-expectation-of-likelihood-process}

and define the new probability measure $\mathbb{Q}$ on $\mathcal{F}_t$ by:

$$
L_T = \frac{d\mathbb{Q}}{d\mathbb{P}}
$$ {#eq-radon-nikodym-derivative}

Then,

$$
dW^{\mathbb{P}}_t = dW^{\mathbb{Q}}_t + \phi_t dt
$$ {#eq-girsanov-transformation}

where $dW^{\mathbb{Q}}_t$ is a $\mathbb{Q}$-standard brownian motion.

:::

*Proof.*

Our claim is that, under the $\mathbb{Q}$ measure, the increments $(W^{\mathbb{Q}}_t - W^{\mathbb{Q}}_s)$ are normally distributed with mean $0$ and variance $(t-s)$. We start with the special case $s=0$. Using moment generating functions, it is enough to show that:

It is straightforward to derive @eq-likelihood-process using Ito's lemma. Let $f(x) = \ln x$. Then, $f_x = -\frac{1}{x}$, $f_{xx} = -\frac{1}{x^2}$.

$$
\begin{align*}
d(\ln L_t) &= -\frac{1}{L_t}dL_t + \frac{1}{L_t^2}(dL_t)^2 \\
&= -\frac{1}{L_t}{\phi_t L_t dW^{\mathbb{P}}_t} + \frac{1}{L_t^2}\phi_t^2 L_t^2 dt\\
&= - \phi_t dW^{\mathbb{P}}_t + \phi_t^2 dt \\
L_t &= \exp\left(-\int_0^t \phi_s dW^{\mathbb{P}}_s + \frac{1}{2}\int_0^t \phi_s^2 ds \right)
\end{align*}
$$

To prove our main result, we will now use the MGF of the increments. For $n \in \mathbb{N}$ and $(t_j,j\leq n)$ a partition of $[0,T]$, with $t_n = T$, I will show that :

$$
\begin{align*}
\mathbb{E}^{\mathbb{Q}}\left([\exp\left(\sum_{j=0}^{n-1}\lambda_j (W^{\mathbb{Q}}_{t_{j+1}} - W^{\mathbb{Q}}_{t_{j}})\right)\right] = \exp\left(\lambda_j^2(t_{j+1}-t_j)\right)
\end{align*}
$$ {#eq-MGF-of-gaussian}

This proves that the increments are the ones of standard brownian motion. 

Let $(\mathcal{F}_{t_j},j\leq n)$ be the filtrations of the Brownian motion at the time of the partition. The proof is by successively conditioning from $t_{n-1}$ to $t_1$. We have:

$$
\begin{aligned}
\mathbb{E}^{\mathbb{Q}}\left[\exp\left(\sum _{j=0}^{n-1} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\right)\right] & =\mathbb{E}^{\mathbb{P}}\left[\mathbb{E}^{\mathbb{P}}\left[ M_{t_{n}}\exp\left(\sum _{j=0}^{n-1} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\right) |\mathcal{F}_{t_{n-1}}\right]\right]\\
 & =\mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\mathbb{E}^{\mathbb{P}}\left[ M_{t_{n}}\exp\left( \lambda _{n-1} (W_{t_{n}}^{\mathbb{Q}} -W_{t_{n-1}}^{\mathbb{Q}} )\right) |\mathcal{F}_{t_{n-1}}\right]\right]\\
 & =\mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\mathbb{E}^{\mathbb{P}}\left[\exp\left( -\int _{t_{n-1}}^{t_{n}} \theta dW_{s}^{\mathbb{Q}} +\frac{1}{2}\int _{t_{n-1}}^{t_{n}} \theta _{s}^{2} ds\right)\exp\left( \lambda _{n-1}\int _{t_{n-1}}^{t_{n}} dW_{s}^{\mathbb{Q}}\right) |\mathcal{F}_{t_{n-1}}\right]\right]\\
 & =\mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\mathbb{E}^{\mathbb{P}}\left[\exp\left(\int _{t_{n-1}}^{t_{n}}( -\theta _{s} +\lambda _{n-1}) dW_{s}^{\mathbb{Q}} +\frac{1}{2}\int _{t_{n-1}}^{t_{n}} \theta _{s}^{2} ds\right) |\mathcal{F}_{t_{n-1}}\right]\right]\\
 & =\mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\mathbb{E}^{\mathbb{P}}\left[\exp\left(\int _{t_{n-1}}^{t_{n}}( -\theta _{s} +\lambda _{n-1})\left( dW_{s}^{\mathbb{P}} +\theta ds\right) +\frac{1}{2}\int _{t_{n-1}}^{t_{n}} \theta _{s}^{2} ds\right) |\mathcal{F}_{t_{n-1}}\right]\right]\\
 & =\mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\exp\left(\frac{1}{2}\int _{t_{n-1}}^{t_{n}} \theta _{s}^{2} +\int _{t_{n-1}}^{t_{n}} \theta _{s}( -\theta _{s} +\lambda _{n-1}) ds\right) \ \exp\left(\frac{1}{2}\int _{t_{n-1}}^{t_{n}}( -\theta _{s} +\lambda _{n-1})^{2} ds\right)\right]\\
 & \left\{\ \int XdW_{s}^{\mathbb{P}} \ \text{ is a }\mathcal{N}^{\mathbb{P}}\left( 0,\int \mathbb{E}\left[ X^{2}\right] ds\right) \ \text{gaussian random variable.}\right\} \ \\
 & =\mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\exp\left(\int _{t_{n-1}}^{t_{n}}\left( -\frac{1}{2} \theta _{s}^{2} +\lambda _{n-1} \theta _{s} +\frac{1}{2} \theta _{s}^{2} -\lambda _{n-1} \theta +\lambda _{n-1}^{2}\right) ds\right)\right]\\
 & =\mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\exp\left( \lambda _{n-1}\int _{t_{n-1}}^{t_{n}} ds\right)\right]\\
 & =\exp( \lambda _{n-1}( t_{n} -t_{n-1})) \cdot \mathbb{E}^{\mathbb{P}}\left[\sum _{j=0}^{n-2} \lambda _{j} (W_{t_{j+1}}^{\mathbb{Q}} -W_{t_{j}}^{\mathbb{Q}} )\right]
\end{aligned}
$$

Here, I used the fact that $M_{t_{n-1}}$ is $\mathcal{F}_{t_{n-1}}$ measurable. I can now condition on $\mathcal{F}_{t_{n-2}}$ down to $\mathcal{F}_{t_1}$ and proceed as above to obtain the desired result. 

The process $\phi_t$ is called the *Girsanov kernel*. 

## What is a numeraire?

As Shreve puts it, *a numeraire is the unit of account in which other assets are denominated*. In practice, we tend to choose numeraires that simply the payoff expression. 

Any strictly positive (*non-dividend paying*) price process can be chosen as a numeraire. A numeraire must be a tradable asset. For example, a unit of stock $S_t$ is a numeraire. But, powers of the stock price $S_t^\alpha$ are not numeraires. 

## Abstract Bayes Formula

:::{#thm-abstract-bayes-formula} 

### Abstract Bayes Formula 
Let $(\Omega,\mathcal{F},\mathbb{P})$ be a probability space and let $\mathbb{Q}$ be any other probability measure on it. By the Radon-Nikodym theorem, $\exists L = \frac{d\mathbb{Q}}{d\mathbb{P}}$, $L \geq 0$ with $\mathbb{E}^{\mathbb{P}}[L]=1$. Then we have:

$$
\begin{align*}
\mathbb{E}^{\mathbb{Q}}[X|\mathcal{G}] = \frac{\mathbb{E}^{\mathbb{P}}[LX|\mathcal{G}]}{\mathbb{E}^{\mathbb{P}}[L|\mathcal{G}]}
\end{align*}
$$ {#eq-abstract-bayes-formula}

:::

*Proof.*

By the definition of conditional expectations, recall that if $W$ is any $\mathcal{G}$-measurable random variable, then the conditional expectation must satisfy the relationship:

$$
\mathbb{E}[WX] = \mathbb{E}[W\mathbb{E}[X|\mathcal{G}]]
$$

It is sufficient to prove that:

$$
\mathbb{E}^{\mathbb{P}}[X|\mathcal{G}]\mathbb{E}^{\mathbb{Q}}[L|\mathcal{G}] = \mathbb{E}^{\mathbb{P}}[LX|\mathcal{G}]
$$

Let $G$ be an arbitrary set in $\mathcal{G}$. We have:

$$
\begin{align*}
& \int_G \mathbb{E}^{\mathbb{Q}}[X|\mathcal{G}]\mathbb{E}^{\mathbb{P}}[L|\mathcal{G}] d\mathbb{P} \\
&= \int_G \mathbb{E}^{\mathbb{P}}[L\cdot \mathbb{E}^{\mathbb{Q}}[X|\mathcal{G}]|\mathcal{G}] d\mathbb{P} \\
& \quad \{ \mathbb{E}^{\mathbb{Q}}[X|\mathcal{G}] \text{ is }\mathcal{G}\text{-measurable } \}\\
&= \int_G  L\cdot \mathbb{E}^{\mathbb{Q}}[X|\mathcal{G}] d\mathbb{P}\\
&= \int_G  \frac{d\mathbb{Q}}{d\mathbb{P}}\cdot \mathbb{E}^{\mathbb{Q}}[X|\mathcal{G}] d\mathbb{P}\\
&= \int_G \mathbb{E}^{\mathbb{Q}}[X|\mathcal{G}] d\mathbb{Q}
\end{align*}
$$

Hence, proved.

Note that, the filtration $\mathcal{G}$ is the same irrespective of what probability measure we construct on $\Omega$. 

## Martingale property

:::{#prp-martingale-property} 

Assume that there exists a numeraire $M$ and a probability measure $\mathbb{Q}^M$, such that the price of any traded asset $X$ (without intermediate payments) relative to $M$ is a martingale under $\mathbb{Q}^M$.That is:

$$
\frac{X_t}{M_t} = \mathbb{E}^{\mathbb{Q}^M} \left\{\frac{X_T}{M_T}|\mathcal{F}_t\right\}
$$

Let $N_t$ be an arbitrary numeraire. Then, there exists a probability measure $\mathbb{Q}^N$ such that the price of $X$ normalized by $N$ is a martingale under $\mathbb{Q}^N$.

$$
\frac{X_t}{N_t} = \mathbb{E}^{\mathbb{Q}^N} \left\{\frac{X_T}{N_T}|\mathcal{F}_t\right\}
$$

Moreover, the Radon-Nikodym derivative defining the measure $\mathbb{Q}^N$ is given by:

$$
\frac{d\mathbb{Q}^N}{d\mathbb{Q}^M} = \frac{N_T/N_0}{M_T/M_0}
$$
:::

*Proof.*

We have:

$$
X_0 = M_0 \mathbb{E}^{\mathbb{Q}^M}\left[\frac{X_T}{M_T}\right]
$$

Imposing the simple fact that, the price of the derivative contract should be the same, even if we switch numeraires from $M$ to $N$, we should have:

$$
X_0 = N_0 \mathbb{E}^{\mathbb{Q}^N}\left[\frac{X_T}{N_T}\right]
$$

Thus,

$$
\begin{aligned}
N_{0}\mathbb{E}^{\mathbb{Q}^{N}}\left[\frac{X_{T}}{N_{T}}\right] & =M_{0}\mathbb{E}^{\mathbb{Q}^{M}}\left[\frac{X_{T}}{M_{T}}\right]\\
\frac{N_{T}}{N_{0}} \times N_{0}\mathbb{E}^{\mathbb{Q}^{N}}\left[\frac{X_{T}}{N_{T}}\right] & =\frac{N_{T}}{N_{0}} \times M_{0} \ \mathbb{E}^{\mathbb{Q}^{M}}\left[\frac{X_{T}}{M_{T}}\right] \quad \left\{\text{Multiplying both sides by }\frac{N_{T}}{N_{0}}\right\}\\
\Longrightarrow \mathbb{E}^{\mathbb{Q}^{N}}[ X_{T}] & =\mathbb{E}^{\mathbb{Q}^{M}}\left[\frac{N_{T} /N_{0}}{M_{T} /M_{0}} X_{T}\right]
\end{aligned}
$$

But, we know that:

$$
\mathbb{E}^{\mathbb{Q}^N}[X_T] = \mathbb{E}^{\mathbb{Q}^M}\left[\frac{d\mathbb{Q}^N}{d\mathbb{Q}^M}X_T\right]
$$

Consequently, our candidate for the Radon-Nikodym derivative should be:

$$
L_T = \frac{d\mathbb{Q}^N}{d\mathbb{Q}^M} = \frac{N_T/N_0}{M_T/M_0}
$$

Further $(X_t/N_t)$ is a martingale under $\mathbb{Q}^N$. Its easy to see that:

$$
\begin{aligned}
\mathbb{E}^{\mathbb{Q}^{N}}\left[\frac{X_{T}}{N_{T}} |\mathcal{F}_{t}\right] & =\frac{\mathbb{E}^{\mathbb{Q}^{M}}\left[ L_{T} \cdot \frac{X_{T}}{N_{T}} |\mathcal{F}_{t}\right]}{\mathbb{E}^{\mathbb{Q}^{M}}[ L_{T} |\mathcal{F}_{t}]} \quad \left\{\text{ Abstract bayes formula }\right\}\\
 & =\frac{\mathbb{E}^{\mathbb{Q}^{M}}\left[ L_{T} \cdot \frac{X_{T}}{N_{T}} |\mathcal{F}_{t}\right]}{L_{t}}\\
 & =\frac{\mathbb{E}^{\mathbb{Q}^{M}}\left[\frac{N_{T}}{N_{0}} \cdot \frac{M_{0}}{M_{T}} \cdot \frac{X_{T}}{N_{T}} |\mathcal{F}_{t}\right]}{\frac{N_{t}}{N_{0}} \cdot \frac{M_{0}}{M_{t}}}\\
 & =\frac{\mathbb{E}^{\mathbb{Q}^{M}}\left[\frac{N_{T}}{N_{0}} \cdot \frac{M_{0}}{M_{T}} \cdot \frac{X_{T}}{N_{T}} |\mathcal{F}_{t}\right]}{\frac{N_{t}}{N_{0}} \cdot \frac{M_{0}}{M_{t}}}\\
 & =\frac{M_{t}}{N_{t}} \cdot \mathbb{E}^{\mathbb{Q}^{M}}\left[\frac{X_{T}}{M_{T}}\right]\\
 & =\frac{M_{t}}{N_{t}} \cdot \frac{X_{t}}{M_{t}}\\
 & =\frac{X_{t}}{N_{t}}
\end{aligned}
$$

Since we determined the relevant likelihood process, it is easy to find the Girsanov Kernel.

## Drift transformation under change of numeraire

Suppose we are interested in the dynamics of the stochastic process $(X_t,t\geq 0)$. Under $\mathbb{Q}^M$ measure, its dynamics reads:

$$
\begin{aligned}
dX(t) = \mu_X^{\mathbb{Q}^M}(t) dt + c_X(t)dW^{\mathbb{Q}^M}_t
\end{aligned}
$$ {#eq-p-dynamics-of-x}

I supressed $\mu_X^{\mathbb{Q}^M}(t,X_t)$ as $\mu_X^{\mathbb{Q}^M}(t)$ for brevity.

Under the $\mathbb{Q}^N$ measure, its dynamics reads:

$$
\begin{aligned}
dX(t) = \mu_X^{\mathbb{Q}^N}(t) dt + c_X(t)dW^{\mathbb{Q}^N}_t
\end{aligned}
$$ {#eq-q-dynamics-of-x}

Remember that the diffusion coefficients in these equations are unaffected by the change of measure! We assume that $\mathbb{Q}^M$ is associated with the numeraire $M(t)$ whose dynamics is given by:

$$
dM(t) = \mu_M(t)dt + c_M(t)dW^{\mathbb{Q}^M}
$$

and that the numeraire $N$ has $\mathbb{Q}^M$ dynamics:

$$
dN(t) = \mu_N(t)dt + c_N(t)dW^{\mathbb{Q}^N}
$$

According to the Girsanov theorem, the likelihood process $L(t)$ accompanying this change of measure is a martingale under the measure $\mathbb{Q}^M$ measure and satisfies the stochastic differential equation:

$$
dL_t = L(t)\theta(t)dW^{\mathbb{Q}^M}_t
$$

Explicitly, the likelihood process $L(t)$ is given by the stochastic exponential of the martingale $\int_0^t \theta_s dW^{\mathbb{Q}^M}_s$:

$$
L(t) = \exp\left(\int_0^t \theta_s dW^{\mathbb{Q}^M}_s - \frac{1}{2}\int_0^t \theta^2_s ds \right)
$$

On the other hand, from @prp-martingale-property, we have:

$$
L_t = \frac{N_t / N_0}{M_t / M_0}
$$

Differentiating using Ito's lemma, we have:

$$
\begin{aligned}
dL_{t} & =\frac{M_{0}}{N_{0}} d\left(\frac{N_{t}}{M_{t}}\right)\\
 & =\frac{M_{0}}{N_{0}}\left( -\frac{N_{t}}{M_{t}^{2}} dM_{t} +\frac{1}{M_{t}} dN_{t} +\frac{1}{2} \cdot \frac{2N_{t}}{M_{t}^{3}}( dM_{t})^{2} -\frac{1}{M_{t}^{2}}( dM_{t} \cdot dN_{t})\right)\\
 &  \begin{array}{l}
=\frac{M_{0}}{N_{0}}( -\frac{N_{t}}{M_{t}^{2}}\left( \mu _{M}( t) dt+c_{M}( t) dW_{t}^{\mathbb{Q}^{M}}\right) +\frac{1}{M_{t}}\left( \mu _{N}( t) dt+c_{N}( t) dW_{t}^{\mathbb{Q}^{M}}\right)\\
+\frac{N_{t}}{M_{t}^{3}} c_{M}^{2}( t) dt-\frac{1}{M_{t}^{2}} c_{M}( t) c_{N}( t) dt
\end{array}
\end{aligned}
$$

But since $L_t$ is driftless, we can ignore the $dt$ terms (whatever they are, they are bound to cancel out) and only look at the diffusion coefficient. So, we can write:

$$
\begin{aligned}
dL_{t} & =\frac{M_{0}}{N_{0}}\left( -\frac{N_{t}}{M_{t}^{2}} c_{M}( t) +\frac{1}{M_{t}} c_{N}( t)\right) dW{_{t}^{\mathbb{Q}}}^{M}\\
 & =\frac{N_{t} /N_{0}}{M_{t} /M_{0}}\left(\frac{c_{N}( t)}{N_{t}} -\frac{c_{M}( t)}{M_{t}}\right) dW{_{t}^{\mathbb{Q}}}^{M}\\
 & =L_{t}\left(\frac{c_{N}( t)}{N_{t}} -\frac{c_{M}( t)}{M_{t}}\right) dW{_{t}^{\mathbb{Q}}}^{M}
\end{aligned}
$$

Comparing this, we can infer that:

$$
\theta_t = \frac{c_N(t)}{N_t} - \frac{c_M(t)}{M_t}
$$

## Pricing the payoff $V(T) = S_T(S_T - K)^{+}$

Under the risk-neutral measure $\mathbb{Q}^M$ associated with the money-market account numeraire $M(t)$, the stock price $S(t)$ evolves according to:

$$
\begin{align*}
dS_t = r S_t dt + \sigma S_t dW^{\mathbb{Q}^M}
\end{align*}
$$ {#eq-diffusion}

which has the solution:

$$
\begin{align*}
S_t = S_0\exp\left[\left(r - \frac{\sigma^2}{2}\right)t + \sigma W^{\mathbb{Q}^M}(t)\right]
\end{align*}
$$ {#eq-solution-of-gbm}

By the risk-neutral pricing formula, we have:

$$
\begin{align*}
V(0) &= \mathbb{E}^{\mathbb{Q}^M}\left[\frac{V(T)}{M(T)}\right] \\
&= \mathbb{E}^{\mathbb{Q}^M}\left[\frac{S_T}{M_T}(S_T - K)^{+}\right]
\end{align*}
$$ {#eq-risk-neutral}

By the change-of-measure formula, if $N$ is any other numeraire with associated probability measure $\mathbb{Q}^N$, we know that:

$$
\begin{align*}
\mathbb{E}^{\mathbb{Q}^N}[V(T)]=\mathbb{E}^{\mathbb{Q}^M}\left[\frac{d\mathbb{Q}^N}{d\mathbb{Q}^M}V(T)\right]
\end{align*}
$$ {#eq-change-of-measure}

We switch to the stock numeraire $S_t$. The Radon-Nikodym derivative $L_T = d\mathbb{Q}^S/d\mathbb{Q}^M$ is simply:

$$
\begin{align*}
L_T = \frac{d\mathbb{Q}^S}{d\mathbb{Q}^M} = \frac{S(T)/S(0)}{M(T)/M(0)}  = \frac{1}{S(0)}\cdot \frac{S(T)}{M(T)}
\end{align*}
$$ {#eq-radon-nikodym}

The dynamics of $L_t$ under the $\mathbb{Q}_M$ measure is given by:

$$
dL_t = \phi_t L_t dW^{\mathbb{Q}^M}
$$

where the Girsanov kernel $\phi_t = \sigma$. Then, the Girsanov transformation is:

$$
W^{\mathbb{Q}^M}_T = W^{\mathbb{Q}^S}_T + \sigma T
$$ {#eq-girsanov-drift}

So, the $\mathbb{Q}^S$ dynamics of the stock price is:

$$
\begin{align*}
S_T &= S_0 \exp\left[\left(r - \frac{\sigma^2}{2}\right)T + \sigma (W^{\mathbb{Q}^S}_T + \sigma T)\right]\\
&=  S_0 \exp\left[\left(r + \frac{\sigma^2}{2}\right)T + \sigma (W^{\mathbb{Q}^S}_T)\right]
\end{align*}
$$ {#eq-Qs-dynamics}

We can develop the expression in @eq-risk-neutral to be:

$$
\begin{align*}
V(0) &= S_0\mathbb{E}^{\mathbb{Q}^M}\left[\frac{1}{S_0}\frac{S_T}{M_T}(S_T - K)^{+}\right]
\end{align*}
$$ {#eq-develop-the-expression}

Applying the change-of-measure (abstract *Baye's* formula),we have:

$$
\begin{align*}
V(0) &= S_0\mathbb{E}^{\mathbb{Q}^S}\left[(S_T - K)^{+}\right]
\end{align*}
$$ {#eq-applying-change-of-measure-formula}

Now, we have:

$$
\begin{align*}
\mathbb{Q}^S(S_T > K) &= \mathbb{Q}^S\left(S_0 \exp\left[\left(r + \frac{\sigma^2}{2}\right)T + \sigma (W^{\mathbb{Q}^S}_T)\right] > K\right)\\
&= \mathbb{Q}^S\left(S_0 \exp\left[\left(r + \frac{\sigma^2}{2}\right)T + \sigma (-\sqrt{T}Z)\right] > K\right)\\
&= \mathbb{Q}^S\left(\log \frac{S_0}{K}  + \left(r + \frac{\sigma^2}{2}\right)T   > \sigma\sqrt{T}Z\right)\\
\end{align*}
$$ {#eq-probability-under-stock-measure}

where we subbed $-\sqrt{T}Z=W^{\mathbb{Q}^S}_T$. Recall, the standard normals $Z$ and $-Z$ have the same distribution by symmetry.

Define 

$$
d_{-} = \frac{\log \frac{S_0}{K}  + \left(r + \frac{\sigma^2}{2}\right)T}{\sigma\sqrt{T}}
$$ {#eq-expression-for-d2}

Then, since $Z \sim \mathcal{N}^{\mathbb{Q}^S}(0,1)$:

$$
\mathbb{Q}^S(S_T > K) = \mathbb{Q}^S(Z < d_{-}) = \Phi(d_{-})
$$ {#eq-STgtKprobability}

So, we can expand the expectation in @eq-applying-change-of-measure-formula. The indicator random variable $1_{\{S_T > K\}}$ is $1$ for all points $Z < d_{-}$. So, the limits of integration will be $-\infty$ to $d_{-}$.

$$
\begin{align*}
V(0) &= S_0\left[\int_{-\infty}^{d_{-}} S_T  d\mathbb{Q}^S - K\int_{-\infty}^{d_{-}} dQ^S\right]\\
&= S_0\left[\int_{-\infty}^{d_{-}} S_T f_Z^{\mathbb{Q}^S}(z)dz - K\int_{-\infty}^{d_{-}} f_Z^{\mathbb{Q}^S}(z)dz\right]\\
&= S_0\left[\frac{1}{\sqrt{2\pi}}\int_{-\infty}^{d_{-}} S_0 \exp\left[\left(r + \frac{\sigma^2}{2}\right)T - \sigma \sqrt{T}z\right] \exp(-\frac{z^2}{2})dz - K\Phi(d_{-})\right]
\end{align*}
$$

Completing the square, we have:

$$
\begin{align*}
V(0) &= S_0\left[\frac{1}{\sqrt{2\pi}}\int_{-\infty}^{d_{-}} S_0 \exp\left[-\frac{1}{2}(z^2 + 2\sigma\sqrt{T}z + (\sigma \sqrt{T})^2)\right] \exp\left[\left(r + \sigma^2\right)T\right]dz - K\Phi(d_{-})\right]\\
&=S_0 \left[S_0\frac{e^{(r + \sigma^2) T}}{\sqrt{2\pi}}\int_{-\infty}^{d_{-}} \exp\left(-\frac{1}{2}(z + \sigma\sqrt{T})^2\right) dz - K\Phi(d_{-})\right]\\
\end{align*}
$$

Let $u = z + \sigma\sqrt{T}$. And define:

$$
d_{+} = d_{-} + \sigma \sqrt{T} = \frac{\log \frac{S_0}{K} + \left(r + \frac{3}{2}\sigma^2\right)}{\sigma \sqrt{T}}
$$

We have the closed-form formula:

$$
V(0) = S_0^2 e^{(r+\sigma^2)T} \Phi(d_{+}) - KS_0 \Phi(d_{-})
$$


