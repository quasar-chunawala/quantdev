<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Quasar">
<meta name="dcterms.date" content="2025-11-27">

<title>quantdev.blog - Python memory management</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;800&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap')
</style>
<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9993009899870547" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../.././symbol.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">quantdev.blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sell_side_quant_critical_path.html" rel="" target="">
 <span class="menu-text">Sell-side Quant</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../roadmap.html" rel="" target="">
 <span class="menu-text">C++ Roadmap</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://patreon.com/u59411143?utm_medium=unknown&amp;utm_source=join_link&amp;utm_campaign=creatorshare_creator&amp;utm_content=copyLink" rel="" target=""><i class="bi bi-patreon" role="img">
</i> 
 <span class="menu-text">Become a patreon</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/quasar-chunawala" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="http://linkedin.com/in/quasar-chunawala" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Python memory management</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Quasar </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 27, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#allocation-domains" id="toc-allocation-domains" class="nav-link" data-scroll-target="#allocation-domains">Allocation Domains</a></li>
  <li><a href="#the-cpython-memory-allocator" id="toc-the-cpython-memory-allocator" class="nav-link" data-scroll-target="#the-cpython-memory-allocator">The CPython memory allocator</a>
  <ul class="collapse">
  <li><a href="#blocks-pools-and-arenas" id="toc-blocks-pools-and-arenas" class="nav-link" data-scroll-target="#blocks-pools-and-arenas">Blocks, Pools and Arenas</a>
  <ul class="collapse">
  <li><a href="#arenas" id="toc-arenas" class="nav-link" data-scroll-target="#arenas">Arenas</a></li>
  <li><a href="#pools" id="toc-pools" class="nav-link" data-scroll-target="#pools">Pools</a></li>
  <li><a href="#blocks" id="toc-blocks" class="nav-link" data-scroll-target="#blocks">Blocks</a></li>
  <li><a href="#block-allocation-api" id="toc-block-allocation-api" class="nav-link" data-scroll-target="#block-allocation-api">Block allocation API</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#cpython-interning" id="toc-cpython-interning" class="nav-link" data-scroll-target="#cpython-interning">CPython interning</a>
  <ul class="collapse">
  <li><a href="#string-interning-explained" id="toc-string-interning-explained" class="nav-link" data-scroll-target="#string-interning-explained"><code>string</code> interning explained</a></li>
  </ul></li>
  <li><a href="#mutable-containers-memory-allocationn-strategy" id="toc-mutable-containers-memory-allocationn-strategy" class="nav-link" data-scroll-target="#mutable-containers-memory-allocationn-strategy">Mutable containers memory allocationn strategy</a></li>
  <li><a href="#list-allocation-strategy" id="toc-list-allocation-strategy" class="nav-link" data-scroll-target="#list-allocation-strategy">List allocation strategy</a></li>
  <li><a href="#overallocation-of-dictionaries-and-sets" id="toc-overallocation-of-dictionaries-and-sets" class="nav-link" data-scroll-target="#overallocation-of-dictionaries-and-sets">Overallocation of dictionaries and sets</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>CPython is one of the many implementations of the Python runtime written in C code. There are other implementations such as PyPy, Jython. In this blog post, I summarize how object memory is alllocated and freed and how CPython manages memory leaks.</p>
<p>Python is a dynamically-typed language. The size of variables can’t be calculated at compile-time. Most of Python’s core types are dynamically sized. The <code>list</code> type can be of any size, a <code>dict</code> can have any number of keys, and even <code>int</code> is dynamic. The user never has to specify the size of these types. Names in Python can be reused for values of different types.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a>a_value <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>a_value <span class="op">=</span> <span class="st">"Now, I'm a string"</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>a_value <span class="op">=</span> [<span class="st">"Now"</span>, <span class="st">"I"</span>, <span class="st">"am"</span>, <span class="st">"a"</span>, <span class="st">"list"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To overcome these constraints, CPython relies heavily on dynamic memory allocation, but adds safety rails to automate the freeing of memory using the garbage collection and reference counting algorithms.</p>
<p>Instead of the Python developer having to allocate memory, Python object memory is allocated automatically by a single, unified API. This design requires that the entire CPython standard library and core modules(written in C) use this API.</p>
</section>
<section id="allocation-domains" class="level1">
<h1>Allocation Domains</h1>
<ul>
<li><p>The raw domain is used for allocation from the system heap and large, or non-object related memory.</p></li>
<li><p>The object domain is used for the allocation of all Python object related memory.</p></li>
<li><p>The PyMem domain is the same as <code>PYMEM_DOMAIN_OBJ</code>. this exists for legacy purposes.</p></li>
</ul>
<p>Each domain implements the same interface of frunctions:</p>
<ul>
<li><p><code>_Alloc(size_t size)</code> allocates memory of <code>size</code> bytes and returns a pointer.</p></li>
<li><p><code>_Calloc(size_t nelem, size_t el_size)</code> allocates <code>nelem</code> elements each of size <code>el_size</code> and returns a pointer.</p></li>
<li><p><code>_Realloc(void* ptr, size_t new_size)</code> reallocates memory of size <code>new_size</code>.</p></li>
<li><p><code>_Free(void* ptr)</code> frees memory at <code>ptr</code> back to the heap.</p></li>
</ul>
<p>The <code>PyMemAllocatorDomain</code> enumeration represents the three domains in CPython as <code>PYMEM_DOMAIN_RAW</code>, <code>PYMEM_DOMAIN_OBJ</code> and <code>PYMEM_DOMAIN_MEM</code>.</p>
<p>CPython uses <span class="math inline">\(2\)</span> memory allocators:</p>
<ul>
<li><code>malloc</code> is the operating system allocator for the raw memory domain.</li>
<li><code>pymalloc</code> is the CPython allocator the PyMem and object domains.</li>
</ul>
</section>
<section id="the-cpython-memory-allocator" class="level1">
<h1>The CPython memory allocator</h1>
<p>The CPython memory alloctor sit on top of the OS memory allocator and has an algorithm for allocation.</p>
<ul>
<li><p>Most of the memory allocation requests are small and of a fixed size, because <code>PyObject</code> is <span class="math inline">\(16\)</span> bytes, <code>PyASCIIObject</code> is <span class="math inline">\(42\)</span> bytes, <code>PyCompactUnicodeObject</code> is <span class="math inline">\(72\)</span> bytes.</p></li>
<li><p>The <code>pymalloc</code> allocator allocates memory blocks only upto <span class="math inline">\(256\)</span> KB. Anything larger is sent to the OS allocator.</p></li>
<li><p><code>pymalloc</code> uses the GIL instead of the system thread-safety check.</p></li>
</ul>
<p>To help clarify this situation, you can imagine a sports stadium, home of CPython FC, as an analogy. To help manage crowds, CPython FC has implemented a system breaking the stadium up into sections A to E, each with seating in rows <span class="math inline">\(1\)</span> to <span class="math inline">\(40\)</span>.</p>
<p>At the front of the stadium, rows <span class="math inline">\(1\)</span> to <span class="math inline">\(10\)</span> are the roomier premium seats, with <span class="math inline">\(80\)</span> seats in each row. At the back rows <span class="math inline">\(31\)</span> to <span class="math inline">\(40\)</span> are the conomy seats with <span class="math inline">\(150\)</span> seats per row.</p>
<p>The Python memory allocation algorithm has similar characteristics:</p>
<ul>
<li>Just like the stadium as seats, the <code>pymalloc</code> algorithm has memory blocks.</li>
<li>Just like the seats can be premium, regular, or economy, memory blocks are all of range of fixed sizes. You can’t bring your desk chair!</li>
<li>Just like seats of the same size are put into rows, blocks of the same size are put into pools.</li>
</ul>
<p>A central register keeps a record of where blocks are and the number of blocks available in a pool, just as the stadium allocates seating. When a row in the stadium is full, the next row is used. When a pool of blocks is full, the next pool is used. Pools are groups into arenas, just like the stadium groups the rows into sections.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="op">%</span>load_ext itikz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are several advantages to this strategy:</p>
<ul>
<li>The algorithm is more performant for CPython’s main use case: small, short-lived objects.</li>
<li>The algorithm uses the GIL instead of system thread-lock detection.</li>
<li>The algorithm uses memory mapping <code>mmap()</code> syscall instead of heap allocations.</li>
</ul>
<p>The requested memory is always matched to a block size. Blocks of the same size are all put into the same <strong>pool</strong> of memory. Pools are grouped into arenas.</p>
<section id="blocks-pools-and-arenas" class="level2">
<h2 class="anchored" data-anchor-id="blocks-pools-and-arenas">Blocks, Pools and Arenas</h2>
<p><code>pymalloc</code> allocates large memory regions called arenas from the system, then divides them into pools.</p>
<section id="arenas" class="level3">
<h3 class="anchored" data-anchor-id="arenas">Arenas</h3>
<p>Arenas are allocated from the system heap using <code>mmap</code> when available otherwise <code>malloc</code>. CPython arenas are <span class="math inline">\(256\)</span>-KB on 32-bit systems and <span class="math inline">\(1\)</span> MB on 64-bit systems. Each arena contains multiple pools.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="pp">#ifdef USE_LARGE_ARENAS</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="pp">#define ARENA_BITS              </span><span class="dv">20</span><span class="pp">                    </span><span class="co">/* 1 MiB */</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="pp">#else</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="pp">#define ARENA_BITS              </span><span class="dv">18</span><span class="pp">                    </span><span class="co">/* 256 KiB */</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="pp">#endif</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="pp">#define ARENA_SIZE              </span><span class="op">(</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span>ARENA_BITS<span class="op">)</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="pp">#define ARENA_SIZE_MASK         </span><span class="op">(</span>ARENA_SIZE<span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="dv">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Arenas are scattered in the main memory. Each arena is a contiguous chunk of memory. CPython maintains a doubly linked list <code>usable_arenas</code> that tracks all the arena objects, that have atleast one pool available for allocation. The <code>usable_arenas</code> list is maintained in ascending order of each arena’s <code>nfreepools</code> (number of free pools). This sorting ensures that allocations preferentially use arenas with fewest free pools.</p>
<p>Our main book-keeping data structure of interest is the <code>arena_object</code>. The <code>usable_arenas</code> doubly linked list strings together <code>arena_object</code> nodes . These contain meta-information of each arena with <code>prevarena</code> and <code>nextarena</code> pointers. Each of these nodes have a <code>address</code> field which is a pointer to the actual contiguous block of memory (<span class="math inline">\(256\)</span>KB / <span class="math inline">\(1\)</span>MB) returned by <code>malloc</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">/* Record keeping for arenas. */</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">struct</span> arena_object <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="co">/* The address of the arena, as returned by malloc.  Note that 0</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">     * will never be returned by a successful malloc, and is used</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">     * here to mark an arena_object that doesn't correspond to an</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">     * allocated arena.</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">     */</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="dt">uintptr_t</span> address<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="co">/* Pool-aligned pointer to the next pool to be carved off. */</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    pymem_block<span class="op">*</span> pool_address<span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="co">/* The number of available pools in the arena:  free pools + never-</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">     * allocated pools.</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">     */</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="ex">uint</span> nfreepools<span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17"></a></span>
<span id="cb4-18"><a href="#cb4-18"></a>    <span class="co">/* The total number of pools in the arena, whether or not available. */</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>    <span class="ex">uint</span> ntotalpools<span class="op">;</span></span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a>    <span class="co">/* Singly-linked list of available pools. */</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>    <span class="kw">struct</span> pool_header<span class="op">*</span> freepools<span class="op">;</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>    <span class="co">/* Whenever this arena_object is not associated with an allocated</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="co">     * arena, the nextarena member is used to link all unassociated</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co">     * arena_objects in the singly-linked `unused_arena_objects` list.</span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co">     * The prevarena member is unused in this case.</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="co">     *</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co">     * When this arena_object is associated with an allocated arena</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="co">     * with at least one available pool, both members are used in the</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="co">     * doubly-linked `usable_arenas` list, which is maintained in</span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="co">     * increasing order of `nfreepools` values.</span></span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co">     *</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="co">     * Else this arena_object is associated with an allocated arena</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="co">     * all of whose pools are in use.  `nextarena` and `prevarena`</span></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="co">     * are both meaningless in this case.</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="co">     */</span></span>
<span id="cb4-38"><a href="#cb4-38"></a></span>
<span id="cb4-39"><a href="#cb4-39"></a>    <span class="kw">struct</span> arena_object<span class="op">*</span> nextarena<span class="op">;</span></span>
<span id="cb4-40"><a href="#cb4-40"></a>    <span class="kw">struct</span> arena_object<span class="op">*</span> prevarena<span class="op">;</span></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each <code>arena_object</code> node also contains a field <code>freepools</code> of the type <code>pool_header*</code> which points to the head of a linked list which tracks available pools in the arena.</p>
<p>When an arena’s <code>nfreepools</code> reaches zero (all pools allocated), it’s removed from <code>usable_arenas</code> linked list. Conversely, when a pool becomes empty and is added to an arena’s freepools, the arena may be added back to <code>usable_arenas</code> if it was previously full.</p>
</section>
<section id="pools" class="level3">
<h3 class="anchored" data-anchor-id="pools">Pools</h3>
<p>Pools are <span class="math inline">\(4\)</span>KB subdivisions (or <span class="math inline">\(16\)</span> Kb on large systems) of arenas. Normally, the size of the pool is equal to the size of a memory page. Limiting pool to the fixed size of blocks helps with fragmentation. Each pool manages blocks of single size class and can be in three states:</p>
<ul>
<li>Used : Partially allocated blocks.</li>
<li>Full : All blocks allocated.</li>
<li>Empty : All blocks available.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">/*</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"> * Size of the pools used for small blocks.  Must be a power of 2.</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co"> */</span></span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="pp">#ifdef USE_LARGE_POOLS</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="pp">#define POOL_BITS               </span><span class="dv">14</span><span class="pp">                  </span><span class="co">/* 16 KiB */</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="pp">#else</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="pp">#define POOL_BITS               </span><span class="dv">12</span><span class="pp">                  </span><span class="co">/* 4 KiB */</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="pp">#endif</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="pp">#define POOL_SIZE               </span><span class="op">(</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span>POOL_BITS<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each pool has a special header structure:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">/* Pool for small blocks. */</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">struct</span> pool_header <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="kw">union</span> <span class="op">{</span> pymem_block <span class="op">*</span>_padding<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>            <span class="ex">uint</span> count<span class="op">;</span> <span class="op">}</span> ref<span class="op">;</span>          <span class="co">/* number of allocated blocks    */</span></span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>    pymem_block <span class="op">*</span>freeblock<span class="op">;</span>             <span class="co">/* pool's free list head         */</span></span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="kw">struct</span> pool_header <span class="op">*</span>nextpool<span class="op">;</span>       <span class="co">/* next pool of this size class  */</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a>    <span class="kw">struct</span> pool_header <span class="op">*</span>prevpool<span class="op">;</span>       <span class="co">/* previous pool of this size class                             */</span></span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a>    <span class="ex">uint</span> arenaindex<span class="op">;</span>                    <span class="co">/* index into arenas of base adr */</span></span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="ex">uint</span> szidx<span class="op">;</span>                         <span class="co">/* block size class index        */</span></span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="ex">uint</span> nextoffset<span class="op">;</span>                    <span class="co">/* bytes to virgin block         */</span></span>
<span id="cb6-18"><a href="#cb6-18"></a></span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="ex">uint</span> maxnextoffset<span class="op">;</span>                 <span class="co">/* largest valid nextoffset      */</span></span>
<span id="cb6-20"><a href="#cb6-20"></a></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pools of the same sized blocks are linked together using doubly linked list (the <code>nextpool</code> and <code>prevpool</code> fields). The <code>szidx</code> field keeps the size class index, whereas <code>ref.count</code> keeps the number of used blocks. The <code>arenaindex</code> stores the number of an arena in which this pool was created.</p>
<p>In order to efficient manage pools, a pool table called <code>usedpools</code> is maintained. A pool table is an array of pointers. It is segmented by the size class index <code>i</code>. For an index <code>i</code>, <code>usedpools[i]</code> points to the head of linked list of all partial used pools of the same size class <code>i</code>. Each node of this linked list is of type <code>pool_header</code>.</p>
<p>If a full pool has a block freed, then the pool is put back in the used state. The newly freed pool is added to the front of the approapriate <code>usedpools[]</code> list, so the next allocation for its size class will use the freed block.</p>
<p>On transition to empty, a pool is unlinked from its <code>usedpools[]</code> list and added to the front of the arena’s singly linked <code>freepools</code> list.</p>
</section>
<section id="blocks" class="level3">
<h3 class="anchored" data-anchor-id="blocks">Blocks</h3>
<p>Blocks are the actual allocated units, with sizes ranging from <span class="math inline">\(8\)</span> to <span class="math inline">\(512\)</span> bytes in <span class="math inline">\(8\)</span>-byte increments.</p>
<table class="table">
<thead>
<tr class="header">
<th>Request in bytes</th>
<th>Size of the allocated block</th>
<th>Size class index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1-8</td>
<td>8</td>
<td>0</td>
</tr>
<tr class="even">
<td>9-16</td>
<td>16</td>
<td>1</td>
</tr>
<tr class="odd">
<td>17-24</td>
<td>24</td>
<td>2</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>505-512</td>
<td>512</td>
<td>63</td>
</tr>
</tbody>
</table>
<p>On a 64-bit system, since an arena is <span class="math inline">\(1\)</span> MB, there will always be <span class="math inline">\(64\)</span> pools each of size <span class="math inline">\(16\)</span>KB.</p>
<p>Within a pool, blocks of fixed size can be allocated and freed. Available blocks within a pool are listed in the singly linked list <code>freeblock</code>. Whenever a block is freed, its inserted at the front of the <code>freeblock</code> list. When a pool is initialized, only the first two blocks are linked within the <code>freeblock</code> list.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#ffffff', 'primaryBorderColor': '#333333', 'background': '#ffffff', 'mainBkg': '#ffffff', 'clusterBkg': '#ffffff', 'clusterBorder': '#333333', 'tertiaryBkgColor': '#ffffff', 'tertiaryBorderColor': '#333333'}}}%%
graph LR
    subgraph usable_arenas ["usable_arenas: Doubly-Linked Arena List"]
        A1["arena_object #1&lt;br/&gt;nfreepools: 3&lt;br/&gt;address: 0x1000"]
        A2["arena_object #2&lt;br/&gt;nfreepools: 5&lt;br/&gt;address: 0x2000"]
        A3["arena_object #3&lt;br/&gt;nfreepools: 1&lt;br/&gt;address: 0x3000"]
        
        A1 --&gt;|nextarena| A2
        A2 --&gt;|prevarena| A1
        A2 --&gt;|nextarena| A3
        A3 --&gt;|prevarena| A2
    end
    
    subgraph freepools_A1 ["freepools: Singly-Linked Pool List"]
        P1["pool_header&lt;br/&gt;szidx: 5 (40B)&lt;br/&gt;count: 2&lt;br/&gt;state: Used"]
        P2["pool_header&lt;br/&gt;szidx: 10 (80B)&lt;br/&gt;count: 0&lt;br/&gt;state: Empty"]
        P3["pool_header&lt;br/&gt;szidx: 3 (24B)&lt;br/&gt;count: 5&lt;br/&gt;state: Used"]
        
        P1 --&gt;|nextpool| P2
        P2 --&gt;|nextpool| P3
        P3 --&gt;|nextpool| None1["NULL"]
    end
    
    subgraph freeblock_P1 ["freeblock: Singly-Linked Block List"]
        B1["Block&lt;br/&gt;addr: 0x1200&lt;br/&gt;size: 40B&lt;br/&gt;FREE"]
        B2["Block&lt;br/&gt;addr: 0x1228&lt;br/&gt;size: 40B&lt;br/&gt;FREE"]
        B3["Block&lt;br/&gt;addr: 0x1250&lt;br/&gt;size: 40B&lt;br/&gt;ALLOCATED"]
        B4["Block&lt;br/&gt;addr: 0x1278&lt;br/&gt;size: 40B&lt;br/&gt;FREE"]
        
        B1 --&gt;|next| B2
        B2 --&gt;|next| B3
        B3 -.-&gt;|skip| B4
        B4 --&gt;|next| None2["NULL"]
    end
    
    A1 --&gt;|freepools| P1
    P1 --&gt;|freeblock| B1
    
    style A1 fill:#64B5F6,stroke:#1976D2,stroke-width:2px,color:#000
    style A2 fill:#64B5F6,stroke:#1976D2,stroke-width:2px,color:#000
    style A3 fill:#64B5F6,stroke:#1976D2,stroke-width:2px,color:#000
    
    style P1 fill:#81C784,stroke:#2E7D32,stroke-width:2px,color:#000
    style P2 fill:#81C784,stroke:#2E7D32,stroke-width:2px,color:#000
    style P3 fill:#81C784,stroke:#2E7D32,stroke-width:2px,color:#000
    
    style B1 fill:#FFB74D,stroke:#F57C00,stroke-width:2px,color:#000
    style B2 fill:#FFB74D,stroke:#F57C00,stroke-width:2px,color:#000
    style B3 fill:#EF9A9A,stroke:#C62828,stroke-width:2px,color:#000
    style B4 fill:#FFB74D,stroke:#F57C00,stroke-width:2px,color:#000
    
    style None1 fill:#EEEEEE,stroke:#666,stroke-width:1px,color:#000
    style None2 fill:#EEEEEE,stroke:#666,stroke-width:1px,color:#000
    
    style usable_arenas fill:#ffffff,stroke:#1976D2,stroke-width:2px,color:#000
    style freepools_A1 fill:#ffffff,stroke:#2E7D32,stroke-width:2px,color:#000
    style freeblock_P1 fill:#ffffff,stroke:#F57C00,stroke-width:2px,color:#000
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="block-allocation-api" class="level3">
<h3 class="anchored" data-anchor-id="block-allocation-api">Block allocation API</h3>
</section>
</section>
</section>
<section id="cpython-interning" class="level1">
<h1>CPython interning</h1>
<p>The general rule is that objects are allocated on assignment. Variables just point to objects. There is an exception to this general rule. This is python runtime implementation specific. Often commonly used objects are preallocated and are shared instead of costly new allocations. This is mainly done for performance optimization.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>x <span class="op">=</span> <span class="dv">255</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>y <span class="op">=</span> <span class="dv">255</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="bu">print</span>(x <span class="kw">is</span> y, x <span class="op">==</span> y)</span>
<span id="cb7-4"><a href="#cb7-4"></a>x <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>y <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="bu">print</span>(x <span class="kw">is</span> y, x <span class="op">==</span> y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True True
False True</code></pre>
</div>
</div>
<p><code>int</code>s in the range <span class="math inline">\([-5,257)\)</span>, empty tuples and all empty or single length strings are preallocated.</p>
<section id="string-interning-explained" class="level2">
<h2 class="anchored" data-anchor-id="string-interning-explained"><code>string</code> interning explained</h2>
<p>String interning is a method of storing only one copy of each distinct string value, which must be immutable. In Python3, we have a function <code>sys.intern()</code> and if we use this function, we can enter a string in the table of interned strings. We get a reference to the interned string.</p>
<p>So, we can gain a little extra performance on dictionary lookup (key comparisons after hashing can be done by a pointer compare instead of a string compare).</p>
<p>Names used in programs are automatically interned. Dictionaries used to hold module, class or instance attributes have interned keys.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">from</span> sys <span class="im">import</span> <span class="bu">intern</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>a, b <span class="op">=</span> <span class="st">"strin"</span>, <span class="st">"string"</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>a <span class="op">+</span> <span class="st">'g'</span> <span class="kw">is</span> b<span class="sc">}</span><span class="ss">"</span>)    <span class="co"># Returns false</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="bu">intern</span>(a <span class="op">+</span> <span class="st">'g'</span>) <span class="kw">is</span> <span class="bu">intern</span>(b) <span class="co"># returns True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>False</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
<section id="mutable-containers-memory-allocationn-strategy" class="level1">
<h1>Mutable containers memory allocationn strategy</h1>
<p>There are different mutable containers in Python - <code>list</code>s, <code>set</code>s and <code>dict</code>s. Behind the scenes, there is a strategy for allocating these containers.</p>
<p>A good strategy will plan for growth and shrinkage. It will slightly overallocate memory needed by the container, to leave room for growth. Each time we append to a <code>list</code>, we won’t have to reallocate the memory. We also have to remember that sometimes we have to shrink the memory for a mutable container. This can help reduce the number of expensive function calls for instance to <code>realloc</code> or <code>memcpy</code>.</p>
</section>
<section id="list-allocation-strategy" class="level1">
<h1>List allocation strategy</h1>
<p>Lists are stored as fixed length array of pointers. So, we just point to objects. By design, we overallocate for list growth by append.</p>
<ul>
<li>The capacity growth pattern is roughly <span class="math inline">\(4,8,16,25,35,46,\ldots\)</span></li>
</ul>
<p>If we put something at the end of the list, these operations are cheap. But, if we put something in the middle or the beginning, we’ll have to copy/shift the elements in memory to perform this operation.</p>
<p>On my 64-bit machine, with Python 3.13.7, the list allocation size is:</p>
<ul>
<li>64 bits : <code>56 + 8 * length</code></li>
</ul>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="im">import</span> sys</span>
<span id="cb12-2"><a href="#cb12-2"></a>l <span class="op">=</span> []</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">17</span>):</span>
<span id="cb12-4"><a href="#cb12-4"></a>    l.append(i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="bu">print</span>(<span class="ss">f"List len = </span><span class="sc">{</span><span class="bu">len</span>(l)<span class="sc">}</span><span class="ss">, size = </span><span class="sc">{</span>sys<span class="sc">.</span>getsizeof(l)<span class="sc">}</span><span class="ss"> bytes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List len = 1, size = 88 bytes
List len = 2, size = 88 bytes
List len = 3, size = 88 bytes
List len = 4, size = 88 bytes
List len = 5, size = 120 bytes
List len = 6, size = 120 bytes
List len = 7, size = 120 bytes
List len = 8, size = 120 bytes
List len = 9, size = 184 bytes
List len = 10, size = 184 bytes
List len = 11, size = 184 bytes
List len = 12, size = 184 bytes
List len = 13, size = 184 bytes
List len = 14, size = 184 bytes
List len = 15, size = 184 bytes
List len = 16, size = 184 bytes
List len = 17, size = 248 bytes</code></pre>
</div>
</div>
<p>There is a fixed overhead of <span class="math inline">\(56\)</span> bytes (the object header, type pointer, reference count ) etc.</p>
<p>For each size tier, the calculation is approximately:</p>
<ul>
<li>88 bytes = 56 + 32(4 slots)</li>
<li>120 bytes = 56 + 64(8 slots)</li>
<li>184 bytes = 56 + 128(16 slots)</li>
<li>248 bytes =56 + 192(24 slots)</li>
</ul>
<p>We shrink when the list size goes below <span class="math inline">\(1/2\)</span> of the allocated storage. This is why appending to Python lists is <span class="math inline">\(O(1)\)</span> amortized time - most appends just fill unused capacity, and only occasional appends trigger a reallocation.</p>
</section>
<section id="overallocation-of-dictionaries-and-sets" class="level1">
<h1>Overallocation of dictionaries and sets</h1>
<p>These are represented as fixed-length hash tables. We overallocate when we reach <span class="math inline">\(2/3\)</span>rd of the capacity of a dictionary of set. For small dictionaries or sets, we quadruple the capacity else we double the capacity.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="quasar-chunawala/quantdev" data-repo-id="R_kgDOL2t5-A" data-category="General" data-category-id="DIC_kwDOL2t5-M4ClndQ" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>