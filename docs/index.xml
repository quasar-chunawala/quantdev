<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>quantdev.blog</title>
<link>http://quantdev.blog/index.html</link>
<atom:link href="http://quantdev.blog/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Tue, 16 Dec 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>How libstdc++ std::unordered_map is implemented?</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>We all love maps. A map is simply a data-structure that allows you to associate a key with some kind of value. They are fast and help to solve a large number of problems. Have you wondered what the internal implementation of a map looks like? In this post, I am going to explore the implementation details of unordered associative containers from the standard library(GCC’s <code>libstdc++</code> implementation).</p>
<p>Currently there are four types of unordered associative containers:</p>
<ul>
<li><code>std::unordered_map</code></li>
<li><code>std::unordered_set</code></li>
<li><code>std::unordered_multimap</code></li>
<li><code>std::unordered_multiset</code></li>
</ul>
<p>Usually, they are implemented on top of some kind of container. I am going to jump into the implementation of this <code>HashTable</code> container directly, because that’s where all the interesting stuff is hidden.</p>
<p>I’ll focus on the key-value containers with a unique set of keys(<code>std::unordered_map</code> and <code>std::unordered_set</code>) which have mostly similar logic.</p>
<p>GCC’s implementation can be found in the <a href="https://github.com/gcc-mirror/gcc/blob/127cd406/libstdc++-v3/include/bits/hashtable.h"><code>hashtable.h</code> header</a>. There are a lot of names with leading underscores. Not everyone is used to such code, but the standard library implementers have no choice, but to avoid collisions with user-defined names.</p>
</section>
<section id="data-layout" class="level1">
<h1>Data Layout</h1>
<section id="nodes" class="level2">
<h2 class="anchored" data-anchor-id="nodes">Nodes</h2>
<p>One of the basic building blocks of the <code>_Hashtable</code> is a node. Each node is allocated from the heap and stores container data along with metadata information to maintain the hash table data-structure.</p>
<p>The node itself is a compound entity and contains several parts, some of them, optional. The design of the node <code>structs</code> brings to mind Russian dolls, because they are nested to each other.</p>
<div class="{text-center}">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/Russian-Matroshka.jpg" class="img-fluid figure-img" data-scale="50%"></p>
<figcaption class="figure-caption">Russian dolls</figcaption>
</figure>
</div>
</div>
<p>The more complex node type(with more data) is inherited from the simpler node type(with a little bit less data). Let us walk through the components bottom up(from simpler to complex).</p>
<p>First, <code>_Hash_node_base</code> is defined in the following way. It has only <code>_M_nxt</code> field, which is a pointer to the next node of the hash table.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_base</span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> _M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-6"></span>
<span id="cb1-7">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>_Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> __next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>__next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The next one <code>_Hash_node_value_base</code> is a little bit more interesting(see the actual code <a href="https://github.com/gcc-mirror/gcc/blob/b9b7981f3d6919518372daf4c7e8c40dfc58f49d/libstdc%2B%2B-v3/include/bits/hashtable_policy.h#L318-L345">here</a>). <code>_Hash_node_value_base</code> is responsible for storing the actual element value in the <code>_M_storage</code> member variable. It also provides accessor methods to retrieve the stored value.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_value_base</span>
<span id="cb2-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5"></span>
<span id="cb2-6">    __gnu_cxx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>__aligned_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> _M_storage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-7"></span>
<span id="cb2-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb2-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>It is a templated class with <code>_Value</code> template parameter that represents the <code>value_type</code>. <code>_Value</code> type is wrapped into <code>__gnu_cxx::__aligned_buffer</code> (thin wrapper around <code>std::aligned_storage</code>) to decouple memory allocation from actual object creation.</p>
<p>The next struct is <code>_Hash_node_code_cache</code> and it implements hash value caching logic. When searching for a key in an unordered map, (i) we need to compute the hash-code of the search key, <img src="https://latex.codecogs.com/png.latex?h(k)">, (ii) find the right bucket <code>idx = h(k) % table_size</code> and then (iii) walk the collision chain comparing each node’s key with you key <img src="https://latex.codecogs.com/png.latex?k">. When keys are large or complex like <code>std::string</code>, using the equality predicate and doing full key comparisons for every node in the chain is expensive. So, we can choose the cach the hash code with each node:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> __cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_code_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> _M_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Stored hash value</span></span>
<span id="cb3-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Specialization when caching is disabled</span></span>
<span id="cb3-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_code_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Empty - no overhead</span></span>
<span id="cb3-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>This way Empty Base Class Optimization(EBCO) can be leveraged, since <code>_Hash_node_code_cache</code> will be extended by inheritance. And that’s exactly what <code>_Hash_node_value</code> is doing:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> _Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_value</span>
<span id="cb4-3">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _Hash_node_value_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-4">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> _Hash_node_code_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-5">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The size of the <code>_Hash_node_value</code> will be the same as size of <code>_Hash_node_value_base&lt;_Value&gt;</code> in case template argument <code>_Cache_hash_code</code> is <code>false</code> as <code>_Hash_node_code_cache</code> will be an empty struct.</p>
<p>The final piece of the puzzle is the <code>_Hash_node</code> that combines everything above together:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> _Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node</span>
<span id="cb5-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _Hash_node_base</span>
<span id="cb5-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> _Hash_node_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> _Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb5-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-6">    _Hash_node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb5-7">    _M_next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span></span>
<span id="cb5-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Hash_node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>_M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Below is a picture of the <code>_Hash_node</code> struct data layout to better visualize what’s going on.</p>
<pre><code>┌──────────────────────────────────────────────────────────────┐
│ _Hash_node&lt;Value&gt;                                            │
├──────────────────────────────────────────────────────────────┤
│ inherits from _Hash_node_base                                │
|--------------------------------------------------------------|
│       _Hash_node_base*          _M_nxt; // ptr to next node  │
├──────────────────────────────────────────────────────────────┤
| inherits from _Hash_node_value                               |
|--------------------------------------------------------------|
|   inherits from _Hash_node_value_base                        |
|--------------------------------------------------------------|
│       aligned_buffer&lt;Value&gt;     _M_storage;    // The value  │
├--------------------------------------------------------------┤
|   inherits from_Hash_node_code_cache                         |
|--------------------------------------------------------------|
│       size_t                    _M_hash_code;  // Cached hash│
└──────────────────────────────────────────────────────────────┘</code></pre>
<p>Summarizing, _Hash_node (directly or inherited from base structs) contains the following data.</p>
<ul>
<li><code>_Hash_node_base* _M_nxt</code> is a pointer to the next element in the linked list of hash table elements.</li>
<li><code>__gnu_cxx::__aligned_buffer&lt;_Value&gt; _M_storage</code> — node data itself. For example for <code>std::unordered_map&lt;std::string, int&gt;</code> container <code>_Value</code> template argument is <code>std::pair&lt;const std::string, int&gt;</code>.</li>
<li><code>std::size_t _M_hash_code</code> optional cached value of key’s hash.</li>
</ul>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/index.html</guid>
  <pubDate>Tue, 16 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Implementing vector&lt;T&gt;</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/implementing_vector/index.html</link>
  <description><![CDATA[ 




<section id="writing-your-own-vectort-training-implementation" class="level1">
<h1>Writing your own <code>vector&lt;T&gt;</code> training implementation</h1>
<p>In this blog post, we will write a naive <code>vector&lt;T&gt;</code> training implementation. Coding up these training implementations, handling corner cases, getting your code reviewed, revisiting your design is very effective at understanding the inner workings of STL data-strucures and writing good C++ code. I adopt a gradual refinement approach, so my first versions will be simpler but less efficient.</p>
<blockquote class="blockquote">
<h4 id="if-you-know-stdvector-you-know-half-of-c." class="anchored"><em>If you know <code>std::vector</code>, you know half of C++.</em></h4>
<p>– Bjarne Stroustrup</p>
</blockquote>
<p>Informally, a <code>std::vector&lt;T&gt;</code> represents a dynamically allocated array that can grow as needed. As with any array, a <code>std::vector&lt;T&gt;</code> is a sequence of elements of type <code>T</code> arranged contigously in memory. We will put our homegrown version of <code>vector&lt;T&gt;</code> under the <code>dev</code> namespace.</p>
<p>The internal representation of a <code>vector</code> like type has a book-keeping node that consists of: - A pointer to the raw data (a block of memory that will hold elements of type <code>T</code>) - Size of the container(the number of elements in the container) - Capacity</p>
<p>It’s important to distinguish between <code>size</code> and <code>capacity</code>. <code>size</code> is the number of elements currently in the container. When <code>size == capacity</code>, the container becomes full and will need to grow, which means allocating more member, copying the elements from the old storage to the new storage and getting rid of the old storage.</p>
<p>For those of you, who want to first attempt writing a basic implementation yourself, I present it in the form a task.</p>
<section id="the-problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-statement">The problem statement</h2>
<blockquote class="blockquote">
<h4 id="your-task" class="anchored">Your Task</h4>
</blockquote>
<p>Implement your own version of a vector with the following methods:</p>
<ul>
<li><code>push_back</code> – Adds an element to the back.</li>
<li><code>at</code> – Retrieves an element by index.</li>
<li><code>getSize</code> – Gets the size of the container.</li>
<li><code>getCapacity</code> – Gets the capacity of the container.</li>
<li><code>shrinkToFit</code> – Shrinks the capacity to equal the size of the container.</li>
<li><code>pop_back</code> – Removes the last element in the container. Will never be called on an empty container.</li>
</ul>
<blockquote class="blockquote">
<h4 id="requirements" class="anchored">Requirements</h4>
</blockquote>
<ul>
<li>Do not worry about memory alignment or advanced optimizations.</li>
<li>Do not use <code>std::vector</code> in your <code>dev::vector</code> implementation.</li>
<li>Your vector’s capacity must start at 1.</li>
<li>The capacity should triple every time it is reached.</li>
</ul>
<p>For more such C++ coding tasks, visit <a href="https://getcracked.io/problem/1/implement-vector">getcracked.io</a>.</p>
</section>
<section id="a-basic-implementation" class="level2">
<h2 class="anchored" data-anchor-id="a-basic-implementation">A basic implementation</h2>
<p>Take a look at my submission. I used uninitialized memory algorithms, where necessary.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Write your solution here</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// C++20 for C++</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb1-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdint&gt;</span></span>
<span id="cb1-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;format&gt;</span></span>
<span id="cb1-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;initializer_list&gt;</span></span>
<span id="cb1-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb1-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdexcept&gt;</span></span>
<span id="cb1-11"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;type_traits&gt;</span></span>
<span id="cb1-12"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> getcracked <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-18"></span>
<span id="cb1-19">   <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb1-20">    Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-23"></span>
<span id="cb1-24">   <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb1-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-26">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>get_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-27">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb1-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)))},</span></span>
<span id="cb1-29">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-30">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-31"></span>
<span id="cb1-32">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> initial_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-33">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))},</span></span>
<span id="cb1-34">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-35">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-37">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_fill_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> initial_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-38">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-39">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-40">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-41">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-42">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-43">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-44"></span>
<span id="cb1-45">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>initializer_list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-46">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-47">                                                    list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()))},</span></span>
<span id="cb1-48">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()},</span></span>
<span id="cb1-49">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-50">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-51">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-52">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-53">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-54">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-55">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-56">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-57">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-58">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-59">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-60">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-61">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-62"></span>
<span id="cb1-63">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-64">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())},</span></span>
<span id="cb1-65">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()},</span></span>
<span id="cb1-66">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-67">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-68">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform a deep-copy of all the elements</span></span>
<span id="cb1-69">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-70">                                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-71">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-72">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-73">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb1-74">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error while copying in copy ctor </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-75">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logic_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-76">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-77">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-78"></span>
<span id="cb1-79">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span></span>
<span id="cb1-80">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)},</span></span>
<span id="cb1-81">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)},</span></span>
<span id="cb1-82">          <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-83"></span>
<span id="cb1-84">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-85">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-86">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-87">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-88">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-89"></span>
<span id="cb1-90">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-91">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-92">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-93">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-94"></span>
<span id="cb1-95">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-96">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-97">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-98">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-99"></span>
<span id="cb1-100">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-101"></span>
<span id="cb1-102">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Element element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-103">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-104">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-105">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate new memory</span></span>
<span id="cb1-106">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-107">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-108">            Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> new_memory_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb1-109">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-110">            Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr_to_new_element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-111"></span>
<span id="cb1-112">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-113">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Construct the new element in new memory block</span></span>
<span id="cb1-114">                ptr_to_new_element <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb1-115">                    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_memory_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-116">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-117">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-118">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb1-119">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to copy-construct element : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-120">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>c_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-121">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-122"></span>
<span id="cb1-123">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-124">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy/move- the elements from the old storage to new</span></span>
<span id="cb1-125">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-126">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-127">                                            new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-128">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-129">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-130">                                            new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-131">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-132">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-133">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_to_new_element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-134">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-135">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb1-136">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to copy/move data from old to new storage, "</span></span>
<span id="cb1-137">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exception : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-138">                    ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-139">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logic_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-140">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-141"></span>
<span id="cb1-142">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Destroy the objects in the old storage</span></span>
<span id="cb1-143">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-144">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-145">                p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;~</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-146">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-147"></span>
<span id="cb1-148">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Deallocate old storage</span></span>
<span id="cb1-149">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-150"></span>
<span id="cb1-151">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reassign internal buffer pointer and update size and capacity</span></span>
<span id="cb1-152">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-153">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-154">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-155">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-156">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-157">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-158">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-159">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-160">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb1-161">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to copy-construct element, exception : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-162">                    ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-163">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logic_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-164">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-165">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-166">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-167"></span>
<span id="cb1-168">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-169">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-170">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>out_of_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Array index out of bounds!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-171"></span>
<span id="cb1-172">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-173">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-174">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> shrink_to_fit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-175">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate a new memory block of capacity = m_size</span></span>
<span id="cb1-176">        Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> new_memory_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb1-177">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-178"></span>
<span id="cb1-179">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-180">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy/move the elements from the old storage to new storage</span></span>
<span id="cb1-181">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-182">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-183">                                        new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-184">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-185">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-186">                                        new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-187">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-188">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-189">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-190">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb1-191">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Internal error in shrink_to_fit() : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-192">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logic_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-193">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-194"></span>
<span id="cb1-195">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Destroy objects in old storage and deallocate memory</span></span>
<span id="cb1-196">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-197">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-198">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-199">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Deallocate memory</span></span>
<span id="cb1-200">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-201"></span>
<span id="cb1-202">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reassign internal buffer pointer and set size and capacity</span></span>
<span id="cb1-203">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-204">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-205">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-206">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> pop_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-207">        Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr_to_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-208">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_to_last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-209">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-210">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-211"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-212"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// namespace getcracked</span></span>
<span id="cb1-213"></span>
<span id="cb1-214"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-215">    getcracked<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-216">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-217">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-218">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v[0] = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-219">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"size = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-220">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"capacity = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-221"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/M491zKcdz">Compiler Explorer</a></p>
</section>
<section id="adding-support-for-other-methods" class="level2">
<h2 class="anchored" data-anchor-id="adding-support-for-other-methods">Adding support for other methods</h2>
<section id="iterators" class="level3">
<h3 class="anchored" data-anchor-id="iterators">Iterators</h3>
<p>C++ containers usually expose iterators as part of their interface and ours will be no exception. We will define type aliases for the <code>const</code> and non-<code>const</code> iterator types, as this makes it simpler to implement alternatives.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb2-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb2-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb2-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb2-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> iterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_iterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> const_pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-15">    pointer <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-16">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-17">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-18"></span>
<span id="cb2-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-20"></span>
<span id="cb2-21">    iterator begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-22">    const_iterator begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-23">    iterator end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-24">    const_iterator end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/MojqWhezr">Compiler Explorer</a></p>
</section>
<section id="basic-services-of-a-vector-like-class" class="level3">
<h3 class="anchored" data-anchor-id="basic-services-of-a-vector-like-class">Basic services of a vector-like class</h3>
<p>There is more to writing a convenient dynamic array type. For example, member functions that let you access the <code>first()</code> element or the last <code>back()</code> element or that let you access the element at a specific index in the array using square brackets are all to be expected.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb3-2">reference <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb3-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb3-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-5"></span>
<span id="cb3-6">const_reference <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb3-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// precondition: !empty()</span></span>
<span id="cb3-11">reference front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-12">const_reference front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-13">reference back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-14">const_reference back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Comparing two <code>vector&lt;T&gt;</code> objects for equivalence or lack thereof is a relatively easy matter if we use algorithms:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//...</span></span>
<span id="cb4-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> </span>
<span id="cb4-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>equal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb4-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="implementing-reserve" class="level3">
<h3 class="anchored" data-anchor-id="implementing-reserve">Implementing <code>reserve()</code></h3>
<p><code>reserve(size_type new_capacity)</code> increases the capacity of the vector(the total number of elements that the vector can hold without requiring reallocation) to a value that’s greater or equal to <code>new_capacity</code>. If <code>new_capacity</code> is greater than the current <code>capacity()</code>, new storage is allocated, otherwise the function does nothing.</p>
<p>We introduce the helper functions <code>allocate_helper</code> and <code>copy_old_storage_to_new</code>.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Dynamically allocates a chunk of uninitialized memory on the heap</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// that can hold `new_capacity` number of elements.</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocation excepts are propogated to the caller.</span></span>
<span id="cb5-4">pointer allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb5-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-7"></span>
<span id="cb5-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pointer ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copies elements from old storage to new</span></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If T's copy/move ctor throws, the objects already constructed are</span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// destroyed and the exception is propagated to the caller.</span></span>
<span id="cb5-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pointer source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> pointer destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;){</span></span>
<span id="cb5-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-21">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-23">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-27"></span>
<span id="cb5-28"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb5-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-31">    </span>
<span id="cb5-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-34">        copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-35">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-36">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb5-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-39">    </span>
<span id="cb5-40">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-41">    deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-42">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-43">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    </span>
<span id="cb5-44"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/ajWYcjaYd">Compiler Explorer</a></p>
<p>There’s a general trick that you would have seen in all of this. Do not modify your object until you know, you can safely do. Try to do the potentially throwing operations first, then do the operations until you can mutate your object. You will sleep better, and the risks of object corruption will be alleviated.</p>
</section>
<section id="implementing-resize" class="level3">
<h3 class="anchored" data-anchor-id="implementing-resize">Implementing <code>resize()</code></h3>
<p>The distinction between <code>resize()</code> and <code>reserve()</code> is that <code>reserve()</code> only affects the capacity of the container, whereas <code>resize()</code> modifies the size and capacity both.</p>
<p>The <code>resize(size_type new_size)</code> method resizes the container to contain <code>count</code> elements:</p>
<ul>
<li>If the <code>new_size</code> is equal to the current size, do nothing.</li>
<li>If the current size is greater than the <code>new_size</code>, the container is reduced to its first <code>new_size</code> elements.</li>
<li>If the current size is less than <code>new_size</code>, then:
<ul>
<li>Additional default-constructed elements are appended.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb6-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> current_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-5"></span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reduce the container to count elements</span></span>
<span id="cb6-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-11"></span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-14">        reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-15"></span>
<span id="cb6-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Default construct elements at indicates</span></span>
<span id="cb6-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [current_size,...,new_size-1]</span></span>
<span id="cb6-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> current_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-19">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{});</span></span>
<span id="cb6-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-21">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>    </span></code></pre></div>
</section>
</section>
<section id="how-to-think-about-adding-elements-to-our-container" class="level2">
<h2 class="anchored" data-anchor-id="how-to-think-about-adding-elements-to-our-container">How to think about adding elements to our container?</h2>
<p>We will code up a <code>push_back(T&amp;&amp;)</code> member function that accepts a universal reference <code>T&amp;&amp;</code>. If <code>T</code> is move constructible, then the value will be moved. If <code>T</code> is copy constructible then the value will be copied.</p>
<p>The <code>emplace_back(Args...)</code> will take a variadic pack of constructor arguments, and then perfectly forward them to the constructor of a <code>T</code> object, that will be placed at the end of the container. A reference to the newly constructed object is returned by <code>emplace_back()</code>, for convenience, in case the user-code would like to use it right away.</p>
<p>We would like to first check whether the container is full. We have a dichotomy. If the container is full, we take the so-called slow path, else we take the fast lane.</p>
<section id="push_back_slow_pathvalue" class="level3">
<h3 class="anchored" data-anchor-id="push_back_slow_pathvalue"><code>push_back_slow_path(value)</code></h3>
<p>In this case, we would like to grow our container; we allocate more memory, than what the container currently holds. We leave the memory uninitialized. Memory allocation, can of course, fail.</p>
<p>We then add the new value at the index <code>m_size</code>. Appending the new element may fail.</p>
<p>We copy/move construct the existing elements of the container from the old storage to the new block of storage.</p>
<p>If all three steps were successful, we deallocate the old storage and return it back before replacing the values in the member variables <code>m_data</code>, <code>m_size</code> and <code>m_capacity</code>.</p>
<p>If either of the last couple of steps fail, we free the newly obtained block of storage.</p>
</section>
<section id="push_back_fast_pathvalue" class="level3">
<h3 class="anchored" data-anchor-id="push_back_fast_pathvalue"><code>push_back_fast_path(value)</code></h3>
<p>In this case, we simply copy/move construct <code>value</code> at the end of the container and update the size of the container.</p>
</section>
<section id="edge-case" class="level3">
<h3 class="anchored" data-anchor-id="edge-case">Edge-case</h3>
<p>Consider the following edge-case, where the <code>value</code> to be added is an element of the vector itself. If there is a reallocation, then the elements of the container are relocated to a new region. So, <code>value</code> might become a dangling reference.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1">dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-3">    vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb7-4">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Our design takes care of this edge case.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb8-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb8-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// allocate more memory</span></span>
<span id="cb8-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb8-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> growth_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb8-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-8"></span>
<span id="cb8-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy-construct the new value at the index m_size</span></span>
<span id="cb8-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb8-13">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow                </span></span>
<span id="cb8-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-16">    </span>
<span id="cb8-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy/move construct the existing elements </span></span>
<span id="cb8-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of the container from the old storage </span></span>
<span id="cb8-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the new block of storage.</span></span>
<span id="cb8-21">        copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb8-23">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-24">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb8-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-27"></span>
<span id="cb8-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// deallocate the old storage, if we are here</span></span>
<span id="cb8-29">    deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-30"></span>
<span id="cb8-31">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-32">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-33">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-34"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-35"></span>
<span id="cb8-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb8-37"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb8-38">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-39">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-40"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>        </span>
<span id="cb8-41"></span>
<span id="cb8-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb8-43"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb8-44"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb8-46">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-47">        push_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb8-48">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-50">        push_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb8-51">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-52"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="coding-up-emplace_back" class="level3">
<h3 class="anchored" data-anchor-id="coding-up-emplace_back">Coding up <code>emplace_back</code></h3>
<p>Again we have a fork - <code>emplace_back_slow_path</code> and <code>emplace_back_fast_path</code>.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb9-2">reference emplace_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb9-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// allocate more memory</span></span>
<span id="cb9-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb9-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> growth_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb9-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-8"></span>
<span id="cb9-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy/move construct the existing elements </span></span>
<span id="cb9-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of the container from the old storage </span></span>
<span id="cb9-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the new block of storage.</span></span>
<span id="cb9-13">        copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb9-15">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb9-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-18"></span>
<span id="cb9-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb9-20">    deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-21">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb9-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-25"></span>
<span id="cb9-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb9-27">reference emplace_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb9-28">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb9-29">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb9-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-32"></span>
<span id="cb9-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb9-34">reference emplace_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb9-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb9-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> emplace_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb9-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb9-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> emplace_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb9-39"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/eKfnMfvqs">Compiler Explorer</a></p>
</section>
</section>
<section id="implementing-insertconst_iterator-position-const-t-value" class="level2">
<h2 class="anchored" data-anchor-id="implementing-insertconst_iterator-position-const-t-value">Implementing <code>insert(const_iterator position, const T&amp; value)</code></h2>
<p>The <code>insert</code> function inserts the given value into the vector before the specified <code>position</code>, possibly using move-semantics. Note that, this kind of operation could be expensive for a vector, and if it is frequently used, it can trigger reallocation. The user should consider using <code>std::list</code>.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb10-2">iterator insert_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_iterator insert_it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If a reallocation is triggered, all iterators are</span></span>
<span id="cb10-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// invalidated and additionally `value` would also become a</span></span>
<span id="cb10-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// dangling reference, if it refers to an existing element of</span></span>
<span id="cb10-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the vector.</span></span>
<span id="cb10-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TODO</span></span>
<span id="cb10-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb10-11">iterator insert_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_iterator position<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> position<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb10-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move_backward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb10-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-18">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb10-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>copy_backward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb10-20">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-25"></span>
<span id="cb10-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb10-27">iterator insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_iterator position<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-28"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb10-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> insert_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>position<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb10-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb10-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> insert_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>position<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb10-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
</section>
<section id="complete-implementation-with-unit-tests" class="level1">
<h1>Complete implementation with unit tests</h1>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Write your solution here</span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// C++20 for C++</span></span>
<span id="cb11-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;gtest/gtest.h&gt;</span></span>
<span id="cb11-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb11-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdint&gt;</span></span>
<span id="cb11-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;format&gt;</span></span>
<span id="cb11-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;initializer_list&gt;</span></span>
<span id="cb11-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb11-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb11-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdexcept&gt;</span></span>
<span id="cb11-11"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;type_traits&gt;</span></span>
<span id="cb11-12"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb11-13"></span>
<span id="cb11-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-17">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-18">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-19">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb11-20">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb11-21">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb11-22">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb11-23">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> iterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-24">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_iterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> const_pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-25">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-26">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> growth_factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-27"></span>
<span id="cb11-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb11-29">        pointer <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-30">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-31">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-32"></span>
<span id="cb11-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb11-34"></span>
<span id="cb11-35">        iterator begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-36">        const_iterator begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-37">        iterator end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-38">        const_iterator end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-39">        </span>
<span id="cb11-40">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-41">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-42"></span>
<span id="cb11-43">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb11-44">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)))},</span></span>
<span id="cb11-45">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb11-46">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb11-47"></span>
<span id="cb11-48">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> initial_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-49">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))},</span></span>
<span id="cb11-50">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb11-51">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-52">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-53">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_fill_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> initial_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-54">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-55">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-56">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-57">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-58">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-59">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-60"></span>
<span id="cb11-61">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>initializer_list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-62">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb11-63">                                                    list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()))},</span></span>
<span id="cb11-64">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()},</span></span>
<span id="cb11-65">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-66">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-67">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-68">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-69">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-70">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-71">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-72">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-73">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-74">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-75">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-76">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-77">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-78"></span>
<span id="cb11-79">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-80">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()))},</span></span>
<span id="cb11-81">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()},</span></span>
<span id="cb11-82">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-83">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-84">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform a deep-copy of all the Ts</span></span>
<span id="cb11-85">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-86">                                        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-87">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-88">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-89">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb11-90">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error while copying in copy ctor </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-91">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logic_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-92">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-93">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-94"></span>
<span id="cb11-95">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span></span>
<span id="cb11-96">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)},</span></span>
<span id="cb11-97">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)},</span></span>
<span id="cb11-98">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span> </span>
<span id="cb11-99">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb11-100"></span>
<span id="cb11-101">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-102">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-103">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-104">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-105">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-106"></span>
<span id="cb11-107">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-108">            vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-109">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-110">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-111"></span>
<span id="cb11-112">        vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-113">            vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-114">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-115">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-116"></span>
<span id="cb11-117">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-118">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-119"></span>
<span id="cb11-120">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-121">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-122">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// allocate more memory</span></span>
<span id="cb11-123">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-124">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-125">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> growth_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-126">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-127"></span>
<span id="cb11-128">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-129">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy-construct the new value at the index m_size</span></span>
<span id="cb11-130">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-131">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-132">                deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-133">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow                </span></span>
<span id="cb11-134">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-135">            </span>
<span id="cb11-136">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-137">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy/move construct the existing elements </span></span>
<span id="cb11-138">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of the container from the old storage </span></span>
<span id="cb11-139">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the new block of storage.</span></span>
<span id="cb11-140">                copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-141">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-142">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-143">                deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-144">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb11-145">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-146"></span>
<span id="cb11-147">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// deallocate the old storage, if we are here</span></span>
<span id="cb11-148">            deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-149"></span>
<span id="cb11-150">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-151">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-152">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-153">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-154"></span>
<span id="cb11-155">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-156">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-157">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-158">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-159">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>        </span>
<span id="cb11-160"></span>
<span id="cb11-161">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-162">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-163">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-164">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb11-165">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-166">                push_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb11-167">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-168">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-169">                push_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb11-170">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-171">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-172">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*void push_back(T value) {</span></span>
<span id="cb11-173"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            std::size_t offset = size();</span></span>
<span id="cb11-174"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            if (m_size == m_capacity - 1) {</span></span>
<span id="cb11-175"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                // Allocate new memory</span></span>
<span id="cb11-176"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                std::size_t new_size = size() + 1;</span></span>
<span id="cb11-177"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                std::size_t new_capacity = 3 * m_capacity;</span></span>
<span id="cb11-178"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                T* new_memory_block = static_cast&lt;T*&gt;(operator new(</span></span>
<span id="cb11-179"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    sizeof(T) * new_capacity));</span></span>
<span id="cb11-180"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                T* ptr_to_new_T{nullptr};</span></span>
<span id="cb11-181"></span>
<span id="cb11-182"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                try {</span></span>
<span id="cb11-183"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    // Construct the new T in new memory block</span></span>
<span id="cb11-184"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    ptr_to_new_T =</span></span>
<span id="cb11-185"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        new (new_memory_block + offset) T(value);</span></span>
<span id="cb11-186"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                } catch (std::exception&amp; ex) {</span></span>
<span id="cb11-187"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    operator delete(new_memory_block);</span></span>
<span id="cb11-188"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    std::string error_msg = std::format(</span></span>
<span id="cb11-189"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        "Failed to copy-construct T : {}", ex.what());</span></span>
<span id="cb11-190"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    throw std::logic_error(error_msg);</span></span>
<span id="cb11-191"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                }</span></span>
<span id="cb11-192"></span>
<span id="cb11-193"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                try {</span></span>
<span id="cb11-194"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    // Copy/move- the Ts from the old storage to new</span></span>
<span id="cb11-195"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    if constexpr (std::is_nothrow_move_constructible_v&lt;T&gt;) {</span></span>
<span id="cb11-196"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        std::uninitialized_move(m_data, m_data + offset,</span></span>
<span id="cb11-197"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                                new_memory_block);</span></span>
<span id="cb11-198"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    } else {</span></span>
<span id="cb11-199"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        std::uninitialized_copy(m_data, m_data + offset,</span></span>
<span id="cb11-200"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                                new_memory_block);</span></span>
<span id="cb11-201"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    }</span></span>
<span id="cb11-202"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                } catch (std::exception&amp; ex) {</span></span>
<span id="cb11-203"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    std::destroy_at(ptr_to_new_T);</span></span>
<span id="cb11-204"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    operator delete(new_memory_block);</span></span>
<span id="cb11-205"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    std::string error_msg = std::format(</span></span>
<span id="cb11-206"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        "Failed to copy/move data from old to new storage, "</span></span>
<span id="cb11-207"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        "exception : {}",</span></span>
<span id="cb11-208"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        ex.what());</span></span>
<span id="cb11-209"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    throw std::logic_error(error_msg);</span></span>
<span id="cb11-210"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                }</span></span>
<span id="cb11-211"></span>
<span id="cb11-212"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                // Destroy the objects in the old storage</span></span>
<span id="cb11-213"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                auto p{m_data};</span></span>
<span id="cb11-214"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                for (auto p{m_data}; p &lt; m_data + m_size; ++p) {</span></span>
<span id="cb11-215"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    p-&gt;~T();</span></span>
<span id="cb11-216"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                }</span></span>
<span id="cb11-217"></span>
<span id="cb11-218"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                // Deallocate old storage</span></span>
<span id="cb11-219"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                operator delete(m_data);</span></span>
<span id="cb11-220"></span>
<span id="cb11-221"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                // Reassign internal buffer pointer and update size and capacity</span></span>
<span id="cb11-222"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                m_data = new_memory_block;</span></span>
<span id="cb11-223"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                m_size = new_size;</span></span>
<span id="cb11-224"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                m_capacity = new_capacity;</span></span>
<span id="cb11-225"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            } else {</span></span>
<span id="cb11-226"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                try {</span></span>
<span id="cb11-227"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    std::construct_at(m_data + offset, value);</span></span>
<span id="cb11-228"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    m_size += 1;</span></span>
<span id="cb11-229"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                } catch (std::exception&amp; ex) {</span></span>
<span id="cb11-230"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    std::string error_msg = std::format(</span></span>
<span id="cb11-231"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        "Failed to copy-construct T, exception : {}",</span></span>
<span id="cb11-232"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                        ex.what());</span></span>
<span id="cb11-233"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                    throw std::logic_error(error_msg);</span></span>
<span id="cb11-234"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                }</span></span>
<span id="cb11-235"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            }</span></span>
<span id="cb11-236"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        }*/</span></span>
<span id="cb11-237">        </span>
<span id="cb11-238">        reference <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-239">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-240">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-241"></span>
<span id="cb11-242">        const_reference <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-243">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-244">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-245"></span>
<span id="cb11-246">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// precondition: !empty()</span></span>
<span id="cb11-247">        reference front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-248">        const_reference front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-249">        reference back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-250">        const_reference back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-251"></span>
<span id="cb11-252">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-253">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-254">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>out_of_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Array index out of bounds!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-255"></span>
<span id="cb11-256">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-257">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-258">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> shrink_to_fit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-259">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate a new memory block of capacity = m_size</span></span>
<span id="cb11-260">            T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> new_memory_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb11-261">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb11-262"></span>
<span id="cb11-263">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-264">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy/move the Ts from the old storage to new storage</span></span>
<span id="cb11-265">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-266">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-267">                                            new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-268">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-269">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-270">                                            new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-271">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-272">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-273">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-274">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb11-275">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Internal error in shrink_to_fit() : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-276">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logic_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-277">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-278"></span>
<span id="cb11-279">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Destroy objects in old storage and deallocate memory</span></span>
<span id="cb11-280">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-281">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-282">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-283">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Deallocate memory</span></span>
<span id="cb11-284">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-285"></span>
<span id="cb11-286">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reassign internal buffer pointer and set size and capacity</span></span>
<span id="cb11-287">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_memory_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-288">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-289">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-290">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> pop_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-291">            T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr_to_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-292">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_to_last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-293">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-294">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-295"></span>
<span id="cb11-296">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-297">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> </span>
<span id="cb11-298">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>equal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-299">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-300"></span>
<span id="cb11-301">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Dynamically allocates a chunk of uninitialized memory on the heap</span></span>
<span id="cb11-302">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// that can hold `new_capacity` number of elements.</span></span>
<span id="cb11-303">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocation excepts are propogated to the caller.</span></span>
<span id="cb11-304">        pointer allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-305">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb11-306">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-307"></span>
<span id="cb11-308">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pointer ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-309">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-310">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-311"></span>
<span id="cb11-312">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copies elements from old storage to new</span></span>
<span id="cb11-313">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If T's copy/move ctor throws, the objects already constructed are</span></span>
<span id="cb11-314">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// destroyed and the exception is propagated to the caller.</span></span>
<span id="cb11-315">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pointer source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> pointer destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-316">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;){</span></span>
<span id="cb11-317">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-318">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-319">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-320">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-321">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-322">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-323">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-324">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-325">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-326">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-327"></span>
<span id="cb11-328">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-329">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb11-330">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-331">            </span>
<span id="cb11-332">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-333">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-334">                copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-335">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-336">                deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-337">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb11-338">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-339"></span>
<span id="cb11-340">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-341">            deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-342">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-343">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-344">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-345"></span>
<span id="cb11-346">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-347">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> current_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-348">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-349">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-350"></span>
<span id="cb11-351">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-352">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-353">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reduce the container to count elements</span></span>
<span id="cb11-354">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-355">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-356"></span>
<span id="cb11-357">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-358">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-359">                reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-360"></span>
<span id="cb11-361">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Default construct elements at indicates</span></span>
<span id="cb11-362">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [current_size,...,new_size-1]</span></span>
<span id="cb11-363">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> current_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-364">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{});</span></span>
<span id="cb11-365">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-366">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-367">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-368"></span>
<span id="cb11-369">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-370">        reference emplace_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-371">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// allocate more memory</span></span>
<span id="cb11-372">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-373">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-374">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> growth_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-375">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-376"></span>
<span id="cb11-377">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-378">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy/move construct the existing elements </span></span>
<span id="cb11-379">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of the container from the old storage </span></span>
<span id="cb11-380">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the new block of storage.</span></span>
<span id="cb11-381">                copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-382">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-383">                deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-384">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb11-385">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-386"></span>
<span id="cb11-387">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb11-388">            deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-389">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-390">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-391">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-392">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-393"></span>
<span id="cb11-394">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-395">        reference emplace_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-396">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb11-397">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-398">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-399">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-400"></span>
<span id="cb11-401">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-402">        reference emplace_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-403">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb11-404">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> emplace_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb11-405">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb11-406">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> emplace_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb11-407">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-408">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>    </span>
<span id="cb11-409"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// namespace dev</span></span>
<span id="cb11-410"></span>
<span id="cb11-411">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> DefaultConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-412">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-413">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-414"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-415"></span>
<span id="cb11-416">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> InitializerListTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-417">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-418">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-419">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-420">    EXPECT_TRUE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-421">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-422">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-423">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-424"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-425"></span>
<span id="cb11-426">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ParameterizedConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-427">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-428">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-429">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-430">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-431">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-432"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-433"></span>
<span id="cb11-434">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CopyConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-435">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-436">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-437"></span>
<span id="cb11-438">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-439"></span>
<span id="cb11-440">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-441">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-442">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-443">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb11-444">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-445"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-446"></span>
<span id="cb11-447">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MoveConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-448">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-449">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb11-450">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-451">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-452">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-453">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-454">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-455"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-456"></span>
<span id="cb11-457">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CopyAssignmentTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-458"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-459">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-460">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-461">    v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-462"></span>
<span id="cb11-463">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-464">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-465">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-466">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-467">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb11-468">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-469"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-470"></span>
<span id="cb11-471">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MoveAssignmentTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-472"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-473">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-474">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-475">    v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-476"></span>
<span id="cb11-477">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-478">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-479">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-480">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-481">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-482">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-483"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-484"></span>
<span id="cb11-485">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> AtTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-486"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-487">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-488">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-489">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-490">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-491"></span>
<span id="cb11-492">    EXPECT_THROW<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>out_of_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-493"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-494"></span>
<span id="cb11-495">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> SubscriptOperatorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-496"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-497">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-498">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-499">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-500">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-501"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-502"></span>
<span id="cb11-503">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FrontAndBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-504"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-505">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-506">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-507">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-508"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-509"></span>
<span id="cb11-510">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> EmptyTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-511"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-512">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-513">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-514"></span>
<span id="cb11-515">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-516">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-517"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-518"></span>
<span id="cb11-519">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> SizeAndCapacityTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-520"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-521">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-522">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-523">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-524"></span>
<span id="cb11-525">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-526">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-527">    EXPECT_GT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-528"></span>
<span id="cb11-529">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-530">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-531">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-532"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-533"></span>
<span id="cb11-534"></span>
<span id="cb11-535">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ReserveTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-536"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-537">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-538">    v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-539">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-540">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-541"></span>
<span id="cb11-542">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-543">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> old_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-544">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-545">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-546">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> old_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-547">    v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-548">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-549">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-550">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-551">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-552"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-553"></span>
<span id="cb11-554">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ResizeTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-555"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-556">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-557">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-558"></span>
<span id="cb11-559">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-560">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-561">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-562"></span>
<span id="cb11-563">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-564">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-565"></span>
<span id="cb11-566">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-567">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-568">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-569">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-570"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-571"></span>
<span id="cb11-572">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PushBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-573"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-574">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-575">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-576">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-577">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-578"></span>
<span id="cb11-579">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-580">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-581">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-582"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-583"></span>
<span id="cb11-584">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PushBackSelfReferenceTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-585"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-586">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The design of push_back/insert is slightly hard to get right.</span></span>
<span id="cb11-587">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If the vector is full, then you reallocate(grow) the vector.</span></span>
<span id="cb11-588">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If the value to be added is a reference to an existing</span></span>
<span id="cb11-589">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// vector element, then value in vec.push_back(value) may become</span></span>
<span id="cb11-590">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a dangling reference, if it refers to the old storage (an element of the vector</span></span>
<span id="cb11-591">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// itself e.g. vec.back()). This test is meant for such an edge case.</span></span>
<span id="cb11-592">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-593">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-594">        vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-595">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-596">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-597"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-598"></span>
<span id="cb11-599">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> EmplaceBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-600"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-601">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Point</span>
<span id="cb11-602">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-603">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-604">        Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-605">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-606">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-607">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-608">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-609">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-610"></span>
<span id="cb11-611">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-612">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>emplace_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-613">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>emplace_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-614"></span>
<span id="cb11-615">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-616">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-617">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-618">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-619">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-620"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-621"></span>
<span id="cb11-622"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> argc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> argv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-623">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>testing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>InitGoogleTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>argc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> argv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-624">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> RUN_ALL_TESTS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-625"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/aYj9of7GT">Compiler Explorer</a></p>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/implementing_vector/index.html</guid>
  <pubDate>Mon, 15 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/implementing_vector/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Lambda Functions</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/lambda_functions/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I’ve got my hands on the <a href="https://leanpub.com/cpplambda">C++ lambda story</a> by <a href="https://leanpub.com/u/fenbf">Bartłomiej Filipek</a> and wanted to try out a few of the examples.</p>
</section>
<section id="lambdas-in-c11" class="level1">
<h1>Lambdas in C++11</h1>
<p>An example of the most minimal lambda expression is:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 1. the simplest lambda</span></span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]{};</span></span></code></pre></div>
<p><code>[]</code> section is called the lambda introducer and the empty <code>{}</code> part is for the function body.</p>
<p>By capturing a variable, you create a member copy of that variable in the closure type. Then, inside the lambda body, you can access it.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with a parameter</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> area <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> radius<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> *</span> radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> radius<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The arguments are passed into a lambda function like any regular function. The return type is not needed as the compiler will automatically deduce it.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-5">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb3-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In the above example, we explicitly set a return type. The trailing return type is also available for regular function declaration since C++11.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-7">    rrtutn param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Before the body of the lambda, you can use other specifiers. In the code, we used <code>mutable</code> (so that we can change the captured variable) and also <code>noexcept</code>. The third lambda uses <code>mutable</code> and <code>noexcept</code> and they have to appear in that order (you cannot write <code>noexcept mutable</code> as the compiler will reject it).</p>
<p>While the <code>()</code> part is optional, if you want to apply <code>mutable</code> or <code>noexcept</code> then <code>()</code> needs to be in the expression.</p>
<section id="core-definitions" class="level2">
<h2 class="anchored" data-anchor-id="core-definitions">Core Definitions</h2>
<p>The core definition from the C++ standard from <a href="https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#2">expr.prim.lambda#2</a> says:</p>
<blockquote class="blockquote">
<p>The evaluation of a lambda-expression results in a <em>prvalue</em> temporary. This temporary is called the <em>closure object</em>.</p>
</blockquote>
<p>From the above definition, we can understand that the compiler generates a unique wrapper class (closure type) from a lambda expression.</p>
<p>Consider the following code snip:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cmath&gt;</span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> cum_normal_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>erf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)))</span></span>
<span id="cb5-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://cppinsights.io/s/4f8ddfcc">CppInsights</a> reveals that the C++ compiler creates the following class, where the function call operator <code>()</code> is overloaded.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1">class __lambda_4_23</span>
<span id="cb6-2">{</span>
<span id="cb6-3">  public: </span>
<span id="cb6-4">  inline /*constexpr */ double operator()(double x) const</span>
<span id="cb6-5">  {</span>
<span id="cb6-6">    return 0.5 * (1.0 - erf(-x / sqrt(2.0)));</span>
<span id="cb6-7">  }  </span>
<span id="cb6-8"></span>
<span id="cb6-9">  /* ... */</span>
<span id="cb6-10">};</span>
<span id="cb6-11"></span>
<span id="cb6-12">__lambda_4_23 cum_normal_cdf = __lambda_4_23{};</span></code></pre></div>
</section>
<section id="constructors-and-copying" class="level2">
<h2 class="anchored" data-anchor-id="constructors-and-copying">Constructors and copying</h2>
<p>In the specification of the feature at <a href="https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#19">expr.prim.lambda</a>, we can also read the following:</p>
<blockquote class="blockquote">
<p>The closure-type associated with a lambda expression has a deleted default constructor and a deleted copy assignment operator.</p>
</blockquote>
<p>That’s why you cannot write:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> fooCopy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/7q9bbhro1">Compiler Explorer</a></p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1">&lt;source&gt;: In function 'int main()':</span>
<span id="cb8-2">&lt;source&gt;:9:19: error: use of deleted function 'main()::&lt;lambda()&gt;::&lt;lambda&gt;()'</span>
<span id="cb8-3">    9 |     decltype(foo) fooCopy;</span>
<span id="cb8-4">      |                   ^~~~~~~</span>
<span id="cb8-5">&lt;source&gt;:5:23: note: a lambda closure type has a deleted default constructor</span>
<span id="cb8-6">    5 |     auto foo = [&amp;x, &amp;y] {</span>
<span id="cb8-7">      |                       ^</span>
<span id="cb8-8">&lt;source&gt;:9:19: note: use '-fdiagnostics-all-candidates' to display considered candidates</span>
<span id="cb8-9">    9 |     decltype(foo) fooCopy;</span>
<span id="cb8-10">      |  </span></code></pre></div>
<p>However, we can copy lambdas:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cmath&gt;</span></span>
<span id="cb9-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb9-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;type_traits&gt;</span></span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;;</span></span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span>Point x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Point y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-10">                    pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>second <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb9-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-12"></span>
<span id="cb9-13">    Point p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-14">    Point origin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distance to (3,4) from the origin = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> origin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb9-16"></span>
<span id="cb9-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> distance_copy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_same_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>distance_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;);</span></span>
<span id="cb9-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/nf7MWaY4z">Compiler Explorer</a></p>
</section>
<section id="captures" class="level2">
<h2 class="anchored" data-anchor-id="captures">Captures</h2>
<p>The <code>[]</code> does not only introduce the lambda but also holds the list of <em>captured variables</em>. It’s called the <em>capture clause</em>. By capturing a variable from outside the scope of the lambda, you create a non-static data member in the closure type. Then, inside the lambda body, you can access it.</p>
<p>The syntax for captures in C++11 are:</p>
<div id="tbl-lambda-syntax" class="anchored">
<table class="table">
<caption>Table&nbsp;1: Lambda capture syntax in C++</caption>
<colgroup>
<col style="width: 38%">
<col style="width: 61%">
</colgroup>
<thead>
<tr class="header">
<th>Syntax</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>[&amp;]</code></td>
<td>Capture by reference all automatic storage duration variables declared in the reaching scope.</td>
</tr>
<tr class="even">
<td><code>[=]</code></td>
<td>Capture by value (create a copy) all automatic storage duration variables declared in the reaching scope.</td>
</tr>
<tr class="odd">
<td><code>[x, &amp;y]</code></td>
<td>Capture <code>x</code> by value, capture <code>y</code> by reference</td>
</tr>
<tr class="even">
<td><code>[args...]</code></td>
<td>Capture a template argument pack all by value</td>
</tr>
<tr class="odd">
<td><code>[&amp;args...]</code></td>
<td>Capture a template argument pack all by reference</td>
</tr>
<tr class="even">
<td><code>[this]</code></td>
<td>Captures the <code>this</code> pointer inside the member function</td>
</tr>
</tbody>
</table>
</div>
<p>Note that for <code>[=]</code> and <code>[&amp;]</code> cases, the compiler generates data members for all used variables inside the lambda body. This is a convenient syntax where you don’t want to explicitly mention which variables you capture.</p>
<section id="the-mutable-keyword" class="level3">
<h3 class="anchored" data-anchor-id="the-mutable-keyword">The <code>mutable</code> keyword</h3>
<p>By default the <code>operator()</code> of the closure type is marked as <code>const</code> and you cannot modify the captured variables inside the body of the lambda. If you want to change this behavior, you need to add the <code>mutable</code> keyword after the parameter list. This syntax removes the <code>const</code> from the call operator declaration in the closure type.</p>
<p>If you have a simple lambda expression with a <code>mutable</code>:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>It will be expanded into the following function object:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1">struct __lambda_x1 {</span>
<span id="cb11-2">    void operator()() { ++x; }</span>
<span id="cb11-3">    int x;</span>
<span id="cb11-4">};</span></code></pre></div>
<p>The call operator can change the value of the member-fields(capture variables).</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> print <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">": "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-7"></span>
<span id="cb12-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-9">    print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in main"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-11">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-12">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-13">        print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in foo"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-15">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb12-16">    print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in main()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/9Tncca1do">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1">in main: 1 1</span>
<span id="cb13-2">in foo: 2 2</span>
<span id="cb13-3">in main(): 1 1</span></code></pre></div>
<p>In the above example, we can change the values of <code>x</code> and <code>y</code>. Since those are only the copies of <code>x</code> and <code>y</code> from the enclosing scope, we don’t see their new values after <code>foo</code> is invoked.</p>
<p>On the other hand, if you capture by reference, you don’t need to apply the <code>mutable</code> keyword to modify the value. This is because the captured data members are references which means that you cannot rebound them to a new object anyway, but you can change the referenced values.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-7">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Yjjqdd3zf">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb15-1">Program stdout</span>
<span id="cb15-2">1</span>
<span id="cb15-3">2</span></code></pre></div>
<p>In the above example, the lambda is not specified with <code>mutable</code> but it can change the referenced value.</p>
<p>One important thing is that when you apply <code>mutable</code>, then you canot mark your resulting closure object with <code>const</code> as it prevents you from invoking the lambda!</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// lam(); // compile eror</span></span></code></pre></div>
<p>The last line won’t compile as we cannot call a non-<code>const</code> member function on a <code>const</code> object.</p>
</section>
<section id="capturing-global-variables" class="level3">
<h3 class="anchored" data-anchor-id="capturing-global-variables">Capturing Global Variables</h3>
<p>If you have a global variable and you use <code>[=]</code> in your lambda, you might think that your global object is also captured by value. But, it’s not.</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb17-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[=]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-8">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb17-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> increaseGlobal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-11">    increaseGlobal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb17-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> moreIncreaseGlobal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-14">    moreIncreaseGlobal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb17-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/aTG3qP5vM">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb18-1">10</span>
<span id="cb18-2">11</span>
<span id="cb18-3">12</span>
<span id="cb18-4">13</span></code></pre></div>
<p>In the above example, we have defined a static variable <code>global</code> and then used it with several lambdas defined in the <code>main()</code> function. If you run the code, then no matter the way you captgure, it will always point to the global object, and no local copies will be created.</p>
<p>Line 13 of the code causes the compiler to generate the following warning:</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb19-1">source&gt;: In function 'int main()':</span>
<span id="cb19-2">&lt;source&gt;:13:38: warning: capture of variable 'global' with non-automatic storage duration</span>
<span id="cb19-3">   13 |     const auto moreIncreaseGlobal = [global]() noexcept { ++global; };</span></code></pre></div>
<p>It’s because only variables with automatic storage duration can be captured.</p>
<p>If you use <code>[=]</code> explicitly, the compiler won’t help you and it generates an error.</p>
</section>
<section id="capturing-static-variables" class="level3">
<h3 class="anchored" data-anchor-id="capturing-static-variables">Capturing <code>static</code> variables</h3>
<p>Similar to capturing global variables, you’ll get the same issues with <code>static</code> objects:</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb20-2"></span>
<span id="cb20-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[=]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-7">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> increase <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-10">    increase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> moreIncrease <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-13">    moreIncrease<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-16"></span>
<span id="cb20-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-18">    bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/xbGbh3hTW">Compiler Explorer</a></p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb21-1">10</span>
<span id="cb21-2">11</span>
<span id="cb21-3">12</span>
<span id="cb21-4">13</span></code></pre></div>
</section>
<section id="caturing-a-class-member-and-the-this-pointer" class="level3">
<h3 class="anchored" data-anchor-id="caturing-a-class-member-and-the-this-pointer">Caturing a class member and the <code>this</code> pointer</h3>
<p>Things get a bit more complicated where you’re in a class member function and you want to capture a data member. Since all non-static data members are related to the <code>this</code> pointer, it also has to be stored somewhere.</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb22-2"></span>
<span id="cb22-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb22-5">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb22-6">        lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb22-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-8"></span>
<span id="cb22-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb22-11"></span>
<span id="cb22-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb22-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-14">    Baz b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-15">    b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb22-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/x3b3GEnox">Compiler Explorer</a></p>
<p>The code tries to capture <code>s</code> which is a data-member. But the compiler will emit the following message:</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb23-1">&lt;source&gt;: In member function 'void Baz::foo()':</span>
<span id="cb23-2">&lt;source&gt;:5:27: error: capture of non-variable 'Baz::s'</span>
<span id="cb23-3">    5 |         const auto lam = [s]() { std::cout &lt;&lt; s; };</span>
<span id="cb23-4">      |                           ^</span>
<span id="cb23-5">&lt;source&gt;:9:17: note: 'std::string Baz::s' declared here</span>
<span id="cb23-6">    9 |     std::string s;</span>
<span id="cb23-7">      |                 ^</span>
<span id="cb23-8">&lt;source&gt;: In lambda function:</span>
<span id="cb23-9">&lt;source&gt;:5:47: error: 'this' was not captured for this lambda function</span>
<span id="cb23-10">    5 |         const auto lam = [s]() { std::cout &lt;&lt; s; };</span></code></pre></div>
<p>To solve this issue, we have to capture the <code>this</code> pointer. Then, we have access to the data members. We can updaten the code to:</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb24-2"></span>
<span id="cb24-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb24-5">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb24-6">        lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-8"></span>
<span id="cb24-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb24-11"></span>
<span id="cb24-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb24-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-14">    Baz b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-15">    b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/jxfEEaT1b">Compiler Explorer</a></p>
<p>There are no compiler errors now.</p>
<p>We can also use <code>[=]</code> or <code>[&amp;]</code> to capture <code>this</code>. They both have the same effect in C++11/14. Note that, we captured <code>this</code> by value to a pointer. That’s why we have access to the initial data-member and not its copy.</p>
<p>The value of the value-captured variable is the value at the time the lambda is defined - not when it is used. The value of a ref-captured variable is the value when the lambda is used - not when it is defined.</p>
<p>The C++ closures do not extend the lifetimes of the captured references. We must be sure that the capture variable still lives when the lambda is invoked.</p>
</section>
<section id="moveable-only-objects" class="level3">
<h3 class="anchored" data-anchor-id="moveable-only-objects">Moveable-only objects</h3>
<p>If you have an object that is moveable only(for example a <code>unique_ptr</code>), then we can move the object into a member of the closure type:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb25-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb25-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unique_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Before definition pointer in main(): "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer in lambda: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value in lambda: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-12"></span>
<span id="cb25-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"After definition pointer in main(): "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-14">    bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb25-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Te795K88b">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb26-1">Before definition pointer in main(): 0x209772b0</span>
<span id="cb26-2">After definition pointer in main(): 0</span>
<span id="cb26-3">pointer in lambda: 0x209772b0</span>
<span id="cb26-4">value in lambda: 10</span></code></pre></div>
</section>
<section id="preserving-const" class="level3">
<h3 class="anchored" data-anchor-id="preserving-const">Preserving <code>const</code></h3>
<p>If you capture a <code>const</code> variable, then the <code>const</code>-ness is preserved:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb27-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;type_traits&gt;</span></span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb27-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb27-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_const<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;::</span>value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-8">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-10"></span>
<span id="cb27-11">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb27-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/GEGnYh81K">Compiler Explorer</a></p>
<p>This code will not compile.</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb28-1">&lt;source&gt;: In lambda function:</span>
<span id="cb28-2">&lt;source&gt;:9:15: error: assignment of read-only variable 'x'</span>
<span id="cb28-3">    9 |             x = 11;</span>
<span id="cb28-4">      |             ~~^~~~</span>
<span id="cb28-5">&lt;source&gt;: In function 'int main()':</span>
<span id="cb28-6">&lt;source&gt;:12:5: error: expected ',' or ';' before 'foo'</span>
<span id="cb28-7">   12 |     foo();</span>
<span id="cb28-8">      |     ^~~</span></code></pre></div>
</section>
<section id="capturing-a-parameter-pack" class="level3">
<h3 class="anchored" data-anchor-id="capturing-a-parameter-pack">Capturing a parameter pack</h3>
<p>We can also leverage captures with variadic templates. The compiler expands the pack into a list of non-static data members whihc might be handy, if you want to use lambda in templated code.</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb29-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;tuple&gt;</span></span>
<span id="cb29-3"></span>
<span id="cb29-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb29-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> captureTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-7">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> tup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb29-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tuple size: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>tuple_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;::</span>value</span>
<span id="cb29-9">                  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tuple 1st: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>tup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb29-12">    lambda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb29-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb29-14"></span>
<span id="cb29-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-16">    captureTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb29-17">    captureTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello World"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb29-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/eGYEPxo8M">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb30-1">tuple size: 4</span>
<span id="cb30-2">tuple 1st: 1</span>
<span id="cb30-3">tuple size: 2</span>
<span id="cb30-4">tuple 1st: Hello World</span></code></pre></div>
</section>
</section>
<section id="return-type" class="level2">
<h2 class="anchored" data-anchor-id="return-type">Return Type</h2>
<p>In most cases, you can skip the return type of the lambda and the compiler will deduce the typename for you. The compiler is able to deduce the return type as long as all of your return statements are of the same type.</p>
</section>
<section id="iife---immediately-invoked-functional-expression" class="level2">
<h2 class="anchored" data-anchor-id="iife---immediately-invoked-functional-expression">IIFE - Immediately Invoked Functional Expression</h2>
<p>In most of the examples, we’ve seen so far, notice that we defined ht lambda and then immediately called it later. However, you can also invoke a lambda immediately.</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb31-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb31-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}();</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// call</span></span>
<span id="cb31-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
</section>
<section id="lambdas-in-c14" class="level1">
<h1>Lambdas in C++14</h1>
<section id="default-parameters-for-lambda-functions" class="level2">
<h2 class="anchored" data-anchor-id="default-parameters-for-lambda-functions">Default parameters for lambda functions</h2>
<p>Let’s start with smaller updates. In C++14, you can use default parameters in a lambda function definition.</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb32-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb32-2"></span>
<span id="cb32-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb32-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb32-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb32-6">    lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb32-7">    lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb32-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/W7ne1jKh5">Compiler Explorer</a></p>
</section>
<section id="captures-with-an-initialiser" class="level2">
<h2 class="anchored" data-anchor-id="captures-with-an-initialiser">Captures with an initialiser</h2>
<p>We recall that, in a lambda expression, we can capture variables form the outside scope. The compiler expands that capture syntax and creates corresponding non-static data members in the closure type.</p>
<p>In C++14, you can create new data-members and initialize them in the capture clause. Then, you can access those variables inside the lambda. It’s called <em>capture with an initialiser</em> or another name for this feature is <em>generalized lambda capture</em>.</p>
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb33-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb33-2"></span>
<span id="cb33-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb33-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-7">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-8">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-9">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb33-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/9czGEbY4v">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb34-1">42</span></code></pre></div>
<p>Keep in mind, that the new variable is initialized at the place where you define the lambda and not where you invoke it.</p>
<p>Creating variables through an initialiser is also flexible, since you can, for example, create references to variables from outside scope.</p>
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb35-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb35-2"></span>
<span id="cb35-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb35-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb35-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb35-6">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb35-7">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb35-8">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb35-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Output:</p>
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb36-1">30</span>
<span id="cb36-2">0</span></code></pre></div>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations</h3>
<p>Note, that while you can capture by reference with an initialiser, it’s not possible to write <em>rvalue</em> reference <code>&amp;&amp;</code>. So, the below code would be invalid.</p>
<div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb37-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;&amp;</span>z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//invalid syntax!</span></span></code></pre></div>
</section>
<section id="one-gotcha-with-stdfunction" class="level3">
<h3 class="anchored" data-anchor-id="one-gotcha-with-stdfunction">One gotcha with <code>std::function</code></h3>
<p>Having a moveable-only captured variable in a lambda makes the closure object not copyable. This might be an issue if you want to store such a lambda in <code>std::function</code> which accepts only copyable copy objects.</p>
</section>
</section>
<section id="optimisation" class="level2">
<h2 class="anchored" data-anchor-id="optimisation">Optimisation</h2>
<p>Another idea is to use capture initialisers as a potential optimisation technique. Rather than computing some value every time, we invoke a lambda, we can compute it once in. the initialiser:</p>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb38-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb38-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb38-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb38-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb38-5"></span>
<span id="cb38-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb38-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb38-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string_literals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> vs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb38-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"apple"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb38-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foobar"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lemon"</span></span>
<span id="cb38-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb38-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo"</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">s</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-14"></span>
<span id="cb38-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>find_if<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb38-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>prefix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb38-17">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bar"</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">s</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb38-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb38-20"></span>
<span id="cb38-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb38-22">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-something found!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-23"></span>
<span id="cb38-24">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> std<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>find_if<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb38-25">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>savedString <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bar"</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">s</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb38-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> savedString<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb38-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb38-29"></span>
<span id="cb38-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb38-31">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-something found!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-32"></span>
<span id="cb38-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-34"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The code above shows two calls to <code>std::find_if</code>. In the first scernario, we capture <code>prefix</code> and compare the input value against <code>prefix + "bar"s</code>. Everytime the lambda is invokes, a temporary value that stores the sum of those strings has to be created and computed.</p>
<p>The second call to <code>find_if</code> shows an optimisation: we create a captured variable <code>savedString</code> that computes the sum of the strings. then, we can safely refer to it in the lambda body. The sum of the strings will run only once and not with every invocation of the lambda.</p>
</section>
<section id="capturing-a-class-data-member" class="level2">
<h2 class="anchored" data-anchor-id="capturing-a-class-data-member">Capturing a class data member</h2>
<p>An initialiser can also be used to capture data members without worrying about <code>*this</code> pointer. We can capgture a copy of a data member and not bother with dangling references.</p>
<div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb39-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb39-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb39-3"></span>
<span id="cb39-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb39-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb39-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb39-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb39-8"></span>
<span id="cb39-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb39-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb39-11"></span>
<span id="cb39-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb39-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb39-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"abc"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> f2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xyz"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-16">    f1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-17">    f2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/TY98T8nxM">Compiler Explorer</a></p>
</section>
<section id="generic-lambdas" class="level2">
<h2 class="anchored" data-anchor-id="generic-lambdas">Generic Lambdas</h2>
<p>The early specification of lambda expressions allowed us to create anonymous function objects (closure types) and pass them to various generic algorithms from the standard library. However, closures were not generic on their own. For example, you couldn’t specify a template parameter as a lambda parameter.</p>
<p>Fortunately, since C++14, the Standard introduced <em>generic lambdas</em> and now we can write:</p>
<div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb40-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb40-2">foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb40-3">foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.1234</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb40-4">foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello world"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>Please notice <code>auto x</code> as a parameter to the lambda. This is equivalent to using a template declaration in the call operator of the closure type:</p>
<div class="sourceCode" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb41-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb41-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb41-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span>Tx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb41-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb41-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb41-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> someInstance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>If there are more <code>auto</code> arguments, then the code expands to separate template parameters:</p>
<div class="sourceCode" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb42-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> fooDouble <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>expands into:</p>
<div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb43-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb43-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> typenname U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb43-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span>Tx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> U y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb43-4">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb43-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb43-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> someInstance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</section>
<section id="variadic-generic-arguments" class="level2">
<h2 class="anchored" data-anchor-id="variadic-generic-arguments">Variadic Generic Arguments</h2>
<p>If we need more function parameters, then we can also go <em>variadic</em>.</p>
<div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb44-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb44-2"></span>
<span id="cb44-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb44-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb44-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb44-7"></span>
<span id="cb44-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb44-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T1 s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb44-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb44-12"></span>
<span id="cb44-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> sumLambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sum of: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" numbers</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb44-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb44-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb44-18"></span>
<span id="cb44-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> sumLambda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb44-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/z34cTcabh">Compiler Explorer</a></p>
</section>
<section id="perfect-forwarding-with-generic-lambdas" class="level2">
<h2 class="anchored" data-anchor-id="perfect-forwarding-with-generic-lambdas">Perfect forwarding with generic lambdas</h2>
<p>With generic lambdas, we’re not restricted to using <code>auto x</code>, we can add any qualifiers as with other <code>auto</code> variables such as <code>auto&amp;</code>, <code>const auto&amp;</code> or <code>auto&amp;&amp;</code>. One of the handy use cases is that we can specify <code>auto&amp;&amp; x</code> which becomes a forwarding(universal) reference.</p>
<div class="sourceCode" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb45-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb45-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb45-3"></span>
<span id="cb45-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo(const string&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb45-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;)</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo(std::string&amp;&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> </span>
<span id="cb45-6"></span>
<span id="cb45-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb45-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb45-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> callFoo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb45-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Calling foo() on: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb45-11">        foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;(</span>str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb45-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb45-13"></span>
<span id="cb45-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello World"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb45-15">    callFoo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb45-16">    callFoo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Helo World Ref Ref"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb45-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/rdEsPK8va">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb46-1">Calling foo() on: Hello World</span>
<span id="cb46-2">foo(const string&amp;)</span>
<span id="cb46-3">Calling foo() on: Helo World Ref Ref</span>
<span id="cb46-4">foo(std::string&amp;&amp;)</span></code></pre></div>
</section>
</section>
<section id="lambdas-in-c17" class="level1">
<h1>Lambdas in C++17</h1>
<p>C++17 brought one major enhancement to lambdas: they can be declared <code>constexpr</code>:</p>
<div class="sourceCode" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb47-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> square <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb47-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>square<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>How about some more practical examples? It’s fun to write a simple compile-time hash function for strings.</p>
<div class="sourceCode" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb48-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb48-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;numeric&gt;</span></span>
<span id="cb48-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string_view&gt;</span></span>
<span id="cb48-4"></span>
<span id="cb48-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> hornerHash <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string_view<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb48-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> hash_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>accumulate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb48-7">        s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ull</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb48-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>accum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb48-9">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb48-10"></span>
<span id="cb48-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> hash_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb48-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb48-13"></span>
<span id="cb48-14"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb48-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> hashCode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hornerHash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello world"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb48-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb48-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/7hh15dbbo">Compiler Explorer</a></p>
<p>You can also capture <code>constexpr</code> variables in lambdas.</p>
<section id="overloaded-pattern" class="level2">
<h2 class="anchored" data-anchor-id="overloaded-pattern">Overloaded pattern</h2>
<p>It might be surprising to see, but you can derive from a lambda! Since the compiler expands a lambda expression into a function object with <code>operator()</code>, we can inherit from this type.</p>
<div class="sourceCode" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb49-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb49-2"></span>
<span id="cb49-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb49-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> ComplexFn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb49-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> ComplexFn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Callable f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){}</span></span>
<span id="cb49-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb49-7"></span>
<span id="cb49-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb49-9">ComplexFn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> MakeComplexFunctionObject<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb49-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> ComplexFn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb49-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb49-12"></span>
<span id="cb49-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb49-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb49-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MakeComplexFunctionObject<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb49-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]{</span></span>
<span id="cb49-17">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello, complex function object!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb49-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb49-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb49-20">    func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> </span>
<span id="cb49-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In the example, there’s the <code>ComplexFn</code> class which derives from <code>Callable</code> which is a template parameter. If we want to derive from a lambda, we need to do a little trick, as we cannot spell out the exact type of the closure type(unless we wrap it into a <code>std::function</code>). That’s why, we need the <code>MakeComplexFnObject</code> function that can perform template argument deduction and get the type of the lambda closure.</p>
<p>The <code>ComplexFn</code> apart from it’s name is just a simple wrapper without much of a use. Are there any use-cases for such code patterns?</p>
<p>We can extend the code above and inherit from two lambdas and create an overloaded set:</p>
<div class="sourceCode" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb50-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb50-2"></span>
<span id="cb50-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb50-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> SimpleOverloaded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb50-5">   <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb50-6">    SimpleOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>TCall tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb50-7"></span>
<span id="cb50-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb50-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb50-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb50-11"></span>
<span id="cb50-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb50-13">SimpleOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> MakeOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb50-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> SimpleOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb50-15">                                          <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb50-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb50-17"></span>
<span id="cb50-18"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb50-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MakeOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Int!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb50-20">                                     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Float!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb50-21"></span>
<span id="cb50-22">    func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb50-23">    func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb50-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/81hM5cGbr">Compiler Explorer</a></p>
<p>This time we have more code and we derive from two template parameters, but we also need to expose their call operators explicitly. It’s because when looking for the correct function overload, the compiler requires the candidates to be in the same scope.</p>
<p>Now, how about using a variable number of base classes, which means a variable number of lambdas?</p>
</section>
<section id="deriving-from-multiple-lambdas" class="level2">
<h2 class="anchored" data-anchor-id="deriving-from-multiple-lambdas">Deriving from multiple lambdas</h2>
<p>In C++17, we have a handy pattern for this:</p>
<div class="sourceCode" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb51-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb51-2"></span>
<span id="cb51-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb51-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> overloaded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb51-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()...;</span></span>
<span id="cb51-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb51-7"></span>
<span id="cb51-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb51-9">overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;;</span></span>
<span id="cb51-10"></span>
<span id="cb51-11"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb51-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb51-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb51-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb51-15">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb51-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb51-17"></span>
<span id="cb51-18">    test<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10.0f"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb51-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/5sf3We9zY">Compiler Explorer</a></p>
<p>Let’s deep-dive into the basic mechanics of this pattern. It benefits from three features:</p>
<ul>
<li>Pack expansions in <code>using</code> declarations.</li>
<li>Custom template argument deduction rules - that allows converting a list of lambda objects into a list of base classes for the <code>overloaded</code> class. (not needed in C++20!)</li>
<li>Extension to aggregate initialisation - before C++17, you couldn’t aggregate initialise type that derives from other types.</li>
</ul>
<p>The <code>using</code> declaration is important for bringing the function call operator - <code>operator()</code> into the same scope of the <code>overloaded</code> structure. In C++17, we got a syntax that supports variadic templates, which was not possible in the previous revisions of the language.</p>
<p>Let’s try and understand the remaining features:</p>
<section id="custom-template-argument-deduction-rules" class="level3">
<h3 class="anchored" data-anchor-id="custom-template-argument-deduction-rules">Custom Template Argument Deduction Rules</h3>
<p>We derive from lambdas, and then we expose their <code>operator()</code> as we saw in the previous section. But, how can we create objects of this <code>overload</code> type?</p>
<p>As you know, there’s no way to know up-front, the type of the lambda, as compiler has to generate some unique typename for each of them. For example, we cannot just write:</p>
<div class="sourceCode" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb52-1">overload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>LambdaType1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> LambdaType2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> myOverload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{...}</span></span></code></pre></div>
<p>The only way that could work would be some <code>make</code> function (as template argument deduction works for function templates):</p>
<div class="sourceCode" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb53-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb53-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> make_overloader<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;...</span> t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb53-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...};</span></span>
<span id="cb53-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>With the template argument deduction rules that were added in C++17, we can simplify the creation of common template types and the <code>make_overloader</code> function is not needed. For simple types, we can write:</p>
<div class="sourceCode" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb54-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>strDouble<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>There’s also the option to define custom deduction guides. The standard library uses a lot of them, for exmaple, for <code>std::array</code>:</p>
<div class="sourceCode" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb55-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb55-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;;</span></span></code></pre></div>
<p>and the above rules allows us to write:</p>
<div class="sourceCode" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb56-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>test<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>For the <code>overloaded</code> pattern, we can specify a custom deduction guide:</p>
<div class="sourceCode" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb57-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;;</span></span></code></pre></div>
</section>
<section id="extension-to-aggregate-initialisation" class="level3">
<h3 class="anchored" data-anchor-id="extension-to-aggregate-initialisation">Extension to aggregate initialisation</h3>
<p>The functionality is relatively straightforward: we can now aggregate initialise a type that derives from other types. From the specification:</p>
<blockquote class="blockquote">
<p>An aggregate is an array or a class with: - no user-provided, explicit or inherited constructors - no <code>private</code> or <code>protected</code> non-static data members - no <code>virtual</code> functions - no <code>virtual</code>, <code>private</code> or <code>protected</code> base classes.</p>
</blockquote>
<p>For example:</p>
<div class="sourceCode" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb58-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> base1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb58-2"></span>
<span id="cb58-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> base2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb58-4">    base2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb58-5">        b3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb58-7"></span>
<span id="cb58-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb58-10"></span>
<span id="cb58-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> derived <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> base1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> base2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb58-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb58-14"></span>
<span id="cb58-15">derived d1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{},</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb58-16">derived d2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{},</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>


</section>
</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/lambda_functions/index.html</guid>
  <pubDate>Sat, 13 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/lambda_functions/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Floating-point numbers</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/floating_point/index.html</link>
  <description><![CDATA[ 




<section id="floating-point-numbers" class="level1">
<h1>Floating-point numbers</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Computer memory has a finite capacity. Real numbers in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D">, do not, in general, however, have finite uniform representation. For example, consider representing the rational number <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B4%7D%7B3%7D"> as a decimal value: it is <img src="https://latex.codecogs.com/png.latex?(1.333%5Coverline%7B3%7D)_%7B10%7D"> – it is impossible to do so exactly! Since only a finite number of digits can be stored in computer memory, the reals have to be approximated in some fashion (rounded or truncated), when represented on a computer.</p>
<p>In this tutorial, we’ll go over the basic ideas of floating-point representation and learn the limits of floating-point accuracy, when doing practical numerical computing.</p>
</section>
<section id="rounding-and-chopping" class="level2">
<h2 class="anchored" data-anchor-id="rounding-and-chopping">Rounding and Chopping</h2>
<p>There are two distinguishable ways of rounding off a real number <img src="https://latex.codecogs.com/png.latex?x"> to a given number <img src="https://latex.codecogs.com/png.latex?t"> of decimals.</p>
<p>In chopping, we simply leave off all decimals to the right of the <img src="https://latex.codecogs.com/png.latex?t">th digit. For example, 56.555 truncated to <img src="https://latex.codecogs.com/png.latex?t=1"> decimal place yields 56.5.</p>
<p>In rounding to nearest, we choose a number with <img src="https://latex.codecogs.com/png.latex?t"> decimals, which is the closest to <img src="https://latex.codecogs.com/png.latex?x">. For example, consider rounding off 56.555 to <img src="https://latex.codecogs.com/png.latex?t=1"> decimal place. There are two possible candidates: 56.5 and 56.6. On the real number line, 56.5 is at a distance of <img src="https://latex.codecogs.com/png.latex?%7C56.555%20-%2056.5%7C=0.55%20%5Ctimes%2010%5E%7B-1%7D"> from 56.555, whilst 56.6 is at a distance of <img src="https://latex.codecogs.com/png.latex?%7C56.6%20-%2056.555%7C=0.45%20%5Ctimes%2010%5E%7B-1%7D">. So, 56.6 is the nearest and we round to 56.6.</p>
<p>Intuitively, we are comparing the fractional part of the number to the right of the <img src="https://latex.codecogs.com/png.latex?t">th digit, which is <img src="https://latex.codecogs.com/png.latex?0.055%20=%200.55%20%5Ctimes%2010%5E%7B-1%7D"> with <img src="https://latex.codecogs.com/png.latex?0.5%20%5Ctimes%2010%5E%7B-1%7D">. As <img src="https://latex.codecogs.com/png.latex?0.55%20%5Ctimes%2010%5E%7B-1%7D%20%3E%200.5%20%5Ctimes%2010%5E%7B-1%7D">, we incremented the <img src="https://latex.codecogs.com/png.latex?t">th digit, which is 5 by 1.</p>
<p>What if, we wished to round off 56.549 to <img src="https://latex.codecogs.com/png.latex?t=1"> decimal places? Observe that, the fractional part is <img src="https://latex.codecogs.com/png.latex?0.49%20%5Ctimes%2010%5E%7B-1%7D">. As <img src="https://latex.codecogs.com/png.latex?0.49%20%5Ctimes%2010%5E%7B-1%7D%20%3C%200.5%20%5Ctimes%2010%5E%7B-1%7D">, we leave the <img src="https://latex.codecogs.com/png.latex?t">th digit unchanged. So, the result is 56.5, which is indeed nearest to 56.549.</p>
<p>In general, let <img src="https://latex.codecogs.com/png.latex?p"> be the fractional part of the number to the right of <img src="https://latex.codecogs.com/png.latex?t">th digit (after the decimal point). If <img src="https://latex.codecogs.com/png.latex?p%3E0.5%20%5Ctimes%2010%5E%7B-t%7D">, we increment the <img src="https://latex.codecogs.com/png.latex?t">th digit. If <img src="https://latex.codecogs.com/png.latex?p%3C0.5%20%5Ctimes%2010%5E%7B-t%7D">, we leave the <img src="https://latex.codecogs.com/png.latex?t">th digit unchanged.</p>
<p>In the case of a tie, when <img src="https://latex.codecogs.com/png.latex?x"> is equidistant to two decimal <img src="https://latex.codecogs.com/png.latex?t">-digit numbers, we raise the <img src="https://latex.codecogs.com/png.latex?t">th decimal if it is odd or leave it unchanged if it is even. In this way, the error in rounding off a decimal number is positive or negative equally often.</p>
<p>Let’s see some more examples of rounding and chopping, to make sure, this sinks in. Assume that, we are interested in rounding off all quantities to <img src="https://latex.codecogs.com/png.latex?t=3"> decimal places:</p>
<div id="tbl-rounding" class="anchored">
<table class="table">
<caption>Table&nbsp;1: Examples of rounding and chopping to <img src="https://latex.codecogs.com/png.latex?t=3"> decimal places</caption>
<thead>
<tr class="header">
<th><img src="https://latex.codecogs.com/png.latex?x"></th>
<th>Rounding</th>
<th>Chopping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.2397</td>
<td>0.240</td>
<td>0.239</td>
</tr>
<tr class="even">
<td>0.23750</td>
<td>0.238</td>
<td>0.237</td>
</tr>
<tr class="odd">
<td>0.23650</td>
<td>0.236</td>
<td>0.236</td>
</tr>
<tr class="even">
<td>0.23652</td>
<td>0.237</td>
<td>0.236</td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?%5Cpi%20%5Capprox%203.1415926"></td>
<td>3.142</td>
<td>3.141</td>
</tr>
</tbody>
</table>
</div>
<p>The difference between chopping and rounding has real-world implications! The Vancouver stock exchange index began trading in 1982, with a base value of 1000.00. Although the underlying stocks were performing decent, the index began hitting the low 500s at the end of 1983. A computer program re-calculated the value of the index thousands of times each day, and the program used chopping instead of rounding to the nearest. A rounded calculation gave a value of 1082.00.</p>
</section>
<section id="computer-number-systems" class="level2">
<h2 class="anchored" data-anchor-id="computer-number-systems">Computer Number Systems</h2>
<p>In our daily life, we represent numbers using the decimal number system with base 10. In the decimal system, we’re aware, that if a digit <img src="https://latex.codecogs.com/png.latex?d_%7B-k%7D"> stands <img src="https://latex.codecogs.com/png.latex?k"> digits to the right of the decimal point, the value it contributes is <img src="https://latex.codecogs.com/png.latex?d_%7B-k%7D%20%5Ccdot%2010%5E%7B-k%7D">. For example the sequence of digits 4711.303 means:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A4%20%5Ccdot%2010%5E3%20+%207%20%5Ccdot%20%2010%5E2%20+%201%20%5Ccdot%2010%5E1%20+%201%5Ccdot%2010%5E0%20+%203%20%5Ccdot%2010%5E%7B-1%7D%20+%200%20%5Ccdot%2010%5E%7B-2%7D%20+%203%20%5Ccdot%2010%5E%7B-3%7D%20%5Cend%7Balign*%7D"></p>
<p>In fact any integer <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20%5Cgeq%202"> (or <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20%5Cleq%20-2">) can be used as a base. Analogously, every real number <img src="https://latex.codecogs.com/png.latex?x%20%5Cin%20%5Cmathbb%7BR%7D"> has a unique representation of the form:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20x%20=%20d_n%20%5Cbeta%5En%20+%20d_%7Bn-1%7D%5Cbeta%5E%7Bn-1%7D%20+%20%5Cldots%20+%20d_1%20%5Cbeta%5E%7B1%7D%20+%20d_0%20%5Cbeta%5E0%20+%20d_%7B-1%7D%5Cbeta%5E%7B-1%7D%20+%20d_%7B-2%7D%20%5Cbeta%5E%7B-2%7D%20+%20%5Cldots%20%5Cend%7Balign*%7D"></p>
<p>or compactly <img src="https://latex.codecogs.com/png.latex?d_%7Bn%7D%5Cldots%20d_1%20d_0.d_%7B-1%7D%20d_%7B-2%7D%20%5Cldots">, where the coefficients <img src="https://latex.codecogs.com/png.latex?d_i">, the digits in system <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, are positive integers such that <img src="https://latex.codecogs.com/png.latex?0%20%5Cleq%20d_i%20%3C%20%5Cbeta">.</p>
<section id="conversion-algorithm-between-two-number-systems" class="level3">
<h3 class="anchored" data-anchor-id="conversion-algorithm-between-two-number-systems">Conversion Algorithm Between Two Number Systems</h3>
<p>Consider the problem of conversion between two number systems with different bases. For the sake of concreteness, let’s try to convert <img src="https://latex.codecogs.com/png.latex?(250)_%7B10%7D"> to the binary format. We may write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20250%20=%20d_7%20%5Ccdot%202%5E7%20+%20d_6%5Ccdot%202%5E6%20+%20d_5%20%5Ccdot%202%5E5%20+%20d_4%5Ccdot%202%5E4%20+%20d_3%5Ccdot%202%5E3%20+%20d_2%5Ccdot%202%5E2%20+%20d_1%5Ccdot%202%5E1%20+%20d_0%20%5Cend%7Balign*%7D"></p>
<p>We can pull out a factor of 2 from each term, except the last, and equivalently write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20250%20=%202%20%5Ctimes%20(d_7%20%5Ccdot%202%5E6%20+%20d_6%5Ccdot%202%5E5%20+%20d_5%20%5Ccdot%202%5E4%20+%20d_4%5Ccdot%202%5E3%20+%20d_3%5Ccdot%202%5E2%20+%20d_2%5Ccdot%202%5E1%20+%20d_1)%20+%20d_0%20%5Cend%7Balign*%7D"></p>
<p>Intuitively, therefore, if we were to divide <img src="https://latex.codecogs.com/png.latex?q_0=250"> by 2, the expression in brackets, let’s call it <img src="https://latex.codecogs.com/png.latex?q_1">, is the quotient and <img src="https://latex.codecogs.com/png.latex?d_0"> is the remainder of the division. Similarly, since <img src="https://latex.codecogs.com/png.latex?q_1%20=%202%20%5Ctimes%20(d_7%20%5Ccdot%202%5E5%20+%20d_6%5Ccdot%202%5E4%20+%20d_5%20%5Ccdot%202%5E3%20+%20d_4%5Ccdot%202%5E2%20+%20d_3%5Ccdot%202%5E1%20+%20d_2)%20+%20d_1">, division by 2 would return the expression in the brackets as the quotient; call it <img src="https://latex.codecogs.com/png.latex?q_2">, and <img src="https://latex.codecogs.com/png.latex?d_1"> as the remainder.</p>
<p>In general, if <img src="https://latex.codecogs.com/png.latex?a"> is an integer with base <img src="https://latex.codecogs.com/png.latex?%5Calpha"> and we want to determine it’s representation in a number system with base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, we perform successive divisions of <img src="https://latex.codecogs.com/png.latex?a"> with <img src="https://latex.codecogs.com/png.latex?%5Cbeta">: set <img src="https://latex.codecogs.com/png.latex?q_0%20=%20a"> and</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20q_k%20=%20%5Cbeta%20%5Ctimes%20q_%7Bk+1%7D%20+%20d_k,%20%5Cquad%20k%20=%200,1,2,%5Cldots%20%5Cend%7Balign*%7D"></p>
<p><img src="https://latex.codecogs.com/png.latex?q_%7Bk+1%7D"> is the quotient and <img src="https://latex.codecogs.com/png.latex?d_k"> is the remainder in the division.</p>
<p>Let’s look at the result of applying the algorithm to <img src="https://latex.codecogs.com/png.latex?(250)_%7B10%7D">:</p>
<p>k q_k q_k+1 d_k 0 250 250/2 = 125 0 1 125 125/2 = 62 1 2 62 62/2 = 31 0 3 31 31/2 = 15 1 4 15 15/2 = 7 1 5 7 7/2 = 3 1 6 3 3/2 = 1 1 7 1 1/2 = 0 1</p>
<p>Therefore, <img src="https://latex.codecogs.com/png.latex?(250)_%7B10%7D%20=%20(d_7%20d_6%20d_5%20d_4%20d_3%20d_2%20d_1%20d_0)_2%20=%201111%5C,1010">.</p>
</section>
<section id="converting-fractions-to-another-number-system" class="level3">
<h3 class="anchored" data-anchor-id="converting-fractions-to-another-number-system">Converting Fractions to Another Number System</h3>
<p>If the real number <img src="https://latex.codecogs.com/png.latex?a"> is not an integer, we write it as <img src="https://latex.codecogs.com/png.latex?a%20=%20b%20+%20c">, where <img src="https://latex.codecogs.com/png.latex?b"> is the integer part and</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ac%20=%20c_%7B-1%7D%5Cbeta%5E%7B-1%7D%20+%20c_%7B-2%7D%5Cbeta%5E%7B-2%7D%20+%20c_%7B-3%7D%5Cbeta%5E%7B-3%7D%20+%20%5Cldots%0A%5Cend%7Balign*%7D%0A"></p>
<p>is the fractional part, where <img src="https://latex.codecogs.com/png.latex?c_%7B-1%7D,c_%7B-2%7D,c_%7B-3%7D,%5Cldots"> are to be determined.</p>
<p>Observe that, multiplying both sides by the base <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> yields,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20c%20%5Ccdot%20%5Cbeta%20=%20%5Cunderbrace%7Bc_%7B-1%7D%7D_%7B%5Ctext%7BInteger%7D%7D%20+%20%5Cunderbrace%7Bc_%7B-2%7D%5Cbeta%5E%7B-1%7D%20+%20c_%7B-3%7D%5Cbeta%5E%7B-2%7D%20+%20%5Cldots%7D_%7B%5Ctext%7BFractional%20part%7D%7D%20%5Cend%7Balign*%7D"></p>
<p>an integer and a fractional portion. The integer portion is precisely <img src="https://latex.codecogs.com/png.latex?c_%7B-1%7D"> – the first digit of <img src="https://latex.codecogs.com/png.latex?c"> represented in base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">. Consecutive digits are obtained as the integer parts, when successively multiplying <img src="https://latex.codecogs.com/png.latex?c"> by <img src="https://latex.codecogs.com/png.latex?%5Cbeta">.</p>
<p>In general, if a fraction <img src="https://latex.codecogs.com/png.latex?c"> must be converted to another number system with base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, we perform successive multiplications of <img src="https://latex.codecogs.com/png.latex?c"> with <img src="https://latex.codecogs.com/png.latex?%5Cbeta">: set <img src="https://latex.codecogs.com/png.latex?p_0%20=%20c"> and</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20p_%7Bk%7D%20%5Ccdot%20%5Cbeta%20=%20c_%7Bk-1%7D%20+%20p_%7Bk-1%7D,%20%5Cquad%20k%20=%200,-1,-2,%5Cldots%20%5Cend%7Balign*%7D"></p>
<p>Let’s look at an example of converting <img src="https://latex.codecogs.com/png.latex?(0.15625)_%7B10%7D"> to binary number system:</p>
<p>k p_k p_k<img src="https://latex.codecogs.com/png.latex?%5Ccdot%20%5Cbeta"> c_k-1 p_k-1 0 0.15625 <img src="https://latex.codecogs.com/png.latex?0.15625%20%5Ctimes%202%20=0.3125"> 0 0.3125 -1 0.3125 <img src="https://latex.codecogs.com/png.latex?0.3125%20%5Ctimes%202%20=0.625"> 0 0.625 -2 0.625 <img src="https://latex.codecogs.com/png.latex?0.625%20%5Ctimes%202%20=1.25"> 1 0.25 -3 0.25 <img src="https://latex.codecogs.com/png.latex?0.25%20%5Ctimes%202%20=0.50"> 0 0.50 -4 0.50 <img src="https://latex.codecogs.com/png.latex?0.50%20%5Ctimes%202%20=1.00"> 1 0.00</p>
<p>freestar Therefore, <img src="https://latex.codecogs.com/png.latex?(0.15625)_%7B10%7D%20=%200.0010%5C,1000"> in the binary system.</p>
</section>
<section id="fixed-and-floating-point-representation" class="level3">
<h3 class="anchored" data-anchor-id="fixed-and-floating-point-representation">Fixed and Floating-Point Representation</h3>
<p>Computers are equipped to handle pieces of information of a fixed size called a word. Typical word lengths are 32-bits or 64-bits.</p>
<p>Early computers made numerical calculations in a fixed-point number system. That is, real numbers were represented using a fixed number of <img src="https://latex.codecogs.com/png.latex?t"> binary digits in the fractional part. If the word-length of the computer is <img src="https://latex.codecogs.com/png.latex?s+1"> bits, (including the sign bit), then only numbers in the bounded interval <img src="https://latex.codecogs.com/png.latex?I=%5B-2%5E%7Bs-t%7D,2%5E%7Bs-t%7D%5D"> are permitted. This limitation is problematic, since, for example, even when <img src="https://latex.codecogs.com/png.latex?x%20%5Cin%20I"> and <img src="https://latex.codecogs.com/png.latex?y%20%5Cin%20I">, it is possible that <img src="https://latex.codecogs.com/png.latex?x%20-%20y"> is outside the bounds of the interval <img src="https://latex.codecogs.com/png.latex?I">.</p>
<p>In a floating-point number system, a real number <img src="https://latex.codecogs.com/png.latex?a"> is represented as:</p>
<p>freestar <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20a%20=%20%5Cpm%20m%20%5Ccdot%20%5Cbeta%5Ee,%20%5Cquad%20m%20=%20(0.d_1%20d_2%20d_3%20%5Cldots)_%5Cbeta,%20%5Cquad%20e%20%5Ctext%7B%20an%20integer%20%7D%20%5Cend%7Balign*%7D"></p>
<p>The fractional part <img src="https://latex.codecogs.com/png.latex?m"> of the number is called the mantissa or significand. <img src="https://latex.codecogs.com/png.latex?e"> is called the exponent and <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> is the base. It’s clear that <img src="https://latex.codecogs.com/png.latex?d_1%20%5Cneq%200">, because if <img src="https://latex.codecogs.com/png.latex?d_1%20=%200">, then we can always decrease the exponent by 1 and shift the decimal point one place to the right.</p>
<p>The mantissa <img src="https://latex.codecogs.com/png.latex?m"> and the exponent <img src="https://latex.codecogs.com/png.latex?e"> are limited by the fixed word length in computers. <img src="https://latex.codecogs.com/png.latex?m"> is rounded off to a number <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bm%7D"> with <img src="https://latex.codecogs.com/png.latex?t"> digits and the exponent <img src="https://latex.codecogs.com/png.latex?e"> lies in a certain range.</p>
<p>Thus, we can only represent floating-point numbers of the form:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20a%20=%20%5Cpm%20%5Coverline%7Bm%7D%20%5Ccdot%20%5Cbeta%5Ee,%20%5Cquad%20%5Coverline%7Bm%7D%20=%20(0.d_1%20d_2%20d_3%20%5Cldots%20d_t)_%5Cbeta,%20%5Cquad%20e_%7Bmin%7D%20%5Cleq%20e%20%5Cleq%20e_%7Bmax%7D,%20%5Cquad%20e%20%5Cin%20%5Cmathbf%7BZ%7D%20%5Cend%7Balign*%7D"></p>
<p>A floating-point number system <img src="https://latex.codecogs.com/png.latex?F"> is completely characterized by the base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, precision <img src="https://latex.codecogs.com/png.latex?t">, the numbers <img src="https://latex.codecogs.com/png.latex?e_%7Bmin%7D"> and <img src="https://latex.codecogs.com/png.latex?e_%7Bmax%7D">. Since <img src="https://latex.codecogs.com/png.latex?d_1%20%5Cneq%200">, the set <img src="https://latex.codecogs.com/png.latex?F">, contains, including the number 0,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%202%20(%5Cbeta%20-%201)%20%5Cbeta%5E%7Bt-1%7D(e_%7Bmax%7D%20-%20e_%7Bmin%7D%20+%201)%20+%201%20%5Cend%7Balign*%7D"></p>
<p>numbers. Intuitively, there are 2 choices for the sign. The digit <img src="https://latex.codecogs.com/png.latex?d_1"> can be chosen from the set <img src="https://latex.codecogs.com/png.latex?%5C%7B1,2,%5Cldots,%5Cbeta%20-%201%5C%7D">. Each of the successive <img src="https://latex.codecogs.com/png.latex?t-1"> digits can be chosen from <img src="https://latex.codecogs.com/png.latex?%5C%7B0,1,2,%5Cldots,%5Cbeta%20-%201%5C%7D">. The exponent can be chosen from <img src="https://latex.codecogs.com/png.latex?e_%7Bmax%7D%20-%20e_%7Bmin%7D%20+%201"> numbers. By the multiplication rule, there are <img src="https://latex.codecogs.com/png.latex?2%20(%5Cbeta%20-%201)%20%5Cbeta%5E%7Bt-1%7D(e_%7Bmax%7D%20-%20e_%7Bmin%7D%20+%201)"> distinguishable numbers. Including the number 0 gives us the expression above.</p>
</section>
</section>
<section id="why-are-floating-point-numbers-inaccurate" class="level2">
<h2 class="anchored" data-anchor-id="why-are-floating-point-numbers-inaccurate">Why Are Floating-Point Numbers Inaccurate?</h2>
<p>Consider a toy floating-point number system <img src="https://latex.codecogs.com/png.latex?F(%5Cbeta%20=%202,%20t%20=%203,%20e_%7Bmin%7D=-1,%20e_%7Bmax%7D=2)">. The set <img src="https://latex.codecogs.com/png.latex?F"> contains exactly <img src="https://latex.codecogs.com/png.latex?2%20%5Ccdot%2016%20+%201%20=%2033"> numbers. The positive numbers in the set <img src="https://latex.codecogs.com/png.latex?F"> are shown below:</p>
<p><img src="https://latex.codecogs.com/png.latex?(0.d_1%20d_2%20d_3)_2"> <img src="https://latex.codecogs.com/png.latex?2%5Ee"> Decimal representation <img src="https://latex.codecogs.com/png.latex?(0.d_1%20d_2%20d_3)_2"> <img src="https://latex.codecogs.com/png.latex?2%5Ee"> Decimal representation <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.25 <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.00 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.3125 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.25 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.375 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.50 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.4375 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.75 <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.50 <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 2.00 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.625 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 2.50 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.75 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 3.00 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.875 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 3.50 It is apparent that not all real numbers, for instance in, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7B%5B1,2%5D%7D"> are present in <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BF%7D">. Moreover, not all floating-point numbers are equally spaced; the spacing jumps by a factor of <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> at each power of <img src="https://latex.codecogs.com/png.latex?%5Cbeta">.</p>
<p>The spacing of the floating-point numbers is characterized by the machine epsilon <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7B%5Cepsilon_M%7D">, which is the distance from 1.0 to the next largest floating-point number.</p>
<p>If a real number <img src="https://latex.codecogs.com/png.latex?x"> is in the range of the floating-point system, the obvious thing to do is to round off <img src="https://latex.codecogs.com/png.latex?x"> to <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bx%7D">, where <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bx%7D=%5Ctext%7Bfloat%7D(x)"> is the floating-point number in <img src="https://latex.codecogs.com/png.latex?F">, that is closest to <img src="https://latex.codecogs.com/png.latex?x">. It should already be clear that representing <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D"> by <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bfloat(x)%7D"> introduces an error.</p>
<p>One interesting question is, how large is this error? It would be great if we could guarantee, that the round-off error at no point exceeds a certain amount. Everybody loves a guarantee! In other words, we seek an upper bound for the relative error:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%5Cfrac%7B%7Cfl(x)%20-%20x%7C%7D%7B%7Cx%7C%7D%20%5Cend%7Balign*%7D"></p>
<p>Recall, from the earlier discussion, that when rounding <img src="https://latex.codecogs.com/png.latex?m"> to <img src="https://latex.codecogs.com/png.latex?t"> decimals, we leave the <img src="https://latex.codecogs.com/png.latex?t">th decimal unchanged, if the part <img src="https://latex.codecogs.com/png.latex?p">, of the number to right of the <img src="https://latex.codecogs.com/png.latex?t">th decimal, is smaller than <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7D%20%5Ctimes%2010%5E%7B-t%7D">, else raise the <img src="https://latex.codecogs.com/png.latex?t">th decimal by 1. Here, we are working with the generic base <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> instead of the decimal base 10. Consequently, the round-off error in the mantissa is bounded by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%7C%5Coverline%7Bm%7D%20-%20m%7C%20%5Cleq%20%5Cfrac%7B1%7D%7B2%7D%5Ccdot%20%5Cbeta%5E%7B-t%7D%20%5Cend%7Balign*%7D"></p>
<p>The relative round-off error in <img src="https://latex.codecogs.com/png.latex?x"> is thus bounded by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%5Cfrac%7B%7Cfl(x)%20-%20x%7C%7D%7B%7Cx%7C%7D%20&amp;=%20%5Cfrac%7B%7C%5Coverline%7Bm%7D%20-%20m%7C%20%5Ccdot%20%5Cbeta%5Ee%7D%7Bm%20%5Ccdot%20%5Cbeta%5Ee%7D%5C%5C%20&amp;%5Cleq%20%5Cfrac%7B%5Cfrac%7B1%7D%7B2%7D%5Ccdot%20%5Cbeta%5E%7B-t%7D%20%5Ccdot%20%5Cbeta%5Ee%7D%7B(0.1)_%5Cbeta%20%5Cbeta%5Ee%7D%20%5Cquad%20%5Cquad%20%5C%7B%20m%20%5Cgeq%20(0.1)_%5Cbeta%20%5C%7D%20%5C%5C%20&amp;=%20%5Cfrac%7B1%7D%7B2%7D%20%5Ccdot%20%5Cbeta%5E%7B-t%20+%201%7D%20%5Cend%7Balign*%7D"></p>
<p>Modern floating-point standards such as the IEEE guarantee this upper bound. This upper bound is called the rounding unit, denoted by <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bu%7D">.</p>
</section>
<section id="ieee-floating-point-standard-in-a-nutshell" class="level2">
<h2 class="anchored" data-anchor-id="ieee-floating-point-standard-in-a-nutshell">IEEE Floating-point Standard in a Nutshell</h2>
<p>Actual computer hardware implementations of floating-point systems differ from the toy system, we just designed. Most current computers conform to the IEEE 754 standard for binary floating-point arithmetic. There is two main basic formats – single and double precision, requiring 32-bit and 64-bit storage.</p>
<p>In single-precision, a floating-point number <img src="https://latex.codecogs.com/png.latex?a"> is stored as the sign <img src="https://latex.codecogs.com/png.latex?s"> (1 bit), the exponent <img src="https://latex.codecogs.com/png.latex?e"> (8 bits), the mantissa <img src="https://latex.codecogs.com/png.latex?m"> (23 bits).</p>
<p>In double-precision, 11 bits are allocated to the exponent <img src="https://latex.codecogs.com/png.latex?e">, whereas 52 bits are allocated to the mantissa <img src="https://latex.codecogs.com/png.latex?m">. The exponent is stored as <img src="https://latex.codecogs.com/png.latex?b=e+1023">.</p>
<p>Rendered by QuickLaTeX.com</p>
<p>The value <img src="https://latex.codecogs.com/png.latex?v"> of the floating-point number <img src="https://latex.codecogs.com/png.latex?a"> in the normal case is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20v%20=%20(-1)%5Es%20(1.m)_2%20%5Ccdot%202%5Ee,%20%5Cquad%20%5Cquad%20e_%7Bmin%7D%20%5Cleq%20e%20%5Cleq%20e_%7Bmax%7D%20%5Cend%7Balign*%7D"></p>
<p>Note, that the digit before the binary point is always 1, similar to the scientific notation we studied in high school. In that way, 1 bit is gained for the mantissa.</p>
<section id="quirks-in-floating-point-arithmetic" class="level3">
<h3 class="anchored" data-anchor-id="quirks-in-floating-point-arithmetic">Quirks in Floating-Point Arithmetic</h3>
<p>Consider the following comparison:</p>
<p>(0.10 + 0.20) == 0.30 Copy The result of this logical comparison is false. This abrupt behavior is expected because the floating-point system is broken. However, let’s take a deeper look at what’s going on.</p>
<p>Let’s put 0.10 in the double-precision format. Because 0.10 is positive, the sign bit <img src="https://latex.codecogs.com/png.latex?s=0">.</p>
<p>0.10 in base-2 scientific notation can be written as <img src="https://latex.codecogs.com/png.latex?(-1)%5E0%20(1%20+%20m)%202%5E%7Be%7D">. This means we must factor 0.10 into a number <img src="https://latex.codecogs.com/png.latex?(1%20+%20m)"> in the range <img src="https://latex.codecogs.com/png.latex?1%20%5Cleq%20m%20%3C%202"> and a power of 2. If we divide 0.10 by different powers of 2, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%200.10%20/%202%5E%7B-1%7D%20&amp;=%200.20%5C%5C%200.10%20/%202%5E%7B-2%7D%20&amp;=%200.40%5C%5C%200.10%20/%202%5E%7B-3%7D%20&amp;=%200.80%5C%5C%200.10%20/%202%5E%7B-4%7D%20&amp;=%201.60%20%5Cend%7Balign*%7D"></p>
<p>Therefore, <img src="https://latex.codecogs.com/png.latex?0.10%20=%201.60%20%5Ctimes%202%5E%7B-4%7D">. The exponent is stored as <img src="https://latex.codecogs.com/png.latex?e%20+%201023=-4%20+%201023%20=%201019">, so the bit pattern in the exponent part is <img src="https://latex.codecogs.com/png.latex?(011%5C,%201111%5C,%201011)_2">.</p>
<p>The mantissa <img src="https://latex.codecogs.com/png.latex?m"> is the fractional part 0.60 in the binary form. Successive multiplication by 2 quickly yields <img src="https://latex.codecogs.com/png.latex?m%20=%20(0.1001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%20%5Cldots)_2">. However, the double-precision format allocates <img src="https://latex.codecogs.com/png.latex?t=52"> bits to the mantissa, so we must round off <img src="https://latex.codecogs.com/png.latex?m"> to 52 digits. The fractional part <img src="https://latex.codecogs.com/png.latex?p">, after the 52nd digit, <img src="https://latex.codecogs.com/png.latex?(0.1001%20%5Cldots)_2%20%5Ctimes%202%5E%7B-52%7D"> exceeds <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7D%20%5Cbeta%5E%7B-t%7D%20=%20(0.1)_2%20%5Ctimes%202%5E%7B-52%7D">. So, we raise the <img src="https://latex.codecogs.com/png.latex?t">th decimal by 1. Thus, the rounded mantissa is <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bm%7D=%20(0.1001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201010)_2">.</p>
<p>Finally, we put the binary strings in the correct order. So, 0.10 in the IEEE double-precision format is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%5Cunderbrace%7B0%7D_%7Bs%7D%5C,%5Cunderbrace%7B011%5C,%201111%5C,%201011%7D_%7Be+1023%7D%5C,%5Cunderbrace%7B1001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201010%7D_%7B%5Coverline%7Bm%7D%7D%20%5Cend%7Balign*%7D"></p>
<p>This machine number is approximately 0.10000000000000000555 in base 10. In a similar fashion, the closest machine number to 0.2 in the floating-point system is approximately 0.2000000000000000111. Therefore, float(0.1) + float(0.2) &gt; 0.30. On the right hand side, the closest machine number to 0.3 is 0.29999999999999998889. So, float(0.30) &lt; 0.30.</p>
<p>To summarize, algebraically equivalent statements are not necessarily numerically equivalent.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this article, we’ve learned how the rules of chopping and rounding to the nearest work. We developed an algorithm for conversion between number systems. We also learnt that, any floating-point system is characterized by a quadruple <img src="https://latex.codecogs.com/png.latex?F(%5Cbeta,t,e_%7Bmin%7D,e_%7Bmax%7D)">. For example, the IEEE double-precision format is given as <img src="https://latex.codecogs.com/png.latex?F(%5Cbeta=2,t=52,e_%7Bmin%7D=-1022,e_%7Bmax%7D=1023)">. Because computers have finite memory capacity, the set of machine numbers, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BM%7D"> are only a subset of the real numbers <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D">. The spacing between machine numbers in technical speak is called the machine epsilon.</p>
<p>Further, any real number <img src="https://latex.codecogs.com/png.latex?x"> is always rounded off to the nearest machine number on a computer. The IEEE standards guarantee that the relative roundoff error is no more than a certain amount. Moreover, as programmers, we need to take proper care when doing floating-point operations.</p>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/floating_point/index.html</guid>
  <pubDate>Sat, 13 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/floating_point/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Objects, Pointers and References</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/objects-pointers-and-references/index.html</link>
  <description><![CDATA[ 




<section id="objects-pointers-and-references" class="level1">
<h1>Objects, pointers and references</h1>
<p>An object is something that has a lifetime and occupies storage. Even a humble <code>int</code> is an object, but a function is not.</p>
<p>A <em>pointer</em> is a typed address. It associates a type with what is found at some memory location.</p>
<p>Pointers allow us to do arithmetic, but that’s legitimately seen as a dangerous operation, as it can take us to arbitrary locations. Accessing the contents of arbitrary addresses is just asking for trouble.</p>
<p>C++ has special types for pointer manipulation:</p>
<ul>
<li><p><code>void*</code> means <em>address with no specific type</em> semantics. A <code>void*</code> is an address with no associated type. All pointers are implicitly convertible to <code>void*</code> ; an informal way to read this is <em>all pointers regardless of type are addresses</em>. The converse does not hold. For example, it’s not true that all addresses are implicitly convertible to <code>int</code> pointers.</p></li>
<li><p><code>char*</code> means pointer to a byte. Due to the C language roots of C++, a <code>char*</code> can alias any address in memory (the <code>char</code> type regardless of its name, which evocates character, really means <code>byte</code> in C and by extension in C++). There is an ongoing effort in C++ to to give <code>char</code> the meaning of character.</p></li>
<li><p><code>std::byte*</code> is the new <em>pointer to a byte</em>, atleast since C++17. The long term intent of <code>std::byte*</code> is to replace <code>char*</code> in those functions that do byte-per-byte manipulation or addressing, but since there’s so much code that uses <code>char*</code> to that effect, this will take time.</p></li>
</ul>
<section id="string-literals" class="level2">
<h2 class="anchored" data-anchor-id="string-literals">String literals</h2>
<p>A <em>string literal</em> is a character sequence enclosed within double quotes.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"this is a string"</span></span></code></pre></div>
<p>A string literal contains one more character than it appears to have; it is terminated by the <code>\0</code> null termination character (having integer value <code>0</code>). For example,</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bohr"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span></code></pre></div>
<p>The type of a string literal is <em>array of appropriate number of <code>const</code> characters</em>, so <code>"Bohr"</code> is of type <code>const char[5]</code>.</p>
<p>In C and older C++ code, you could assign a string literal to a non-<code>const</code> <code>char*</code>.</p>
<p>Modifying string literals is undefined behavior. In practice, the implementation can for instance store the string literal in read-only memory, such as the&nbsp;<code>.rodata</code>&nbsp;segment on Linux.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb3-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//char* p = "Cauchy";       // error, since C++11</span></span>
<span id="cb3-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cauchy"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb3-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//s[4] = 'e';               // error, assignment to const</span></span>
<span id="cb3-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Having string literals as immutable is not only obvious but also allows implementations to do significant optimizations in the way string literals are stored and accessed.</p>
<p>If we want a string that we are guaranteed to be able to modify, we must place the characters in a non-<code>const</code> array.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Schwarz"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// p is an array of 8 char</span></span>
<span id="cb4-2">p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'s'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span></code></pre></div>
<p>A string literal is statically allocated so it is safe to return one from a function. It is an <em>lvalue</em>.</p>
<p>Whether two identical strings are allocated as one array, or as two is implementation defined. For example:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carl Friedrich Gauss"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carl Friedrich Gauss"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Implementation defined</span></span></code></pre></div>
<p>Note that, <code>==</code> compares addresses (pointer values) when applied to pointers, and not the objects pointed to.</p>
</section>
<section id="challenge-puzzle" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle">Challenge puzzle</h2>
<p>Observe the code snippet below. What is printed?</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb6-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// string literals</span></span>
<span id="cb6-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'h'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'e'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'o'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> s3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"world"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-9"></span>
<span id="cb6-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s1 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s2 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s3 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-13"></span>
<span id="cb6-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C++"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"general"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"purpose"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb6-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"programming"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span></span>
<span id="cb6-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-18"></span>
<span id="cb6-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 0 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 1 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 2 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 3 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                           </span>
<span id="cb6-23"></span>
<span id="cb6-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[0] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[1] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-26">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[2] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-27">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[3] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-28"></span>
<span id="cb6-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> cp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span> cpp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-31">    </span>
<span id="cb6-32"></span>
<span id="cb6-33">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>cpp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-34">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(*(*(</span>cpp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-35">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>cpp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-36">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>cpp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-38"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/vqbb6xYqx">Compiler Explorer</a></p>
</section>
<section id="challenge-puzzle-1" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle-1">Challenge puzzle</h2>
<p>Which of the following can be used to print the address of a <code>char</code> variable?</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> ch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">???;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// print address of ch</span></span></code></pre></div>
<ol type="a">
<li><p><code>&amp;ch[0]</code></p></li>
<li><p><code>(char*)&amp;ch</code></p></li>
<li><p><code>(void*)&amp;ch</code></p></li>
<li><p><code>&amp;ch</code></p></li>
</ol>
<p><code>&amp;ch</code> is of type <code>char*</code>. The <code>&lt;&lt;</code> operator for <code>std::cout</code> has an overload for <code>char*</code> that interprets it as a pointer to a null-terminated C-style string, so it attempts to print characters starting from the address of ch until it encounters a null terminator <code>(\0)</code>.</p>
<p>A pointer has to be able address all memory space. On 64-bit architecture, <code>sizeof(T*)</code> is therefore, <img src="https://latex.codecogs.com/png.latex?8"> bytes = <img src="https://latex.codecogs.com/png.latex?64"> bits.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb8-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok : implicit conversion of `int*` to `void*`</span></span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// *pv;         // error: can't dereference void*</span></span>
<span id="cb8-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>pv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// error: can't increment void*</span></span>
<span id="cb8-6">    </span>
<span id="cb8-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pi2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>pv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// explicit conversion back to `int*`</span></span>
<span id="cb8-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//double* pd1 = pv;                   // error</span></span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//double* pd2 = pi;                   // error</span></span>
<span id="cb8-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pd3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>pv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// unsafe</span></span>
<span id="cb8-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In general, it is not safe to use a pointer that has been converted to a type that differs from the type of the object pointed to.</p>
<p>The primary use for <code>void*</code> is for passing pointers to functions that are not allowed to make assumptions about the type of the object and for returning untyped objects from functions.</p>
</section>
<section id="pointer-declarations" class="level2">
<h2 class="anchored" data-anchor-id="pointer-declarations">Pointer declarations</h2>
<p>Use the spiral rule, when reading pointer declarations. Start at the inner-most level and work your way outwards spiralling in a counter-clockwise direction.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Pointer to array of 5 double(s)</span></span>
<span id="cb9-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ptr is an array of pointers to double of size 5</span></span></code></pre></div>
</section>
<section id="dereferencing-null-pointers" class="level2">
<h2 class="anchored" data-anchor-id="dereferencing-null-pointers">Dereferencing null pointers</h2>
<p>Trying to dereference a null pointer is an error. On most platforms, it generally causes a signal, usually SIGSEGV (see Signals).</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NULL<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-2">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* This causes a signal and terminates.  */</span></span></code></pre></div>
<p>Likewise a pointer that has the wrong alignment for the target data type (on most types of computer), or points to a part of memory that has not been allocated in the process’s address space.</p>
</section>
<section id="pointer-comparisons" class="level2">
<h2 class="anchored" data-anchor-id="pointer-comparisons">Pointer comparisons</h2>
<p>Two pointer values are equal if they point to the same memory address or they are both <code>nullptr</code>. Ordering comparisons such as <code>&gt;</code> and <code>&gt;=</code> operate on pointers by converting them to unsigned integers.</p>
</section>
<section id="pointers-into-arrays" class="level2">
<h2 class="anchored" data-anchor-id="pointers-into-arrays">Pointers into arrays</h2>
<p>In C++, pointers and arrays are closely related. The name of the array holds the starting address of the array can be used as a pointer to the initial element.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pointer to initial element</span></span>
<span id="cb11-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pointer to initial element</span></span>
<span id="cb11-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pointer to one beyond the last element</span></span></code></pre></div>
<p>Taking a pointer to the element one beyond the end of an array is guaranteed to work. This is important for many algorithms. However, since such a pointer does not in fact point to an element of the array, it should not be used for dereferencing, reading or writing values.</p>
<p>The result of taking the address of the element before the initial element or beyond one-past-the-last element is undefined and should be avoided.</p>
<p>For example:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// int* p4 = v - 1;    // before the beginning, undefined</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// int* p5 = v + 7;    // beyond the end, undefined</span></span></code></pre></div>
</section>
<section id="navigating-arrays" class="level2">
<h2 class="anchored" data-anchor-id="navigating-arrays">Navigating arrays</h2>
<p>Efficient and elegant access to arrays and similar data-structures is the key to many algorithms. Access can be achieved either through pointer to an array plus an integer index or through a pointer to an element.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> fi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> </span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> fp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Subscripting a built-in array is defined in terms of pointer operations <code>+</code> and <code>*</code>. For every built-in array <code>a</code> and integer <code>j</code> within the range of <code>a</code>, we have:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1">a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(&amp;</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]+</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>It usually surprises people to find that <code>a[j] == j[a]</code>. For example, <code>3["Texas"] == "Texas"[3] == 'a'</code>. Although such cleverness has no place in production code, from an interview perspective its good to know these low-level equivalences.</p>
<p>The result of applying the arithmetic operators <code>+</code>, <code>-</code>, <code>++</code> or <code>--</code> to pointers depends on the type of the object pointed to. When an arithmetic operator is applied to a pointer <code>p</code> of type <code>T*</code>, <code>p</code> is assumed to point to an element of an array of objects of type <code>T</code>; <code>p+1</code> points to the next element of that array, <code>p-1</code> points to the previous element. This implies that the integer value of <code>p+1</code> will be <code>sizeof(T)</code> larger than the integer value of <code>p</code>.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb15-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb15-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> byte_diff<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">reinterpret_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">reinterpret_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-6"></span>
<span id="cb15-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> vi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb15-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb15-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> byte_diff<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>vi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>vi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" bytes diff"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> byte_diff<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" bytes diff"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/rhqYbzr9f">Compiler Explorer</a></p>
<p>Subtraction of pointers is defined only when both pointers point to elements of the same array. When subtracting a <code>p</code> pointer from another pointer <code>q</code>, <code>q-p</code> is the number of array elements in the sequence <code>[p:q)</code>. One can add an integer to a pointer or subtract an integer from a pointer, in both cases, the result is a pointer value. If that value does not point to an element of the same array as the original array or one beyond, the result of using that value is UB.</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb16-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// i1 = 2</span></span>
<span id="cb16-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//int i2 = &amp;v1[5] - &amp;v2[3];   // UB</span></span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// p1 = &amp;v2[2]</span></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//int* p2 = v2 - 2;   // UB</span></span></code></pre></div>
<p>Complicated pointer arithmetic is usually unnecessary and best avoided. Addition of pointers makes no sense and is not allowed.</p>
<p>Arrays are not self-describing because the number of elements of an array is not guaranteed to be stored with the array. This implies that to traverse an array that does not contain a terminator, the way C-style strings do, we must somehow supply the elements. ## Precedence of operators</p>
<p>The precedence of operators in C++ is:</p>
<table class="table">
<thead>
<tr class="header">
<th>Operators</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>[]</code> <code>()</code> <code>.</code> <code>-&gt;</code></td>
<td>Postfix operators, left-to-right</td>
</tr>
<tr class="even">
<td><code>x++</code> <code>x--</code></td>
<td>Postfix, left-to-right</td>
</tr>
<tr class="odd">
<td><code>++x</code> <code>--x</code> <code>*</code> <code>&amp;</code></td>
<td>Prefix, right-to-left</td>
</tr>
<tr class="even">
<td><code>*</code> <code>/</code> <code>%</code></td>
<td>Multiplicative</td>
</tr>
<tr class="odd">
<td><code>+</code> <code>-</code></td>
<td>Additive</td>
</tr>
</tbody>
</table>
<section id="example-1" class="level3">
<h3 class="anchored" data-anchor-id="example-1">Example 1</h3>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// x = 10, p now points to arr[1]</span></span></code></pre></div>
<p>Consider the expression <code>*ptr++</code> . Post-increment <code>++</code> has a higher precedence than the dereference operator <code>*</code>, so it’s parsed as <code>*(ptr++)</code>. <code>ptr++</code> returns the old value that <code>ptr</code> pointed to, but moves <code>ptr</code> forward at a future time. ### Example 2</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb18-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// p moves to arr[1], then x = 20</span></span></code></pre></div>
<p>Consider the expression <code>*++p</code>. Both the dereference operator <code>*</code> and pre-increment <code>++</code> are prefix operators and have the same precedence. Since, they have right-to-left associativity, we read them right-to-left. <code>*++p</code> is parsed as <code>*(++p)</code>. ### Example 3</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb19-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// arr[0] becomes 11, p unchanged</span></span></code></pre></div>
<p>Consider the expression <code>++*p</code>. Using right-to-left associativity rule, we first dereference and then increment. ## Challenge puzzle</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-4"></span>
<span id="cb20-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// What are the values of:</span></span>
<span id="cb20-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a) p - q</span></span>
<span id="cb20-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// b) q - p</span></span>
<span id="cb20-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// c) *p++</span></span>
<span id="cb20-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// d) *++p (after the previous operation)</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/cGvEnnEd3">Compiler Explorer</a> <code>p - q</code> evaluates to <img src="https://latex.codecogs.com/png.latex?-2">, <code>q - p</code> evaluates to <img src="https://latex.codecogs.com/png.latex?2">.</p>
</section>
</section>
<section id="challenge-puzzle-2" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle-2">Challenge puzzle</h2>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-4"></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// What happens with each line?</span></span>
<span id="cb21-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Can you still access x? What's its value?</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/7n8zbd9c9">Compiler Explorer</a> After the line <code>*pp=20</code>, the variable <code>x</code> has been assigned a new value <code>20</code>. <code>*p = nullptr</code> will reset the value in pointer variable <code>p</code> to a <code>nullptr</code>. We cannot access the contents of the variable <code>x</code> through the pointer variables <code>p</code> and <code>pp</code>.</p>
</section>
<section id="challenge-puzzle-3" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle-3">Challenge Puzzle</h2>
<p>Observe the code snippet below. What is printed?</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Headers</span></span>
<span id="cb22-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb22-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb22-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AAAAA"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BBBBB"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCCCC"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DDDDD"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> </span>
<span id="cb22-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> sptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> </span>
<span id="cb22-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span> pp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-7">    pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>pp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**++</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Initially, <code>pp</code> is incremented to point to the address of <code>sptr[1]</code>.</p>
<p>In the order of precedence, from high to low, we have:</p>
<ol type="1">
<li><code>*</code> dereference and <code>++</code> pre-increment operator (Right-to-left)</li>
<li><code>+</code> - Addition binary operator (Left-to-right)</li>
</ol>
<p>So, <code>**++pp + 2</code> would be parsed as <code>*(*(+pp)) + 2</code>. Thus, <code>pp</code> is now incremented to point to the address of <code>str+1</code>. Then, it is dereferenced twice to yield the string literal <code>BBBBB</code> which is a <code>char*</code>. Finally, an offset of <code>2</code>, will print the text <code>BBB</code>. ## Passing C-style arrays</p>
<p>Arrays cannot be directly passed by value. Instead, an array is as a pointer to its first element.</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> vec_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb23-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>  </span>
<span id="cb23-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb23-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-6">        sum_of_squares <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb23-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-8">    </span>
<span id="cb23-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Multi-dimensional arrays can be passed in a similar fashion.</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> frobenius_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>num_rows<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>num_cols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>  </span>
<span id="cb24-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-7">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-8">            sum_of_squares <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> mat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb24-9">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-11">    </span>
<span id="cb24-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>The C++ language supports two families of indirections: pointers and references. A reference can be seen as an alias for an existing entity. We deliberately did not use the word object, since one could refer to a function and we already know that a function is not an object.</p>
<p>Pointers are objects. As such they occupy storage. References, on the other hand, are not objects, they do not use any storage of their own.</p>
<p>The <code>sizeof</code> operator applied to a reference, will yield the size of whatever it refers to. In C++, a reference is always bound to an object and remains bound to that object until the end of the reference’s lifetime. A pointer, on the other hand, can point to numerous distinct objects during its lifetime.</p>
<p>Another difference between pointers and references is that, contrary to the situation, there is no such thing as reference arithmetic. This makes references safer than pointers.</p>
</section>
<section id="understanding-the-fundamental-properties-of-objects" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-fundamental-properties-of-objects">Understanding the fundamental properties of objects</h2>
<p>We saw earlier that in C++, an object has a type and an address. It occupies a region of storage from the beginning of it’s construction to the end of it’s destruction.</p>
<section id="object-lifetime" class="level3">
<h3 class="anchored" data-anchor-id="object-lifetime">Object lifetime</h3>
<p>In C++, generally speaking, automatic objects are destructed at the end of their scope in a well-defined order. Static(global) objects are destructed on program termination in a somewhat well-defined order. Dynamically allocated objects are destroyed when your program says so.</p>
<p>Let’s examine some aspects of object lifetime with the following very simple program:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb25-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb25-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;format&gt;</span></span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-7">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string_view<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X::X(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-11"></span>
<span id="cb25-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb25-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~X::X() for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-16"></span>
<span id="cb25-17">X glob<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"glob"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-18"></span>
<span id="cb25-19"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb25-20">    X xg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"g()"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-22"></span>
<span id="cb25-23"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb25-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-25">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p0"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maybe_unused</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// will leak</span></span>
<span id="cb25-27">    X xmain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main()"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-28">    g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb25-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> p0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// oops, forgot to delete p1</span></span>
<span id="cb25-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-32"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/jEo3anfso">Compiler Explorer</a></p>
<p>When executed, the program will print the following:</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb26-1">X::X(glob)</span>
<span id="cb26-2">X::X(p0)</span>
<span id="cb26-3">X::X(p1)</span>
<span id="cb26-4">X::X(main())</span>
<span id="cb26-5">X::X(g())</span>
<span id="cb26-6">~X::X() for g()</span>
<span id="cb26-7">~X::X() for p0</span>
<span id="cb26-8">~X::X() for main()</span>
<span id="cb26-9">~X::X() for glob</span></code></pre></div>
<p>The fact that the number of constructors and destructors do not match is a sign that we did something wrong. More specifically, in this example, we manually created an object (pointed to by <code>p1</code>) with the operator <code>new</code> but never manually destructed that object afterward. This is a <em>memory leak</em>.</p>
</section>
</section>
<section id="object-size-alignment-and-padding" class="level2">
<h2 class="anchored" data-anchor-id="object-size-alignment-and-padding">Object size, alignment and padding</h2>
<p>Since each object occupies storage, the space associated with an object is an important(if low-level) property of C++ types. For example, look at the following code:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// fporward declaraion: there will be a class B</span></span>
<span id="cb27-2">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// at some point in the future</span></span>
<span id="cb27-3">            </span>
<span id="cb27-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// fine, we know what NB is, even if don't know the details yet,</span></span>
<span id="cb27-5">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// and all object addresses are of the same size</span></span>
<span id="cb27-6"></span>
<span id="cb27-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// oops! This is the definition of class D. To determine</span></span>
<span id="cb27-8">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// sizeof(D), we have to know how big sizeof(B) is and what</span></span>
<span id="cb27-9">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a B object contains since a D is a B</span></span></code></pre></div>
<p>In the above example, trying to define the <code>D</code> class would not compile. This is because in order to create a<code>D</code> object, the compiler needs to reserve enough space for a <code>D</code> object, but a <code>D</code> object is also a <code>B</code> object and as such we cannot kn ow the size of a <code>D</code> object without knowing the size of <code>B</code> object.</p>
<p>The size of an object or equivalently of a type can be obtained through the <code>sizeof</code> operator. This operator yields a compile-time, non-zero unsigned integral value corresponding to the number of bytes required to store an object.</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb28-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb28-2"></span>
<span id="cb28-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb28-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb28-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a  char precisely occupies one byte of storage, per</span></span>
<span id="cb28-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standard wording</span></span>
<span id="cb28-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb28-8"></span>
<span id="cb28-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Tiny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb28-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// all C++ types occupy non-zero bytes of storage by </span></span>
<span id="cb28-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// definition, even if they are empty like type Tiny</span></span>
<span id="cb28-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Tiny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb28-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In the preceding example, the <code>Tiny</code> class is empty because it has no data-member. A class could have member functions and still be empty.</p>
<p>A C++ object always occupies atleast one byte of storage, even in the case of empty classes such as <code>Tiny</code>. That’s because if the object’s size was zero, that object could be at the same memory location as its immediate neighbor, which would be somewhat hard to reason about.</p>
<p>C++ differs from many other languages in that it does not standardize the size of all fundamental types. For example, <code>sizeof(int)</code> can yield different values depending on the compiler and the platform. Still there are rules concerning the size of objects:</p>
<ul>
<li>The size reported by operator <code>sizeof</code> for objects of type <code>signed char</code>, <code>unsigned char</code> and <code>char</code> is <img src="https://latex.codecogs.com/png.latex?1">, and the same goes for <code>sizeof(std::byte)</code> as each of these types can be used to represent a single byte.</li>
<li>The standard specifies a minimum width for the fundamental types:
<ul>
<li>Signed Integer Types : Signed integers are represented in two’s complement form. The rules of binary arithmetic are the same for two’s complement as the standard base-2 representation. Hence, the same binary adder hardware circuits can be used for signed integer addition.</li>
</ul></li>
</ul>
<table class="table">
<thead>
<tr class="header">
<th>Type</th>
<th>Minimum width <img src="https://latex.codecogs.com/png.latex?N"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>signed char</code></td>
<td><img src="https://latex.codecogs.com/png.latex?1"> byte</td>
</tr>
<tr class="even">
<td><code>short</code></td>
<td><img src="https://latex.codecogs.com/png.latex?2"> bytes</td>
</tr>
<tr class="odd">
<td><code>int</code></td>
<td><img src="https://latex.codecogs.com/png.latex?2"> bytes</td>
</tr>
<tr class="even">
<td><code>long</code></td>
<td><img src="https://latex.codecogs.com/png.latex?4"> bytes</td>
</tr>
<tr class="odd">
<td><code>long long</code></td>
<td><img src="https://latex.codecogs.com/png.latex?8"> bytes</td>
</tr>
</tbody>
</table>
<ul>
<li>For each of the signed integer types, there exists the corresponding, but different, <em>standard unsigned integer</em> types. An unsigned integer type has the same width <img src="https://latex.codecogs.com/png.latex?N"> as the corresponding unsigned integer type. The range of representable values for an unsigned type is <img src="https://latex.codecogs.com/png.latex?0"> to <img src="https://latex.codecogs.com/png.latex?2%5EN%20-%201">. Arithmetic for the unsigned type is performed modulo <img src="https://latex.codecogs.com/png.latex?2%5EN">. Unsigned arithmetic does not overflow. Each value <img src="https://latex.codecogs.com/png.latex?x"> of an unsigned integer type with <img src="https://latex.codecogs.com/png.latex?N"> has a unique representation <img src="https://latex.codecogs.com/png.latex?x%20=%20x_0%202%5E0%20+%20x_1%202%5E1%20+%20%5Cldots%20+%20x_%7BN-1%7D2%5E%7BN-1%7D">, where each coefficient <img src="https://latex.codecogs.com/png.latex?x_i"> is either <img src="https://latex.codecogs.com/png.latex?0"> or <img src="https://latex.codecogs.com/png.latex?1">: this is called the base-2 representation of <img src="https://latex.codecogs.com/png.latex?x">.</li>
<li>The size occupied by an object of any <code>struct</code> or <code>class</code> cannot be less than the sum of the size of its data-members.</li>
</ul>
<section id="empty-base-class-optimization-ebco" class="level3">
<h3 class="anchored" data-anchor-id="empty-base-class-optimization-ebco">Empty base class optimization (EBCO)</h3>
<p>Consider the following code snippet:</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb29-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// private inheritance</span></span>
<span id="cb29-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb29-5"></span>
<span id="cb29-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb29-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-8">    Y y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb29-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/desWebdYE">Compiler Explorer</a> Since the base class is empty, and objects of the derived class <code>Y</code> occupy atleast one byte of storage, the base class can be flattened, when creating objects of the derived class <code>Y</code>. Note that, since the presence of <code>X</code> in <code>Y</code> is an implementation detail, not something that participates in the interface of <code>class Y</code>, I used private inheritance.</p>
</section>
</section>
<section id="alignment" class="level2">
<h2 class="anchored" data-anchor-id="alignment">Alignment</h2>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb30-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 1 byte</span></span>
<span id="cb30-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 2 bytes</span></span>
<span id="cb30-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 2 bytes</span></span>
<span id="cb30-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> ll<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 8 bytes</span></span>
<span id="cb30-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb30-7"></span>
<span id="cb30-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb30-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb30-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>We know that <code>sizeof(X)</code> will be atleast <img src="https://latex.codecogs.com/png.latex?13"> bytes. In practice however, <code>sizeof(X)</code> is likely to be equal to <img src="https://latex.codecogs.com/png.latex?32"> bytes. This might seem surprising at first, but it’s a logical consequence of something called <strong>alignment</strong>.</p>
<p>The alignment of an object tells us where that object can be placed in memory. The <code>char</code> type has an alignment of <img src="https://latex.codecogs.com/png.latex?1">, and as such one can place a <code>char</code> object literally anywhere (as long as one can access that memory). <code>short</code> has an alignment of <code>2</code>. If a type has an alignment <img src="https://latex.codecogs.com/png.latex?n">, then objects of that type must be placed at an address that is a multiple of <img src="https://latex.codecogs.com/png.latex?n">.</p>
<p>The alignment has to be a strictly positive power of <img src="https://latex.codecogs.com/png.latex?2">.</p>
<p>The C++ language offers two operators related to alignment: - The <code>alignof</code> operator, which yields the natural alignment of a type <code>T</code> or of an object of that type. - The <code>alignas</code> operator, which lets the programmers impose the alignment of an object. this is often useful, when playing tricks with memory(as we will), or when interfacing wit with exotic hardware. Of course, <code>alignas</code> can only reasonably increase the natural alignment of a type <code>T</code>, not reduce it.</p>
<p>For some fundamental type <code>T</code>, we can expect the assertion <code>sizeof(T)</code> is equal to <code>alignof(T)</code> to hold, but that assertion does not generalize to composite types. For example, consider again the <code>struct X</code>:</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(c) == 1</span></span>
<span id="cb31-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(s) == 2</span></span>
<span id="cb31-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(i) == 4 (most probable)</span></span>
<span id="cb31-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> ll<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(ll) == 8 (most probable)</span></span>
<span id="cb31-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Generally, speaking for a composite type, the alignment will correspond to the worst alignment of the data members. Here, worst means biggest. For <code>struct X</code>, the worst-aligned data member is type <code>long long</code>, and as such <code>X</code> objects will be aligned on <img src="https://latex.codecogs.com/png.latex?8">-byte boundaries, so it can be placed at an address <img src="https://latex.codecogs.com/png.latex?8">, <img src="https://latex.codecogs.com/png.latex?16">, <img src="https://latex.codecogs.com/png.latex?24"> and so forth. It is highly probable <code>sizeof(X) == 16</code> bytes.</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb32-1">Offset  Content</span>
<span id="cb32-2">------  -------</span>
<span id="cb32-3">  0     | c  |  (char, 1 byte)</span>
<span id="cb32-4">        +----+</span>
<span id="cb32-5">  1     |pad |  (padding, 1 byte)</span>
<span id="cb32-6">        +----+</span>
<span id="cb32-7">  2     | s  |  (short, 2 bytes)</span>
<span id="cb32-8">  3     |    |</span>
<span id="cb32-9">        +----+</span>
<span id="cb32-10">  4     | i  |  (int, 4 bytes)</span>
<span id="cb32-11">  5     |    |</span>
<span id="cb32-12">  6     |    |</span>
<span id="cb32-13">  7     |    |</span>
<span id="cb32-14">        +----+</span>
<span id="cb32-15">  8     | ll |  (long long, 8 bytes)</span>
<span id="cb32-16">  9     |    |</span>
<span id="cb32-17"> 10     |    |</span>
<span id="cb32-18"> 11     |    |</span>
<span id="cb32-19"> 12     |    |</span>
<span id="cb32-20"> 13     |    |</span>
<span id="cb32-21"> 14     |    |</span>
<span id="cb32-22"> 15     |    |</span>
<span id="cb32-23">        +----+</span></code></pre></div>
<p>Now, that we know about alignment, just changing the order of the elements in a <code>struct</code> can affect memory consumption. We should always code <code>struct</code>s in the order of largest to smallest data-members.</p>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/objects-pointers-and-references/index.html</guid>
  <pubDate>Fri, 12 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/objects-pointers-and-references/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>The C++ casts</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/the_cpp_casts/index.html</link>
  <description><![CDATA[ 




<section id="the-c-casts" class="level1">
<h1>The C++ casts</h1>
<p>Traditionally, C++ has supported four ways to perform those explicit type conversions we call casts - <code>static_cast</code>, <code>dynamic_cast</code>, <code>const_cast</code> and <code>reinterprete_cast</code>. C++11 added a fifth one <code>duration_cast</code>. Finally, C++20 introduced a sixth case <code>bit_cast</code>.</p>
<section id="your-best-friend-most-of-the-time---static_cast" class="level2">
<h2 class="anchored" data-anchor-id="your-best-friend-most-of-the-time---static_cast">Your best friend (most of the time) - <code>static_cast</code></h2>
<p>The best, most efficient tool in our type-casting toolset is <code>static_cast</code>. <code>static_cast</code> performs compile-time conversion between related types. It is mostly safe, costs essentially nothing in most cases, and can be used in a <code>constexpr</code> context.</p>
<p>You can also use <code>static_cast</code> in situations involving potential risks, such as converting an <code>int</code> to a <code>float</code> or vice versa. In the latter case, it explicitly acknowledges the loss of the decimal part.</p>
<p>You can can use <code>static_cast</code> to cast a pointer or a reference from a derived class to one of its direct or indirect base classes (as long as there is no ambiguity), which is totally safe.</p>
<p>Casting from a base class to a derived class is extremely risky if the cast is incorrect, as it does not perform runtime checks.</p>
<p>Here are some examples:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb1-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">default</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb1-12">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){}</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*){}</span></span>
<span id="cb1-16"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*){}</span></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb1-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.14159</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok, no warning</span></span>
<span id="cb1-22"></span>
<span id="cb1-23">    X x0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-24"></span>
<span id="cb1-25">    X x1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compiles, </span></span>
<span id="cb1-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// probably warns (narrowing conversion)</span></span>
<span id="cb1-27"></span>
<span id="cb1-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//X x2{3.5, 0}; // does not compile</span></span>
<span id="cb1-29">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// narrowing is not allowed within braces</span></span>
<span id="cb1-30"></span>
<span id="cb1-31">    X x3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-32"></span>
<span id="cb1-33">    D0 d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// illegal, no base-derived relatonship between D0 and D1</span></span>
<span id="cb1-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//D1* d1 = static_cast&lt;D1*&gt;(&amp;d0);</span></span>
<span id="cb1-36"></span>
<span id="cb1-37">    B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(&amp;</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// f(*b)                         // illegal</span></span>
<span id="cb1-39">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span>         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-40">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span>         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compiles, but very dangerous</span></span>
<span id="cb1-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-42"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Y7684n73e">Compiler Explorer</a> Pay special attention to the last use of <code>static_cast</code> of the preceding example - converting from a base class to one of its derived classes is appropriately done with <code>static_cast</code>. However, you must ensure that the conversion leads to an object of the chosen type, as there is no run-time verification made of the validity of that conversion. Only compile-time checks are done.</p>
</section>
<section id="a-sign-somethings-wrong---dynamic_cast" class="level2">
<h2 class="anchored" data-anchor-id="a-sign-somethings-wrong---dynamic_cast">A sign something’s wrong - <code>dynamic_cast</code></h2>
<p>There will be cases where you have a pointer or a reference to an object of some class type and that happens to be different (but related to) the type needed. This often happens - for example, in game engines where most classes derive from some <code>Component</code> base and functions tend to take <code>Component*</code> arguments but need to access members from an object of the derived class they expect.</p>
<p>The main problem here is, typically that the function’s interface is wrong - it accepts arguments of types that are insufficiently precise. Still, we all have software to deliver, and sometimes we need to make things work even though we made some choices along the way, that we will revisit later on.</p>
<p>The safe way to do such casts is <code>dynamic_cast</code>. This cast lets you convert a pointer or reference from one type to another, related type in a way that lets you test whether the conversion worked or not; with pointers, an incorrect conversion yields <code>nullptr</code>, whereas with references, an incorrect conversion throws <code>std::bad_cast</code>. The relatedness of types with <code>dynamic_cast</code> is not limited to base-derived relationships and includes casting from one base to another base in a multiple inheritance design. However, note that in most cases, <code>dynamic_cast</code> requires that the expression that is cast to another type is of the polymorphic type, in the sense that it must have atleast one <code>virtual</code> member function.</p>
<p>Here are some examples:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">default</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>B1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">default</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-15">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">override</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-19"></span>
<span id="cb2-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> B1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-22">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">override</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-25"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// g has the wrong interfacce: it accepts a D0&amp; but </span></span>
<span id="cb2-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// tries to use it as a D1&amp;, which makes sense if the </span></span>
<span id="cb2-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// referred object is publiclly D0 and D1 (for example)</span></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// class D</span></span>
<span id="cb2-37"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-38">    D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> d1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">dynamic_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&gt;(</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//throws if wrong</span></span>
<span id="cb2-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-40"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-41"></span>
<span id="cb2-42"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb2-43"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-44">    D d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-45">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb2-46">    g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok, D is a D0</span></span>
<span id="cb2-47">    D0 d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// calls f(nullptr) as &amp;d0 does not point to a D</span></span>
<span id="cb2-49">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">dynamic_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(&amp;</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-50"></span>
<span id="cb2-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-52">        g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compile, but will throw std::bad_cast</span></span>
<span id="cb2-53">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>bad_cast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-54">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cerr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nice try!"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-55">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-57"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/fdq4qYaKE">Compiler Explorer</a></p>
<p>Note that, even though this example displays a message when <code>std::bad_cast</code> ism thrown, this is in no way what we could call exception handling; we did not solve the problem, and code execution continues in a potentially corrupt state, which could make things worse in more serious code. In a toy example such as this, just letting the code fail and stop executing would also have been a more reasonable choice.</p>
<p>Note that, the use of <code>dynamic_cast</code> requires binaries to be compiled with <strong>runtime type information(RTTI)</strong> included, leading to larger binaries. Unsurprisingly; due to these costs, some application domains will tend to avoid this cost.</p>
</section>
<section id="playing-tricks-with-safety---const_cast" class="level2">
<h2 class="anchored" data-anchor-id="playing-tricks-with-safety---const_cast">Playing tricks with safety - <code>const_cast</code></h2>
<p>Neither <code>static_cast</code> nor <code>dynamic_cast</code>, can change <em>cv</em>-qualifiers of an expression. To do this, you need <code>const_cast</code>. With <code>const_cast</code>, you can add or remove the <code>const</code> or <code>volatile</code> qualifiers from an expression. As you might guess, this only makes sense on a pointer or a reference.</p>
</section>
<section id="believe-me-compiler---reinterprete_cast" class="level2">
<h2 class="anchored" data-anchor-id="believe-me-compiler---reinterprete_cast"><em>Believe me compiler</em> - <code>reinterprete_cast</code></h2>
<p>Sometimes, you just have to make the compiler believe you. For example, knowing <code>sizeof(int) == 4</code> on your platform, you might want to treat <code>int</code> as <code>char[4]</code> to interoperate with an existing API that expects that type. Note that, you should ensure that this property holds (maybe through <code>static_assert</code>), rather than relying on the belief that the property holds on all platforms (it does not).</p>
<p>That’s what <code>reinterpret_cast</code> gives you - the ability to cast a pointer of some type to a pointer of an unrelated type. This can be used in situations where you seek to benefit from pointer-interconvertibility, just as this this can be used to lie to the type system in several rather dangerous and non-portable ways.</p>
<p>Also note that, <code>reinterpret_cast</code> only changes the type associated with an expression - for example, it does not perform the slight address adjustments, that <code>static_cast</code> would make when converting from a derived class to a base class in multiple inheritance situations.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span></code></pre></div>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://amzn.eu/d/7bRAPXQ">C++ Memory Management</a> by <em>Patrice Roy</em>, Packt Publishers</li>
</ul>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/the_cpp_casts/index.html</guid>
  <pubDate>Fri, 12 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/the_cpp_casts/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Lock-free SPSC Queue</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/spsc_lockfree_queue/index.html</link>
  <description><![CDATA[ 




<section id="designing-the-spsc_queue-data-structure" class="level1">
<h1>Designing the <code>spsc_queue</code> data-structure</h1>
<p>I would like to present my implementation for an SPSC lock-free queue in this blog-post.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext itikz</span></code></pre></div>
</div>
<section id="what-makes-an-operation-atomic" class="level2">
<h2 class="anchored" data-anchor-id="what-makes-an-operation-atomic">What makes an operation atomic?</h2>
<p>When a programmer says that an operation is atomic, there are atleast two properties to which they might be referring:</p>
<ul>
<li><em>Non-preemptible</em> - The operation can’t be pre-empted in the middle (e.g.&nbsp;by another thread).</li>
<li><em>Synchronizable</em> - The results of the operation can be made visible to other threads of execution in a controllable fashion.</li>
</ul>
</section>
<section id="setup---how-the-queue-works" class="level2">
<h2 class="anchored" data-anchor-id="setup---how-the-queue-works">Setup - How the queue works</h2>
<ul>
<li>Bounded size. The elements are stored in a fixed-length buffer.</li>
<li>Single-producer, Single-consumer applications.</li>
<li>Circular buffer. The <code>head</code> and <code>tail</code> cursors after reaching the maximum index of the buffer wrap around to the start of the buffer.</li>
</ul>
<p>The <code>spsc_queue</code> type contains a fixed-length array - a buffer to store the elements of the queue and it also contains two indices into the array:</p>
<ul>
<li><code>m_head</code> - The index of the <code>front</code> element, if any.</li>
<li><code>m_tail</code> - The index where a new element would be inserted at the back of the queue.</li>
</ul>
<p>In an initially empty container, both the <code>m_head</code> and <code>m_tail</code> start at zero:</p>
<div class="{text-center}">
<div class="cell" data-execution_count="2">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb2-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb2-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb2-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (Empty)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6">    </span>
<span id="cb2-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb2-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-9">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb2-10">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11">    }</span>
<span id="cb2-12">    </span>
<span id="cb2-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb2-14">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-15">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb2-16">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-17">    }</span>
<span id="cb2-18">    </span>
<span id="cb2-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Pointers</span>
<span id="cb2-20">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-21">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-22">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.6</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-23">    </span>
<span id="cb2-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb2-25">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>) {Status: Empty (m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> m\_tail)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-26">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-3-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Then I have a <code>spsc_queue::push_back()</code> function that is used to append a new element to the queue. If the queue is not full, this operation should succeed, and it will go ahead and write a new element to the tail location and move the <code>m_tail</code> index forward.</p>
<p>For example, if do <code>push_back(1)</code> the queue looks something like this.</p>
<div class="{text-center}">
<div class="cell" data-execution_count="3">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb3-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb3-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb3-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> element)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-6">    </span>
<span id="cb3-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb3-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-10">    </span>
<span id="cb3-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb3-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb3-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-15">    }</span>
<span id="cb3-16">    </span>
<span id="cb3-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb3-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb3-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-21">    }</span>
<span id="cb3-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill first cell</span>
<span id="cb3-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-24">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-25">    </span>
<span id="cb3-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb3-27">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-28">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-29">    </span>
<span id="cb3-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb3-31">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.8</span>) {Status: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> element (m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> m\_head)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-32">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-4-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Here’s the queue with a few more elements added:</p>
<div class="{text-center}">
<div class="cell" data-execution_count="4">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb4-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb4-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb4-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> elements)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-6">    </span>
<span id="cb4-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb4-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-10">    </span>
<span id="cb4-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb4-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb4-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-15">    }</span>
<span id="cb4-16">    </span>
<span id="cb4-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb4-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb4-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-21">    }</span>
<span id="cb4-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill cells <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb4-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-24">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-25">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-26">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-27">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-28">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-29">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-30">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-31">    </span>
<span id="cb4-32">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb4-33">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-34">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-35">    </span>
<span id="cb4-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb4-37">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.8</span>) {Status: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> elements (m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> m\_head)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-38">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-5-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Once I have got some elements into the queue, I can go ahead and call the <code>pop()</code> function, which is going to try to read and remove the first element from the front of the queue.</p>
<p>If the queue isn’t empty, it :</p>
<ul>
<li>Advances <code>m_head</code> thereby implicitly discard the element at the front of the queue</li>
</ul>
<div class="{text-center}">
<div class="cell" data-execution_count="5">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb5-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb5-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb5-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> elements)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-6">    </span>
<span id="cb5-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb5-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-10">    </span>
<span id="cb5-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb5-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb5-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-15">    }</span>
<span id="cb5-16">    </span>
<span id="cb5-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb5-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb5-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-21">    }</span>
<span id="cb5-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill cells <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb5-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-24">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-25">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-26">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-27">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-28">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-29">    </span>
<span id="cb5-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb5-31">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-32">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-33">    </span>
<span id="cb5-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb5-35">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.8</span>) {Status: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> elements (m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> m\_head)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-36">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>) {Note: Index <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> now <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stale"</span> (logically removed)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-37">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-6-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Most of the time, when we advance an index like this, it is a simple increment. But, as I stated earlier, the buffer slots are used in a a circular fashion. If that increment would place that <code>index</code> out of bounds, it wraps around to the zeroeth slot (that’s what makes it a ring) of the queue buffer.</p>
<div class="{text-center}">
<div class="cell" data-execution_count="6">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb6-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb6-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb6-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span> elements)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-6">    </span>
<span id="cb6-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb6-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-10">    </span>
<span id="cb6-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb6-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb6-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-15">    }</span>
<span id="cb6-16">    </span>
<span id="cb6-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb6-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb6-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-21">    }</span>
<span id="cb6-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill cells <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span></span>
<span id="cb6-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-24">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-25">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-26">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-27">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-28">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-29">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-30">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-31">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-32">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-33">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-34">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-35">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-36">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-37">    </span>
<span id="cb6-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb6-39">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-40">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-41">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-7-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>As we’ll see, it turns out that the indices <code>m_head</code> and <code>m_tail</code> will need to be <code>atomic</code> objects. We’ll understand why this is the case.</p>
<p>The storage for a ring buffer consists of a fixed-capacity array of elements and the indices for <code>head</code> and <code>tail</code>. We shall write <code>spsc_queue</code> as a templated class having the capacity as a template parameter.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The capacity must be a power of two.</span></span>
<span id="cb7-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb7-6">    T <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb7-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb7-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>We would like to enforce the capacity to be a power of <img src="https://latex.codecogs.com/png.latex?2"> for efficiency reasons. Remember, that with this design, there’s always atleast one unused element in the array, because <code>m_head == m_tail + 1</code> is the queue full condition. So, the effective capacity equals <code>capacity - 1</code>.</p>
</section>
<section id="the-class-interface" class="level2">
<h2 class="anchored" data-anchor-id="the-class-interface">The <code>class</code> interface</h2>
<p>Here is the class interface:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The capacity must be a power of two.</span></span>
<span id="cb8-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb8-6">    T <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb8-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-10">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-11">        spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb8-12">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-13">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> pop_front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb8-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
</section>
</section>
<section id="push_back-and-pop_front-take-1" class="level1">
<h1><code>push_back()</code> and <code>pop_front()</code> take 1</h1>
<p>Here’s a first attempt at implementing <code>pop()</code>:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(++</span>idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-4">        idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> pop_front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb9-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>is_empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb9-12">        v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb9-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Unfortunately, this section of code for advancing <code>m_head</code> has a couple of problems. The increment of <code>m_head</code> could be pre-empted in the middle. And that’s a problem because the <code>push</code> thread also reads the <code>m_head</code> index in order to figure out, whether the queue is full.</p>
<p>Note that, <code>push_back()</code> is always called by the producer thread while <code>pop_front()</code> is always called by the consumer thread.</p>
<p>That’s why, the <code>spsc_queue</code>’s design depends on:</p>
<ul>
<li>Reading and writing the indices non-pre-emptively.</li>
<li>Having only one producer thread and one consumer thread.</li>
</ul>
<p>if the consumer thread is pre-empted while writing <code>m_head</code>, the producer thread may read a half-written nonsense value.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb10-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>If the producer thread is pre-empted while writing <code>m_tail</code>, the consumer thread may read a half-written nonsense value.</p>
<section id="using-atomic-indices" class="level2">
<h2 class="anchored" data-anchor-id="using-atomic-indices">Using atomic indices</h2>
<p>This is my implementation for SPSC lock-free queue with atomic indices.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;atomic&gt;</span></span>
<span id="cb11-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;thread&gt;</span></span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb11-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The capacity must be a power of two.</span></span>
<span id="cb11-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb11-9">    T <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alignas</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hardware_destructive_interference_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alignas</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hardware_destructive_interference_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-12"></span>
<span id="cb11-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb11-14">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-15">        spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb11-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb11-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb11-20"></span>
<span id="cb11-21">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-22">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb11-23">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-25"></span>
<span id="cb11-26">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-29"></span>
<span id="cb11-30">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb11-31">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-32">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-33"></span>
<span id="cb11-34">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> get_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb11-35">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-37"></span>
<span id="cb11-38">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> current_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-39">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> current_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-41">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> next_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-42">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-43"></span>
<span id="cb11-44">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-45">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-46">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_write_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-47">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>next_write_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_acquire<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb11-48">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-49"></span>
<span id="cb11-50">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-51">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>next_write_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_release<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-52">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-53">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-54"></span>
<span id="cb11-55">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> pop_front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-56">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-57">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_acquire<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb11-58">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-59"></span>
<span id="cb11-60">            v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>head<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-61">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_read_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-62">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>next_read_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_release<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-63">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-64">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-65"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<section id="why-do-we-use-a-power-of-2-buffer-size" class="level3">
<h3 class="anchored" data-anchor-id="why-do-we-use-a-power-of-2-buffer-size">Why do we use a power of <img src="https://latex.codecogs.com/png.latex?2"> buffer size?</h3>
<p>For a buffer of fixed capacity <img src="https://latex.codecogs.com/png.latex?N">, with current index <code>idx</code>, the index to the next element can be calculated as:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1">next_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>curr_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> N</span></code></pre></div>
<p>This is because our queue is a ring buffer, so after the last slot, we will go back to the zeroeth one, then the first one and so on.</p>
<p>We can use the above method to get the next index for any buffer size <img src="https://latex.codecogs.com/png.latex?N">. Why do we then only use capacity that are powers of <img src="https://latex.codecogs.com/png.latex?2">? The answer is easy: performance. The modulo (<code>%</code>) operator requires a division instruction, which is expensive. When the size <img src="https://latex.codecogs.com/png.latex?N"> is a power of <img src="https://latex.codecogs.com/png.latex?2">, we can just do the following:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curr_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
</section>
<section id="buffer-access-synchronization" class="level3">
<h3 class="anchored" data-anchor-id="buffer-access-synchronization">Buffer access synchronization</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/diagram-20251206.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Synchronization</figcaption>
</figure>
</div>
<p>Here’s what the actual execution order looks like after we make the indices atomic.</p>
<p>If we look at the push thread, the incremented value of the tail, <code>next_write_index</code> written to <code>m_tail</code> index is a release operation. Over on the pop thread, when we load the <code>m_tail</code> index (take a snapshot of it), this is an acquire operation. The combination of release and acquire on the same atomic variable implies that <code>m_tail</code> store in the push thread synchronizes with <code>m_tail</code> load on the pop thread.</p>
<p>The instruction <code>m_buffer[tail] = item</code> cannot be moved to after the release barrier in actual CPU execution order. The instrusction <code>v=m_buffer[head]</code> cannot be moved to before the acquire barrier in actual CPU exection order. So, we have happens-before relationship between these two instructions.</p>
<p>The release of <code>m_head</code> in the pop thread synchronizes with the acquire of <code>m_head</code> in the push thread.</p>


</section>
</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/spsc_lockfree_queue/index.html</guid>
  <pubDate>Fri, 05 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/spsc_lockfree_queue/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Pymalloc - Down the rabit hole</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/pymalloc_deep_dive/index.html</link>
  <description><![CDATA[ 




<section id="prerequisites" class="level1">
<h1>Prerequisites</h1>
<p>Download the CPython source and build it in the debug mode to step into the interpreter’s internals.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1">git clone https://github.com/python/cpython.git</span>
<span id="cb1-2">cd cpython</span>
<span id="cb1-3"></span>
<span id="cb1-4"># Configure with debug options</span>
<span id="cb1-5">./configure --with-pydebug</span>
<span id="cb1-6"></span>
<span id="cb1-7"># Build (feel free to adjust -j)</span>
<span id="cb1-8">make -j8</span></code></pre></div>
<p>This will produce a local python binary.</p>
</section>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>CPython is one of the many implementations of the Python runtime written in C code. There are other implementations such as PyPy, Jython. PyPy is a python compiler written in Python. PyPy’s logo is an Ouroboros to represent the self-hosting nature of the compiler. In this blog post, I summarize how object memory is alllocated and freed and how CPython manages memory leaks.</p>
<p>Python is a dynamically-typed language. The size of variables can’t be calculated at compile-time. Most of Python’s core types are dynamically sized. The <code>list</code> type can be of any size, a <code>dict</code> can have any number of keys, and even <code>int</code> is dynamic. The user never has to specify the size of these types. Names in Python can be reused for values of different types.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1">a_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-2">a_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Now, I'm a string"</span></span>
<span id="cb2-3">a_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Now"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"am"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>]</span></code></pre></div>
</div>
<p>To overcome these constraints, CPython relies heavily on dynamic memory allocation, but adds safety rails to automate the freeing of memory using the garbage collection and reference counting algorithms.</p>
<p>Instead of the Python developer having to allocate memory, Python object memory is allocated automatically by a single, unified API. This design requires that the entire CPython standard library and core modules(written in C) use this API.</p>
</section>
<section id="allocation-domains" class="level1">
<h1>Allocation Domains</h1>
<ul>
<li><p>The raw domain is used for allocation from the system heap and large, or non-object related memory.</p></li>
<li><p>The object domain is used for the allocation of all Python object related memory.</p></li>
<li><p>The PyMem domain is the same as <code>PYMEM_DOMAIN_OBJ</code>. this exists for legacy purposes.</p></li>
</ul>
<p>Each domain implements the same interface of frunctions:</p>
<ul>
<li><p><code>_Alloc(size_t size)</code> allocates memory of <code>size</code> bytes and returns a pointer.</p></li>
<li><p><code>_Calloc(size_t nelem, size_t el_size)</code> allocates <code>nelem</code> elements each of size <code>el_size</code> and returns a pointer.</p></li>
<li><p><code>_Realloc(void* ptr, size_t new_size)</code> reallocates memory of size <code>new_size</code>.</p></li>
<li><p><code>_Free(void* ptr)</code> frees memory at <code>ptr</code> back to the heap.</p></li>
</ul>
<p>The <code>PyMemAllocatorDomain</code> enumeration represents the three domains in CPython as <code>PYMEM_DOMAIN_RAW</code>, <code>PYMEM_DOMAIN_OBJ</code> and <code>PYMEM_DOMAIN_MEM</code>.</p>
<p>CPython uses <img src="https://latex.codecogs.com/png.latex?2"> memory allocators:</p>
<ul>
<li><code>malloc</code> is the operating system allocator for the raw memory domain.</li>
<li><code>pymalloc</code> is the CPython allocator the PyMem and object domains.</li>
</ul>
</section>
<section id="the-cpython-memory-allocator" class="level1">
<h1>The CPython memory allocator</h1>
<p>The CPython memory alloctor sit on top of the OS memory allocator and has an algorithm for allocation.</p>
<ul>
<li><p>Most of the memory allocation requests are small and of a fixed size, because <code>PyObject</code> is <img src="https://latex.codecogs.com/png.latex?16"> bytes, <code>PyASCIIObject</code> is <img src="https://latex.codecogs.com/png.latex?42"> bytes, <code>PyCompactUnicodeObject</code> is <img src="https://latex.codecogs.com/png.latex?72"> bytes.</p></li>
<li><p>The <code>pymalloc</code> allocator allocates memory blocks only upto <img src="https://latex.codecogs.com/png.latex?256"> KB. Anything larger is sent to the OS allocator.</p></li>
<li><p><code>pymalloc</code> uses the GIL instead of the system thread-safety check.</p></li>
</ul>
<p>To help clarify this situation, you can imagine a sports stadium, home of CPython FC, as an analogy. To help manage crowds, CPython FC has implemented a system breaking the stadium up into sections A to E, each with seating in rows <img src="https://latex.codecogs.com/png.latex?1"> to <img src="https://latex.codecogs.com/png.latex?40">.</p>
<p>At the front of the stadium, rows <img src="https://latex.codecogs.com/png.latex?1"> to <img src="https://latex.codecogs.com/png.latex?10"> are the roomier premium seats, with <img src="https://latex.codecogs.com/png.latex?80"> seats in each row. At the back rows <img src="https://latex.codecogs.com/png.latex?31"> to <img src="https://latex.codecogs.com/png.latex?40"> are the conomy seats with <img src="https://latex.codecogs.com/png.latex?150"> seats per row.</p>
<p>The Python memory allocation algorithm has similar characteristics:</p>
<ul>
<li>Just like the stadium as seats, the <code>pymalloc</code> algorithm has memory blocks.</li>
<li>Just like the seats can be premium, regular, or economy, memory blocks are all of range of fixed sizes. You can’t bring your desk chair!</li>
<li>Just like seats of the same size are put into rows, blocks of the same size are put into pools.</li>
</ul>
<p>A central register keeps a record of where blocks are and the number of blocks available in a pool, just as the stadium allocates seating. When a row in the stadium is full, the next row is used. When a pool of blocks is full, the next pool is used. Pools are groups into arenas, just like the stadium groups the rows into sections.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext itikz</span></code></pre></div>
</div>
<p>There are several advantages to this strategy:</p>
<ul>
<li>The algorithm is more performant for CPython’s main use case: small, short-lived objects.</li>
<li>The algorithm uses the GIL instead of system thread-lock detection.</li>
<li>The algorithm uses memory mapping <code>mmap()</code> syscall instead of heap allocations.</li>
</ul>
<p>The requested memory is always matched to a block size. Blocks of the same size are all put into the same <strong>pool</strong> of memory. Pools are grouped into arenas.</p>
<section id="blocks-pools-and-arenas" class="level2">
<h2 class="anchored" data-anchor-id="blocks-pools-and-arenas">Blocks, Pools and Arenas</h2>
<p><code>pymalloc</code> allocates large memory regions called arenas from the system, then divides them into pools.</p>
<section id="arenas" class="level3">
<h3 class="anchored" data-anchor-id="arenas">Arenas</h3>
<p>Arenas are allocated from the system heap using <code>mmap</code> when available otherwise <code>malloc</code>. CPython arenas are <img src="https://latex.codecogs.com/png.latex?256">-KB on 32-bit systems and <img src="https://latex.codecogs.com/png.latex?1"> MB on 64-bit systems. Each arena contains multiple pools.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#ifdef USE_LARGE_ARENAS</span></span>
<span id="cb4-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_BITS              </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                    </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 1 MiB */</span></span>
<span id="cb4-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#else</span></span>
<span id="cb4-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_BITS              </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                    </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 256 KiB */</span></span>
<span id="cb4-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#endif</span></span>
<span id="cb4-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_SIZE              </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span>ARENA_BITS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_SIZE_MASK         </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ARENA_SIZE<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<p>Arenas are scattered in the main memory. Each arena is a contiguous chunk of memory. CPython maintains a doubly linked list <code>usable_arenas</code> that tracks all the arena objects, that have atleast one pool available for allocation. The <code>usable_arenas</code> list is maintained in ascending order of each arena’s <code>nfreepools</code> (number of free pools). This sorting ensures that allocations preferentially use arenas with fewest free pools.</p>
<p>Our main book-keeping data structure of interest is the <code>arena_object</code>. The <code>usable_arenas</code> doubly linked list strings together <code>arena_object</code> nodes . These contain meta-information of each arena with <code>prevarena</code> and <code>nextarena</code> pointers. Each of these nodes have a <code>address</code> field which is a pointer to the actual contiguous block of memory (<img src="https://latex.codecogs.com/png.latex?256">KB / <img src="https://latex.codecogs.com/png.latex?1">MB) returned by <code>malloc</code>.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Record keeping for arenas. */</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> arena_object <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* The address of the arena, as returned by malloc.  Note that 0</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * will never be returned by a successful malloc, and is used</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * here to mark an arena_object that doesn't correspond to an</span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * allocated arena.</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     */</span></span>
<span id="cb5-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uintptr_t</span> address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9"></span>
<span id="cb5-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Pool-aligned pointer to the next pool to be carved off. */</span></span>
<span id="cb5-11">    pymem_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pool_address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-12"></span>
<span id="cb5-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* The number of available pools in the arena:  free pools + never-</span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * allocated pools.</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     */</span></span>
<span id="cb5-16">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> nfreepools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-17"></span>
<span id="cb5-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* The total number of pools in the arena, whether or not available. */</span></span>
<span id="cb5-19">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> ntotalpools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-20"></span>
<span id="cb5-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Singly-linked list of available pools. */</span></span>
<span id="cb5-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> freepools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Whenever this arena_object is not associated with an allocated</span></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * arena, the nextarena member is used to link all unassociated</span></span>
<span id="cb5-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * arena_objects in the singly-linked `unused_arena_objects` list.</span></span>
<span id="cb5-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * The prevarena member is unused in this case.</span></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     *</span></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * When this arena_object is associated with an allocated arena</span></span>
<span id="cb5-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * with at least one available pool, both members are used in the</span></span>
<span id="cb5-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * doubly-linked `usable_arenas` list, which is maintained in</span></span>
<span id="cb5-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * increasing order of `nfreepools` values.</span></span>
<span id="cb5-32"></span>
<span id="cb5-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     *</span></span>
<span id="cb5-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * Else this arena_object is associated with an allocated arena</span></span>
<span id="cb5-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * all of whose pools are in use.  `nextarena` and `prevarena`</span></span>
<span id="cb5-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * are both meaningless in this case.</span></span>
<span id="cb5-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     */</span></span>
<span id="cb5-38"></span>
<span id="cb5-39">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> arena_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nextarena<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-40">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> arena_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prevarena<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-41"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p><code>pool_address</code> serves as the arena’s <strong>high water mark</strong> pointer that tracks where to carve off the next pool. It’s initialized when an arena is created and advances as pools are allocated.</p>
<p>Each <code>arena_object</code> node also contains a field <code>freepools</code> of the type <code>pool_header*</code> which points to the head of a linked list which tracks available pools in the arena.</p>
<p>When an arena’s <code>nfreepools</code> reaches zero (all pools allocated), it’s removed from <code>usable_arenas</code> linked list. Conversely, when a pool becomes empty and is added to an arena’s freepools, the arena may be added back to <code>usable_arenas</code> if it was previously full.</p>
</section>
<section id="pools" class="level3">
<h3 class="anchored" data-anchor-id="pools">Pools</h3>
<p>Pools are <img src="https://latex.codecogs.com/png.latex?4">KB subdivisions (or <img src="https://latex.codecogs.com/png.latex?16"> Kb on large systems) of arenas. Normally, the size of the pool is equal to the size of a memory page. Limiting pool to the fixed size of blocks helps with fragmentation. Each pool manages blocks of single size class and can be in three states:</p>
<ul>
<li>Used : Partially allocated blocks.</li>
<li>Full : All blocks allocated.</li>
<li>Empty : All blocks available.</li>
</ul>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * Size of the pools used for small blocks.  Must be a power of 2.</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#ifdef USE_LARGE_POOLS</span></span>
<span id="cb6-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define POOL_BITS               </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 16 KiB */</span></span>
<span id="cb6-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#else</span></span>
<span id="cb6-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define POOL_BITS               </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 4 KiB */</span></span>
<span id="cb6-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#endif</span></span>
<span id="cb6-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define POOL_SIZE               </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span>POOL_BITS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<p>Each pool has a special header structure:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Pool for small blocks. */</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-3"></span>
<span id="cb7-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">union</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> pymem_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>_padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-5">            <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> ref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* number of allocated blocks    */</span></span>
<span id="cb7-6"></span>
<span id="cb7-7">    pymem_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>freeblock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* pool's free list head         */</span></span>
<span id="cb7-8"></span>
<span id="cb7-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>nextpool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* next pool of this size class  */</span></span>
<span id="cb7-10"></span>
<span id="cb7-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>prevpool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* previous pool of this size class                             */</span></span>
<span id="cb7-12"></span>
<span id="cb7-13">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> arenaindex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* index into arenas of base adr */</span></span>
<span id="cb7-14"></span>
<span id="cb7-15">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> szidx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* block size class index        */</span></span>
<span id="cb7-16"></span>
<span id="cb7-17">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> nextoffset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* bytes to virgin block         */</span></span>
<span id="cb7-18"></span>
<span id="cb7-19">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> maxnextoffset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* largest valid nextoffset      */</span></span>
<span id="cb7-20"></span>
<span id="cb7-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Pools of the same sized blocks are linked together using doubly linked list (the <code>nextpool</code> and <code>prevpool</code> fields). The <code>szidx</code> field keeps the size class index, whereas <code>ref.count</code> keeps the number of used blocks. The <code>arenaindex</code> stores the number of an arena in which this pool was created.</p>
<p>In order to efficient manage pools, a pool table called <code>usedpools</code> is maintained. A pool table is an array of pointers. It is segmented by the size class index <code>i</code>. For an index <code>i</code>, <code>usedpools[i+1]</code> points to the head of linked list of all partial used pools of the same size class <code>i</code>. Each node of this linked list is of type <code>pool_header</code>.</p>
<p>If a full pool has a block freed, then the pool is put back in the used state. The newly freed pool is added to the front of the approapriate <code>usedpools[]</code> list, so the next allocation for its size class will use the freed block.</p>
<p>On transition to empty, a pool is unlinked from its <code>usedpools[]</code> list and added to the front of the arena’s singly linked <code>freepools</code> list.</p>
</section>
<section id="blocks" class="level3">
<h3 class="anchored" data-anchor-id="blocks">Blocks</h3>
<p>Blocks are the actual allocated units, with sizes ranging from <img src="https://latex.codecogs.com/png.latex?8"> to <img src="https://latex.codecogs.com/png.latex?512"> bytes in <img src="https://latex.codecogs.com/png.latex?8">-byte increments.</p>
<table class="table">
<thead>
<tr class="header">
<th>Request in bytes</th>
<th>Size of the allocated block</th>
<th>Size class index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1-8</td>
<td>8</td>
<td>0</td>
</tr>
<tr class="even">
<td>9-16</td>
<td>16</td>
<td>1</td>
</tr>
<tr class="odd">
<td>17-24</td>
<td>24</td>
<td>2</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>505-512</td>
<td>512</td>
<td>63</td>
</tr>
</tbody>
</table>
<p>On a 64-bit system, since an arena is <img src="https://latex.codecogs.com/png.latex?1"> MB, there will always be <img src="https://latex.codecogs.com/png.latex?64"> pools each of size <img src="https://latex.codecogs.com/png.latex?16">KB.</p>
<p>Within a pool, blocks of fixed size can be allocated and freed. Available blocks within a pool are listed in the singly linked list <code>freeblock</code>. Whenever a block is freed, its inserted at the front of the <code>freeblock</code> list. When a pool is initialized, only the first two blocks are linked within the <code>freeblock</code> list.</p>
</section>
<section id="block-allocation-api" class="level3">
<h3 class="anchored" data-anchor-id="block-allocation-api">Block allocation API</h3>
<p>When a block of memory is requested by a memory domain that uses <code>pymalloc</code>, the API function <code>pymalloc_alloc()</code> is invoked. This function is a good place to insert a break-point and step through the code to test your knowledge of blocks, pools and arenas.</p>
</section>
</section>
</section>
<section id="cpython-interning" class="level1">
<h1>CPython interning</h1>
<p>The general rule is that objects are allocated on assignment. Variables just point to objects. There is an exception to this general rule. This is python runtime implementation specific. Often commonly used objects are preallocated and are shared instead of costly new allocations. This is mainly done for performance optimization.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb8-2">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb8-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> y, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> y)</span>
<span id="cb8-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb8-5">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb8-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> y, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> y)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True True
False True</code></pre>
</div>
</div>
<p><code>int</code>s in the range <img src="https://latex.codecogs.com/png.latex?%5B-5,257)">, empty tuples and all empty or single length strings are preallocated.</p>
<section id="string-interning-explained" class="level2">
<h2 class="anchored" data-anchor-id="string-interning-explained"><code>string</code> interning explained</h2>
<p>String interning is a method of storing only one copy of each distinct string value, which must be immutable. In Python3, we have a function <code>sys.intern()</code> and if we use this function, we can enter a string in the table of interned strings. We get a reference to the interned string.</p>
<p>So, we can gain a little extra performance on dictionary lookup (key comparisons after hashing can be done by a pointer compare instead of a string compare).</p>
<p>Names used in programs are automatically interned. Dictionaries used to hold module, class or instance attributes have interned keys.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sys <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">intern</span></span>
<span id="cb10-2">a, b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"strin"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb10-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'g'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Returns false</span></span>
<span id="cb10-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">intern</span>(a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'g'</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">intern</span>(b) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># returns True</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>False</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
<section id="mutable-containers-memory-allocationn-strategy" class="level1">
<h1>Mutable containers memory allocationn strategy</h1>
<p>There are different mutable containers in Python - <code>list</code>s, <code>set</code>s and <code>dict</code>s. Behind the scenes, there is a strategy for allocating these containers.</p>
<p>A good strategy will plan for growth and shrinkage. It will slightly overallocate memory needed by the container, to leave room for growth. Each time we append to a <code>list</code>, we won’t have to reallocate the memory. We also have to remember that sometimes we have to shrink the memory for a mutable container. This can help reduce the number of expensive function calls for instance to <code>realloc</code> or <code>memcpy</code>.</p>
</section>
<section id="list-allocation-strategy" class="level1">
<h1>List allocation strategy</h1>
<p>Lists are stored as fixed length array of pointers. So, we just point to objects. By design, we overallocate for list growth by append.</p>
<ul>
<li>The capacity growth pattern is roughly <img src="https://latex.codecogs.com/png.latex?4,8,16,25,35,46,%5Cldots"></li>
</ul>
<p>If we put something at the end of the list, these operations are cheap. But, if we put something in the middle or the beginning, we’ll have to copy/shift the elements in memory to perform this operation.</p>
<p>On my 64-bit machine, with Python 3.13.7, the list allocation size is:</p>
<ul>
<li>64 bits : <code>56 + 8 * length</code></li>
</ul>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb13-2">l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb13-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>):</span>
<span id="cb13-4">    l.append(i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"List len = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(l)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, size = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getsizeof(l)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> bytes"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List len = 1, size = 88 bytes
List len = 2, size = 88 bytes
List len = 3, size = 88 bytes
List len = 4, size = 88 bytes
List len = 5, size = 120 bytes
List len = 6, size = 120 bytes
List len = 7, size = 120 bytes
List len = 8, size = 120 bytes
List len = 9, size = 184 bytes
List len = 10, size = 184 bytes
List len = 11, size = 184 bytes
List len = 12, size = 184 bytes
List len = 13, size = 184 bytes
List len = 14, size = 184 bytes
List len = 15, size = 184 bytes
List len = 16, size = 184 bytes
List len = 17, size = 248 bytes</code></pre>
</div>
</div>
<p>There is a fixed overhead of <img src="https://latex.codecogs.com/png.latex?56"> bytes (the object header, type pointer, reference count ) etc.</p>
<p>For each size tier, the calculation is approximately:</p>
<ul>
<li>88 bytes = 56 + 32(4 slots)</li>
<li>120 bytes = 56 + 64(8 slots)</li>
<li>184 bytes = 56 + 128(16 slots)</li>
<li>248 bytes =56 + 192(24 slots)</li>
</ul>
<p>We shrink when the list size goes below <img src="https://latex.codecogs.com/png.latex?1/2"> of the allocated storage. This is why appending to Python lists is <img src="https://latex.codecogs.com/png.latex?O(1)"> amortized time - most appends just fill unused capacity, and only occasional appends trigger a reallocation.</p>
</section>
<section id="overallocation-of-dictionaries-and-sets" class="level1">
<h1>Overallocation of dictionaries and sets</h1>
<p>These are represented as fixed-length hash tables. We overallocate when we reach <img src="https://latex.codecogs.com/png.latex?2/3">rd of the capacity of a dictionary of set. For small dictionaries or sets, we quadruple the capacity else we double the capacity.</p>


</section>

 ]]></description>
  <category>Python</category>
  <guid>http://quantdev.blog/posts/pymalloc_deep_dive/index.html</guid>
  <pubDate>Thu, 27 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/pymalloc_deep_dive/python.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Generators, iterators and asynchronous programming</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/generators_iterators_and_asynchronous_programming/index.html</link>
  <description><![CDATA[ 




<section id="what-is-a-generator" class="level1">
<h1>What is a generator?</h1>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext itikz</span></code></pre></div>
</div>
<p>A generator is a function that uses the <code>yield</code> keyword to return an item. When a generator function is called, it returns a generator object, which is a type of iterator. Here is a simple generator, that produces a sequence of numbers:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> number_generator(n):</span>
<span id="cb2-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb2-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> i</span>
<span id="cb2-4"></span>
<span id="cb2-5">gen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> number_generator(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1_000_000</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(gen))</span>
<span id="cb2-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(gen))</span>
<span id="cb2-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(gen))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0
1
2</code></pre>
</div>
</div>
<p>The state of the generator is saved between <code>yield</code> calls. The state of generator is the state of the local variables when the generator is suspended. This allows it to resume where it left off.</p>
<p>The main use of generators is to save memory - instead of having a very large list of elements in memory, holding everything at once, we have an object that knows how to produce each particular element, one at a time. This enables lazy computations of heavy objects in memory.</p>
</section>
<section id="example-flattening-a-list-of-lists" class="level1">
<h1>Example: Flattening a list of lists</h1>
<p>A common task is to flatten a list of lists into a single list.</p>
<p>Imagine you have a list of trades, where each trade has a list of associated cashflows. You want to process all cashflows from all trades.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ref: bwrob.github.io/posts/python-academy-iteration </span></span>
<span id="cb4-2">trades_cashflows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-3">    [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>],   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cashflows for trade 1</span></span>
<span id="cb4-4">    [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>],       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cashflows for trade 2</span></span>
<span id="cb4-5">    [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cashflows for trade 3</span></span>
<span id="cb4-6">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">110</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simple payment doesn't need to be in a list</span></span>
<span id="cb4-7">]</span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> flatten(list_of_lists):</span>
<span id="cb4-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> list_of_lists:</span>
<span id="cb4-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(item, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>):</span>
<span id="cb4-12">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> subitem <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> item:</span>
<span id="cb4-13">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> subitem</span>
<span id="cb4-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb4-15">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> item</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The generator does not hold all cashflows in memory</span></span>
<span id="cb4-18">all_cashflows_generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> flatten(trades_cashflows)</span>
<span id="cb4-19"></span>
<span id="cb4-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> cf <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> all_cashflows_generator:</span>
<span id="cb4-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(cf, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10 20 30 15 25 100 -10 5 110 </code></pre>
</div>
</div>
<p>This <code>flatten</code> generator is memory-efficient. It only needs to store one cashflow at a time, regardless of the total number of cashflows.</p>
</section>
<section id="example-generating-the-fibonacci-sequence" class="level1">
<h1>Example: Generating the fibonacci sequence</h1>
<p>The Fibonacci sequence is defined by the recurrence relation: <img src="https://latex.codecogs.com/png.latex?F_n%20=%20F_%7Bn-1%7D%20+%20F_%7Bn-2%7D"> with seed values <img src="https://latex.codecogs.com/png.latex?F_0%20=%200"> and <img src="https://latex.codecogs.com/png.latex?F_1%20=%201">. A naive implementation of this in Python is a direct translation of the mathematical formula:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> fibonacci_recursive(n: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Calculate the nth Fibonacci number using a recursive approach."""</span></span>
<span id="cb6-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb6-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fibonacci is not defined for negative numbers"</span>)</span>
<span id="cb6-5">    </span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb6-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> n</span>
<span id="cb6-8"></span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> fibonacci_recursive(n) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fibonacci_recursive(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<p>For <code>n=40</code>, this already takes a long amount of time. We are doing lot of rework. Another way to solve this problem is to use an iterative approach.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> fibonacci_iterative(n: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb7-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Calculate the nth Fibonacci number using an iterative approach."""</span></span>
<span id="cb7-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb7-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fibonacci is not defined for negative numbers"</span>)</span>
<span id="cb7-5"></span>
<span id="cb7-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb7-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> n</span>
<span id="cb7-8"></span>
<span id="cb7-9">    a, b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb7-11">        a, b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b, a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb7-12">    </span>
<span id="cb7-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> b</span></code></pre></div>
</div>
<p>We can also code up a generator to produce the fibonacci sequence.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> fibonacci_generator():</span>
<span id="cb8-2">    a, b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb8-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> a</span>
<span id="cb8-5">        a, b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b, a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb8-6"></span>
<span id="cb8-7">gen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fibonacci_generator()</span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb8-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"F_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(gen)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>F_0 = 0
F_1 = 1
F_2 = 1
F_3 = 2
F_4 = 3
F_5 = 5
F_6 = 8
F_7 = 13
F_8 = 21
F_9 = 34</code></pre>
</div>
</div>
</section>
<section id="generator-expressions" class="level1">
<h1>Generator expressions</h1>
<p>List comprehensions are widely used in Python. However, many of the use-cases do not need to have the full list created in-memory. Instead, they only need to iterate over the elements one at a time.</p>
<p>For example, the following summation code will build a full list of squares in memory, iterate over those values, and when the reference is no longer needed, delete the list.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>([x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>285</code></pre>
</div>
</div>
<p>Memory is conserved by using a generator expression instead.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>285</code></pre>
</div>
</div>
<p>Consider taking the inner product of the vectors <code>x_vector</code> and <code>y_vector</code>:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">x_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb14-2">y_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> x, y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(x_vector, y_vector))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>130</code></pre>
</div>
</div>
</section>
<section id="iterators" class="level1">
<h1>Iterators</h1>
<p>An iterator is an object that represents a stream of data. It produces one item at a time, only when requested. This <em>lazy</em> evaluation is incredibly memory-efficient. The iterator protocol in Pythoon consists of two methods:</p>
<ul>
<li><code>__iter__()</code>: Returns the iterator object itself</li>
<li><code>__next__()</code>: Returns the next item from the stream. When there are no more items, it raise a <code>StopIteration</code> exception.</li>
</ul>
<p>Having these protocols in Python has an advantage: everyone know that Python will be familiar with this interface already, so there a sort of <em>standard contract</em>.</p>
</section>
<section id="example-finding-the-implied-volatility-of-european-vanilla-options-using-an-iterative-root-solver" class="level1">
<h1>Example : Finding the implied volatility of European vanilla options using an iterative root-solver</h1>
<p>For the purposes of this example, I will use the <a href="https://en.wikipedia.org/wiki/Bisection_method">bisection method</a> to solve for the implied volatility of a European call option.</p>
<p>The bisection method makes use of the <a href="https://en.wikipedia.org/wiki/Intermediate_value_theorem">intermediate value theorem</a>(IVT) from Real Analysis. The intermediate value theorem states that the image of a continuous function <img src="https://latex.codecogs.com/png.latex?f"> over an interval <img src="https://latex.codecogs.com/png.latex?(a,b)"> is an interval. If <img src="https://latex.codecogs.com/png.latex?f"> is a continuous function, it preserves intervals. If we take an interval and apply a continous function <img src="https://latex.codecogs.com/png.latex?f"> to it, the image is also an interval. It captures the intuitive notion, there are no gaps or jumps in a continuous curve. If <img src="https://latex.codecogs.com/png.latex?f"> is continuous and <img src="https://latex.codecogs.com/png.latex?f(a)%20%3C%20k%20%3Cf(b)">, then there exists an element <img src="https://latex.codecogs.com/png.latex?c%5Cin(a,b)">, such that <img src="https://latex.codecogs.com/png.latex?f(c)=k">.</p>
<section id="iteration-process" class="level2">
<h2 class="anchored" data-anchor-id="iteration-process">Iteration process</h2>
<p>We start with an initial interval <img src="https://latex.codecogs.com/png.latex?%5Ba,b%5D">, such that the function values <img src="https://latex.codecogs.com/png.latex?f(a)"> and <img src="https://latex.codecogs.com/png.latex?f(b)"> are of opposite sign.</p>
<p><strong>Step 1</strong>. We calculate the midpoint <img src="https://latex.codecogs.com/png.latex?m%20=%20(a%20+%20b)/2">.</p>
<p><strong>Step 2</strong>. Case I. If <img src="https://latex.codecogs.com/png.latex?f(a)"> and <img src="https://latex.codecogs.com/png.latex?f(m)"> have the same signs, the root must be in the right half <img src="https://latex.codecogs.com/png.latex?%5Bm,b%5D">. So, we set <img src="https://latex.codecogs.com/png.latex?a=m">.</p>
<p>Case II. If <img src="https://latex.codecogs.com/png.latex?f(m)"> and <img src="https://latex.codecogs.com/png.latex?f(b)"> have the same signs, the root must be in the left half <img src="https://latex.codecogs.com/png.latex?%5Ba,m%5D">. So, we set <img src="https://latex.codecogs.com/png.latex?b=m">.</p>
<p>We iteratively perform steps (1) and (2) until the absolute or relative error is within a certain tolerance <img src="https://latex.codecogs.com/png.latex?%5Cepsilon">.</p>
<div class="text-center">
<div class="cell" data-execution_count="10">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>backgrounds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Scenario <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>: Root <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> left half</span>
<span id="cb16-4">\begin{tikzpicture}[scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, background rectangle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>.style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>white}, show background rectangle]</span>
<span id="cb16-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Axes</span>
<span id="cb16-6">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) node[right] {$x$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-7">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) node[above] {$y$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-8">    </span>
<span id="cb16-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Points</span>
<span id="cb16-10">    \coordinate (a) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-11">    \coordinate (b) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-12">    \coordinate (m) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-13">    </span>
<span id="cb16-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Function curve (convex)</span>
<span id="cb16-15">    \draw[thick, blue, domain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>:<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>, samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>] </span>
<span id="cb16-16">        plot (\x, {<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(\x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(\x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-17">    </span>
<span id="cb16-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Vertical lines <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> points</span>
<span id="cb16-19">    \draw[dashed] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-20">    \draw[dashed] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-21">    \draw[dashed] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-22">    </span>
<span id="cb16-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Function values</span>
<span id="cb16-24">    \fill[red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>}) circle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) </span>
<span id="cb16-25">        node[below left] {$f(a) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-26">    \fill[red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>}) circle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) </span>
<span id="cb16-27">        node[below right] {$f(m) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-28">    \fill[red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>}) circle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) </span>
<span id="cb16-29">        node[above right] {$f(b) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-30">    </span>
<span id="cb16-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>axis labels</span>
<span id="cb16-32">    \fill (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) circle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) node[below] {$a$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-33">    \fill (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) circle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) node[below] {$m$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-34">    \fill (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) circle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) node[below] {$b$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-35">    </span>
<span id="cb16-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Root indicator</span>
<span id="cb16-37">    \draw[thick, red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-38">    \node[red] at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>) {Root <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> $[m, b]$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-39">    </span>
<span id="cb16-40">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb16-41">    \node[align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center] at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) {\textbf{Scenario <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:} $f(a)$ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> $f(m)$ have same sign}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-42">    \node[align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center] at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {New interval: $[m, b]$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-43">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<p><img src="http://quantdev.blog/posts/generators_iterators_and_asynchronous_programming/index_files/figure-html/cell-11-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<div class="text-center">
<div class="cell" data-execution_count="11">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>backgrounds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb17-2">\begin{tikzpicture}[scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, background rectangle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>.style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>white}, show background rectangle]</span>
<span id="cb17-3">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Axes</span>
<span id="cb17-4">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) node[right] {$x$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-5">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) node[above] {$y$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-6">    </span>
<span id="cb17-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Points</span>
<span id="cb17-8">    \coordinate (a) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-9">    \coordinate (b) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-10">    \coordinate (m) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-11">    </span>
<span id="cb17-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Function curve (convex)</span>
<span id="cb17-13">    \draw[thick, blue, domain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>:<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>, samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>] </span>
<span id="cb17-14">        plot (\x, {<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(\x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(\x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-15">    </span>
<span id="cb17-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Vertical lines <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> points</span>
<span id="cb17-17">    \draw[dashed] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-18">    \draw[dashed] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-19">    \draw[dashed] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-20">    </span>
<span id="cb17-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Function values</span>
<span id="cb17-22">    \fill[red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>}) circle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) </span>
<span id="cb17-23">        node[above left] {$f(a) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-24">    \fill[red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>}) circle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) </span>
<span id="cb17-25">        node[above right] {$f(m) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-26">    \fill[red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>}) circle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) </span>
<span id="cb17-27">        node[below right] {$f(b) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-28">    </span>
<span id="cb17-29">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>axis labels</span>
<span id="cb17-30">    \fill (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) circle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) node[below] {$a$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-31">    \fill (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) circle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) node[below] {$m$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-32">    \fill (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) circle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>) node[below] {$b$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-33">    </span>
<span id="cb17-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Root indicator</span>
<span id="cb17-35">    \draw[thick, red] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-36">    \node[red] at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>) {Root <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> $[a, m]$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-37"></span>
<span id="cb17-38">    </span>
<span id="cb17-39">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb17-40">    \node[align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center] at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) {\textbf{Scenario <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:} $f(m)$ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> $f(b)$ have same sign}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-41">    \node[align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center] at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {New interval: $[a, m]$}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-42">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<p><img src="http://quantdev.blog/posts/generators_iterators_and_asynchronous_programming/index_files/figure-html/cell-12-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>A call option is the right to buy an asset at a future time <img src="https://latex.codecogs.com/png.latex?T">, at a pre-determined price <img src="https://latex.codecogs.com/png.latex?K">. A put option is the right to sell an asset at a future time <img src="https://latex.codecogs.com/png.latex?T">, at a pre-determined price <img src="https://latex.codecogs.com/png.latex?K">.</p>
<p>Vanilla options have two quote conventions - they can be quoted in terms of a price (in dollar terms) or in terms of the implied volatility. The Black-Scholes analytic formula used as a converter to convert an implied-vol quote to a price.</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?%5Csigma"> be the market-implied volatility of the option. Then, the call option price is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AC_%7BBS%7D(%5Csigma)%20=%20S_t%20%5CPhi(d_%7B+%7D)%20-%20K%20e%5E%7B-r(T-t)%7D%5CPhi(d_%7B-%7D)%0A"></p>
<p>where</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ad_%7B%5Cpm%7D%20=%20%5Cfrac%7B%5Clog(S_t/K)%20+%20(r%20%5Cpm%20%5Csigma%5E2/2)(T-t)%7D%7B%5Csigma%20%5Csqrt%7BT-t%7D%7D%0A"></p>
<p>Conversely, if we have the observed marker option quote <img src="https://latex.codecogs.com/png.latex?C_%7BBS%7D">, we can backout the implied volatility <img src="https://latex.codecogs.com/png.latex?%5Csigma">, by solving for the root of the above equation.</p>
<p>Thus, we can define</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Af(%5Csigma)%20=%20S_t%20%5CPhi(d_%7B+%7D)%20-%20K%20e%5E%7B-r(T-t)%7D%5CPhi(d_%7B-%7D)%20-%20C_%7BBS%7D%0A"></p>
<p>and find the root of <img src="https://latex.codecogs.com/png.latex?f">. Assume that the root lies in the interval <img src="https://latex.codecogs.com/png.latex?%5B0,1%5D">.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb18-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Callable</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> d_plus(S, K, T, r, sigma):</span>
<span id="cb18-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""d+ term of the Black formula"""</span></span>
<span id="cb18-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (math.log(S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> K) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> T)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> math.sqrt(T))</span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> d_minus(S, K, T, r, sigma):</span>
<span id="cb18-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""d- term of the Black formula"""</span></span>
<span id="cb18-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (math.log(S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> K) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> T)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> math.sqrt(T))</span>
<span id="cb18-11"></span>
<span id="cb18-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> norm_cdf(x : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb18-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""An approximation to standard normal CDF."""</span></span>
<span id="cb18-14">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2316419</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-15">    k_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.319381530</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.356563782</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.781477937</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.821255978</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.330274429</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k))))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-16"></span>
<span id="cb18-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>:</span>
<span id="cb18-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">pow</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.14159</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>math.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k_sum)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb18-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> norm_cdf(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-21">  </span>
<span id="cb18-22"></span>
<span id="cb18-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> call_option_price(</span>
<span id="cb18-24">    S : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, K : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, r: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, T: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, sigma: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb18-25">):</span>
<span id="cb18-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""The price of European vanilla call option."""</span></span>
<span id="cb18-27">    d_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d_plus(S, K, T, r, sigma)</span>
<span id="cb18-28">    d_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d_minus(S, K, T, r, sigma)</span>
<span id="cb18-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> norm_cdf(d_1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> math.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> T) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> norm_cdf(d_2)</span>
<span id="cb18-30"></span>
<span id="cb18-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> BisectionSolver:</span>
<span id="cb18-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""A solver that iteratively halves the search interval"""</span></span>
<span id="cb18-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, y_target: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb18-34">    a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb18-35">    b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb18-36">    epsilon: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb18-37">    g : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">callable</span>):</span>
<span id="cb18-38">    </span>
<span id="cb18-39">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_target</span>
<span id="cb18-40">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a</span>
<span id="cb18-41">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b</span>
<span id="cb18-42">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.epsilon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> epsilon</span>
<span id="cb18-43">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g</span>
<span id="cb18-44">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.b)</span>
<span id="cb18-45">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.m)</span>
<span id="cb18-46">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-47"></span>
<span id="cb18-48">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__iter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb18-49">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Return the iterator object (self)"""</span></span>
<span id="cb18-50">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb18-51">    </span>
<span id="cb18-52">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__next__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb18-53">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Advance one step to generate the next iterate"""</span></span>
<span id="cb18-54">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_target) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.epsilon:</span>
<span id="cb18-55">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">StopIteration</span></span>
<span id="cb18-56">    </span>
<span id="cb18-57">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb18-58">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.m</span>
<span id="cb18-59"></span>
<span id="cb18-60">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb18-61">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.m</span>
<span id="cb18-62"></span>
<span id="cb18-63">        m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.m</span>
<span id="cb18-64">        i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.i</span>
<span id="cb18-65">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-66">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.b)</span>
<span id="cb18-67">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.g(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.m)</span>
<span id="cb18-68">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (i,m)</span>
<span id="cb18-69"></span>
<span id="cb18-70"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb18-71">    S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb18-72">    K<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb18-73">    r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb18-74">    T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb18-75">    market_quote <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.450577973198428</span></span>
<span id="cb18-76"></span>
<span id="cb18-77">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> g(sigma: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb18-78">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> call_option_price(S, K, r, T, sigma)</span>
<span id="cb18-79"></span>
<span id="cb18-80">    solver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BisectionSolver(market_quote, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5e-5</span>, g)</span>
<span id="cb18-81">    </span>
<span id="cb18-82">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">iter</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> solver:</span>
<span id="cb18-83">        i, root <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">iter</span></span>
<span id="cb18-84">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Iteration# : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, root estimate : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>root<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Iteration# : 1, root estimate : 0.5
Iteration# : 2, root estimate : 0.25
Iteration# : 3, root estimate : 0.125
Iteration# : 4, root estimate : 0.1875
Iteration# : 5, root estimate : 0.21875
Iteration# : 6, root estimate : 0.203125
Iteration# : 7, root estimate : 0.1953125
Iteration# : 8, root estimate : 0.19921875
Iteration# : 9, root estimate : 0.201171875
Iteration# : 10, root estimate : 0.2001953125
Iteration# : 11, root estimate : 0.19970703125
Iteration# : 12, root estimate : 0.199951171875
Iteration# : 13, root estimate : 0.2000732421875
Iteration# : 14, root estimate : 0.20001220703125
Iteration# : 15, root estimate : 0.199981689453125
Iteration# : 16, root estimate : 0.1999969482421875
Iteration# : 17, root estimate : 0.20000457763671875
Iteration# : 18, root estimate : 0.20000076293945312
Iteration# : 19, root estimate : 0.1999988555908203
Iteration# : 20, root estimate : 0.19999980926513672
Iteration# : 21, root estimate : 0.20000028610229492</code></pre>
</div>
</div>
<p>We see that a <img src="https://latex.codecogs.com/png.latex?1">-year call option struck at <img src="https://latex.codecogs.com/png.latex?K=100"> with the underlying spot at <img src="https://latex.codecogs.com/png.latex?100">, annualised interest rate <img src="https://latex.codecogs.com/png.latex?r=0.05"> with market price <img src="https://latex.codecogs.com/png.latex?C_%7BBS%7D=10.45"> corresponds to an implied volatility of <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7BBS%7D=0.20">.</p>
<p>While this toy solver uses the Bisection algorithm, the bisection method has a slow rate of convergence. The <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.brentq.html">Brent-Dekker</a> algorithm is considered the industry standard for root finding.</p>
<p>Many numerical solvers for finding roots, finding solutions of ODEs and PDEs are iterative in nature.</p>
</section>
</section>
<section id="challenge-question" class="level1">
<h1>Challenge question</h1>
<p>Here is a challenge question to test your understanding. Observe the code snippet below. What will <code>print(type(t))</code> output?</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">lst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span>
<span id="cb20-2"></span>
<span id="cb20-3">l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> n <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> lst]</span>
<span id="cb20-4">s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> n <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> lst}</span>
<span id="cb20-5">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {n : n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>n <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> lst}</span>
<span id="cb20-6">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> n <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> lst)</span>
<span id="cb20-7"></span>
<span id="cb20-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(l))</span>
<span id="cb20-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(s))</span>
<span id="cb20-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(d))</span>
<span id="cb20-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(t))</span></code></pre></div>
<p>For more such questions, visit <a href="https://getcracked.io/">getcracked.io</a>.</p>


</section>

 ]]></description>
  <category>Python</category>
  <guid>http://quantdev.blog/posts/generators_iterators_and_asynchronous_programming/index.html</guid>
  <pubDate>Mon, 24 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/generators_iterators_and_asynchronous_programming/python.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Pythonic code</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/pythonic_code/index.html</link>
  <description><![CDATA[ 




<section id="pythonic-code" class="level1">
<h1>Pythonic code</h1>
<section id="context-managers" class="level2">
<h2 class="anchored" data-anchor-id="context-managers">Context Managers</h2>
<p>Context managers are a very useful feature in Python. Most of the time, we see contet managers around resource management. For example, in situations, when we open files, we want to make sure they are closed after processing (so we do not leak file descriptors). Or, if we open a connection to a service (or even a socket), we also want to be sure to close it accordingly. In all of these cases, you would normally have to remember to free all of the resources that were allocated and that is just thinking about the best case - there could be also be exceptions and error handling. Handling all possible combinations and execution paths of our program makes it harder. There is a elegant Pythonic way of handling this.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(filename) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> fd:</span>
<span id="cb1-2">    process_file(fd)</span></code></pre></div>
<p>The <code>with</code> statement (PEP-43) enters the context manager. In this case, the <code>open</code> function implements the context manager protocol, which means that the file will be automatically closed when the block is finished, even if an exception occurred.</p>
<p>Context managers consist of two magic methods <code>__enter__</code> and <code>__exit__</code>. On the first line of the context manager, the <code>with</code> statement will call the first method, <code>__enter__</code>, and whatever this method returns will be assigned to the variable after <code>as</code>. This is optional - we don’t really need to return anything specific on the <code>__enter__</code> method, even if we do, there is still no strict reason to assign it to a variable if it is not needed.</p>
<p>After this line is executed, the code enters a new context, where any other Python code can be run. After the last statement on the block is finished, the context will be exited, meaning that Python will call the <code>__exit__</code> method of the original context manager object we first invoked.</p>
<p>If there is an exception or error inside the context manager block, the <code>__exit__</code> method will still be called, which makes it convenient for safely cleaning up the conditions. In fact, this method receives the exceptions that was triggered on the block in case we want to handle it in a custom fashion.</p>
<p>Context managers are a good way of seperating concerns and isolating parts of the code that should be kept independent, because if we mix them, then the logic will become harder to maintain.</p>
<p>As an example, consider a situation where we want to run a backup of our database with a script. The caveat is that the backup is offline, which means that we can only do it while the database is not running, and for this we have to stop it. After running the backup, we want to be sure that we start the process again, regardless of how the backup itself went.</p>
<p>Instead of creating a monolithic function to do this, we can tackle this issue with context managers:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> stop_database():</span>
<span id="cb2-2">    run(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"systemctl stop postgresql.service"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> start_database():</span>
<span id="cb2-5">    run(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"systemctl start postgresql.service"</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DBHandler:</span>
<span id="cb2-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__enter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb2-9">        stop_database()</span>
<span id="cb2-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb2-11">    </span>
<span id="cb2-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__exit__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, exc_type, ex_value, ex_traceback):</span>
<span id="cb2-13">        start_database()</span>
<span id="cb2-14">    </span>
<span id="cb2-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> db_backup():</span>
<span id="cb2-16">    run(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pg_dump database"</span>)</span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> main():</span>
<span id="cb2-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> DBHandler():</span>
<span id="cb2-20">        db_backup()</span></code></pre></div>
<section id="implementing-context-managers" class="level3">
<h3 class="anchored" data-anchor-id="implementing-context-managers">Implementing context managers</h3>
<p>In general, we can implement context managers like the one in the previous example. All we need is just a class that implements the <code>__enter__</code> and <code>__exit__</code> magic methods, and then that object will be able to support the context manager protocol. While this is the most common way for context managers to be implemented, it is not the only one.</p>
<p>The <code>contextlib</code> module in the Python standard library contains a lot of helper functions and objects to implement context managers or use ones already provided that can help us write more compact code.</p>
<p>Lets start by looking at the <code>contextmanager</code> decorator.</p>
<p>When the <code>contextlib.contextmanager</code> decorator is applied to a function, it converts the code on that function into a context manager. The function in question has to be a particular kind of function called a <code>generator</code> function, which will separate statements into what is going to be on <code>__enter__</code> and <code>__exit__</code> magic methods respectively.</p>
<p>The equivalent code in the previous example can be written as:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> contextlib</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@contextlib.contextmanager</span></span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> db_handler():</span>
<span id="cb3-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb3-6">        stop_database()</span>
<span id="cb3-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span></span>
<span id="cb3-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">finally</span>:</span>
<span id="cb3-9">        start_database()</span>
<span id="cb3-10"></span>
<span id="cb3-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> db_handler():</span>
<span id="cb3-12">    db_backup()</span></code></pre></div>
<p>Here, we define the <code>generator</code> function and apply the <code>@contextlib.contextmanager</code> decorator to it. The function contains a <code>yield</code> statement, which makes it a generator function. Details on generators are not important at this point. All we need to know, is when the decorator is applied, everything before the <code>yield</code> statement will be run as if it were part of the <code>__enter__</code> method. Then the yielded value is going to be the result of the context manager evaluation (what <code>__enter__</code> would return and what would be assigned to the variable if we chose to assign it like <code>as x:</code> - in this case nothing is yielded).</p>
<p>At the <code>yield</code> statement, the <code>generator</code> function is suspended, and the context manager is entered, where, again we run the backup code for our database. After this completes, the execution resumes, so we can consider every line that comes after the <code>yield</code> statement will be part of <code>__exit__</code> logic.</p>
<p>Writing context managers like this has the advantage that it is easier to refactor existing functions, reuse code and in general a good idea when we need a context manager that doesn’t belong to a particular object.</p>
<p>Using context managers is considered idiomatic.</p>
</section>
</section>
<section id="comprehensions-and-assignment-expressions" class="level2">
<h2 class="anchored" data-anchor-id="comprehensions-and-assignment-expressions">Comprehensions and assignment expressions</h2>
<p>The use of comprehensions is recommended to create data-structures in a single instruction, instead of multiple operations. For example, if we wanted to create a list with calculations over some numbers in it, instead of:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">numbers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb4-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb4-3">    numbers.append(run_calculation(i))</span></code></pre></div>
<p>we could do:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">numbers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [run_calculation(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)]</span></code></pre></div>
<p>The introduction of assignment expressions in <a href="https://www.python.org/dev/peps/pep-0572/">PEP-572</a> is also very useful.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute partial sums in a list comprehension</span></span>
<span id="cb6-2">total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-3">partial_sums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> v <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> values]</span>
<span id="cb6-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Total:"</span>, total)</span></code></pre></div>
<p>The <code>:=</code> operator is informally known as the walrus operator.</p>
<section id="using-the-walrus-operator" class="level3">
<h3 class="anchored" data-anchor-id="using-the-walrus-operator">Using the walrus operator</h3>
<p>In this example, the assignment expression helps avoid calling <code>len()</code> twice:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>))</span>
<span id="cb7-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(a)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:</span>
<span id="cb7-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"List is too long (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> elements, expected &lt;= 10)"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List is too long (15 elements, expected &lt;= 10)</code></pre>
</div>
</div>
<p>The operator is also useful with <code>while</code> loops that compute a value to test loop termination and then need that value again in the body of the loop.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> f.read(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>:</span>
<span id="cb9-2">    process(block)</span></code></pre></div>
<p>A subexpression can be shared between a comprehension filter and its output.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Share a subexpression between a comprehension filter clause and its output</span></span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(x):</span>
<span id="cb10-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb10-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb10-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb10-7"></span>
<span id="cb10-8">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb10-9">filtered_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [y <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> data <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> f(x)) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb10-10">filtered_data</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>[4, 16]</code></pre>
</div>
</div>
<p>Unparenthesized assignment expressions are prohibited at the top level of an expression statement.</p>
<p>Keep in mind however, that a more compact code does not always mean better better code. If to write a one-liner, we have to create a convoluted expression, then its not worth it, and we would be better off using a naive approach. This is related to the <em>Keep it simple, stupid</em>(KISS) principle.</p>
<p>Another good reason for using assignment expressions in general is the performance considerations. If we have to use a function as part of our transformation logic, we don’t want to call that more than is necessary. Assigning the result of the function to a temporary identifier is a good optimization technique.</p>
</section>
</section>
<section id="properties-attributes-and-different-types-of-methods-for-objects" class="level2">
<h2 class="anchored" data-anchor-id="properties-attributes-and-different-types-of-methods-for-objects">Properties, attributes and different types of methods for objects</h2>
<p>All of the properties and functions of object are <code>public</code> in Python, which is different from other languages where properties can have the access specifier <code>public</code>, <code>private</code> and <code>protected</code>. That is, there is no point in preventing the caller from invoking any attributes an object has.</p>
<p>There is no strict enforcement, but there are some conventions. An attribute that starts with an underscore is meant to be <code>private</code> to that object, and we expect that no external agent calls it (but again nothing preventing this).</p>
<section id="underscores-in-python" class="level3">
<h3 class="anchored" data-anchor-id="underscores-in-python">Underscores in Python</h3>
<p>There are some conventions and implementation details that make use of underscores in Python, which is an interesting topic in itself that’s worthy of analysis.</p>
<p>Like I mentioned, by default, all attributes of an object in python are <code>public</code>. Consider the following example :</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Point:</span>
<span id="cb12-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x_value, y_value):</span>
<span id="cb12-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._x_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_value</span>
<span id="cb12-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_value</span>
<span id="cb12-5"></span>
<span id="cb12-6">p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Point(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>)</span>
<span id="cb12-7">p1.__dict__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>{'_x_value': 1.0, '_y_value': 2.0}</code></pre>
</div>
</div>
<p>Attributes that start with an underscore must be respected as <code>private</code> and not called externally. Using a single underscore prefix is the Pythonic way of clearly delimiting the interface of the object.</p>
<p>Note that, using too many internal methods and attributes could be a sign that a class has too many tasks and doesn’t comply with the single responsibility princple.</p>
<p>There is however, a common misconception that some attributes and methods can actually be made <code>private</code>. This is again a misconception. Let us imagine that the <code>x_value</code> and <code>y_value</code> attributes are defined with a leading double underscore instead.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Point:</span>
<span id="cb14-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x_value : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, y_value : <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">FloatingPointError</span>):</span>
<span id="cb14-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.__x_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_value</span>
<span id="cb14-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_value</span>
<span id="cb14-5"></span>
<span id="cb14-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> scale(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, scale_factor : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb14-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.__x_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> scale_factor</span>
<span id="cb14-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> scale_factor</span>
<span id="cb14-9"></span>
<span id="cb14-10"></span>
<span id="cb14-11">p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Point(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>)</span>
<span id="cb14-12">p1.scale(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>)</span>
<span id="cb14-13">p1.__x_value</span></code></pre></div>
<p>Output:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb15-1">--------------------------------------------------------------------------</span>
<span id="cb15-2">AttributeError                            Traceback (most recent call last)</span>
<span id="cb15-3">Cell In[7], line 13</span>
<span id="cb15-4">     11 p1 = Point(1.0, 2.0)</span>
<span id="cb15-5">     12 p1.scale(2.0)</span>
<span id="cb15-6">---&gt; 13 p1.__x_value</span>
<span id="cb15-7"></span>
<span id="cb15-8">AttributeError: 'Point' object has no attribute '__x_value'</span></code></pre></div>
<p>Some developers use this method to hide some attributes, thinking that <code>x_value</code> is now <code>private</code> and that no other object can modify it. Now, take a look at the exception that it raised when trying to access <code>__x_value</code>. It’s <code>AttributeError</code> saying that it doesn’t exist. It doesn’t say something like <em>this is private</em>,</p>
<p>What’s actually happening is that with the double underscores, Python creates a different name for the attribute (this is called as name mangling). What it does is create the attribute with the following name instead <code>&lt;class_name&gt;__&lt;attribute_name&gt;</code>. In this case the attribute named <code>Point__x_value</code> will be created.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">p1.__dict__</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'_x_value': 1.0, '_y_value': 2.0}</code></pre>
</div>
</div>
<p>The idea of a double underscore in Python is completely different. It was created as a means to override different methods of a class that is going to be extended several times. Double underscores are a non-Pythonic approach. If you need to defined attributes as <code>private</code>, use a single underscore and respect the Pythonic convention that it is a <code>private</code> attribute.</p>
</section>
<section id="properties" class="level3">
<h3 class="anchored" data-anchor-id="properties">Properties</h3>
<p>Typically, in object-oriented design we create objects to represent an abstraction over an entity of the problem domain. In this sense, objects can encapsulate the behavior or data. And more often than not, the accuracy of the data determines if an object can be created or not. That is to say, entities can exist for certain values of the data only, and incorrect values should not be allowed.</p>
<p>That is, why we create validation methods, typically to be used in <code>setter</code> operations. However, in Python, we can encapsulate the <code>setter</code> and <code>getter</code> methods more compactly using <code>properties</code>.</p>
<p>Consider the example of a geographical system that needs to deal with coordinates. There is only a certain range of values for which the latitude and the longitude make sense. Outside of those values, a coordinate cannot exist.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Coordinate:</span>
<span id="cb18-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, lat: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">long</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb18-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._latitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._longitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb18-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.latitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lat</span>
<span id="cb18-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.longitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">long</span></span>
<span id="cb18-6"></span>
<span id="cb18-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb18-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> latitude(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb18-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._latitude</span>
<span id="cb18-10"></span>
<span id="cb18-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@latitude.setter</span></span>
<span id="cb18-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> latitude(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, lat_value: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb18-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> lat_value <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb18-14">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lat_value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is an invalid value for latitude"</span>)</span>
<span id="cb18-15"></span>
<span id="cb18-16">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._latitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lat_value</span>
<span id="cb18-17"></span>
<span id="cb18-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb18-19">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> longitude(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb18-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._longitude</span>
<span id="cb18-21"></span>
<span id="cb18-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@longitude.setter</span></span>
<span id="cb18-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> longitude(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, long_value:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb18-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> long_value <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb18-25">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lat_value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is an invalid value for longitude"</span>)</span>
<span id="cb18-26"></span>
<span id="cb18-27">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._longitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> long_value</span></code></pre></div>
</div>
</section>
</section>
<section id="using-dataclasses" class="level2">
<h2 class="anchored" data-anchor-id="using-dataclasses">Using <code>dataclasses</code></h2>
<p>A <code>dataclass</code> is a class that exists primarily to store values which are accessible by attribute lookup and not complex logic. There is a common boilerplate when it comes to initialization of such objects, which is to declare in the <code>__init__</code> method all attributes that the object will have, and then set that to internal variables.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Point:</span>
<span id="cb19-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, y:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb19-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x</span>
<span id="cb19-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y</span></code></pre></div>
<p>Since Python 3.7 we can simplify this by using the <code>dataclasses</code> module, which was introduced in <a href="https://peps.python.org/pep-0557/#rationale">PEP-557</a>. We’ll review this module briefly to understand how it helps us write compact code.</p>
<p>The module provides a <code>@dataclass</code> decorator objectr which when applied to a class, it’ll take all the class attributes with annotations and treat them as instance attributes, as if they were declared in the initialization method. When using this method, it will automatically generate the <code>__init__</code> method on the class.</p>
<p>Additionally, this module provides a <code>field</code> object that will help us define particular traits for some of the attributes.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass, field</span>
<span id="cb20-2"></span>
<span id="cb20-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb20-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> VanillaOptionQuote:</span>
<span id="cb20-5">    strike : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb20-6">    spot : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb20-7">    implied_vol : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> </span>
<span id="cb20-8">    underlying : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> </span>
<span id="cb20-9">    time_to_maturity : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> field(default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span></code></pre></div>
</div>
<p>The <code>Field</code> objects describe each field. These objects are created internally and are returned by the <code>fields()</code> module-level method. Users should never instantiate a <code>Field</code> object directly. Its documented attributes are:</p>
<ul>
<li><code>name</code>: Name of the field</li>
<li><code>type</code>: The type of the field</li>
<li><code>default</code>: If provided, this will be th default value for this field.</li>
<li><code>default_factory</code>: If provided, it must be a zero-argument callable that will be called when a default value is needed for this field.</li>
<li><code>init</code>: If <code>true</code>(default), this field is included as a parameter in the generated <code>__init__</code> method.</li>
<li><code>__repr__</code> : If <code>true</code>(default), this field is included in the string returned by <code>__repr__</code> method.</li>
</ul>
<p>A good use-case for dataclass would be all those places when we need to use objects as data-containers or wrappers.</p>
<section id="immutable-dataclass" class="level3">
<h3 class="anchored" data-anchor-id="immutable-dataclass">Immutable <code>dataclass</code></h3>
<p>It is not possible to create truly immutable Python objects. However, by passing <code>frozen=True</code> to the <code>@dataclass</code> decorator you can emulate immutability. In that case, Data Classes will add <code>__setattr__</code> and <code>__delattr__</code> methods to the class. These methods will raise a <code>FrozenInstanceError</code> when invoked.</p>
</section>
<section id="why-not-just-use-attrs" class="level3">
<h3 class="anchored" data-anchor-id="why-not-just-use-attrs">Why not just use <code>attrs</code>?</h3>
<ul>
<li><code>attrs</code> moves faster than could be accomodated if it were moved to the standard library.</li>
<li><code>attrs</code> supports additional features not being proposed here : validators, converters, metadata etc.</li>
</ul>
</section>
</section>
<section id="iterable-objects" class="level2">
<h2 class="anchored" data-anchor-id="iterable-objects">Iterable objects</h2>
<p>In python, we have objects that can be iterated by default. For example, lists, sets, tuples and dictionaries can not only hold data in the structure, but also be iterated over a <code>for</code> loop to get those values repeatedly.</p>
<p>However, the built-in <code>iterable</code> objects are not the only kind we can have in a <code>for</code> loop. We can also create our own iterable, with the logic we define for iteration.</p>
<p>In order to achieve this, we rely again on magic methods. Iteration works in Python by its own protocol(namely the <code>iterator</code> protocol). When you try to iterate an object in the form <code>for e in my_collection:...</code>, at a high-level, Python checks for:</p>
<ul>
<li>If the object contains one of the iterator methods - <code>__next__</code> or <code>__iter__</code>.</li>
<li>If the object is a sequence and has <code>__len__</code> and <code>__get_item__</code></li>
</ul>
<section id="creating-iterable-objects" class="level3">
<h3 class="anchored" data-anchor-id="creating-iterable-objects">Creating iterable objects</h3>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> timedelta</span>
<span id="cb21-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dt</span>
<span id="cb21-3"></span>
<span id="cb21-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DateRange:</span>
<span id="cb21-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""An iterable that contains its own iterator object."""</span></span>
<span id="cb21-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, start_date: dt.date, end_date: dt.date):</span>
<span id="cb21-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._start_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_date</span>
<span id="cb21-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._end_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> end_date</span>
<span id="cb21-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._present_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_date</span>
<span id="cb21-10"></span>
<span id="cb21-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__iter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb21-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb21-13"></span>
<span id="cb21-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__next__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb21-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._present_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._end_date:</span>
<span id="cb21-16">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">StopIteration</span>()</span>
<span id="cb21-17"></span>
<span id="cb21-18">        today <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._present_date</span>
<span id="cb21-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._present_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> today</span>
<span id="cb21-21"></span>
<span id="cb21-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> day <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> DateRange(dt.date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2026</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), dt.date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2026</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)):</span>
<span id="cb21-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>day<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)        </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2026-01-01
2026-01-02
2026-01-03
2026-01-04
2026-01-05
2026-01-06
2026-01-07</code></pre>
</div>
</div>
</section>
<section id="the-basic-mechanics" class="level3">
<h3 class="anchored" data-anchor-id="the-basic-mechanics">The basic mechanics</h3>
<p>Here, the <code>for</code> loop starts a new iteration over our object. At this point Python will call the <code>iter()</code> function on it, which in turn will call the <code>__iter__</code> magic method. On this method, it is decided to return <code>self</code>, indicating that the object is an <code>iterable</code> itself. Every step of the loop calls the <code>next()</code> function on this object, which delegates to <code>__next__</code> method. When there is nothing else to produce, we have to signal this to Python by raising <code>StopIteration</code> exception.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1">r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DateRange(dt.date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2026</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), dt.date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2026</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(r))</span>
<span id="cb23-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(r))</span>
<span id="cb23-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(r))</span>
<span id="cb23-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(r))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2026-01-01
2026-01-02
2026-01-03
2026-01-04</code></pre>
</div>
</div>
<p>This example works, but it has a small problem - once exhausted, the <code>iterable</code> will continue to be empty, hence raising <code>StopIteration</code>.</p>
<p>If there are two or more consecutive <code>for</code> loops, only the first one will work, while the second one will remain empty. Because, there is only one shared iteration state. We should separate out the iterator from the iterable.</p>
</section>
</section>
<section id="creating-sequences" class="level2">
<h2 class="anchored" data-anchor-id="creating-sequences">Creating sequences</h2>
<p>Maybe our object does not define the <code>__iter__()</code> method, but we still want to be able to iterate over it. If <code>__iter__</code> is not defined on the object, the <code>iter()</code> function will look for the presence of <code>__getitem__</code>, and if this is not found, it will raise <code>TypeError</code>.</p>
<p>A sequence is an object that implements <code>__len__</code> and <code>__getitem__</code> magic methods and expects to be able to get the elements it contains, one at a time, in order, starting at <img src="https://latex.codecogs.com/png.latex?0"> as the first index. This means that you should be careful in the logic so that you correctly implement <code>__get_item__</code> to expect this type of index, or the iteration will not work.</p>
<p>The example from the previous section had the advantage that it uses less memory. This means that it is only holding one date at a time and knows how to produce the days one by one. However, it has the drawback that if we want to get to the <code>n</code>th element, we have no way to do so but iterate <img src="https://latex.codecogs.com/png.latex?n"> times. until we reach it. This is a typical trade-off in CS between memory and CPU usage.</p>
<p>The implementation with an <code>iterable</code> will use memory, but take <img src="https://latex.codecogs.com/png.latex?O(n)"> time, whereas implementing a sequence will use more(because we have to hold everything at once),but supports indexing in constant time.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DateRangeSequence:</span>
<span id="cb25-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, start_date : dt.date, end_date:dt.date):</span>
<span id="cb25-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._start_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_date</span>
<span id="cb25-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._end_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> end_date</span>
<span id="cb25-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._create_range()</span>
<span id="cb25-6"></span>
<span id="cb25-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _create_range(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb25-8">        days <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb25-9">        current_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._start_date</span>
<span id="cb25-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> current_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._end_date:</span>
<span id="cb25-11">            days.append(current_date)</span>
<span id="cb25-12">            current_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-13"></span>
<span id="cb25-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> days</span>
<span id="cb25-15">    </span>
<span id="cb25-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__getitem__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, day_idx):</span>
<span id="cb25-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._range[day_idx]</span>
<span id="cb25-18"></span>
<span id="cb25-19">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__len__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb25-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._range)</span>
<span id="cb25-21"></span>
<span id="cb25-22">s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DateRangeSequence(dt.date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2026</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), dt.date(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2026</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb25-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> day <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> s1:</span>
<span id="cb25-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(day)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2026-01-01
2026-01-02
2026-01-03
2026-01-04
2026-01-05</code></pre>
</div>
</div>
</section>
<section id="container-objects" class="level2">
<h2 class="anchored" data-anchor-id="container-objects">Container objects</h2>
<p>Containers are objects that implement a <code>__contains__</code> method(that usually returns a <code>boolean</code> value). This method is called in the presence of the python keyword <code>in</code>.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dataclasses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dataclass</span>
<span id="cb27-2"></span>
<span id="cb27-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dataclass</span></span>
<span id="cb27-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Interval:</span>
<span id="cb27-5">    left_end_point : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> </span>
<span id="cb27-6">    right_end_point : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb27-7">    exclude_right_end : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb27-8"></span>
<span id="cb27-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__contains__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x_value : <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb27-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.exclude_right_end:</span>
<span id="cb27-11">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.left_end_point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> x_value <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> x_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.right_end_point </span>
<span id="cb27-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb27-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.left_end_point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> x_value <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> x_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.right_end_point </span>
<span id="cb27-14"></span>
<span id="cb27-15">interval <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Interval(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb27-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Is 0.5 contained in the interval [0,1) : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> interval<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb27-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Is 1.0 contained in the interval [0,1) : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> interval<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Is 0.5 contained in the interval [0,1) : True
Is 1.0 contained in the interval [0,1) : False</code></pre>
</div>
</div>
</section>
<section id="dynamic-attributes" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-attributes">Dynamic attributes</h2>
<p>It is possible to control the way attributes are obtained from objects by means of the <code>__getattr__</code> magic method. When we call something like <code>&lt;my_object&gt;.&lt;my_attribute&gt;</code>, Python will look at <code>&lt;my_attribute&gt;</code> in the dictionary of the object, calling <code>__get_attribute__</code>. If this is not found (that is, the object does not have the attribute we are looking for), then the extra method <code>__getattr__</code> is called, passing in the name of the attribute as a parameter.</p>
<p>By receiving this value, we can control the way things should be returned to our objects. We can even create new attributes on the fly.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DynamicAttributes:</span>
<span id="cb29-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, attribute):</span>
<span id="cb29-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attribute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attribute</span>
<span id="cb29-4">    </span>
<span id="cb29-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__getattr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, attr):</span>
<span id="cb29-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> attr.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fallback_"</span>):</span>
<span id="cb29-7">            name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attr.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fallback_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb29-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[fallback resolved] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb29-9">    </span>
<span id="cb29-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">AttributeError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>__class__<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> has no attribute </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>attr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</div>
</section>
<section id="callable-objects" class="level2">
<h2 class="anchored" data-anchor-id="callable-objects">Callable objects</h2>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> defaultdict</span>
<span id="cb30-2"></span>
<span id="cb30-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> CallCount:</span>
<span id="cb30-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb30-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb30-6"></span>
<span id="cb30-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, argument):</span>
<span id="cb30-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._counts[argument] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb30-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._counts[argument]</span>
<span id="cb30-10"></span>
<span id="cb30-11">call_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CallCount()</span>
<span id="cb30-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(call_count(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span>))</span>
<span id="cb30-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(call_count(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"World"</span>))</span>
<span id="cb30-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(call_count(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1
1
2</code></pre>
</div>
</div>
</section>
<section id="python-collections.abc-module" class="level2">
<h2 class="anchored" data-anchor-id="python-collections.abc-module">Python <code>collections.abc</code> module</h2>
<p>The best way to implement these methods is to declare our class to inherit from the corresponding class defined in the <code>collections.abc</code> module.</p>
<p>These interfaces provide the methods that need to be implemented, so it’ll make it easier for you to define the class correctly.</p>
<p>With practice and experience, you become more fluent with these features of Python, until it becomes second nature for you wrap the logic you’re writing behind abstractions with nice and small interfaces. Give it enough time, and you’ll naturally think of having small, clean interfaces in your programs.</p>
</section>
<section id="caveats" class="level2">
<h2 class="anchored" data-anchor-id="caveats">Caveats</h2>
<section id="mutable-default-arguments" class="level3">
<h3 class="anchored" data-anchor-id="mutable-default-arguments">Mutable default arguments</h3>
<p>Don’t use mutable objects as the default arguments of functions.</p>


</section>
</section>
</section>

 ]]></description>
  <category>Python</category>
  <guid>http://quantdev.blog/posts/pythonic_code/index.html</guid>
  <pubDate>Fri, 21 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/pythonic_code/python.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Creating a tiny C++ Task Library</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/exploring_futures_and_promises/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>A <strong>future</strong> is an object that represents some undetermined result of a task that will be completed sometime in the future. A <strong>promise</strong> is the provider of that result.</p>
<p>The <code>std::promise</code> and <code>std::future</code> pair implements a one-short producer-consumer channel with the promise as the producer and the future as the consumer. The consumer (<code>std::future</code>) can can block until the result of the producer (<code>std::promise</code>) is available.</p>
<p>Many modern programming languages provide similar asynchronous approaches, such as Python(with the <code>asyncio</code> library), Scala(in the <code>scala.concurrent</code> library), Rust(in its standard library <code>std</code> or crates such as <code>promising_future</code>).</p>
<p>The basic principle behind achieving asynchronous execution using promises and futures is that a function we want to run to generate a result is executed in the background, using a new thread or the current one, and a future object is used by the initial thread to retrieve the result computed by the function. This result value will be stored when the function finishes, so meanwhile, the future acts as a placeholder. The asynchronous function will use a promise object to store the result in the future with no need for explicit synchronization mechanisms between the initial thread and the background one. When the value is needed by the initial thread, it will be retrieved from the future object. If the value is still not ready, the initial thread of execution will be blocked until the future becomes ready.</p>
<p>Using promises and futures improves responsiveness by offloading computations and provides a structured approach to handling asynchronous operations compared to threads and callbacks.</p>
<section id="the-basic-mechanics" class="level2">
<h2 class="anchored" data-anchor-id="the-basic-mechanics">The Basic Mechanics</h2>
<section id="promises" class="level3">
<h3 class="anchored" data-anchor-id="promises">Promises</h3>
<p>A promise holds a shared state. The shared state is a memory area that stores the completion status, synchronization mechanisms, and a pointer to the result. It ensures proper communication and synchronization between a promise and a future by enabling the promise to store either a result or an exception, signal when it’s complete and allowing the future to access the result, blocking if the promise is not yet ready. The promise can update its shared state using the following operations:</p>
<ul>
<li><p><strong>Make ready</strong>. The promise stores the result in the shared state and makes the state of the promise to become ready unblocking any thread waiting on a future associated with the promise.</p></li>
<li><p><strong>Release</strong>. The promise releases its reference to the shared state, which will be destroyed if this is the last reference.</p></li>
<li><p><strong>Abandon</strong>. The promise stores an exception of type <code>std::future_error</code> with error code <code>std::future_errc::broken_promise</code> making the shared state ready and then releasing it.</p></li>
</ul>
<p>The value of a promise can be set using the <code>std::promise</code> function <code>set_value()</code> and an exception by using the <code>set_exception()</code> function. The result is stored atomically in the promise’s shared state, making its state ready. Let’s see an example:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Ref: Asynchronous programming with C++</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//Javier Reguara Salgado</span></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> threadFunc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> prom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-6">        prom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-8">        prom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set_exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> prom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>jthread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>thread_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>prom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span></code></pre></div>
<p><code>set_value()</code> can throw a <code>std::future_error</code> exception if the promise has no shared state (error code set to <code>no_state</code>) or the shared state has already a storedd result.</p>
<p><code>set_value()</code> can also be used without specifying a value. In that case, it simply makes the state ready. That can be used as a barrier, as we will see later in this blog post.</p>
</section>
<section id="futures" class="level3">
<h3 class="anchored" data-anchor-id="futures">Futures</h3>
<p>Futures are defined in the <code>&lt;future&gt;</code> header file as <code>std::future</code>.</p>
<p>As we saw earlier, a future is the consumer side of the communication channel. It provides access to the result stored by the promise.</p>
<p>A <code>std::future</code> object must be created from <code>std::promise</code> object by calling <code>get_future()</code> or through a <code>std::packaged_task</code> object or a call to the <code>std::async</code> function.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> prom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>future<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> fut <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_future<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span></code></pre></div>
<p>Like promises, futures can be moved but not copied for the smae reasons. To reference the same shared state from multiple futures, we need to use shared futures.</p>
<p>The <code>get()</code> method can be used to retrieve the result. If the shared state is still not ready, this call will block internally calling <code>wait()</code>. When the shared state becomes ready, the result value is returned. If an exceptionwas sttored in the shared state, that exception will be retrhrown:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb3-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Result from thread:"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb3-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cerr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exception : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>After calling the <code>get()</code> method, <code>valid()</code> will return <code>false</code>. If for some reason <code>get()</code> is called when <code>valid()</code> is <code>false</code>, the behavior is undefined, but the C++ standard recommends that a <code>std::future_error</code> exception is thrown with the <code>std::future_errc::no_state</code> error code.</p>
<p>When a future is destroyed, it releases it shared state reference. If that were the last reference, the shared state would be destroyed.</p>
</section>
</section>
<section id="a-quick-working-example" class="level2">
<h2 class="anchored" data-anchor-id="a-quick-working-example">A quick working example</h2>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb4-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;chrono&gt;</span></span>
<span id="cb4-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;future&gt;</span></span>
<span id="cb4-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;thread&gt;</span></span>
<span id="cb4-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb4-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>chrono_literals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb4-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> user_list_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> orders_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-13"></span>
<span id="cb4-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> fetch_users_ready <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> user_list_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_future<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> fetch_orders_ready <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> orders_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_future<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-16"></span>
<span id="cb4-17">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>jthread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>user_list_thread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([&amp;](){</span></span>
<span id="cb4-18">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> userList<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb4-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-20">            userList<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-21">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>this_thread<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">::</span>sleep_for<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>chrono<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">::</span>milliseconds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb4-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-23">        user_list_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>userList<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb4-25"></span>
<span id="cb4-26">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>jthread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>orders_thread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([&amp;](){</span></span>
<span id="cb4-27">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> orders<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb4-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-29">            orders<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-30">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>this_thread<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">::</span>sleep_for<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>chrono<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">::</span>milliseconds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb4-31">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-32">        orders_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>orders<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-33">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb4-34"></span>
<span id="cb4-35">    fetch_users_ready<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>wait<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-36">    fetch_orders_ready<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>wait<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-37"></span>
<span id="cb4-38">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_users_ready<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-39">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> orders <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_orders_ready<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-40"></span>
<span id="cb4-41">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Users = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> users<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-42">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Orders = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> orders<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-43">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-44"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/EqYY6MxaT">Compiler Explorer</a></p>
</section>
<section id="shared-futures" class="level2">
<h2 class="anchored" data-anchor-id="shared-futures">Shared Futures</h2>
<p>As we saw earlier, <code>std::future</code> is only moveable, thus only one future object can refer to a particular asynchronous result. On the other hand, <code>std::shared_future</code> is copyable, so several shared future objects can refer to the same shared state.</p>
<p>There, <code>std::shared_future</code> allows thread-safe access from different threads to the same shared state. Shared futures can be useful for sharing the result of a computationally intensive task among multiple consumers or interested parties, reducing computation. Also, they can be used to notify events or as a synchronization mechanism where multiple threads must wait for the completion of a single task. The interface of <code>std::shared_object</code> is the same as the one for <code>std::future</code>. A <code>shared_future</code> object is created using the <code>.share()</code> function on the future.</p>
</section>
<section id="creating-a-tiny-c-task-library" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-tiny-c-task-library">Creating a tiny C++ task library</h2>
<p>Promises and futures can be chained together to perform multiple asynchronous operations sequentially. We can have elaborate data-processing pipelines where one future’s result becoimes the input for the next operation’s promise. This allows for composing complex asynchronous workflows where the output of one task feeds into the next.</p>
<p>Also, we can allow branching in the pipeline and keep some tasks switched off until needed. This can be done using futures with deferred execution.</p>
<p>Generally speaking tasks make up a DAG(Directed acyclic graph). Thus, a task library must consist of two parts : an API to specify the task DAG and a scheduler that actually executes the DAG.</p>
<p>Let’s try to create the following task graph:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">graph LR
  Task-1[Task-1] --&gt; Task-2[Task-2]
  Task-2 --&gt; Task-3[Task-3]
  Task-2 --&gt; Task-4[Task-4]
  Task-3 --&gt; Aggregate[Aggregate results]
  Task-4 --&gt; Aggregate
</pre>
</div>
</div>
</div>
</div>
<p>We start by defining a template class called <code>Task</code> that accepts a callable as a template argument, defining the function to execute. This class will also allow us to create tasks that share a future with dependent ones.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb5-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdint&gt;</span></span>
<span id="cb5-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define sync_cout </span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>osyncstream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> GraphWalker<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb5-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-11"></span>
<span id="cb5-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb5-13">    Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-17">        sync_cout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-18">                  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" constructed "</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-20"></span>
<span id="cb5-21">    Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb5-25"></span>
<span id="cb5-26">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint64_t</span> get_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb5-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-29"></span>
<span id="cb5-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb5-31">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u64_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-32">    Func <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-33">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_promise</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-34"></span>
<span id="cb5-35"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-36"></span>
<span id="cb5-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-38">    Task task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-39">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;</span> child_nodes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-40"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/exploring_futures_and_promises/index.html</guid>
  <pubDate>Tue, 18 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/exploring_futures_and_promises/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>A crash course in Rust - I</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/rust_crash_course_I/index.html</link>
  <description><![CDATA[ 




<section id="a-crash-course-in-rust---i" class="level1">
<h1>A crash course in Rust - I</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>I have been working through the excellent <a href="https://rust-unofficial.github.io/too-many-lists/">Learn Rust With Entirely Too Many Linked Lists</a> and I summarize my learnings about Rust language features and code snippets I tried here.</p>
</section>
<section id="designing-a-basic-linked-list" class="level2">
<h2 class="anchored" data-anchor-id="designing-a-basic-linked-list">Designing a basic linked list</h2>
<p>A linked list is a data-structure consisting of a collection of nodes which together form a sequence. In its most basic form, each node contains data and a reference (pointer or link) to the next node in the sequence. Consider defining a <code>List</code> as follows:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">enum</span> List<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    Empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-3">    Element(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> List)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> main()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span></code></pre></div>
<p>Let’s go ahead and compile that.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">[quantdev@quasar-arch ownership]$ rustc first.rs -o first.out</span>
<span id="cb2-2">error[E0072]: recursive type `List` has infinite size</span>
<span id="cb2-3"> --&gt; first.rs:1:1</span>
<span id="cb2-4">  |</span>
<span id="cb2-5">1 | pub enum List{</span>
<span id="cb2-6">  | ^^^^^^^^^^^^^</span>
<span id="cb2-7">2 |     Empty,</span>
<span id="cb2-8">3 |     Element(i32, List),</span>
<span id="cb2-9">  |                  ---- recursive without indirection</span>
<span id="cb2-10">  |</span>
<span id="cb2-11">help: insert some indirection (e.g., a `Box`, `Rc`, or `&amp;`) to break the cycle                ---- recursive without indirection</span></code></pre></div>
<p>If we actually checkout the error message, we can see that <code>rustc</code> is actually telling us exactly how to solve this problem.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb3-1">help: insert some indirection (e.g., a `Box`, `Rc`, or `&amp;`) to break the cycle                ---- recursive without indirection</span></code></pre></div>
<p>Alright, <code>Box</code>. What’s that? Let’s google <code>rust box</code>. <a href="https://doc.rust-lang.org/std/boxed/struct.Box.html"></a> module documentation states that <code>Box&lt;T&gt;</code> casually referred to as a ‘box’, provides the simplest form of heap allocation in Rust. Boxes provide ownership for this allocation, and drop their contents when they go out of scope.</p>
<section id="examples" class="level3">
<h3 class="anchored" data-anchor-id="examples">Examples</h3>
<p>Move a value from a stack to the heap by creating a <code>Box</code>:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> boxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new(val)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>Moving a value from a <code>Box</code> back to the stack by dereferencing it:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> boxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>boxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>Creating a recursive data-structure</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource rust number-lines code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>derive<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Debug</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb6-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">enum</span> List<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-3">    Empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-4">    Element(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>List<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> main()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> List <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">List::</span>Element(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">List::</span>Element(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">List::</span>Empty))))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-9">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{list:?}"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>If I compile and run this code, it gives me:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb7-1">[quantdev@quasar-arch ownership]$ rustc first.rs -o first.out</span>
<span id="cb7-2">[quantdev@quasar-arch ownership]$ ./first.out</span>
<span id="cb7-3">Element(1, Element(2, Empty))</span></code></pre></div>
<p>Recursive data-structures must be boxed, because if the definition of <code>List</code> looked like this:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1">Element(T, List)</span></code></pre></div>
<p>it wouldn’t work.</p>


</section>
</section>
</section>

 ]]></description>
  <category>Rust</category>
  <guid>http://quantdev.blog/posts/rust_crash_course_I/index.html</guid>
  <pubDate>Mon, 17 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/rust_crash_course_I/Rust-4.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Memory Barriers</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/memory_barriers/index.html</link>
  <description><![CDATA[ 




<section id="c-atomics" class="level1">
<h1>C++ Atomics</h1>
<section id="introduction-to-atomic-operations" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-atomic-operations">Introduction to Atomic Operations</h2>
<p>Atomic operations are indivisible. An atomic operation is any operation that is <strong>guaranteed to execute as a single transaction</strong>. At a low-level, atomic operations are special hardware instructions.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext itikz</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The itikz extension is already loaded. To reload it, use:
  %reload_ext itikz</code></pre>
</div>
</div>
<p>Consider a shared variable <code>counter</code> initialized to <code>0</code>. The assembly instructions for incrementing this counter show that it requires multiple CPU instructions: load the value from memory into a register, add 1 to the register, and store the result back to memory. This multi-step process creates opportunities for race conditions in multi-threaded code.</p>
<p>Using atomic types and operations solves this problem by using special CPU instructions like <code>lock add</code> that guarantee the entire operation completes as a single, indivisible unit.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Incrementing a counter        </span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> counter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb3-5">    counter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb3-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="generated-assembly---non-atomic" class="level2">
<h2 class="anchored" data-anchor-id="generated-assembly---non-atomic">Generated Assembly - Non-Atomic</h2>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">counter:</span></span>
<span id="cb4-2">        .zero   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">main:</span></span>
<span id="cb4-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">push</span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">rbp</span></span>
<span id="cb4-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">mov</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">rbp</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">rsp</span></span>
<span id="cb4-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">mov</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">eax</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DWORD</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PTR</span> counter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>rip<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb4-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">add</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">eax</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">mov</span>     <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DWORD</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PTR</span> counter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>rip<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">eax</span></span>
<span id="cb4-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">mov</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">eax</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb4-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">pop</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">rbp</span></span>
<span id="cb4-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">ret</span></span></code></pre></div>
</section>
<section id="atomic-increment" class="level2">
<h2 class="anchored" data-anchor-id="atomic-increment">Atomic Increment</h2>
<p>Using atomic types and operations:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;atomic&gt;</span></span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> counter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb5-5">    counter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span></span>
<span id="cb5-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><strong>Generated Assembly:</strong></p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb6-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">lock</span> add <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DWORD</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PTR</span> counter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>rip<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span></code></pre></div>
<p>Atomic operations allow threads to read, modify and write indivisibly and can also be used as synchronization primitives. Atomic operations must be provided by the CPU (as in the <code>lock add</code> instruction).</p>
</section>
<section id="operations-on-stdatomict" class="level2">
<h2 class="anchored" data-anchor-id="operations-on-stdatomict">Operations on <code>std::atomic&lt;T&gt;</code></h2>
<p><strong>Explicit reads and writes:</strong></p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-2">T y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Same as T y = x;</span></span>
<span id="cb7-3">x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Same as x = y;</span></span></code></pre></div>
<p><strong>Atomic exchange:</strong></p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1">T z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Atomically: z = x; x = y;</span></span></code></pre></div>
<p><code>exchange</code> is an atomic swap - a read-modify-write done atomically. It reads the old value, replaces it with the new value and guarantees that nobody can get in there in between.</p>
</section>
<section id="compare-and-swap-cas" class="level2">
<h2 class="anchored" data-anchor-id="compare-and-swap-cas">Compare-and-Swap (CAS)</h2>
<p><strong>Compare-and-swap (conditional exchange):</strong></p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> success <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>compare_exchange_strong<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// T&amp; y</span></span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// var.compare_exchange_strong(expected,desired);</span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If x == y, x = z and return true</span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Otherwise, set y = x and return false</span></span></code></pre></div>
</section>
<section id="why-is-cas-so-special" class="level2">
<h2 class="anchored" data-anchor-id="why-is-cas-so-special">Why is CAS So Special?</h2>
<p>Compare-and-swap (CAS) is used in most lock-free algorithms. Consider this example of atomic increment with CAS. Pretty much every lock-free algorithm is centered around a loop like this. We want to increment <code>x</code>. First, we read the atomic value and store it in a local <code>x0</code>. We hope nobody got to <code>x</code> before us, that <code>x</code> hasn’t changed. If that’s <code>true</code>, we change it atomically to the desired value (which could be an increment, decrement, multiplication by 2, etc.). If nobody else changed <code>x</code>, we did our increment atomically. CAS returns <code>true</code> and the loop ends.</p>
<p>If somebody did change <code>x</code>, CAS fails and returns <code>false</code>. The changed value of <code>x</code> is updated in <code>x0</code>, so we don’t have to read again. We continue to the next iteration and keep trying, until our compare-and-swap beats everyone else’s and gets that increment in.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [1] </span></span>
<span id="cb10-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>compare_exchange_swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)){}</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [2]</span></span></code></pre></div>
</section>
<section id="additional-atomic-operations" class="level2">
<h2 class="anchored" data-anchor-id="additional-atomic-operations">Additional Atomic Operations</h2>
<p><strong>For integer T:</strong></p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-2">x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>fetch_add<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Same as x += y;</span></span></code></pre></div>
<p><code>fetch_add()</code> doesn’t just add atomically. It increments atomically, but also returns the old value (the fetch part). So it returns the old value and adds the increment, all atomically.</p>
<p>Also available: <code>fetch_sub</code>, <code>fetch_and()</code>, <code>fetch_or()</code> and <code>fetch_xor()</code>.</p>
<p><strong>Note:</strong> If you have multiple atomic operations, their composition is not atomic.</p>
</section>
<section id="do-atomic-operations-wait-on-each-other" class="level2">
<h2 class="anchored" data-anchor-id="do-atomic-operations-wait-on-each-other">Do Atomic Operations wait on Each Other?</h2>
<p>Atomic operations are lock-free, maybe even wait-free. It doesn’t mean they don’t wait on each other. Atomic operations do wait for cache-line access.</p>
<div class="text-center">
<div class="cell" data-execution_count="2">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb12-2"></span>
<span id="cb12-3">\tikzset{every picture<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>.style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> default line width to <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>        </span>
<span id="cb12-4"></span>
<span id="cb12-5">\begin{tikzpicture}[x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>,y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\Large]</span>
<span id="cb12-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>uncomment <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> require: \path (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">249</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> diagram left start at <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> has height of <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">249</span></span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp7226624209327404] </span>
<span id="cb12-9">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">115</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">43.47</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">115</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">33.82</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">122.82</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">132.47</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">505.03</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">514.68</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">522.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">33.82</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">522.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">43.47</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">522.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">95.88</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">522.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">105.52</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">514.68</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">113.34</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">505.03</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">113.34</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">132.47</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">113.34</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">122.82</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">113.34</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">115</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">105.52</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">115</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">95.88</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp404929071772297] </span>
<span id="cb12-11">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">113</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">158.47</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">113</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.82</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">120.82</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">141</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">130.47</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">141</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">503.03</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">141</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">512.68</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">141</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">520.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.82</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">520.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">158.47</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">520.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.88</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">520.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">220.52</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">512.68</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">228.34</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">503.03</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">228.34</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">130.47</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">228.34</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">120.82</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">228.34</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">113</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">220.52</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">113</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.88</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp8165659276958122] </span>
<span id="cb12-13">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">247</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">204</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">151</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">62</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">151</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">57.58</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">154.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">159</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">300.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">304.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">308.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">57.58</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">308.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">62</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">308.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">86</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">308.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">90.42</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">304.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">94</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">300.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">94</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">159</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">94</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">154.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">94</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">151</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">90.42</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">151</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">86</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp5545605907049965] </span>
<span id="cb12-15">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">247</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">204</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">325</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">61</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">325</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">56.58</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">328.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">53</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">333</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">53</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">474.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">53</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">478.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">53</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">482.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">56.58</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">482.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">61</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">482.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">85</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">482.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">89.42</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">478.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">93</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">474.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">93</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">333</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">93</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">328.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">93</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">325</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">89.42</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">325</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">85</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp9918614693760329] </span>
<span id="cb12-17">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">247</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">204</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">176</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">171.58</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">147.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">152</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">293.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">297.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">171.58</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">176</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">204.42</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">297.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">293.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">152</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">147.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">204.42</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp9032232500910276] </span>
<span id="cb12-19">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">247</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">204</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">332</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">176</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">332</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">171.58</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">335.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">340</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">481.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">485.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">489.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">171.58</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">489.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">176</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">489.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">489.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">204.42</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">485.92</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">481.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">340</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">335.58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">332</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">204.42</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">332</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-20"></span>
<span id="cb12-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-22">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">263</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]   [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\texttt{std::atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-24">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">257</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">146</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]   [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\texttt{std::atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-25"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-26">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">231.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">63.33</span>) node {Thread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-27"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-28">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">410</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) node {Thread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-29"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-30">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">221.33</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>) node {Thread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-32">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">414</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>) node {Thread<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-34">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">231.71</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">82</span>) node {<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-35"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-36">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">410.38</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80.67</span>) node {<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-37"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-38">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">228.08</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">198</span>) node {<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-39"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-40">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">419.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">196.67</span>) node {<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-41"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-42">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">214.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">13.33</span>) node {Accessing shared variable}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-43"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb12-44">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">127.33</span>) node {Accessing Non<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>shared variable}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-45"></span>
<span id="cb12-46"></span>
<span id="cb12-47">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="http://quantdev.blog/posts/memory_barriers/index_files/figure-html/cell-3-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>Fig. Functions - control flow</p>
</div>
<p>Let’s compare atomic increment of an atomic variable versus increment two atomic variables that are different. That is, the worker thread <img src="https://latex.codecogs.com/png.latex?t0"> works on an atomic variable <code>x[0]</code> and the worker thread <img src="https://latex.codecogs.com/png.latex?t1"> works on the atomic variable <code>x[1]</code>. That way, they don’t have to wait on each other. Let’s run a benchmark for different number of threads. Let’s run the benchmark for different number of threads. It’s basically the same thing - we see no difference between the two. Can we conclude that atomic operations don’t wait on each other from this?</p>
<div class="text-center">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/memory_barriers/memory_barriers_01.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Two threads incrementing a shared variable atomically vs two threads work on different atomic variables</figcaption>
</figure>
</div>
</div>
<pre><code>Benchmark                                        Time         CPU
------------------------------------------------------------------------
BM_SharedAtomicIncrement/1/real_time         0.558 ms    0.015 ms
BM_SharedAtomicIncrement/2/real_time          2.56 ms    0.044 ms
BM_SharedAtomicIncrement/4/real_time          5.40 ms    0.096 ms
BM_SharedAtomicIncrement/8/real_time          10.6 ms    0.218 ms
BM_SharedAtomicIncrement/16/real_time         22.9 ms    0.401 ms
BM_SharedAtomicIncrement/32/real_time         48.4 ms     1.14 ms
BM_SeparateAtomicIncrement/1/real_time       0.556 ms    0.016 ms
BM_SeparateAtomicIncrement/2/real_time        2.74 ms    0.033 ms
BM_SeparateAtomicIncrement/4/real_time        5.74 ms    0.081 ms
BM_SeparateAtomicIncrement/8/real_time        11.2 ms    0.244 ms
BM_SeparateAtomicIncrement/16/real_time       23.9 ms    0.403 ms
BM_SeparateAtomicIncrement/32/real_time       26.6 ms     1.23 ms</code></pre>
<section id="whats-really-going-on" class="level3">
<h3 class="anchored" data-anchor-id="whats-really-going-on">What’s really going on?</h3>
<p>Can we conclude that atomic operations don’t wait on each other? Not necessarily!</p>
<p>It is highly likely, that data elements in relatively close memory locations are accessed over a short period of time. This is typical, for example, when traversing an array, or performing matrix multiplication. To optimize performance, a chunk of data called the cache line trickles up and down through the cache from the main memory to the CPU and back, instead of just the request data-item. On x86, the cache line size is <img src="https://latex.codecogs.com/png.latex?64">-bytes.</p>
<p>What’s actually happening is that the two atomic operations are in the same cache-line. On x86, the whole cache line trickles up and down from main memory to the on-board CPU cache and back. Even if you want one variable from the cache line, the entire 64-byte chunk will go up and down. If two different CPUs want two different variables within the same cache-line, they need to wait, as if it was the same variable. You don’t get lower granularity than 64-bytes on x86.</p>
<div class="text-center">
<div class="cell" data-execution_count="3">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb14-2">\tikzset{every picture<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>.style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> default line width to <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>        </span>
<span id="cb14-3"></span>
<span id="cb14-4">\begin{tikzpicture}[x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>,y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>,xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>,font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\Large]</span>
<span id="cb14-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>uncomment <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> require: \path (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">379</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> diagram left start at <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> has height of <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">379</span></span>
<span id="cb14-6"></span>
<span id="cb14-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp27460933128570264] </span>
<span id="cb14-8">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">38.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">45.45</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">38.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">39.13</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">43.63</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">49.95</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">296.05</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">302.37</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">307.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">39.13</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">307.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">45.45</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">307.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.8</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">307.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">86.12</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">302.37</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">296.05</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">49.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">43.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">38.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">86.12</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">38.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.8</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp6820620708533545] </span>
<span id="cb14-10">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">335</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">127.87</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">335</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">124.63</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">337.63</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">340.87</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">586.63</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">589.87</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">124.63</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">127.87</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">145.48</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.72</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">589.87</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">586.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">340.87</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">337.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">335</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.72</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">335</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">145.48</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp9973874025957986] </span>
<span id="cb14-12">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">127.87</span>) .. controls (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">124.63</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">46.63</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">49.87</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">295.63</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">298.87</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">122</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">124.63</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">127.87</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">145.48</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">301.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.72</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">298.87</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">295.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">49.87</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">46.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.34</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.72</span>) .. (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">145.48</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp9732688461749553] </span>
<span id="cb14-14">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">252</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">246</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">153</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">46.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">309.12</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">46.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">303.9</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.56</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.67</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">55.78</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.67</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">586.38</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.67</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">591.6</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.67</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">595.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">303.9</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">595.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">309.12</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">595.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">337.47</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">595.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">342.69</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">591.6</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">346.92</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">586.38</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">346.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">55.78</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">346.92</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.56</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">346.92</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">46.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">342.69</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">46.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">337.47</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da9504358299662848] </span>
<span id="cb14-16">\draw    (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">276.08</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">339.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">383.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">339.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-17">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">386.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">339.92</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> }  ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-18">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">273.08</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">339.92</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> }  ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp1128018396464796] </span>
<span id="cb14-20">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">329.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">45.45</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">329.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">39.13</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">334.63</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">340.95</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">587.05</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">593.37</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">598.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">39.13</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">598.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">45.45</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">598.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.8</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">598.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">86.12</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">593.37</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">587.05</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">340.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">334.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">329.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">86.12</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">329.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.8</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da8059041144370804] </span>
<span id="cb14-22">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">378.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">154.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">378.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">182.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-23">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">378.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.25</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp591399533303866] </span>
<span id="cb14-25">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">335.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">189.2</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">335.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.96</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">338.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">341.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">587.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">590.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">593.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.96</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">593.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">189.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">593.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">206.81</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">593.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.05</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">590.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">587.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">341.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">338.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">335.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.05</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">335.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">206.81</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp5591689579874568] </span>
<span id="cb14-27">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">189.2</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.96</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">47.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">296.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.33</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">302.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.96</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">302.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">189.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">302.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">206.81</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">302.17</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.05</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">296.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">47.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.68</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.05</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">206.81</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-28"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Rounded Rect [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:dp4165838369572783] </span>
<span id="cb14-29">\draw  [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">181</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">212</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">244</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">245.87</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">242.63</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">47.29</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.54</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">586.46</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">589.71</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">242.63</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">245.87</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">263.48</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">592.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">266.72</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">589.71</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">269.34</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">586.46</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">269.34</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.54</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">269.34</span>) .. controls (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">47.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">269.34</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">266.72</span>) .. (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">263.48</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-30"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da7083107764900278] </span>
<span id="cb14-31">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">92.99</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">215.67</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">92.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">240.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-32">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">212.67</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">90.17</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da028317245941649194] </span>
<span id="cb14-34">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">93.66</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">153.67</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">93.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">182.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-35">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">93.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">150.67</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">90.15</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-36"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da8360791510647615] </span>
<span id="cb14-37">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">92.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">93.67</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">92.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">122.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-38">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">92.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">90.67</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">90.15</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-39"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da620625708639835] </span>
<span id="cb14-40">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">378.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">213.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">378.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">241.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-41">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">378.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.58</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-42"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da911476849461266] </span>
<span id="cb14-43">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">305.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">270.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">305.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">298.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-44">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">305.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">267.92</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-45"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da6168210047920039] </span>
<span id="cb14-46">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">377.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">94.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">377.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">122.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-47">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">377.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">226</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-48"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da45709411556658486] </span>
<span id="cb14-49">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">243.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">243.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">119.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-50">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">243.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">122.25</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-51"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da1624871748247504] </span>
<span id="cb14-52">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">244.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">152.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">244.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">180.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-53">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">244.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">183.58</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-54"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da951312301312835] </span>
<span id="cb14-55">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">245.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">211.33</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">244.99</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">237.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-56">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">244.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">240.25</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">271.49</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-57"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da5598487398669117] </span>
<span id="cb14-58">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">351</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">270.67</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">350.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">295.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-59">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">350.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">298.92</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">270.17</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-60"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da18143538236339274] </span>
<span id="cb14-61">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">547.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">91.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">547.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">119.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-62">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">547.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">122.25</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-63"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da11843933303452991] </span>
<span id="cb14-64">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">547.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">151.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">547.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">179.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-65">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">547.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">182.25</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-66"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>Straight Lines [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>:da21016027697626216] </span>
<span id="cb14-67">\draw [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">546.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">211.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">546.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">239.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-68">\draw [shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">546.92</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">242.25</span>)}, rotate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span>] [fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">144</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">254</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>]  [draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.93</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.29</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-69"></span>
<span id="cb14-70"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-71">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{CPU Core<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-72"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-73">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">342</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{CPU Core<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-74"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-75">\draw  [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">184</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">134</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.25</span>]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">58.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">124.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">169.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">124.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">169.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">149.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">58.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">149.25</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-76">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">113.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">136.75</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">72.93</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-77">x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],...</span>
<span id="cb14-78">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-79"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-80">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">210</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{L1 Cache}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-81"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-82">\draw (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">127.5</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{L1 Cache}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-83"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-84">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">470.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">302.67</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{Main Memory}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-85"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-86">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">298.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">344.17</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bytes</span>}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-87"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-88">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">170.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">312.17</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{Cache line}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-89"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-90">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">179.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">68.63</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">48.73</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-91"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-92">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-93"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-94">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">467.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">68.13</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">41.71</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-95"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-96">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-97"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-98">\draw  [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">184</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">134</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.25</span>]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">349.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">123.75</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">460.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">123.75</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">460.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.75</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">349.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">148.75</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-99">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">405.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">136.25</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">72.93</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-100">x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],...</span>
<span id="cb14-101">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-102"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-103">\draw  [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">184</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">134</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.25</span>]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">278.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">305.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">389.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">305.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">389.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">330.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">278.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">330.92</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-104">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">334.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">318.42</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">72.93</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-105">x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],...</span>
<span id="cb14-106">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-107"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-108">\draw  [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">184</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">134</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.25</span>]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">58.79</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">169.79</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">169.79</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">58.79</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-109">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">114.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">198.08</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">72.93</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-110">x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],...</span>
<span id="cb14-111">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-112"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-113">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.67</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">189.33</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{L2 Cache}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-114"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-115">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">500.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">189.5</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{L2 Cache}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-116"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-117">\draw  [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">184</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">134</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.25</span>]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">350.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.08</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">461.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">185.08</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">461.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.08</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">350.29</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">210.08</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-118">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">405.79</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">197.58</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">72.93</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-119">x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],...</span>
<span id="cb14-120">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-121"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-122">\draw  [color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">184</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">134</span> }  ,draw opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{rgb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:red, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">233</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> green, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> blue, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">229</span> }  ,fill opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ][line width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.25</span>]   (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">276.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">241.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">387.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">241.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">387.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">266.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">276.13</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">266.58</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> cycle  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-123">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">331.63</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">254.08</span>) node  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\begin{minipage}[lt]{<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">72.93</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}\setlength\topsep{<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>}</span>
<span id="cb14-124">x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],...</span>
<span id="cb14-125">\end{minipage}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-126"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Text Node</span>
<span id="cb14-127">\draw (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">500.33</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">246.67</span>) node [anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north west][inner sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pt</span>]  [xscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,yscale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] [align<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>left] {\textit{L3 Cache}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-128"></span>
<span id="cb14-129"></span>
<span id="cb14-130">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<p><img src="http://quantdev.blog/posts/memory_barriers/index_files/figure-html/cell-4-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Atomic operations do wait on each other! In particular, write-operations do. Read operations scale near-perfectly.</p>
<p>If I put the variables on separate cache-lines, then there is no problem and the CPUs don’t have to wait on anything. We can prove it with a benchmark.</p>
<pre><code>Benchmark                            Time         CPU
------------------------------------------------------------------------
BM_Shared/1/real_time            0.561 ms    0.015 ms
BM_Shared/2/real_time             3.25 ms    0.054 ms
BM_Shared/4/real_time             6.07 ms    0.061 ms
BM_Shared/8/real_time             10.6 ms    0.240 ms
BM_Shared/16/real_time            22.9 ms    0.384 ms
BM_Shared/32/real_time            51.4 ms    0.944 ms
BM_Shared/64/real_time             103 ms     2.67 ms
BM_FalseShared/1/real_time       0.578 ms    0.016 ms
BM_FalseShared/2/real_time        2.98 ms    0.037 ms
BM_FalseShared/4/real_time        6.18 ms    0.065 ms
BM_FalseShared/8/real_time        10.6 ms    0.234 ms
BM_FalseShared/16/real_time       13.5 ms    0.386 ms
BM_FalseShared/32/real_time       26.7 ms     1.21 ms
BM_FalseShared/64/real_time       37.0 ms     2.36 ms
BM_NonShared/1/real_time         0.576 ms    0.015 ms
BM_NonShared/2/real_time         0.591 ms    0.028 ms
BM_NonShared/4/real_time         0.632 ms    0.051 ms
BM_NonShared/8/real_time         0.598 ms    0.102 ms
BM_NonShared/16/real_time         1.05 ms    0.225 ms
BM_NonShared/32/real_time         1.81 ms    0.701 ms
BM_NonShared/64/real_time         3.21 ms     1.28 ms</code></pre>
<p>Atomic operations have to wait for cache line access. This is the <strong>price of data sharing</strong> without race conditions. Modifying different locations on the same cache line still incurs a run-time penalty, a phenomenon known as false sharing. To avoid false sharing, we should align per-thread data to separate cache lines. Atomic operations do wait on each other, particularly write operations. However, read-only operations can scale near-perfectly when properly designed.</p>
</section>
</section>
<section id="strong-vs-weak-compare-and-swap" class="level2">
<h2 class="anchored" data-anchor-id="strong-vs-weak-compare-and-swap">Strong vs Weak Compare-and-Swap</h2>
<p>C++ provides two versions of CAS - weak and strong.</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Strong CAS</span></span>
<span id="cb16-2">x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>compare_exchange_strong<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>old_x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> new_x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* </span></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">if (x == old_x)</span></span>
<span id="cb16-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    x = new_x;</span></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    return true;</span></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}else{</span></span>
<span id="cb16-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    old_x = x;</span></span>
<span id="cb16-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    return false;</span></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*/</span></span></code></pre></div>
<p><code>x.compare_exchange_weak(old_x, new_x)</code> is essentially the same thing, but can <strong>spuriously fail</strong> and return <code>false</code>, even if <code>x == old_x</code>.</p>
</section>
</section>
<section id="memory-barriers" class="level1">
<h1>Memory Barriers</h1>
<section id="memory-barriers---introduction" class="level2">
<h2 class="anchored" data-anchor-id="memory-barriers---introduction">Memory Barriers - Introduction</h2>
<p>It’s good to understand about atomic variables, but its not enough by a mile. Memory barriers go hand-in-hand with C++ atomics. Memory barriers control how changes to memory made by one CPU core become visible to other CPU cores. Without memory barriers, there is no guarantee of visibility whatsoever. Imagine you have two CPUs, both modifying a variable <code>x</code> in their on-chip caches. The main memory doesn’t have to change at all! There is no guarantee that anybody can see anything.</p>
<p>For example, CPU-1 cache might have <code>x = 42</code>, CPU-2 cache might have <code>x = 17</code>, while Main Memory still shows <code>x = 0</code> (stale/unchanged). The problem is that each CPU sees its own value. Memory is unchanged, and there is no coherence between the cores.</p>
</section>
<section id="memory-barriers-in-c" class="level2">
<h2 class="anchored" data-anchor-id="memory-barriers-in-c">Memory Barriers in C++</h2>
<p>C++ memory barriers are modifiers on atomic operations.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-2">x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_release<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>This implies that we have put a release memory barrier on that store.</p>
</section>
<section id="no-barriers---stdmemory_order_relaxed" class="level2">
<h2 class="anchored" data-anchor-id="no-barriers---stdmemory_order_relaxed">No Barriers - <code>std::memory_order_relaxed</code></h2>
<p>No memory barrier means that we can reorder reads and writes any way we want. We have an atomic <code>x</code> variable and <code>a</code>, <code>b</code> and <code>c</code> are non-atomic variables. No memory order means I can reorder reads and writes anywhere I want.</p>
<p>We have an atomic store to <code>x</code> in the middle. In the program order, I write to <code>a</code>, then I write to <code>b</code>, then I write to <code>c</code> and then I write to <code>x</code>. In the actual order, anything is possible. There are no restrictions whatsoever. This in C++ stamdard is called <code>std::memory_order_relaxed</code>. There are no guarantees here.</p>
<div class="text-center">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/memory_barriers/memory_order_relaxed.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Reads and writes can be reordered arbitrarily. No guarantees.</figcaption>
</figure>
</div>
</div>
</section>
<section id="acquire-barrier" class="level2">
<h2 class="anchored" data-anchor-id="acquire-barrier">Acquire Barrier</h2>
<p>An acquire barrier is a half-barrier that acts as a one-way gate. Nothing that was after the <code>load</code> can move in front of it, but anything that was before can move after. Acquire barrier guarantees that all memory operations scheduled after the barrier in the program order become visible after the barrier. This applies to <strong>all operations</strong> - not just all reads or all writes, but both reads and writes. Furthermore, this applies to <strong>all operations</strong>, not just operations on the atomic variable, but literally all memory operations. Reads and writes cannot be reordered from after to before the barrier.</p>
<div class="text-center">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/memory_barriers/memory_order_acquire.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Anything that was after cannot be moved to before the load.</figcaption>
</figure>
</div>
</div>
</section>
<section id="release-barrier" class="level2">
<h2 class="anchored" data-anchor-id="release-barrier">Release Barrier</h2>
<p>A release barrier is the reverse of an acquire barrier. Nothing that was before the barrier can move after, but anything that is after can move in front of the <code>store</code>.</p>
<div class="text-center">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/memory_barriers/memory_order_release.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Anything that was before cannot be moved to after the store.</figcaption>
</figure>
</div>
</div>
</section>
<section id="acquire-release-protocol" class="level2">
<h2 class="anchored" data-anchor-id="acquire-release-protocol">Acquire-Release Protocol</h2>
<p>Acquire and release barriers are often used together. Thread t1 writes atomic variable <code>x</code> with a <code>release</code> barrier. Thread t2 reads atomic variable <code>x</code> with an <code>acquire</code> barrier. On the acquire side, all memory reads done after the <code>acquire</code> barrier in t2 in program order have to be done after the barrier in actual execution order. On the release side, all memory writes done before the <code>release</code> barrier in t1 in program order have to be done before the barrier in actual execution order.</p>
<p>The result is that all memory writes that happen in t1 before the barrier become visible in thread t2 after the barrier. Thread 1 prepares data (does some writes) then <strong>releases</strong> (publishes) it by updating atomic variable <code>x</code>. Thread 2 <strong>acquires</strong> atomic variable <code>x</code> and the data is guaranteed to be visible. It’s important to note that it has to be the same atomic variable <code>x</code> for this synchronization to work.</p>
</section>
<section id="challenge-question" class="level2">
<h2 class="anchored" data-anchor-id="challenge-question">Challenge question</h2>
<p>Observe the following code snippet. What is the output of lines (q) and (s)?</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Thread-1</span></span>
<span id="cb18-2">x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-3">y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_release<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-4">x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-5">z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_release<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-6">x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//Thread-2</span></span>
<span id="cb18-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_acquire<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){}</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// p</span></span>
<span id="cb18-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// q</span></span>
<span id="cb18-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_acquire<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){}</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// r</span></span>
<span id="cb18-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// s</span></span></code></pre></div>
<p>For more such questions, visit <a href="https://getcracked.io">getcracked.io</a></p>
</section>

</section>

<div id="quarto-appendix" class="default"><section id="references" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">References</h2><div class="quarto-appendix-contents">

<ul>
<li><a href="https://www.youtube.com/watch?v=ZQFzMfHIxng">C++ atomics, from basic to advanced</a> by Fedor Pikus (CppCon 2017)</li>
<li>“C++ Concurrency in Action” by Anthony Williams</li>
<li>“The Art of Multiprocessor Programming” by Herlihy and Shavit</li>
</ul>


</div></section></div> ]]></description>
  <category>Concurrency</category>
  <guid>http://quantdev.blog/posts/memory_barriers/index.html</guid>
  <pubDate>Sun, 16 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/memory_barriers/concurrency.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Coroutines</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/coroutines/index.html</link>
  <description><![CDATA[ 




<section id="coroutines" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="coroutines">Coroutines</h2>
<p>You’ve likely heard about this new C++20 feature, <strong>coroutines</strong>. I think that this is a really important subject and there are several cool use-cases for coroutines. A <a href="https://en.wikipedia.org/wiki/Coroutine">coroutine</a> in the simplest terms is just a function that you can pause in the middle. Imagine that you are executing a function top-down and then just at some point in between, you’d like to say, I am going to hit the pause button here; going to return the control back to the caller. At a later point the caller will decide to resume the execution of the function right where you left off. Unlike a function therefore, coroutines are always stateful - you atleast need to remember where you left off in the function body. Usually, you also need to remember more than this; you need to remember the values of all of the local variables were at the point where you paused. As a consequence, <em>you can think of the coroutine you are calling not as a function in the classical sense of the term, but more like a factory function that actually returns the coroutine object back to you. And this coroutine object is the one that holds all the state, and which you can resume to continue the computation at a future time</em>.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext itikz</span></code></pre></div>
</div>
<p>Coroutines can simplify our code! Coroutines are a great tool, when it comes to implementing parsers.</p>
<p>Compared to functions, the control flow of coroutines looks as follows:</p>
<div class="text-center">
<div class="cell" data-execution_count="2">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb2-2">\begin{tikzpicture}[scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>]</span>
<span id="cb2-3">\draw[blue, rounded corners] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) rectangle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-4">\node(A) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.75</span>) {Caller}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5">\node(B) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.50</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6">\node(C) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.20</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-7">\node(call) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.20</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.20</span>) {call}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-8">\node(D) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-9">\node(F) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.75</span>) {Function}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-10">\node(Func) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.50</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11">\node(Return) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-12">\node(return_back) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>) {\texttt{<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span>}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-13">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (A) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (B)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-14">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (B) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (Func)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-15">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (Func) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (Return)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-16">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (Return) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (C)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-17">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (C) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (D)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-18">\draw[blue, rounded corners] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) rectangle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-19">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<p><img src="http://quantdev.blog/posts/coroutines/index_files/figure-html/cell-3-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>Fig. Functions - control flow</p>
</div>
<div class="text-center">
<div class="cell" data-execution_count="3">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb3-2">\begin{tikzpicture}[scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>]</span>
<span id="cb3-3">\draw[blue, rounded corners] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) rectangle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4">\node(F) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.75</span>) {Coroutine}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-5">\node(A) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.75</span>) {Caller}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-6">\node(B) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.50</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-7">\node(coro_A) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.50</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-8">\node(coro_B) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.20</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-9">\node(suspend_1) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.75</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.70</span>) {suspend}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-10">\node(coyield_1) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.50</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.25</span>) {\texttt{co\_yield}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-11">\node(call_1) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.20</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.20</span>) {call}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-12">\node(C) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.20</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-13">\node(D) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.70</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-14">\node(coro_C) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.70</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-15">\node(resume_1) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.75</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.10</span>) {resume}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-16">\node(coro_D) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.20</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-17">\node(suspend_2) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.75</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.70</span>) {suspend}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-18">\node(coyield_2) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.50</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.25</span>) {\texttt{co\_yield}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-19">\node(E) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.20</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-20">\node(F) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-21">\node(resume_2) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.75</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.55</span>) {resume}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-22">\node(coro_F) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-23">\node(coro_G) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.55</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-24">\node(return_back) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) {\texttt{co\_return}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-25">\node(H) at (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) {}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-26">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (A) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (B)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-27">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (B) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (coro_A)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-28">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (coro_A) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (coro_B)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-29">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (coro_B) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (C)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-30">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (C) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (D)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-31">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (D) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (coro_C)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-32">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (coro_C) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (coro_D)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-33">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (coro_D) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (E)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-34">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (E) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (F)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-35">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (F) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (coro_F)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-36">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (coro_F) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (coro_G)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-37">\draw[dashed, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>{Stealth[length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">mm</span>]}] (coro_G) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (H)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-38">\draw[blue, rounded corners] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) rectangle (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-39">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="http://quantdev.blog/posts/coroutines/index_files/figure-html/cell-4-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>Fig. Coroutines - control flow</p>
</div>
<p>Coroutine frames (state of all the local variables at the point where you paused) may be stored on the stack or on the dynamic heap. C++ implements the latter approach - stackless coroutines.</p>
<p>When using coroutines, we are talking about cooperative multi-tasking. As a quick 101, in preemptive multitasking, a special hardware timer interrupt is sent to the CPU periodically, the register state of the currently running process is saved to the main memory (in a data-structure called the process context) and the OS kernel acquires control of the CPU. The OS scheduler uses a scheduling policy such as round-robin to schedule another process from the process queue, copies its context from main memory to the CPU registers and transfers control to it. This is called a context switch. In cooperative multitasking, each process/thread, once running decides for how long to keep the CPU, and (crucially) when it is time to give it up so that another thread can use it.</p>
<section id="a-simple-example" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="a-simple-example">A simple example</h3>
<p>Let’s start with a simple example. Let’s say, you want to compute the Fibonacci sequence. First thing, that you’d do, is code up a function <code>fibo(int)</code> that returns a sequence in a vector.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Returns a vector containing the </span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// first n elements of the Fibonacci </span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// series: </span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 1, 1, 2, 3, 5, 8, 13, 21, ...</span></span>
<span id="cb4-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> fibo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb4-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> a_prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> a_curr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> a_next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-10">    results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a_prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-11">    results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a_curr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-14">        a_next <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a_prev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a_curr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-15">        results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a_next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-16">        a_prev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a_curr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-17">        a_curr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a_next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-19"></span>
<span id="cb4-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>This naive implementation has a number of disadvantages. For example, this function will always require <img src="https://latex.codecogs.com/png.latex?O(n)"> storage. Fibonacci has a simple recursive equation, but if I have a complex computation, and I am only ever processing the numbers sequentially one at a time, then it makes no sense to pay for the entire <img src="https://latex.codecogs.com/png.latex?O(n)"> storage. Another problem is that, if you are dealing with an infinite range, then it becomes a lot harder to handle.</p>
<p>A different way of implementing this would be as follows. Instead of our function returning a range in a <code>vector</code>, we are just going to return a <code>generator</code> object; this <code>generator</code> object has then a <code>next()</code> member function and then every call to the <code>next()</code> member function gives us back the next number in the sequence.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> FiboGenerator</span>
<span id="cb5-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Successive calls to next()  </span></span>
<span id="cb5-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// return the numbers from the </span></span>
<span id="cb5-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Fibonacci series</span></span>
<span id="cb5-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb5-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Returns a new FiboGenerator object</span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// that will start from the first </span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Fibonacci number</span></span>
<span id="cb5-12">FiboGenerator makeFiboGenerator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span></code></pre></div>
<p>The interesting question is: Is <code>makeFiboGenerator()</code> a coroutine? And we really can’t tell - it’s an implementation detail. All we see is an interface. This is actually the most important thing about coroutines. From the outside, they just look and behave like functions. From the outside, there is no way to tell, whether they’ve been implemented using a coroutine or not. The only thing that we need to know as the user of this function is the interface of the object <code>FiboGenerator</code>.</p>
</section>
<section id="the-coroutine-return-type" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="the-coroutine-return-type">The coroutine return type</h3>
<p>The initial call to the coroutine function will produce this return object of a certain <code>ReturnType</code> and hand it back to the caller. The interface of this type is what is going to determine what the coroutine is capable of. Since coroutines are super-flexible, we can do a whole lot with this return object. If you have some coroutine, and you want to understand what it’s doing, the first thing you should look at is the <code>ReturnType</code>, and what it’s interface is. The important thing here is, we design this <code>ReturnType</code>. If you are writing a coroutine, you can decide, what goes into this interface.</p>
</section>
<section id="how-to-turn-a-function-into-a-coroutine" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="how-to-turn-a-function-into-a-coroutine">How to turn a function into a coroutine?</h3>
<p>The compiler looks for one of the three keywords in the implementation: <code>co_yield</code>, <code>co_await</code> and <code>co_return</code>.</p>
<table class="table">
<caption>Coroutine keywords and their effects</caption>
<thead>
<tr class="header">
<th>Keyword</th>
<th>Action</th>
<th>State</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>co_yield</code></td>
<td>Output</td>
<td>Suspended</td>
</tr>
<tr class="even">
<td><code>co_return</code></td>
<td>Output</td>
<td>Ended</td>
</tr>
<tr class="odd">
<td><code>co_await</code></td>
<td>Input</td>
<td>Suspended</td>
</tr>
</tbody>
</table>
<p>In the preceding table, we see that after <code>co_yield</code> and <code>co_await</code>, the coroutine suspends itself and after <code>co_return</code>, it is terminated (<code>co_return</code> is the equivalent of the <code>return</code> statement in the C++ function).</p>
<p>A classical function starts executing when it’s called and normally terminates with a <code>return</code> statement or just when the function’s end is reached. A function runs from the beginning to end. It may call another function (or even itself if it is recursive) and it may throw exceptions or have different return points. But it always runs from the beginning to the end.</p>
<p>A coroutine is different. A coroutine is a function that can suspend itself. The flow for a coroutine may be like the following pseudo-code:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1">ReturnType coroutine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb6-2">    do_something<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb6-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_yield</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-4">    do_something_else<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_yield</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-6">    do_more_work<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>You should think of the coroutine function not as a function in the classical sense, but rather as a factory function that returns a coroutine object and this coroutine object is the one that holds all the state, and one which you can resume to continue the computation later on.</p>
</section>
<section id="use-cases-for-coroutines" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="use-cases-for-coroutines">Use-cases for coroutines</h3>
<p><strong>Asynchronous computation.</strong> Suppose we are tasked with designing a simple echo server. We listen for incoming data from a client socket and we simply send it back to the client. At some point in our code for the echo server, we will have a piece of logic like below:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> session<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb7-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb7-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>read<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb7-4">    sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb7-5">    log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>We create a <code>buffer</code>, then call the <code>read</code> that reads packets from the NIC and stores them in the buffer. The return value <code>len</code> will tell us how many bytes we read. Then, we shrink the <code>buffer</code> - we create a smaller one with <code>len</code> bytes and we write it back. Finally, we perform some logging. If we run it, it will probably work, but we certainly don’t want to write a server like this. Say one of the clients requests communication and we are in a session. They say, they are ready to send the data, so we are blocking on the <code>read</code>, but maybe they send us this data in 2 minutes, or 5 minutes or even more. And other clients keep waiting.</p>
<p>What we could do is start this session and run it in a separate thread. And this would work, because if this thread is blocked, and if there are other threads in this server, they would run in exchange during the wait time. If we have a threadpool, we’ll just grab a thread from the threadpool, tell whatever system manages the pool to run this <code>session(Socket)</code> function there.</p>
<p>This solution is still far from ideal. These are operating system emulated threads and the OS will have to manage which threads get CPU time. It will have to preempt one thread, run another. This preemption will occur at random moments, when we least expect it. We could have data-races and likely require protection of a critical section/resource using mutexes.</p>
<p>One alternative is to use an asynchronous framework and rewrite our code as follows:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> session<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb8-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> State<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb8-3">    </span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Heap allocate the state</span></span>
<span id="cb8-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_shared<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>State<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-6"></span>
<span id="cb8-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> on_read_finished_callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb8-8"></span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform an asynchronous read </span></span>
<span id="cb8-10">    state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>socket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>async_read<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb8-11">                             on_read_finished_callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The <code>async_read()</code> call is a request to the framework, which says that we are interested in data being read to our buffer at some point convenient to the client. When this succeeds, call our <code>on_read_finished_callback</code>. So, we are just making this association at this point and the server can move on to doing other stuff.</p>
<p>The <code>read</code> operation may fail for a number of reasons, so a good approach would be supply two arguments to the <code>on_read_finished_callback</code>: (i) An error code (ii) The number of bytes received, if there were no errors. We can try to implement it, by checking the error-code.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> session<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb9-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> State<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-3">    </span>
<span id="cb9-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Heap allocate the state</span></span>
<span id="cb9-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_shared<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>State<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-6"></span>
<span id="cb9-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> on_read_finished_callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span></span>
<span id="cb9-8">        error_code ec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb9-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> len</span>
<span id="cb9-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-12">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> done <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb9-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>ec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-15">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform an asynchronous write</span></span>
<span id="cb9-16">            state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>socket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>async_write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> </span>
<span id="cb9-17">                state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb9-18">                done </span>
<span id="cb9-19">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb9-20">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-22"></span>
<span id="cb9-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform an asynchronous read </span></span>
<span id="cb9-24">    state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>socket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>async_read<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb9-25">                             on_read_finished_callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Now, we don’t have exception handling, because we have spread our logic over a number of callbacks. We are only left with <code>if</code> statements. If the reading all went fine, we can write the data back by shrinking the buffer, requesting that the <code>write</code> is performed at some time, not necessarily now - maybe later. When this <code>write</code> is performed, we would like to call another callback <code>done</code>. We don’t wait until this callback is called or <code>write</code> is performed. At this point, we just make an association. It is possible, that at a future time, the <code>write</code> succeeds and then the callback <code>done</code> is called. So, we have to define it.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> session<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> State<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-3">    </span>
<span id="cb10-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Heap allocate the state</span></span>
<span id="cb10-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_shared<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>State<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-6"></span>
<span id="cb10-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> on_read_finished_callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span></span>
<span id="cb10-8">        error_code ec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb10-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> len</span>
<span id="cb10-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-12">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> done <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span>error_code ec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-14">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>ec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-15">                log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb10-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>ec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform an asynchronous write</span></span>
<span id="cb10-20">            state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>socket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>async_write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> </span>
<span id="cb10-21">                state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb10-22">                done </span>
<span id="cb10-23">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb10-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-26"></span>
<span id="cb10-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform an asynchronous read </span></span>
<span id="cb10-28">    state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>socket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>async_read<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb10-29">                             on_read_finished_callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-30"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><code>done</code> has a similar structure. It takes two arguments - the error code that tells if the <code>write</code> went fine and the number of bytes written <code>len</code>. If there were no errors on <code>write</code> and everything went fine, we can do the logging. Implicitly,</p>
<p>So, the <code>session</code> makes two associations:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Ctext%7BOn%20finishing%20read%7D%20&amp;%5Cmapsto%20%5Ctexttt%7Bon%5C_finished%5C_read%5C_callback%7D%20%5C%5C%0A%5Ctext%7BOn%20finishing%20write%7D%20&amp;%5Cmapsto%20%5Ctexttt%7Bdone%7D%20%5C%5C%0A%5Ctext%7BAccepting%20a%20new%20client%20connection%7D%20&amp;%5Cmapsto%20%5Ctexttt%7Bsession%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>And implicitly there is a third association even though we cannot see it here - this entire function <code>session</code> is most likely a callback, in response to an event like <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BOn%20client%20connection%20established%7D">. So, the server will be many different associations of events to callbacks at different levels.</p>
<p>Pay attention to the <code>state</code>. We said that, we wanted to allocate it on the heap and manage it through a <code>shared_ptr</code>. We pass this <code>shared_ptr&lt;State&gt;</code> by value to every single callback. This way, I make sure that the last one who touches this session turns off the lights and deallocates <code>state</code>.</p>
<p>While this is a toy-example, in real production code, there can be a long sequence of steps and calling lambdas inside lambdas can obfuscate the meaning of the code. We already see a weird inversion of control flow, when reading the code.</p>
<p>One thing to note before I go to coroutines is that, even though those things happen asynchronously, there is a sequence to it, that is not violated. We only perform a <code>write</code> when we know that the <code>read</code> has succeeded. We only perform the <code>log</code> after the <code>write</code> has succeeded.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctexttt%7Bread%7D%20%5Cto%20%5Ctexttt%7Bwrite%7D%20%5Cto%20%5Ctexttt%7Blog%7D%0A"></p>
<p>As an application programmer we determine, when we yield control to the system other sessions. It’s not that the system pre-empts this task.</p>
<p>A coroutine implementation of the same echo’ing session would look like this:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1">Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> session<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Socket sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_await</span> sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>async_read<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb11-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_await</span> sock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>async_write<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb11-5">    log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>This looks very similar to the sequential code, except that we use this <code>co_await</code> keyword. You have clear indication of the points where the coroutine will be suspended. Also, note that previously the function <code>session</code> returned <code>void</code>. Now, we are returning something - a <code>Task&lt;void&gt;</code>. This will be a handle to the coroutine and it’s how the outside world will be communicating with the coroutine.</p>
<p><strong>Suspended computation</strong>. A second use-case is that coroutines support lazy evaluation. Just as in the fibonacci example, sometimes we want to avoid doing unecessary evaluation. Lazy evaluation doesn’t do any work unless it’s absolutely necessary. This can also potentially make your code more efficient. Lazy evaluation also supports programming with infinite lists.</p>
</section>
</section>
<section id="the-simplest-coroutine" class="level2">
<h2 class="anchored" data-anchor-id="the-simplest-coroutine">The simplest coroutine</h2>
<p>The following code is the simplest implementation of a coroutine:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;coroutine&gt;</span></span>
<span id="cb12-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb12-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb12-7">    coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb12-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/W3GoWPoEs">Compiler Explorer</a></p>
<p>Our first coroutine will just return nothing. It will not do anything else. Sadly, the preceding code is too simple for a functional coroutine and it will not compile. When compiling with <code>gcc 15.2</code>, we get the following error:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1">&lt;source&gt;: In function 'void coro_func()':</span>
<span id="cb13-2">&lt;source&gt;:4:5: error: unable to find the promise type for this coroutine</span>
<span id="cb13-3">    4 |     co_return;</span>
<span id="cb13-4">      |     ^~~~~~~~~</span></code></pre></div>
<p>Looking at C++ reference, we see that the return type of a coroutine must define a type named <code>promise_type</code>.</p>
<section id="the-promise_type" class="level3">
<h3 class="anchored" data-anchor-id="the-promise_type">The <code>promise_type</code></h3>
<p>Why do we need a promise? The <code>promise_type</code> is the second important piece in the coroutine mechanism. We can draw an analogy from futures and promises which are essential blocks for achieving asynchronous programming in C++. The future is the thing, that the function that does the asynchronous computation, hands out back to the caller, that the caller can use to retrieve the result by invoking the <code>get()</code> member function. The future has the role of the return object. But, you need something that remains on the producer-side. The asynchronous function holds on to the promise, and that’s where it puts the results that will be given to the caller, when it calls <code>get()</code> on the future. The idea behind the <code>promise_type</code> for coroutines is similar. The promise is where the coroutine’s return value is stored, and it provides functions to control the coroutine’s behavior at startup and completion of t he coroutine. The promise is the interface through which the caller interacts with the coroutine.</p>
<p>Following the reference advice, we can write a new version of our coroutine.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;coroutine&gt;</span></span>
<span id="cb14-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Task</span>
<span id="cb14-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span></span>
<span id="cb14-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-8"></span>
<span id="cb14-9">Task coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb14-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-12"></span>
<span id="cb14-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb14-14">    coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/G957defsr">Compiler Explorer</a></p>
<p>Note that the return type of a coroutine can have any name (I call it <code>Task</code>, so that it makes intuitive sense). Compiling the preceding code again gives us errors. All errors are about missing functions in the <code>promise_type</code>:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb15-1">&lt;source&gt;: In function 'Task coro_func()':</span>
<span id="cb15-2">&lt;source&gt;:11:5: error: no member named 'return_void' in</span>
<span id="cb15-3">'std::__n4861::__coroutine_traits_impl&lt;Task, void&gt;::promise_type' {aka 'Task::promise_type'}</span>
<span id="cb15-4">   11 |     co_return;</span>
<span id="cb15-5">      |     ^~~~~~~~~</span>
<span id="cb15-6">&lt;source&gt;:10:6: error: no member named 'unhandled_exception' in</span>
<span id="cb15-7">'std::__n4861::__coroutine_traits_impl&lt;Task, void&gt;::promise_type' {aka 'Task::promise_type'}</span>
<span id="cb15-8">   10 | Task coro_func(){</span>
<span id="cb15-9">      |      ^~~~~~~~~</span>
<span id="cb15-10">&lt;source&gt;:10:6: error: no member named 'get_return_object' in</span>
<span id="cb15-11">'std::__n4861::__coroutine_traits_impl&lt;Task, void&gt;::promise_type' {aka 'Task::promise_type'}</span></code></pre></div>
<p>One of the important functions of the <code>promise_type</code> is that it determines what happens at certain key points in the coroutine’s life. It determines, what happens at the startup and completion of execution of the coroutine.</p>
</section>
<section id="implementing-the-promise_type" class="level3">
<h3 class="anchored" data-anchor-id="implementing-the-promise_type">Implementing the <code>promise_type</code></h3>
<p>The first thing that the compiler expects from us the <code>get_return_object()</code> function. The return type of this function is the same as the return type of the coroutine.</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;coroutine&gt;</span></span>
<span id="cb16-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-6">        Task get_return_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb16-7">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_return_object()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-9">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-10"></span>
<span id="cb16-11">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> return_void<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-12">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"return_void()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-14"></span>
<span id="cb16-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> unhandled_exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-16">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unhandled_exception()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-18"></span>
<span id="cb16-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-20">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"initial_suspend()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb16-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-23"></span>
<span id="cb16-24">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>final_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-25">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final_suspend()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb16-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-29"></span>
<span id="cb16-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;){</span></span>
<span id="cb16-31">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task(promise_type&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-32">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-33"></span>
<span id="cb16-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-35">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~Task()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-37"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-38"></span>
<span id="cb16-39">Task coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb16-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-41"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-42"></span>
<span id="cb16-43"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb16-44">    coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb16-45"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/xoqanYjMT">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb17-1">get_return_object()</span>
<span id="cb17-2">Task(promise_type&amp;)</span>
<span id="cb17-3">initial_suspend()</span>
<span id="cb17-4">~Task()</span></code></pre></div>
<p>The <code>get_return_object()</code> method is implicitly called when the coroutine starts executing. Its upto the <code>promise_type</code> to provide an implementation of this method that constructs the return object that will be handed back to the caller. The <code>Task</code> object is stored on the heap. You don’t see this in the source code anywhere. When the coroutine reaches its first suspension point, and control flow is returned back to the caller, then the caller will receive this object.</p>
<p>The next thing we need to specify is the <code>return_void()</code> function. This is a customization point for handling what happens when we reach the <code>co_return</code> statement in the function body. There is also a corresponding <code>return_value()</code>, if you don’t have an empty <code>co_return</code> statement, but we’ll look at this at length later ahead.</p>
<p>The next one we need is <code>unhandled_exception()</code> and similar to the <code>return_void()</code>, this function is a customization point for handling, what happens when the coroutine throws an exception. We leave it empty for now.</p>
<p>We need to implement two more functions <code>initial_suspend()</code> and <code>final_suspend()</code>. These are basically the customization points that allow us to execute some code, both when the coroutine first starts executing and shortly before the coroutine ends execution. Here, we are returning <code>std::suspend_always</code> which basically means that at these points, I want to go into suspension. In a typical implementation, you either return <code>std::suspend_always</code>, which means you pause execution at this point and hand control back to the caller always, or you return <code>std::suspend_never</code>, which basically means you just go on and continue executing the coroutine.</p>
<p>Note that, <code>final_suspend()</code> is not printed in the output, because the coroutine is paused at <code>initial_suspend()</code> and since I never resumed it, I don’t see the output on the console.</p>
</section>
</section>
<section id="a-yielding-coroutine" class="level2">
<h2 class="anchored" data-anchor-id="a-yielding-coroutine">A yielding coroutine</h2>
<p>The do-nothing coroutine was great to get a gut intuitive feel for the basic mechanics of writing low-level coroutines in C++. Let’s implement another coroutine that can send data back to the caller.</p>
<p>In this second example, we implement a coroutine that produces a message. It will be the hello world of coroutines. The coroutine will say hello and the caller function will print the message received from the coroutine.</p>
<p>To implement this functionality, we need to establish a communication channel from the coroutine to the caller. This channel is the mechanism that allows the coroutine to pass values to the caller and receive information from it. This channel is established through the coroutine’s <code>promise_type</code> and the <em>coroutine handle</em>.</p>
<p>The <em>coroutine handle</em> is a type that gives access to the coroutine frame(the coroutine’s internal state) and allows the caller to resume or destroy the coroutine. The handle is what the caller can use to resume the coroutine after it has been suspended (for example after <code>co_await</code> or <code>co_yield</code>). The handle can also be used to check whether the coroutine is done or to clean up its resources.</p>
<p>The following code is the new version of both the caller function and the coroutine:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb18-1">Task coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb18-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_yield</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello world from the coroutine"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-5"></span>
<span id="cb18-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb18-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> task <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb18-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"task.get() = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb18-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The coroutine <em>yields</em> and sends some data to the caller. The caller reads that data and prints it. When the compiler reads the <code>co_ yield</code> expression, it will generate a call to the <code>yield_value</code> function defined in the <code>promise_type</code>. Thus, we add the following code to the <code>promise_type</code> :</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>output_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-4"></span>
<span id="cb19-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb19-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>yield_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-7">            output_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-8">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb19-10"></span>
<span id="cb19-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;){</span></span>
<span id="cb19-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task(promise_type&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-14"></span>
<span id="cb19-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~Task()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The function gets a <code>std::string</code> object and moves it to the <code>output_data</code> member variable of the promise type. But, this just keeps the data inside the <code>promise_type</code>. We still need a mechanism to get that data out of the coroutine.</p>
<section id="the-coroutine-handle" class="level3">
<h3 class="anchored" data-anchor-id="the-coroutine-handle">The coroutine handle</h3>
<p>Once we require a communication channel to and from a coroutine, we need a way to refer to a suspended or executing coroutine. The mechanism to refer to the coroutine object is through a pointer or handle called a <strong>coroutine handle</strong>. The C++ library header file <code>&lt;coroutine&gt;</code> defines a type <code>std::coroutine_handle</code> to work with coroutine handles.</p>
<p>Two functions are of interest to us in the <code>std::coroutine_handle</code> interface : <code>resume()</code> and <code>destroy()</code>.</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{</span></span>
<span id="cb20-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb20-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> coroutine_handle from_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;);</span></span>
<span id="cb20-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>What <code>resume()</code> does is simply, it resumes the suspended coroutine. It continues execution.</p>
<p>If we think of this coroutine frame or object living somewhere on the heap, where all of the state of execution is stored, one way to destroy this state is to let the coroutine run to completion. But, far more commonly, we would like to manage the lifetime externally and we can then just call the <code>destroy()</code> function which will then get rid of the coroutine state.</p>
<p>Note that, the <code>coroutine_handle</code> is not a smart pointer type. So, you have to call the <code>destroy()</code> explicitly.</p>
<p>There’s two more functions <code>.promise()</code> and <code>.from_promise()</code>. These are used to convert from a coroutine to a promise object and vice versa.</p>
<p>We add the following functionality to our return type to manage the coroutine handle:</p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>output_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-4"></span>
<span id="cb21-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb21-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>yield_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-7">            output_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-8">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb21-10"></span>
<span id="cb21-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Coroutine handle member-variable</span></span>
<span id="cb21-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb21-13"></span>
<span id="cb21-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ReturnType(promise_type&amp;) ctor initializes </span></span>
<span id="cb21-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the coroutine handle member variable</span></span>
<span id="cb21-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb21-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> handle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;::</span>from_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task(promise_type&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-21"></span>
<span id="cb21-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Destructor</span></span>
<span id="cb21-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-24">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~Task()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb21-26">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb21-27">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-28"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The preceding code declares a coroutine handle of type <code>std::coroutine_handle&lt;promise_type&gt;</code> and creates the handle in the return type constructor. The handle is destroyed in the return type destructor.</p>
<p>Now, back to our yielding coroutine. The only missing bit is a <code>get()</code> function for the caller to be able to extract the resultant string out of the promise.</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb22-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>done<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb22-3">        handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb22-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>output_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb22-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The <code>get()</code> function resumes the coroutine if it has not terminated and return the result stored in the <code>output_data</code> member variable of the promise. The full source code listing is shown below:</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;coroutine&gt;</span></span>
<span id="cb23-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb23-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb23-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb23-5"></span>
<span id="cb23-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string_literals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-7"></span>
<span id="cb23-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>output_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb23-11"></span>
<span id="cb23-12">        Task get_return_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb23-13">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_return_object()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-14">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb23-15">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-16"></span>
<span id="cb23-17">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> return_void<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-18">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"return_void()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-20"></span>
<span id="cb23-21">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> unhandled_exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-22">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unhandled_exception()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-23">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-24"></span>
<span id="cb23-25">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-26">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"initial_suspend()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb23-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-29"></span>
<span id="cb23-30">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>final_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-31">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final_suspend()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-32">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb23-33">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-34"></span>
<span id="cb23-35">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>yield_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-36">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yield_value(std::string)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-37">            output_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-38">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb23-39">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-40">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb23-41"></span>
<span id="cb23-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Coroutine handle member-variable</span></span>
<span id="cb23-43">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb23-44"></span>
<span id="cb23-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ReturnType(promise_type&amp;) ctor initializes </span></span>
<span id="cb23-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the coroutine handle member variable</span></span>
<span id="cb23-47">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb23-48">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> handle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;::</span>from_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-49">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-50">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task(promise_type&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-51">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-52"></span>
<span id="cb23-53">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-54">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~Task()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-55">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb23-56">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb23-57">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-58"></span>
<span id="cb23-59">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb23-60">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-61">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>done<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb23-62">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb23-63"></span>
<span id="cb23-64">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>output_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-65">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-66"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb23-67"></span>
<span id="cb23-68">Task coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb23-69">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_yield</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello world from the coroutine"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-70">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-71"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-72"></span>
<span id="cb23-73"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb23-74">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> task <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb23-75">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-76"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/EjdWEnb5a">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb24-1">get_return_object()</span>
<span id="cb24-2">Task(promise_type&amp;)</span>
<span id="cb24-3">initial_suspend()</span>
<span id="cb24-4">get()</span>
<span id="cb24-5">yield_value(std::string)</span>
<span id="cb24-6">Hello world from the coroutine</span>
<span id="cb24-7">~Task()</span></code></pre></div>
<p>The output shows what is happening during the coroutine execution. The <code>Task</code> object is created after a call to <code>get_return_object</code>. The coroutine is initially suspended. The caller wants to get the message from the coroutine so <code>get()</code> is called, which resumes the coroutine. When the compiler sees <code>co_yield</code> statement in the coroutine, it generates an implicit called to <code>yield_value(std::string)</code>. <code>yield_value</code> is called and the message is copied to the resultant member variable <code>output_data</code> in the promise. Finally, the message is printed by the caller function, and the coroutine returns.</p>
</section>
</section>
<section id="a-waiting-coroutine" class="level2">
<h2 class="anchored" data-anchor-id="a-waiting-coroutine">A waiting coroutine</h2>
<p>We are now going to implement a coroutine that can wait for the input data sent by the caller. In our example, the coroutine will wait until it gets a <code>std::string</code> object and then print it. We say that the coroutine waits, we mean it is suspended (that is, not executed) until the data is received.</p>
<p>We start with changes to both the coroutine and the caller function:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb25-1">Task coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb25-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_await</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb25-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-5"></span>
<span id="cb25-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb25-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> task <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb25-8">    task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"To boldly go where no man has gone before"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In the preceding code, the caller function calls the <code>put()</code> function(a method in the return type structure) and the coroutine calls <code>co_await</code> to wait for a <code>std::string</code> object from the caller.</p>
<p>The changes to the return type are simple, that is, just adding the <code>put()</code> function.</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb26-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb26-2">    handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>input_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb26-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>done<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb26-4">        handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb26-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb26-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>We need to add the <code>input_data</code> variable to the promise structure. But, just with those changes to our first example and the coroutine handle from the previous example, the code cannot be compiled.</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb27-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb27-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;coroutine&gt;</span></span>
<span id="cb27-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb27-5"></span>
<span id="cb27-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>input_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb27-9"></span>
<span id="cb27-10">        Task get_return_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-11">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_return_object"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-12">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb27-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> </span>
<span id="cb27-14"></span>
<span id="cb27-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> return_void<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-16">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"return_void"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-18"></span>
<span id="cb27-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-20">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"initial_suspend"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb27-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-23"></span>
<span id="cb27-24">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>final_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-25">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final_suspend"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb27-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-28">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> unhandled_exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-29">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unhandled_exception"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-30">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-31"></span>
<span id="cb27-32">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>yield_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-33">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yield_value"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-34">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//output_data = std::move(msg);</span></span>
<span id="cb27-35">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb27-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-37">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb27-38"></span>
<span id="cb27-39">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb27-40"></span>
<span id="cb27-41">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb27-42">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;::</span>from_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span></span>
<span id="cb27-43">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-44">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task(promise_type&amp;) ctor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-45">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-46"></span>
<span id="cb27-47">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb27-49">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb27-50"></span>
<span id="cb27-51">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~Task()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-52">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-53"></span>
<span id="cb27-54">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb27-55">        handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>input_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-56">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>done<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb27-57">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb27-58">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-59"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb27-60"></span>
<span id="cb27-61">Task coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb27-62">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_await</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb27-63">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-64"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-65"></span>
<span id="cb27-66"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb27-67">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> task <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb27-68">    task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"To boldly go where no man has gone before"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb27-69">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-70"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/1qafsj83e">Compiler Explorer</a></p>
<p>The compiler gives us the following error:</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb28-1">&lt;source&gt;: In function 'Task coro_func()':</span>
<span id="cb28-2">&lt;source&gt;:62:18: error: no member named 'await_ready' in 'std::string' {aka 'std::__cxx11::basic_string&lt;char&gt;'}</span>
<span id="cb28-3">   62 |     std::cout &lt;&lt; co_await std::string{};</span>
<span id="cb28-4">      |                  ^~~~~~~~</span></code></pre></div>
<p>Let’s explore more about what this error message means.</p>
</section>
<section id="what-is-an-awaitable" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-awaitable">What is an awaitable?</h2>
<p>An <em>awaitable</em> is any object, I can call <code>co_await</code> on. You can think of <code>co_await</code> like an operator, and its argument as an <em>awaitable</em>. The way to think about the operator <code>co_await</code> is that these are opportunities for suspension. These are the points where the coroutine can be paused, and the control-flow can be handed back to the caller. The awaitable controls what happens at these points. Similar to, how the <code>promise_type</code> provides hooks to control what happens at startup or when you return from the coroutine, the awaitable provides these hooks for what happens when we go into suspension. They may decide not to suspend at all, and let the execution just continue. Not every <code>co_await</code> call necessary suspends. It’s totally upto the coroutine-writer. Let’s try to implement such an awaitable.</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Awaitable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> await_ready<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb29-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> await_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;);</span></span>
<span id="cb29-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> await_resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;);</span></span>
<span id="cb29-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The first function is <code>.await_ready()</code> which returns a <code>bool</code>. This determines whether we do actually go into suspension or we just say, <em>yeah, we are ready, and we don’t want to go into suspension</em>, we want to continue execution and in that case we just return <code>true</code>.</p>
<p>The next function is <code>.await_suspend()</code> and that is the customization point that will get executed shortly before the coroutine function goes to sleep.</p>
<p>The next function is <code>.await_resume()</code> and that is the customization point that will get execute just after the coroutine is resumed.</p>
<p>The following code shows our implementation of the <code>await_transform</code> function and the <code>Awaitable</code> struct:</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> await_transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb30-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Awaitable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb30-3">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-4"></span>
<span id="cb30-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> await_ready<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb30-6">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Says, yeah we are ready</span></span>
<span id="cb30-7">                            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// we don't need to sleep. Just go on.</span></span>
<span id="cb30-8">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb30-9"></span>
<span id="cb30-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>await_resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb30-11">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>input_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb30-12">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb30-13"></span>
<span id="cb30-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> await_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb30-15"></span>
<span id="cb30-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb30-17"></span>
<span id="cb30-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Awaitable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb30-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>This is the code for the full example of the waiting coroutine:</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb31-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb31-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;coroutine&gt;</span></span>
<span id="cb31-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb31-5"></span>
<span id="cb31-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>input_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb31-9"></span>
<span id="cb31-10">        Task get_return_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-11">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_return_object"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-12">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb31-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> </span>
<span id="cb31-14"></span>
<span id="cb31-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> return_void<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-16">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"return_void"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-18"></span>
<span id="cb31-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-20">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"initial_suspend"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb31-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-23"></span>
<span id="cb31-24">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>final_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-25">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final_suspend"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb31-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-28">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> unhandled_exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-29">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unhandled_exception"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-30">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-31"></span>
<span id="cb31-32">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>yield_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-33">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yield_value"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-34">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//output_data = std::move(msg);</span></span>
<span id="cb31-35">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb31-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-37"></span>
<span id="cb31-38">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> await_transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-39">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Awaitable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-40">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-41"></span>
<span id="cb31-42">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> await_ready<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-43">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Says, yeah we are ready</span></span>
<span id="cb31-44">                                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// we don't need to sleep. Just go on.</span></span>
<span id="cb31-45">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-46"></span>
<span id="cb31-47">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>await_resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-48">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>input_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-49">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-50"></span>
<span id="cb31-51">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> await_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb31-52"></span>
<span id="cb31-53">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb31-54"></span>
<span id="cb31-55">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Awaitable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-56">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-57">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb31-58"></span>
<span id="cb31-59">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb31-60"></span>
<span id="cb31-61">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb31-62">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;::</span>from_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span></span>
<span id="cb31-63">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-64">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task(promise_type&amp;) ctor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-65">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-66"></span>
<span id="cb31-67">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-68">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb31-69">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb31-70"></span>
<span id="cb31-71">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~Task()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-72">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-73"></span>
<span id="cb31-74">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb31-75">        handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>input_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-76">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>done<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb31-77">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb31-78">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-79"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb31-80"></span>
<span id="cb31-81">Task coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb31-82">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_await</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb31-83">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-84"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb31-85"></span>
<span id="cb31-86"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb31-87">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> task <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coro_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb31-88">    task<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"To boldly go where no man has gone before"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-89">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-90"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/fTvvYcsjn">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb32-1">get_return_object</span>
<span id="cb32-2">Task(promise_type&amp;) ctor</span>
<span id="cb32-3">initial_suspend</span>
<span id="cb32-4">To boldly go where no man has gone beforereturn_void</span>
<span id="cb32-5">final_suspend</span>
<span id="cb32-6">~Task()</span></code></pre></div>
</section>
<section id="coroutine-generators" class="level2">
<h2 class="anchored" data-anchor-id="coroutine-generators">Coroutine Generators</h2>
<p>A <strong>generator</strong> is a coroutine that generates a sequence of elements by repeatedly resuming itself from the point that it was suspended.</p>
<p>A generator can be seen as an infinite list, because it can generate an arbitrary number of elements.</p>
<p>I present below the source code for a simple <code>FibonacciGenerator</code>.</p>
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb33-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb33-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb33-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;coroutine&gt;</span></span>
<span id="cb33-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb33-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb33-6"></span>
<span id="cb33-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb33-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb33-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> fibo_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-10"></span>
<span id="cb33-11">        Generator get_return_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb33-12">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> </span>
<span id="cb33-14"></span>
<span id="cb33-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> return_void<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb33-16"></span>
<span id="cb33-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb33-18">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb33-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-20"></span>
<span id="cb33-21">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>final_suspend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb33-22">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb33-23">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-24">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> unhandled_exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb33-25"></span>
<span id="cb33-26">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>suspend_always<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>yield_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb33-27">            fibo_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-28">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb33-29">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-31"></span>
<span id="cb33-32">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb33-33"></span>
<span id="cb33-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb33-35">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>coroutine_handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">promise_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;::</span>from_promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span></span>
<span id="cb33-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb33-37"></span>
<span id="cb33-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb33-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb33-40">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb33-41">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-42"></span>
<span id="cb33-43">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb33-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>done<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb33-45">            handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb33-46">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>promise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>fibo_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-47">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-48"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-49"></span>
<span id="cb33-50">Generator makeFibonacciGenerator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb33-51">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-52">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb33-54">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_yield</span> i1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-55">        i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb33-56">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-57">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">co_return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-58"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-59"></span>
<span id="cb33-60"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb33-61">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> fibo_gen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> makeFibonacciGenerator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb33-62">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The first 10 numbers the Fibonacci sequence are : "</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb33-63">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb33-64">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">] = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> fibo_gen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb33-65">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb33-66">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-67"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/5vv9eh7r5">Compiler Explorer</a></p>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/coroutines/index.html</guid>
  <pubDate>Wed, 12 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/coroutines/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>AAD(Adjoint Algorithmic Differentiation)</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/aad/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I was skimming through <a href="http://luca-capriotti.net/">Luca Capriotti</a> and Mike Giles’ paper <a href="https://people.maths.ox.ac.uk/~gilesm/files/AAD_Review.pdf">15 Years of Adjoint Algorithmic Differentiation in Finance</a> and wanted to write a toy implementation in Julia. Algorithmic differentiation (AD) is a set of techniques to accurately and efficiently compute derivatives of a function in the form of a computer program. Many of my toy examples are borrowed from the excellent <a href="https://www.amazon.co.uk/Algorithmic-Differentiation-Explained-Financial-Engineering/dp/3319539787/ref=sr_1_1?crid=3ICBI9FQDER6B&amp;dib=eyJ2IjoiMSJ9.OBdGni8_VOEiK_wWQ1g2PA.ChQjNVwVvAHPnbWhiXJDTSw2G9dyuIX9-hsH6BP_ZT4&amp;dib_tag=se&amp;keywords=Algorithmic+Differentiation+in+Finance+Explained&amp;qid=1761218601&amp;sprefix=algorithmic+differentiation+in+finance+explained%2Caps%2C91&amp;sr=8-1">Algorithmic Differentiation in Finance Explained</a>, by Marc Henrard.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>As a quick example, suppose we have the scalar-valued function <img src="https://latex.codecogs.com/png.latex?f:%5Cmathbb%7BR%7D%5E%7Bp_a%7D%20%5Cto%20%5Cmathbb%7BR%7D">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ay%20=%20%5Ccos(x_1%20+%20e%5E%7Bx_2%7D)(%5Csin%20x_3%20+%20%5Ccos%20x_4)%20+%20x_2%5E%7B3/2%7D%20+%20x_4%0A"></p>
<p>The function inputs are a vector <code>a[1...p_a]</code> of dimension <img src="https://latex.codecogs.com/png.latex?p_a">. All intermediate values in the program will be denoted by <code>b</code>s. The output of the function is denoted by the variable <code>z</code> of dimension <img src="https://latex.codecogs.com/png.latex?1">. So, the algorithm starts with the inputs <code>a</code>, goes to <code>z</code> through a lot of <code>b</code>s. The new variables are denoted by <code>b[j]</code> with <code>j</code> starting with <code>1</code> and going upto <img src="https://latex.codecogs.com/png.latex?p_b">. There are <img src="https://latex.codecogs.com/png.latex?p_b"> intermediate variables <img src="https://latex.codecogs.com/png.latex?b"> in the program.</p>
</section>
<section id="forward-mode-ad" class="level2">
<h2 class="anchored" data-anchor-id="forward-mode-ad">Forward-mode AD</h2>
<p>Standard algorithmic differentiation also called forward algorithmic differentiation or tangent algorithmic differentiation. Our goal is to compute <img src="https://latex.codecogs.com/png.latex?%5Cpartial%20z/%5Cpartial%20a_i">. We achieve this by computing for each <img src="https://latex.codecogs.com/png.latex?j">(<img src="https://latex.codecogs.com/png.latex?p_a%20+%201%20%5Cleq%20j%20%5Cleq%20p_b">) the value:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdot%7Bb%7D%5Bj,i%5D%20=%20%5Cfrac%7B%5Cpartial%20b%5Bj%5D%7D%7B%5Cpartial%20a%5Bi%5D%7D%0A"></p>
<p>We first initialize the variables <img src="https://latex.codecogs.com/png.latex?b%5Bj%5D"> from <img src="https://latex.codecogs.com/png.latex?1%20%5Cleq%20j%20%5Cleq%20p_a"> with the inputs values <img src="https://latex.codecogs.com/png.latex?a%5Bj%5D">. Note that the derivative is denoted by dot on the variable and <img src="https://latex.codecogs.com/png.latex?%5Cdot%7Bb%7D%5Bj,i%5D"> is the derivative of <img src="https://latex.codecogs.com/png.latex?b%5Bj%5D"> with respect to some other variable <img src="https://latex.codecogs.com/png.latex?a%5Bi%5D">. For <img src="https://latex.codecogs.com/png.latex?j=1:p_a">, then, the derivative of <img src="https://latex.codecogs.com/png.latex?b%5Bj%5D"> with respect to <img src="https://latex.codecogs.com/png.latex?a%5Bi%5D"> is simply <img src="https://latex.codecogs.com/png.latex?1">, if <img src="https://latex.codecogs.com/png.latex?j=i"> and <img src="https://latex.codecogs.com/png.latex?0"> if <img src="https://latex.codecogs.com/png.latex?j%20%5Cneq%20i">. This is the starting point of a recursive algorithm. The starting part is the identity matrix :</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdot%7Bb%7D%5Bj,i%5D%20=%20%5Cdelta_%7Bi,j%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cdelta_%7Bi,j%7D"> represents Kronecker’s delta.</p>
<p>The successive derivatives <img src="https://latex.codecogs.com/png.latex?%5Cdot%7Bb%7D%5Bj,i%5D"> are given by the chain rule:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cdot%7Bb%7D%5Bj,i%5D%20=%20%5Cfrac%7B%5Cpartial%20b%5Bj%5D%7D%7B%5Cpartial%20a%5Bi%5D%7D%20&amp;=%20%5Csum_%7Bk=p_a%20+%201%7D%5E%7Bk=j-1%7D%5Cfrac%7B%5Cpartial%20b%5Bj%5D%7D%7B%5Cpartial%20b%5Bk%5D%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20b%5Bk%5D%7D%7B%5Cpartial%20a%5Bi%5D%7D%5C%5C%0A&amp;=%20%5Csum_%7Bk=p_a%20+%201%7D%5E%7Bj-1%7D%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20b%5Bk%5D%7D%20(b%5Bj%5D)%20%5Ccdot%20%5Cdot%7Bb%7D%5Bk,i%5D%5C%5C%0A&amp;=%20%5Csum_%7Bk=p_a%20+%201%7D%5E%7Bj-1%7D%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20b%5Bk%5D%7D%20g_j(b%5Bp_a%20+%201%20:%20j%20-%201%5D)%20%5Ccdot%20%5Cdot%7Bb%7D%5Bk,i%5D%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>The numbers <img src="https://latex.codecogs.com/png.latex?%5Cdot%7Bb%7D%5Bp_b,i%5D"> are equal to the derivatives of <img src="https://latex.codecogs.com/png.latex?z=b%5Bp_b%5D"> with respect to <img src="https://latex.codecogs.com/png.latex?a_i">, <img src="https://latex.codecogs.com/png.latex?1%20%5Cleq%20i%20%5Cleq%20p_a">. This concludes the algorithm for the computation of <img src="https://latex.codecogs.com/png.latex?%5Cpartial%20z/%5Cpartial%20a_i">.</p>
<p>The requirements for such an implementation is that all the intermediary functions <img src="https://latex.codecogs.com/png.latex?g_j"> have a derivative version. The algorithmic differentiation approach is a bottom-up approach : it can be implemented for an algorithm only if all the components below it, all the components entering into the composition have already been implemented.</p>
<div id="fig:forward_ad" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/aad/forward_ad.jpg" class="img-fluid figure-img" data-scale="70%"></p>
<figcaption class="figure-caption">Forward AD</figcaption>
</figure>
</div>
</section>
<section id="naive-implementation-of-forward-ad" class="level2">
<h2 class="anchored" data-anchor-id="naive-implementation-of-forward-ad">Naive implementation of forward-AD</h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Array{Real}</span>)</span>
<span id="cb1-2">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb1-3">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb1-4">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb1-5">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb1-6">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb1-7">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>f (generic function with 1 method)</code></pre>
</div>
</div>
<p>We create an AD version of the starter function as follows:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_AD</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Array{Real}</span>)</span>
<span id="cb3-2">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb3-3">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb3-4">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb3-5">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb3-6">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb3-7">    </span>
<span id="cb3-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Forward sweep - derivatives</span></span>
<span id="cb3-9">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(x)</span>
<span id="cb3-10"></span>
<span id="cb3-11">    b1dot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(n)</span>
<span id="cb3-12">    b1dot[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-13">    b1dot[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb3-14"></span>
<span id="cb3-15">    b2dot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(n)</span>
<span id="cb3-16">    b2dot[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb3-17">    b2dot[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">-sin</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb3-18"></span>
<span id="cb3-19">    b3dot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(n)</span>
<span id="cb3-20">    b3dot[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">*</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb3-21">    b3dot[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-22"></span>
<span id="cb3-23">    b4dot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">-sin</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b1dot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b2dot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b3dot</span>
<span id="cb3-24">    (b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>],b4dot)</span>
<span id="cb3-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>f_AD (generic function with 1 method)</code></pre>
</div>
</div>
<p>Note that, the output of the original function <code>f</code> is the function value - a <code>double</code>, whilst the output <code>f_ad</code> is a 2-tuple : the function value and the value of the jacobian(gradient).</p>
</section>
<section id="adjoint-algorithmic-differentiation" class="level2">
<h2 class="anchored" data-anchor-id="adjoint-algorithmic-differentiation">Adjoint Algorithmic Differentiation</h2>
<p>Our goal is to compute <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20z%7D%7B%5Cpartial%20a_i%7D">. We achieve this by computing for each intermediate variable <img src="https://latex.codecogs.com/png.latex?j"> (<img src="https://latex.codecogs.com/png.latex?p_a%20+%201%20%5Cleq%20j%20%5Cleq%20p_b">) the value:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coverline%7Bb%7D%5Bj%5D%20=%20%5Cfrac%7B%5Cpartial%20z%7D%7B%5Cpartial%20b%5Bj%5D%7D%0A"></p>
<p>Note that, <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bb%7D%5Bj%5D"> is the derivative of the output with respect to <code>b[j]</code>. It is important to switch the perception between the forward mode and the reverse mode. What is fixed in the reverse approach is the output, we always compute the derivative of the same variable, the output.</p>
<p>The starting point of the algorithm is easy. For <img src="https://latex.codecogs.com/png.latex?j%20=%20p_b">, the derivative of <img src="https://latex.codecogs.com/png.latex?z"> with respect to <img src="https://latex.codecogs.com/png.latex?b%5Bj%5D"> is simply the derivative of <img src="https://latex.codecogs.com/png.latex?z"> with respect to itself, which is <img src="https://latex.codecogs.com/png.latex?1">. This is the starting point of a recursive algorithm.</p>
<p>From there, we read the code in reverse order and just apply the chain rule. Each intermediary variable <img src="https://latex.codecogs.com/png.latex?b%5Bj%5D"> is used only in the lines of code that follow in the computation. The derivative <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bb%7D%5Bj%5D"> is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coverline%7Bb%7D%5Bj%5D%20=%20%5Cfrac%7B%5Cpartial%20z%7D%7B%5Cpartial%20b_j%7D%20=%20%5Csum_%7Bk=j+1%7D%5E%7Bp_b%7D%20%5Cfrac%7B%5Cpartial%20z%7D%7B%5Cpartial%20b_k%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20b_k%7D%7B%5Cpartial%20b_j%7D%20=%20%5Csum_%7Bk=j+1%7D%5E%7Bp_b%7D%20%5Coverline%7Bb%7D%5Bk%5D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20g_k%7D%7B%5Cpartial%20b_j%7D%0A"></p>
<p>I think it’s easy to visualize this in a computational graph:</p>
<div id="fig:reverse_ad" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/aad/reverse_ad.jpg" class="img-fluid figure-img" data-scale="70%"></p>
<figcaption class="figure-caption">Reverse AD</figcaption>
</figure>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_AAD</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Array{Real}</span>)</span>
<span id="cb5-2">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb5-3">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb5-4">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb5-5">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb5-6">    b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb5-7"></span>
<span id="cb5-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Backward sweep - derivatives</span></span>
<span id="cb5-9">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(a)</span>
<span id="cb5-10">    abar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(n)</span>
<span id="cb5-11">    b4bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb5-12">    b3bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b4bar</span>
<span id="cb5-13">    b2bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b4bar</span>
<span id="cb5-14">    b1bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">-sin</span>(b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b4bar</span>
<span id="cb5-15"></span>
<span id="cb5-16">    abar[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">-sin</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b2bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b3bar</span>
<span id="cb5-17">    abar[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b2bar</span>
<span id="cb5-18">    abar[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b1bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (a[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b3bar</span>
<span id="cb5-19">    abar[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b1bar</span>
<span id="cb5-20"></span>
<span id="cb5-21">    (b[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], abar)</span>
<span id="cb5-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>f_AAD (generic function with 1 method)</code></pre>
</div>
</div>
</section>
</section>
<section id="algorithmic-differentiation-tools" class="level1">
<h1>Algorithmic Differentiation Tools</h1>
<p>Given any computer function <code>f(x)</code>, we can build code implementing the tangent or adjoint mode for the calculation of its derivatives. This involves representing the function as a computational graph, calculating the derivatives on each of the edges, and computing the tangents or adjoints in the appropriate direction. This process is mechanical in nature and can be easily automated.</p>
<p>Most AD tools fall into 2 categories : <em>source code transformation</em> and <em>operator overloading</em>.</p>


</section>

 ]]></description>
  <category>Fin Math</category>
  <guid>http://quantdev.blog/posts/aad/index.html</guid>
  <pubDate>Wed, 22 Oct 2025 23:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/aad/image.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Continuous probability puzzles</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/continuous_probability_puzzles/index.html</link>
  <description><![CDATA[ 




<section id="puzzles-on-continuous-probability" class="level2">
<h2 class="anchored" data-anchor-id="puzzles-on-continuous-probability">Puzzles on continuous probability</h2>
<div id="exm-puzzle-1" class="theorem example">
<p><span class="theorem-title"><strong>Example 1 </strong></span>What is the maximum possible variance of a random variable that takes the values in the set <img src="https://latex.codecogs.com/png.latex?%5B-1,1%5D">?</p>
</div>
<p><em>Solution</em>.</p>
<p>Intuitively speaking, the variance of a mass distribution is the probability weighted average of the sum of the squared distances from the mean. It is maximized if the masses are placed far away from the center of gravity. So, if we place two point masses with probability weights <img src="https://latex.codecogs.com/png.latex?1/2"> at <img src="https://latex.codecogs.com/png.latex?(-1,0)"> and <img src="https://latex.codecogs.com/png.latex?(1,0)">, the variance would be maximal. Hence, the maximum variance equals <img src="https://latex.codecogs.com/png.latex?1">.</p>
<div id="exm-puzzle-2" class="theorem example">
<p><span class="theorem-title"><strong>Example 2 </strong></span>What is the maximum possible variance of a random variable that takes the values in the set <img src="https://latex.codecogs.com/png.latex?%5B0,1%5D">?</p>
</div>
<p><em>Solution</em>.</p>
<p>Again, we can have point masses with probability weights <img src="https://latex.codecogs.com/png.latex?1/2"> at <img src="https://latex.codecogs.com/png.latex?X=0"> and <img src="https://latex.codecogs.com/png.latex?X=1">. The center of mass or expectation of this distribution <img src="https://latex.codecogs.com/png.latex?EX%20=%201/2">. So, the maximal variance would be <img src="https://latex.codecogs.com/png.latex?(1/2)(1/2)%5E2%20+%20(1/2)(1/2)%5E2=1/4">.</p>
<div id="exm-puzzle-3" class="theorem example">
<p><span class="theorem-title"><strong>Example 3 </strong></span>Let <img src="https://latex.codecogs.com/png.latex?X"> be a random variable such that <img src="https://latex.codecogs.com/png.latex?P(X%20%5Cne%200)%20%3E%200">. Suppose that for some real numbers <img src="https://latex.codecogs.com/png.latex?a"> and <img src="https://latex.codecogs.com/png.latex?b">, the random variables <img src="https://latex.codecogs.com/png.latex?aX"> and <img src="https://latex.codecogs.com/png.latex?bX"> have the same distribution. Is it true that <img src="https://latex.codecogs.com/png.latex?a%20=%20b">? What if we also assume that <img src="https://latex.codecogs.com/png.latex?a"> and <img src="https://latex.codecogs.com/png.latex?b"> are both positive.</p>
</div>
<p><em>Solution</em>.</p>
<p>If <img src="https://latex.codecogs.com/png.latex?aX"> and <img src="https://latex.codecogs.com/png.latex?bX"> have the same mass distribution, they have the same expectation and variance.</p>
<p>Hence, <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5BaX%5D%20=%20%5Cmathbb%7BE%7D%5BbX%5D">. So, <img src="https://latex.codecogs.com/png.latex?a%5Cmathbb%7BE%7D%5BX%5D%20=%20b%20%5Cmathbb%7BE%7D%5BX%5D">. Consequently, <img src="https://latex.codecogs.com/png.latex?(a-b)%5Cmathbb%7BE%7D%5BX%5D%20=%200">. If <img src="https://latex.codecogs.com/png.latex?a%20%5Cneq%20b">, then <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5BX%5D%20=%200">. For example, consider the <img src="https://latex.codecogs.com/png.latex?U%20%5Csim%20U%5B-1,1%5D"> random variable. Both <img src="https://latex.codecogs.com/png.latex?U"> and <img src="https://latex.codecogs.com/png.latex?-U"> have the same distribution. Also, their second moments must match. So, <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5BaX"></p>


</section>

 ]]></description>
  <category>Quant Puzzles</category>
  <guid>http://quantdev.blog/posts/continuous_probability_puzzles/index.html</guid>
  <pubDate>Tue, 21 Oct 2025 23:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/continuous_probability_puzzles/image.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Discrete probability and counting puzzles</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/index.html</link>
  <description><![CDATA[ 




<section id="puzzles-on-discrete-probability" class="level2">
<h2 class="anchored" data-anchor-id="puzzles-on-discrete-probability">Puzzles on discrete probability</h2>
<div id="exm-puzzle-1" class="theorem example">
<p><span class="theorem-title"><strong>Example 1 </strong></span>We flip a fair coin until we obtain our first heads. If the first heads occurs on the <img src="https://latex.codecogs.com/png.latex?k">-th flip, we are given <img src="https://latex.codecogs.com/png.latex?k"> balls. We put them into 3 bins labeled 1, 2, and 3 at random. Find the probability that none of the three bins are empty.</p>
</div>
<p><em>Solution</em>.</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?A_k"> be the event that the first head occurs on the <img src="https://latex.codecogs.com/png.latex?k">th flip. So, we are interested in the sequence <img src="https://latex.codecogs.com/png.latex?%5Cunderbrace%7BT%20%5Cldots%20T%7D_%7B(k-1)%5Ctext%7B-tails%7D%7DH">. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%7BP%7D(A_k)%20=%20%5Cleft(%5Cfrac%7B1%7D%7B2%7D%5Cright)%5E%7Bk-1%7D%20%5Ccdot%20%5Cfrac%7B1%7D%7B2%7D%20=%20%5Cfrac%7B1%7D%7B2%5Ek%7D%0A"></p>
<div id="exm-puzzle-2" class="theorem example">
<p><span class="theorem-title"><strong>Example 2 </strong></span>Imagine you have <img src="https://latex.codecogs.com/png.latex?4"> <img src="https://latex.codecogs.com/png.latex?6">-sided dice. What is the probability that you roll a different number on each die?</p>
</div>
<p><em>Solution</em>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap%20=%20%5Cfrac%7B6%5Ccdot%205%20%5Ccdot%204%20%5Ccdot%203%7D%7B6%5E4%7D%0A"></p>
<div id="exm-puzzle-3" class="theorem example">
<p><span class="theorem-title"><strong>Example 3 </strong></span>What is the probability of flipping exactly <img src="https://latex.codecogs.com/png.latex?5"> heads when flipping <img src="https://latex.codecogs.com/png.latex?10"> fair coins?</p>
</div>
<p><em>Solution</em>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(k%20=%205)%20=%20%7B10%20%5Cchoose%205%7D%20%5Cfrac%7B1%7D%7B2%5E%7B10%7D%7D%0A"></p>
<div id="exm-puzzle-4" class="theorem example">
<p><span class="theorem-title"><strong>Example 4 </strong></span>Two players are at deuce in a tennis match — player <img src="https://latex.codecogs.com/png.latex?1"> has <img src="https://latex.codecogs.com/png.latex?60"> percent of winning the point and player <img src="https://latex.codecogs.com/png.latex?2"> has <img src="https://latex.codecogs.com/png.latex?40"> percent chance. What are the odds of player 1 winning?</p>
</div>
<p><em>Solution</em></p>
<p>When a game is at the 40-40 mark, a player still needs two clear points to win the game. We can quickly draw the following state diagram to represent the game (it is a discrete-time markov chain).</p>
<div id="fig:markov_chain_01" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/markov_chain_01.jpg" class="img-fluid figure-img" data-scale="50%"></p>
<figcaption class="figure-caption">Winning the game</figcaption>
</figure>
</div>
<p>Let the state <img src="https://latex.codecogs.com/png.latex?s_1%20%5Cstackrel%7Bdef%7D%7B=%7D"> the two players are 40-40. And the state <img src="https://latex.codecogs.com/png.latex?s_3%20%5Cstackrel%7Bdef%7D%7B=%7D"> player <img src="https://latex.codecogs.com/png.latex?1"> wins. The states <img src="https://latex.codecogs.com/png.latex?3"> and <img src="https://latex.codecogs.com/png.latex?5"> are absorbing states. Let <img src="https://latex.codecogs.com/png.latex?p_%7B13%7D"> be the hitting probability of state <img src="https://latex.codecogs.com/png.latex?3"> from state <img src="https://latex.codecogs.com/png.latex?1">. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ap_%7B13%7D%20&amp;=%200.6%20p_%7B23%7D%20+%200.4%20p_%7B43%7D%5C%5C%0Ap_%7B23%7D%20&amp;=%200.6%20(1)%20+%200.4p_%7B13%7D%5C%5C%0Ap_%7B43%7D%20&amp;=%200.6p_%7B13%7D%20+%200.4(0)%0A%5Cend%7Balign*%7D%0A"></p>
<p>It turns out that <img src="https://latex.codecogs.com/png.latex?p_%7B13%7D%20=%20%5Cfrac%7B9%7D%7B13%7D">.</p>
<div id="exm-puzzle-5" class="theorem example">
<p><span class="theorem-title"><strong>Example 5 </strong></span>You have a plate of spaghetti in front of you (no sauce!). You pick two ends and tie them together. Then you pick two more ends and tie them together. Continue until there are no free ends left. If there were <img src="https://latex.codecogs.com/png.latex?n"> spaghettis originally, what is the probability that you now have a single giant loop consisting of all the spaghettis?</p>
</div>
<p>Let <img src="https://latex.codecogs.com/png.latex?p_n"> be the probability of a single giant loop. <img src="https://latex.codecogs.com/png.latex?n"> spaghettis have <img src="https://latex.codecogs.com/png.latex?2n"> free ends. In each of the <img src="https://latex.codecogs.com/png.latex?n"> trials, you pick <img src="https://latex.codecogs.com/png.latex?2"> ends. At the start, the probability that you don’t tie a sphagetti to itself is</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B2n%7D%7B2n%7D%20%5Ccdot%20%5Cfrac%7B2n%20-%202%7D%7B2n%20-%201%7D%20=%20%5Cfrac%7B2n%20-%202%7D%7B2n%20-%201%7D%0A"></p>
<p>After the first draw, we have reduced the problem to <img src="https://latex.codecogs.com/png.latex?(n-1)"> spaghetti strands and <img src="https://latex.codecogs.com/png.latex?2n-2"> free ends. So, the probability of no-loops is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap_n%20=%20%20%5Cfrac%7B2n%20-%202%7D%7B2n%20-%201%7D%20%5Ccdot%20p_%7Bn-1%7D%0A"></p>
<p>Extending this to <img src="https://latex.codecogs.com/png.latex?k=(n-1)"> trials: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ap_n%20&amp;=%20%5Cfrac%7B2n%20-%202%7D%7B2n%20-%201%7D%20%5Ccdot%20%5Cfrac%7B2n-4%7D%7B2n-3%7D%20%5Ccdots%20%5Cfrac%7B2%7D%7B1%7D%5C%5C%0A&amp;=%202%5E%7Bn-1%7D%20%5Cfrac%7B(n-1)!%7D%7B(2n-1)(2n-3)%5Ccdots%201%7D%5C%5C%0A&amp;=%202%5E%7Bn-1%7D%20%5Cfrac%7B2%5En%20n!%20(n-1)!%7D%7B(2n)(2n-1)(2n-2)(2n-3)%20%5Ccdots%201%7D%5C%5C%0A&amp;=%202%5E%7B2n-1%7D%20%5Cfrac%7Bn!%20(n-1)!%7D%7B(2n)!%7D%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-7" class="theorem example">
<p><span class="theorem-title"><strong>Example 6 </strong></span>An electronic safe has a three digit passcode. You are given three constraints regarding the code. Firstly, the code is not an odd number. Secondly, the code does not contain the number six. Lastly, one of the digits appears more than once. How many possible three digit entries satisfy these three requirements?</p>
</div>
<p><em>Solution</em>.</p>
<p>Since it’s a <img src="https://latex.codecogs.com/png.latex?3">-digit electronic passcode to a safe, <img src="https://latex.codecogs.com/png.latex?0"> is a valid first digit. The last digit must be one of <img src="https://latex.codecogs.com/png.latex?0,2,4,8">. The first digit must be one of <img src="https://latex.codecogs.com/png.latex?%5C%7B0,1,2,%5Cldots,5,7,8,9%5C%7D">. The middle digit must be must be one of <img src="https://latex.codecogs.com/png.latex?%5C%7B0,1,2,%5Cldots,5,7,8,9%5C%7D"></p>
<p>Case I. The first two digits are identical.</p>
<p>There are <img src="https://latex.codecogs.com/png.latex?9%20%5Ctimes%201%20%5Ctimes%204%20=%2036"> such distinguishable codes.</p>
<p>Case II. The last two digits are identical.</p>
<p>There are <img src="https://latex.codecogs.com/png.latex?9%20%5Ctimes%201%20%5Ctimes%204%20=%2036"> such distinguishable codes.</p>
<p>Case III. The first and the third digits are identical.</p>
<p>There are <img src="https://latex.codecogs.com/png.latex?1%20%5Ctimes%209%20%5Ctimes%204%20=%2036"> such distinguishable codes.</p>
<p>Also, <img src="https://latex.codecogs.com/png.latex?000">, <img src="https://latex.codecogs.com/png.latex?222">, <img src="https://latex.codecogs.com/png.latex?444"> and <img src="https://latex.codecogs.com/png.latex?888"> have been overcounted <img src="https://latex.codecogs.com/png.latex?3"> times. They should be accounted for only once. Hence, the number of possible three digit entries satisfying the above requirements are <img src="https://latex.codecogs.com/png.latex?108%20-%208%20=%20100">.</p>
<div id="exm-puzzle-8" class="theorem example">
<p><span class="theorem-title"><strong>Example 7 </strong></span>Suppose we roll <img src="https://latex.codecogs.com/png.latex?5"> standard fair dice and sum the faces of the largest <img src="https://latex.codecogs.com/png.latex?3"> values showing. Find the probability that the sum is <img src="https://latex.codecogs.com/png.latex?18">.</p>
</div>
<p><em>Solution</em>.</p>
<p>To reach a sum of <img src="https://latex.codecogs.com/png.latex?18"> on the largest three die faces, we must get atleast <img src="https://latex.codecogs.com/png.latex?3"> sixes in <img src="https://latex.codecogs.com/png.latex?5"> dice rolls.</p>
<p>Define success as getting a <img src="https://latex.codecogs.com/png.latex?6"> on a die, <img src="https://latex.codecogs.com/png.latex?p%20=%20%5Cfrac%7B1%7D%7B6%7D">, <img src="https://latex.codecogs.com/png.latex?q=%5Cfrac%7B5%7D%7B6%7D"> and let <img src="https://latex.codecogs.com/png.latex?X"> be the number of sixes in <img src="https://latex.codecogs.com/png.latex?5"> die rolls.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AP(X%20%5Cge%203)%20&amp;=%201%20-%20(P(X=0)%20+%20P(X=1)%20+%20P(X=2))%5C%5C%0A&amp;=%201%20-%20%5Cleft(%5Cfrac%7B5%7D%7B6%7D%5Cright)%5E5%20-%20%7B5%20%5Cchoose%201%7D%20%5Cleft(%5Cfrac%7B1%7D%7B6%7D%5Cright)%5Cleft(%5Cfrac%7B5%7D%7B6%7D%5Cright)%5E4%20-%20%7B5%20%5Cchoose%202%7D%20%5Cleft(%5Cfrac%7B1%7D%7B6%7D%5Cright)%5E2%5Cleft(%5Cfrac%7B5%7D%7B6%7D%5Cright)%5E3%5C%5C%0A&amp;=%20%5Cfrac%7B23%7D%7B648%7D%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-9" class="theorem example">
<p><span class="theorem-title"><strong>Example 8 </strong></span>Consider a <img src="https://latex.codecogs.com/png.latex?2023%20%5Ctimes%202023"> grid. The grid squares from the middle row are shaded in. What is the probability that a randomly selected rectangle contains at least one shaded square?</p>
</div>
<p><em>Solution</em>.</p>
<p>Let’s solve this puzzle for a smaller <img src="https://latex.codecogs.com/png.latex?5%20%5Ctimes%205"> grid. A rectangle is always determined by a choice of a pair of vertical grid lines and a pair of horizonal grid lines.</p>
<div id="fig:quant_puzzles_01" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/quant_puzzles_01.jpg" class="img-fluid figure-img" data-scale="25%"></p>
<figcaption class="figure-caption">Rectangles</figcaption>
</figure>
</div>
<p>The number of horizontal and vertical grid lines are <img src="https://latex.codecogs.com/png.latex?6">. So, the total number of rectangles are <img src="https://latex.codecogs.com/png.latex?%7B6%20%5Cchoose%202%7D%20%5Ctimes%20%7B6%20%5Cchoose%202%7D">.</p>
<p>In order to pick rectangle that includes atleast one shaded square, one of the grid lines must chosen from the top <img src="https://latex.codecogs.com/png.latex?3"> horizontal grid lines and the second grid line must be chosen from the bottom <img src="https://latex.codecogs.com/png.latex?3"> horizontal grid lines. That yields <img src="https://latex.codecogs.com/png.latex?%7B3%20%5Cchoose%201%7D%5E2"> pairs of horizontal grid lines. There are no restrictions on the vertical grid lines so there are <img src="https://latex.codecogs.com/png.latex?%7B6%20%5Cchoose%202%7D"> pairs of vertical grid lines. Hence, the number of favorable rectangles are <img src="https://latex.codecogs.com/png.latex?3%5E2%20%5Ctimes%20%7B6%20%5Cchoose%202%7D">.</p>
<p>Generalizing, the desired probability for a <img src="https://latex.codecogs.com/png.latex?(2n-1)%20%5Ctimes%20(2n-1)"> grid is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ap_%7B2n-1%7D%20&amp;=%20%5Cfrac%7Bn%5E2%20%5Ccdot%20%7B2n%20%5Cchoose%202%7D%7D%7B%7B2n%20%5Cchoose%202%7D%5E2%7D%20%5C%5C%0A&amp;=%20%5Cfrac%7Bn%5E2%20%7D%7B%7B2n%20%5Cchoose%202%7D%7D%20%5C%5C%0A&amp;=%20%5Cfrac%7B2n%5E2%7D%7B(2n)(2n-1)%7D%5C%5C%0A&amp;=%20%5Cfrac%7Bn%7D%7B2n-1%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>So, <img src="https://latex.codecogs.com/png.latex?p_%7B2023%7D%20=%20%5Cfrac%7B1012%7D%7B2023%7D%20%5Capprox%200.5">.</p>
<div id="exm-puzzle-10" class="theorem example">
<p><span class="theorem-title"><strong>Example 9 </strong></span>How many paths are there where you can only move up or right one unit at each step that go from <img src="https://latex.codecogs.com/png.latex?(0,%200)"> to <img src="https://latex.codecogs.com/png.latex?(5,%203)"> without crossing the line <img src="https://latex.codecogs.com/png.latex?y%20=%20x">? You are allowed to touch it.</p>
</div>
<p>We are interested in those paths where each vertice on the trajectory has <img src="https://latex.codecogs.com/png.latex?x"> coordinate greater than or equal to the <img src="https://latex.codecogs.com/png.latex?y">- coordinate.</p>
<div id="exm-puzzle-11" class="theorem example">
<p><span class="theorem-title"><strong>Example 10 </strong></span>How many paths are there where you can only move up or right one unit at each step that go from <img src="https://latex.codecogs.com/png.latex?(0,%200)"> to <img src="https://latex.codecogs.com/png.latex?(5,%203)"> without crossing the line <img src="https://latex.codecogs.com/png.latex?y%20=%20x">? You are allowed to touch it.</p>
</div>
<div id="exm-puzzle-12" class="theorem example">
<p><span class="theorem-title"><strong>Example 11 </strong></span>Imagine 3 pairs of socks (6 total) labeled <img src="https://latex.codecogs.com/png.latex?%5C%7B1,1,2,2,3,3%5C%7D">. Define a satisfactory pair as any pair of individual socks such that their numbers differ by a maximum of 1 (i.e.&nbsp;2 3 is a satisfactory pair). In this game, drawing without replacement, what is the probability that a player will draw three satisfactory pairs of socks?</p>
</div>
<p><em>Solution</em>.</p>
<p>Label the socks as</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5C%7Ba_1,%20a_2,%20b_1,%20b_2,%20c_1,%20c_2%5C%7D%0A"></p>
<p>Arrangements with <img src="https://latex.codecogs.com/png.latex?3"> satisfactory pairs are only obtained, if there are no pairs where a 1-sock is paired with a 3-sock. Let us find the number of arrangements, where there is atleast <img src="https://latex.codecogs.com/png.latex?1"> pair containing a 1-sock paired with a 3-sock.</p>
<p>The number of distinguishable arrangements where the first pair has a 1-sock paired with a 3-sock are given as follows. There are <img src="https://latex.codecogs.com/png.latex?2"> possible choices for the 1-sock, <img src="https://latex.codecogs.com/png.latex?2"> possible choices for the <img src="https://latex.codecogs.com/png.latex?3">-sock, <img src="https://latex.codecogs.com/png.latex?2"> possible arrangements within this pair. For each such choice, there are <img src="https://latex.codecogs.com/png.latex?4!"> choices for second and third pairs of socks. So, the result is <img src="https://latex.codecogs.com/png.latex?2%20%5Ctimes%202%20%5Ctimes%202%20%5Ctimes%204!%20=%20192">. By similar arguments, the number of arrangements with the second pair/third pair containing a 1-sock and 3-sock are <img src="https://latex.codecogs.com/png.latex?192"> each. So, the total number of distinct arrangements are <img src="https://latex.codecogs.com/png.latex?192%20%5Ctimes%203%20=%20576">.</p>
<p>However, we overcounted the arrangements that have two (<img src="https://latex.codecogs.com/png.latex?1">-sock,<img src="https://latex.codecogs.com/png.latex?3">-sock) pairs. The number of arrangements where the first and second pair are (<img src="https://latex.codecogs.com/png.latex?1">-sock,<img src="https://latex.codecogs.com/png.latex?3">-sock) pairs is <img src="https://latex.codecogs.com/png.latex?2%20%5Ctimes%202%20%5Ctimes%202%20%5Ctimes%201%20%5Ctimes%202%20=%2016">. The three pairs can be arrangement amongst themselves in <img src="https://latex.codecogs.com/png.latex?3!%20=%206"> ways. So, the total number of distinct arrangements are <img src="https://latex.codecogs.com/png.latex?96">.</p>
<p>By inclusion-exclusion, the number of arrangments with atleast one (<img src="https://latex.codecogs.com/png.latex?1">-sock, <img src="https://latex.codecogs.com/png.latex?3">-sock) pair = <img src="https://latex.codecogs.com/png.latex?576%20-%2096%20=%20480">. Thus, the number of satisfactory arrangments is <img src="https://latex.codecogs.com/png.latex?720%20-%20480%20=%20240">.</p>
<p>The probability of <img src="https://latex.codecogs.com/png.latex?3"> satisfactory pairs = <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B240%7D%7B720%7D=%5Cfrac%7B1%7D%7B3%7D"></p>
<div id="exm-puzzle-13" class="theorem example">
<p><span class="theorem-title"><strong>Example 12 </strong></span>Player M has <img src="https://latex.codecogs.com/png.latex?1"> dollar and player N has <img src="https://latex.codecogs.com/png.latex?2"> dollars. Each game gives the winner $1 from the other. As a better player, M wins <img src="https://latex.codecogs.com/png.latex?2/3"> of the games. They play until one of them is bankrupt. What Is the probability that M wins?</p>
</div>
<p><em>Solution.</em></p>
<div id="fig:markov_chain_02" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/markov_chain_02.jpg" class="img-fluid figure-img" data-scale="50%"></p>
<figcaption class="figure-caption">Winning the game</figcaption>
</figure>
</div>
<p>Let <img src="https://latex.codecogs.com/png.latex?p_%7B1W%7D"> be the hitting probability of state <img src="https://latex.codecogs.com/png.latex?W"> given we are in state <img src="https://latex.codecogs.com/png.latex?1">. We can quickly setup:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ap_%7B1W%7D%20&amp;=%20%5Cfrac%7B2%7D%7B3%7Dp_%7B2W%7D%20%20+%20%5Cfrac%7B1%7D%7B3%7D%20%5Ctimes%200%0Ap_%7B2W%7D%20&amp;=%20%5Cfrac%7B1%7D%7B3%7Dp_%7B1W%7D%20+%20%5Cfrac%7B2%7D%7B3%7D%20%5Ctimes%201%0A%5Cend%7Balign*%7D%0A"></p>
<p>So, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ap_%7B1W%7D%20&amp;=%20%5Cfrac%7B2%7D%7B3%7D%5Cleft(%5Cfrac%7B1%7D%7B3%7Dp_%7B1W%7D%20+%20%5Cfrac%7B2%7D%7B3%7D%5Cright)%5C%5C%0A&amp;=%20%5Cfrac%7B2%7D%7B9%7D%20p_%7B1W%7D%20+%20%5Cfrac%7B4%7D%7B9%7D%5C%5C%0A%5Cfrac%7B7%7D%7B9%7Dp_%7B1W%7D%20&amp;=%20%5Cfrac%7B4%7D%7B9%7D%5C%5C%0Ap_%7B1W%7D%20&amp;=%20%5Cfrac%7B4%7D%7B7%7D%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-13" class="theorem example">
<p><span class="theorem-title"><strong>Example 13 </strong></span>We throw <img src="https://latex.codecogs.com/png.latex?3"> dice one by one. What is the probability that we obtain 3 points in strictly increasing order?</p>
</div>
<p><em>Solution.</em></p>
<p>We can choose a sub-population of <img src="https://latex.codecogs.com/png.latex?3"> numbers without ordering from a population of <img src="https://latex.codecogs.com/png.latex?n=6"> in <img src="https://latex.codecogs.com/png.latex?%7B6%20%5Cchoose%203%7D"> ways. For each selection, there is only one unique way to order them in strictly increasing order. Hence, the number of dice rolls where the points are in strictly increasing order are:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%7B6%20%5Cchoose%203%7D%7D%7B6%5E3%7D%20=%20%5Cfrac%7B20%7D%7B216%7D%0A"></p>
<div id="exm-puzzle-14" class="theorem example">
<p><span class="theorem-title"><strong>Example 14 </strong></span>Five boys and five girls are seated in a row at the movie theater. To ensure that the children are engaged during the movie, the teacher mandates that no two children of the same gender can sit next to each other. How many arrangements are possible?</p>
</div>
<p><em>Solution</em>.</p>
<p>We label the set of boys and girls as</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5C%7BB_1,%20B_2,%20B_3,%20B_4,%20B_5,%20G_1,%20G_2,%20G_3,%20G_4,%20G_5%20%5C%7D%0A"></p>
<p>There are <img src="https://latex.codecogs.com/png.latex?5%20%5Ctimes%204%20%5Ctimes%203%20%5Ctimes%202%20%5Ctimes%20=%205!"> ways to pick a girl for each boy. A boy and girl <img src="https://latex.codecogs.com/png.latex?(B_i,%20G_j)"> within a pair can be further be permuted. Additionally, the person in the first seat can be boy or a girl.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap%20=%20%5Cfrac%7B5!%205!%202%7D%7B10!%7D%0A"></p>
<div id="exm-puzzle-15" class="theorem example">
<p><span class="theorem-title"><strong>Example 15 </strong></span>A company is hosting a dinner for working mothers who have at least one son. Ms.&nbsp;Jackson, a mother with two children, has been invited to the event. What are the chances that both of her children are boys? In the second part, a new colleague, Ms.&nbsp;Parker, has two children. If you happen to see her walking with one of her children, and the child happens to be a boy, what is the probability that both of her children are boys?</p>
</div>
<p><em>Solution</em></p>
<p>The sample space <img src="https://latex.codecogs.com/png.latex?%5COmega%20=%20%5C%7B%20GG,%20GB,%20BG,%20BB%20%5C%7D">. The probability that both children are boys given that atleast one is a boy is <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B3%7D">.</p>
<p>The probability that both children are boys given that a specific child is a boy is given by</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BP%7D(%5Ctext%7BBoth%20are%20boys%7D%20%7C%20%5Ctext%7BSpecific%20child%20is%20a%20boy%7D)%20&amp;=%20P(%5Ctext%7BBoth%20are%20boys%7D%7C%5Ctext%7BFirst%20is%20a%20boy%7D)%20%5Ctimes%20P(%5Ctext%7BFirst%20is%20a%20boy%7D)%20+%20P(%5Ctext%7BBoth%20are%20boys%7D%7C%5Ctext%7BSecond%20is%20a%20boy%7D)%20%5Ctimes%20P(%5Ctext%7BSecond%20is%20a%20boy%7D)%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%7D%20%5Ctimes%20%5Cfrac%7B1%7D%7B2%7D%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Ctimes%20%5Cfrac%7B1%7D%7B2%7D%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%7D%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-16" class="theorem example">
<p><span class="theorem-title"><strong>Example 16 </strong></span>You have been given a thousand coins to study. One of these coins has heads on both sides, while the remaining 999 are fair coins. You pick a coin at random and flip it ten times. To your surprise, the coin turns up heads every time. What is the likelihood that the coin you picked is the one with two heads?</p>
</div>
<p><em>Solution.</em></p>
<p>By Bayes,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AP(%5Ctext%7BDouble%20head%20coin%7D%7C%5Ctext%7B10%20heads%7D)%20&amp;=%20%5Cfrac%7BP(%5Ctext%7B10%20heads%7D%20%5Ccap%20%5Ctext%7BDouble%20head%20coin%7D)%7D%7BP(%5Ctext%7B10%20heads%7D)%7D%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7B1000%7D%7D%7BP(%5Ctext%7B10%20heads%7D%20%7C%20%5Ctext%7BDouble%20head%20coin%7D)%20P(%5Ctext%7BDouble%20head%20coin%7D)%20+%20P(%5Ctext%7B10%20heads%7D%20%7C%20%5Ctext%7BFair%20coin%7D)%20P(%5Ctext%7BFair%20coin%7D)%7D%20%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7B1000%7D%5Ccdot%201%7D%7B%5Cfrac%7B1%7D%7B1000%7D%20%5Ccdot%201%20+%20%5Cfrac%7B1%7D%7B2%5E%7B10%7D%7D%20%5Ccdot%20%5Cfrac%7B999%7D%7B1000%7D%20%7D%5C%5C%0A%5Capprox%200.5061%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-17" class="theorem example">
<p><span class="theorem-title"><strong>Example 17 </strong></span>You have ten coins. <img src="https://latex.codecogs.com/png.latex?9"> of them are fair coins and <img src="https://latex.codecogs.com/png.latex?1"> of them is a coin with two heads. You pick a random coin from the set of coins and flip it five times. All five flips happen to be heads. Given this, what is the probability that the next flip will also be heads?</p>
</div>
<p><em>Solution.</em></p>
<p>Let <img src="https://latex.codecogs.com/png.latex?D"> be the event that a double coin is picked and <img src="https://latex.codecogs.com/png.latex?F"> be the event that a fair coin was picked. Let <img src="https://latex.codecogs.com/png.latex?E"> be the event that the next flip is heads. Let <img src="https://latex.codecogs.com/png.latex?S"> be the event that we get a sequence of <img src="https://latex.codecogs.com/png.latex?5">-heads.</p>
<p>By Bayes:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AP(E%7CS)%20&amp;=%20%5Cfrac%7BP(SE)%7D%7BP(S)%7D%5C%5C%0A&amp;=%20%5Cfrac%7BP(SE%7CF)%20P(F)%20+%20P(SE%7CD)%20P(D)%7D%7BP(S%7CF)P(F)%20+%20P(S%7CD)%20P(D)%7D%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cfrac%7B1%7D%7B2%5E6%7D%20%5Ccdot%20%5Cfrac%7B9%7D%7B10%7D%20+%201%5Ccdot%20%5Cfrac%7B1%7D%7B10%7D%7D%7B%5Cfrac%7B1%7D%7B2%5E5%7D%5Cfrac%7B9%7D%7B10%7D%20+%201%20%5Ccdot%20%5Cfrac%7B1%7D%7B10%7D%7D%5C%5C%0A&amp;=%20%5Cfrac%7B73%7D%7B82%7D%0A%5Capprox%200.890243%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-18" class="theorem example">
<p><span class="theorem-title"><strong>Example 18 </strong></span>You are given n random variables, <img src="https://latex.codecogs.com/png.latex?X_1,%20X_2%20%5Cldots,%20X_N">. Each of these variables has a uniform distribution that ranges from <img src="https://latex.codecogs.com/png.latex?0"> to <img src="https://latex.codecogs.com/png.latex?1">. Your task is to determine the probability that the sum of these variables, denoted as <img src="https://latex.codecogs.com/png.latex?S">, is less than equal to <img src="https://latex.codecogs.com/png.latex?1">. Can you solve this problem?</p>
</div>
<p><em>Solution</em>.</p>
<p>For <img src="https://latex.codecogs.com/png.latex?N=2">, <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D%5BX_1%20+%20X_2%20%5Cleq%201%5D"> can be visualized as follows:</p>
<div id="fig:quant_puzzles_02" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/quant_puzzles_02.jpg" class="img-fluid figure-img" data-scale="25%"></p>
<figcaption class="figure-caption">Sum of Uniforms</figcaption>
</figure>
</div>
<p>The two uniform random variables can be plotted along two orthogonal axes. Since <img src="https://latex.codecogs.com/png.latex?X_1%20%5Cgeq%200">, <img src="https://latex.codecogs.com/png.latex?X_2%20%5Cgeq%200"> and <img src="https://latex.codecogs.com/png.latex?X_1%20+%20X_2%20%5Cleq%201">, we are interested in the area of the yellow shaded portion. This should be <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7D">.</p>
<p>Similarly, for <img src="https://latex.codecogs.com/png.latex?N=3"> random variables, we will be interested in the volume of the tetrahedron, having vertices <img src="https://latex.codecogs.com/png.latex?(1,0,0)">, <img src="https://latex.codecogs.com/png.latex?(0,1,0)">, <img src="https://latex.codecogs.com/png.latex?(0,0,1)"> and <img src="https://latex.codecogs.com/png.latex?(0,0,0)"> which equals <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%5Ccdot%203%7D">.</p>
<p>In general, we posit that the probability that the sum of <img src="https://latex.codecogs.com/png.latex?N"> uniforms is less than unity is <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7BN!%7D">.</p>
<p>More rigorously, the MGF of a uniform random variable is: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AP(X_1%20+%20X_2%20%5Cleq%20t)%20&amp;=%20%5Cint_0%5Et%20P(X_2%20%5Cleq%20t%20-%20x_1%20%7C%20X_1%20=%20x_1%20)%20f_%7BX_1%7D(x_1)%20dx_1%20%5C%5C%0A&amp;=%20%5Cint_0%5Et%20%5Cint_0%5E%7Bt-x_1%7D%20dx_2%20dx_1%20%5C%5C%0A&amp;=%20%5Cint_0%5Et%20(t-x_1)%20dx_1%5C%5C%0A&amp;=%20%5Cleft%5B%5Cfrac%7B(t-x_1)%5E2%7D%7B2%7D%5Cright%5D_0%5Et%20%5C%5C%0A&amp;=%20%5Cfrac%7Bt%5E2%7D%7B2%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Assume that <img src="https://latex.codecogs.com/png.latex?P(X_1%20+%20%5Cldots%20+%20X_k%20%5Cleq%20t)%20=%20%5Cfrac%7Bt%5Ek%7D%7Bk!%7D">. We are interested to show that <img src="https://latex.codecogs.com/png.latex?P(X_1+%20%5Cldots%20+%20X_%7Bk%7D%20+%20X_%7Bk+1%7D%20%5Cleq%20t)%20=%20%5Cfrac%7Bt%5E%7Bk+1%7D%7D%7B(k+1)!%7D">.</p>
<p>Define <img src="https://latex.codecogs.com/png.latex?S_k%20%5Cstackrel%7Bdef%7D%7B=%7D%20%5Csum_%7Bi=1%7D%5E%7Bk%7D%20X_k">. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AP(S_k%20+%20X_%7Bk+1%7D%20%5Cleq%20t)%20&amp;=%20%5Cint_0%5Et%20P(S_k%20%5Cleq%20t%20-%20x_%7Bk+1%7D%20%7C%20X_%7Bk+1%7D%20=%20x_%7Bk+1%7D)%20f_%7BX_%7Bk+1%7D%7D(x_%7Bk+1%7D)%20dx_%7Bk+1%7D%5C%5C%0A&amp;=%20%5Cint_0%5Et%20%5Cfrac%7B(t%20-%20x_%7Bk+1%7D)%5Ek%7D%7Bk!%7D%20dx_%7Bk+1%7D%5C%5C%0A&amp;=%20%5Cleft%5B%5Cfrac%7B(t-x_%7Bk+1%7D)%5E%7Bk+1%7D%7D%7B(k+1)k!%7D%5Cright%5D_0%5Et%5C%5C%0A&amp;=%20%5Cfrac%7Bt%5E%7Bk+1%7D%7D%7B(k+1)!%7D%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-19" class="theorem example">
<p><span class="theorem-title"><strong>Example 19 </strong></span>Person A has a <img src="https://latex.codecogs.com/png.latex?20">-sided dice and person B has three <img src="https://latex.codecogs.com/png.latex?6">-sided dice. They both roll their dice and whoever gets a bigger number/sum of numbers wins the game. Is it a fair game? Now, what if there is one more player <img src="https://latex.codecogs.com/png.latex?C"> who has a <img src="https://latex.codecogs.com/png.latex?20">-sided dice. Is this new game fair? (all dice are fair; a <img src="https://latex.codecogs.com/png.latex?20">-sided dice has number <img src="https://latex.codecogs.com/png.latex?1,2,%5Cldots,20"> on each of its <img src="https://latex.codecogs.com/png.latex?20"> sides)</p>
</div>
<p><em>Solution</em></p>
<p>The game between is <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?B"> is not fair.</p>
<p>Define <img src="https://latex.codecogs.com/png.latex?X_1"> as the face value on the <img src="https://latex.codecogs.com/png.latex?20">-sided die rolled by person A.</p>
<p>Define <img src="https://latex.codecogs.com/png.latex?Y_1,%20Y_2,%20Y_3"> as the face values on the three <img src="https://latex.codecogs.com/png.latex?6">-sided die rolled by person B.</p>
<p>Define <img src="https://latex.codecogs.com/png.latex?S_1%20%5Cstackrel%7Bdef%7D%7B=%7D%20X_1">, <img src="https://latex.codecogs.com/png.latex?S_2%20%5Cstackrel%7Bdef%7D%7B=%7D%20Y_1%20+%20Y_2%20+%20Y_3">.</p>
<p>It’s a fair game, if the expected cost of playing a game equals the expected winnings. The expected cost for <img src="https://latex.codecogs.com/png.latex?A"> is expectetaion of <img src="https://latex.codecogs.com/png.latex?B"> winnings.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%7BE%7D%5BS_1%5D%20-%20%5Cmathbb%7BE%7D%5BS_2%5D%20%20=%2010.5%20-%203%20%5Ctimes%203.5%20=%200%0A"></p>
<div id="exm-puzzle-20" class="theorem example">
<p><span class="theorem-title"><strong>Example 20 </strong></span>I keep rolling a die until a <img src="https://latex.codecogs.com/png.latex?6"> appears. What is the probability the sum of all rolls is even?</p>
</div>
<p><em>Solution.</em></p>
<div id="fig:quant_puzzles_03" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/quant_puzzles_03.jpg" class="img-fluid figure-img" data-scale="25%"></p>
<figcaption class="figure-caption">Even Sum</figcaption>
</figure>
</div>
<p>We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ap_%7B13%7D%20&amp;=%20%5Cfrac%7B1%7D%7B6%7D%20%5Ccdot%201%20+%20%5Cfrac%7B1%7D%7B3%7D%20%5Ccdot%20p_%7B13%7D%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Ccdot%20p_%7B23%7D%5C%5C%0Ap_%7B23%7D%20&amp;=%20%5Cfrac%7B1%7D%7B2%7D%20%5Ccdot%20p_%7B13%7D%20+%20%5Cfrac%7B1%7D%7B3%7D%20%5Ccdot%20p_%7B23%7D%20+%20%5Cfrac%7B1%7D%7B6%7D%20%5Ccdot%200%0A%5Cend%7Balign*%7D%0A"></p>
<p>So, <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B2%7D%7B3%7Dp_%7B23%7D%20=%20%5Cfrac%7B1%7D%7B2%7Dp_%7B13%7D"> which implies <img src="https://latex.codecogs.com/png.latex?p_%7B23%7D%20=%20%5Cfrac%7B3%7D%7B4%7Dp_%7B13%7D">. Substituting in the first equation, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B2%7D%7B3%7Dp_%7B13%7D%20&amp;=%20%5Cfrac%7B1%7D%7B6%7D%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Ccdot%20%5Cfrac%7B3%7D%7B4%7D%20p_%7B13%7D%20%5C%5C%0A%5Cfrac%7B7%7D%7B24%7D%20p_%7B13%7D%20&amp;=%20%5Cfrac%7B1%7D%7B6%7D%5C%5C%0Ap_%7B13%7D%20&amp;=%20%5Cfrac%7B4%7D%7B7%7D%0A%5Cend%7Balign*%7D%0A"></p>
<div id="exm-puzzle-21" class="theorem example">
<p><span class="theorem-title"><strong>Example 21 </strong></span>You have two dice, how do you simulate one seventh odds with the two dice? Same way as one third odds with coins.</p>
</div>
<p><em>Solution.</em></p>


</section>

 ]]></description>
  <category>Quant Puzzles</category>
  <guid>http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/index.html</guid>
  <pubDate>Tue, 21 Oct 2025 23:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/discrete-probability-and-counting-puzzles/image.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Uniformly sampling from the unit disk</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/sampling-uniformly-on-the-unit-disk/index.html</link>
  <description><![CDATA[ 




<section id="uniformly-sampling-from-the-unit-disk" class="level1">
<h1>Uniformly sampling from the unit disk</h1>
<p>I was asked this puzzle in a recent quant interview and thought it would be interesting to solve this. We are asked to generate points that are uniformly distributed on the unit circle. This is a really elegant question.</p>
<p>A first approach would be to generate points from the unit square distribution - that is pick <img src="https://latex.codecogs.com/png.latex?U_1%20%5Csim%20U%5B0,1%5D"> and <img src="https://latex.codecogs.com/png.latex?U_2%20%5Csim%20U%5B0,1%5D">, and apply the transform <img src="https://latex.codecogs.com/png.latex?U_1'%20=%20-1%20+%202U_1">, <img src="https://latex.codecogs.com/png.latex?U_2'%20=%20-1%20+%202U_2">, so that the transformed random variables are <img src="https://latex.codecogs.com/png.latex?U%5B-1,1%5D">. We then accept all points that satisfy <img src="https://latex.codecogs.com/png.latex?u_1'%5E2%20+%20u_2'%5E2%20%5Cleq%201"> and reject all points that violate this condition. However, this is not computationally efficient as we are wasting <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B4%20-%20%5Cpi%7D%7B4%7D%20%5Capprox%2020%5C%25"> of the points.</p>
<p>One thing is, if you divide circle in concentric rings of size <img src="https://latex.codecogs.com/png.latex?%5CDelta%20R">, note that the further you are away from the origin, the more area the ring contains. However, we would like a distant ring to have the same density as a ring closer to the origin. So, we need to pick more points in the outer ring then in the inner ring. If we pick points with a probability proportional to the square of the distance from the origin, we should end up with a uniform scattering.</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?u%20=%20F(r)%20=%20r%5E2">. So, <img src="https://latex.codecogs.com/png.latex?r%20=%20%5Csqrt%7Bu%7D">. Thus, <img src="https://latex.codecogs.com/png.latex?R%20%5Cstackrel%7Bdef%7D%7B=%7D%20F%5E%7B-1%7D(U)%20=%20%5Csqrt%7BU%7D"> must have the CDF <img src="https://latex.codecogs.com/png.latex?F_R(r)%20=%20r%5E2"> and density <img src="https://latex.codecogs.com/png.latex?f_R(r)%20=%202r">. We also pick <img src="https://latex.codecogs.com/png.latex?%5CTheta%20%5Csim%20U%5B0,2%5Cpi%5D">. If we project the point <img src="https://latex.codecogs.com/png.latex?%5Cleft(r,%20%5Ctheta%20%5Cright)"> onto the <img src="https://latex.codecogs.com/png.latex?x">- and <img src="https://latex.codecogs.com/png.latex?y">-axis, then we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AX%20&amp;=%20%5Csqrt%7BU%7D%20%5Ccos%20%5CTheta%5C%5C%0AY%20&amp;=%20%5Csqrt%7BU%7D%20%5Csin%20%5CTheta%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Then, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Af_%7BX,Y%7D(x,y)%20&amp;=%20f_%7BR,%5CTheta%7D(r(x,y),%5Ctheta(x,y))%20%5Cfrac%7B%5Cpartial(r,%5Ctheta)%7D%7B%5Cpartial(x,y)%7D%5C%5C%0A&amp;=%202r%20%5Ccdot%20%5Cfrac%7B1%7D%7B2%5Cpi%7D%20%5Cleft%7C%5Cbegin%7Bmatrix%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20x%7D%20%5Cfrac%7B1%7D%7B%5Csqrt%7Bx%5E2%20+%20y%5E2%7D%7D%20&amp;%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20y%7D%20%5Cfrac%7B1%7D%7B%5Csqrt%7Bx%5E2%20+%20y%5E2%7D%7D%20%5C%5C%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20x%7D%20%5Carctan%20(y/x)%20&amp;%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20y%7D%20%5Carctan%20(y/x)%0A%5Cend%7Bmatrix%7D%5Cright%7C%5C%5C%0A&amp;=%202%5Csqrt%7Bx%5E2%20+%20y%5E2%7D%20%5Ccdot%20%5Cfrac%7B1%7D%7B2%5Cpi%7D%20%5Cleft%7C%5Cbegin%7Bmatrix%7D%0A%5Cfrac%7Bx%7D%7B%5Csqrt%7Bx%5E2%20+%20y%5E2%7D%7D%20&amp;%20%5Cfrac%7By%7D%7B%5Csqrt%7Bx%5E2%20+%20y%5E2%7D%7D%20%5C%5C%0A-%5Cfrac%7By%7D%7Bx%5E2%20+%20y%5E2%7D%20&amp;%20%5Cfrac%7Bx%7D%7Bx%5E2%20+%20y%5E2%7D%0A%5Cend%7Bmatrix%7D%5Cright%7C.%5C%5C%0A&amp;%20=%20%5Cfrac%7B1%7D%7B%5Cpi%7D%0A%5Cend%7Balign*%7D%0A"></p>
<section id="numerical-simulation" class="level2">
<h2 class="anchored" data-anchor-id="numerical-simulation">Numerical simulation</h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.patches <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> patches</span>
<span id="cb1-4"></span>
<span id="cb1-5">u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.uniform(low<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, high<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb1-6">r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(u)</span>
<span id="cb1-7">theta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.random.uniform(low<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, high<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb1-8">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.cos(theta)</span>
<span id="cb1-9">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.sin(theta)</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create fig and axes</span></span>
<span id="cb1-12">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use patches.Circle() to create the circle. The xy argument is a tuple for the center (x,y) and radius is a float</span></span>
<span id="cb1-15">circle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> patches.Circle((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>), radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the circle to the axes</span></span>
<span id="cb1-18">ax.add_patch(circle)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the (x,y) samples to the axes using the 'scatter' method</span></span>
<span id="cb1-21">ax.scatter(x, y, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure the aspect ratio is equal so the circle isn't distorted</span></span>
<span id="cb1-24">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>)</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the plot limits</span></span>
<span id="cb1-27">ax.set_xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-28">ax.set_ylim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-29"></span>
<span id="cb1-30">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Uniform sampling from the unit circle'</span>)</span>
<span id="cb1-31">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="http://quantdev.blog/posts/sampling-uniformly-on-the-unit-disk/index_files/figure-html/cell-2-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>Quant Puzzles</category>
  <guid>http://quantdev.blog/posts/sampling-uniformly-on-the-unit-disk/index.html</guid>
  <pubDate>Mon, 20 Oct 2025 23:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/sampling-uniformly-on-the-unit-disk/image.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Gaussian Processes</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/gaussian-processes/index.html</link>
  <description><![CDATA[ 




<section id="gaussian-processes." class="level1">
<h1>Gaussian Processes.</h1>
<section id="random-vectors." class="level2">
<h2 class="anchored" data-anchor-id="random-vectors.">Random Vectors.</h2>
<p>Consider a probability space <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Cmathbb%7BP%7D)">. We can define several random variables on <img src="https://latex.codecogs.com/png.latex?%5COmega">. A <img src="https://latex.codecogs.com/png.latex?n">-tuple of random variables on this space is called a random vector. For example, if <img src="https://latex.codecogs.com/png.latex?X_%7B1%7D,X_%7B2%7D,%5Cldots,X_%7Bn%7D"> are random variables on <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Cmathbb%7BP%7D)">, then the <img src="https://latex.codecogs.com/png.latex?n">-tuple <img src="https://latex.codecogs.com/png.latex?(X_%7B1%7D,X_%7B2%7D,%5Cldots,X_%7Bn%7D)"> is a random vector on <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Cmathbb%7BP%7D)">. The vector is said to be <img src="https://latex.codecogs.com/png.latex?n">-dimensional because it contains <img src="https://latex.codecogs.com/png.latex?n">-variables. We will sometimes denote a random vector by <img src="https://latex.codecogs.com/png.latex?X">.</p>
<p>A good point of view is to think of a random vector <img src="https://latex.codecogs.com/png.latex?X=(X_%7B1%7D,%5Cldots,X_%7Bn%7D)"> as a random variable (point) in <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D%5E%7Bn%7D">. In other words, for an outcome <img src="https://latex.codecogs.com/png.latex?%5Comega%5Cin%5COmega">, <img src="https://latex.codecogs.com/png.latex?X(%5Comega)"> is a point sampled in <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D%5E%7Bn%7D">, where <img src="https://latex.codecogs.com/png.latex?X_%7Bj%7D(%5Comega)"> represents the <img src="https://latex.codecogs.com/png.latex?j">-th coordinate of the point. The distribution of <img src="https://latex.codecogs.com/png.latex?X">, denoted <img src="https://latex.codecogs.com/png.latex?%5Cmu_%7BX%7D"> is the probability on <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D%5E%7Bn%7D">defined by the events related to the values of <img src="https://latex.codecogs.com/png.latex?X">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D%5C%7BX%5Cin%20A%5C%7D=%5Cmu_%7BX%7D(A)%5Cquad%5Ctext%7Bfor%20a%20subset%20%7DA%5Ctext%7B%20in%20%7D%5Cmathbf%7BR%7D%5E%7Bn%7D"></p>
<p>In other words, <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(X%5Cin%20A)=%5Cmu_%7BX%7D(A)"> is the probability that the random point <img src="https://latex.codecogs.com/png.latex?X"> falls in <img src="https://latex.codecogs.com/png.latex?A">. The distribution of the vector <img src="https://latex.codecogs.com/png.latex?X"> is also called the joint distribution of <img src="https://latex.codecogs.com/png.latex?(X_%7B1%7D,%5Cldots,X_%7Bn%7D)">.</p>
<div id="def-joint-distribution" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 1 (Joint Distribution) </strong></span>The <strong>joint distribution function</strong> of <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BX%7D=(X,Y)"> is the function <img src="https://latex.codecogs.com/png.latex?F:%5Cmathbf%7BR%7D%5E%7B2%7D%5Cto%5B0,1%5D"> given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?F_%7B%5Cmathbf%7BX%7D%7D(x,y)=%5Cmathbb%7BP%7D(X%5Cleq%20x,Y%5Cleq%20y)"></p>
</div>
<div id="def-joint-density-function" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 2 (Joint density) </strong></span>The joint <strong>PDF</strong> <img src="https://latex.codecogs.com/png.latex?f_%7B%5Cmathbf%7BX%7D%7D(x_%7B1%7D,%5Cldots,x_%7Bn%7D)"> of a random vector <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BX%7D"> is a function <img src="https://latex.codecogs.com/png.latex?f_%7B%5Cmathbf%7BX%7D%7D:%5Cmathbf%7BR%7D%5E%7Bn%7D%5Cto%5Cmathbf%7BR%7D"> such that the probability that <img src="https://latex.codecogs.com/png.latex?X"> falls in a subset <img src="https://latex.codecogs.com/png.latex?A"> of <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D%5E%7Bn%7D"> and is expressed as the multiple integral of <img src="https://latex.codecogs.com/png.latex?f(x_%7B1%7D,x_%7B2,%7D%5Cldots,x_%7Bn%7D)"> over <img src="https://latex.codecogs.com/png.latex?A">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(X%5Cin%20A)=%5Cint_%7BA%7Df(x_%7B1%7D,x_%7B2%7D,%5Cldots,x_%7Bn%7D)dx_%7B1%7Ddx_%7B2%7D%5Cldots%20dx_%7Bn%7D"></p>
</div>
<p>Note that: we must have that the integral of <img src="https://latex.codecogs.com/png.latex?f"> over the whole of <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D%5E%7Bn%7D"> is <img src="https://latex.codecogs.com/png.latex?1">.</p>
<p>If <img src="https://latex.codecogs.com/png.latex?F"> is differentiable at the point <img src="https://latex.codecogs.com/png.latex?(x,y)">, then we usually specify:</p>
<p><img src="https://latex.codecogs.com/png.latex?f(x,y)=%5Cfrac%7B%5Cpartial%5E%7B2%7D%7D%7B%5Cpartial%20x%5Cpartial%20y%7DF(x,y)"></p>
<div id="thm-law-of-total-probability" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1 (Law of total probability) </strong></span>Let <img src="https://latex.codecogs.com/png.latex?(X,Y)"> be the random variables with joint density function <img src="https://latex.codecogs.com/png.latex?f_%7BX,Y%7D(x,y)">. The marginal density function <img src="https://latex.codecogs.com/png.latex?f_%7BX%7D(x)"> and <img src="https://latex.codecogs.com/png.latex?f_%7BY%7D(y)"> of the random variables <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> respectively is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Af_%7BX%7D(x)%20&amp;%20=%5Cint_%7B-%5Cinfty%7D%5E%7B+%5Cinfty%7Df_%7B(X,Y)%7D(x,y)dy%5C%5C%20f_%7BY%7D(y)%20&amp;%20=%5Cint_%7B-%5Cinfty%7D%5E%7B+%5Cinfty%7Df_%7B(X,Y)%7D(x,y)dx%5Cend%7Baligned%7D"></p>
</div>
<p><em>Proof.</em></p>
<p>We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0AF_%7BX%7D(x)%20&amp;%20=P(X%5Cleq%20x)%5C%5C%20&amp;%20=%5Cint_%7B-%5Cinfty%7D%5E%7Bx%7D%5Cint_%7By=-%5Cinfty%7D%5E%7By=+%5Cinfty%7Df(x,y)dydx%5Cend%7Baligned%7D"></p>
<p>Differentiating both sides with respect to <img src="https://latex.codecogs.com/png.latex?x">,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Af_%7BX%7D(x)%20&amp;%20=%5Cint_%7By=-%5Cinfty%7D%5E%7By=+%5Cinfty%7Df(x,y)dydx%5Cend%7Baligned%7D">&nbsp;</p>
<p>This closes the proof. <img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
<div id="def-conditional-density-function" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 3 (Conditional density function) </strong></span>For continuous random variables <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> with the joint density function <img src="https://latex.codecogs.com/png.latex?f_%7B(X,Y)%7D">, the conditional density of <img src="https://latex.codecogs.com/png.latex?Y"> given <img src="https://latex.codecogs.com/png.latex?X=x"> is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Af_%7BY%7CX%7D(y%7Cx)%20&amp;%20=%5Cfrac%7Bf_%7B(X,Y)%7D(x,y)%7D%7Bf_%7BX%7D(x)%7D%5Cend%7Baligned%7D"></p>
<p>for all <img src="https://latex.codecogs.com/png.latex?x"> with <img src="https://latex.codecogs.com/png.latex?f_%7BX%7D(x)%3E0">. This is considered as a function of <img src="https://latex.codecogs.com/png.latex?y"> for a fixed <img src="https://latex.codecogs.com/png.latex?x">. As a convention, in order to make <img src="https://latex.codecogs.com/png.latex?f_%7BY%7CX%7D(y%7Cx)"> well-defined for all real <img src="https://latex.codecogs.com/png.latex?x">, let <img src="https://latex.codecogs.com/png.latex?f_%7BY%7CX%7D(y%7Cx)=0"> for all <img src="https://latex.codecogs.com/png.latex?x"> with <img src="https://latex.codecogs.com/png.latex?f_%7BX%7D(x)=0">.</p>
</div>
<p>We are essentially slicing the the joint density function of <img src="https://latex.codecogs.com/png.latex?f_%7B(X,Y)%7D(x,y)"> by a thin plane <img src="https://latex.codecogs.com/png.latex?X=x">. How can we speak of conditioning on <img src="https://latex.codecogs.com/png.latex?X=x"> for <img src="https://latex.codecogs.com/png.latex?X"> being a continuous random variable, considering that this event has probability zero. Rigorously speaking, we are actually conditioning on the event that <img src="https://latex.codecogs.com/png.latex?X"> falls within a small interval containing <img src="https://latex.codecogs.com/png.latex?x">, say <img src="https://latex.codecogs.com/png.latex?X%5Cin(x-%5Cepsilon,x+%5Cepsilon)"> and then taking the limit as <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> approaches zero from the right.</p>
<p>We can recover the joint PDF <img src="https://latex.codecogs.com/png.latex?f_%7B(X,Y)%7D"> if we have the conditional PDF <img src="https://latex.codecogs.com/png.latex?f_%7BY%7CX%7D"> and the corresponding marginal <img src="https://latex.codecogs.com/png.latex?f_%7BX%7D">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Af_%7B(X,Y)%7D(x,y)%20&amp;%20=f_%7BY%7CX%7D(y%7Cx)%5Ccdot%20f_%7BX%7D(x)%0A%5Cend%7Baligned%7D%0A"></p>
<div id="thm-bayes-rule-and-lotp" class="theorem">
<p><span class="theorem-title"><strong>Theorem 2 (Bayes rule and LOTP) </strong></span>Let <img src="https://latex.codecogs.com/png.latex?(X,Y)"> be continuous random variables. We have the following continuous form of the Bayes rule:</p>
<p><img src="https://latex.codecogs.com/png.latex?f_%7BY%7CX%7D(y%7Cx)=%5Cfrac%7Bf_%7BX%7CY%7D(x%7Cy)%5Ccdot%20f_%7BY%7D(y)%7D%7Bf_%7BX%7D(x)%7D"></p>
<p>And we have the following continuous form of the law of total probability:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Af_%7BX%7D(x)%20&amp;%20=%5Cint_%7By=-%5Cinfty%7D%5E%7By=+%5Cinfty%7Df_%7BX%7CY%7D(x%7Cy)%5Ccdot%20f_%7BY%7D(y)dy%5Cend%7Baligned%7D"></p>
</div>
<p><em>Proof.</em></p>
<p>By the definition of conditional PDFs, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Af_%7BX%7CY%7D(x%7Cy)%5Ccdot%20f_%7BY%7D(y)%20&amp;%20=f_%7B(X,Y)%7D(x,y)=f_%7BY%7CX%7D(y%7Cx)%5Ccdot%20f_%7BX%7D(x)%5Cend%7Baligned%7D%0A"></p>
<p>Dividing throughout by <img src="https://latex.codecogs.com/png.latex?f_%7BX%7D(x)">, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Af_%7BY%7CX%7D(x)%20&amp;%20=%5Cfrac%7Bf_%7BX%7CY%7D(x%7Cy)%5Ccdot%20f_%7BY%7D(y)%7D%7Bf_%7BX%7D(x)%7D=%5Cfrac%7Bf_%7B(X,Y)%7D(x,y)%7D%7Bf_%7BX%7D(x)%7D%5Cend%7Baligned%7D%0A">&nbsp;</p>
<p>This closes the proof. <img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
<div id="exm-sampling-uniformly" class="theorem example">
<p><span class="theorem-title"><strong>Example 1 </strong></span>(Sampling uniformly in the unit disc). Consider the random vector <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BX%7D=(X,Y)"> corresponding to a random point chosen uniformly in the unit disc <img src="https://latex.codecogs.com/png.latex?%5C%7B(x,y):x%5E%7B2%7D+y%5E%7B2%7D%5Cleq1%5C%7D">. <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BX%7D"> is said to have uniform on the unit circle distribution. In this case the PDF is <img src="https://latex.codecogs.com/png.latex?0"> outside the disc and <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B%5Cpi%7D"> inside the disc:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Af(x,y)%20&amp;%20=%5Cfrac%7B1%7D%7B%5Cpi%7D%5Cquad%5Ctext%7B%20if%20%7Dx%5E%7B2%7D+y%5E%7B2%7D%5Cleq1%5Cend%7Baligned%7D"></p>
<p>The random point <img src="https://latex.codecogs.com/png.latex?(X,Y)"> has <img src="https://latex.codecogs.com/png.latex?x">-coordinate <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> coordinate <img src="https://latex.codecogs.com/png.latex?Y">. Each of these are random variables and their PDFs and CDFs can be computed. This is a valid PDF, because:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cint%5Cint_%7BD%7Df(x,y)dydx%20&amp;%20=%5Cint_%7B-1%7D%5E%7B1%7D%5Cint_%7B-%5Csqrt%7B1-x%5E%7B2%7D%7D%7D%5E%7B%5Csqrt%7B1-x%5E%7B2%7D%7D%7D%5Cfrac%7B1%7D%7B%5Cpi%7Ddydx%5C%5C%20&amp;%20=%5Cfrac%7B1%7D%7B%5Cpi%7D%5Cint_%7B-1%7D%5E%7B1%7D%5Cleft%5By%5Cright%5D_%7B-%5Csqrt%7B1-x%5E%7B2%7D%7D%7D%5E%7B+%5Csqrt%7B1-x%5E%7B2%7D%7D%7Ddx%5C%5C%20&amp;%20=%5Cfrac%7B2%7D%7B%5Cpi%7D%5Cint_%7B-1%7D%5E%7B1%7D%5Csqrt%7B1-x%5E%7B2%7D%7Ddx%5Cend%7Baligned%7D"></p>
<p>Substituting <img src="https://latex.codecogs.com/png.latex?x=%5Csin%5Ctheta">, we have: <img src="https://latex.codecogs.com/png.latex?dx=%5Ccos%5Ctheta%20d%5Ctheta"> and <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7B1-x%5E%7B2%7D%7D=%5Ccos%5Ctheta">. The limits of integration are <img src="https://latex.codecogs.com/png.latex?%5Ctheta=-%5Cpi/2"> to <img src="https://latex.codecogs.com/png.latex?%5Ctheta=%5Cpi/2">. Thus,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cint%5Cint_%7BD%7Df(x,y)dydx%20&amp;%20=%5Cfrac%7B2%7D%7B%5Cpi%7D%5Cint_%7B-%5Cpi/2%7D%5E%7B%5Cpi/2%7D%5Ccos%5E%7B2%7D%5Ctheta%20d%5Ctheta%5C%5C%20&amp;%20=%5Cfrac%7B1%7D%7B%5Cpi%7D%5Cint_%7B-%5Cpi/2%7D%5E%7B%5Cpi/2%7D(1+%5Ccos2%5Ctheta)d%5Ctheta%5C%5C%20&amp;%20=%5Cfrac%7B1%7D%7B%5Cpi%7D%5Cleft%5B%5Ctheta+%5Cfrac%7B1%7D%7B2%7D%5Csin2%5Ctheta%5Cright%5D_%7B-%5Cpi/2%7D%5E%7B%5Cpi/2%7D%5C%5C%20&amp;%20=%5Cfrac%7B1%7D%7B%5Cpi%7D%5Ccdot%5Cpi%5C%5C%20&amp;%20=1%5Cend%7Baligned%7D"></p>
<p>The CDF of <img src="https://latex.codecogs.com/png.latex?X"> is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0AF_%7BX%7D(a)%20&amp;%20=%5Cint_%7B-1%7D%5E%7Ba%7D%5Cint_%7B-%5Csqrt%7B1-x%5E%7B2%7D%7D%7D%5E%7B%5Csqrt%7B1-x%5E%7B2%7D%7D%7D%5Cfrac%7B1%7D%7B%5Cpi%7Ddydx%5C%5C%20&amp;%20=%5Cfrac%7B2%7D%7B%5Cpi%7D%5Cint_%7B-1%7D%5E%7Ba%7D%5Csqrt%7B1-x%5E%7B2%7D%7Ddx%5Cend%7Baligned%7D"></p>
<p>I leave it in this integral form. The PDF of <img src="https://latex.codecogs.com/png.latex?X"> is obtained by differentiating the CDF, so it is:</p>
<p><img src="https://latex.codecogs.com/png.latex?f_%7BX%7D(x)=%5Cfrac%7B2%7D%7B%5Cpi%7D%5Csqrt%7B1-x%5E%7B2%7D%7D%5Clabel%7Beq:marginal-pdf-of-X%7D"></p>
</div>
<p>Let’s quickly plot the density of <img src="https://latex.codecogs.com/png.latex?X"> over the domain of the definition <img src="https://latex.codecogs.com/png.latex?-1%5Cleq%20x%5Cleq1">.</p>
<p>::: center Figure. The PDF of the random variable <img src="https://latex.codecogs.com/png.latex?X">. :::</p>
<p>Not suprisingly the distribution of the <img src="https://latex.codecogs.com/png.latex?x">-coordinate is no longer uniform!</p>
<p>If <img src="https://latex.codecogs.com/png.latex?(X_%7B1%7D,X_%7B2%7D,%5Cldots,X_%7Bn%7D)"> is a random vector, the distribution of a single coordinate, say <img src="https://latex.codecogs.com/png.latex?X_%7B1%7D"> is called the <em>marginal distribution</em>. In the example [Uniform-on-the-unit-circle-distribution], the marginal distribution of <img src="https://latex.codecogs.com/png.latex?X"> is determined by the PDF [eq:marginal-pdf-of-X].</p>
<p>Random variables <img src="https://latex.codecogs.com/png.latex?X_%7B1%7D,X_%7B2%7D,%5Cldots,X_%7Bn%7D"> defined on the same probability space are said to be independent if for any intervals <img src="https://latex.codecogs.com/png.latex?A_%7B1%7D,A_%7B2%7D,%5Cldots,A_%7Bn%7D"> in <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D">, the probability factors:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(X_%7B1%7D%5Cin%20A_%7B1%7D,X_%7B2%7D%5Cin%20A_%7B2%7D,%5Cldots,X_%7Bn%7D%5Cin%20A_%7Bn%7D)=%5Cmathbb%7BP%7D(X_%7B1%7D%5Cin%20A_%7B1%7D)%5Ctimes%5Cmathbb%7BP%7D(X_%7B2%7D%5Cin%20A_%7B2%7D)%5Ctimes%5Cldots%5Ctimes%5Cmathbb%7BP%7D(X_%7Bn%7D%5Cin%20A_%7Bn%7D)"> We say that the random variables are independent and identically distributed (IID) if they are independent and their marginal distributions are the same.</p>
<p>When the random vector <img src="https://latex.codecogs.com/png.latex?(X_%7B1%7D,X_%7B2%7D,%5Cldots,X_%7Bn%7D)"> has a joint PDF <img src="https://latex.codecogs.com/png.latex?f(x_%7B1%7D,x_%7B2%7D,%5Cldots,x_%7Bn%7D)">, the independence of random variables is equivalent to saying that the joint PDF is given by the product of the marginal PDFs:</p>
<p><img src="https://latex.codecogs.com/png.latex?f(x_%7B1%7D,x_%7B2%7D,%5Cldots,x_%7Bn%7D)=f_%7B1%7D(x_%7B1%7D)%5Ctimes%20f_%7B2%7D(x_%7B2%7D)%5Ctimes%5Cldots%5Ctimes%20f_%7Bn%7D(x_%7Bn%7D)"></p>
</section>
<section id="basic-probabilistic-inequalities." class="level2">
<h2 class="anchored" data-anchor-id="basic-probabilistic-inequalities.">Basic Probabilistic Inequalities.</h2>
<p>Inequalities are extremely useful tools in the theoretical development of probability theory.</p>
<section id="jensens-inequality." class="level3">
<h3 class="anchored" data-anchor-id="jensens-inequality.">Jensen’s inequality.</h3>
<div id="thm-jensens-inequality" class="theorem">
<p><span class="theorem-title"><strong>Theorem 3 </strong></span>If <img src="https://latex.codecogs.com/png.latex?g"> is a convex function, and <img src="https://latex.codecogs.com/png.latex?a%3E0">, <img src="https://latex.codecogs.com/png.latex?b%3E0">, with <img src="https://latex.codecogs.com/png.latex?p%5Cin%5B0,1%5D">, it follows that:</p>
<p><img src="https://latex.codecogs.com/png.latex?g(pa+(1-p)b)%5Cleq%20pg(a)+(1-p)g(b)"></p>
</div>
<p><em>Proof.</em> This directly follows from the definition of convex functions.&nbsp;<img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
</section>
<section id="jensens-inequality-for-random-variables." class="level3">
<h3 class="anchored" data-anchor-id="jensens-inequality-for-random-variables.">Jensen’s inequality for Random variables.</h3>
<div id="thm-jensens-inequality-for-random-variables" class="theorem">
<p><span class="theorem-title"><strong>Theorem 4 </strong></span>If <img src="https://latex.codecogs.com/png.latex?g"> is a convex function, then it follows that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D(g(X))%5Cgeq%20g(%5Cmathbb%7BE%7DX)"></p>
</div>
<p><em>Proof.</em></p>
<p>Another way to express the idea, that a function is convex is to observe that the tangent line at an arbitrary point <img src="https://latex.codecogs.com/png.latex?(t,g(t))"> always lies below the curve. Let <img src="https://latex.codecogs.com/png.latex?y=a+bx"> be the tangent to <img src="https://latex.codecogs.com/png.latex?g"> at the point <img src="https://latex.codecogs.com/png.latex?t">. Then, it follows that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Aa+bt%20&amp;%20=g(t)%5C%5C%20a+bx%20&amp;%20%5Cleq%20g(x)%5Cend%7Baligned%7D"></p>
<p>for all <img src="https://latex.codecogs.com/png.latex?x">.</p>
<p>Thus, it follows that, for any point <img src="https://latex.codecogs.com/png.latex?t">, there exists <img src="https://latex.codecogs.com/png.latex?b"> such that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Ag(x)-g(t)%20&amp;%20%5Cgeq%20b(x-t)%5Cend%7Baligned%7D"></p>
<p>for all <img src="https://latex.codecogs.com/png.latex?x">. Set <img src="https://latex.codecogs.com/png.latex?t=%5Cmathbb%7BE%7DX"> and <img src="https://latex.codecogs.com/png.latex?x=X">. Then,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Ag(X)-g(%5Cmathbb%7BE%7DX)%20&amp;%20%5Cgeq%20b(X-%5Cmathbb%7BE%7DX)%5Cend%7Baligned%7D"></p>
<p>Taking expectations on both sides and simplifying:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbb%7BE%7D%5Cleft(g(X)%5Cright)-g(%5Cmathbb%7BE%7DX)%20&amp;%20%5Cgeq%20b(%5Cmathbb%7BE%7DX-%5Cmathbb%7BE%7DX)=0%5C%5C%20%5Cmathbb%7BE%7Dg(X)%20&amp;%20%5Cgeq%20g(%5Cmathbb%7BE%7DX)%5Cend%7Baligned%7D">&nbsp;</p>
<p>This closes the proof. <img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
</section>
<section id="youngs-inequality." class="level3">
<h3 class="anchored" data-anchor-id="youngs-inequality.">Young’s Inequality.</h3>
<div id="thm-youngs-inequality" class="theorem">
<p><span class="theorem-title"><strong>Theorem 5 </strong></span>If <img src="https://latex.codecogs.com/png.latex?a%5Cgeq0"> and <strong><img src="https://latex.codecogs.com/png.latex?b%5Cgeq0"></strong> are non-negative real numbers and if <img src="https://latex.codecogs.com/png.latex?p%3E1"> and <img src="https://latex.codecogs.com/png.latex?q%3E1"> are real numbers such that <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7Bp%7D+%5Cfrac%7B1%7D%7Bq%7D=1">, then:</p>
<p><img src="https://latex.codecogs.com/png.latex?ab%5Cleq%5Cfrac%7Ba%5E%7Bp%7D%7D%7Bp%7D+%5Cfrac%7Bb%5E%7Bq%7D%7D%7Bq%7D"></p>
</div>
<p><em>Proof.</em></p>
<p>Consider <img src="https://latex.codecogs.com/png.latex?g(x)=%5Clog%20x">. Being a concave function, Jensen’s inequality can be reversed. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Ag%5Cleft(%5Cfrac%7B1%7D%7Bp%7Da%5E%7Bp%7D+%5Cfrac%7B1%7D%7Bq%7Db%5E%7Bq%7D%5Cright)%20&amp;%20%5Cgeq%5Cfrac%7B1%7D%7Bp%7Dg(a%5E%7Bp%7D)+%5Cfrac%7B1%7D%7Bq%7Dg(b%5E%7Bq%7D)%5C%5C%20%5Clog%5Cleft(%5Cfrac%7B1%7D%7Bp%7Da%5E%7Bp%7D+%5Cfrac%7B1%7D%7Bq%7Db%5E%7Bq%7D%5Cright)%20&amp;%20%5Cgeq%5Cfrac%7B1%7D%7Bp%7D%5Clog(a%5E%7Bp%7D)+%5Cfrac%7B1%7D%7Bq%7D%5Clog(b%5E%7Bq%7D)%5C%5C%20%5Clog%5Cleft(%5Cfrac%7B1%7D%7Bp%7Da%5E%7Bp%7D+%5Cfrac%7B1%7D%7Bq%7Db%5E%7Bq%7D%5Cright)%20&amp;%20%5Cgeq%5Cfrac%7B1%7D%7Bp%7D%5Ccdot%20p%5Clog(a)+%5Cfrac%7B1%7D%7Bq%7D%5Ccdot%20q%5Clog(b)%5C%5C%20%5Clog%5Cleft(%5Cfrac%7B1%7D%7Bp%7Da%5E%7Bp%7D+%5Cfrac%7B1%7D%7Bq%7Db%5E%7Bq%7D%5Cright)%20&amp;%20%5Cgeq%5Clog%20ab%5Cend%7Baligned%7D"></p>
<p>By the Monotonicity of the <img src="https://latex.codecogs.com/png.latex?%5Clog%20x"> function, it follows that :</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Aab%20&amp;%20%5Cleq%5Cfrac%7Ba%5E%7Bp%7D%7D%7Bp%7D+%5Cfrac%7Bb%5E%7Bq%7D%7D%7Bq%7D%5Cend%7Baligned%7D">&nbsp;</p>
<p>This closes the proof. <img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
</section>
<section id="chebyshevs-inequality." class="level3">
<h3 class="anchored" data-anchor-id="chebyshevs-inequality.">Chebyshev’s inequality.</h3>
<p>One of the simplest and very useful probabilistic inequalities is a tail bound by expectation: the so called Chebyshev’s inequality.</p>
<div id="thm-chebyshevs-inequality" class="theorem">
<p><span class="theorem-title"><strong>Theorem 6 (Chebyshev’s inequality) </strong></span>If <img src="https://latex.codecogs.com/png.latex?X"> is a non-negative random variable, then for every <img src="https://latex.codecogs.com/png.latex?t%5Cgeq0">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(X%5Cgeq%20t)%5Cleq%5Cfrac%7B1%7D%7Bt%7D%5Cmathbb%7BE%7DX"></p>
</div>
<p><em>Proof.</em></p>
<p>We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0At%5Ccdot%5Cmathbf%7B1%7D_%7B%5C%7BX%5Cgeq%20t%5C%7D%7D%20&amp;%20%5Cleq%20X%5Ccdot%5Cmathbf%7B1%7D_%7B%5C%7BX%5Cgeq%20t%5C%7D%7D%5Cend%7Baligned%7D"></p>
<p>By the monotonicity of expectations, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbb%7BE%7D%5Cmathbf%7B1%7D_%7B%5C%7BX%5Cgeq%20t%5C%7D%7D%20&amp;%20%5Cleq%5Cfrac%7B1%7D%7Bt%7D%5Cmathbb%7BE%7DX%5C%5C%20%5Cimplies%5Cmathbb%7BP%7D%5C%7BX%5Cgeq%20t%5C%7D%20&amp;%20%5Cleq%5Cfrac%7B1%7D%7Bt%7D%5Cmathbb%7BE%7DX%5Cend%7Baligned%7D"></p>
<p>This closes the proof.&nbsp;<img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
<p>There are several variants, easily deduced from Chebyshev’s inequality using monotonicity of several functions. For a non-negative random variable <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?t%3E0">, using the power function <img src="https://latex.codecogs.com/png.latex?x%5E%7Bp%7D">, <img src="https://latex.codecogs.com/png.latex?p%3E0">, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(X%5Cgeq%20t)=%5Cmathbb%7BP%7D(X%5E%7Bp%7D%5Cgeq%20t%5E%7Bp%7D)%5Cleq%5Cfrac%7B1%7D%7Bt%5E%7Bp%7D%7D%5Cmathbb%7BE%7DX%5E%7Bp%7D"></p>
<p>For a real valued random variable <img src="https://latex.codecogs.com/png.latex?X">, every <img src="https://latex.codecogs.com/png.latex?t%5Cin%5Cmathbf%7BR%7D">, using the square function <img src="https://latex.codecogs.com/png.latex?x%5E%7B2%7D"> and variance, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(%7CX-%5Cmathbb%7BE%7DX%7C%5Cgeq%20t)%5Cleq%5Cfrac%7B1%7D%7Bt%5E%7B2%7D%7D%5Cmathbb%7BE%7D%7CX-%5Cmathbb%7BE%7DX%7C%5E%7B2%7D=%5Cfrac%7B1%7D%7Bt%5E%7B2%7D%7DVar(X)"></p>
<p>For a real-valued random variable <img src="https://latex.codecogs.com/png.latex?X">, every <img src="https://latex.codecogs.com/png.latex?t%5Cin%5Cmathbf%7BR%7D"> and <img src="https://latex.codecogs.com/png.latex?%5Clambda%3E0">, using the exponential function <img src="https://latex.codecogs.com/png.latex?e%5E%7B%5Clambda%20x%7D">(which is monotonic), we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(X%5Cgeq%20t)=%5Cmathbb%7BP%7D(%5Clambda%20X%5Cgeq%5Clambda%20t)=%5Cmathbb%7BP%7D(e%5E%7B%5Clambda%20X%7D%5Cgeq%20e%5E%7B%5Clambda%20t%7D)%5Cleq%5Cfrac%7B1%7D%7Be%5E%7B%5Clambda%20t%7D%7D%5Cmathbb%7BE%7De%5E%7B%5Clambda%20X%7D"></p>
<p>Our next inequality, the so-called Holder’s inequality is a very effective inequality to factor out the expectation of a product.</p>
</section>
<section id="holders-inequality." class="level3">
<h3 class="anchored" data-anchor-id="holders-inequality.">Holder’s inequality.</h3>
<div id="thm-holders-inequality" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7 </strong></span>Let <img src="https://latex.codecogs.com/png.latex?p,q%5Cgeq1"> be such that <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7Bp%7D+%5Cfrac%7B1%7D%7Bq%7D=1">, For random variables <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y">, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbb%7BE%7D%7CXY%7C%20&amp;%20%5Cleq%5Cleft(%5Cmathbb%7BE%7D%7CX%5E%7Bp%7D%7C%5Cright)%5E%7B1/p%7D%5Cleft(%5Cmathbb%7BE%7D%7CY%5E%7Bq%7D%7C%5Cright)%5E%7B1/q%7D%5Cend%7Baligned%7D"></p>
</div>
<p><em>Proof.</em> From the Young’s inequality, for any <img src="https://latex.codecogs.com/png.latex?a,b%5Cin%5Cmathbf%7BR%7D">, <img src="https://latex.codecogs.com/png.latex?p,q%5Cgeq1">, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Aab%20&amp;%20%5Cleq%5Cfrac%7Ba%5E%7Bp%7D%7D%7Bp%7D+%5Cfrac%7Bb%5E%7Bq%7D%7D%7Bq%7D%5Cend%7Baligned%7D"></p>
<p>Setting <img src="https://latex.codecogs.com/png.latex?a=%5Cfrac%7B%7CX%7C%7D%7B%5Cleft(%5Cmathbb%7BE%7D%7CX%5E%7Bp%7D%7C%5Cright)%5E%7B1/p%7D%7D"> and <img src="https://latex.codecogs.com/png.latex?b=%5Cfrac%7B%7CY%7C%7D%7B%5Cleft(%5Cmathbb%7BE%7D%7CY%5E%7Bq%7D%7C%5Cright)%5E%7B1/q%7D%7D">, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cfrac%7B%7CXY%7C%7D%7B%5Cleft(%5Cmathbb%7BE%7D%7CX%5E%7Bp%7D%7C%5Cright)%5E%7B1/p%7D%5Cleft(%5Cmathbb%7BE%7D%7CY%5E%7Bq%7D%7C%5Cright)%5E%7B1/q%7D%7D%20&amp;%20%5Cleq%5Cfrac%7B1%7D%7Bp%7D%5Ccdot%5Cfrac%7B%7CX%7C%5E%7Bp%7D%7D%7B%5Cmathbb%7BE%7D%7CX%5E%7Bp%7D%7C%7D+%5Cfrac%7B1%7D%7Bq%7D%5Ccdot%5Cfrac%7B%7CY%7C%5E%7Bq%7D%7D%7B%5Cmathbb%7BE%7D%7CY%5E%7Bq%7D%7C%7D%5Cend%7Baligned%7D"></p>
<p>Taking expectations on both sides, and using the monotonicity of expectation property, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cfrac%7B%5Cmathbb%7BE%7D%7CXY%7C%7D%7B%5Cleft(%5Cmathbb%7BE%7D%7CX%5E%7Bp%7D%7C%5Cright)%5E%7B1/p%7D%5Cleft(%5Cmathbb%7BE%7D%7CY%5E%7Bq%7D%7C%5Cright)%5E%7B1/q%7D%7D%20&amp;%20%5Cleq%5Cfrac%7B1%7D%7Bp%7D%5Ccdot%5Cfrac%7B%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D%7D%7B%5Cmathbb%7BE%7D%7CX%5E%7Bp%7D%7C%7D+%5Cfrac%7B1%7D%7Bq%7D%5Ccdot%5Cfrac%7B%5Cmathbb%7BE%7D%7CY%7C%5E%7Bq%7D%7D%7B%5Cmathbb%7BE%7D%7CY%5E%7Bq%7D%7C%7D=%5Cfrac%7B1%7D%7Bp%7D+%5Cfrac%7B1%7D%7Bq%7D=1%5Cend%7Baligned%7D"></p>
<p>Consequently,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbb%7BE%7D%7CXY%7C%20&amp;%20%5Cleq%5Cleft(%5Cmathbb%7BE%7D%7CX%5E%7Bp%7D%7C%5Cright)%5E%7B1/p%7D%5Cleft(%5Cmathbb%7BE%7D%7CY%5E%7Bq%7D%7C%5Cright)%5E%7B1/q%7D%5Cend%7Baligned%7D"></p>
<p>Let <img src="https://latex.codecogs.com/png.latex?p=2"> and <img src="https://latex.codecogs.com/png.latex?q=2">. Then, we get the Cauchy-Schwarz inequality:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbb%7BE%7D%7CXY%7C%20&amp;%20%5Cleq%5Cleft%5B%5Cmathbb%7BE%7D(X%5E%7B2%7D)%5Cright%5D%5E%7B1/2%7D%5Cleft%5B%5Cmathbb%7BE%7D(Y%5E%7B2%7D)%5Cright%5D%5E%7B1/2%7D%5Cend%7Baligned%7D"></p>
<p>In some ways, the <img src="https://latex.codecogs.com/png.latex?p">-th moment of a random variable can be thought of as it’s length or <img src="https://latex.codecogs.com/png.latex?p">-norm.</p>
<p>Define:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D=%5Cleft(%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D">&nbsp;</p>
<p>This closes the proof. <img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
</section>
<section id="minkowskis-inequality." class="level3">
<h3 class="anchored" data-anchor-id="minkowskis-inequality.">Minkowski’s Inequality.</h3>
<div id="thm-minkowskis-inequality" class="theorem">
<p><span class="theorem-title"><strong>Theorem 8 </strong></span>For random variables <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y">, and for all <img src="https://latex.codecogs.com/png.latex?p%5Cgeq1"> we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20X+Y%5Cright%5CVert%20_%7Bp%7D%5Cleq%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D+%5Cleft%5CVert%20Y%5Cright%5CVert%20_%7Bp%7D"></p>
</div>
<p><em>Proof.</em></p>
<p>The basic idea of the proof is to use Holder’s inequality. Let <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7Bq%7D=1-%5Cfrac%7B1%7D%7Bp%7D"> or in other words, <img src="https://latex.codecogs.com/png.latex?q=%5Cfrac%7Bp%7D%7Bp-1%7D">. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbb%7BE%7D%7CX%7C%7CX+Y%7C%5E%7Bp-1%7D%20&amp;%20%5Cleq%5Cleft(%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%5Cleft(%5Cmathbb%7BE%7D%7CX+Y%7C%5E%7B(p-1)q%7D%5Cright)%5E%7B1/q%7D%20&amp;%20(a)%5C%5C%20%5Cmathbb%7BE%7D%7CY%7C%7CX+Y%7C%5E%7Bp-1%7D%20&amp;%20%5Cleq%5Cleft(%5Cmathbb%7BE%7D%7CY%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%5Cleft(%5Cmathbb%7BE%7D%7CX+Y%7C%5E%7B(p-1)q%7D%5Cright)%5E%7B1/q%7D%20&amp;%20(b)%5Cend%7Baligned%7D"></p>
<p>Adding the above two equations, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbb%7BE%7D(%7CX+Y%7C%7CX+Y%7C%5E%7Bp-1%7D)%5Cleq%5Cmathbb%7BE%7D(%7CX%7C+%7CY%7C)(%7CX+Y%7C%5E%7Bp-1%7D)%20&amp;%20%5Cleq%5Cleft%5C%7B%20%5Cleft(%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D+%5Cleft(%5Cmathbb%7BE%7D%7CY%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%5Cright%5C%7D%20%5Cleft(%5Cmathbb%7BE%7D%7CX+Y%7C%5E%7B(p-1)q%7D%5Cright)%5E%7B1/q%7D%5C%5C%20%5Cmathbb%7BE%7D%7CX+Y%7C%5E%7Bp%7D%20&amp;%20%5Cleq%5Cleft%5C%7B%20%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D+%5Cleft%5CVert%20Y%5Cright%5CVert%20_%7Bp%7D%5Cright%5C%7D%20%5Cleft(%5Cmathbb%7BE%7D%7CX+Y%7C%5E%7Bp%7D%5Cright)%5E%7B1/q%7D%5C%5C%20%5Cleft(%5Cmathbb%7BE%7D%7CX+Y%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%20&amp;%20%5Cleq%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D+%5Cleft%5CVert%20Y%5Cright%5CVert%20_%7Bp%7D%5C%5C%20%5Cleft%5CVert%20X+Y%5Cright%5CVert%20_%7Bp%7D%20&amp;%20%5Cleq%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D+%5Cleft%5CVert%20Y%5Cright%5CVert%20_%7Bp%7D%5Cend%7Baligned%7D">&nbsp;</p>
<p>This closes the proof. <img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
</section>
</section>
<section id="a-quick-refresher-of-linear-algebra." class="level2">
<h2 class="anchored" data-anchor-id="a-quick-refresher-of-linear-algebra.">A quick refresher of linear algebra.</h2>
<p>Many of the concepts in this chapter have very elegant interpretations, if we think of real-valued random variables on a probability space as vectors in a vector space. In particular, variance is related to the concept of norm and distance, while covariance is related to inner-products. These concepts can help unify some of the ideas in this chapter from a geometric point of view. Of course, real-valued random variables are simply measurable, real-valued functions on the abstract space <img src="https://latex.codecogs.com/png.latex?%5COmega."></p>
<div id="def-vector-space" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 4 (Vector Space.) </strong></span>By a vector space, we mean a non-empty set <img src="https://latex.codecogs.com/png.latex?V"> with two operations: :::</p>
<ul>
<li><p>Vector addition: <img src="https://latex.codecogs.com/png.latex?+:(%5Cmathbf%7Bx%7D,%5Cmathbf%7By%7D)%5Cto%5Cmathbf%7Bx%7D+%5Cmathbf%7By%7D"></p></li>
<li><p>Scalar multiplication: <img src="https://latex.codecogs.com/png.latex?%5Ccdot:(%5Calpha,%5Cmathbf%7Bx%7D)%5Cto%5Calpha%5Cmathbf%7Bx%7D"></p></li>
</ul>
<p>such that the following conditions are satisfied:</p>
<p>(A1) Commutativity. <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D+%5Cmathbf%7By%7D=%5Cmathbf%7By%7D+%5Cmathbf%7Bx%7D"> for all <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D,%5Cmathbf%7By%7D%5Cin%20V"></p>
<p>(A2) Associativity: <img src="https://latex.codecogs.com/png.latex?(%5Cmathbf%7Bx%7D+%5Cmathbf%7By%7D)+%5Cmathbf%7Bz%7D=%5Cmathbf%7Bx%7D+(%5Cmathbf%7By%7D+%5Cmathbf%7Bz%7D)"> for all <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D,%5Cmathbf%7By%7D,%5Cmathbf%7Bz%7D%5Cin%20V"></p>
<p>(A3) Zero Element: There exists a zero element, denoted <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7B0%7D"> in <img src="https://latex.codecogs.com/png.latex?V">, for all <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D%5Cin%20V">, such that <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D+%5Cmathbf%7B0%7D=%5Cmathbf%7Bx%7D">.</p>
<p>(A4) Additive Inverse: For all <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D%5Cin%20V">, there exists an additive inverse(negative element) denoted <img src="https://latex.codecogs.com/png.latex?-%5Cmathbf%7Bx%7D"> in <img src="https://latex.codecogs.com/png.latex?V">, such that <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D+(-%5Cmathbf%7Bx%7D)=%5Cmathbf%7B0%7D">.</p>
<p>(M1) Scalar multiplication by identity element in <img src="https://latex.codecogs.com/png.latex?F">: For all <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D%5Cin%20V">, <img src="https://latex.codecogs.com/png.latex?1%5Ccdot%5Cmathbf%7Bx%7D=%5Cmathbf%7Bx%7D">, where <img src="https://latex.codecogs.com/png.latex?1"> denotes the multiplicative identity in <img src="https://latex.codecogs.com/png.latex?F">.</p>
<p>(M2) Scalar multiplication and field multiplication mix well: For all <img src="https://latex.codecogs.com/png.latex?%5Calpha,%5Cbeta%5Cin%20F"> and <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bv%7D%5Cin%20V">, <img src="https://latex.codecogs.com/png.latex?(%5Calpha%5Cbeta)%5Cmathbf%7Bv%7D=%5Calpha(%5Cbeta%5Cmathbf%7Bv%7D)">.</p>
<p>(D1) Distribution of scalar multiplication over vector addition: For all <img src="https://latex.codecogs.com/png.latex?%5Calpha%5Cin%20F">, and <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bu%7D,%5Cmathbf%7Bv%7D%5Cin%20V">, <img src="https://latex.codecogs.com/png.latex?%5Calpha(%5Cmathbf%7Bu%7D+%5Cmathbf%7Bv%7D)=%5Calpha%5Cmathbf%7Bu%7D+%5Calpha%5Cmathbf%7Bv%7D">.</p>
<p>(D2) Distribution of field addition over scalar multiplication: For all <img src="https://latex.codecogs.com/png.latex?%5Calpha,%5Cbeta%5Cin%20F">, and <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bv%7D%5Cin%20V">, <img src="https://latex.codecogs.com/png.latex?(%5Calpha+%5Cbeta)%5Cmathbf%7Bv%7D=%5Calpha%5Cmathbf%7Bv%7D+%5Cbeta%5Cmathbf%7Bv%7D">.</p>
</div>
<p>As usual, our starting point is a random experiment modeled by a probability space <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Cmathbb%7BP%7D)">, so that <img src="https://latex.codecogs.com/png.latex?%5COmega"> is the set of outcomes, <img src="https://latex.codecogs.com/png.latex?%5Cmathscr%7B%5Cmathcal%7BF%7D%7D"> is the <img src="https://latex.codecogs.com/png.latex?%5Csigma">-algebra of events and <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D"> is the probability measure on the measurable space <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D)">. Our basic vector space <img src="https://latex.codecogs.com/png.latex?V"> consists of all real-valued random variables defined on <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Cmathbb%7BP%7D)">. We define vector addition and scalar multiplication in the usual way point-wise.</p>
<ul>
<li><p>Vector addition: <img src="https://latex.codecogs.com/png.latex?(X+Y)(%5Comega)=X(%5Comega)+Y(%5Comega)">.</p></li>
<li><p>Scalar multiplication: <img src="https://latex.codecogs.com/png.latex?(%5Calpha%20X)(%5Comega)=%5Calpha%20X(%5Comega)"></p></li>
</ul>
<p>Clearly, any function <img src="https://latex.codecogs.com/png.latex?g"> of a random variable <img src="https://latex.codecogs.com/png.latex?X(%5Comega)"> is also a random variable on the same probability space and any linear combination of random variables on <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Cmathbb%7BP%7D)"> also define a new random variable on the same probability space. Thus, <img src="https://latex.codecogs.com/png.latex?V"> is closed under vector addition and scalar-multiplication. Since vector-addition and scalar multiplication is defined point-wise, it is easy to see that - all the axioms of a vector space (A1)-(A4), (M1-M2), (D1), (D2) are satisfied. The constantly zero random variable <img src="https://latex.codecogs.com/png.latex?0(%5Comega)=0"> and the indicator random variable <img src="https://latex.codecogs.com/png.latex?I_%7B%5COmega%7D(%5Comega)"> can be thought of as the zero and identity vectors in this vector space.</p>
<p>Clearly, any function <img src="https://latex.codecogs.com/png.latex?g"> of a random variable <img src="https://latex.codecogs.com/png.latex?X(%5Comega)"> is also a random variable on the same probability space and any linear combination of random variables on <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Cmathbb%7BP%7D)"> also define a new random variable on the same probability space. Thus, <img src="https://latex.codecogs.com/png.latex?V"> is closed under vector addition and scalar-multiplication. Since vector-addition and scalar multiplication is defined point-wise, it is easy to see that - all the axioms of a vector space (A1)-(A4), (M1-M2), (D1), (D2) are satisfied. The constantly zero random variable <img src="https://latex.codecogs.com/png.latex?0(%5Comega)=0"> and the indicator random variable <img src="https://latex.codecogs.com/png.latex?I_%7B%5COmega%7D(%5Comega)"> can be thought of as the zero and identity vectors in this vector space.</p>
<section id="inner-products." class="level3">
<h3 class="anchored" data-anchor-id="inner-products.">Inner Products.</h3>
<p>In Euclidean geometry, the angle between two vectors is specified by their dot product, which is itself formalized by the abstract concept of inner products.</p>
<div id="def-inner-product" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 5 (Inner Product.) </strong></span>An inner product on the real vector space <img src="https://latex.codecogs.com/png.latex?V"> is a pairing that takes two vectors <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bv%7D,%5Cmathbf%7Bw%7D%5Cin%20V"> and produces a real number <img src="https://latex.codecogs.com/png.latex?%5Cleft%5Clangle%20%5Cmathbf%7Bv%7D,%5Cmathbf%7Bw%7D%5Cright%5Crangle%20%5Cin%5Cmathbf%7BR%7D">. The inner product is required to satisfy the following three axioms for all <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bu%7D,%5Cmathbf%7Bv%7D,%5Cmathbf%7Bw%7D%5Cin%20V"> and scalars <img src="https://latex.codecogs.com/png.latex?c,d%5Cin%5Cmathbf%7BR%7D">.</p>
<ol type="1">
<li>Bilinearity: <img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5Clangle%20c%5Cmathbf%7Bu%7D+d%5Cmathbf%7Bv%7D,%5Cmathbf%7Bw%7D%5Cright%5Crangle%20=c%5Cleft%5Clangle%20%5Cmathbf%7Bu%7D,%5Cmathbf%7Bw%7D%5Cright%5Crangle%20+d%5Cleft%5Clangle%20%5Cmathbf%7Bv%7D,%5Cmathbf%7Bw%7D%5Cright%5Crangle%0A"></li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5Clangle%20%5Cmathbf%7Bu%7D,c%5Cmathbf%7Bv%7D+d%5Cmathbf%7Bw%7D%5Cright%5Crangle%20=c%5Cleft%5Clangle%20%5Cmathbf%7Bu%7D,%5Cmathbf%7Bv%7D%5Cright%5Crangle%20+d%5Cleft%5Clangle%20%5Cmathbf%7Bu%7D,%5Cmathbf%7Bw%7D%5Cright%5Crangle%0A"></p>
<ol start="2" type="1">
<li>Symmetry:</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5Clangle%20%5Cmathbf%7Bv%7D,%5Cmathbf%7Bw%7D%5Cright%5Crangle%20=%5Cleft%5Clangle%20%5Cmathbf%7Bw%7D,%5Cmathbf%7Bv%7D%5Cright%5Crangle%0A"></p>
<ol start="3" type="1">
<li>Positive Definiteness:</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5Clangle%20%5Cmathbf%7Bv%7D,%5Cmathbf%7Bv%7D%5Cright%5Crangle%20%3E0%5Cquad%5Ctext%7B%20whenever%20%7D%5Cmathbf%7Bv%5Cneq%5Cmathbf%7B0%7D%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5Clangle%20%5Cmathbf%7Bv%7D,%5Cmathbf%7Bv%7D%5Cright%5Crangle%20=0%5Cquad%5Ctext%7B%20whenever%20%7D%5Cmathbf%7Bv=0%7D%0A"></p>
</div>
<div id="def-norm" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6 </strong></span>(Norm). A norm on a real vector space <img src="https://latex.codecogs.com/png.latex?V"> is a function <img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20%5Ccdot%5Cright%5CVert%20:V%5Cto%5Cmathbf%7BR%7D"> satisfying :</p>
<p>(i) Positive Definiteness.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20%5Cmathbf%7Bv%7D%5Cright%5CVert%20%5Cgeq0"></p>
<p>and <img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20%5Cmathbf%7Bv%7D%5Cright%5CVert%20=0%5Cquad%5Ctext%7Bif%20and%20only%20if%20%7D%5Cmathbf%7Bv%7D=%5Cmathbf%7B0%7D"></p>
<p>(ii) Scalar multiplication.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20%5Calpha%5Cmathbf%7Bv%7D%5Cright%5CVert%20=%7C%5Calpha%7C%5Cleft%5CVert%20%5Cmathbf%7Bv%7D%5Cright%5CVert"></p>
<p>(iii) Triangle Inequality.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20%5Cmathbf%7Bx+y%7D%5Cright%5CVert%20%5Cleq%5Cleft%5CVert%20%5Cmathbf%7Bx%7D%5Cright%5CVert%20+%5Cleft%5CVert%20%5Cmathbf%7By%7D%5Cright%5CVert"></p>
</div>
<p>As mentioned earlier, we can define the <img src="https://latex.codecogs.com/png.latex?p">-norm of a random variable as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D%20&amp;%20=%5Cleft(%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>(i) Positive semi-definiteness: Since <img src="https://latex.codecogs.com/png.latex?%7CX%7C"> is a non-negative random variable, <img src="https://latex.codecogs.com/png.latex?%7CX%7C%5E%7Bp%7D%5Cgeq0"> and the expectation of a non-negative random variable is also non-negative. Hence, <img src="https://latex.codecogs.com/png.latex?(%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D)%5E%7B1/p%7D%5Cgeq0">. Moreover, <img src="https://latex.codecogs.com/png.latex?%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D=0"> implies that <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D=0">. From property (iv) of expectations, <img src="https://latex.codecogs.com/png.latex?X=0">.</p>
<p>(ii) Scalar-multiplication: We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cleft%5CVert%20cX%5Cright%5CVert%20_%7Bp%7D%20&amp;%20=%5Cleft(%5Cmathbb%7BE%7D%7CcX%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%5C%5C%0A&amp;%20=%5Cleft(%7Cc%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%5Cleft(%5Cmathbb%7BE%7D%7CX%7C%5E%7Bp%7D%5Cright)%5E%7B1/p%7D%5C%5C%0A&amp;%20=%7Cc%7C%5Ccdot%5Cleft%5CVert%20X%5Cright%5CVert%20_%7Bp%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>(iii) Triangle Inequality. This followed from the Minkowski’s inequality.</p>
<p>The space of all random variables defined on <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7B%5Cmathcal%7BF%7D%7D,%5Cmathbb%7BP%7D)"> such that <img src="https://latex.codecogs.com/png.latex?%7C%7CX%7C%7C_%7Bp%7D%3C%5Cinfty"> is finite is called the <img src="https://latex.codecogs.com/png.latex?L%5E%7Bp%7D"> space.</p>
</section>
<section id="orthogonal-matrices." class="level3">
<h3 class="anchored" data-anchor-id="orthogonal-matrices.">Orthogonal Matrices.</h3>
<div id="def-orthogonal-matrices" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7 (Orthogonal Matrix.) </strong></span>Let <img src="https://latex.codecogs.com/png.latex?A"> be an <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20n"> square matrix. We say that the matrix <img src="https://latex.codecogs.com/png.latex?A"> is orthogonal, if its transpose is equal toits inverse.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AA'%20&amp;%20=A%5E%7B-1%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>This may seem like an odd property to study, but the following theorem explains why it is so useful. Essentially, an orthogonal matrix rotates (or reflects) vectors without distorting angles or distances.</p>
<div id="prp-properties-of-orthogonal-matrix" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 1 (Properties of an orthogonal matrix) </strong></span>Faor an <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20n"> square matrix <img src="https://latex.codecogs.com/png.latex?A">, the following are equivalent:</p>
<p>(1) <img src="https://latex.codecogs.com/png.latex?A"> is orthogonal. That is, <img src="https://latex.codecogs.com/png.latex?A'A=I">.</p>
<p>(2) <img src="https://latex.codecogs.com/png.latex?A"> preserves norms. That is, for all <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D">,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cleft%5CVert%20A%5Cmathbf%7Bx%7D%5Cright%5CVert%20&amp;=%5Cleft%5CVert%20%5Cmathbf%7Bx%7D%5Cright%5CVert%20%5Cend%7Baligned%7D"></p>
<p>(3) <img src="https://latex.codecogs.com/png.latex?A"> preserves inner products, that is, for every <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D">, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7By%7D"><img src="https://latex.codecogs.com/png.latex?%5Cin%5Cmathbf%7BR%7D%5E%7Bn%7D">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A(A%5Cmathbf%7Bx%7D)%5Ccdot(A%5Cmathbf%7By%7D)%20&amp;=%5Cmathbf%7Bx%7D%5Ccdot%5Cmathbf%7By%7D%5Cend%7Baligned%7D"></p>
</div>
<p><em>Proof.</em></p>
<p>We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cleft%5CVert%20A%5Cmathbf%7Bx%7D%5Cright%5CVert%20%5E%7B2%7D%20&amp;%20=%5Cleft(A%5Cmathbf%7Bx%7D%5Cright)'(A%5Cmathbf%7Bx%7D)%5C%5C%0A&amp;%20=%5Cmathbf%7Bx%7D'(A'A)%5Cmathbf%7Bx%7D%5C%5C%0A&amp;%20=%5Cmathbf%7Bx%7D'I%5Cmathbf%7Bx%7D%5C%5C%0A&amp;%20=%5Cmathbf%7Bx%7D'%5Cmathbf%7Bx%7D%5C%5C%0A&amp;%20=%7C%7C%5Cmathbf%7Bx%7D%7C%7C%5E%7B2%7D%5Cend%7Baligned%7D"></p>
<p>Consequently, <img src="https://latex.codecogs.com/png.latex?%7C%7CA%5Cmathbf%7Bx%7D%7C%7C=%7C%7C%5Cmathbf%7Bx%7D%7C%7C">. The matrix <img src="https://latex.codecogs.com/png.latex?A"> preserves norms. Thus, (1) implies (2).</p>
<p>Moreover, consider</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%7C%7CA(%5Cmathbf%7Bx%7D+%5Cmathbf%7By%7D)%7C%7C%5E%7B2%7D%20&amp;%20=%5Cleft(A%5Cmathbf%7Bx%7D+A%5Cmathbf%7By%7D%5Cright)%5Ccdot%5Cleft(A%5Cmathbf%7Bx%7D+A%5Cmathbf%7By%7D%5Cright)%5C%5C%0A&amp;%20=(A%5Cmathbf%7Bx%7D)%5Ccdot(A%5Cmathbf%7Bx%7D)+(A%5Cmathbf%7Bx%7D)%5Ccdot(A%5Cmathbf%7By%7D)+(A%5Cmathbf%7By%7D)%5Ccdot(A%5Cmathbf%7Bx%7D)+(A%5Cmathbf%7By%7D)%5Ccdot(A%5Cmathbf%7By%7D)%5C%5C%0A&amp;%20=%7C%7CA%5Cmathbf%7Bx%7D%7C%7C%5E%7B2%7D+2(A%5Cmathbf%7Bx%7D)%5Ccdot(A%5Cmathbf%7By%7D)+%7C%7CA%5Cmathbf%7By%7D%7C%7C%5E%7B2%7D%20&amp;%20%5C%7B%5Cmathbf%7Bx%7D%5Ccdot%5Cmathbf%7By%7D=%5Cmathbf%7By%7D%5Ccdot%5Cmathbf%7Bx%7D%5C%7D%5C%5C%0A&amp;%20=%7C%7C%5Cmathbf%7Bx%7D%7C%7C%5E%7B2%7D+2(A%5Cmathbf%7Bx%7D)%5Ccdot(A%5Cmathbf%7By%7D)+%7C%7C%5Cmathbf%7By%7D%7C%7C%5E%7B2%7D%20&amp;%20%5C%7BA%5Ctext%7B%20preserves%20norms%7D%5C%7D%5Cend%7Baligned%7D"></p>
<p>But, <img src="https://latex.codecogs.com/png.latex?%7C%7CA(%5Cmathbf%7Bx%7D+%5Cmathbf%7By%7D)%7C%7C%5E%7B2%7D=%7C%7C%5Cmathbf%7Bx%7D+%5Cmathbf%7By%7D%7C%7C%5E%7B2%7D=%7C%7C%5Cmathbf%7Bx%7D%7C%7C%5E%7B2%7D+2%5Cmathbf%7Bx%7D%5Ccdot%5Cmathbf%7By%7D+%7C%7C%5Cmathbf%7By%7D%7C%7C%5E%7B2%7D">.</p>
<p>Equating the two expressions, we have the desired result. Hence, (2) implies (3).</p>
<p>Lastly, if <img src="https://latex.codecogs.com/png.latex?A"> preserves inner products, we may write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cleft%5Clangle%20A%5Cmathbf%7Bx%7D,A%5Cmathbf%7Bx%7D%5Cright%5Crangle%20%20&amp;%20=%5Cleft%5Clangle%20%5Cmathbf%7Bx%7D,%5Cmathbf%7Bx%7D%5Cright%5Crangle%20%5C%5C%0A%5Cleft(A%5Cmathbf%7Bx%7D%5Cright)'(A%5Cmathbf%7Bx%7D)%20&amp;%20=%5Cmathbf%7Bx%7D'%5Cmathbf%7Bx%7D%5C%5C%0A%5Cmathbf%7Bx%7D'A'A%5Cmathbf%7Bx%7D%20&amp;%20=0%5Cend%7Baligned%7D"></p>
<p>Since <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D%5Cneq%5Cmathbf%7B0%7D">, it must be true that <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D'A'A-%5Cmathbf%7Bx%7D'=0">. Again, since <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D'%5Cneq%5Cmathbf%7B0%7D">, it follows that <img src="https://latex.codecogs.com/png.latex?A'A-I=0">.</p>
<div id="thm-linear-independence-of-orthogonal-vectors" class="theorem">
<p><span class="theorem-title"><strong>Theorem 9 (Linear Independence of orthogonal vectors) </strong></span>If <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bq%7D_%7B1%7D,%5Cmathbf%7Bq%7D_%7B2%7D,%5Cldots,%5Cmathbf%7Bq%7D_%7Bk%7D%5Cin%20V"> be mutually orthogonal elements, such that <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bq%7D_%7Bi%7D%5Cneq%5Cmathbf%7B0%7D"> for all <img src="https://latex.codecogs.com/png.latex?i">, then <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bq%7D_%7B1%7D,%5Cmathbf%7Bq%7D_%7B2%7D,%5Cldots,%5Cmathbf%7Bq%7D_%7Bk%7D"> are linearly independent.</p>
</div>
<p><em>Proof.</em></p>
<p>Let</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0Ac_%7B1%7D%5Cmathbf%7Bq%7D_%7B1%7D+c_%7B2%7D%5Cmathbf%7Bq%7D_%7B2%7D+%5Cldots+c_%7Bk%7D%5Cmathbf%7Bq%7D_%7Bk%7D%20&amp;%20=%5Cmathbf%7B0%7D%5Cend%7Baligned%7D"></p>
<p>Since <img src="https://latex.codecogs.com/png.latex?%5Cleft%5Clangle%20%5Cmathbf%7Bq%7D_%7Bi%7D,%5Cmathbf%7Bq%7D_%7Bi%7D%5Cright%5Crangle%20=1"> and <img src="https://latex.codecogs.com/png.latex?%5Cleft%5Clangle%20%5Cmathbf%7Bq%7D_%7Bi%7D,%5Cmathbf%7Bq%7D_%7Bj%7D%5Cright%5Crangle%20=0"> where <img src="https://latex.codecogs.com/png.latex?i%5Cneq%20j">, we can take the inner product of the vector <img src="https://latex.codecogs.com/png.latex?c_1%20%5Cmathbf%7Bq%7D_%7B1%7D%20+%20c_2%20%5Cmathbf%7Bq%7D_%7B2%7D%20+%20%5Cldots%20+%20c_i%20%5Cmathbf%7Bq%7D_%7Bi%7D+%5Cldots%20+%20c_%7Bk%7D%5Cmathbf%7Bq%7D_%7Bk%7D"> with <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bq%7D_%7Bi%7D"> for each <img src="https://latex.codecogs.com/png.latex?i=1,2,3,%5Cldots,k">. It results in <img src="https://latex.codecogs.com/png.latex?c_%7Bi%7D%7C%7C%5Cmathbf%7Bq%7D_%7Bi%7D%7C%7C%5E%7B2%7D=0">. Since <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bq%7D_%7Bi%7D%5Cneq%5Cmathbf%7B0%7D">, <img src="https://latex.codecogs.com/png.latex?%7C%7C%5Cmathbf%7Bq%7D_%7Bi%7D%7C%7C%5E%7B2%7D%3E0">. So, <img src="https://latex.codecogs.com/png.latex?c_%7Bi%7D=0">. We conclude that <img src="https://latex.codecogs.com/png.latex?c_%7B1%7D=c_%7B2%7D=%5Cldots=c_%7Bk%7D%20=0">. Consequently, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bq%7D_%7B1%7D,%5Cmathbf%7Bq%7D_%7B2%7D,%5Cldots,%5Cmathbf%7Bq%7D_%7Bk%7D"> are linearly independent.&nbsp;<img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
<div id="thm-orthogonal-vectors-form-a-basis" class="theorem">
<p><span class="theorem-title"><strong>Theorem 10 (Orthogonal vectors form a basis) </strong></span>Let <img src="https://latex.codecogs.com/png.latex?Q=%5Cleft%5B%5Cbegin%7Barray%7D%7Bcccc%7D%20%5Cmathbf%7Bq%7D_%7B1%7D%20&amp;%20%5Cmathbf%7Bq%7D_%7B2%7D%20&amp;%20%5Cldots%20&amp;%20%5Cmathbf%7Bq%7D_%7Bn%7D%5Cend%7Barray%7D%5Cright%5D"> be an <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20n"> orthogonal matrix. Then, <img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cmathbf%7Bq%7D_%7B1%7D,%5Cldots,%5Cmathbf%7Bq%7D_%7Bn%7D%5C%7D"> form an orthonormal basis for <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D%5E%7Bn%7D">.</p>
</div>
<p><em>Proof.</em></p>
<p>We have <img src="https://latex.codecogs.com/png.latex?Q%5Cmathbf%7Be%7D_%7Bi%7D=%5Cmathbf%7Bq%7D_%7Bi%7D">. Consequently,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cleft%5Clangle%20%5Cmathbf%7Bq%7D_%7Bi%7D,%5Cmathbf%7Bq%7D_%7Bi%7D%5Cright%5Crangle%20%20&amp;%20=%5Cmathbf%7Bq%7D_%7Bi%7D'%5Cmathbf%7Bq%7D_%7Bi%7D%5C%5C%0A&amp;%20=(Q%5Cmathbf%7Be%7D_%7Bi%7D)'(Q%5Cmathbf%7Be%7D_%7Bi%7D)%5C%5C%0A&amp;%20=%5Cmathbf%7Be%7D_%7Bi%7D'Q'Q%5Cmathbf%7Be%7D_%7Bi%7D%5C%5C%0A&amp;%20=%5Cmathbf%7Be%7D_%7Bi%7D'I%5Cmathbf%7Be%7D_%7Bi%7D%5C%5C%0A&amp;%20=%5Cmathbf%7Be%7D_%7Bi%7D'%5Cmathbf%7Be%7D_%7Bi%7D%5C%5C%0A&amp;%20=1%5Cend%7Baligned%7D"></p>
<p>Assume that <img src="https://latex.codecogs.com/png.latex?i%5Cneq%20j">. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cleft%5Clangle%20%5Cmathbf%7Bq%7D_%7Bi%7D,%5Cmathbf%7Bq%7D_%7Bj%7D%5Cright%5Crangle%20%20&amp;%20=%5Cmathbf%7Bq%7D_%7Bi%7D'%5Cmathbf%7Bq%7D_%7Bj%7D%5C%5C%0A&amp;%20=%5Cmathbf%7Be%7D_%7Bi%7D'Q'Q%5Cmathbf%7Be%7D_%7Bj%7D%5C%5C%0A&amp;%20=%5Cmathbf%7Be%7D_%7Bi%7D'%5Cmathbf%7Be%7D_%7Bj%7D%5C%5C%0A&amp;%20=0%5Cend%7Baligned%7D"></p>
<p>From Theorem&nbsp;9, <img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cmathbf%7Bq%7D_%7B1%7D,%5Cldots,%5Cmathbf%7Bq%7D_%7Bn%7D%5C%7D"> are linearly independent and hence form an orthonormal basis for <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D%5E%7Bn%7D">.</p>
</section>
<section id="quadratic-forms." class="level3">
<h3 class="anchored" data-anchor-id="quadratic-forms.">Quadratic Forms.</h3>
<p>An expression of the form:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D'A%5Cmathbf%7Bx%7D"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D"> is a <img src="https://latex.codecogs.com/png.latex?n%5Ctimes1"> column vector and <img src="https://latex.codecogs.com/png.latex?A"> is an <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20n"> matrix is called a quadratic form in <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D"> and</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbf%7Bx%7D'A%5Cmathbf%7Bx%7D%20&amp;%20=%5Csum_%7Bi=1%7D%5E%7Bn%7D%5Csum_%7Bj=1%7D%5E%7Bn%7Da_%7Bij%7Dx_%7Bi%7Dx_%7Bj%7D%5Cend%7Baligned%7D"></p>
<p>If <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?B"> are <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20n"> and <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D,%5Cmathbf%7By%7D"> are <img src="https://latex.codecogs.com/png.latex?n">-vectors, then</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbf%7Bx%7D'(A+B)%5Cmathbf%7By%7D%20&amp;%20=%5Cmathbf%7Bx%7D'A%5Cmathbf%7By%7D+%5Cmathbf%7Bx%7D'B%5Cmathbf%7By%7D%5Cend%7Baligned%7D"></p>
<p>The quadratic form of the matrix <img src="https://latex.codecogs.com/png.latex?A"> is called positive definite if:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbf%7Bx%7D'A%5Cmathbf%7Bx%7D%20&amp;%20%3E0%5Cquad%5Ctext%7Bwhenever%20%7D%5Cmathbf%7Bx%7D%5Cneq%5Cmathbf%7B0%7D%5Cend%7Baligned%7D"></p>
<p>and positive semidefinite if:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cmathbf%7Bx%7D'A%5Cmathbf%7Bx%7D%20&amp;%20%5Cgeq0%5Cquad%5Ctext%7Bwhenever%20%7D%5Cmathbf%7Bx%7D%5Cneq%5Cmathbf%7B0%7D%5Cend%7Baligned%7D"></p>
<p>Letting <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Be%7D_%7Bi%7D"> be the unit vector with it’s <img src="https://latex.codecogs.com/png.latex?i">th coordinate vector <img src="https://latex.codecogs.com/png.latex?1">, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cmathbf%7Be%7D_%7Bi%7D'A%5Cmathbf%7Be%7D_%7Bi%7D%20&amp;%20=%5Cleft%5Ba_%7Bi1%7Da_%7Bi2%7D%5Cldots%20a_%7Bii%7D%5Cldots%20a_%7Bin%7D%5Cright%5D%5Cleft%5B%5Cbegin%7Barray%7D%7Bc%7D%0A0%5C%5C%0A0%5C%5C%0A%5Cvdots%5C%5C%0A1%5C%5C%0A%5Cvdots%5C%5C%0A0%0A%5Cend%7Barray%7D%5Cright%5D=a_%7Bii%7D%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="eigenthingies-and-diagonalizability." class="level3">
<h3 class="anchored" data-anchor-id="eigenthingies-and-diagonalizability.">Eigenthingies and diagonalizability.</h3>
<p>Let <img src="https://latex.codecogs.com/png.latex?V"> and <img src="https://latex.codecogs.com/png.latex?W"> be finite dimensional vector spaces with <img src="https://latex.codecogs.com/png.latex?dim(V)=n"> and <img src="https://latex.codecogs.com/png.latex?dim(W)=m">. A linear transformation <img src="https://latex.codecogs.com/png.latex?T:V%5Cto%20W">, is defined by its action on the basis vectors. Suppose:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AT(%5Cmathbf%7Bv%7D_%7Bj%7D)%20&amp;%20=%5Csum_%7Bi=1%7D%5E%7Bn%7Da_%7Bij%7D%5Cmathbf%7Bw%7D_%7Bi%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>for all <img src="https://latex.codecogs.com/png.latex?1%5Cleq%20i%5Cleq%20m">.</p>
<p>Then, the matrix <img src="https://latex.codecogs.com/png.latex?A=%5BT%5D_%7B%5Cmathcal%7BB%7D_%7BV%7D%7D%5E%7B%5Cmathcal%7BB%7D_%7BW%7D%7D"> of the linear transformation is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0AA%20&amp;%20=%5Cleft%5B%5Cbegin%7Barray%7D%7Bcccc%7D%0Aa_%7B11%7D%20&amp;%20a_%7B12%7D%20&amp;%20%5Cldots%20&amp;%20a_%7B1n%7D%5C%5C%0Aa_%7B21%7D%20&amp;%20a_%7B22%7D%20&amp;%20%5Cldots%20&amp;%20a_%7B2n%7D%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%5C%5C%0Aa_%7Bm1%7D%20&amp;%20a_%7Bm2%7D%20&amp;%20%5Cldots%20&amp;%20a_%7Bmn%7D%0A%5Cend%7Barray%7D%5Cright%5D%5Cend%7Baligned%7D"></p>
<div id="def-diagonalizable" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 8 </strong></span>A linear transformation <img src="https://latex.codecogs.com/png.latex?T:V%5Cto%20V"> is said to be <strong>diagonalizable</strong> if there exists an ordered basis <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BB%7D=%5C%7B%5Cmathbf%7Bv%7D_%7B1%7D,%5Cldots,%5Cmathbf%7Bv%7D_%7Bn%7D%5C%7D"> for <img src="https://latex.codecogs.com/png.latex?V"> so that the matrix for <img src="https://latex.codecogs.com/png.latex?T"> with respect to <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BB%7D"> is diagonal. This means precisely that, for some scalars <img src="https://latex.codecogs.com/png.latex?%5Clambda_%7B1%7D,%5Clambda_%7B2%7D,%5Cldots,%5Clambda_%7Bn%7D">, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AT(%5Cmathbf%7Bv%7D_%7B1%7D)%20&amp;%20=%5Clambda_%7B1%7D%5Cmathbf%7Bv%7D_%7B1%7D%5C%5C%0AT(%5Cmathbf%7Bv%7D_%7B2%7D)%20&amp;%20=%5Clambda_%7B2%7D%5Cmathbf%7Bv%7D_%7B2%7D%5C%5C%0A%5Cvdots%5C%5C%0AT(%5Cmathbf%7Bv%7D_%7Bn%7D)%20&amp;%20=%5Clambda_%7Bn%7D%5Cmathbf%7Bv%7D_%7Bn%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
<p>In other words, if <img src="https://latex.codecogs.com/png.latex?A=%5BT%5D_%7B%5Cmathcal%7BB%7D%7D">, then we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0AA%5Cmathbf%7Bv%7D_%7Bi%7D%20&amp;%20=%5Clambda_%7Bi%7D%5Cmathbf%7Bv%7D_%7Bi%7D%5Cend%7Baligned%7D"></p>
<p>Thus, if we let <img src="https://latex.codecogs.com/png.latex?P"> be the <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20n"> matrix whose columns are the vectors <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bv%7D_%7B1%7D,%5Cmathbf%7Bv%7D_%7B2%7D,%5Cldots,%5Cmathbf%7Bv%7D_%7Bn%7D"> and <img src="https://latex.codecogs.com/png.latex?%5CLambda"> be the <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20n"> diagonal matrix with diagonal entries <img src="https://latex.codecogs.com/png.latex?%5Clambda_%7B1%7D,%5Clambda_%7B2%7D,%5Cldots,%5Clambda_%7Bn%7D">, then we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0AA%5Cleft%5B%5Cbegin%7Barray%7D%7Bcccc%7D%0A%5Cmathbf%7Bv%7D_%7B1%7D%20&amp;%20%5Cmathbf%7Bv%7D_%7B2%7D%20&amp;%20%5Cldots%20&amp;%20%5Cmathbf%7Bv%7D_%7Bn%7D%5Cend%7Barray%7D%5Cright%5D%20&amp;%20=%5Cleft%5B%5Cbegin%7Barray%7D%7Bcccc%7D%0A%5Cmathbf%7Bv%7D_%7B1%7D%20&amp;%20%5Cmathbf%7Bv%7D_%7B2%7D%20&amp;%20%5Cldots%20&amp;%20%5Cmathbf%7Bv%7D_%7Bn%7D%5Cend%7Barray%7D%5Cright%5D%5Cleft%5B%5Cbegin%7Barray%7D%7Bcccc%7D%0A%5Clambda_%7B1%7D%5C%5C%0A&amp;%20%5Clambda_%7B2%7D%5C%5C%0A&amp;%20%20&amp;%20%5Cddots%5C%5C%0A&amp;%20%20&amp;%20%20&amp;%20%5Clambda_%7Bn%7D%0A%5Cend%7Barray%7D%5Cright%5D%5C%5C%0AAP%20&amp;%20=P%5CLambda%5C%5C%0AA%20&amp;%20=P%5CLambda%20P%5E%7B-1%7D%5Cend%7Baligned%7D"></p>
<p>There exists a large class of diagonalizable matrices - the symmetric matrices. A square matrix <img src="https://latex.codecogs.com/png.latex?A"> is symmetric, if <img src="https://latex.codecogs.com/png.latex?A=A'">.</p>
<div id="def-eigenvector" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 9 (Eigenvectors) </strong></span>Let <img src="https://latex.codecogs.com/png.latex?T:V%5Cto%20V"> be a linear transformation. A <strong>non-zero</strong> vector <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bv%7D%5Cin%20V"> is called the eigenvector of <img src="https://latex.codecogs.com/png.latex?T">, if there is a scalar <img src="https://latex.codecogs.com/png.latex?%5Clambda"> so that <img src="https://latex.codecogs.com/png.latex?T(%5Cmathbf%7Bv%7D)=%5Clambda%5Cmathbf%7Bv%7D">. The scalar <img src="https://latex.codecogs.com/png.latex?%5Clambda"> is called the eigenvalue of <img src="https://latex.codecogs.com/png.latex?T">.</p>
</div>


</section>
</section>
</section>

 ]]></description>
  <category>Fin Math</category>
  <guid>http://quantdev.blog/posts/gaussian-processes/index.html</guid>
  <pubDate>Sat, 18 Oct 2025 23:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/gaussian-processes/image.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>A short note on the Dupire PDE</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/dupire-pde/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>If the Black-Scholes model were good, the implied volatility <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Csigma%7D"> parameter would be the same for all call option market prices. However, in reality, Black-Scholes implied volatility depends strongly on strike <img src="https://latex.codecogs.com/png.latex?K">, and maturity <img src="https://latex.codecogs.com/png.latex?T">.</p>
<p>In Dupire’s 1993 paper, he proposes the following dynamics for the spot process:</p>
<p><span id="eq-local-volatility-model"><img src="https://latex.codecogs.com/png.latex?%0AdS_t%20=%20r(t)S_t%20dt%20+%20%5Csigma_%7BLV%7D(t,%20S_t)%20S_t%20dW_t%5E%7BQ%7D%0A%5Ctag%7B1%7D"></span></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7BLV%7D(t,S_t)"> is a deterministic function of the variables <img src="https://latex.codecogs.com/png.latex?(S_t,t)">.</p>
<p>The function <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7BLV%7D(t,s)"> such that the call option prices are given by the model in Equation&nbsp;1 coinicide with the market option prices <img src="https://latex.codecogs.com/png.latex?%5Chat%7BC%7D(K,T)"> is called <strong>local volatility</strong>.</p>
</section>
<section id="derivation-of-the-dupire-pde" class="level1">
<h1>Derivation of the Dupire PDE</h1>
<p>Recall, that the Fokker-Planck PDE describes the dynamics of the transition probability density forward in time. We represent the transition probability density function by <img src="https://latex.codecogs.com/png.latex?p(x,t)">. Were we to be more rigorous, we should write <img src="https://latex.codecogs.com/png.latex?p(x,t%7Cx_0,%20t_0)">. The call option price has a similar representation. It is a function of strike <img src="https://latex.codecogs.com/png.latex?K"> and expiration <img src="https://latex.codecogs.com/png.latex?T">, given the current spot value <img src="https://latex.codecogs.com/png.latex?S_t"> and current time <img src="https://latex.codecogs.com/png.latex?t">. So, its a function <img src="https://latex.codecogs.com/png.latex?C(K,T%20%7C%20S_t,%20t)">; we can suppress the variables <img src="https://latex.codecogs.com/png.latex?(S_t,%20t)"> and write <img src="https://latex.codecogs.com/png.latex?C(K,T)">. This is standard terminology in the industry.</p>
<p>The call option payoff at maturity <img src="https://latex.codecogs.com/png.latex?T"> is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AC(K,T%7CS_T,T)%20=%20(S_T%20-%20K)%5E%7B+%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>We can’t exactly apply Ito’s formula, but there is the Tanaka-Meyer formula - an implication of which is that we can use Ito’s lemma for the absolute value function and the maximum function.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0Ad(S_T%20-%20K)%5E%7B+%7D%20&amp;=%20%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20S_T%7D(S_T%20-%20K)%5E%7B+%7DdS_T%20+%20%5Cfrac%7B1%7D%7B2%7D%5Cfrac%7B%5Cpartial%5E2%7D%7B%5Cpartial%20S_T%5E2%7D%20(S_T%20-%20K)%5E%7B+%7D%20dS_T%5E2%0A%5Cend%7Baligned%7D%0A"></p>
<p>We can write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20S_T%7D(S_T%20-%20K)%5E%7B+%7D%20=%201_%7BS_T%20%3E%20K%7D%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20S_T%7D%20(S_T%20-%20K)%20=%201_%7BS_T%20%3E%20K%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Now, we calculate the second derivative:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%5E2%20S_T%7D(S_T%20-%20K)%5E%7B+%7D%20=%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20S_T%7D%201_%7BS_T%20%3E%20K%7D%20=%20%5Cdelta(S_T%20-%20K)%0A%5Cend%7Balign*%7D%0A"></p>
<p>The indicator function goes from <img src="https://latex.codecogs.com/png.latex?0"> to <img src="https://latex.codecogs.com/png.latex?1"> at <img src="https://latex.codecogs.com/png.latex?K">, so the derivative at <img src="https://latex.codecogs.com/png.latex?K"> is <img src="https://latex.codecogs.com/png.latex?%5Cinfty"> and <img src="https://latex.codecogs.com/png.latex?0"> otherwise, and this is basically the definition of the Dirac-Delta function. Now, we can substitute these derivatives into the Tanaka formula and get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ad(S_T%20-%20K)%5E%7B+%7D%20&amp;=%201_%7BS_T%20%3E%20K%7D%20dS_T%20+%20%5Cfrac%7B1%7D%7B2%7D%5Cdelta(S_T%20-%20K)dS_T%5E2%0A%5Cend%7Balign*%7D%0A"></p>
<p>Next, let’s calculate the partial derivatives of the payoff with respect to <img src="https://latex.codecogs.com/png.latex?K">. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D(S_T%20-%20K)%5E%7B+%7D%20=%201_%7BS_T%20%3E%20K%7D%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D%20(S_T%20-%20K)%20=%20-1_%7BS_T%20%3E%20K%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Differentiating this result again with respect to <img src="https://latex.codecogs.com/png.latex?K">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%5E2%7D%7B%5Cpartial%20K%5E2%7D%20(S_T%20-%20K)%5E%7B+%7D%20&amp;=%20-%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D%201_%7BS_T%20%3E%20K%7D%20%5C%5C%0A&amp;=%20-%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D1_%7BS_T%20-%20K%20%3E%200%7D%20%5C%5C%0A&amp;=%20-%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7DH(S_T%20-%20K)%0A%5Cend%7Balign*%7D%0A"></p>
<p>Define <img src="https://latex.codecogs.com/png.latex?y%20=%20(S_T%20-%20K)">. We have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%5E2%7D%7B%5Cpartial%20K%5E2%7D%20(S_T%20-%20K)%5E%7B+%7D%20&amp;=%20%20-%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7DH(S_T%20-%20K)%20%5C%5C%0A&amp;=-%5Cfrac%7B%5Cpartial%20H(y)%7D%7B%5Cpartial%20y%7D%5Ccdot%20%5Cfrac%7B%5Cpartial%20y%7D%7B%5Cpartial%20K%7D%5C%5C%0A&amp;=-%5Cdelta(y)%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D(S_T%20-%20K)%5C%5C%0A&amp;=%5Cdelta(S_T%20-%20K)%0A%5Cend%7Balign*%7D%0A"></p>
<p>Now, substituting for <img src="https://latex.codecogs.com/png.latex?dS_T"> and <img src="https://latex.codecogs.com/png.latex?dS_T%5E2"> in Ito’s lemma, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ad(S_T%20-%20K)%5E%7B+%7D%20&amp;=%201_%7BS_T%20%3E%20K%7D(rS_T%20dT%20+%20%5Csigma(S_T,%20T)S_TdW_T)%20+%20%5Cfrac%7B1%7D%7B2%7D%5Cdelta(S_T%20-%20K)%20%5Csigma(S_T,T)%5E2%20S_T%5E2%20dT%5C%5C%0A&amp;=%20%5Cleft(rS_T%201_%7BS_T%20%3E%20K%7D%20+%20%5Cfrac%7B1%7D%7B2%7D%5Cdelta(S_T%20-%20K)%5Csigma(S_T,T)%5E2%20S_T%5E2%20%5Cright)dT%20+%201_%7BS_T%20%3E%20K%7D%20%5Csigma(S_T,%20T)%20S_T%20dW_T%0A%5Cend%7Balign*%7D%0A"></p>
<p>Taking expectations on both sides, the <img src="https://latex.codecogs.com/png.latex?dB_T"> becomes zero. So, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D%5E%7B%5Cmathbb%7BQ%7D%7D%5Cleft%5Bd(S_T%20-%20K)%5E%7B+%7D%5Cright%5D%20=%5Cmathbb%7BE%7D%5E%7BQ%7D%5Cleft%5BrS_T1_%7BS_T%20%3E%20K%7D%20+%20%5Cfrac%7B1%7D%7B2%7D%5Csigma(S_T,T)%5E2%20S_T%5E2%5Cright%5DdT%0A%5Cend%7Balign*%7D%0A"></p>
<p>We are left with just the <img src="https://latex.codecogs.com/png.latex?dT"> term. Now, we can shift <img src="https://latex.codecogs.com/png.latex?dT"> to the LHS (interchange expectation and the derivative) to get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20T%7D%5Cmathbb%7BE%7D%5E%7BQ%7D%5Cleft%5Bd(S_T%20-%20K)%5E%7B+%7D%5Cright%5D%20&amp;=%5Cmathbb%7BE%7D%5E%7BQ%7D%5Cleft%5BrS_T1_%7BS_T%20%3E%20K%7D%20+%20%5Cfrac%7B1%7D%7B2%7D%5Csigma(S_T,T)%5E2%20S_T%5E2%5Cright%5D%5C%5C%0A&amp;=%20rS_T%20%5Cmathbb%7BE%7D%5E%7BQ%7D%5Cleft%5B1_%7BS_T%20%3E%20K%7D%5Cright%5D%20+%20%5Cfrac%7B1%7D%7B2%7D%5Cmathbb%7BE%7D%5E%7BQ%7D%5Cleft%5B%5Csigma(S_T,T)%5E2%20S_T%5E2%5Cright%5D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Let’s try to express the first term on the RHS by the call option price. We can write the payoff as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A(S_T%20-%20K)1_%7BS_T%20%3E%20K%7D%20%20=%20S_T%201_%7BS_T%20%3E%20K%7D%20-%20K%201_%7BS_T%20%3E%20K%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Now, we can rearrange the terms to get what we want:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AS_T1_%7BS_T%20%3E%20K%7D%20=%20(S_T%20-%20K)%201_%7BS_T%20%3E%20K%7D%20+%20K1_%7BS_T%20%3E%20K%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>We now take expectation on both sides, so we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D%5EQ%5BS_T%201_%7BS_T%20%3E%20K%7D%5D%20&amp;=%20%5Cmathbb%7BE%7D%5E%7BQ%7D%5B(S_T%20-%20K)1_%7BS_T%20%3E%20K%7D%5D%20+%20K%5Cmathbb%7BE%7D%5E%7BQ%7D%5B1_%7BS_T%20%3E%20K%7D%5D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Recall that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AC_%7BK,T%7D%20&amp;=%20e%5E%7B-rT%7D%20%5Cmathbb%7BE%7D%5E%7BQ%7D%5B(S_T%20-%20K)1_%7BS_T%20%3E%20K%7D%5D%20%5C%5C%0A%5Cimplies%20e%5E%7BrT%7D%20C(K,T)%20&amp;=%20%5Cmathbb%7BE%7D%5E%7BQ%7D%5B(S_T%20-%20K)1_%7BS_T%20%3E%20K%7D%5D%0A%5Cend%7Balign*%7D%0A"></p>
<p>So, our first expression is then the undiscounted value of the call option. Now, the second expression has got the indicator or the heavyside function, which we know is the derivative of the payoff. Let’s reproduce the risk-neutral valuation formula.</p>
<p><span id="eq-first-derivative-wrt-strike"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D%20C_%7BK,T%7D%20&amp;=%20e%5E%7B-rT%7D%20%5Cmathbb%7BE%7D%5E%7BQ%7D%5Cleft%5B%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D%20(S_T%20-%20K)%5E%7B+%7D%5Cright%5D%5C%5C%0A&amp;=%20-%20e%5E%7B-rT%7D%20%5Cmathbb%7BE%7D%5E%7BQ%7D%5B1_%7BS_T%20%3E%20K%7D%5D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B2%7D"></span></p>
<p>So, we can replace the second expectation term <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5E%7BQ%7D%5B1_%7BS_T%20%3E%20K%7D%5D"> by <img src="https://latex.codecogs.com/png.latex?-e%5E%7BrT%7D%5Cfrac%7B%5Cpartial%20C_%7BK,T%7D%7D%7B%5Cpartial%20K%7D">. So, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D%5EQ%5BS_T%201_%7BS_T%20%3E%20K%7D%5D%20&amp;=%20e%5E%7BrT%7DC(K,T)%20-%20Ke%5E%7BrT%7D%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Let’s move to the second expectation term:</p>
<p><span id="eq-primary-expression-2"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20T%7D%5Cmathbb%7BE%7D%5E%7BQ%7D%5Cleft%5Bd(S_T%20-%20K)%5E%7B+%7D%5Cright%5D%20&amp;=%20re%5E%7BrT%7DC(K,T)%20-%20rKe%5E%7BrT%7D%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%20+%20%5Cfrac%7B1%7D%7B2%7D%5Cmathbb%7BE%7D%5EQ%5Cleft%5B%5Csigma(T,S_T)%5E2%20S_T%5E2%20%5Cdelta(S_T%20-%20K)%5Cright%5D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B3%7D"></span></p>
<p>We know that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D%5BX%20%7C%20Y=y_0%5D%20&amp;=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20x%20f_%7BX%7CY=y_0%7D(x)%20dx%5C%5C%0A&amp;=%5Cint_%7B%5Cmathbb%7BR%7D%7D%20x%20%5Cfrac%7Bf_%7BX,Y%7D(x,y_0)%7D%7Bf_Y(y_0)%7D%20dx%5C%5C%0A&amp;=%20%5Cint_%7B%5Cmathbb%7BR%7D%7D%20x%20%5Cfrac%7B%5Cint_%7B%5Cmathbb%7BR%7D%7D1_%7BY=y_0%7Df_%7BX,Y%7D(x,y)dy%7D%7Bf_Y(y_0)%7D%20dx%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cint%5Cint_%7B%5Cmathbb%7BR%7D%5E2%7Dxf_%7BX,Y%7D(x,y)%5Ccdot%201_%7BY=y_0%7Ddx%20dy%7D%7B%5Cint_%7BR%7Df_%7BX,Y%7D(x,y_0)%20dx%7D%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cint%5Cint_%7B%5Cmathbb%7BR%7D%5E2%7Dxf_%7BX,Y%7D(x,y)%5Ccdot%201_%7BY=y_0%7Ddx%20%5Ccdot%20dy%7D%7B%5Cint%20%5Cint_%7B%5Cmathbb%7BR%7D%5E2%7D1_%7BY=y_0%7D%20%5Ccdot%20f_%7BX,Y%7D(x,y)%20dx%20%5Ccdot%20dy%7D%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cmathbb%7BE%7D%5BX%5Ccdot%201_%7BY=y_0%7D%5D%7D%7B%5Cmathbb%7BE%7D%5B1_%7BY=y_0%7D%5D%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>So,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%7BE%7D%5BX%20%7C%20Y=y_0%5D%20%5Ccdot%20%5Cmathbb%7BE%7D%5B1_%7BY=y_0%7D%5D%20=%20%5Cmathbb%7BE%7D%5BX%5Ccdot%201_%7BY=y_0%7D%5D%0A"></p>
<p>Using this result, we may write:</p>
<p><span id="eq-intermediate-result-1"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D%5EQ%20%5B%5Csigma(T,S_T)%5E2%20S_T%5E2%20%5Cdelta(S_T%20-%20K)%5D%20&amp;=%20%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(T,S_T)%5E2%20S_T%5E2%20%7C%20S_T%20=%20K%5D%20%5Ccdot%20%5Cmathbb%7BE%7D%5EQ%5B%5Cdelta(S_T%20-%20K)%5D%5C%5C%0A&amp;=%20K%5E2%20%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(T,S_T)%5E2%20%7C%20S_T%20=%20K%5D%20%20%5Ccdot%20%5Cmathbb%7BE%7D%5EQ%5B%5Cdelta(S_T%20-%20K)%5D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B4%7D"></span></p>
<p>Now, taking the second derivative of the call option price with respect to the strike <img src="https://latex.codecogs.com/png.latex?K">, we have:</p>
<p><span id="eq-second-derivative-wrt-strike"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AC_%7BK,T%7D%20&amp;=%20e%5E%7B-rT%7D%5Cmathbb%7BE%7D%5EQ%5B(S_T%20-%20K)%5E%7B+%7D%5D%5C%5C%0A%5Cfrac%7B%5Cpartial%5E2%20C%7D%7B%5Cpartial%20K%5E2%7D%20%20&amp;=%20e%5E%7B-rT%7D%5Cmathbb%7BE%7D%5EQ%5Cleft%5B%5Cfrac%7B%5Cpartial%5E2%7D%7B%5Cpartial%20K%5E2%7D%20(S_T%20-%20K)%5E%7B+%7D%5Cright%5D%5C%5C%0A&amp;=%20e%5E%7B-rT%7D%20%5Cmathbb%7BE%7D%5EQ%5B%5Cdelta(S_T%20-%20K)%5D%5C%5C%0Ae%5E%7BrT%7D%5Cfrac%7B%5Cpartial%5E2%20C_%7BK,T%7D%7D%7B%5Cpartial%20K%5E2%7D%20&amp;=%20%5Cmathbb%7BE%7D%5EQ%5B%5Cdelta(S_T%20-%20K)%5D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B5%7D"></span></p>
<p>So, the second expression in the RHS of Equation&nbsp;4 becomes:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D%5EQ%20%5B%5Csigma(T,S_T)%5E2%20S_T%5E2%20%5Cdelta(S_T%20-%20K)%5D%20%20&amp;=%20K%5E2%20%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(T,S_T)%5E2%20%7C%20S_T%20=%20K%5D%20%20%5Ccdot%20%5Cmathbb%7BE%7D%5EQ%5B%5Cdelta(S_T%20-%20K)%5D%20%5C%5C%0A&amp;=%20K%5E2%20%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(T,S_T)%5E2%20%7C%20S_T%20=%20K%5D%20%20%5Ccdot%20e%5E%7BrT%7D%20%5Cfrac%7B%5Cpartial%5E2%20C%7D%7B%5Cpartial%20K%5E2%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>So, our primary expression in Equation&nbsp;3 becomes:</p>
<p><span id="eq-time-derivative"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20T%7D%5Cmathbb%7BE%7D%5EQ%5B(S_T%20-%20K)%5E+%5D%20&amp;=%20re%5E%7BrT%7D%20C(K,T)%20-%20rKe%5E%7BrT%7D%20%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%20%5C%5C&amp;+%20%5Cfrac%7B1%7D%7B2%7DK%5E2%20%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(T,S_T)%5E2%20%7C%20S_T%20=%20K%5D%20%20%5Ccdot%20e%5E%7BrT%7D%20%5Cfrac%7B%5Cpartial%5E2%20C%7D%7B%5Cpartial%20K%5E2%7D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B6%7D"></span></p>
<p>Let <img src="https://latex.codecogs.com/png.latex?C%5Eu(K,T%7CS,t)"> denote the undiscounted call option price. Since <img src="https://latex.codecogs.com/png.latex?C%5Eu(K,T%7CS,t)%20=%20%5Cmathbb%7BE%7D%5EQ%5B(S_T%20-%20K)%5E%7B+%7D%5D">, we can write the above PDE as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20T%7D&amp;=%20rC%5Eu_%7BK,T%7D%20-%20rK%20%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%7D%20%5C%5C&amp;+%20%5Cfrac%7B1%7D%7B2%7DK%5E2%20%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(T,S_T)%5E2%20%7C%20S_T%20=%20K%5D%20%20%5Ccdot%20%5Cfrac%7B%5Cpartial%5E2%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%5E2%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Rearranging we have:</p>
<p><span id="eq-dupire-formula-in-terms-of-undiscounted-call-option-price-1"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(T,%20S_T)%5E2%20%7C%20S_T%20=%20K%5D%0A=%20%5Cfrac%7B%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20T%7D%20+%20rK%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%7D%20-%20rC%5Eu_%7BK,T%7D%7D%7B%5Cfrac%7B1%7D%7B2%7DK%5E2%20%5Cfrac%7B%5Cpartial%5E2%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%5E2%7D%7D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B7%7D"></span></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2(S_T,%20T)"> is the instantaneous variance at <img src="https://latex.codecogs.com/png.latex?(S_T,T)">. We can write it’s conditional expectation as a function of the variables <img src="https://latex.codecogs.com/png.latex?(K,T)">, since it is an integral over the state space of <img src="https://latex.codecogs.com/png.latex?S_T">, so <img src="https://latex.codecogs.com/png.latex?S_T"> is integrated out and we will have a function of <img src="https://latex.codecogs.com/png.latex?K"> for each <img src="https://latex.codecogs.com/png.latex?T">.</p>
<section id="the-theory-of-local-volatility" class="level3">
<h3 class="anchored" data-anchor-id="the-theory-of-local-volatility">The theory of local volatility</h3>
<div id="def-local-volatility" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 1 (Local Volatility) </strong></span>The local variance <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7BK,T%7D%5E2(S_t,t)"> is defined as the reisk-neutral expectation of the squared instantaneous volatility at <img src="https://latex.codecogs.com/png.latex?(S_T,T)"> conditional on <img src="https://latex.codecogs.com/png.latex?S_T%20=%20K"> and time <img src="https://latex.codecogs.com/png.latex?t"> information <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BF%7D_t">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cboxed%7B%5Csigma_%7BK,T%7D%5E2(S_t,t)%20%5Cstackrel%7Bdef%7D%7B=%7D%20%5Cmathbf%7BE%7D%5E%7BQ%7D%5B%5Csigma%5E2(S_T,T,%5Ccdot)%7CS_T%20=%20K,%20%5Cmathcal%7BF%7D_t%5D=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20%5Csigma(s,T)%5E2%20f_%7BS_T%7CS_T%20=%20K%7D(s)%20ds%7D%0A"></p>
<p>Then local volatility is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Csigma_%7BK,T%7D%20%5Cstackrel%7Bdef%7D%7B=%7D%20%5Csqrt%7B%5Csigma_%7BK,T%7D%5E2(S_t,t)%7D%0A"></p>
</div>
<p>Thus, intuitively, we can think of the local volatility <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7BK,T%7D(S_t,t)"> is the market’s consensus for instantaneous volatility for a market level <img src="https://latex.codecogs.com/png.latex?K"> at some future date <img src="https://latex.codecogs.com/png.latex?T">. Since, it is implied from the observed option prices, the LVS gives the fair value of the asset price volatility for future market levels and times.</p>
<p>This definition of local volatility has two implications: first, the use market’s view on future volatility expressed by the expectation operator clarifies that all sources of risk from stochastic volatility are integrated out. Instead, the evolution of volatility is compressed into a single funtion that is deterministic in <img src="https://latex.codecogs.com/png.latex?S_t,t">.</p>
<p>To put it differently, the concept of local volatility assumes</p>
<p>So, we have:</p>
<p><span id="eq-dupire-formula-in-terms-of-undiscounted-call-option-price"><img src="https://latex.codecogs.com/png.latex?%0A%5Cboxed%7B%0A%20%20%20%20%5Csigma_%7BLV%7D%5E2(K,T)%20=%20%5Cfrac%7B%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20T%7D%20+%20rK%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%7D%20-%20rC%5Eu_%7BK,T%7D%7D%7B%5Cfrac%7B1%7D%7B2%7DK%5E2%20%5Cfrac%7B%5Cpartial%5E2%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%5E2%7D%7D%0A%7D%0A%5Ctag%7B8%7D"></span></p>
<p>We can also relabel the parameters to define the function in terms of time <img src="https://latex.codecogs.com/png.latex?t"> and stock price <img src="https://latex.codecogs.com/png.latex?S">:</p>
<p><span id="eq-dupire-formula-in-time-and-stock-price-terms"><img src="https://latex.codecogs.com/png.latex?%0A%5Cboxed%7B%0A%20%20%20%20%5Cmathbb%7BE%7D%5EQ%5B%5Csigma(t,%20S)%5E2%20%7C%20S_t%20=%20S%5D%20=%20%5Csigma_%7BLV%7D%5E2(K,T)%20%7C_%7BK=S,%20T=t%7D%20=%5Cleft.%5Cfrac%7B%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20T%7D%20+%20rK%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%7D%20-%20rC%5Eu_%7BK,T%7D%7D%7B%5Cfrac%7B1%7D%7B2%7DK%5E2%20%5Cfrac%7B%5Cpartial%5E2%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%5E2%7D%7D%5Cright%5Cvert_%7BK=S,T=t%7D%0A%7D%0A%5Ctag%7B9%7D"></span></p>
</section>
<section id="digression---breeden-litzenberger-formula" class="level2">
<h2 class="anchored" data-anchor-id="digression---breeden-litzenberger-formula">Digression - Breeden-Litzenberger Formula</h2>
<p>Assume that <img src="https://latex.codecogs.com/png.latex?(S_t,t%5Cgeq%200)"> is a markov process with the density <img src="https://latex.codecogs.com/png.latex?p(t,s,T,S_T)"> conditioned on <img src="https://latex.codecogs.com/png.latex?S_t%20=%20s">. Then:</p>
<p><span id="eq-first-derivative-of-call-option-price"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AC(s,t,T,K)%20&amp;=%20e%5E%7B-r(T-t)%7D%5Cint_0%5E%5Cinfty%20p(t,s,T,S_T)%20(S_T%20-%20K)%5E%7B+%7D%20dS_T%20%5C%5C%0A&amp;=%20%20e%5E%7B-r(T-t)%7D%5Cint_K%5E%5Cinfty%20p(t,s,T,y)%20(y%20-%20K)%20dy%20%5C%5C%0A%5Cend%7Balign*%7D%0A%5Ctag%7B10%7D"></span></p>
<p>Differentiating with respect to <img src="https://latex.codecogs.com/png.latex?K">, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%20&amp;=%20e%5E%7B-r(T-t)%7D%5Cleft%5B%5Cleft.p(t,s,T,y)%20(y%20-%20K)%5Cright%5Cvert_%7By=%5Cinfty%7D%20-%20%5Cleft.p(t,s,T,y)%20(y%20-%20K)%5Cright%5Cvert_%7By=K%7D%20+%20%5Cint_%7BK%7D%5E%5Cinfty%20p(t,s,T,y)%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D(y-k)dy%5Cright%5D%20%5C%5C%0A&amp;=%20-e%5E%7B-r(T-t)%7D%20%5Cint_%7BK%7D%5E%5Cinfty%20p(t,s,T,y)%20dy%0A%5Cend%7Balign*%7D%0A"></p>
<p>Differentiating again with respect to <img src="https://latex.codecogs.com/png.latex?K"> and applying the Leibnitz rule:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%5E2%20C%7D%7B%5Cpartial%20K%5E2%7D%20&amp;=%20-%20e%5E%7B-r(T-t)%7D%20%5B%20p(t,s,T,y)%7C_%7By=%5Cinfty%7D%20-%20%20p(t,s,T,y)%7C_%7By=K%7D%5D%5C%5C%0A&amp;=%20e%5E%7B-r(T-t)%7Dp(t,s,T,K)%0A%5Cend%7Balign*%7D%0A"></p>
<p>Finally, we have:</p>
<p><span id="eq-breeden-litzenberger-formula"><img src="https://latex.codecogs.com/png.latex?%0A%5Cboxed%7B%5Cfrac%7B%5Cpartial%5E2%20C%7D%7B%5Cpartial%20K%5E2%7D%20=%20e%5E%7B-r(T-t)%7Dp(t,s,T,K)%7D%0A%5Ctag%7B11%7D"></span></p>
<p><a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2642349">Breeden &amp; Litzenberger(1978)</a>, showed that this second-order partial derivative can be used to approximate the option-implied risk-neutral probability that the underlying asset price <img src="https://latex.codecogs.com/png.latex?S"> will be equal to the strike <img src="https://latex.codecogs.com/png.latex?K"> at maturity.</p>
</section>
<section id="no-arbitrage-conditions" class="level2">
<h2 class="anchored" data-anchor-id="no-arbitrage-conditions">No-arbitrage conditions</h2>
<p>The volatility surface, or equivalently the Call prices surface cannot have any arbitrary shape. Peter Carr has shown that static arbitrage is avoided in a set of option prices, if the calendar spread and butterfly spread arbitrages are avoided.</p>
<section id="calendar-spread-condition" class="level3">
<h3 class="anchored" data-anchor-id="calendar-spread-condition">Calendar spread condition</h3>
<p>Calendar spread arbitrage is usually expressed as the monotonicity of the European call option prices <img src="https://latex.codecogs.com/png.latex?C"> with respect to the maturity <img src="https://latex.codecogs.com/png.latex?T">. I closely follow the derivation in <a href="https://core.ac.uk/reader/6978470">Fengler(2005)</a>.</p>
<div id="prp-calendar-spread" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 1 (Calendar Arbitrage) </strong></span>Define forward-moneyness <img src="https://latex.codecogs.com/png.latex?k%20%5Cstackrel%7Bdef%7D%7B=%7D%20K/F(t,T)">, where the forward price is given by <img src="https://latex.codecogs.com/png.latex?F(t,T)%20=%20S_t%20e%5E%7B%5Cint_t%5ET%20r(u)du%7D"> and total variance as <img src="https://latex.codecogs.com/png.latex?%5Cnu%5E2(k,%5Ctau)%20=%20%5Chat%7B%5Csigma%7D%5E2(k,%5Ctau)%5Ctau">.</p>
<p>If <img src="https://latex.codecogs.com/png.latex?%5Cnu%5E2(k,%5Ctau_i)"> is a strictly increasing function of <img src="https://latex.codecogs.com/png.latex?%5Ctau_i%20=%20T_i%20-%20t">, <img src="https://latex.codecogs.com/png.latex?i=1,2">, there is no calendar arbitrage.</p>
</div>
<p><em>Proof.</em></p>
<p>Given two expiry dates <img src="https://latex.codecogs.com/png.latex?t%20%3C%20T_1%20%3C%20T_2">, construct in <img src="https://latex.codecogs.com/png.latex?t">, the following calendar spread in two calls with the same forward-moneyness: a long position in a call <img src="https://latex.codecogs.com/png.latex?C_t(K_2,%20T_2)"> and a short position in <img src="https://latex.codecogs.com/png.latex?C_t(K_1,T_1)"> call. The forward-moneyness requirement implies that:</p>
<p><span id="eq-forward-moneyness-condition"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7BK_1%7D%7BF(t,T_1)%7D%20&amp;=%20%5Cfrac%7BK_2%7D%7BF(t,T_2)%7D%5C%5C%0AK_1%20&amp;=%20e%5E%7B-%5Cint_%7BT_1%7D%5E%7BT_2%7Dr(u)du%7D%20K_2%0A%5Cend%7Balign*%7D%0A%5Ctag%7B12%7D"></span></p>
<p>In <img src="https://latex.codecogs.com/png.latex?T_1">, if <img src="https://latex.codecogs.com/png.latex?S_%7BT_1%7D%20%5Cleq%20K_1"> the short option position struck at <img src="https://latex.codecogs.com/png.latex?K_1"> expires worthless while <img src="https://latex.codecogs.com/png.latex?C_%7BT_1%7D(K_2,T_2)%5Cgeq%200">, because it still has some time-value of money. Otherwise, the entire portfolio is worth <img src="https://latex.codecogs.com/png.latex?C_%7BT_1%7D(K_2,T_2)%20-%20(S_%7BT_1%7D%20-%20K_1)">. But, Equation&nbsp;12 implies that the portfolio is worth <img src="https://latex.codecogs.com/png.latex?C_%7BT_1%7D(K_2,T_2)%20-%20(S_%7BT_1%7D%20-%20K_2%20e%5E%7B-%5Cint_%7BT_1%7D%5E%7BT_2%7D%20r(u)%20du%7D)"> which equals <img src="https://latex.codecogs.com/png.latex?P_%7BT_1%7D(K_2,T_2)"> by put-call parity. Thus, the payoff of this portfolio is always non-negative.</p>
<p>In order to preclude arbitrage, at time <img src="https://latex.codecogs.com/png.latex?t%20%5Cleq%20T_1%20%3C%20T_2"> we must have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AC_t(K_2,T_2)%20-%20C_t(K_1,T_1)%20&amp;%3E%200%5C%5C%0AC_t(K_2,T_2)%20&amp;%3E%20C_t(K_1,T_1)%0A%5Cend%7Balign*%7D%0A"></p>
<p>Multiplying by <img src="https://latex.codecogs.com/png.latex?e%5E%7B%5Cint_0%5E%7BT_2%7D%20r_u%20du%7D"> and dividing by <img src="https://latex.codecogs.com/png.latex?K_2"> yields:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7Be%5E%7B%5Cint_0%5E%7BT_2%7D%20r_u%20du%7DC_t(K_2,T_2)%7D%7BK_2%7D%20&amp;%3E%20%5Cfrac%7Be%5E%7B%5Cint_0%5E%7BT_2%7D%20r_u%20du%7DC_t(K_1,T_1)%7D%7BK_2%7D%5C%5C%0A&amp;=%20%5Cfrac%7Be%5E%7B%5Cint_0%5E%7BT_2%7D%20r_u%20du%7DC_t(K_1,T_1)%7D%7BK_1%20e%5E%7B%5Cint_%7BT_1%7D%5E%7BT_2%7Dr_u%20du%7D%7D%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>So, we have the condition:</p>
<p><span id="eq-undiscounted-call-option-price-scaled-by-strike"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cboxed%7B%5Cfrac%7Be%5E%7B%5Cint_0%5E%7BT_2%7D%20r_u%20du%7DC_t(K_2,T_2)%7D%7BK_2%7D%20%3E%20%20%5Cfrac%7Be%5E%7B%5Cint_0%5E%7BT_1%7D%20r_u%20du%7DC_t(K_1,T_1)%7D%7BK_1%7D%7D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B13%7D"></span></p>
<p>Finally, we observe that the function:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Af(k,%5Cnu%5E2)%20&amp;%5Cstackrel%7Bdef%7D%7B=%7D%20%5Cfrac%7Be%5E%7B%5Cint_%7B0%7D%5ET%20r_u%20du%7DC_t%5E%7BBS%7D(K,T)%7D%7BK%7D%5C%5C%0A&amp;=%20%5Cfrac%7BF(0,T)%5CPhi(d_%7B+%7D)%7D%7BK%7D%20-%20%5CPhi(d_%7B-%7D)%5C%5C%0A&amp;=%20k%5E%7B-1%7D%5CPhi(d_%7B+%7D)%20-%20%5CPhi(d_%7B-%7D)%0A%5Cend%7Balign*%7D%0A"></p>
<p>is a function in <img src="https://latex.codecogs.com/png.latex?k"> and <img src="https://latex.codecogs.com/png.latex?%5Cnu%5E2"> only, and, for a fixed <img src="https://latex.codecogs.com/png.latex?k">, is a strictly monotone increasing function in <img src="https://latex.codecogs.com/png.latex?%5Cnu%5E2">, since</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ad_%7B%5Cpm%7D%20&amp;=%20%5Cfrac%7B%5Cln(%5Cfrac%7B1%7D%7Bk%7D)%5Cpm%20%5Cfrac%7B%5Cnu%5E2%7D%7B2%7D%7D%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%5C%5C%0A%5Cfrac%7B%5Cpartial%20d_%7B+%7D%7D%7B%5Cpartial%20%5Cnu%5E2%7D%20&amp;=%5Cfrac%7B%5Csqrt%7B%5Cnu%5E2%7D%20%5Ccdot%20%5Cfrac%7B1%7D%7B2%7D%20-%20%5Cleft(-%5Cln%20k%20+%20%5Cfrac%7B%5Cnu%5E2%7D%7B2%7D%5Cright)%5Ccdot%20%5Cfrac%7B1%7D%7B2%5Csqrt%7B%5Cnu%5E2%7D%7D%7D%7B%5Cnu%5E2%7D%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cfrac%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%7B2%7D%20-%20%5Cfrac%7Bd_%7B+%7D%7D%7B2%7D%7D%7B%5Cnu%5E2%7D%5C%5C%0A%5Cfrac%7B%5Cpartial%20d_%7B-%7D%7D%7B%5Cpartial%20%5Cnu%5E2%7D%20&amp;=%20%5Cfrac%7B-%5Cfrac%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%7B2%7D%20-%20%5Cfrac%7Bd_%7B-%7D%7D%7B2%7D%7D%7B%5Cnu%5E2%7D%5C%5C%0A%5Cfrac%7B%5Cpartial%20d_%7B+%7D%7D%7B%5Cpartial%20%5Cnu%5E2%7D%20-%20%5Cfrac%7B%5Cpartial%20d_%7B-%7D%7D%7B%5Cpartial%20%5Cnu%5E2%7D%20&amp;=%20%5Cfrac%7B1%7D%7B2%5Csqrt%7B%5Cnu%5E2%7D%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Also observe that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cphi(d_%7B+%7D)%7D%7B%5Cphi(d_%7B-%7D)%7D%20&amp;=%20%5Cexp%5Cleft%5B-%5Cfrac%7B1%7D%7B2%7D(d_%7B+%7D%5E2%20-%20d_%7B-%7D%5E2)%5Cright%5D%5C%5C%0A&amp;=%20%5Cexp%5Cleft%5B-%5Cfrac%7B1%7D%7B2%7D(d_%7B+%7D%20+%20d_%7B-%7D)(d_%7B+%7D%20-%20d_%7B-%7D)%5Cright%5D%5C%5C%0A&amp;=%20%5Cexp%5Cleft%5B-%5Cfrac%7B1%7D%7B2%7D%5Cleft(%5Cfrac%7B-%5Cln%20k%20+%20%5Cnu%5E2/2%7D%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%20+%20%5Cfrac%7B-%5Cln%20k%20-%20%5Cnu%5E2/2%7D%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%5Cright)%5Cleft(%5Cfrac%7B-%5Cln%20k%20+%20%5Cnu%5E2/2%7D%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%20-%20%5Cfrac%7B-%5Cln%20k%20-%20%5Cnu%5E2/2%7D%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%5Cright)%5Cright%5D%5C%5C%0A&amp;=%20%5Cexp%5Cleft%5B%5Cleft(%5Cfrac%7B%5Cln%20k%7D%7B%5Csqrt%7B%5Cnu%5E2%7D%7D%5Cright)%5Csqrt%7B%5Cnu%5E2%7D%5Cright%5D%5C%5C%0A&amp;=%20k%0A%5Cend%7Balign*%7D%0A"></p>
<p>So, <img src="https://latex.codecogs.com/png.latex?%5Cphi(d_%7B+%7D)%20=%20k%20%5Cphi(d_%7B-%7D)">. Also, recall that <img src="https://latex.codecogs.com/png.latex?d_%7B+%7D%20=%20d_%7B-%7D%20+%20%5Csqrt%7B%5Cnu%5E2%7D">. Putting it all together, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20%5Cnu%5E2%7D%20&amp;=%20k%5E%7B-1%7D%5Cphi(d_%7B+%7D)%20(%5Cpartial%20d_%7B+%7D/%5Cpartial%20%5Cnu%5E2)%20-%20%5Cphi(d_%7B-%7D)(%5Cpartial%20d_%7B-%7D/%5Cpartial%20%5Cnu%5E2)%20%5C%5C%0A&amp;=%20%5Cphi(d_%7B-%7D)%20%5Ccdot%20%5Cleft(%5Cfrac%7B%5Cpartial%20d_%7B+%7D%7D%7B%5Cpartial%20%5Cnu%5E2%7D%20-%20%5Cfrac%7B%5Cpartial%20d_%7B-%7D%7D%7B%5Cpartial%20%5Cnu%5E2%7D%5Cright)%5C%5C%0A&amp;=%20%5Cphi(d_%7B-%7D)%5Cfrac%7B1%7D%7B2%5Csqrt%7B%5Cnu%5E2%7D%7D%20%3E%200,%20%5Cquad%20%5Cforall%20%5Cnu%5E2%20%5Cin%20(0,%5Cinfty)%0A%5Cend%7Balign*%7D%0A"></p>
<p>We conclude that <img src="https://latex.codecogs.com/png.latex?f"> is strictly monotonically increasing in <img src="https://latex.codecogs.com/png.latex?%5Cnu%5E2">. So, if total variance <img src="https://latex.codecogs.com/png.latex?%5Cnu%5E2%20=%20%5Csigma%5E2(k,%5Ctau)"> is increasing, <img src="https://latex.codecogs.com/png.latex?f(k,%5Cnu%5E2)">, that is the undiscounted call option price scaled by the strike price <img src="https://latex.codecogs.com/png.latex?K"> is increasing and from Equation&nbsp;13, it follows that there is no calendar arbitrage.</p>
<p>The equation Equation&nbsp;13 is the discrete version of the calendar spread no-arbitrage condition. We can also <img src="https://latex.codecogs.com/png.latex?%5Cblacksquare"></p>
</section>
<section id="butterfly-spread-arbitrage" class="level3">
<h3 class="anchored" data-anchor-id="butterfly-spread-arbitrage">Butterfly spread arbitrage</h3>
<p>We can write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%5E2%20C%7D%7B%5Cpartial%20K%5E2%7D%20=%20%5Clim_%7B%5Cepsilon%20%5Cto%200%7D%20%5Cfrac%7BC(K-%5Cepsilon,T)%20-%202C(K,T)%20+%20C(K+%5Cepsilon,%20T)%7D%7B%5Cepsilon%5E2%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Consider the European payoff consisting of <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B%5Cepsilon%5E2%7D"> calls of strike <img src="https://latex.codecogs.com/png.latex?K%20-%20%5Cepsilon">, <img src="https://latex.codecogs.com/png.latex?1/%5Cepsilon%5E2"> calls of strike <img src="https://latex.codecogs.com/png.latex?K+%5Cepsilon"> and <img src="https://latex.codecogs.com/png.latex?-2/%5Cepsilon%5E2"> calls of strike <img src="https://latex.codecogs.com/png.latex?K"> - this is known as the butterfly spread.</p>
<p>The payout at maturity as a function of <img src="https://latex.codecogs.com/png.latex?S_T"> has a triangular shape whose surface area is unity : it vanishes for <img src="https://latex.codecogs.com/png.latex?S_T%20%5Cleq%20K%20-%20%5Cepsilon"> and <img src="https://latex.codecogs.com/png.latex?S_T%20%5Cgeq%20K%20+%20%5Cepsilon"> and is equal to <img src="https://latex.codecogs.com/png.latex?1/%5Cepsilon"> for <img src="https://latex.codecogs.com/png.latex?S_T%20=%20K">. For <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%20%5Cto%200">, it becomes a Dirac-Delta function. It either vanishes or is strictly positive dependending on <img src="https://latex.codecogs.com/png.latex?S_T">. Hence, its price at inception must be positive.</p>
<p>Options prices are arbitraged well-enough that butterfly spreads do not have negative prices : the denominator in the Dupire formula is positive.</p>
<p>By the Breeden-Litzenberger formula Equation&nbsp;11, <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bd%5E2%20C(K,T)%7D%7BdK%5E2%7D"> is related to the probability density of <img src="https://latex.codecogs.com/png.latex?S_T">, which must be positive. Hence, the condition <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bd%5E2%20C(K,T)%7D%7BdK%5E2%7D%20%3E%200"> is equivalent to requiring that the market implied risk-beutral probabilities are not negative. Violation of the positivity of <img src="https://latex.codecogs.com/png.latex?d%5E2%20C/dK%5E2"> is called butterfly-spread arbitrage.</p>
</section>
<section id="call-option-price-bounds" class="level3">
<h3 class="anchored" data-anchor-id="call-option-price-bounds">Call option price bounds</h3>
<p>From Equation&nbsp;10, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%20=%20-e%5E%7B-r%5Ctau%7D%20%5Cint_%7BK%7D%5E%7B%5Cinfty%7Dp(s,t,y,T)dy%0A"></p>
<p>From the positivity of the integral <img src="https://latex.codecogs.com/png.latex?%5Cint_%7BK%7D%5E%7B%5Cinfty%7Dp(s,t,y,T)dy%20%3E%200">, we must have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%20%5Cleq%200%0A"></p>
<p>Further, using the fact <img src="https://latex.codecogs.com/png.latex?%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7Dp(s,t,y,T)dy%20=%201">, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ae%5E%7B-r%5Ctau%7D%5Cint_%7BK%7D%5E%7B%5Cinfty%7Dp(s,t,y,T)dy%20&amp;%5Cleq%20e%5E%7B-r%5Ctau%7D%20%5Cint_%7BK%7D%5E%7B%5Cinfty%7Dp(s,t,y,T)dy%20=%20e%5E%7B-r%5Ctau%7D%20%5C%5C%0A-e%5E%7B-r%5Ctau%7D%5Cint_%7BK%7D%5E%7B%5Cinfty%7Dp(s,t,y,T)dy%20%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%5Cgeq%20-e%5E%7B-r%5Ctau%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>Putting it together, we have:</p>
<p><span id="eq-no-arbitrage-bounds-on-first-derivative-wrt-strike"><img src="https://latex.codecogs.com/png.latex?%0A%5Cboxed%7B-e%5E%7B-r%5Ctau%7D%20%5Cleq%20%5Cfrac%7B%5Cpartial%20C%7D%7B%5Cpartial%20K%7D%20%5Cleq%200%7D%0A%5Ctag%7B14%7D"></span></p>
<p>The option price is a decreasing and convex function of the strike <img src="https://latex.codecogs.com/png.latex?K">.</p>
</section>
</section>
<section id="dupire-pde-in-terms-of-forward-moneyness" class="level2">
<h2 class="anchored" data-anchor-id="dupire-pde-in-terms-of-forward-moneyness">Dupire PDE in terms of forward moneyness</h2>
<p>Let the log forward-moneyness be defined as <img src="https://latex.codecogs.com/png.latex?y%20=%20%5Cln(K/F)">. We need to transform the derivatives of the Dupire formula in terms of forward-moneyness.</p>
<p>The deterministic local volatility function is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Csigma_%7BK,T%7D%5E2(S_t,t)%20=%20%5Cfrac%7B%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20T%7D%20+%20rK%5Cfrac%7B%5Cpartial%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%7D%20-%20rC%5Eu_%7BK,T%7D%7D%7B%5Cfrac%7B1%7D%7B2%7DK%5E2%20%5Cfrac%7B%5Cpartial%5E2%20C%5Eu_%7BK,T%7D%7D%7B%5Cpartial%20K%5E2%7D%7D%0A"></p>
<p>The first derivative with respect to time <img src="https://latex.codecogs.com/png.latex?T"> is obtained using the total derivative rule. Imagine that the undiscounted call option price is a function of two intermediate variables <img src="https://latex.codecogs.com/png.latex?a,b"> which are in turn a function of <img src="https://latex.codecogs.com/png.latex?T">. That is, <img src="https://latex.codecogs.com/png.latex?C%5Eu%20=%20C%5Eu(a(T),b(T))">. Then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20T%7D(%7Ba(T),b(T)%7D)%20&amp;=%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20a%7D%5Cright%5Cvert_%7Bb%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20a%7D%7B%5Cpartial%20T%7D%20+%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20b%7D%5Cright%5Cvert_%7Ba%7D%20%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20b%7D%7B%5Cpartial%20T%7D%20%20%0A%5Cend%7Balign*%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cvert_%7Ba%7D"> indicates that <img src="https://latex.codecogs.com/png.latex?a"> is treated as a constant. For the undiscounted call option price <img src="https://latex.codecogs.com/png.latex?C%5Eu%20=%20C%5Eu(y(K,T),T)">, so <img src="https://latex.codecogs.com/png.latex?a(T)%20=%20y(K,T)"> and <img src="https://latex.codecogs.com/png.latex?b(T)%20=%20T">. So, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20T%7D(%7By(K,T),T%7D)%20&amp;=%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright%5Cvert_%7BT%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20y%7D%7B%5Cpartial%20T%7D%20+%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20T%7D%5Cright%5Cvert_%7By%7D%20%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20T%7D%7B%5Cpartial%20T%7D%20%5C%5C%0A&amp;=%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright%5Cvert_%7BT%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20y%7D%7B%5Cpartial%20T%7D%20+%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20T%7D%5Cright%5Cvert_%7By%7D%20%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Now,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ay(K,T)%20&amp;=%20(-rT)+%5Cln%5Cleft(%5Cfrac%7BK%7D%7BS_0%7D%5Cright)%5C%5C%0A%5Cfrac%7B%5Cpartial%20y%7D%7B%5Cpartial%20T%7D%20&amp;=%20(-r)%0A%5Cend%7Balign*%7D%0A"></p>
<p>Thus,</p>
<p><span id="eq-dupire-formula-in-forward-moneyness-terms-1"><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20T%7D%20=%20-r%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright%5Cvert_%7BT%7D%20%20+%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20T%7D%5Cright%5Cvert_%7By%7D%20%20%5C%5C%0A%5Ctag%7B15%7D"></span></p>
<p>Using the chain rule, the first derivative with respect to <img src="https://latex.codecogs.com/png.latex?K"> is:</p>
<p><span id="eq-dupire-formula-in-forward-moneyness-terms-2"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20K%7D%20&amp;=%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20y%7D%7B%5Cpartial%20K%7D%20%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20K%7D%20%5Cln%5Cleft(%5Cfrac%7BK%7D%7BF_t%7D%5Cright)%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%20%5Ccdot%20%5Cfrac%7BF%7D%7BK%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D%20%5Cleft(%5Cfrac%7BK%7D%7BF_t%7D%5Cright)%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7BK%7D%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%0A%5Cend%7Balign*%7D%0A%5Ctag%7B16%7D"></span></p>
<p>Differentiating again with respect to <img src="https://latex.codecogs.com/png.latex?K">, we have:</p>
<p><span id="eq-dupire-formula-in-forward-moneyness-terms-3"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%5E2%20C%5Eu%7D%7B%5Cpartial%20K%5E2%7D%20&amp;=%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D%20%5Cleft(%5Cfrac%7B1%7D%7BK%7D%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright)%20%5C%5C%0A&amp;=%20-%5Cfrac%7B1%7D%7BK%5E2%7D%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%20+%20%5Cfrac%7B1%7D%7BK%7D%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20K%7D%20%5Cleft(%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright)%5C%5C%0A&amp;=%20-%5Cfrac%7B1%7D%7BK%5E2%7D%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%20+%20%5Cfrac%7B1%7D%7BK%7D%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20y%7D%20%5Cleft(%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright)%5Cfrac%7B%5Cpartial%20y%7D%7B%5Cpartial%20K%7D%5C%5C%0A&amp;=%20-%5Cfrac%7B1%7D%7BK%5E2%7D%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%20+%20%5Cfrac%7B1%7D%7BK%5E2%7D%5Cfrac%7B%5Cpartial%5E2%20C%5Eu%7D%7B%5Cpartial%20y%5E2%7D%5C%5C%0A&amp;=%5Cfrac%7B1%7D%7BK%5E2%7D%5Cleft(%5Cfrac%7B%5Cpartial%5E2%20C%5Eu%7D%7B%5Cpartial%20y%5E2%7D%20-%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright)%0A%5Cend%7Balign*%7D%0A%5Ctag%7B17%7D"></span></p>
<p>Substituting Equation&nbsp;15, Equation&nbsp;16 and Equation&nbsp;17 in the expression for local volatility, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Csigma_%7BK,T%7D%5E2(S_t,t)%20&amp;=%20%5Cfrac%7B-r%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu_%7By,T%7D%7D%7B%5Cpartial%20y%7D%5Cright%5Cvert_%7BT%7D%20+%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu_%7By,T%7D%7D%7B%5Cpartial%20T%7D%5Cright%5Cvert_%7By%7D%20+%20rK%5Cfrac%7B%5Cpartial%20C%5Eu_%7By,T%7D%7D%7B%5Cpartial%20y%7D%20%5Ccdot%20%5Cfrac%7B1%7D%7BK%7D%20-%20rC%5Eu_%7By,T%7D%7D%7B%5Cfrac%7B1%7D%7B2%7DK%5E2%20%5Cfrac%7B1%7D%7BK%5E2%7D%5Ccdot%20%5Cleft(%5Cfrac%7B%5Cpartial%5E2%20C%5Eu%7D%7B%5Cpartial%20y%5E2%7D%20-%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright)%7D%5C%5C%0A&amp;=%20%5Cfrac%7B%20%5Cleft.%5Cfrac%7B%5Cpartial%20C%5Eu_%7By,T%7D%7D%7B%5Cpartial%20T%7D%5Cright%5Cvert_%7By%7D%20+%20%20-%20rC%5Eu_%7By,T%7D%7D%7B%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%5Cfrac%7B%5Cpartial%5E2%20C%5Eu%7D%7B%5Cpartial%20y%5E2%7D%20-%20%5Cfrac%7B%5Cpartial%20C%5Eu%7D%7B%5Cpartial%20y%7D%5Cright)%7D%5C%5C%0A%5Cfrac%7B%5Cpartial%20C%5Eu_%7By,T%7D%7D%7B%5Cpartial%20T%7D%20&amp;=%20rC%5Eu_%7By,T%7D%20+%20%5Cfrac%7B%5Csigma_%7By,T%7D%5E2%7D%7B2%7D%5Cleft(%5Cfrac%7B%5Cpartial%5E2%20C%5Eu_%7By,T%7D%7D%7B%5Cpartial%20y%5E2%7D%20-%20%5Cfrac%7B%5Cpartial%20C%5Eu_%7By,T%7D%7D%7B%5Cpartial%20y%7D%5Cright)%0A%5Cend%7Balign*%7D%0A"></p>
</section>
<section id="local-volatility-in-terms-of-implied-volatility" class="level2">
<h2 class="anchored" data-anchor-id="local-volatility-in-terms-of-implied-volatility">Local volatility in terms of implied volatility</h2>
<p>Since options can also be quoted in terms of implied volatility, the local volatility may also be expressed in terms of the total variance <img src="https://latex.codecogs.com/png.latex?w(y,T)">. Define:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Aw(y,T)%20=%20%5CSigma%5E2(y,T)%20T%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5CSigma(y,T)"> is the Black-Scholes implied volatility as a function of forward-moneyness and time-to-maturity <img src="https://latex.codecogs.com/png.latex?T">.</p>
<p>We know that the Black-Scholes formula for the future value of the call-option price is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AC_%7BBS%7D(y,w)%20=%20F%5Cleft(%5CPhi%5Cleft(-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%20-%20e%5Ey%5CPhi%5Cleft(-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cright)%0A"></p>
<p>Differentiating with respect to <img src="https://latex.codecogs.com/png.latex?w">, we have:</p>
<p><span id="eq-BS-derivative-wrt-w"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%20&amp;%20=F_%7BT%7D%5Cleft%5C%7B%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20w%7D%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%20-e%5E%7By%7D%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20w%7D%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cright%5C%7D%5C%5C%0A&amp;%20=F_%7BT%7D%5Cleft%5C%7B%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cleft(%5Cfrac%7By%7D%7B2w%5E%7B3/2%7D%7D%20+%5Cfrac%7B1%7D%7B4w%5E%7B1/2%7D%7D%5Cright)%20-e%5E%7By%7D%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cleft(%5Cfrac%7By%7D%7B2w%5E%7B3/2%7D%7D%20-%5Cfrac%7B1%7D%7B4w%5E%7B1/2%7D%7D%5Cright)%5Cright%5C%7D%5C%5C%0A&amp;%20=F_%7BT%7D%5Cleft%5C%7B%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cleft(%5Cfrac%7By%7D%7B2w%5E%7B3/2%7D%7D%20+%5Cfrac%7B1%7D%7B4w%5E%7B1/2%7D%7D%5Cright)%20-%5Cleft(%5Cfrac%7By%7D%7B2w%5E%7B3/2%7D%7D%20-%5Cfrac%7B1%7D%7B4w%5E%7B1/2%7D%7D%5Cright)%5Cright%5C%7D%5C%5C%0A&amp;%20=F_%7BT%7D%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%20%5Ccdotp%20%5Cfrac%7B1%7D%7B2w%5E%7B1/2%7D%7D%0A%5Cend%7Baligned%7D%0A%5Ctag%7B18%7D"></span></p>
<p>Differentiating again with respect to <img src="https://latex.codecogs.com/png.latex?w">:</p>
<p><span id="eq-BS-second-derivative-wrt-w"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7B%5Cpartial%20%5E%7B2%7D%20C_%7BBS%7D%7D%7B%5Cpartial%20w%5E%7B2%7D%7D%20&amp;%20=F_%7BT%7D%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20w%7D%5Cleft(%20%5Cphi%20(%20d_%7B+%7D)%20%5Ccdotp%20%5Cfrac%7B1%7D%7B2w%5E%7B1/2%7D%7D%5Cright)%5C%5C%0A&amp;%20=F_%7BT%7D%5Cleft%5B%5Cfrac%7B1%7D%7B2w%5E%7B1/2%7D%7D%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20w%7D(%20%5Cphi%20(%20d_%7B+%7D))%20+%5Cphi%20(%20d_%7B+%7D)%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20w%7D%5Cleft(%5Cfrac%7B1%7D%7B2w%5E%7B1/2%7D%7D%5Cright)%5Cright%5D%5C%5C%0A&amp;%20=F_%7BT%7D%5Cleft%5B%5Cfrac%7B1%7D%7B2w%5E%7B1/2%7D%7D%20%5Cphi%20(%20d_%7B+%7D)%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20w%7D%5Cleft(%20-%5Cfrac%7Bd_%7B+%7D%5E%7B2%7D%7D%7B2%7D%5Cright)%20-%5Cphi%20(%20d_%7B+%7D)%5Cfrac%7B1%7D%7B4w%5E%7B3/2%7D%7D%5Cright%5D%5C%5C%0A&amp;%20=F_%7BT%7D%5Cfrac%7B%5Cphi%20(%20d_%7B+%7D)%7D%7B2w%5E%7B1/2%7D%7D%5Cleft%5B%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20w%7D%5Cleft(%20-%5Cfrac%7Bd_%7B+%7D%5E%7B2%7D%7D%7B2%7D%5Cright)%20-%5Cfrac%7B1%7D%7B2w%7D%5Cright%5D%5C%5C%0A&amp;%20=%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%5Cleft%5B%20-d_%7B+%7D%5Cfrac%7B%5Cpartial%20d_%7B+%7D%7D%7B%5Cpartial%20w%7D%20-%5Cfrac%7B1%7D%7B2w%7D%5Cright%5D%5C%5C%0A&amp;%20=%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%5Cleft%5B%20-%5Cleft(%20-%5Cfrac%7By%7D%7Bw%5E%7B1/2%7D%7D%20+%5Cfrac%7Bw%5E%7B1/2%7D%7D%7B2%7D%5Cright)%5Cleft(%5Cfrac%7By%7D%7B2w%5E%7B3/2%7D%7D%20+%5Cfrac%7B1%7D%7B4w%5E%7B1/2%7D%7D%5Cright)%20-%5Cfrac%7B1%7D%7B2w%7D%5Cright%5D%5C%5C%0A&amp;%20=%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%5Cleft%5B%5Cfrac%7By%5E%7B2%7D%7D%7B2w%5E%7B2%7D%7D%20+%5Cfrac%7By%7D%7B4w%7D%20-%5Cfrac%7By%7D%7B4w%7D%20-%5Cfrac%7B1%7D%7B8%7D%20-%5Cfrac%7B1%7D%7B2w%7D%5Cright%5D%5C%5C%0A&amp;%20=%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%5Cleft(%5Cfrac%7By%5E%7B2%7D%7D%7B2w%5E%7B2%7D%7D%20-%5Cfrac%7B1%7D%7B2w%7D%20-%5Cfrac%7B1%7D%7B8%7D%5Cright)%0A%5Cend%7Baligned%7D%0A%5Ctag%7B19%7D"></span></p>
<p>Also, the mixed partial <img src="https://latex.codecogs.com/png.latex?%5Cpartial_%7Bwy%7D%20C_%7BBS%7D"> is given by:</p>
<p><span id="eq-BS-mixed-partial-derivative-wrt-wy"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7B%5Cpartial%20%5E%7B2%7D%20C_%7BBS%7D%7D%7B%5Cpartial%20w%5Cpartial%20y%7D%20&amp;%20=%5Cfrac%7BF_%7BT%7D%7D%7B2w%5E%7B1/2%7D%7D%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20y%7D%5Cleft%5C%7B%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cright%5C%7D%5C%5C%0A&amp;%20=%5Cfrac%7BF_%7BT%7D%7D%7B2w%5E%7B1/2%7D%7D%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20y%7D%5Cleft(%20-%5Cfrac%7Bd_%7B+%7D%5E%7B2%7D%7D%7B2%7D%5Cright)%5C%5C%0A&amp;%20=%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20d_%7B+%7D%7D%5Cleft(%20-%5Cfrac%7Bd_%7B+%7D%5E%7B2%7D%7D%7B2%7D%5Cright)%5Cfrac%7B%5Cpartial%20d_%7B+%7D%7D%7B%5Cpartial%20y%7D%5C%5C%0A&amp;%20=-%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%5Cleft(%20-%5Cfrac%7By%7D%7Bw%5E%7B1/2%7D%7D%20+%5Cfrac%7Bw%5E%7B1/2%7D%7D%7B2%7D%5Cright)%5Cleft(%20-%5Cfrac%7B1%7D%7B%5Csqrt%7Bw%7D%7D%5Cright)%5C%5C%0A&amp;%20=%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%5Cleft(%5Cfrac%7B1%7D%7B2%7D%20-%5Cfrac%7By%7D%7Bw%7D%5Cright)%0A%5Cend%7Baligned%7D%0A%5Ctag%7B20%7D"></span></p>
<p>Additionally, the partial derivatives of the Black-Scholes formula with respect to <img src="https://latex.codecogs.com/png.latex?y"> are:</p>
<p><span id="eq-BS-partial-derivative-wrt-y"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20y%7D%20&amp;%20=F_%7BT%7D%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20y%7D%5Cleft%5C%7B%5CPhi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%20-e%5E%7By%7D%20%5CPhi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cright%5C%7D%5C%5C%0A&amp;%20=F_%7BT%7D%20%5Ccdot%20%5Cleft%5B%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cfrac%7B%5Cpartial%20d_%7B+%7D%7D%7B%5Cpartial%20y%7D%20-e%5E%7By%7D%20%5CPhi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cright%5D%5C%5C%0A&amp;%20-F_%7BT%7D%5Cleft%5B%20e%5E%7By%7D%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cfrac%7B%5Cpartial%20d_%7B-%7D%7D%7B%5Cpartial%20y%7D%5Cright%5D%5C%5C%0A&amp;%20=F_%7BT%7D%20%5Ccdot%20%5Cleft%5B%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20+%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cleft(%20-%5Cfrac%7B1%7D%7B%5Csqrt%7Bw%7D%7D%5Cright)%20-e%5E%7By%7D%20%5CPhi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cright%5D%5C%5C%0A&amp;%20-F_%7BT%7D%5Cleft%5B%20e%5E%7By%7D%20%5Cphi%20%5Cleft(%20-%5Cfrac%7By%7D%7B%5Csqrt%7Bw%7D%7D%20-%5Cfrac%7B%5Csqrt%7Bw%7D%7D%7B2%7D%5Cright)%5Cleft(%20-%5Cfrac%7B1%7D%7B%5Csqrt%7Bw%7D%7D%5Cright)%5Cright%5D%5C%5C%0A&amp;%20=-%5Cfrac%7BF_%7BT%7D%7D%7B%5Csqrt%7Bw%7D%7D%20%5Ccdot%20%5Cleft%5B%20%5Cphi%20(%20d_%7B+%7D)%20-e%5E%7By%7D%20%5Cphi%20(%20d_%7B-%7D)%5Cright%5D%5C%5C%0A&amp;%20-F_%7BT%7D%20e%5E%7By%7D%20%5CPhi%20(%20d_%7B-%7D)%5C%5C%0A&amp;%20=-F_%7BT%7D%20e%5E%7By%7D%20%5CPhi%20(%20d_%7B-%7D)%0A%5Cend%7Baligned%7D%0A%5Ctag%7B21%7D"></span></p>
<p>Also:</p>
<p><span id="eq-BS-second-partial-derivative-wrt-y"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7B%5Cpartial%20%5E%7B2%7D%20C_%7BBS%7D%7D%7B%5Cpartial%20y%5E%7B2%7D%7D%20&amp;%20=-F_%7BT%7D%5Cfrac%7B%5Cpartial%20%7D%7B%5Cpartial%20y%7D%5Cleft(%20e%5E%7By%7D%20%5CPhi%20(%20d_%7B-%7D)%5Cright)%5C%5C%0A&amp;%20=-F_%7BT%7D%5Cleft(%20e%5E%7By%7D%20%5CPhi%20(%20d_%7B-%7D)%20+e%5E%7By%7D%20%5Cphi%20(%20d_%7B-%7D)%5Cfrac%7B%5Cpartial%20d_%7B-%7D%7D%7B%5Cpartial%20y%7D%5Cright)%5C%5C%0A&amp;%20=-F_%7BT%7D%20e%5E%7By%7D%20%5CPhi%20(%20d_%7B-%7D)%20+%5Cfrac%7BF_%7BT%7D%20e%5E%7By%7D%20%5Cphi%20(%20d_%7B-%7D)%7D%7B%5Csqrt%7Bw%7D%7D%5C%5C%0A&amp;%20=%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20y%7D%20+2%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%0A%5Cend%7Baligned%7D%0A%5Ctag%7B22%7D"></span></p>
<p>Now, the undiscounted call option price <img src="https://latex.codecogs.com/png.latex?C%5Eu(y,T)%20=%20C_%7BBS%7D(y(T),w(y,T))"> is a function of the intermediate variables <img src="https://latex.codecogs.com/png.latex?(y,w)">. So, we may write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AC%5Eu(y,T)%20&amp;=%20C_%7BBS%7D(w(y),y)%5C%5C%0AC%5Eu_y(y,T)%20&amp;=%20(C_%7BBS%7D)_w%20%5Ccdot%20w_y%20+%20(C_%7BBS%7D)_y%0A%5Cend%7Baligned%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AC_%7Byy%7D%20&amp;=%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20y%7D%5Cleft((C_%7BBS%7D)_w%20%5Ccdot%20w_y%20+%20(C_%7BBS%7D)_y%5Cright)%5C%5C%0A&amp;=%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20y%7D%5Cleft%5B(C_%7BBS%7D)_w%20%5Ccdot%20w_y%5Cright%5D%20+%20%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20y%7D((C_%7BBS%7D)_y)%5C%5C%0A&amp;=%5Cleft%5B%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20y%7D%5C%7B(C_%7BBS%7D)_w%5C%7D%20%5Ccdot%20w_y%20+%20(C_%7BBS%7D)_w%20%5Ccdot%20w_%7Byy%7D%5Cright%5D%20+%20(C_%7BBS%7D)_%7Byy%7D%20+%20(C_%7BBS%7D)_%7Byw%7D%20%5Ccdot%20w_y%5C%5C%0A&amp;=%5Cleft%5B%5C%7B(C_%7BBS%7D)_%7Bww%7D%20%5Ccdot%20w_y%20+%20(C_%7BBS%7D)_%7Bwy%7D%5C%7D%20%5Ccdot%20w_y%20+%20(C_%7BBS%7D)_w%20%5Ccdot%20w_%7Byy%7D%5Cright%5D%20+%20(C_%7BBS%7D)_%7Byy%7D%20+%20(C_%7BBS%7D)_%7Byw%7D%20%5Ccdot%20w_y%5C%5C%0A&amp;=%20(C_%7BBS%7D)_%7Byy%7D%20+%202(C_%7BBS%7D)_%7Bwy%7D%20%5Ccdot%20w_y%20+%20(C_%7BBS%7D)_%7Bww%7D%20%5Ccdot%20(w_y)%5E2%20+%20(C_%7BBS%7D)_w%20%5Ccdot%20w_%7Byy%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cleft.%5Cfrac%7B%5Cpartial%20C_u(y,T)%7D%7B%5Cpartial%20T%7D%5Cright%7C_y%20&amp;=%20%5Cleft.%5Cfrac%7B%5Cpartial%20C_%7BBS%7D(w(y,T),T)%7D%7B%5Cpartial%20T%7D%5Cright%7C_%7Bw%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20T%7D%7B%5Cpartial%20T%7D%20+%20%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20w%7D%7B%5Cpartial%20T%7D%5C%5C%0A&amp;=%20rC_%7BBS%7D%20+%20%5Cfrac%7B%5Cpartial%20C_%7BBS%7D%7D%7B%5Cpartial%20w%7D%20%5Ccdot%20%5Cfrac%7B%5Cpartial%20w%7D%7B%5Cpartial%20T%7D%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>where the last equality follows from the fact that the only explicit dependence of the option price on <img src="https://latex.codecogs.com/png.latex?T"> is through the forward price <img src="https://latex.codecogs.com/png.latex?F_T%20=%20S_0%20%5Cexp(%5Cint_0%5ET%20r%20dt)">.</p>
<p>Substituting these results in the Dupire’s formula:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cfrac%7B%5Cpartial%20C%5Eu(y,T)%7D%7B%5Cpartial%20T%7D%20&amp;=%20rC%5Eu(y,T)%20+%20%5Cfrac%7B%5Csigma%5E2(y,T)%7D%7B2%7D%5Cleft(%5Cfrac%7B%5Cpartial%5E2%20C_u(y,T)%7D%7B%5Cpartial%20y%5E2%7D%20-%20%5Cfrac%7B%5Cpartial%20C_u(y,T)%7D%7B%5Cpartial%20y%7D%5Cright)%5C%5C%0ArC_%7BBS%7D%20+%20(C_%7BBS%7D)_w%20%5Ccdot%20w_T%20&amp;=%20rC_%7BBS%7D%20+%20%5Csigma_%7BLV%7D%5E2/2((C_%7BBS%7D)_%7Byy%7D%20+%202(C_%7BBS%7D)_%7Bwy%7D%20%5Ccdot%20w_y%20+%20(C_%7BBS%7D)_%7Bww%7D%20%5Ccdot%20(w_y)%5E2%20+%20(C_%7BBS%7D)_w%20%5Ccdot%20w_%7Byy%7D-%20(C_%7BBS%7D)_y)%5C%5C%0A(C_%7BBS%7D)_w%20%5Ccdot%20w_T%20&amp;=%20%5Csigma_%7BLV%7D%5E2/2%5B((C_%7BBS%7D)_%7Byy%7D%20-%20(C_%7BBS%7D)_y)%20+%202(C_%7BBS%7D)_%7Bwy%7D%20%5Ccdot%20w_y%20%20+%20(C_%7BBS%7D)_%7Bww%7D%20%5Ccdot%20(w_y)%5E2%20+%20(C_%7BBS%7D)_w%20%5Ccdot%20w_%7Byy%7D-(C_%7BBS%7D)_w%20%5Ccdot%20w_y%5D%5C%5C%0A(C_%7BBS%7D)_w%20%5Ccdot%20w_T%20&amp;=%20%5Csigma_%7BLV%7D%5E2/2%5B2(C_%7BBS%7D)_w%20+%202(C_%7BBS%7D)_w%20%5Cleft(%5Cfrac%7B1%7D%7B2%7D%20-%20%5Cfrac%7By%7D%7Bw%7D%5Cright)%5Ccdot%20w_y%20+%20%5Cleft(%5Cfrac%7By%5E%7B2%7D%7D%7B2w%5E%7B2%7D%7D%20-%5Cfrac%7B1%7D%7B2w%7D%20-%5Cfrac%7B1%7D%7B8%7D%5Cright)(C_%7BBS%7D)_w%20(w_y)%5E2%20+%20(C_%7BBS%7D)_w%20%5Ccdot%20w_%7Byy%7D-(C_%7BBS%7D)_w%20%5Ccdot%20w_y%5D%5C%5C%0Aw_T%20&amp;=%20%5Csigma_%7BLV%7D%5E2/2%5B2%20+%202%20%5Cleft(%5Cfrac%7B1%7D%7B2%7D%20-%20%5Cfrac%7By%7D%7Bw%7D%5Cright)%5Ccdot%20w_y%20+%20%5Cleft(%5Cfrac%7By%5E%7B2%7D%7D%7B2w%5E%7B2%7D%7D%20-%5Cfrac%7B1%7D%7B2w%7D%20-%5Cfrac%7B1%7D%7B8%7D%5Cright)(w_y)%5E2%20+%20w_%7Byy%7D-%20%20w_y%5D%5C%5C%0A%5Csigma_%7BLV%7D%5E2%20&amp;=%20%5Cfrac%7Bw_T%7D%7B1%20-%20%5Cfrac%7By%7D%7Bw%7Dw_y%20+%20%5Cfrac%7B1%7D%7B4%7D%5Cleft(%5Cfrac%7By%5E2%7D%7B2w%5E2%7D%20-%20%5Cfrac%7B1%7D%7Bw%7D%20-%20%5Cfrac%7B1%7D%7B4%7D%5Cright)(w_y)%5E2%20+%20%5Cfrac%7B1%7D%7B2%7D%20w_%7Byy%7D%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>This gives us our final result:</p>
<p><span id="eq-local-vol-in-terms-of-implied-vol"><img src="https://latex.codecogs.com/png.latex?%0A%5Cboxed%7B%5Csigma_%7BLV%7D%5E2%20=%20%5Cfrac%7B%5Cfrac%7B%5Cpartial%20w%7D%7B%5Cpartial%20T%7D%7D%7B1%20-%20%5Cfrac%7By%7D%7Bw%7D%5Cfrac%7B%5Cpartial%20w%7D%7B%5Cpartial%20y%7D%20+%20%5Cfrac%7B1%7D%7B4%7D%5Cleft(%5Cfrac%7By%5E2%7D%7B2w%5E2%7D%20-%20%5Cfrac%7B1%7D%7Bw%7D%20-%20%5Cfrac%7B1%7D%7B4%7D%5Cright)(%5Cfrac%7B%5Cpartial%20w%7D%7B%5Cpartial%20y%7D)%5E2%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Cfrac%7B%5Cpartial%5E2%20w%7D%7B%5Cpartial%20y%5E2%7D%7D%7D%0A%5Ctag%7B23%7D"></span></p>
</section>
<section id="implied-variance-is-the-average-of-local-variance-over-the-life-of-the-option-when-there-is-no-skew" class="level2">
<h2 class="anchored" data-anchor-id="implied-variance-is-the-average-of-local-variance-over-the-life-of-the-option-when-there-is-no-skew">Implied variance is the average of local variance over the life of the option when there is no skew</h2>
<p>If the implied volatility <img src="https://latex.codecogs.com/png.latex?%5CSigma"> is independent of the strike, then the skew <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20w%7D%7B%5Cpartial%20y%7D"> is zero.</p>
<p>So, the Dupire’s formula becomes:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Csigma_%7BLV%7D%5E2(w,T)%20&amp;=%20%5Cfrac%7B%5Cpartial%20w%7D%7B%5Cpartial%20T%7D%5C%5C%0A%5CSigma%5E2(T)%20T%20&amp;=%20%5Cint_%7BR%7D%20%5Csigma_%7BLV%7D%5E2%20(w,T)%20dT%5C%5C%0A%5CSigma%5E2(T)%20&amp;=%20%5Cfrac%7B1%7D%7BT%7D%5Cint_%7BR%7D%20%5Csigma_%7BLV%7D%5E2%20(w,T)%20dT%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://engineering.nyu.edu/sites/default/files/2018-09/CarrFinResearchLetters2005.pdf">A note sufficient conditions for no arbitrage</a>, <em>Peter Carr and Dilip Madan</em></li>
<li><a href="https://www.amazon.co.uk/Volatility-Surface-Practitioners-Guide-Finance/dp/0471792519/ref=sr_1_1?crid=3VZ8L0LIO7J24&amp;dib=eyJ2IjoiMSJ9.mJ-yHScvO5YUgkVfwPorn8L9K4zyd5H6qIeL1SxlWPs.CMG7pEJaZU-9EsEoRoz9P2TmJo7AyVECPpkvNcTETbQ&amp;dib_tag=se&amp;keywords=jim+gatheral&amp;qid=1760024387&amp;sprefix=JIm+Gatheral%2Caps%2C92&amp;sr=8-1&amp;ufe=app_do%3Aamzn1.fos.95fd378e-6299-4723-b1f1-3952ffba15af">The volatility surface - A practitioner’s guide</a>, <em>Jim Gatheral</em></li>
</ul>


</section>
</section>

 ]]></description>
  <category>Fin Math</category>
  <guid>http://quantdev.blog/posts/dupire-pde/index.html</guid>
  <pubDate>Tue, 30 Sep 2025 23:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/dupire-pde/image.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
