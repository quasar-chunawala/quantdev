<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>quantdev.blog</title>
<link>http://quantdev.blog/index.html</link>
<atom:link href="http://quantdev.blog/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Tue, 06 Jan 2026 00:00:00 GMT</lastBuildDate>
<item>
  <title>Constructing a 3D Array</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/constructing_a_3d_array/index.html</link>
  <description><![CDATA[ 




<section id="coding-exercise" class="level1">
<h1>Coding Exercise</h1>
<section id="constructing-a-3d-array" class="level2">
<h2 class="anchored" data-anchor-id="constructing-a-3d-array">Constructing a 3D Array</h2>
<p>Implement a function <code>GetSpace</code> such that that it allocates a 3D array of ints of dimensions <code>x</code>, <code>y</code>, and <code>z</code> on the heap. You can find the original coding exercise <a href="https://getcracked.io/problem/8/3d-space?language=Cpp&amp;topic=LanguageKnowledge">here</a>.</p>
</section>
<section id="requirements" class="level2">
<h2 class="anchored" data-anchor-id="requirements">Requirements</h2>
<ul>
<li><p>Return an <code>int***</code>.</p></li>
<li><p>You cannot use any data structures (such as <code>vector</code>).</p></li>
<li><p>You must initialize all values to std::numeric_limits::min() during allocation without a for-loop. Cracked developers prefer STL algorithms to raw loops.</p></li>
<li><p>Consider edge-cases fully. Return <code>nullptr</code> when encountering invalid inputs.</p></li>
</ul>
</section>
<section id="test-cases" class="level2">
<h2 class="anchored" data-anchor-id="test-cases">Test Cases</h2>
<p>Test case inputs are formatted as <code>x</code>,<code>y</code>,<code>z</code> coordinates. For example, <code>4,5,6</code> is <code>size_t x = 4, y = 5, z = 6;</code>.</p>
<p>For more such puzzles, visit <a href="https://getcracked.io">getcracked.io</a>.</p>
</section>
<section id="my-implementation" class="level2">
<h2 class="anchored" data-anchor-id="my-implementation">My Implementation</h2>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Problem: https://getcracked.io/problem/8/3d-space?language=Cpp</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Date: 06-Jan-2025</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compiler Explorer: https://compiler-explorer.com/z/d7PzdexEj</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdlib&gt;</span></span>
<span id="cb1-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;limits&gt;</span></span>
<span id="cb1-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb1-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb1-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span> GetSpace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-15"></span>
<span id="cb1-16">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***&gt;(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-17">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>for_each<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[=](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**&amp;</span> pp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-18">        pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**&gt;(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>for_each<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[=](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&amp;</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-20">            p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-21">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>numeric_limits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;::</span>min<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb1-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb1-24"></span>
<span id="cb1-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb1-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span> arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GetSpace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-30">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/d7PzdexEj">Compiler Explorer</a></p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li>Coding exercises on <a href="https://getcracked.io">getcracked.io</a></li>
</ul>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/constructing_a_3d_array/index.html</guid>
  <pubDate>Tue, 06 Jan 2026 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/constructing_a_3d_array/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Coding Exercise - Grouping lines together</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/grouping_lines_together/index.html</link>
  <description><![CDATA[ 




<section id="coding-exercise." class="level1">
<h1>Coding Exercise.</h1>
<section id="group-lines-by-their-slope." class="level2">
<h2 class="anchored" data-anchor-id="group-lines-by-their-slope.">Group lines by their slope.</h2>
<p>You’ve been given several lines. You’re interested in finding how many lines share the same slope. You’re tasked with writing a method that does exactly that. — For example, if you have two lines with a slope of <code>2.0</code>, and one line with a slope of <code>1.0</code>, the result is <code>{ { 2.0 Slope Line, 2 }, { 1.0 Slope Line, 1 } }</code>. The coding exercise is <a href="https://getcracked.io/problem/20/we-re-stronger-together?language=Cpp&amp;topic=LanguageKnowledge">here</a>.</p>
</section>
<section id="my-implementation" class="level2">
<h2 class="anchored" data-anchor-id="my-implementation">My Implementation</h2>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb1-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;unordered_map&gt;</span></span>
<span id="cb1-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb1-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb1-8"></span>
<span id="cb1-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     </span>
<span id="cb1-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>     </span>
<span id="cb1-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-15">    Point A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-16">    Point B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-17">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> GetSlope<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-20"></span>
<span id="cb1-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> GetSlope<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>GetSlope<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span>    </span>
<span id="cb1-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> std<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&gt;</span></span>
<span id="cb1-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{</span></span>
<span id="cb1-29">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-30">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>h1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{}(</span>point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-31">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>h2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{}(</span>point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-32">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-33">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-35"></span>
<span id="cb1-36">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&gt;</span></span>
<span id="cb1-37">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{</span></span>
<span id="cb1-38">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-39">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{}(</span>line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>GetSlope<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-40">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-41">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-42"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-43"></span>
<span id="cb1-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Lines <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;;</span></span>
<span id="cb1-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Slope <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-46"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Bucket <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Slope<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;;</span></span>
<span id="cb1-47"></span>
<span id="cb1-48"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-49">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> ForwardIterator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-50">    ForwardIterator first_equal_to_or_less_than<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ForwardIterator first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ForwardIterator last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-51">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>upper_bound<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-53">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-54"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-55"></span>
<span id="cb1-56"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> GroupPoints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-57"></span>
<span id="cb1-58">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-59">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Slope<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> slope_count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb1-61">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-62"></span>
<span id="cb1-63">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>for_each<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-64">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-65">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb1-66"></span>
<span id="cb1-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     </span>
<span id="cb1-68"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-69"></span>
<span id="cb1-70"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb1-71"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-72">    Line line1</span>
<span id="cb1-73">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-74">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-75">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-76">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-77">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-78">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-79">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-80">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-81">    Line line2</span>
<span id="cb1-82">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-83">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-84">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-85">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-86">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-87">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb1-88">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-89">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-90">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GroupPoints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span>line1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> line2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb1-91">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-92">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_of_lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-93">        Point A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-94">        Point B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-95">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Line (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)--(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-96">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Freq = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> num_of_lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-97">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-98">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-99"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/3fPPY691E">Compiler Explorer</a></p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li>Coding exercises on <a href="https://getcracked.io">getcracked.io</a></li>
</ul>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/grouping_lines_together/index.html</guid>
  <pubDate>Tue, 06 Jan 2026 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/grouping_lines_together/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>const, constexpr, consteval and constinit</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/const_vs_constexpr_consteval_vs_constinit/index.html</link>
  <description><![CDATA[ 




<section id="const-ness" class="level1">
<h1><code>const</code>-ness</h1>
<p>Constants, by their simplest definition are values that do not change. <code>const</code> correctness is the practice of using the <code>const</code> keyword to prevent <code>const</code> objects from getting mutated.</p>
<blockquote class="blockquote">
<h3 id="just-make-everything-const-that-you-can" class="anchored">Just make everything <code>const</code> that you can!</h3>
</blockquote>
<p>We should add <code>const</code> early and often. Back-patching <code>const</code> correctness results in a snowball effect: every <code>const</code> over here requires four more to be added over there.</p>
<section id="const-functions" class="level2">
<h2 class="anchored" data-anchor-id="const-functions"><code>const</code> functions</h2>
<p>You can declare a non-static member function <code>const</code> if it doesn’t change the value of the underlying object.</p>
<p>In case a function has two overloaded versions where one is <code>const</code> and the other is not, the compiler will choose which one to call based on whether the object itself is <code>const</code> or not.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb1-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;initializer_list&gt;</span></span>
<span id="cb1-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-8"></span>
<span id="cb1-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> </span>
<span id="cb1-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"double&amp; x()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb1-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb1-20">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"const double&amp; x() const"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> </span>
<span id="cb1-21">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb1-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-24">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> </span>
<span id="cb1-25">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"double&amp; y()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-26">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb1-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb1-30">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"const double&amp; y() const"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-31">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb1-33">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-34"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-35"></span>
<span id="cb1-36"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-39"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb1-40">    Point p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-41">    p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-42">    p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-43"></span>
<span id="cb1-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point p2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-45">    p2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-46">    p2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-48"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/sbbff5nYY">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">double&amp; x()</span>
<span id="cb2-2">x = 3</span>
<span id="cb2-3">double&amp; y()</span>
<span id="cb2-4">y = 4</span>
<span id="cb2-5">const double&amp; x() const</span>
<span id="cb2-6">x = 1</span>
<span id="cb2-7">const double&amp; y() const</span>
<span id="cb2-8">y = -1</span></code></pre></div>
</section>
<section id="const-variables" class="level2">
<h2 class="anchored" data-anchor-id="const-variables"><code>const</code> variables</h2>
<p>If you add the <code>const</code> qualifier to the type of a local variable, the local variable is immutable. Declaring variables as <code>const</code> also helps the compiler to perform some optimizations.</p>
<p>A member of a <code>const</code>-qualified <code>struct</code> or <code>union</code> type acquires the qualification of the type it belongs to.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb3-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> ci<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> S cs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the types of cs.i and cs.ci are </span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// both const int</span></span></code></pre></div>
<p>If an array type is declared with the <code>const</code> type qualifier, it’s elements are considered <code>const</code>.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> A a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// int* pi = a[0]; // a[0] is const int*</span></span></code></pre></div>
<p>A pointer to a non-<code>const</code> type can be implicitly converted to a pointer to const-qualified version of the same. The reverse conversion requires a cast expression.</p>
</section>
<section id="const-members" class="level2">
<h2 class="anchored" data-anchor-id="const-members"><code>const</code> members</h2>
<p>Having <code>const</code> local variables is good. Having <code>const</code> as a member variable is never a good idea. You cannot copy assign or move assign to the objects of such a type.</p>
</section>
<section id="const-return-types" class="level2">
<h2 class="anchored" data-anchor-id="const-return-types"><code>const</code> return types</h2>
<p>When returning objects by value, it is not recommended to use the <code>const</code> qualifier. It would be misleading to return a value by <code>const</code> object. RVO(Return Value Optimization) only kicks in when you return an object by value without the <code>const</code> qualifier.</p>
<p>Imagine that we need the unit vectors <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bi%7D%20=%20(1,0)"> and <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bj%7D%20=%20(0,1)"> in the physics engine in our game. We might specify these vectors as:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point unit_vector_i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point unit_vector_j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>When an object is declared <code>const</code>, all its subobjects are <code>const</code>. This aligns with our intuition. Being able to modify the coordinates of the basis vectors should be an illegal and makes no sense.</p>
<p>Hence, the <code>x()</code> and <code>y()</code> getter methods should have a <code>const</code> version, that operates on <code>const Point</code> objects and returns a constant reference.</p>
</section>
<section id="const-function-parameters" class="level2">
<h2 class="anchored" data-anchor-id="const-function-parameters"><code>const</code> function parameters</h2>
<p>Consider the following code:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// declaration of f(int)</span></span>
<span id="cb6-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// re-declaration of f(int)</span></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// defintion of f(int)</span></span>
<span id="cb6-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//re-definition of f(int)</span></span></code></pre></div>
<p>A function declaration tells the compiler the function’s signature and return type. One line 2, the <code>const</code>ness of the function’s parameter type is ignored. Similarly, line 4 is a definition of the same function <code>f(int)</code>, which will result in an error at link time. Multiple declarations are allowed, but only a single definition is permitted.</p>
<section id="meaning-of-const-in-function-declarations" class="level3">
<h3 class="anchored" data-anchor-id="meaning-of-const-in-function-declarations">Meaning of <code>const</code> in function declarations</h3>
<p>Not all <code>const</code> qualifications in function declarations are ignored. To quote from from the C++ standard,</p>
<blockquote class="blockquote">
<p><em><code>const</code> type-specifiers buried within a parameter type specification are significant and can be used to distinguish overloaded function declarations.</em></p>
</blockquote>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 1</span></span>
<span id="cb7-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 2</span></span>
<span id="cb7-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unique_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 3</span></span>
<span id="cb7-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 4</span></span></code></pre></div>
<p>In all of the above examples, the parameter <code>x</code> itself is never declared <code>const</code>. <code>const</code> is buried inside the parameter type, hence each has a declaration has a different parameter type, forming an overload set.</p>
</section>
</section>
</section>
<section id="constexpr" class="level1">
<h1><code>constexpr</code></h1>
<section id="constexpr-variables" class="level2">
<h2 class="anchored" data-anchor-id="constexpr-variables"><code>constexpr</code> variables</h2>
<p>Let’s review the definition of a literal type. According to the <a href="https://eel.is/c++draft/basic.types.general#10">standard</a>:</p>
<p>A literal type is one whose layout can be determined at compile time. The following are the literal types:</p>
<ul>
<li><code>void</code></li>
<li>Scalar types</li>
<li>References</li>
<li>Arrays of void, scalar types or references</li>
<li>A class that has a <code>constexpr</code> destructor, and one or more constexpr constructors that are not move or copy constructors. Additionally, all its non-static data members and base classes must be literal types and not volatile.</li>
</ul>
<p>The primary difference between <code>const</code> and <code>constexpr</code> variable is that the initialization of a <code>const</code> variable can be deferred to compile-time. A <code>constexpr</code> variable must be initialized at compile time. All <code>constexpr</code> variables are <code>const</code>, but the converse is not true.</p>
<ul>
<li><p>A variable can be declared with <code>constexpr</code>, when it has a literal type and is initialized. If the initialization is performed by a constructor, the constructor must be declared as <code>constexpr</code>.</p></li>
<li><p>A reference may be declared as <code>constexpr</code> if and only if the referenced object is initialized by a constant expression.</p></li>
<li><p>All declarations of a <code>constexpr</code> variable or function must have <code>constexpr</code> specifier.</p></li>
</ul>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0e8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> G <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.67430e-11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</section>
<section id="constexpr-functions" class="level2">
<h2 class="anchored" data-anchor-id="constexpr-functions"><code>constexpr</code> functions</h2>
<p>A <code>constexpr</code> function is one whose return value is computable at compile time. The caller(consuming code) requires the return value at compile-time to initialize a <code>constexpr</code> variable, or to provide a non-type template argument. When a <code>constexpr</code> function is passed arguments known at compile-time, it produces function produces a compile-time constant. When called with non-<code>constexpr</code> arguments, or when its return value isn’t required at compile-time, it produces a value at run time like a regular function. This dual behavior saves you from having to write <code>constexpr</code> and non-<code>constexpr</code> versions of the same function. It follows that, you cannot specify <code>constexpr</code> on the variables in the parameter list of a <code>constexpr</code> function. Recall, <code>constexpr</code> variables must be initialized at compile-time.</p>
<p>A <code>constexpr</code> function or constructor is implicitly <code>inline</code>. The <code>inline</code> keyword suggests to the compiler to substitute the code within the function definition in place of each call to the function.</p>
<p>The following rules apply to <code>constexpr</code> functions:</p>
<ul>
<li>A <code>constexpr</code> function must accept and return only literal types.</li>
<li>The body can be defined as <code>=default</code> or <code>=delete</code>. This also applies to constructors and destructors.</li>
<li>The body cannot contain <code>try</code> blocks.</li>
</ul>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb9-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb9-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;array&gt;</span></span>
<span id="cb9-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdlib&gt;</span></span>
<span id="cb9-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cmath&gt;</span></span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Point is a literal type</span></span>
<span id="cb9-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-11"></span>
<span id="cb9-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb9-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span> </span>
<span id="cb9-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-16"></span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Line is not a literal type. </span></span>
<span id="cb9-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Its destructor is not constexpr.</span></span>
<span id="cb9-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-20">    Point <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-21">    Point <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-22"></span>
<span id="cb9-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){}</span></span>
<span id="cb9-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-25"></span>
<span id="cb9-26"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb9-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> Point p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> Point o<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>o<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-30">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distance from origin to (3.0,4.0) = "</span></span>
<span id="cb9-31">              <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/5GvPWaazd">Compiler Explorer</a></p>
</section>
<section id="challenge-puzzle" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle">Challenge puzzle</h2>
<p>Which line should we remove to make this program compile successfully?</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb10-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li><ol type="a">
<li><code>std::cout &lt;&lt; x;</code></li>
</ol></li>
<li><ol start="2" type="a">
<li><code>static_assert(c &gt; 0);</code></li>
</ol></li>
<li><ol start="3" type="a">
<li><code>constexpr int n = first(4);</code></li>
</ol></li>
<li><ol start="4" type="a">
<li><code>int result = second(b);</code></li>
</ol></li>
</ul>
<p>For more such puzzles, visit <a href="https://getcracked.io">getcracked.io</a></p>
</section>
</section>
<section id="constinit-keyword" class="level1">
<h1><code>constinit</code> keyword</h1>
<p><code>constinit</code> keyword can be used to force and ensure that a mutable <code>static</code> or global variable is initialized at compile-time. So, roughly speaking the effect is described as :</p>
<pre><code>constinit = constexpr - const</code></pre>
<p>A <code>constinit</code> variable is <strong><em>not <code>const</code></em></strong>. The keyword would be better named <code>compileinit</code> or something.</p>
<p>You can use <code>constinit</code> whenever you declare a static or a global variable. For example,</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constinit</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> incrementCounter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constinit</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> counter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>counter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> getCollection<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb12-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constinit</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> globalCollection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> getCollection<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span></code></pre></div>
<p>You can still modify the declared values. The effect of using <code>constinit</code> is that the initialization only compiles if the initial value is known at compile-time.</p>
<p>There are a couple of things to repect when using <code>constinit</code> in practice.</p>
<p>First, you cannot initialize a <code>constinit</code> value with another <code>constinit</code> value:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constinit</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//f() must be constexpr</span></span>
<span id="cb13-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constinit</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Error: x is not a constant initializer</span></span></code></pre></div>
<p>The reason is that the initial value must be a constant value known at compile time, but <code>constinit</code> values are not constant. So, <code>x</code> is open for modification at run-time, prior to assigning it to <code>y</code>. The next code snip compiles fine:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//f() must be a compile-time function</span></span>
<span id="cb14-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constinit</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span></code></pre></div>
<p>When initializing objects, a compile-time constructor is required. However, a compile-time destructor is not required.</p>
<p><code>constinit</code> does not imply inline (this is different from <code>constexpr</code>).</p>
<section id="how-constinit-solves-the-static-initialization-order-fiasco" class="level2">
<h2 class="anchored" data-anchor-id="how-constinit-solves-the-static-initialization-order-fiasco">How <code>constinit</code> solves the static initialization order fiasco?</h2>
<p>In C++, there is a problem called the <em>static initialization order fiasco</em>, which <code>constinit</code> can solve. The problem is that the order of static and global initializations in different translation units is not defined.</p>
<p>Assume that we have a type with a constructor to initialize the objects and introduce an extern global object of this type:</p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><em><a href="https://isocpp.org/wiki/faq/const-correctness#const-ref-alt"><code>const</code> correctness</a>, C++ core guidelines</em>.</li>
<li><em>C++ 20 - The complete guide, by Nikolai Josuttis</em>.</li>
</ul>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/const_vs_constexpr_consteval_vs_constinit/index.html</guid>
  <pubDate>Mon, 29 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/const_vs_constexpr_consteval_vs_constinit/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Hash Maps</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/hash_map/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p><code>std::unordered_map</code> is C++’s hash table container, providing amortized <img src="https://latex.codecogs.com/png.latex?O(1)"> constant-time search, insertion and deletion operations with unique keys on average. In this blog post, I explore the basic API of <code>unordered_map</code>.</p>
</section>
<section id="construction" class="level1">
<h1>Construction</h1>
<p><code>std::unordered_map</code> is a class template in the header <code>&lt;unordered_map&gt;</code>.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> pmr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span></span>
<span id="cb1-3">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Hash <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-6">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> KeyEqual <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>equal_to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> unordered_map <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb1-8">          <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> KeyEqual<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9">              <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pmr<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">::</span>polymorphic_allocator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;;</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>It allows you specify a custom hash function <code>hash</code>, <code>equal</code> function to compare keys and <code>alloc</code> as a custom allocator.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;unordered_map&gt;</span></span>
<span id="cb2-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb2-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb2-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb2-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Default construction</span></span>
<span id="cb2-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> word_count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-9"></span>
<span id="cb2-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initializer list construction</span></span>
<span id="cb2-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> symbol_to_price_levels_map </span>
<span id="cb2-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AAPL"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">101.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">102.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb2-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GOOG"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1500.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1505.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1510.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span></span>
<span id="cb2-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-16"></span>
<span id="cb2-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with bucket count hint</span></span>
<span id="cb2-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 100 buckets</span></span>
<span id="cb2-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-20"></span>
<span id="cb2-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Range construction (accepts a pair of iterators)</span></span>
<span id="cb2-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> word_count_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb2-23">        word_count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> word_count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb2-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-25"></span>
<span id="cb2-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy construction</span></span>
<span id="cb2-27">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fedor Pikus"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Performance GOAT"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-29">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Herb Sutter"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C++ Visionary"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-30">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Carmack"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legendary programmer"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-32"></span>
<span id="cb2-33">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> cache_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-34"></span>
<span id="cb2-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// move construction</span></span>
<span id="cb2-36">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> word_count2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>word_count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)};</span></span>
<span id="cb2-37"></span>
<span id="cb2-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with a custom hash function</span></span>
<span id="cb2-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Knuth's multiplicative hash</span></span>
<span id="cb2-40">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> CustomHash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-41">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-42">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2654435761</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-43">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-44">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-45"></span>
<span id="cb2-46">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CustomHash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> map_with_custom_hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-47"></span>
<span id="cb2-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with a custom hash and custom equality</span></span>
<span id="cb2-49">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-50">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-51">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-52"></span>
<span id="cb2-53">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-54">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-55">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-56">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-57"></span>
<span id="cb2-58">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> point_equal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-59">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-60">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-61"></span>
<span id="cb2-62">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> point_hash <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-63">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>h1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{}(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-64">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>h2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{}(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-65">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> h1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-66">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-67"></span>
<span id="cb2-68">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb2-69">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>point_hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>point_equal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;</span> points_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-70"></span>
<span id="cb2-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// from a vector of pairs</span></span>
<span id="cb2-72">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-73"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Ys83asq47">Compiler Explorer</a></p>
</section>
<section id="insertion" class="level1">
<h1>Insertion</h1>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;unordered_map&gt;</span></span>
<span id="cb3-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb3-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb3-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb3-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb3-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-9"></span>
<span id="cb3-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// array index operator</span></span>
<span id="cb3-11">    map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carl Gauss"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-12">    map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Augustin Louis Cauchy"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-13"></span>
<span id="cb3-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// insert(pair(k,v))</span></span>
<span id="cb3-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// returns pair&lt;iterator,bool&gt;. bool is true</span></span>
<span id="cb3-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if the insert succeeds, else false</span></span>
<span id="cb3-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>it1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Joseph Fourier"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb3-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>it2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Josepph Lagrange"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb3-19">    </span>
<span id="cb3-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// void insert(initializer_list)</span></span>
<span id="cb3-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// insert from an initializer list</span></span>
<span id="cb3-22">    map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb3-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Riemann"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb3-25">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ada Lovelace"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb3-27">    </span>
<span id="cb3-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// emplace(Args&amp;&amp; ...)</span></span>
<span id="cb3-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// inserts a new element into the container constructed</span></span>
<span id="cb3-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// in-place with the given args, if there is no element</span></span>
<span id="cb3-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with the key in the container</span></span>
<span id="cb3-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>it3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>emplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Leonard Euler"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-33"></span>
<span id="cb3-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The new element may be constructed even if there already</span></span>
<span id="cb3-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// is an element with the key in the container, in which case</span></span>
<span id="cb3-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the newly constructed element will be destroyed immediately</span></span>
<span id="cb3-37">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-38">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"David Hilbert"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-39">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"emplace(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">) called"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-40"></span>
<span id="cb3-41">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>it4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>emplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-42">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"success flag : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-43"></span>
<span id="cb3-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// try_emplace(Key&amp;&amp;, Args&amp;&amp;)</span></span>
<span id="cb3-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if the key k already exists in the container, do nothing</span></span>
<span id="cb3-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Otherwise, insert a new element into the container</span></span>
<span id="cb3-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with key k and value constructed with args</span></span>
<span id="cb3-48">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>it5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>try_emplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"David Hilbert"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-49"></span>
<span id="cb3-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// range insert - takes a pair of iterators</span></span>
<span id="cb3-51">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-52">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Andrew Kolmogorov"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb3-53">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Emile Borel"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-54">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-55"></span>
<span id="cb3-56">    map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb3-57"></span>
<span id="cb3-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// insert_range(R&amp;&amp; rg)</span></span>
<span id="cb3-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Inserts a copyn of each element in the range rg </span></span>
<span id="cb3-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if and only if each of the keys are not </span></span>
<span id="cb3-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// already present in the map</span></span>
<span id="cb3-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> rg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Guido Cantelli"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Terrence Tao"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}};</span></span>
<span id="cb3-63">    map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-64"></span>
<span id="cb3-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// insert_or_assign(key, obj)</span></span>
<span id="cb3-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If a key k already exists in the container, assigns</span></span>
<span id="cb3-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// obj to the key k. If the key k does not exist, </span></span>
<span id="cb3-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// it inserts the new value as if by insert.</span></span>
<span id="cb3-69">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>it6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert_or_assign<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"William Feller"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-70">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>it7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> success7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert_or_assign<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Andrew Wiles"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-71">    </span>
<span id="cb3-72">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-73"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/bhW3rz653">Compiler Explorer</a></p>
</section>
<section id="search" class="level1">
<h1>Search</h1>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;unordered_map&gt;</span></span>
<span id="cb4-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb4-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb4-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb4-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> PhoneRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>full_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>phone<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb4-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PhoneRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> phone_book<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-15">    phone_book<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({</span></span>
<span id="cb4-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Smith"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Smith"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"123 Main Street, New York, NY 10001"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(212) 555-1234"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1234"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mary Johnson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mary Johnson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"456 Oak Avenue, Los Angeles, CA 90001"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(213) 555-2345"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2345"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Robert Williams"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Robert Williams"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"789 Pine Road, Chicago, IL 60601"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(312) 555-3456"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3456"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Patricia Brown"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Patricia Brown"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"321 Maple Drive, Houston, TX 77001"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(713) 555-4567"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4567"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-20">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Michael Jones"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Michael Jones"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"654 Cedar Lane, Phoenix, AZ 85001"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(602) 555-5678"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5678"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-21">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Linda Garcia"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Linda Garcia"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"987 Elm Court, Philadelphia, PA 19101"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(215) 555-6789"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6789"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"David Miller"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"David Miller"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"147 Birch Place, San Antonio, TX 78201"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(210) 555-7890"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7890"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-23">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Barbara Davis"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Barbara Davis"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"258 Walnut Boulevard, San Diego, CA 92101"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(619) 555-8901"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8901"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Richard Rodriguez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Richard Rodriguez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"369 Cherry Way, Dallas, TX 75201"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(214) 555-9012"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"9012"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-25">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Susan Martinez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Susan Martinez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"741 Hickory Circle, San Jose, CA 95101"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(408) 555-0123"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0123"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-26">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Joseph Hernandez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Joseph Hernandez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"852 Willow Terrace, Austin, TX 78701"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(512) 555-1235"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1235"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jessica Lopez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jessica Lopez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"963 Poplar Parkway, Jacksonville, FL 32099"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(904) 555-2346"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2346"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Thomas Gonzalez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Thomas Gonzalez"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"159 Sycamore Trail, Fort Worth, TX 76101"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(817) 555-3457"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3457"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-29">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sarah Wilson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sarah Wilson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"357 Ash Street, Columbus, OH 43085"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(614) 555-4568"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4568"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-30">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Charles Anderson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Charles Anderson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"486 Magnolia Avenue, Charlotte, NC 28201"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(704) 555-5679"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5679"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-31">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Karen Thomas"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Karen Thomas"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"753 Dogwood Road, San Francisco, CA 94101"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(415) 555-6780"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6780"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-32">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Christopher Taylor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Christopher Taylor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"951 Redwood Drive, Indianapolis, IN 46201"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(317) 555-7891"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7891"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-33">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nancy Moore"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nancy Moore"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"246 Sequoia Lane, Seattle, WA 98101"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(206) 555-8902"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8902"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span></span>
<span id="cb4-34">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Daniel Jackson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Daniel Jackson"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"135 Fir Court, Denver, CO 80201"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(303) 555-9013"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"9013"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}},</span>        </span>
<span id="cb4-35">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb4-36"></span>
<span id="cb4-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// iter = find(const Key&amp; key);</span></span>
<span id="cb4-38">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> phone_book<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>find<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Robert Williams"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> phone_book<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb4-40">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> record<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-41">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Key = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-42">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Full name = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> record<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>full_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-43">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Address = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> record<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-44">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Phone = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> record<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>phone<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-45">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-46"></span>
<span id="cb4-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// contains(), at()</span></span>
<span id="cb4-48">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Robert Williams"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>phone_book<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>contains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb4-50">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-51">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Key exists: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-52">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> record <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> phone_book<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-53">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-54"></span>
<span id="cb4-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Array index operator</span></span>
<span id="cb4-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// operator[]() returns a reference to the value that</span></span>
<span id="cb4-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// is mapped to the key k, performing an insertion if</span></span>
<span id="cb4-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// such a key does not exist.</span></span>
<span id="cb4-59">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> letter_counts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'c'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}};</span></span>
<span id="cb4-60">    println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"letter_counts initially contains: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> letter_counts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-61">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> result1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> letter_counts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb4-62">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> result2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> letter_counts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// just inserts the pair ('d', 0)</span></span>
<span id="cb4-63">    println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"letter_counts now contains: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> letter_counts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-64"></span>
<span id="cb4-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// at(Key&amp; key)</span></span>
<span id="cb4-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Returns a reference to the mapped value of the element</span></span>
<span id="cb4-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with specified key. If no such element exists, an</span></span>
<span id="cb4-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// exception of the type std::out_of_range is thrown.</span></span>
<span id="cb4-69">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> result3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> letter_counts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   </span>
<span id="cb4-70">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-71">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> result4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> letter_counts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'e'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-72">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>out_of_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-73">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Out of range exception occured!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-74">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-75">    </span>
<span id="cb4-76">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-77"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/9E4d78n4E">Compiler Explorer</a></p>
</section>
<section id="deletion" class="level1">
<h1>Deletion</h1>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;unordered_map&gt;</span></span>
<span id="cb5-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb5-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb5-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb5-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> PhoneRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>full_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>phone<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb5-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-15">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"three"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb5-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"four"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"five"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"six"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-18"></span>
<span id="cb5-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// erase(pos) by iterator</span></span>
<span id="cb5-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// It removes the specified element from the container</span></span>
<span id="cb5-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// and returns an iterator following the last modified</span></span>
<span id="cb5-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// element.</span></span>
<span id="cb5-23"></span>
<span id="cb5-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The order of the remaining elements is preserved.</span></span>
<span id="cb5-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This makes it possible to erase individual elements</span></span>
<span id="cb5-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// while iterating the container.</span></span>
<span id="cb5-27"></span>
<span id="cb5-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pos is an iterator to the element to be removed.</span></span>
<span id="cb5-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Any references and iterators to erased elements </span></span>
<span id="cb5-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// are invalidated. </span></span>
<span id="cb5-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()};</span> it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span>map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();){</span></span>
<span id="cb5-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-33">            it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>erase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb5-35">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-37"></span>
<span id="cb5-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// erase(key) by key</span></span>
<span id="cb5-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// It removes the element (if one exists) with the key.</span></span>
<span id="cb5-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// It returns the number of elements removed (0 or 1).</span></span>
<span id="cb5-41">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>num_elements_removed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>erase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-42"></span>
<span id="cb5-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// clear</span></span>
<span id="cb5-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// clear() removes all elements</span></span>
<span id="cb5-45">    map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>clear<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb5-46"></span>
<span id="cb5-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// node_type extract(pos)</span></span>
<span id="cb5-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// unlinks the node that contains the element pointed to </span></span>
<span id="cb5-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// by pos and returns a node handle that owns it.</span></span>
<span id="cb5-50">    </span>
<span id="cb5-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// node_type extract(key)</span></span>
<span id="cb5-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// unlinks the node corresponding to key and returns</span></span>
<span id="cb5-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a node_handle to it, else returns an empty node_handle</span></span>
<span id="cb5-54">    </span>
<span id="cb5-55"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/6TdzxM7Px">Compiler Explorer</a></p>
</section>
<section id="how-to-choose-a-good-hash-function" class="level1">
<h1>How to choose a good hash function?</h1>
<ul>
<li>Input data often has patterns and is <em>not random</em>. So, good hash functions should generate hash values that are uniformly distributed.</li>
<li>Avalanche effect. A small change in the hash function (e.g.&nbsp;flipping a single bit) should change the output significantly.</li>
<li>Hash functions should be fast. Cryptographic hash functions like SHA-1, SHA-256, SHA-512, MD-5 are extremely secure, and we use them everyday for encryption, checksumming etc. but they are slow to compute. They are designed such that it is maximally difficult to produce collisions.</li>
<li>Sometimes you are tracking large datasets e.g.&nbsp;a genetic dataset and you just want to know, if you have seen it before. You don’t want to keep the whole thing in a <code>std::set</code>, because your memory usage is going to skyrocket. Instead, you want to just keep a number that represents it.</li>
</ul>
<p>At it’s core, a hash function can simply be described as follows:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> hash_function(data: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bytes</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb6-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> data:</span>
<span id="cb6-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hash</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cleverness(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hash</span>, chunk)</span>
<span id="cb6-4"></span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hash</span></span></code></pre></div>
<p>Basically, you have a rolling hash value, we can think of it as a context or a state, but its ultimately just a number and we have a block of input data <code>chunk</code> (perhaps <img src="https://latex.codecogs.com/png.latex?1"> byte or <img src="https://latex.codecogs.com/png.latex?4"> bytes), and you mix those and then you will generate another number. Now, you may have some pre- and post- processing depending on the function, but that’s pretty much how it works. The <code>cleverness</code> thing is actually what’s called a <em>mixing</em> function. If you ever see the word <em>mixing</em> function on the wikipedia page, this is what it refers to.</p>
<section id="how-do-you-implement-this-cleverness-function" class="level2">
<h2 class="anchored" data-anchor-id="how-do-you-implement-this-cleverness-function">How do you implement this cleverness function?</h2>
<p>In general you do it with unsigned, fixed length integers. You use:</p>
<ul>
<li>Bitwise operations (xor, rotation, unsigned bit shifts)</li>
<li>Multiplication</li>
<li>Usually, there is atleast one magic number e.g.&nbsp;a prime number.</li>
</ul>
<p>In hash table implementations, buckets are often a power of <img src="https://latex.codecogs.com/png.latex?2"> e.g.&nbsp;you might have <img src="https://latex.codecogs.com/png.latex?128"> buckets or <img src="https://latex.codecogs.com/png.latex?256">. If you have the same factorization of the number of buckets as some of the constants to manipulate the state of the hash function, you can end up bucketing everything actually into the same thing.</p>
<section id="fnv-1a" class="level3">
<h3 class="anchored" data-anchor-id="fnv-1a">FNV-1A</h3>
<p>FNV1-A is venerable hash function created by Fowler, Knoll and Vo in 1991 and has been improved a couple of times since. It’s still in wide use today.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb7-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdint&gt;</span></span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32_t</span> fnv1a32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>byte<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>num_bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb7-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This is actually the hash of the email </span></span>
<span id="cb7-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// signatures of one of the creators of FNV.</span></span>
<span id="cb7-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32_t</span> hash <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2166136261</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>num_bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb7-9">        hash <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb7-10">        hash <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16777619</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-11"></span>
<span id="cb7-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> hash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/z4a9nsPez">Compiler Explorer</a> Suppose that the input string is <code>"ab"</code>. We get the following hash code from the FNV algorithm:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1">hash(0) = 10000001000111001001110111000101</span>
<span id="cb8-2">byte[0] =                          1100001</span>
<span id="cb8-3">XOR     = 10000001000111001001110110100100</span>
<span id="cb8-4">hash(1) = 11100100000011000010100100101100</span>
<span id="cb8-5">byte[1] =                          1100010</span>
<span id="cb8-6">XOR     = 11100100000011000010100101001110</span>
<span id="cb8-7">hash(2) =  1001101001001010000010111001010</span></code></pre></div>
<p>The XOR changes only a few bits, so that’s why the multiplier is there. Actually, <img src="https://latex.codecogs.com/png.latex?16777619"> is the prime closest to <img src="https://latex.codecogs.com/png.latex?2%5E24">. It gives you bit-shifting behavior as well. FNV1a kind of hides this bit-shifting, but every other algorithm uses bit shifts heavily to get this avalanche behavior. So, what this is doing is, it’s going to shift everything and then its going add some noise to the lower end of the number.</p>
<p><code>16'777'619</code> in binary is <code>0b0000 0001 0000 0000 0000 0001 1001 0011</code>. When you multiply this number, you are essentially doing:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ahash%20%5Ctimes%2016777619%20=%20hash%20%5Ctimes%20(2%5E%7B24%7D%20+%202%5E8%20+%202%5E7%20+%202%5E4%20+%202%5E1%20+%202%5E0)%0A"></p>
<p>To keep things simple, consider the value <code>5 = 0b0101</code>. Assume we multiply <img src="https://latex.codecogs.com/png.latex?5%20%5Ctimes%208%20=%205%20%5Ctimes%202%5E3">. Using the rules of binary multiplication, we get:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1"> 0b0000 0101</span>
<span id="cb9-2">x0b0000 1000</span>
<span id="cb9-3">------------</span>
<span id="cb9-4">           0</span>
<span id="cb9-5">          00</span>
<span id="cb9-6">         000</span>
<span id="cb9-7"> 0b 010 1000</span>
<span id="cb9-8">------------</span>
<span id="cb9-9"> 0b 010 1000</span></code></pre></div>
<p>Hence, <code>x * 2^3</code> is like <code>x &lt;&lt; 3</code>.</p>
<p>So, the first byte <code>a = 0b0110 0001</code> has a hash value of <code>0b1110 0100 0000 1100 0010 1001 0010 1100</code>. If we look at the next byte <code>b = 0b0110 0010</code>, it has just 2 bits different from the first byte, but the hash value is <code>0b0100 1101 0010 0101 0000 0101 1100 1010</code>.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb10-1">0b1110 0100 0000 1100 0010 1001 0010 1100</span>
<span id="cb10-2">0b0100 1101 0010 0101 0000 0101 1100 1010</span>
<span id="cb10-3">  ^ ^  ^  ^   ^  ^  ^   ^  ^^   ^^^   ^^</span></code></pre></div>
<p>You can see how well distributed are two similar bytes. Every nibble has <img src="https://latex.codecogs.com/png.latex?1"> or <img src="https://latex.codecogs.com/png.latex?2"> bits that are being changed. So, we are already seeing a real avalanche behavior here. Things are getting moved, things are getting mutated, it all looks cool.</p>
<p>Let us look at few hash functions that are considered to be reasonably state-of-the-art.</p>
</section>
<section id="murmur-hash" class="level3">
<h3 class="anchored" data-anchor-id="murmur-hash">Murmur Hash</h3>
<pre><code>algorithm Murmur3_32 is
    // Note: In this version, all arithmetic is performed with unsigned 32-bit integers.
    //       In the case of overflow, the result is reduced modulo 232.
    input: data, len, seed

    c1 ← 0xcc9e2d51
    c2 ← 0x1b873593
    r1 ← 15
    r2 ← 13
    m ← 5
    n ← 0xe6546b64

    hash ← seed

    for each fourByteChunk of data do
        k ← fourByteChunk

        k ← k × c1
        k ← (k &lt;&lt; r1) | (k &gt;&gt; (32 - r1))
        k ← k × c2

        hash ← hash XOR k
        hash ← (hash &lt;&lt; r2) | (hash &gt;&gt; (32 - r2))
        hash ← (hash × m) + n

    with any remainingBytesInKey do
        remainingBytes ← SwapToLittleEndian(remainingBytesInKey)
        // Note: Endian swapping is only necessary on big-endian machines.
        //       The purpose is to place the meaningful digits towards the low end of the value,
        //       so that these digits have the greatest potential to affect the low range digits
        //       in the subsequent multiplication.  Consider that locating the meaningful digits
        //       in the high range would produce a greater effect upon the high digits of the
        //       multiplication, and notably, that such high digits are likely to be discarded
        //       by the modulo arithmetic under overflow.  We don't want that.

        remainingBytes ← remainingBytes × c1
        remainingBytes ← (remainingBytes &lt;&lt; r1) | (remainingBytes &gt;&gt; (32 - r1))
        remainingBytes ← remainingBytes × c2

        hash ← hash XOR remainingBytes

    hash ← hash XOR len

    hash ← hash XOR (hash &gt;&gt; 16)
    hash ← hash × 0x85ebca6b
    hash ← hash XOR (hash &gt;&gt; 13)
    hash ← hash × 0xc2b2ae35
    hash ← hash XOR (hash &gt;&gt; 16)</code></pre>
<p>Murmur3 hash has a few constants. Quite a few of those are primes. There is also a seed value that sometimes the user provides or is hardcoded at times. It also means that, if you want to generate different hash values for different users, you have a way to do it.</p>
<p>Then we start the mixing function. Murmur hash operates on <img src="https://latex.codecogs.com/png.latex?4"> bytes at a time, rather than <img src="https://latex.codecogs.com/png.latex?1"> byte. We multiply, do some bit shifting to try and get the values distributed more evenly, then again multiply, exclusive OR and then more stuff and it gets mutated.</p>
<p>If there are less than <img src="https://latex.codecogs.com/png.latex?4"> bytes, remaining then there is an alternative mixing function.</p>
<p>Finally, at the end we have, we have a series of post-processing steps to try and introduce more randomness into the whole thing. Again, we have multiplication with some constants and bit shifting to maximize distributing the hash.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb12-1">hash ← hash XOR len</span>
<span id="cb12-2"></span>
<span id="cb12-3">hash ← hash XOR (hash &gt;&gt; 16)</span>
<span id="cb12-4">hash ← hash × 0x85ebca6b</span>
<span id="cb12-5">hash ← hash XOR (hash &gt;&gt; 13)</span>
<span id="cb12-6">hash ← hash × 0xc2b2ae35</span>
<span id="cb12-7">hash ← hash XOR (hash &gt;&gt; 16)</span></code></pre></div>
</section>
</section>
</section>
<section id="the-theory-of-hashing" class="level1">
<h1>The theory of hashing</h1>
<p>The goal of hashing is to provide a solution that is faster than binary trees.</p>
<p>The formal setup for hashing is as follows:</p>
<ul>
<li><p>The keys come from some large universe <img src="https://latex.codecogs.com/png.latex?U">.</p></li>
<li><p>We will perform inserts and lookups by having an array of size <img src="https://latex.codecogs.com/png.latex?M">, and a hash function <img src="https://latex.codecogs.com/png.latex?h:U%20%5Cto%20%5C%7B0,%5Cldots,M-1%5C%7D">. Given an element <img src="https://latex.codecogs.com/png.latex?x">, the idea of hashing is we want to store it in <img src="https://latex.codecogs.com/png.latex?A%5Bh(x)%5D">.</p></li>
<li><p>We need a method for resolving collisions. A collision is when <img src="https://latex.codecogs.com/png.latex?h(x)%20=%20h(y)"> for two different <img src="https://latex.codecogs.com/png.latex?x"> and <img src="https://latex.codecogs.com/png.latex?y">. There are two methods to handle collisions:</p>
<ul>
<li>Separate chaining</li>
<li>Open addressing</li>
</ul></li>
</ul>
<section id="separate-chaining" class="level2">
<h2 class="anchored" data-anchor-id="separate-chaining">Separate chaining</h2>
<p>In the event, that multiple keys are hashed to the same slot, we store the keys in a linked list on that slot.</p>
<p>Let’s compute the mean and variance of the chain length. For slot <img src="https://latex.codecogs.com/png.latex?t">, let <img src="https://latex.codecogs.com/png.latex?C_t"> be the random variable equal to length of the linked list chain corresponding to slot <img src="https://latex.codecogs.com/png.latex?t">.</p>
<p>The expected chain length <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BE%7D%5BC_t%5D"> is constant. We can write <img src="https://latex.codecogs.com/png.latex?I_j"> be the indicator random variable which is <img src="https://latex.codecogs.com/png.latex?1">, if the hash of <img src="https://latex.codecogs.com/png.latex?x_j"> falls in bucket <img src="https://latex.codecogs.com/png.latex?t">, else 0. Then, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0AC_t%20&amp;=%20I_1%20+%20%5Cldots%20+%20I_n%20%5C%5C%0A%5Cmathbf%7BC_t%7D%20&amp;=%20%5Csum_%7Bj=1%7D%5E%7Bn%7D%5Cmathbf%7BE%7DI_j%20%5C%5C%0A&amp;=%20%5Csum_%7Bj=1%7D%5En%20P(h(x_j)%20=%20t)%20%5C%5C%0A&amp;=%20%5Csum_%7Bj=1%7D%5En%20%5Cfrac%7B1%7D%7Bm%7D%20%5C%5C%0A&amp;=%20%5Cfrac%7Bn%7D%7Bm%7D%0A%5Cend%7B%5Calign*%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%20n/m"> is frequently called the load factor. The load factor is constant if we assume that <img src="https://latex.codecogs.com/png.latex?c_1%20m%20%5Cleq%20n%20%5Cleq%20c_2%20n"> or equivalently <img src="https://latex.codecogs.com/png.latex?n%20=%20%5CTheta(n)">. This assumption can be kept satisfied by doubling the hash table size as needed.</p>
<p>Hence, our average case lookup time is <img src="https://latex.codecogs.com/png.latex?O(1+%5Calpha)%20=%20O(1+%5Cfrac%7Bn%7D%7Bm%7D)"></p>
</section>
<section id="open-addressing" class="level2">
<h2 class="anchored" data-anchor-id="open-addressing">Open addressing</h2>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/hash_map/index.html</guid>
  <pubDate>Thu, 25 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/hash_map/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Move semantics and perfect forwarding</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/move-semantics/index.html</link>
  <description><![CDATA[ 




<section id="value-categories" class="level1">
<h1>Value Categories</h1>
<p>C++ defines the following value categories:</p>
<ul>
<li><em>lvalues</em>: expressions for locations of long-living objects or functions. These objects have identity, persist in memory and are addressable.</li>
<li><em>prvalues</em>: expressions for short-living values for initializations. <em>prvalues</em> themselves do not exist somewhere in memory, they do not denote objects. They are unmaterialized entities meant for initialization.</li>
<li><em>xvalue</em>: A special location, representing a (long-living) object, whose resources/values are no longer needed and can be reused. The guts of this object can be stolen.</li>
</ul>
<p>The moment a <em>prvalue</em> (conceptual temporary) becomes an <em>xvalue</em>(temporary object), it is called <em>materialization</em>. The temporary materialization conversion is usually an implicit <em>prvalue-to-xvalue</em> conversion.</p>
<p>Anytime a <em>prvalue</em> is used where a <em>lvalue</em> or <em>xvalue</em> is expected, a temporary object is created and initialized with the <em>prvalue</em>.</p>
</section>
<section id="rules-for-binding-references" class="level1">
<h1>Rules for binding references</h1>
<p>Define:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb1-2">X v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> X c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;);</span></span>
<span id="cb1-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;);</span></span>
<span id="cb1-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;);</span></span>
<span id="cb1-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;);</span></span></code></pre></div>
<ul>
<li><p>A non-<code>const</code> <em>lvalue</em> reference <code>X&amp;</code> takes only non-<code>const</code> <em>lvalues</em>.</p></li>
<li><p>A <em>rvalue</em> reference <code>X&amp;&amp;</code> takes only non-<code>const</code> <em>rvalues</em>.</p></li>
<li><p>A <code>const</code> <em>lvalue</em> reference <code>const X&amp;</code> can take everything and serves as a fallback mechanism for move semantics.</p></li>
<li><p>A <code>const</code> <em>rvalue</em> reference takes both modifiable and <code>const</code> <em>rvalues</em> (e.g.&nbsp;<code>std::move(c)</code>).</p></li>
<li><p>A universal reference binds to all value categories and are usually used to forward arguments.</p></li>
</ul>
<section id="overload-resolution-priority" class="level3">
<h3 class="anchored" data-anchor-id="overload-resolution-priority">Overload resolution priority</h3>
<table class="table">
<colgroup>
<col style="width: 24%">
<col style="width: 11%">
<col style="width: 18%">
<col style="width: 12%">
<col style="width: 20%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Call</th>
<th><code>f(X&amp;)</code></th>
<th><code>f(const X&amp;)</code></th>
<th><code>f(X&amp;&amp;)</code></th>
<th><code>f(const X&amp;&amp;)</code></th>
<th><code>f(T&amp;&amp;)</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>f(v)</code></td>
<td>1</td>
<td>3</td>
<td>no</td>
<td>no</td>
<td>2</td>
</tr>
<tr class="even">
<td><code>f(c)</code></td>
<td>no</td>
<td>1</td>
<td>no</td>
<td>no</td>
<td>2</td>
</tr>
<tr class="odd">
<td><code>f(X{})</code></td>
<td>no</td>
<td>4</td>
<td>1</td>
<td>3</td>
<td>2</td>
</tr>
<tr class="even">
<td><code>f(std::move(v))</code></td>
<td>no</td>
<td>4</td>
<td>1</td>
<td>3</td>
<td>2</td>
</tr>
<tr class="odd">
<td><code>f(std::move(c))</code></td>
<td>no</td>
<td>3</td>
<td>no</td>
<td>1</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Note that, universal reference is always the second best option.</p>
</section>
<section id="universal-references-and-detail" class="level3">
<h3 class="anchored" data-anchor-id="universal-references-and-detail">Universal references and detail</h3>
<p>Note that, when we declare <code>arg</code> as <code>T&amp;&amp;</code> (pronounced <code>T</code>-ref-ref) where <code>T</code> is function template type parameter, this is a universal(forwarding reference). It does not follow the rules of <em>rvalue references</em>.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> arg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){}</span></span></code></pre></div>
<section id="reference-collapsing-rules" class="level4">
<h4 class="anchored" data-anchor-id="reference-collapsing-rules">Reference collapsing rules</h4>
<p>For a non-const object <code>v</code> and a const object <code>c</code> the type <code>T</code> and the type of <code>arg</code> is deduced as follows:</p>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 22%">
<col style="width: 22%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><code>T</code></th>
<th><code>T&amp;&amp;</code></th>
<th><code>arg</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>foo(v)</code></td>
<td><code>X&amp;</code></td>
<td><code>X&amp; &amp;&amp;</code></td>
<td><code>X&amp;</code></td>
</tr>
<tr class="even">
<td><code>foo(c)</code></td>
<td><code>const X&amp;</code></td>
<td><code>const X&amp; &amp;&amp;</code></td>
<td><code>const X&amp;</code></td>
</tr>
<tr class="odd">
<td><code>foo(X{})</code></td>
<td><code>X</code></td>
<td><code>X &amp;&amp;</code></td>
<td><code>X&amp;&amp;</code></td>
</tr>
<tr class="even">
<td><code>foo(std::move(v))</code></td>
<td><code>X&amp;&amp;</code></td>
<td><code>X&amp;&amp; &amp;&amp;</code></td>
<td><code>X&amp;&amp;</code></td>
</tr>
<tr class="odd">
<td><code>foo(std::move(c))</code></td>
<td><code>const X&amp;&amp;</code></td>
<td><code>const X&amp;&amp; &amp;&amp;</code></td>
<td><code>const X&amp;&amp;</code></td>
</tr>
</tbody>
</table>
<ul>
<li><code>X&amp; &amp;</code> becomes <code>X&amp;</code>.</li>
<li><code>X&amp; &amp;&amp;</code> becomes <code>X&amp;</code>.</li>
<li><code>X&amp;&amp; &amp;</code> becomes <code>X&amp;</code>.</li>
<li><code>X&amp;&amp; &amp;&amp;</code> becomes <code>X&amp;&amp;</code>.</li>
</ul>
</section>
</section>
<section id="copy-elison" class="level2">
<h2 class="anchored" data-anchor-id="copy-elison">Copy elison</h2>
<p>Copy elison omits copy and move constructors, resulting in zero-copy pass-by-value semantics.</p>
<section id="mechanics" class="level3">
<h3 class="anchored" data-anchor-id="mechanics">Mechanics</h3>
<p>The basic mechanics of <strong>Return Value Optimization</strong>(RVO) is as follows:</p>
<ul>
<li>The caller allocates space on the stack for the return value, passes the address to the callee.</li>
<li>The callee constructs the result directly in that space.</li>
</ul>
<p>In the below code snip,</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb3-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-5">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_val</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructed at "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-6">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X(const X&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-7">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X(X&amp;&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"destructed at "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_val</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X arg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb3-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;arg = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>arg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-15"></span>
<span id="cb3-16">X g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb3-17">    X obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy elison initializing obj</span></span>
<span id="cb3-18">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// from temporary</span></span>
<span id="cb3-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> obj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// NRVO</span></span>
<span id="cb3-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-21"></span>
<span id="cb3-22">X h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb3-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// URVO</span></span>
<span id="cb3-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-25"></span>
<span id="cb3-26"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb3-27">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb3-28">    X v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()};</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy elison initializing v1 from the result of g()</span></span>
<span id="cb3-29">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;v1 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-30">    X v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()};</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy elison initializing v2 from the result of h()</span></span>
<span id="cb3-31">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;v2 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/oMr16KTof">Compiler Explorer</a></p>
<p>It is important to note that:</p>
<ul>
<li>When a temporary(<em>prvalue</em>) is used to initialize an object, or function parameter, a copy is elided.</li>
<li>Inside a function, when a <em>prvalue</em> is returned by value, URVO(unnamed return value optimization) is performed.</li>
<li>Inside a function, when a <em>lvalue</em> is returned by value, NRVO(named return value optimization) is performed.</li>
</ul>
</section>
</section>
<section id="challenge-puzzle" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle">Challenge puzzle</h2>
<p>Observe the below code snip. What is the output printed?</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb4-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-3">    A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb4-4">    A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-5">    A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-12"></span>
<span id="cb4-13">A bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb4-14">    A a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-17"></span>
<span id="cb4-18">A foobar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb4-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-21"></span>
<span id="cb4-22">A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> arg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>arg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-25"></span>
<span id="cb4-26"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-27">    A a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-28">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-29">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb4-30">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-31">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> foobar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">().</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-32">    A result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-33">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-34"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://godbolt.org/z/zh91h7fr6">Compiler Explorer</a></p>
<p>For more such puzzles, visit <a href="https://getcracked.io/">getcracked.io</a></p>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/move-semantics/index.html</guid>
  <pubDate>Tue, 23 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/move-semantics/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Using std::variant</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/std_variant/index.html</link>
  <description><![CDATA[ 




<section id="using-stdvariant" class="level1">
<h1>Using <code>std::variant</code></h1>
<p>A <code>std::variant</code> is a closed-discriminated union. Variants simply have internal memory for maximum size of the underlying types plus a fixed overhead to manage which alternative is used. No heap memory is allocated. The resulting object has value semantics. Copying a variant is implemented as a deep-copy, it creates a new variant object with the current value of the alternative in its own memory.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb1-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb1-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// initialized with string alternative</span></span>
<span id="cb1-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>   </span>
<span id="cb1-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-9"></span>
<span id="cb1-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// now holds int alternative</span></span>
<span id="cb1-11">    var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// access by index</span></span>
<span id="cb1-16">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//access by type</span></span>
<span id="cb1-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//error</span></span>
<span id="cb1-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>bad_variant_access<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cerr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exception: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Ehqhq3T51">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">Program returned: 0</span>
<span id="cb2-2">Program stdout</span>
<span id="cb2-3"></span>
<span id="cb2-4">1</span>
<span id="cb2-5">0</span>
<span id="cb2-6"></span>
<span id="cb2-7">Program stderr</span>
<span id="cb2-8"></span>
<span id="cb2-9">Exception: std::get: wrong index for variant</span></code></pre></div>
<p>The default constructor for <code>std::variant</code> always initializes the first type with the default constructor. If there is no default constructor for the first type, calling the default constructor for the variant is a compile-time error.</p>
<p>If we still want to have a <code>std::variant</code>, we can use the helper type <code>std::monostate</code>. They serve as a first alternative type to make the variant type default constructible. Objects of type <code>std::monostate</code> only have <img src="https://latex.codecogs.com/png.latex?1"> state, so they always compare equal. To an extent, you can interprete this state as signalling emptiness.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Ref: C++17 - The complete guide</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Nikolai Josuttis</span></span>
<span id="cb3-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb3-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> NoDefConstr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-7">    NoDefConstr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb3-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// different ways to check for monostate</span></span>
<span id="cb3-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>monostate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> NoDefConstr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-13"></span>
<span id="cb3-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb3-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has monostate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb3-18">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has monostate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>holds_alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>monostate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)){</span></span>
<span id="cb3-21">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has monostate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// get_if accepts a pointer to a variant and returns</span></span>
<span id="cb3-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a `T*` if the alternative is T, else return</span></span>
<span id="cb3-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// nullptr</span></span>
<span id="cb3-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get_if<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(&amp;</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)){</span></span>
<span id="cb3-27">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has monostate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get_if<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>monostate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(&amp;</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)){</span></span>
<span id="cb3-30">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has monostate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/GbrEYWh7h">Compiler Explorer</a></p>
<p>You can assign any other alternative and even assign <code>std::monostate</code> to the variant again.</p>
<section id="stdvariant-types-and-operations" class="level2">
<h2 class="anchored" data-anchor-id="stdvariant-types-and-operations"><code>std::variant</code> types and operations</h2>
<section id="construction" class="level3">
<h3 class="anchored" data-anchor-id="construction">Construction</h3>
<p>There are several different ways to construct and initialize a <code>std::variant</code>.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb4-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb4-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;complex&gt;</span></span>
<span id="cb4-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;set&gt;</span></span>
<span id="cb4-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;initializer_list&gt;</span></span>
<span id="cb4-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> NoCopyConstr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-9">    NoCopyConstr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> NoCopyConstr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb4-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// construction</span></span>
<span id="cb4-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// sets first int to 0, index() == 0</span></span>
<span id="cb4-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb4-16"></span>
<span id="cb4-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if a value is passed for initialization,</span></span>
<span id="cb4-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the best matching type is used</span></span>
<span id="cb4-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v2.index() = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb4-21"></span>
<span id="cb4-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the call is ambiguous, if two types match equally well</span></span>
<span id="cb4-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::variant&lt;long, long&gt; v3{42};    // error</span></span>
<span id="cb4-24"></span>
<span id="cb4-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 42.3 is a double and requires narrowing conversion</span></span>
<span id="cb4-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// when assigned to int or float.</span></span>
<span id="cb4-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Neither is better.</span></span>
<span id="cb4-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::variant&lt;int, float&gt; v4{42.3};  // error</span></span>
<span id="cb4-29"></span>
<span id="cb4-30"></span>
<span id="cb4-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::variant&lt;std::string, std::string_view&gt; v5{"hello"};  //error</span></span>
<span id="cb4-32">    </span>
<span id="cb4-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// std::in_place_type or std::in_place_index</span></span>
<span id="cb4-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// is used to pass more than one value for initialization</span></span>
<span id="cb4-35">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>complex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> v6<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-36">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>in_place_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>complex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span></span>
<span id="cb4-37">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-38"></span>
<span id="cb4-39">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>complex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> v7<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-40">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>in_place_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb4-41">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-42"></span>
<span id="cb4-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// in_place_index tags can be used to resolve</span></span>
<span id="cb4-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ambiguities or overrule priorities during </span></span>
<span id="cb4-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// initialization</span></span>
<span id="cb4-46">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>in_place_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">77</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-47">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v8.index() = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v8<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb4-48">    </span>
<span id="cb4-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pass an initializer list followed by additional</span></span>
<span id="cb4-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// arguments</span></span>
<span id="cb4-51">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> sc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>abs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>abs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-53">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-54"></span>
<span id="cb4-55">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> </span>
<span id="cb4-56">                 <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>set<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;&gt;</span> v9<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-57">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>in_place_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> sc</span>
<span id="cb4-58">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-59"></span>
<span id="cb4-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// there is no make_variant convenience function</span></span>
<span id="cb4-61"></span>
<span id="cb4-62">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// you can copy variants provided all alternatives</span></span>
<span id="cb4-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// support copying.</span></span>
<span id="cb4-64">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v10<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-65">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v11<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>v10<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-66"></span>
<span id="cb4-67">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> NoCopyConstr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v12<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// std::variant&lt;int, NoCopyConstr&gt; v13{v12};</span></span>
<span id="cb4-69">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-70"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Kb4zGb5dx">Compiler Explorer</a></p>
</section>
<section id="accessing-the-stored-value" class="level3">
<h3 class="anchored" data-anchor-id="accessing-the-stored-value">Accessing the stored value</h3>
</section>
<section id="changing-the-value" class="level3">
<h3 class="anchored" data-anchor-id="changing-the-value">Changing the value</h3>
<p>There are <img src="https://latex.codecogs.com/png.latex?4"> ways to change the current value of the variant:</p>
<ul>
<li>the assignment operator</li>
<li><code>emplace</code></li>
<li><code>get</code> and then assign a new value for the currently active type.</li>
<li>a visitor.</li>
</ul>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb5-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb5-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb5-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// initialized with string alternative</span></span>
<span id="cb5-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>   </span>
<span id="cb5-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9"></span>
<span id="cb5-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// now holds int alternative</span></span>
<span id="cb5-11">    var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-13"></span>
<span id="cb5-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// access by index</span></span>
<span id="cb5-16">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//access by type</span></span>
<span id="cb5-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//error</span></span>
<span id="cb5-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>bad_variant_access<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cerr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exception: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> e<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-21"></span>
<span id="cb5-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Changing the value</span></span>
<span id="cb5-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// assignment and emplace() operations can be used to</span></span>
<span id="cb5-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// modify the value in the variant. </span></span>
<span id="cb5-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// operator=() directly assigns the new value, </span></span>
<span id="cb5-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if the variant currently holds the alternative.</span></span>
<span id="cb5-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// emplace() first destroys the old value and then assigns</span></span>
<span id="cb5-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the new value.</span></span>
<span id="cb5-29"></span>
<span id="cb5-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//sets first int to 0, index() == 0</span></span>
<span id="cb5-31">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> var2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-32">    var2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-33">    var2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>emplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-34"></span>
<span id="cb5-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// get&lt;&gt;() or get_if&lt;&gt;() can also be used to assign</span></span>
<span id="cb5-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a new value to the current alternative.</span></span>
<span id="cb5-37">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">77</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-38">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>var2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-40"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/6WP6bGzPj">Compiler Explorer</a></p>
</section>
<section id="comparisons" class="level3">
<h3 class="anchored" data-anchor-id="comparisons">Comparisons</h3>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb6-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb6-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb6-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// for 2 variants of the same type (i.e. having</span></span>
<span id="cb6-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the same alternatives), you can use the usual</span></span>
<span id="cb6-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// comparison operators. The following rules apply.</span></span>
<span id="cb6-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// - a variant with a value of an earlier alternative</span></span>
<span id="cb6-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// is less than a variant with value with a later alternative.</span></span>
<span id="cb6-11"></span>
<span id="cb6-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if two variants have the same alternative, the corresponding</span></span>
<span id="cb6-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// operators for the type of the alternatives is invoked.</span></span>
<span id="cb6-14"></span>
<span id="cb6-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>monostate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> v3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>monostate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::cout &lt;&lt; v1 == v4;    // compile-time error</span></span>
<span id="cb6-18">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// false</span></span>
<span id="cb6-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// true</span></span>
<span id="cb6-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// true</span></span>
<span id="cb6-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// false</span></span>
<span id="cb6-22"></span>
<span id="cb6-23">    v1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// false</span></span>
<span id="cb6-25">    v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">41</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-26">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-28"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/EsjonPejs">Compiler Explorer</a></p>
</section>
</section>
<section id="visitors" class="level2">
<h2 class="anchored" data-anchor-id="visitors">Visitors</h2>
<p>Visitors are simply objects that provide a function call operator <code>operator=()</code> for each possible type. When a visitor object visits a variant, they invoke the best matching function call operator for the actual value of the variant.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb7-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb7-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> MyVisitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-9"></span>
<span id="cb7-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-13"></span>
<span id="cb7-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"double: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-18"></span>
<span id="cb7-19"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb7-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>MyVisitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// calls operator() for int</span></span>
<span id="cb7-22">    var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>MyVisitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-24">    var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>MyVisitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-27"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/c5ejxco7n">Compiler Explorer</a></p>
<section id="using-generic-lambdas-as-visitors" class="level3">
<h3 class="anchored" data-anchor-id="using-generic-lambdas-as-visitors">Using generic lambdas as visitors</h3>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb8-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb8-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> printVisitor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb8-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb8-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>printVisitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// calls operator() for int</span></span>
<span id="cb8-12">    var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>printVisitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-14">    var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>printVisitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/EqsqbGj1j">Compiler Explorer</a></p>
</section>
<section id="the-cracked-mans-match" class="level3">
<h3 class="anchored" data-anchor-id="the-cracked-mans-match">The cracked-man’s match</h3>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb9-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb9-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb9-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> overload <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...{</span></span>
<span id="cb9-7">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()...;</span></span>
<span id="cb9-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// base types are deduced from the passed arguments</span></span>
<span id="cb9-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb9-12">overload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> overload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;;</span></span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb9-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-16"></span>
<span id="cb9-17">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>overload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// calls best matching lambda for current alternative</span></span>
<span id="cb9-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-20">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-22">    var<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/KWf7nxsYd">Compiler Explorer</a></p>
<p>You might wonder why we need to bring the function call operators of the closure types (<code>__my_lambda_with_int_param_struct</code> and <code>__my_lambda_with_string_param_struct</code>) in scope.</p>
<p>As per <a href="https://en.cppreference.com/w/cpp/language/overload_resolution.html">overload resolution rules</a>, when we have a <code>Derived</code> class as a subtype of two base classes <code>Base1</code> and <code>Base2</code>, and <code>Base1</code> implements <code>operator()(int)</code>, whilst <code>Base2</code> implements <code>operator()(std::string)</code>, both these method are inherited by <code>Derived</code>. Whilst both these candidates are a part of the overload set, overload resolution for overloaded operators differs from regular functions. In the case of overloaded operators, the argument list for the purpose of overloaded resolution has the implied object argument of type <em>cv</em> <code>Derived</code>. In which case, all base class methods will also be present, when the candidate set is trimmed to the viable set, and the result is ambiguous.</p>
</section>
</section>
<section id="polymorphism-and-inhomogenous-collections-with-stdvariant" class="level2">
<h2 class="anchored" data-anchor-id="polymorphism-and-inhomogenous-collections-with-stdvariant">Polymorphism and inhomogenous collections with <code>std::variant</code></h2>
<p><code>std::variant</code> enables a new form polymorphism and allows dealing with inhomogenous collections. It is a form of compile-time polymorphism with a closed set of data-types.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;variant&gt;</span></span>
<span id="cb10-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb10-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb10-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb10-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-11"></span>
<span id="cb10-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-13">    Point head<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-14">    Point tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> draw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rendering line"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-17"></span>
<span id="cb10-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Circle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-19">    Point center<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-20">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> radius<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> draw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rendering circle"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>    </span>
<span id="cb10-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-23"></span>
<span id="cb10-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Rectangle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-25">    Point origin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-26">    Point size_vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-27"></span>
<span id="cb10-28">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> draw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rendering rectangle"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-29"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-30"></span>
<span id="cb10-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// common type of all geometric objects</span></span>
<span id="cb10-32"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> GeoObj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>variant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Circle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Rectangle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;;</span></span>
<span id="cb10-33"></span>
<span id="cb10-34"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>GeoObj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> createFigure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb10-35">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>GeoObj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> fig<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb10-36">    fig<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Line<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-37">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> </span>
<span id="cb10-38">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-39">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb10-40"></span>
<span id="cb10-41">    fig<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Circle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-42">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>center <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb10-43">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span></span>
<span id="cb10-44">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb10-45"></span>
<span id="cb10-46">    fig<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Rectangle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-47">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>origin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb10-48">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb10-49">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb10-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> fig<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-51"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-52"></span>
<span id="cb10-53"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb10-54">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>GeoObj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> figure <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> createFigure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb10-55">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> GeoObj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> geoobj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> figure<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-56">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>visit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> obj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-57">            obj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>draw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb10-58">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> geoobj<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-59">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-60"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/G7cM7dqzd">Compiler Explorer</a></p>
<p>The three types <code>Line</code>, <code>Circle</code> and <code>Rectangle</code> don’t have any special relationship. In fact, they do not need to have a common base class, no virtual functions and their interfaces might even differ.</p>
<p>The code above would not be possible with runtime polymorphism, because then the types would need to have <code>GeoObj</code> as a common base class and we would need a vector of pointers of <code>GeoObj</code> elements. Moreover, runtime polymorphism is costly as memory needs to be dynamically allocated and there are two levels of indirection.</p>
<p>While compiling the <code>std::visit()</code> call, t the lambda gets instantiated into <img src="https://latex.codecogs.com/png.latex?3"> separate functions:</p>
</section>
<section id="the-pros-and-cons-of-stdvariant-polymorphism" class="level2">
<h2 class="anchored" data-anchor-id="the-pros-and-cons-of-stdvariant-polymorphism">The pros and cons of <code>std::variant</code> polymorphism</h2>
<p>Pros:</p>
<ul>
<li>You don’t need common base types.</li>
<li>You don’t have to use pointers for inhomogenous collections.</li>
<li>No need for <code>virtual</code> member functions.</li>
<li>Value semantics(no access of freed memory or memory leaks).</li>
<li>Elements in a vector are stored in contiguous memory locations. You don’t have to chase pointers in heap memory, resulting in fewer cache misses.</li>
</ul>
<p>Constraints and drawbacks:</p>
<ul>
<li>A closed set of types(you have to know all the alternatives at compile-time).</li>
<li>Elements of the vector all have the size of the biggest element type(an issue if the element sizes differ a lot).</li>
<li>Copying elements might be more expensive.</li>
</ul>
</section>
<section id="examples-of-using-stdvariant" class="level2">
<h2 class="anchored" data-anchor-id="examples-of-using-stdvariant">Examples of using <code>std::variant</code></h2>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/std_variant/index.html</guid>
  <pubDate>Tue, 23 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/std_variant/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Storage Duration and Linkage in C++</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/storage-duration/index.html</link>
  <description><![CDATA[ 




<section id="names-and-attributes" class="level1">
<h1>Names and Attributes</h1>
<p>In C++, a declared name can have associated attributes:</p>
<ul>
<li>Type</li>
<li>Scope</li>
<li>Storage duration</li>
<li>Linkage</li>
</ul>
</section>
<section id="source-files-and-header-files" class="level1">
<h1>Source files and header files</h1>
<p>Each C++ application or library consists of one or more source files. The C++ compiler translates <code>.cpp</code> source files to object files <code>*.o</code>, one source file at a time.</p>
<p><img src="http://quantdev.blog/posts/storage-duration/compilation_model.png" style="width:80.0%;height:80.0%"></p>
<p>The translation unit(TU) is the basic unit of compilation in C++. It is a single implementation file (<code>*.cpp</code>) together with the contents of all it’s header files.</p>
</section>
<section id="storage-duration" class="level1">
<h1>Storage Duration</h1>
<p>The storage duration of an object defines the lifetime of the storage containing the object.</p>
<p>In C++, the storage duration of the object can be:</p>
<ul>
<li>Static</li>
<li>Thread</li>
<li>Automatic</li>
<li>Dynamic</li>
</ul>
<p>For an object with <em>static</em> storage duration: - The storage is allocated at program startup. - The storage persists until the program is terminated.</p>
<p>For an object with <em>thread</em> storage duration: - The storage is allocated when the thread begins. - THe storage persists until the thread terminates.</p>
<p>For an object with automatic storage duration: - The storage is allocated when the enclosing block begins executing. This is usually upon entering the enclosing function. - The storage persists until the block terminates. This is usally upon function return.</p>
<p>For an object with dynamic storage duration: - The storage is allocated on the heap by a call to a memory allocation function e.g.&nbsp;<code>std::malloc</code>, <code>operator new</code> or the new expression. - The storage on the heap is deallocated by <code>std::free</code>, <code>operator delete</code> or the delete expression.</p>
</section>
<section id="linkage" class="level1">
<h1>Linkage</h1>
<p>The <em>linkage</em> of a name is the extent to which that name might refer to a name declared elsewhere. C++ provides for three categories of linkage:</p>
<ul>
<li>external linkage</li>
<li>internal linkage</li>
<li>no linkage</li>
</ul>
<section id="external-linkage" class="level2">
<h2 class="anchored" data-anchor-id="external-linkage">External linkage</h2>
<p>A given name declared with external linkage denotes the same entity across all translation units in a program.</p>
<p>In the below example, <code>total</code> in each translation unit has external linkage:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//file1.cpp</span></span>
<span id="cb1-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// definition</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//file2.cpp</span></span>
<span id="cb1-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// declaration for the same object</span></span></code></pre></div>
<p><code>total</code> is defined in <code>file1.cpp</code>. It has <code>extern</code> on it, which means external linkage. It is a definition, it does have an initial value <code>0</code>. In the second implementation file <code>file2.cpp</code>, it does not have an initializer, so its just a declaration. Those two things refer to the same variable. After separate compiling both <code>file1.cpp</code> and <code>file2.cpp</code> into <code>file1.o</code> and <code>file2.o</code> and linking them together, there’s going to be only one <code>total</code> in this executable.</p>
</section>
<section id="internal-linkage" class="level2">
<h2 class="anchored" data-anchor-id="internal-linkage">Internal linkage</h2>
<p>A given name declared with internal linkage denotes the same entity <strong><em>within a single translation unit</em></strong>.</p>
<p>A variable with internal linkage can be declared multiple times within a single translation unit and they all wind up referring to the same thing. But, nobody outside the translation unit can refer to those things with internal linkage.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// file1.cpp</span></span>
<span id="cb2-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// definition of total </span></span>
<span id="cb2-3">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with internal linkage</span></span>
<span id="cb2-4">    </span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// file2.cpp</span></span>
<span id="cb2-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// declaration for </span></span>
<span id="cb2-7">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a different object</span></span></code></pre></div>
<p>In <code>file2.cpp</code> you have a declaration of <code>total</code> with external linkage and that says, *“Hey, I don’t have any storage, I need it from somewhere else!”. But, it can’t get it from <code>file1.cpp</code>. <code>file1.cpp</code> does not have external linkage. If you try to build this program, because that’s an unsatisfied reference <code>file2.cpp</code>, you’d probably get a link error. At link time, it would say, I don’t see a definition for <code>total</code> to satisfy.</p>
<p>So, what we need is a third one - <code>file3.cpp</code>. The previous example needs the <code>total</code> in <code>file3.cpp</code> to link:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// file1.cpp</span></span>
<span id="cb3-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a definition for total</span></span>
<span id="cb3-3">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with internal linkage</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// file2.cpp</span></span>
<span id="cb3-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a declaration that refers to </span></span>
<span id="cb3-7">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the total in file3.cpp</span></span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// file3.cpp</span></span>
<span id="cb3-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a definition for the object</span></span>
<span id="cb3-11">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// referenced in file2.cpp</span></span></code></pre></div>
<p>The <code>total</code> in <code>file2.cpp</code> refers to the object in <code>file3.cpp</code>. To summarize, there are two <code>total</code> objects in all - one internal to <code>file1.cpp</code> and one that’s shared by <code>file2</code> and <code>file3</code> via external linkage.</p>
</section>
<section id="no-linkage" class="level2">
<h2 class="anchored" data-anchor-id="no-linkage">No linkage</h2>
<p>Local variables have no linkage. Suppose you have two functions <code>f()</code> and <code>g()</code>. Each have a local variable named <code>total</code>. Think about it. Is there any way, you can write a declaration for <code>total</code> anywhere else in the program that will at link time become a reference to one of those <code>total</code>s?</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a definition</span></span>
<span id="cb4-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a definition for a different object</span></span>
<span id="cb4-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>No, you can’t do that. Those <code>total</code>s have automatic storage. They are not statically allocated. Because they don’t have a fixed location, there’s no way the linker can can link them. The only things that can have linkage, are things that have a fixed location - functions and objects with static storage.</p>
</section>
</section>
<section id="a-conceptual-model" class="level1">
<h1>A conceptual model</h1>
<p>In a release build, the <strong><em>linker sees names only if they have external linkage.</em></strong> Names that have internal linkage or no linkage are useful for symbolic debugging, but the linker does not use them when it is combining <code>*.o</code> object files together to produce an executable.</p>
<ul>
<li><p>Names <strong><em>defined</em></strong> with external linkage in a translation unit become definitions in the compiled object module.</p></li>
<li><p>Names <strong><em>declared</em></strong> with external linkage but not defined in a translation unit become <strong><em>refs</em></strong> in the compiled object module. But, only if they are used in that translation unit.</p></li>
</ul>
<p>In a release build, the <strong><em>compiler discards names declared with internal or no linkage</em></strong> at the end of compilation.</p>
</section>
<section id="storage-class-specifiers-and-functions" class="level1">
<h1>Storage class specifiers and functions</h1>
<p>By default functions at namespace scope have external linkage.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>Adding the keyword <code>extern</code> to a function declaration at file or namespace(global) scope has no effect:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> demo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Class members in C++ have external linkage by default.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Widget<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// f has external linkage</span></span>
<span id="cb7-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>You commonly place class definitions in header files. And you include those all over the place and create objects that type and call member functions on them and at nowhere did you say that these things were extern. You just implicitly treat them as if they are. They have <code>extern</code> linkage by default.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Widget<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// f has external linkage</span></span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// extern int g(int);   // error: can't use extern here</span></span>
<span id="cb8-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Adding an <code>extern</code> to a declaration at class scope is an error. Class member functions can never have anything but external linkage by default.</p>
<p>Declaring a free-standing function <strong><em><code>static</code> at file or namespace scope affects its linkage.</em></strong></p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// f has internal linkage</span></span></code></pre></div>
<p>This is not so for C++ class member functions.</p>
<p>Declaring a C++ class member function <code>static</code> <strong><em>does not</em></strong> affect its linkage.</p>
<p>It eliminates the function’s implicitly declared <strong><em><code>this</code> parameter.</em></strong></p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Widget<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb10-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// f has external linkage</span></span>
<span id="cb10-4">                            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// but has no `this`</span></span>
<span id="cb10-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
</section>
<section id="storage-class-specifiers-and-objects" class="level1">
<h1>Storage class specifiers and objects</h1>
<p>Objects at file or namespace scope always have static storage:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// linkage=     storage=</span></span>
<span id="cb11-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// internal     static</span></span>
<span id="cb11-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// external     static</span></span>
<span id="cb11-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// external     static</span></span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> demo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// internal     static</span></span>
<span id="cb11-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// external     static</span></span>
<span id="cb11-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// external     static</span></span>
<span id="cb11-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>In this case, the storage-class specifier only affects the linkage.</p>
<p>Objects at local scope can have almost any storage duration or linkage:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb12-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-3">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// linkage=     storage=</span></span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ?            static</span></span>
<span id="cb12-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// No           static</span></span>
<span id="cb12-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// No           automatic</span></span>
<span id="cb12-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>For a name declared as <code>extern</code> at the file, namespace or local scope:</p>
<ul>
<li>The name has <strong><em>internal linkage if previously declared with internal linkage in a visible declaration</em></strong>.</li>
<li>Otherwise, it has external linkage.</li>
</ul>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// internal linkage</span></span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb13-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// internal linkage</span></span>
<span id="cb13-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extern</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// external linkage</span></span>
<span id="cb13-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><em><a href="https://www.youtube.com/watch?v=cpkDQaYttR4">Back to Basics: Compiling and Linking</a> by Ben Saks, CppCon 2021</em></li>
</ul>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/storage-duration/index.html</guid>
  <pubDate>Mon, 22 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/storage-duration/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>auto type deduction rules</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/auto_type_deduction_rules/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This weekend, I tried to solve a fun puzzle - <a href="https://www.volatileint.dev/posts/auto-type-deduction-gauntlet/">the C++ <code>auto</code> type deduction gauntlet</a> and thought of creating a quick cheatsheet on <code>auto</code> type deduction rules. I encourage you to give it a shot.</p>
<p><code>auto</code> is a placeholder type that gets replaced typically by deduction from an initializer.</p>
<p>Whenever you have:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>some_modifiers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> expression<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>you have three general cases:</p>
<ul>
<li><code>auto x</code> : The object being assigned is allowed to decay. We strip the RHS <code>expression</code> of all CV-qualifiers such as <code>const</code> and reference modifiers <code>&amp;</code> to deduce the <em>by-value</em> type of <code>x</code>.</li>
<li><code>auto&amp; x</code> or <code>auto&amp;&amp; x</code> : It preserves references and CV-qualifiers.</li>
<li><code>const auto&amp; x</code> : We specify the qualifiers, <code>auto</code> simply deduces the base type.</li>
</ul>
<p>There is special treatment for expressions that are functions or arrays:</p>
<ul>
<li>When initializing a reference(<code>auto&amp;</code>), array/function types are preserved.</li>
<li>Otherwise, it <em>decays</em> to a pointer before type deduction.</li>
</ul>
</section>
<section id="exercises-to-flex-your-understanding-of-auto-deduction-rules" class="level1">
<h1>Exercises to flex your understanding of <code>auto</code> deduction rules</h1>
<p>Let’s determine for each of the problems:</p>
<ul>
<li>The deduced type</li>
<li>The value category</li>
<li>What CV qualifiers are applicable</li>
</ul>
<p>As the author of the puzzles states, let’s note that these are meant to test your understanding and some examples won’t compile.</p>
<section id="basics" class="level2">
<h2 class="anchored" data-anchor-id="basics">Basics</h2>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>This is fairly straight-forward. The deduced type is <code>int</code>. The value category of <code>v</code> is <em>lvalue</em>.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>Floating-point values default to the larger <code>double</code>, rather than <code>float</code>. The value category of <code>v</code> is <em>lvalue</em>.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>The deduced type is <code>int</code> and the value category of <code>v</code> is <em>lvalue</em>.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The <code>u</code> suffix is used for unsigned integer literals and the <code>z</code> suffix is used for the signed version of <code>std::size_t</code>. The suffix <code>uz</code> deduces to <code>std::size_t</code>.</p>
<p>The type <code>size_t</code> is an implementation-defined unsigned integer type that is large enough to contain the size in bytes of any object.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span></code></pre></div>
<p>I didn’t get this puzzle. But, this will fail to compile. All types in an expression defined with <code>auto</code> have be the same.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>&amp;</code> is the address-of operator. So, the type of <code>v</code> is deduced as pointer-to-int <code>int*</code>. The value category of <code>v</code> is <em>lvalue</em>.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>x</code> is an array of <img src="https://latex.codecogs.com/png.latex?5"> <code>int</code>s, its type is <code>int [5]</code>. C-style arrays decay to a pointer. So, the type of <code>v</code> is <code>int*</code>. <code>v</code> is an <em>lvalue</em>.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>nullptr</code> is a value of type <code>std::nullptr_t</code>.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p><img src="https://latex.codecogs.com/png.latex?1">, <img src="https://latex.codecogs.com/png.latex?2"> and <img src="https://latex.codecogs.com/png.latex?3"> are <code>int</code>s. So, the type of <code>v</code> is deduced as <code>std::initializer_list&lt;int&gt;</code>. If the curly-braced initializer list were <code>{1, 2.5, 4}</code>, type deduction would fail, because we require all types in an initializer list to be the same.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Curly braced direct initialization only works with a single scalar value e.g.&nbsp;<code>auto v{1}</code>.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The type of <code>x</code> is deduced as <code>std::initializer_list&lt;int&gt;</code>.</p>
<p>To summarize:</p>
<ul>
<li><code>auto</code> + copy list initialization : If all elements are of type <code>T</code>, <code>auto</code> is deduced as <code>std::initializer_list&lt;T&gt;</code>.</li>
<li><code>auto</code> + direct list initialization :
<ul>
<li><img src="https://latex.codecogs.com/png.latex?1"> element in braces <img src="https://latex.codecogs.com/png.latex?%5Cimplies"> <code>auto</code> deduces the type of element by-value.</li>
<li><img src="https://latex.codecogs.com/png.latex?%3E1"> element <img src="https://latex.codecogs.com/png.latex?%5Cimplies"> error(ill-formed).</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb13-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>v</code> is deduced as a function pointer, <code>int (*) int</code>. According to the C++ standard, a function is an object that occupies memory storage and has a lifetime. Hence, <code>foo</code> is an <em>lvalue</em> expression.</p>
</section>
<section id="intermediate" class="level2">
<h2 class="anchored" data-anchor-id="intermediate">Intermediate</h2>
<p>We now explore how references and CV-qualifiers are handled.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">volatile</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>We strip all modifiers off <code>x</code>, so that results in an <code>int</code>. Thus, <code>auto</code> is deduced as <code>int</code>. <code>auto</code> always drops top-level CV qualifiers.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">volatile</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>I didn’t quite get this one. It turns out that CV qualifiers applied to pointed-to. So, type of <code>x</code> is deduced as <code>volatile const int*</code>. The next code snip also shows the same:</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cassert&gt;</span></span>
<span id="cb16-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;type_traits&gt;</span></span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb16-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_same_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&gt;);</span></span>
<span id="cb16-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/hb39vqYeE">Compiler Explorer</a></p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>y</code> is an <em>lvalue reference</em> to <code>x</code>. The type of <code>y</code> decays to <code>int</code>.</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>The type of <code>v</code> is deduced as <code>int&amp;</code>. <code>v</code> is an <em>lvalue reference</em>.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb19-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>auto</code> is deduced as <code>int [5]</code>. The type of <code>v</code> is a reference to an array of <img src="https://latex.codecogs.com/png.latex?5"> <code>int</code>s.</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>Functions are <em>lvalues</em> and the function name is a pointer to function object in memory. CV-qualifiers on parameters are thrown away during function resolution. Hence, <code>auto</code> is deduced as <code>int (*)(int)</code>.</p>
</section>
<section id="advanced" class="level2">
<h2 class="anchored" data-anchor-id="advanced">Advanced</h2>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>auto&amp;&amp; v</code> is a forwarding reference. <code>x</code> is an <em>lvalue</em> and <em>lvalues</em> bind to <em>lvalue</em> references. Here, we get an <em>lvalue reference</em>.</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb22-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb22-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span></code></pre></div>
<p>The return value of the function call is a <em>prvalue</em>. It will bind to an <em>rvalue reference</em>. So, the type of <code>v</code> is deduced as <code>int&amp;&amp;</code>.</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb23-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb23-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span></code></pre></div>
<p>The result of the function call <code>y()</code> is an <em>lvalue</em>, so the type of <code>v</code> is deduced to be <code>int&amp;</code>.</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb24-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span></code></pre></div>
<p>The call to the constructor <code>Foo{}</code> creates a temporary <code>Foo</code> instance - a <em>prvalue</em>. Hence, the type of <code>v</code> is deduced as <code>Foo&amp;&amp;</code>.</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-2"></span>
<span id="cb25-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> cx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> rx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-6"></span>
<span id="cb25-7">f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [1]</span></span>
<span id="cb25-8">f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [2]</span></span>
<span id="cb25-9">f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>rx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [3]</span></span></code></pre></div>
<p><code>auto&amp;</code> preserves references and CV-qualifiers. In the function call <code>f(x)</code>, the type of param is deduced as <code>int&amp;</code>. In the function call <code>f(cx)</code>, the type of param is deduced as <code>const int&amp;</code>. In the function call <code>f(rx)</code>, the type of param is deduced as <code>const int&amp;</code>.</p>
<p>Solving these <code>auto</code> type deduction puzzles prompted me to go watch <a href="https://www.youtube.com/watch?v=wQxj20X-tIU&amp;t=1769s">Scott Meyer’s talk on type deduction from CppCon 2014</a>. At 25:10, he says:</p>
<blockquote class="blockquote">
<h5 id="it-is-important-to-distinguish-between-an-expression-that-is-const-and-an-expression-that-contains-const." class="anchored"><em>It is important to distinguish between an expression that is <code>const</code>, and an expression that contains <code>const</code>.</em></h5>
</blockquote>
<p>The most common place this issue occurs, is when we are dealing with pointers. Observe the following code snip:</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb26-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> cpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb26-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb26-3"></span>
<span id="cb26-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pci<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb26-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pci<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb26-6"></span>
<span id="cb26-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> cpci<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb26-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> p3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cpci<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>You can have a constant pointer-to-<code>int</code>, in which case the expression is a constant. Or you can have a pointer-to-<code>const</code>, in which case you have a expression containing <code>const</code>. And you can have a constant pointer to <code>const</code>, which is a constant expression that contains a <code>const</code>.</p>
<p>When deducing <code>auto</code>, we are deducing <em>by-value</em>. The top-level <code>const/volatile</code> is dropped. Applying this rule, we have the following:</p>
<ul>
<li>The type of <code>p1</code> is deduced as <code>int*</code>.</li>
<li>The type of <code>p2</code> is deduced as <code>const int*</code>.</li>
<li>The type of <code>p3</code> is deduced as <code>const int*</code>.</li>
</ul>
<p>THe fact that <code>p3</code> is <code>const</code> is ignored. The fact that <code>p3</code> contains <code>const</code> is not ignored.</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb27-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pcx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ppcx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>pcx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>The expression <code>&amp;pcx</code> contains <code>const</code>. So, the type of <code>ppcx</code> is deduced as <code>const int**</code>.</p>
</section>
<section id="lambda-capture-type-deduction" class="level2">
<h2 class="anchored" data-anchor-id="lambda-capture-type-deduction">Lambda capture type deduction</h2>
<p>The captures of a <a href="https://quantdev.blog/posts/lambda_functions/">lambda expression</a> defines the outside variables that are accessible from within the lambda function body. There are three kinds of lambda capture:</p>
<ul>
<li><em>By reference</em>: Uses type deduction rules for reference parameters.</li>
<li><em>Init capture</em>: Uses <code>auto</code> type deduction rules.</li>
<li><em>By value</em>: CV qualifiers are retained.</li>
</ul>
<p>Recall that, C++14 allows <a href="https://quantdev.blog/posts/lambda_functions/#captures-with-an-initialiser">init-captures</a>. You can create new data members in the closure type on the fly. Then, we can access those variables inside the lambda.</p>
<p>The key takeaway is that the simple <em>by-value</em> capture <img src="https://latex.codecogs.com/png.latex?%5Cneq"> by-value init capture. Observe the following code snip:</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb28-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb28-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](){};</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// by-value capture</span></span>
<span id="cb28-4">                            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The type of `cx` is `const int`</span></span>
<span id="cb28-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb28-6"></span>
<span id="cb28-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb28-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb28-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](){};</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// init-capture</span></span>
<span id="cb28-10">                                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The type of `cx` is `int`</span></span>
<span id="cb28-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>This is an interesting wrinkle that exists for <em>by-value</em> lambda captures.</p>
<p>Observe the following code snip:</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb29-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span> cx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// error</span></span>
<span id="cb29-4">    func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb29-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In this lambda expression, <code>cx</code> is captured by value. The type <code>cx</code> is deduced as <code>int</code>. Recall, that the function call operator is <code>const</code>. You can’t modify a non-<code>const</code> member variable inside a <code>const</code> member function. So, this would be a compile error.</p>
<p>If you declare your lambda as <code>mutable</code>, it means that the function call operator is not <code>const</code>. Observe the next code snip. If we have a local variable which is <code>const</code> and we capture it by value, then it will be copied into the class as a <code>const</code>.</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb30-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb30-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb30-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> cx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// still error</span></span>
<span id="cb30-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>My next example, is a real mind-bender borrowed from slide 31 of Scott Meyer’s talk. Observe the code snip below. What is the deduced type of <code>param</code>?</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb31-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb31-3"></span>
<span id="cb31-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Widget<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb31-5"></span>
<span id="cb31-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Widget<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> createVec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb31-7"></span>
<span id="cb31-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> vw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> createVec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb31-9"></span>
<span id="cb31-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>vw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb31-11">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>vw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb31-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>First, the function <code>createVec()</code> returns a <code>vector&lt;Widget&gt;</code> by value. <code>auto</code> deduction rules apply. So, the type of <code>vw</code> is deduced as <code>const std::vector&lt;Widget&gt;</code>. So, all elements of the vector are considered immutable and are of type <code>const Widget</code>. If the vector is not empty, <code>f</code> receives the address of the element of the vector. This is a pointer-to-<code>const</code> <code>Widget</code>, it contains <code>const</code>. Thus, the base type <code>T</code> is deduced as <code>Widget* const</code>. <code>param</code> is a <code>const</code> reference to <code>T</code>, so the type of <code>param</code> is deduced as <code>const Widget* const &amp;</code>.</p>
</section>
<section id="decltype-type-deduction" class="level2">
<h2 class="anchored" data-anchor-id="decltype-type-deduction"><code>decltype</code> type deduction</h2>
<ul>
<li>If you apply <code>decltype</code> to a (unparenthesized) name, it will give you the declared type of that name. It’s not the same as <code>auto</code>, because in <code>auto</code> deduction, top-level CV-qualifiers are dropped.</li>
<li>If the argument is any other expression of type <code>T</code>:
<ul>
<li>If the value category of the expression is <em>xvalue</em>, then <code>decltype</code> yields <code>T&amp;&amp;</code>.</li>
<li>If the value category of the expression is a <em>prvalue</em>, then <code>decltype</code> yield <code>T</code>.</li>
<li>If the value category of the expression is a <em>lvalue</em>, then <code>decltype</code> yields <code>T&amp;</code>.</li>
</ul></li>
</ul>
<p><code>decltype</code> merely inspects the type of the expression statically at compile-time. It does <strong>not</strong> evaluate the expression. Let’s try and solve a few more puzzles.</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb32-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb32-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>The expression <code>(x)</code> is an <em>lvalue</em>, so <code>decltype(auto)</code> deduces to an lvalue reference of type <code>int&amp;</code>.</p>
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb33-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb33-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span></code></pre></div>
<p>The expression <code>Foo{}</code> is a <em>prvalue</em>. For any prvalue expression <code>e</code>, <code>decltype(e)</code> evaluates to the type of <code>e</code>.</p>
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb34-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb34-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>The expression <code>std::move(x)</code> is an <em>xvalue</em>. The type of <code>v</code> is deduced as <code>int&amp;&amp;</code>.</p>
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb35-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb35-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb35-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb35-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>foo</code> is an <em>lvalue</em> of type <code>int (*) (int)</code>. So, the type of <code>v</code> is deduced as <code>int (*)(int)</code>.</p>
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb36-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb36-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb36-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p><code>(foo)</code> is an <em>lvalue</em> expression of type <code>int (*) (int)</code>. So, the type of <code>v</code> is deduced to be <code>int (*) (int) &amp;</code>.</p>
<div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb37-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb37-3">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb37-4">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb37-5">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb37-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb37-7"></span>
<span id="cb37-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Derived <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> Base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb37-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb37-10"></span>
<span id="cb37-11">Derived d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb37-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span></code></pre></div>
<p><code>Derived</code> inherits <code>foo()</code> from <code>Base</code>, so you can access <code>Base::foo()</code> using a <code>Derived</code> object. Further, <code>this</code> in <code>Base::foo()</code> returns a <code>Base*</code>, so the type of <code>v</code> is deduced as <code>Base*</code>.</p>
</section>
<section id="challenge-puzzle" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle">Challenge Puzzle</h2>
<p>Observe the code snippet below. What gets printed?</p>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Headers</span></span>
<span id="cb38-2"></span>
<span id="cb38-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb38-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb38-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-7"></span>
<span id="cb38-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>For more such puzzles, visit <a href="https://getcracked.io">getcracked.io</a>.</p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><em><a href="https://www.youtube.com/watch?v=wQxj20X-tIU&amp;t=1769s">Type deduction and why you care</a> by Scott Meyers</em>.</li>
<li><em><a href="https://www.youtube.com/watch?v=E5L66fkNlpE"><code>decltype(auto)</code>: An overview of How, Why and Where</a> by Jason Turner</em>.</li>
</ul>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/auto_type_deduction_rules/index.html</guid>
  <pubDate>Sun, 21 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/auto_type_deduction_rules/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>C++ Type erasure</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/type-erasure/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Once you instantiate a <code>std::function</code> object, how is it, that <em>you are able to stick objects of different actual types e.g.&nbsp;an anonymous lambda, a free-standing function or a function-pointer (with only a common function signature)</em> to it? This is achieved through <strong>type erasure</strong>.</p>
<p>Type erasure is a programming technique by which the explicit type information is removed from the program. It is a type of <em>abstraction</em> that ensures that the program does not explicitly depend on some of the data-types. You might wonder, how is it, that a program is written in a strongly typed language but does not use the actual types?</p>
</section>
<section id="how-does-type-erasure-look-like" class="level1">
<h1>How does type erasure look like?</h1>
<p>The ultimate type-erased object in C++ is <code>std::function</code>. Another one is <code>std::any</code>. Consider the following code snip:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;functional&gt;</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> print_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> display_lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> PrintFunctor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb1-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;</span> f_print_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> print_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;</span> f_display_lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> display_lambda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;</span> f_print_functor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PrintFunctor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb1-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/1Tz7dWqM7">Compiler Explorer</a></p>
<p>The free-standing function <code>print_num</code>, the lambda function <code>diplay_lambda</code> and the functor <code>PrintFunctor</code> are objects with different types. So, the type of object being assigned to the <code>std::function</code> changed, but on the left hand side we have the same type. <code>std::function&lt;void(int)&gt;</code> can store any of these callable objects. Somehow, we can stick all these different types into it.</p>
<p>If you look at it from the design point of view, what it does is, it abstracts away all the behavior of the type you erase, except the set of behaviors you consider relevant. It’s a very flexible abstraction. In my case, I say, what’s relevant is, I can invoke this type with a <code>int</code> and I get back a <code>void</code>.</p>
</section>
<section id="type-erasure---the-basic-mechanics" class="level1">
<h1>Type erasure - the basic mechanics</h1>
<section id="step-1---how-to-write-a-container-that-holds-unrelated-types" class="level2">
<h2 class="anchored" data-anchor-id="step-1---how-to-write-a-container-that-holds-unrelated-types">Step 1 - How to write a container that holds unrelated types?</h2>
<p>On cppreference.com, <code>std::function</code> is defined as follows:</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)&gt;;</span></span></code></pre></div>
<p><em>The class template <code>std::function</code> is a general-purpose polymorphic function wrapper.</em></p>
</div>
</div>
</div>
<p><code>std::function</code> has to be polymorphic, meaning it has to be able to hold completely unrelated types. They don’t have to be bound by an inheritance-hierarchy or any other sort of thing.</p>
<p>Our end-goal looks something like this:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> MagicFunctionContainer</span>
<span id="cb3-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb3-3"></span>
<span id="cb3-4">MagicFunctionContainer f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> print_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-5">MagicFunctionContainer f2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">({},</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-6">MagicFunctionContainer f3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PrintFunctor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span></code></pre></div>
<p>We should be able to assign different objects of types like a free-standing function, a lambda expression or a functor to this <code>MagicFunctionContainer</code>.</p>
<p>Let’s start with designing a container, which is constructible from completely unrelated types:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> MagicFunctionContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-3">    MagicFunctionContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span> </span>
<span id="cb4-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb4-6"></span>
<span id="cb4-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb4-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-10"></span>
<span id="cb4-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb4-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//void(*)(int) m_func;   // we need to think</span></span>
<span id="cb4-13">                             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of m_func's type</span></span>
<span id="cb4-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>We see that, there’s this container called <code>MagicFunctionContainer</code>. The most important thing to note is that, its constructor is now a templated constructor, so you can pass any type into the <code>MaginFunctionContainer</code> constructor, and it simply forwards the object <code>func</code> into <code>m_func</code>. We need to think, what the type of <code>m_func</code> is. We see that this function container also implements a function call operator <code>operator()</code>, which accepts an integer and returns type <code>void</code>. So, when this function container object is invoked with an integer <code>i</code>, it simply calls <code>m_func(i)</code> under the hood.</p>
<p>As long as we have defined the type of <code>m_func</code>, and its the correct type, this code satisfies our requirements. We now have a container, that can be constructed from completely unrelated types. How do we store these unrelated types? How do we now define what the type of <code>m_func</code> should be? The answer to this puzzle is step-2 of our design.</p>
</section>
<section id="step-2---can-m_func-be-a-polymorphic-pointer-to-a-place-on-the-heap-that-will-hold-these-unrelated-types" class="level2">
<h2 class="anchored" data-anchor-id="step-2---can-m_func-be-a-polymorphic-pointer-to-a-place-on-the-heap-that-will-hold-these-unrelated-types">Step 2 - Can <code>m_func</code> be a polymorphic pointer to a place on the heap that will hold these unrelated types?</h2>
<p>The classic type erasure pattern can be realized by first coding up a <em>type-agnostic interface</em> (a <code>Concept</code> class). Then we use an <code>Impl</code> class that wraps up the concrete type &amp; provides the <em>type-dependent implementation</em>. Finally, we use dynamic polymorphism via virtual functions, but the caller only sees the interface.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Type erasure 101</span></span>
<span id="cb5-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb5-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Concept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-7">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-8">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> Concept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){}</span></span>
<span id="cb5-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-10"></span>
<span id="cb5-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb5-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Impl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-13"></span>
<span id="cb5-14">        Impl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> </span>
<span id="cb5-15">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_callable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb5-17"></span>
<span id="cb5-18">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-19">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_callable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-20">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-21">        </span>
<span id="cb5-22">        Callable <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_callable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-23">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Each time I get any new type <code>Callable</code>, I am creating an implementation <code>Impl&lt;Callable&gt;</code>, and passing that object into this new type.</p>
<p>Any type <code>Callable</code> that implements <code>operator()(int)</code> can be stored in <code>Impl&lt;Callable&gt;</code>. And <code>Impl&lt;Callable&gt;</code> inherits from <code>Concept</code>.</p>
<p>Now, what we’ve achieved so far is, that any <code>Impl&lt;Callable&gt;</code> object, as long as <code>Callable</code> implements the function call operator <code>operator()</code>, accepts an <code>int</code>, returns <code>void</code> can be assigned to a pointer to <code>Concept</code>, <code>Concept*</code>. Remember, all types <code>Impl&lt;Callable_1&gt;</code>, <code>Impl&lt;Callable_2&gt;</code>, …, <code>Impl&lt;Callable_n&gt;</code> inherit from <code>Concept</code>.</p>
<p>We can now finish the revisit the definition of <code>MagicFunctionContainer</code>.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> MagicFunctionContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb6-3">    MagicFunctionContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> Impl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span> </span>
<span id="cb6-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb6-6"></span>
<span id="cb6-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb6-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-9">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>bad_function_call<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb6-10"></span>
<span id="cb6-11">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-13"></span>
<span id="cb6-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb6-15">    Concept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>   </span>
<span id="cb6-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>In the <code>MagicFunctionContainer</code>, I have still got the templated constructor. I have still got the function call operator. But, now I have type for <code>m_func</code>. <code>m_func</code> is a pointer to <code>Concept</code>. In the templated constructor, now what I’m doing is, each time I get any type <code>Func</code>, I am passing that object into this new type <code>Impl&lt;Func&gt;</code>. So, essentially a <code>Concept*</code> pointer is always pointing to an <code>Impl&lt;Func&gt;</code>.</p>
<p>As a result what happens is, although the <code>MagicFunctionContainer</code> is not templated itself, its constructor is templated and it’s <code>m_func</code> member variable is able to store different unrelated types.</p>
</section>
<section id="polishing-our-design-for-stdfunction-like-container" class="level2">
<h2 class="anchored" data-anchor-id="polishing-our-design-for-stdfunction-like-container">Polishing our design for <code>std::function</code> like container</h2>
<p>We can add some template magic and use concepts to constrain our template type parameter <code>Func</code>.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb7-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;functional&gt;</span></span>
<span id="cb7-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb7-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;concepts&gt;</span></span>
<span id="cb7-5"></span>
<span id="cb7-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Concept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-9">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> R <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-10">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Concept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){}</span></span>
<span id="cb7-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-12"></span>
<span id="cb7-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Impl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Concept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;{</span></span>
<span id="cb7-15">        Impl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Func func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb7-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb7-18"></span>
<span id="cb7-19">        R <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">override</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-20">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb7-21">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-22"></span>
<span id="cb7-23">        Func <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-25"></span>
<span id="cb7-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-28">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-29">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-30">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">requires</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>invocable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;</span></span>
<span id="cb7-31">        function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Func func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> </span>
<span id="cb7-32">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Impl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;&gt;(</span>func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span></span>
<span id="cb7-33">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb7-34"></span>
<span id="cb7-35">        R <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb7-36">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb7-37">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-38"></span>
<span id="cb7-39">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-40">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unique_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Concept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>R<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_func</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-41">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-42"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-43"></span>
<span id="cb7-44"></span>
<span id="cb7-45"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> print_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb7-46">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-47"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-48"></span>
<span id="cb7-49"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> display_lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb7-50">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-51"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-52"></span>
<span id="cb7-53"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> PrintFunctor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-54">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb7-55">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-56">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-57"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-58"></span>
<span id="cb7-59"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb7-60"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-61">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> f_print_num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> print_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-62">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> f_display_lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> display_lambda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-63">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> f_print_functor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PrintFunctor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb7-64"></span>
<span id="cb7-65">    f_print_num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-66">    f_display_lambda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-67">    f_print_functor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb7-68">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-69"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/e8rKhPzYK">Compiler Explorer</a></p>
</section>
</section>
<section id="type-safety-in-type-erasure" class="level1">
<h1>Type safety in type erasure</h1>
<p>The type erased container should have the ability to hold unrelated types. In addition to this, there is one other requirement. <em>The type erased container should retain the type information of the assigned object</em>.</p>
<p>Consider the following example:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-2">    Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Constructed Foo()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-3">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Destructed ~Foo()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb8-5"></span>
<span id="cb8-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> foo_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb8-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> foo_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>I have a type agnostic <code>foo_ptr</code> and I am assigning it an object of type <code>Foo</code>. When a <code>Foo</code> object is constructed, it prints the text <code>Constructed Foo()</code> to the console, when it is destructed, it prints <code>Destructed ~Foo()</code> to the console. Do you think this code compiles?</p>
<p><code>gcc</code> issues the following warning:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1">&lt;source&gt;: In function 'int main()':</span>
<span id="cb9-2">&lt;source&gt;:11:12: warning: deleting 'void*' is undefined [-Wdelete-incomplete]</span>
<span id="cb9-3">   11 |     delete foo_ptr;</span>
<span id="cb9-4">      |            ^~~~~~~</span></code></pre></div>
<p>Let’s try something else:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unique_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> uptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Do you think this code builds?</p>
<p>It’s the same thing. As per the standard, deleteing a <code>void*</code> pointer is undefined behavior. In this particular case, <code>unique_ptr</code> has a static assertion built in to ensure that we don’t use a type-agnostic pointer.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1">&lt;source&gt;:11:43:   </span>
<span id="cb11-2">   11 |     std::unique_ptr&lt;void&gt; uptr{ new Foo() };</span>
<span id="cb11-3">      |                                           ^</span>
<span id="cb11-4">/cefs/e6/e6c9babfba5a70d326be2358_gcc-trunk-20251219/include/c++/16.0.0/bits/unique_ptr.h:88:38: error: static assertion failed: can't delete pointer to incomplete type</span>
<span id="cb11-5">   88 |         static_assert(!is_void&lt;_Tp&gt;::value,</span>
<span id="cb11-6">      |                                      ^~~~~</span>
<span id="cb11-7">  '!(bool)std::integral_constant&lt;bool, true&gt;::value' evaluates to false</span></code></pre></div>
<p>We’ve seen that raw-pointers and <code>unique_ptr</code> don’t work. How about a <code>shared_ptr</code>? Do you think this builds?</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> sptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>In this case, we see the following output:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1">Constructed Foo()</span>
<span id="cb13-2">Destructed ~Foo()</span></code></pre></div>
<p>This is suprising! Is the <code>shared_ptr</code> not storing a raw pointer of <code>void*</code>, whilst the <code>unique_ptr</code> is? How does <code>shared_ptr</code> even able to delete the object correctly? Usually, once you assign a typed address <code>T*</code> to a pointer-to-void <code>void*</code>, you have lost the type information. How is <code>shared_ptr</code> still able to store the original type <code>Foo</code> in order to be able to destruct it correctly?</p>
<p>This is what we mean by type-safety in type erasure. From cppreference.com, if you look at the declarations for the <code>unique_ptr</code> and <code>shared_ptr</code>, they look something like this:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span></span>
<span id="cb14-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb14-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Deleter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>default_delete<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> unique_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><code>shared_ptr</code> only has a template type parameter <code>T</code>. But, magically it also stores the object type information and called the correct destructor. <code>unique_ptr&lt;T&gt;</code> only stores the template type information.</p>
<p>The signature of the <code>shared_ptr</code> templated class kind of gives this away. It doesn’t have a deleter as a template type parameter. The deleter type is erased. In <code>shared_ptr</code> the deleter is based on the object type being passed during construction(and not the template type).</p>
</section>
<section id="type-erasure---adding-support-for-a-custom-deleter-to-the-shared_ptr" class="level1">
<h1>Type erasure - Adding support for a custom deleter to the <code>shared_ptr</code></h1>
<p>Let’s use our learnings above to add support for a custom deleter to the <code>shared_ptr</code>. The <code>shared_ptr</code> needs to be aware of the actual type being passed during construction in order to delete the object correctly. Let’s see how we can achieve that.</p>
<p>A <code>shared_ptr&lt;T1&gt;</code> can store objects of any type <code>T2</code> as long as <code>T2*</code> is convertible to <code>T1*</code>. It type erases <code>T2</code>. Upon destruction, the <code>shared_ptr</code> will call the correct destructor of type <code>T2</code>, that is the destructor of the actual object stored, instead of type <code>T1</code>.</p>
<p>Here is a quick overview of the <code>shared_ptr</code>. Typical implementations of <code>shared_ptr</code> look like as follows:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb15-1">+-------------------+</span>
<span id="cb15-2">|    shared_ptr&lt;T&gt;  |</span>
<span id="cb15-3">+-------------------+</span>
<span id="cb15-4">|                   |</span>
<span id="cb15-5">|  +--------------+ |        +------------+</span>
<span id="cb15-6">|  |   T* ptr     |-|-------&gt;|  T object  | </span>
<span id="cb15-7">|  +--------------+ |        |   (heap)   | </span>
<span id="cb15-8">|                   |        +------------+ </span>
<span id="cb15-9">|  +--------------+ |                       </span>
<span id="cb15-10">|  | ControlBlock*| |        +------------------------------------------+               </span>
<span id="cb15-11">|  |    cb_ptr    |-|-------&gt;|         Control Block (heap)             |</span>
<span id="cb15-12">|  +--------------+ |        +------------------------------------------+</span>
<span id="cb15-13">|                   |        |                                          |</span>
<span id="cb15-14">+------------------+|        |  +------------------------------------+  |</span>
<span id="cb15-15">                             |  |  size_t reference_count            |  |</span>
<span id="cb15-16">                             |  +------------------------------------+  |</span>
<span id="cb15-17">                             |                                          |</span>
<span id="cb15-18">                             |  +------------------------------------+  |</span>
<span id="cb15-19">                             |  |  size_t weak_count                 |  |</span>
<span id="cb15-20">                             |  +------------------------------------+  |</span>
<span id="cb15-21">                             |                                          |</span>
<span id="cb15-22">                             |  +------------------------------------+  |</span>
<span id="cb15-23">                             |  |  Deleter (custom or                |  |</span>
<span id="cb15-24">                             |  |  default delete)                   |  |</span>
<span id="cb15-25">                             |  +------------------------------------+  |</span>
<span id="cb15-26">                             |                                          |</span>
<span id="cb15-27">                             |  +------------------------------------+  |</span>
<span id="cb15-28">                             |  |  Allocator (optional)              |  |</span>
<span id="cb15-29">                             |  +------------------------------------+  |</span>
<span id="cb15-30">                             |                                          |</span>
<span id="cb15-31">                             +------------------------------------------+</span></code></pre></div>
<p>You have a <code>shared_ptr</code> of type <code>T</code>. It stores a raw underlying pointer-to-<code>T</code> and a pointer to a control block. The <code>control_block</code> is a different from the managed object. It stores the reference count, the weak count and some additional data. The custom deleter is going to delete the object type passed during <code>shared_ptr</code> construction and not the type <code>T</code>.</p>
<section id="step-1---code-up-a-container-that-can-hold-unrelated-different-types" class="level2">
<h2 class="anchored" data-anchor-id="step-1---code-up-a-container-that-can-hold-unrelated-different-types">Step 1 - Code up a container that can hold unrelated different types</h2>
<p>We start with thinking about our <code>shared_ptr</code> class. So, we write a templated constructor <code>shared_ptr(Y* ptr)</code>. You should be used to this by now - I can pass in any object to this. I later constrain this using the <code>std::is_convertible_v&lt;Y*, T*&gt;</code> type trait, to enforce that <code>Y*</code> is indeed convertible to <code>T*</code>.</p>
<p>We have another constructor that takes two parameters : a pointer to <code>Y</code> and a custom deleter.</p>
<p>Now, the pointer to <code>Y</code>, <code>Y*</code> is convertible to pointer to <code>T</code>, <code>T*</code>. So, the pointer(address) itself is simply stored in the class as a <code>T*</code> member variable. So, I have a member variable <code>T* m_underlying_ptr</code> at the bottom. The question is how do we store the original object type <code>Y*</code> and the deleter type <code>Deleter</code>. As soon as I assign <code>Y* ptr</code> to <code>T* m_underlying_ptr</code>, I have lost information about the original object type <code>Y*</code>. How do we store the deleter and the true object type <code>Y</code>?</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb16-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb16-6"></span>
<span id="cb16-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb16-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">requires</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_convertible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;</span></span>
<span id="cb16-9">    shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb16-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>default_delete<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{})</span></span>
<span id="cb16-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb16-12"></span>
<span id="cb16-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Templated constructor</span></span>
<span id="cb16-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb16-15">    shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Deleter deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb16-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ???  </span></span>
<span id="cb16-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb16-19"></span>
<span id="cb16-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Destructor</span></span>
<span id="cb16-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb16-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Decrement the ref-count. If m_ref_count == 0, </span></span>
<span id="cb16-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// delete m_underlying_ptr using deleter </span></span>
<span id="cb16-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-25"></span>
<span id="cb16-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Pointer like functions</span></span>
<span id="cb16-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-29">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-30"></span>
<span id="cb16-31">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb16-32">    T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
</section>
<section id="step-2---coding-up-a-type-agnostic-interface-and-a-type-dependent-implementation" class="level2">
<h2 class="anchored" data-anchor-id="step-2---coding-up-a-type-agnostic-interface-and-a-type-dependent-implementation">Step 2 - Coding up a type-agnostic interface and a type-dependent implementation</h2>
<p>Let’s now write a <code>Concept</code> and <code>Impl</code> class that supports destruction using an instance of the custom <code>Impl&lt;ObjType, Deleter&gt;</code> type. We can actually define a <code>ControlBlockBase</code> and <code>ControlBlockImpl&lt;ObjType, Deleter&gt;</code> classes.</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb17-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Type-agnostic Concept class</span></span>
<span id="cb17-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> ControlBlockBase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb17-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_ref_count</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-5">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>ControlBlockBase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">default</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-7"></span>
<span id="cb17-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Type dependent Impl&lt;ObjType,Deleter&gt; implementation</span></span>
<span id="cb17-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> ObjType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb17-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> ControlBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> ControlBlockBase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb17-11">        ControlBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span> ObjType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> object_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Deleter deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb17-12">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_object_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> object_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb17-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_deleter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> deleter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb17-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb17-15"></span>
<span id="cb17-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>ControlBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb17-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb17-18">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_deleter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_object_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb17-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb17-20"></span>
<span id="cb17-21">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb17-22">        ObjType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_object_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-23">        Deleter <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_deleter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-25"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// namespace dev</span></span></code></pre></div>
<p>The <code>ControlBlock</code> inherits from <code>ControlBlockBase</code> and it is templated. <code>Concept</code> itself is not templated, but the implementation <code>control_block</code> class is. In this case, it is templated on the <code>ObjectType</code> and the <code>Deleter</code> type. The constructor <code>control_block(ObjectType*, Deleter)</code> takes two parameters - the object type and the deleter. <code>ObjectType</code> is not the type parameter of the <code>shared_ptr</code>, which is <code>T</code>, but the type of the object passed to the <code>shared_ptr()</code> during construction.</p>
<p>On destruction of the control block, it calls the deleter on a pointer to <code>ObjType</code> - the correct type. It’s not going to call the deleter on the template type. We can now, finish up with our definition of the <code>shared_ptr</code>.</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb18-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb18-6"></span>
<span id="cb18-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb18-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">requires</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_convertible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;</span></span>
<span id="cb18-9">    shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>default_delete<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{})</span></span>
<span id="cb18-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb18-12"></span>
<span id="cb18-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Templated constructor</span></span>
<span id="cb18-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb18-15">    shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Deleter deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb18-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_control_block_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> ControlBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>Deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb18-19"></span>
<span id="cb18-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Destructor</span></span>
<span id="cb18-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb18-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Decrement the ref-count. If m_ref_count == 0, </span></span>
<span id="cb18-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// delete the control_block_ptr which will destroy the managed object </span></span>
<span id="cb18-24">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_control_block_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-26"></span>
<span id="cb18-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Pointer like functions</span></span>
<span id="cb18-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-31"></span>
<span id="cb18-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb18-33">    T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-34">    ControlBlockBase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_control_block_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Concept* pointer</span></span>
<span id="cb18-35"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Observe that, as long as the two <code>shared_ptr</code> types share the same signature, they can be assigned to each other and the destruction is going to be correct.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb19-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb19-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb19-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> ptr1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> Foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb19-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> ptr2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> Bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb19-9">    ptr1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/xboYxMsYd">Compiler Explorer</a></p>
<p>I was explaining earlier why a <code>shared_ptr&lt;void&gt;</code> is allowed whereas a <code>unique_ptr&lt;void&gt;</code> won’t compile.</p>
<p>You can see that, what the <code>shared_ptr</code> design does is, in the single parameter constructor, when you don’t pass a deleter, it uses a default deleter of the actual object type. It retains the information of the actual object type. It does not use a default deleter of template type parameter <code>T</code>.</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb20-2"></span>
<span id="cb20-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb20-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb20-6"></span>
<span id="cb20-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb20-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">requires</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_convertible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;</span></span>
<span id="cb20-9">    shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb20-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>default_delete<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;{})</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// default deleter of ObjType</span></span>
<span id="cb20-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb20-12"></span>
<span id="cb20-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Templated constructor</span></span>
<span id="cb20-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb20-15">    shared_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Deleter deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb20-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_control_block_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> ControlBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>Deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>deleter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb20-19"></span>
<span id="cb20-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb20-21"></span>
<span id="cb20-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb20-23">    T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_underlying_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-24">    ControlBlockBase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_control_block_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Concept* pointer</span></span>
<span id="cb20-25"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/type-erasure/index.html</guid>
  <pubDate>Thu, 18 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/type-erasure/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Implementing string</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/implementing_string/index.html</link>
  <description><![CDATA[ 




<section id="implementing-a-basic-string-class" class="level1">
<h1>Implementing a basic <code>string</code> class</h1>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Write your solution here</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// C++20 for C++</span></span>
<span id="cb1-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;gtest/gtest.h&gt;</span></span>
<span id="cb1-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb1-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdint&gt;</span></span>
<span id="cb1-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;format&gt;</span></span>
<span id="cb1-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb1-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdexcept&gt;</span></span>
<span id="cb1-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb1-11"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;unordered_map&gt;</span></span>
<span id="cb1-12"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;list&gt;</span></span>
<span id="cb1-13"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;tuple&gt;</span></span>
<span id="cb1-14"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;bit&gt;</span></span>
<span id="cb1-15"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;bitset&gt;</span></span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@brief</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: A string class</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    * The capacity is usually a power of 2, so the </span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    * least significant bit of the m_capacity field</span></span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    * is set to 0, to indicate string_long format. And</span></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    * if set to 1, it implies SSO. </span></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    */</span></span>
<span id="cb1-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> string_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-27">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-28">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb1-29">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb1-30"></span>
<span id="cb1-31">        CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>   <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 8 bytes</span></span>
<span id="cb1-32">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 8 bytes</span></span>
<span id="cb1-33">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 8 bytes</span></span>
<span id="cb1-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-35"></span>
<span id="cb1-36">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-37">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> string_short<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-38">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-39">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb1-40">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb1-41">        </span>
<span id="cb1-42">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-43"></span>
<span id="cb1-44">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 23 bytes</span></span>
<span id="cb1-45">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 1 byte</span></span>
<span id="cb1-46">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-47"></span>
<span id="cb1-48">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">enum</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> string_short_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0x01</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-49">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">enum</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> string_long_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-50"></span>
<span id="cb1-51">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-52">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-53">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-54">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb1-55">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb1-56">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb1-57">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb1-58">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-59"></span>
<span id="cb1-60">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">union</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-61">            string_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-62">            string_short<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-63">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-64"></span>
<span id="cb1-65">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb1-66"></span>
<span id="cb1-67">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_small<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-68">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> string_short_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-69">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-70"></span>
<span id="cb1-71">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-72">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_small<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-73">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-74"></span>
<span id="cb1-75">        pointer get_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb1-76">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> is_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-77">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-78"></span>
<span id="cb1-79">        const_pointer get_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-80">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> is_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-81">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>        </span>
<span id="cb1-82"></span>
<span id="cb1-83">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> set_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-84">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> string_short_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-85">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::println("m_data.s.m_size = {}", m_data.s.m_size);</span></span>
<span id="cb1-86">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-87"></span>
<span id="cb1-88">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> get_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-89">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::println("get_short_size()");</span></span>
<span id="cb1-90">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::println("m_data.s.m_size &gt;&gt; 1 = {}", m_data.s.m_size &gt;&gt; 1);</span></span>
<span id="cb1-91">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-92">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-93"></span>
<span id="cb1-94">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> get_long_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-95">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//std::println("get_long_size()");</span></span>
<span id="cb1-96">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-97">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-98"></span>
<span id="cb1-99">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> set_long_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-100">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-101">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-102"></span>
<span id="cb1-103">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> get_long_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-104">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(~(</span>string_long_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-105">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-106"></span>
<span id="cb1-107">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> set_long_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-108">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~(</span>string_long_mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-109">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-110"></span>
<span id="cb1-111">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> get_short_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-112">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-113">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-114"></span>
<span id="cb1-115">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-116">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> is_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> get_long_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> get_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-117">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-118"></span>
<span id="cb1-119">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-120">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> is_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> get_long_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> get_short_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-121">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-122"></span>
<span id="cb1-123">        pointer allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-124">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-125">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-126"></span>
<span id="cb1-127">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pointer ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-128">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-129">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-130">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-131"></span>
<span id="cb1-132">        string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb1-133">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-134">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize as short string (empty)</span></span>
<span id="cb1-135">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-136">            set_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This sets bit 0 to mark as short</span></span>
<span id="cb1-137">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-138"></span>
<span id="cb1-139">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> construct_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_pointer chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-140">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-141">                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-142"></span>
<span id="cb1-143">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-144">            set_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-145">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-146"></span>
<span id="cb1-147">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> construct_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_pointer chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-148">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>bit_ceil<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// +1 for '\0'</span></span>
<span id="cb1-149">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-150"></span>
<span id="cb1-151">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> </span>
<span id="cb1-152">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-153">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-154">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-155">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-156">            set_long_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-157">            set_long_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-158">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-159"></span>
<span id="cb1-160">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// constructors</span></span>
<span id="cb1-161">        string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_pointer chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-162">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-163">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> strlen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-164">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-165">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-166">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-167">                set_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This sets bit 0 to mark as short</span></span>
<span id="cb1-168">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-169">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-170">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-171">                construct_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-172">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-173">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-174">                construct_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-175">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-176">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-177"></span>
<span id="cb1-178">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//copy constructor</span></span>
<span id="cb1-179">        string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-180">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-181">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-182">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-183">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-184">                set_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This sets bit 0 to mark as short</span></span>
<span id="cb1-185">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-186">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-187"></span>
<span id="cb1-188">            const_pointer other_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-189">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-190">                construct_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-191">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb1-192">                construct_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-193">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-194"></span>
<span id="cb1-195">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// move constructor</span></span>
<span id="cb1-196">        string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-197">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_small<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// other is short string format</span></span>
<span id="cb1-198">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-199">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy the buffer </span></span>
<span id="cb1-200">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb1-201">                    other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb1-202">                    other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb1-203">                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span></span>
<span id="cb1-204">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-205"></span>
<span id="cb1-206">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// zero out other's buffer</span></span>
<span id="cb1-207">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>fill_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb1-208">                    other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-209">                    other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb1-210">                    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-211">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-212"></span>
<span id="cb1-213">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-214">                set_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-215">                other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set_short_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-216">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-217">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//other is long string format</span></span>
<span id="cb1-218">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-219">                set_long_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_long_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-220">                set_long_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_long_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-221">                other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set_long_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-222">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-223">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-224"></span>
<span id="cb1-225">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// swap</span></span>
<span id="cb1-226">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-227">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-228">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-229"></span>
<span id="cb1-230">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy assignment</span></span>
<span id="cb1-231">        string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-232">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-233">            string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-234">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-235">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-236"></span>
<span id="cb1-237">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// move assignment</span></span>
<span id="cb1-238">        string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-239">            string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-240">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-241">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-242"></span>
<span id="cb1-243">        CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-244">            pointer buffer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-245">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-246">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-247"></span>
<span id="cb1-248">        const_reference at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-249">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb1-250">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>out_of_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Index out of bounds!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-251"></span>
<span id="cb1-252">            const_pointer buffer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-253">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb1-254">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-255"></span>
<span id="cb1-256">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CharType<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-257">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb1-258">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-259"></span>
<span id="cb1-260">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-261">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-262">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb1-263">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-264">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-265">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-266">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-267"></span>
<span id="cb1-268">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span>const_pointer other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-269">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> other_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> strlen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-270">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> my_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-271"></span>
<span id="cb1-272">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>my_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> other_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-273">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-274"></span>
<span id="cb1-275">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>my_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-276">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-277">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> my_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-278">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span></span>
<span id="cb1-279">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-280">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-281">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-282">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-283">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-284"></span>
<span id="cb1-285">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-286">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-287">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-288"></span>
<span id="cb1-289">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Append a character to the end</span></span>
<span id="cb1-290">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>CharType ch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-291">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_small<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb1-292">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-293">                </span>
<span id="cb1-294">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-295">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-296"></span>
<span id="cb1-297">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-298">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_long<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-299">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-300">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer_ptr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-301">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-302">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-303"></span>
<span id="cb1-304">        CharType front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb1-305">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-306">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-307"></span>
<span id="cb1-308">        CharType back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb1-309">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-310">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-311">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-312"></span>
<span id="cb1-313"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// namespace dev</span></span>
<span id="cb1-314"></span>
<span id="cb1-315">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> DefaultCtorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-316">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-317">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-318">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-319"></span>
<span id="cb1-320">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb1-321">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-322">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  </span>
<span id="cb1-323"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-324"></span>
<span id="cb1-325">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CtorStringStackAllocationTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-326">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-327">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-328">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-329"></span>
<span id="cb1-330">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"World"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-331">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>chars_array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-332">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-333">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"World"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-334"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-335"></span>
<span id="cb1-336">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CtorStringHeapAllocationTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-337">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C++ is a general-purpose and multi-paradigm programming language!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-338">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-339">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C++ is a general-purpose and multi-paradigm programming language!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-340"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-341"></span>
<span id="cb1-342">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CopyConstructSmallStringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-343">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-344">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-345">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-346">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-347">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-348">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb1-349"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-350"></span>
<span id="cb1-351">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CopyConstructLongStringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-352">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C++ is a general-purpose and multi-paradigm programming language!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-353">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-354">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-355">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-356">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-357">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb1-358"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-359"></span>
<span id="cb1-360">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> EmptyTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-361">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb1-362">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-363"></span>
<span id="cb1-364">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-365">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-366">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-367"></span>
<span id="cb1-368">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-369">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-370">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-371"></span>
<span id="cb1-372">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-373">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-374">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s4<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-375"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-376"></span>
<span id="cb1-377">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> SwapTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-378">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-379">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"World!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-380">    s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-381">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-382">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-383">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"World!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-384">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-385"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-386"></span>
<span id="cb1-387">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MoveConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-388">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}};</span></span>
<span id="cb1-389">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-390">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-391"></span>
<span id="cb1-392">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"World!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-393">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)};</span></span>
<span id="cb1-394">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"World!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-395">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-396">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-397">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-398"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-399"></span>
<span id="cb1-400">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CopyAssignmentTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-401"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-402">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-403">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-404">    s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-405">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-406">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-407"></span>
<span id="cb1-408">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ouroboros"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-409">    s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-410">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ouroboros"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-411">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> s3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-412">    EXPECT_NE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-413"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-414"></span>
<span id="cb1-415">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MoveAssignmentTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-416">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GNU is not Unix!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-417">    s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WINE is not an emulator!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-418">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WINE is not an emulator!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-419">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> strlen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WINE is not an emulator!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-420"></span>
<span id="cb1-421">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pip installs packages"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-422">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> expected_len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-423">    s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-424">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pip installs packages"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-425">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> expected_len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-426">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-427">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-428"></span>
<span id="cb1-429">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a moved from string can be moved to again</span></span>
<span id="cb1-430">    s2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Emacs makes a computer sing"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-431">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Emacs makes a computer sing"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-432"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-433"></span>
<span id="cb1-434">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FrontTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-435"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-436">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small string optimization(SSO) is awesome!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-437">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'S'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-438"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-439"></span>
<span id="cb1-440">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> BackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-441"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-442">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small string optimization(SSO) is awesome!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-443">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'!'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-444"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-445"></span>
<span id="cb1-446">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>StringTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PushBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-447">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>string s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brownian motion"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-448"></span>
<span id="cb1-449"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-450"></span>
<span id="cb1-451"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> argc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> argv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-452">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>testing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>InitGoogleTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>argc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> argv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-453">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> RUN_ALL_TESTS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-454"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/cc5aGPc9G">Compiler Explorer</a></p>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/implementing_string/index.html</guid>
  <pubDate>Thu, 18 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/implementing_string/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Implementing LRU Cache</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/implementing_lru_cache/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>A <em>least recently used</em>(LRU) cache is a fixed-size cache that behaves just like a regular lookup table, but remembers the order in which the elements are accessed. Once it’s user defined capacity is reached it uses the information to replace the least recently used element with a new one. This is ideal for caching function return values, where fast lookup of complex computations is favorable, but a memory blowup from caching all <code>(input, output)</code> pairs is to be avoided. We will first write a basic implementation of <code>LRUCache</code>.</p>
<p>We will then add functionality to connect all our caches to <em>statistics</em> objects that keep track of cache hits and misses for all keys and upon request, individual keys (similar to <code>functools.lrucache</code> in Python). You can also register arbitrary callbacks for hits, misses and accesses in general.</p>
<blockquote class="blockquote">
<h4 id="task" class="anchored" data-anchor-id="introduction">Task</h4>
</blockquote>
<p>Design a data structure that follows the constraints of a Least Recently Used (LRU) cache.</p>
<p>Implement the <code>LRUCache</code> class:</p>
<ul>
<li><code>LRUCache(int capacity)</code> Initialize the LRU cache with positive size <code>capacity</code>.</li>
<li><code>int get(int key)</code> Return the value of the key if the key exists, otherwise return <code>-1</code>.</li>
<li><code>void put(int key, int value)</code> Update the value of the key if the key exists. Otherwise, add the key-value pair to the cache. If the number of keys exceeds the capacity from this operation, evict the least recently used key.</li>
</ul>
<p>The functions <code>get</code> and <code>put</code> must each run in <img src="https://latex.codecogs.com/png.latex?O(1)"> average time complexity.</p>
</section>
<section id="basic-implementation" class="level1">
<h1>Basic implementation</h1>
<p>We will use a <code>std::list</code> to track the usage of the keys and a <code>std::unordered_map</code> to provide fast access to the key-value pair in the last.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Write your solution here</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// C++20 for C++</span></span>
<span id="cb1-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;gtest/gtest.h&gt;</span></span>
<span id="cb1-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstddef&gt;</span></span>
<span id="cb1-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cstdint&gt;</span></span>
<span id="cb1-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;format&gt;</span></span>
<span id="cb1-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdexcept&gt;</span></span>
<span id="cb1-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb1-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;unordered_map&gt;</span></span>
<span id="cb1-11"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;list&gt;</span></span>
<span id="cb1-12"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;tuple&gt;</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@brief</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: LRU (Least Recently Used) policy</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    */</span></span>
<span id="cb1-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span></span>
<span id="cb1-19">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb1-20">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb1-21">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Container<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;::</span>iterator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span></span>
<span id="cb1-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> LRUCache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-23">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> lru_list_iterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;::</span>iterator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-24"></span>
<span id="cb1-25">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb1-26">        Container <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-27">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb1-28">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-29"></span>
<span id="cb1-30">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb1-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// explicit single-parameter constructor</span></span>
<span id="cb1-32">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> LRUCache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-33">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-34">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-35">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-37"></span>
<span id="cb1-38">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> touch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lru_list_iterator it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-39">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>splice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-40">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-41"></span>
<span id="cb1-42">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Key key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-43">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>find<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-44">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>optional<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-45">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb1-46">                result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>nullopt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-47">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-48">                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*((*</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-49">                result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-50">                touch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-51">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-52">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-53">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-54"></span>
<span id="cb1-55">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Key key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Value value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-56">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>find<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-57">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb1-58">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-59">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-60">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-61">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//Evict the least recently used (k,v) pair</span></span>
<span id="cb1-62">                    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>lru_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> lru_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-63">                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>erase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lru_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-64">                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>pop_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-65">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-66">                    </span>
<span id="cb1-67">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Insert the key-value pair</span></span>
<span id="cb1-68">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb1-69">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_lru_list</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-70">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-71">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Update the key-value pair</span></span>
<span id="cb1-72">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_dict</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]-&gt;</span>second <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-73">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-74">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-75">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-76"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// namespace dev</span></span>
<span id="cb1-77"></span>
<span id="cb1-78"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;array&gt;</span></span>
<span id="cb1-79"></span>
<span id="cb1-80">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>CacheTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> SimplePut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-81"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-82">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>LRUCache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-83"></span>
<span id="cb1-84">    cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">666</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-85"></span>
<span id="cb1-86">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">666</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-87"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-88"></span>
<span id="cb1-89">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>CacheTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PutWithUpdate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-90"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-91">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>TEST_CASE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-92">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>LRUCache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>TEST_CASE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-93"></span>
<span id="cb1-94">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TEST_CASE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-95">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-96">        cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>to_string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-97"></span>
<span id="cb1-98">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>to_string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-99">        ASSERT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-100">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-101"></span>
<span id="cb1-102">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TEST_CASE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-103">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-104">        ASSERT_TRUE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>to_string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)));</span></span>
<span id="cb1-105">        cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>to_string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-106"></span>
<span id="cb1-107">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>to_string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-108">        ASSERT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-109">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-110"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-111"></span>
<span id="cb1-112">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>CacheTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> KeepsAllValuesWithinCapacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-113"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-114">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> CACHE_CAP <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-115">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> TEST_RECORDS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-116">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>LRUCache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>CACHE_CAP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-117"></span>
<span id="cb1-118">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TEST_RECORDS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-119">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-120">        cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-121">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-122"></span>
<span id="cb1-123">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TEST_RECORDS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> CACHE_CAP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-124">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-125">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>nullopt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-126">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-127"></span>
<span id="cb1-128">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TEST_RECORDS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> CACHE_CAP<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TEST_RECORDS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-129">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-130">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-131">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-132"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-133"></span>
<span id="cb1-134">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>CacheTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PutAndGet<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-135">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>LRUCache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-136">    lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// cache is {1=1}</span></span>
<span id="cb1-137">    lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// cache is {2=2, 1=1}</span></span>
<span id="cb1-138">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// return 1, cache is {1=1, 2=2} </span></span>
<span id="cb1-139">    lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// evicts key 2, cache is {3=3, 1=1}</span></span>
<span id="cb1-140">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>nullopt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// returns std::nullopt (not found)</span></span>
<span id="cb1-141">    lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>put<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// LRU key was 1, evicts key 1, cache is {4=4, 3=3}</span></span>
<span id="cb1-142">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>nullopt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// return std::nullopt (not found)</span></span>
<span id="cb1-143">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// return 3, cache is {3=3, 4=4}</span></span>
<span id="cb1-144">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>lru_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// return 4, cache is {4=4, 3=3}</span></span>
<span id="cb1-145"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-146"></span>
<span id="cb1-147"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> argc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> argv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-148">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>testing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>InitGoogleTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>argc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> argv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-149">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> RUN_ALL_TESTS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb1-150"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/snodGh33T">Compiler Explorer</a></p>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/implementing_lru_cache/index.html</guid>
  <pubDate>Wed, 17 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/implementing_lru_cache/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Header files and translation units</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/header_files_and_translation_units/index.html</link>
  <description><![CDATA[ 







 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/header_files_and_translation_units/index.html</guid>
  <pubDate>Wed, 17 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/header_files_and_translation_units/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>How libstdc++ std::unordered_map is implemented?</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>We all love maps. A map is simply a data-structure that allows you to associate a key with some kind of value. They are fast and help to solve a large number of problems. Have you wondered what the internal implementation of a map looks like? In this post, I am going to explore the implementation details of unordered associative containers from the standard library(GCC’s <code>libstdc++</code> implementation).</p>
<p>Currently there are four types of unordered associative containers:</p>
<ul>
<li><code>std::unordered_map</code></li>
<li><code>std::unordered_set</code></li>
<li><code>std::unordered_multimap</code></li>
<li><code>std::unordered_multiset</code></li>
</ul>
<p>Usually, they are implemented on top of some kind of container. I am going to jump into the implementation of this <code>HashTable</code> container directly, because that’s where all the interesting stuff is hidden.</p>
<p>I’ll focus on the key-value containers with a unique set of keys(<code>std::unordered_map</code> and <code>std::unordered_set</code>) which have mostly similar logic.</p>
<p>GCC’s implementation can be found in the <a href="https://github.com/gcc-mirror/gcc/blob/127cd406/libstdc++-v3/include/bits/hashtable.h"><code>hashtable.h</code> header</a>. There are a lot of names with leading underscores. Not everyone is used to such code, but the standard library implementers have no choice, but to avoid collisions with user-defined names.</p>
</section>
<section id="data-layout" class="level1">
<h1>Data Layout</h1>
<section id="nodes" class="level2">
<h2 class="anchored" data-anchor-id="nodes">Nodes</h2>
<p>One of the basic building blocks of the <code>_Hashtable</code> is a node. Each node is allocated from the heap and stores container data along with metadata information to maintain the hash table data-structure.</p>
<p>The node itself is a compound entity and contains several parts, some of them, optional. The design of the node <code>structs</code> brings to mind Russian dolls, because they are nested to each other.</p>
<div class="{text-center}">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/Russian-Matroshka.jpg" style="width:75.0%;height:75.0%" class="figure-img"></p>
<figcaption class="figure-caption">Russian dolls</figcaption>
</figure>
</div>
</div>
<p>The more complex node type(with more data) is inherited from the simpler node type(with a little bit less data). Let us walk through the components bottom up(from simpler to complex).</p>
<p>First, <code>_Hash_node_base</code> is defined in the following way. It has only <code>_M_nxt</code> field, which is a pointer to the next node of the hash table.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_base</span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> _M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-6"></span>
<span id="cb1-7">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>_Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> __next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>__next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The next one <code>_Hash_node_value_base</code> is a little bit more interesting(see the actual code <a href="https://github.com/gcc-mirror/gcc/blob/b9b7981f3d6919518372daf4c7e8c40dfc58f49d/libstdc%2B%2B-v3/include/bits/hashtable_policy.h#L318-L345">here</a>). <code>_Hash_node_value_base</code> is responsible for storing the actual element value in the <code>_M_storage</code> member variable. It also provides accessor methods to retrieve the stored value.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_value_base</span>
<span id="cb2-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5"></span>
<span id="cb2-6">    __gnu_cxx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>__aligned_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> _M_storage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-7"></span>
<span id="cb2-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb2-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>It is a templated class with <code>_Value</code> template parameter that represents the <code>value_type</code>. <code>_Value</code> type is wrapped into <code>__gnu_cxx::__aligned_buffer</code> (thin wrapper around <code>std::aligned_storage</code>) to decouple memory allocation from actual object creation.</p>
<p>The next struct is <code>_Hash_node_code_cache</code> and it implements hash value caching logic. When searching for a key in an unordered map, (i) we need to compute the hash-code of the search key, <img src="https://latex.codecogs.com/png.latex?h(k)">, (ii) find the right bucket <code>idx = h(k) % table_size</code> and then (iii) walk the collision chain comparing each node’s key with you key <img src="https://latex.codecogs.com/png.latex?k">. When keys are large or complex like <code>std::string</code>, using the equality predicate and doing full key comparisons for every node in the chain is expensive. So, we can choose the cach the hash code with each node:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> __cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_code_cache <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> _M_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Stored hash value</span></span>
<span id="cb3-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Specialization when caching is disabled</span></span>
<span id="cb3-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_code_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Empty - no overhead</span></span>
<span id="cb3-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>This way Empty Base Class Optimization(EBCO) can be leveraged, since <code>_Hash_node_code_cache</code> will be extended by inheritance. And that’s exactly what <code>_Hash_node_value</code> is doing:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> _Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node_value</span>
<span id="cb4-3">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _Hash_node_value_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-4">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> _Hash_node_code_cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb4-5">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The size of the <code>_Hash_node_value</code> will be the same as size of <code>_Hash_node_value_base&lt;_Value&gt;</code> in case template argument <code>_Cache_hash_code</code> is <code>false</code> as <code>_Hash_node_code_cache</code> will be an empty struct.</p>
<p>The final piece of the puzzle is the <code>_Hash_node</code> that combines everything above together:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> _Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> _Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> _Hash_node</span>
<span id="cb5-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> _Hash_node_base</span>
<span id="cb5-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> _Hash_node_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> _Cache_hash_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb5-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-6">    _Hash_node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb5-7">    _M_next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span></span>
<span id="cb5-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_Hash_node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>_M_nxt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Below is a picture of the <code>_Hash_node</code> struct data layout to better visualize what’s going on.</p>
<pre><code>+==============================================================+
| _Hash_node&lt;Value&gt;                                            |
+______________________________________________________________+
| inherits from _Hash_node_base                                |
+--------------------------------------------------------------+
|       _Hash_node_base*          _M_nxt; // ptr to next node  |
+______________________________________________________________+
| inherits from _Hash_node_value                               |
+--------------------------------------------------------------+
|   inherits from _Hash_node_value_base                        |
+--------------------------------------------------------------+
|       aligned_buffer&lt;Value&gt;     _M_storage;    // The value  |
+--------------------------------------------------------------+
|   inherits from _Hash_node_code_cache                        |
+--------------------------------------------------------------+
|       size_t                    _M_hash_code;  // Cached hash|
+______________________________________________________________+</code></pre>
<p>Summarizing, _Hash_node (directly or inherited from base structs) contains the following data.</p>
<ul>
<li><code>_Hash_node_base* _M_nxt</code> is a pointer to the next element in the linked list of hash table elements.</li>
<li><code>__gnu_cxx::__aligned_buffer&lt;_Value&gt; _M_storage</code> — node data itself. For example for <code>std::unordered_map&lt;std::string, int&gt;</code> container <code>_Value</code> template argument is <code>std::pair&lt;const std::string, int&gt;</code>.</li>
<li><code>std::size_t _M_hash_code</code> optional cached value of key’s hash.</li>
</ul>
</section>
<section id="hash-table" class="level2">
<h2 class="anchored" data-anchor-id="hash-table">Hash table</h2>
<p>The <code>_Hashtable</code> class is defined in the following way:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> _Hashtable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-3">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>   _M_buckets          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>_M_single_bucket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>        _M_bucket_count     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-5">    _Hash_node_base     _M_before_begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>        _M_element_count    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-7">    _RehashPolicy       _M_rehash_policy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-8"></span>
<span id="cb7-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb7-10">    _Hash_node_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>     _M_single_bucket    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>The <code>Hashtable</code> class itself is a combination of <code>std::forward_list&lt;_Hash_node&gt;</code> - a linked list containing the elements belonging to a bucket and <code>std::vector&lt;std::forward_list&lt;_Hash_node&gt;::iterator&gt;</code> - a vector(array) of pointers representing the buckets.</p>
<p><code>_Hash_node_base** _M_buckets</code> is an array of pointers to hash table nodes. One can think of it as <code>_Hash_node_base* _M_buckets[]</code> instead of a pointer to a pointer.</p>
<p><code>_Hash_node_base _M_before_begin</code> is a special node without any user data. This node stores a pointer to the first hash table element (if there is any) in <code>_M_before_begin._M_nxt</code>.</p>
<p>One interesting thing is that <code>_M_buckets</code> contains <code>_Hash_node_base*</code> instead of <code>_Hash_node*</code>. The reason is because <code>_M_buckets</code> is kind of a storage for two types of objects: actual hash table nodes and a special <em>before begin node</em> <code>_M_before_begin</code>. This should be a lot more clear from the example:</p>
<p>Suppose we have the following code and we create <code>std::unordered_map</code> and insert <img src="https://latex.codecogs.com/png.latex?4"> keys in this order <img src="https://latex.codecogs.com/png.latex?14,%2025,%2036,%2019">.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unordered_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-2"></span>
<span id="cb8-3">map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-4">map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-5">map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-6">map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>Then, the internal <code>_Hashtable</code> linked list will like the one in the picture below. The key order in the hash table is a reverse insertion order, so the key’s iteration order will be <img src="https://latex.codecogs.com/png.latex?19">, <img src="https://latex.codecogs.com/png.latex?36">, <img src="https://latex.codecogs.com/png.latex?25">, <img src="https://latex.codecogs.com/png.latex?14">.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/_hashtable_01.png" style="width:75.0%;height:75.0%" class="figure-img"></p>
<figcaption class="figure-caption">Internal _Hashtable linked list</figcaption>
</figure>
</div>
<p>Let’s make a real hash table from the linked list by adding buckets.</p>
<p>There are <img src="https://latex.codecogs.com/png.latex?11"> buckets in the picture, only two buckets are not empty - buckets at index <img src="https://latex.codecogs.com/png.latex?3"> and <img src="https://latex.codecogs.com/png.latex?8">.</p>
<p>Thin arrows are pointers from the <code>_Hashtable</code> internal linked list from the previous picture, this time slightly rearranged and grouped by buckets. Each bucket stores a pointer to the node before the first node from the bucket.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/_hashtable_02.png" style="width:75.0%;height:75.0%" class="figure-img"></p>
<figcaption class="figure-caption">Internal _Hashtable linked list</figcaption>
</figure>
</div>
<p>Bucket index <code>3</code> has keys <code>36</code>, <code>25</code> and <code>19</code>, but a <code>_Hash_node_base*</code> from <code>_M_buckets</code> array points to the element with a key <code>19</code>, which is a <strong>previous</strong> element in the hash table iteration order. Same logic is true for the bucket index <code>8</code>. For this bucket, <code>_M_buckets</code> array has a pointer to the <code>_M_before_begin_node</code>.</p>
</section>
</section>
<section id="fast-and-slow-hash-functions" class="level1">
<h1>Fast and slow hash functions</h1>
<p>GCC’s libstdc++ hash table implementation distinguishes between fast and slow hash functions. If the hash function is slow, then the hash code will be cached inside the hash table node.</p>
<p>Currently, <code>std::hash</code> is fast by default(including user-defined types), except for <code>long double</code> and string-like types (<code>std::string</code>, <code>std::string_view</code> and all other variations of character types).</p>
<p>Comparison of two strings with lengths <img src="https://latex.codecogs.com/png.latex?n">, <img src="https://latex.codecogs.com/png.latex?m"> has <img src="https://latex.codecogs.com/png.latex?O(n,m)"> complexity, but if we’ll cache the hash value in the hash table node, we can implement faster negative comparison. If hash codes of two strings do not match, we can instantly conclude they are not equal. Integer comparison just takes one CPU cycle.</p>
<p>For integer types, <code>std::hash</code> is defined as the identity function.</p>
<p># Insert</p>
<p>Now, that we know how the hash table is internally organized, let’s look at the implementation of <code>insert</code>. The high level steps are the following:</p>
<ul>
<li>Check that there is no such key in the hash table.</li>
<li>Create a hash table node.</li>
<li>Insert the new node to a hash-table data structure.</li>
</ul>
<p>The implementation is in the <code>_M_insert_unique</code> method. And there is a surprise on the first line of code:</p>


</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/index.html</guid>
  <pubDate>Tue, 16 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/how_libstdcxx_map_is_implemented/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Implementing vector&lt;T&gt;</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/implementing_vector/index.html</link>
  <description><![CDATA[ 




<section id="implementing-vectort" class="level1">
<h1>Implementing <code>vector&lt;T&gt;</code></h1>
<section id="the-problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-statement">The problem statement</h2>
<blockquote class="blockquote">
<h4 id="your-task" class="anchored">Your Task</h4>
</blockquote>
<p>Implement your own version of a vector with the following methods:</p>
<ul>
<li><code>push_back</code> – Adds an element to the back.</li>
<li><code>at</code> – Retrieves an element by index.</li>
<li><code>getSize</code> – Gets the size of the container.</li>
<li><code>getCapacity</code> – Gets the capacity of the container.</li>
<li><code>shrinkToFit</code> – Shrinks the capacity to equal the size of the container.</li>
<li><code>pop_back</code> – Removes the last element in the container. Will never be called on an empty container.</li>
</ul>
<blockquote class="blockquote">
<h4 id="requirements" class="anchored">Requirements</h4>
</blockquote>
<ul>
<li>Do not worry about memory alignment or advanced optimizations.</li>
<li>Do not use <code>std::vector</code> in your <code>dev::vector</code> implementation.</li>
<li>Your vector’s capacity must start at 1.</li>
<li>The capacity should triple every time it is reached.</li>
</ul>
<p>For more such C++ coding tasks, visit <a href="https://getcracked.io/problem/1/implement-vector">getcracked.io</a>.</p>
</section>
</section>
<section id="writing-your-own-vectort-training-implementation" class="level1">
<h1>Writing your own <code>vector&lt;T&gt;</code> training implementation</h1>
<blockquote class="blockquote">
<h3 id="if-you-know-stdvector-you-know-half-of-c." class="anchored"><em>If you know <code>std::vector</code>, you know half of C++.</em></h3>
<h3 id="bjarne-stroustrup" class="anchored">- Bjarne Stroustrup</h3>
</blockquote>
<p>The most fundamental STL data-structure is the <code>vector</code>. In this article, I am going to explore writing a custom implementation of the <code>vector</code> data-structure. The standard library implementation <code>std::vector</code> is a work of art, it is extremely efficient at managing memory and has been tested ad nauseam. It is much better, in fact, than a homegrown alternative would be.</p>
<p>Why then write our own custom <code>vector</code>? - Writing a naive implementation is challenging and rewarding. It is a lot of fun! - Coding up these training implementations, thinking about corner cases, getting your code reviewed, revisiting your design is very effective at understanding the inner workings of STL data-strucures and writing good C++ code. - Its a good opportunity to learn about low-level memory management algorithms.</p>
<p>We are not aiming for an exhaustive representation or implementation, but we will write test cases for all basic functionalities expected out of a <code>vector</code> like data-structure.</p>
<p>Informally, a <code>std::vector&lt;T&gt;</code> represents a dynamically allocated array that can grow as needed. As with any array, a <code>std::vector&lt;T&gt;</code> is a sequence of elements of type <code>T</code> arranged contigously in memory. We will put our homegrown version of <code>vector&lt;T&gt;</code> under the <code>dev</code> namespace.</p>
<section id="unit-tests-for-vectort" class="level2">
<h2 class="anchored" data-anchor-id="unit-tests-for-vectort">Unit tests for <code>vector&lt;T&gt;</code></h2>
<p>For low-level data-structures such as the <code>vector</code>, let’s write the unit-tests upfront before the implementation. This will help us think through the interface and corner cases. Tests will also serve as documentation of the expected functionality.</p>
<p>The internal representation of a <code>vector</code> like type has a book-keeping node that consists of: - A pointer to the raw data (a block of memory that will hold elements of type <code>T</code>) - Size of the container(the number of elements in the container) - Capacity</p>
<p><img src="http://quantdev.blog/posts/implementing_vector/vector.png" class="img-fluid"></p>
<p>It’s important to distinguish between <code>size</code> and <code>capacity</code>. <code>size</code> is the number of elements currently in the container. When <code>size == capacity</code>, the container becomes full and will need to grow, which means allocating more member, copying the elements from the old storage to the new storage and getting rid of the old storage.</p>
<p>Given this background, we assume that the <code>vector</code> is equipped with basic getters such as:</p>
<ul>
<li><code>std::size_t size()</code></li>
<li><code>std::size_t capacity()</code></li>
<li><code>bool empty()</code></li>
<li><code>bool is_full()</code></li>
</ul>
<p>The <code>vector</code> should support various constructors.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> DefaultConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-3">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> InitializerListTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-7">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-8">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-9">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-10">    EXPECT_TRUE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-12">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-15"></span>
<span id="cb1-16">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ParameterizedConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-17">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-18">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-20">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-23"></span>
<span id="cb1-24">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CopyConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-25">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-26">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-27"></span>
<span id="cb1-28">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-29"></span>
<span id="cb1-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-32">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-33">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb1-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-35"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-36"></span>
<span id="cb1-37">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MoveConstructorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb1-38">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-39">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb1-40">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-41">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-42">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-43">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-44">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-45"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-46"></span>
<span id="cb1-47">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CopyAssignmentTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-48"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-49">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-50">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-51">    v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-52"></span>
<span id="cb1-53">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-54">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb1-55">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-56">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-57">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb1-58">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-59"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-60"></span>
<span id="cb1-61">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> MoveAssignmentTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb1-62"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-63">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-64">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-65">    v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-66"></span>
<span id="cb1-67">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-68">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-69">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-70">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-71">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb1-72">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-73"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The <code>vector</code> data-structure should support element access through the array subscript operator <code>[]</code>, just like C-style arrays. The <code>T&amp; at(std::size_t idx)</code> could also be used to access the element at index <code>idx</code> with bounds checking.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> AtTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-3">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-4">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-5">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-6">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-7"></span>
<span id="cb2-8">    EXPECT_THROW<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>out_of_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-10"></span>
<span id="cb2-11">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> SubscriptOperatorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb2-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-13">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-15">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>We expect the container to perform the book-keeping of size and capacity correctly.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> EmptyTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-3">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-5"></span>
<span id="cb3-6">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-7">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-9"></span>
<span id="cb3-10">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> SizeAndCapacityTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-12">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-13">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-14">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-15"></span>
<span id="cb3-16">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-17">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-18">    EXPECT_GT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-19"></span>
<span id="cb3-20">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb3-21">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-22">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>We expect the container to support the getter methods <code>front()</code> and <code>back()</code>.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FrontAndBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-3">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-4">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-5">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The container should support <code>reserve(size_t new_capacity)</code> and <code>resize(size_t new_size)</code>. These are explained at length further ahead.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ReserveTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-3">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-4">    v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-5">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-6">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-7"></span>
<span id="cb5-8">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> old_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb5-10">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-11">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> old_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-13">    v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-14">    EXPECT_GE<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-15">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-17">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-19"></span>
<span id="cb5-20">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ResizeTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-22">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb5-23">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-24"></span>
<span id="cb5-25">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-27">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-28"></span>
<span id="cb5-29">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-30">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-31"></span>
<span id="cb5-32">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-33">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-34">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-35">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-36"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The container should support appending elements or removal elements at the back.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PushBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-3">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-4">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-5">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-6">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-7"></span>
<span id="cb6-8">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-10">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-12"></span>
<span id="cb6-13">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PushBackSelfReferenceTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The design of push_back/insert is slightly hard to get right.</span></span>
<span id="cb6-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If the vector is full, then you reallocate(grow) the vector.</span></span>
<span id="cb6-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If the value to be added is a reference to an existing</span></span>
<span id="cb6-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// vector element, then value in vec.push_back(value) may become</span></span>
<span id="cb6-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a dangling reference, if it refers to the old storage (an element of the vector</span></span>
<span id="cb6-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// itself e.g. vec.back()). This test is meant for such an edge case.</span></span>
<span id="cb6-21">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-23">        vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb6-24">        EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-27"></span>
<span id="cb6-28">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> EmplaceBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-29"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Point</span>
<span id="cb6-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-32">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-33">        Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-34">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-35">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-37">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-39"></span>
<span id="cb6-40">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-41">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>emplace_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-42">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>emplace_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-43"></span>
<span id="cb6-44">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-45">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-46">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-47">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-48">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">].</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-49"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-50"></span>
<span id="cb6-51">TEST<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>VectorTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> PopBackTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb6-52"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-53">    dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-54">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-55">    v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>pop_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb6-56">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb6-57">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;({</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}));</span></span>
<span id="cb6-58"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The container should support a <code>.insert</code> method that allows us to insert elements from a source range to a specified position in the target vector. You can write a variety tests, like inserting at the beginning, middle, end of the vector, self-referential insertion etc. For brevity, I skip listing all of the tests here. The Compiler Explorer online source listing for this entire article is available in the conclusion section.</p>
</section>
<section id="vector-member-data" class="level2">
<h2 class="anchored" data-anchor-id="vector-member-data"><code>vector</code> member data</h2>
<p>We start with coding up the <code>vector</code> as a class template. It is templated by the type <code>T</code> of the elements stored in the container. We also define various type aliases.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> dev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-4">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-5">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-6">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb7-7">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb7-8">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb7-9">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_reference <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;;</span></span>
<span id="cb7-10">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> iterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-11">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> const_iterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> const_pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-12">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-13">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> growth_factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-14"></span>
<span id="cb7-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-16">        pointer <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-17">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-18">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>C++ containers usually expose iterators as part of their interface and ours will be no exception. We define type aliases for the <code>const</code> and non-<code>const</code> iterator types, as this makes it simpler to implement alternatives.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb8-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-5"></span>
<span id="cb8-6">    iterator begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-7">    const_iterator begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-8">    iterator end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-9">    const_iterator end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span></code></pre></div>
</section>
<section id="vector-constructors" class="level2">
<h2 class="anchored" data-anchor-id="vector-constructors"><code>vector</code> constructors</h2>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb9-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)},</span></span>
<span id="cb9-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>initial_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb9-5"></span>
<span id="cb9-6">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> initial_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))},</span></span>
<span id="cb9-8"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-9"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_fill_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> initial_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-14">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-18"></span>
<span id="cb9-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Constructs a vector with count default-inserted </span></span>
<span id="cb9-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// objects of T. No copies are made.</span></span>
<span id="cb9-21">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-23"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-24"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}{</span></span>
<span id="cb9-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-26">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_default_construct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-27">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-29">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-30">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-32"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-33"></span>
<span id="cb9-34">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>initializer_list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-35"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())},</span></span>
<span id="cb9-36"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()},</span></span>
<span id="cb9-37"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-40">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-41">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-42">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> list<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-43">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-44">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-45">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-46">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-47">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-48">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-49"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-50"></span>
<span id="cb9-51">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-52"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-53"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()},</span></span>
<span id="cb9-54"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()}</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-55">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-56">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform a deep-copy of all the Ts</span></span>
<span id="cb9-57">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-58">                                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-59">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-60">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-61">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>error_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb9-62">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Error while copying in copy ctor </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>what<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb9-63">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>logic_error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>error_msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-64">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-65"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-66"></span>
<span id="cb9-67">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span></span>
<span id="cb9-68"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)},</span></span>
<span id="cb9-69"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)},</span></span>
<span id="cb9-70"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exchange<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)}</span> </span>
<span id="cb9-71"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb9-72"></span>
<span id="cb9-73"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-74">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-75">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-76">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-77"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-78"></span>
<span id="cb9-79">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-80">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-81">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-82"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-83"></span>
<span id="cb9-84">vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=(</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-85">    vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)).</span>swap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-86">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-87"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="basic-services-of-a-vector-like-class" class="level2">
<h2 class="anchored" data-anchor-id="basic-services-of-a-vector-like-class">Basic services of a vector-like class</h2>
<section id="implementing-front-back-and-operatorsize_t-idx" class="level3">
<h3 class="anchored" data-anchor-id="implementing-front-back-and-operatorsize_t-idx">Implementing <code>front()</code>, <code>back()</code> and <code>operator[](size_t idx)</code></h3>
<p>There is more to writing a convenient dynamic array type. For example, member functions that let you access the elements at front or rear-end of the vector are to be expected. Similarly, an implementation of <code>operator[]</code> to access the element at a specific index in the array is also expected.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ...</span></span>
<span id="cb10-2">reference <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb10-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb10-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-5"></span>
<span id="cb10-6">const_reference <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb10-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// precondition: !empty()</span></span>
<span id="cb10-11">reference front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-12">const_reference front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-13">reference back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-14">const_reference back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Comparing two <code>vector&lt;T&gt;</code> objects for equivalence or lack thereof is a relatively easy matter if we use algorithms:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//...</span></span>
<span id="cb11-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> </span>
<span id="cb11-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>equal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb11-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="implementing-reserve" class="level3">
<h3 class="anchored" data-anchor-id="implementing-reserve">Implementing <code>reserve()</code></h3>
<p><code>reserve(size_type new_capacity)</code> increases the capacity of the vector(the total number of elements that the vector can hold without requiring reallocation) to a value that’s greater or equal to <code>new_capacity</code>. If <code>new_capacity</code> is greater than the current <code>capacity()</code>, new storage is allocated, otherwise the function does nothing.</p>
<p>We introduce the helper functions <code>allocate_helper</code> and <code>copy_old_storage_to_new</code>.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Dynamically allocates a chunk of uninitialized memory on the heap</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// that can hold `new_capacity` number of elements.</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocation excepts are propogated to the caller.</span></span>
<span id="cb12-4">pointer allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb12-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb12-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pointer ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb12-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copies elements from old storage to new</span></span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If T's copy/move ctor throws, the objects already constructed are</span></span>
<span id="cb12-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// destroyed and the exception is propagated to the caller.</span></span>
<span id="cb12-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pointer source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> pointer destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb12-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;){</span></span>
<span id="cb12-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-21">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>source_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> source_first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_elements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> destination_first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-22">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb12-23">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-27"></span>
<span id="cb12-28"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb12-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb12-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-31">    </span>
<span id="cb12-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-34">        copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-35">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb12-36">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb12-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-39">    </span>
<span id="cb12-40">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-41">    deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-42">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-43">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    </span>
<span id="cb12-44"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>If <code>new_capacity &gt; capacity()</code>, we must:</p>
<ul>
<li>Allocate a chunk <code>new_capacity * sizeof(T)</code> bytes large on the heap dynamically.</li>
<li>Copy the existing container elements from the old storage area to the new block of memory.</li>
<li>Destruct the elements in the old storage and deallocate the memory occupied.</li>
<li>Update the <code>vector</code>’s <code>m_data</code> pointer and <code>m_capacity</code> field.</li>
</ul>
<p>In general, we must separate allocation from construction. <code>operator new(size_t count)</code> and <code>operator new[](size_t count)</code>. <code>operator new(size_t count)</code> attempt to allocate <code>count</code> bytes on the heap. The newly allocated memory is <strong>uninitialized</strong>. This is different from the <code>new</code> expression, <code>new T(Args)</code> or <code>new T[]()</code> which performs both allocation and zero initialization (invokes the default constructor <code>T()</code>).</p>
<p>After the allocation, we want to copy the elements in the range <code>m_data[0...m_size-1]</code> to <code>ptr_new_blk</code>. <code>copy_old_storage_to_new</code> is a helper function to copy <code>num_elements</code> from the memory location <code>source_first</code> to <code>destination_first</code>.</p>
<p>C++17 introduced <code>std::uninitialized_copy</code> and <code>std::uninitialized_move</code> algorithms. <code>std::uninitialized_copy(first, last, d_first)</code> accepts a source range <code>[first,last)</code> and copies the elements from the source range to an uninitialized memory area beginning at <code>d_first</code>. The <code>std::uninitialized_move</code> algorithm uses move semantics.</p>
<p>The beauty of these uninitialized memory algorithms are that they are exception safe. If one of the <code>T(const T&amp;)</code> constructors invoked by <code>uninitialized_copy</code> ends up throwing, then the objects it managed to create before the exception was thrown will be destroyed in the reverse order of construction, before the exception leaves the function.</p>
<p>The type-trait <code>std::is_move_constructible_v&lt;T&gt;</code> is meta-function that returns <code>true</code>, if the argument <code>T</code> is move constructible.</p>
<p>There’s a general trick that you would have seen in all of this. Do not modify your object until you know, you can safely do. Try to do the potentially throwing operations first, then do the operations until you can mutate your object. You will sleep better, and the risks of object corruption will be alleviated.</p>
</section>
<section id="implementing-resize" class="level3">
<h3 class="anchored" data-anchor-id="implementing-resize">Implementing <code>resize()</code></h3>
<p>The distinction between <code>resize()</code> and <code>reserve()</code> is that <code>reserve()</code> only affects the capacity of the container, whereas <code>resize()</code> modifies the size and capacity both.</p>
<p>The <code>resize(size_type new_size)</code> method resizes the container to contain <code>count</code> elements:</p>
<ul>
<li>If the <code>new_size</code> is equal to the current size, do nothing.</li>
<li>If the current size is greater than the <code>new_size</code>, the container is reduced to its first <code>new_size</code> elements.</li>
<li>If the current size is less than <code>new_size</code>, then:
<ul>
<li>Additional default-constructed elements are appended.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb13-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> current_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-5"></span>
<span id="cb13-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reduce the container to count elements</span></span>
<span id="cb13-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb13-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-11"></span>
<span id="cb13-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> current_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-14">        reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb13-15"></span>
<span id="cb13-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Default construct elements at indicates</span></span>
<span id="cb13-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [current_size,...,new_size-1]</span></span>
<span id="cb13-18">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{});</span></span>
<span id="cb13-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-20">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>    </span></code></pre></div>
</section>
</section>
<section id="how-to-think-about-adding-elements-to-our-container" class="level2">
<h2 class="anchored" data-anchor-id="how-to-think-about-adding-elements-to-our-container">How to think about adding elements to our container?</h2>
<p>We will code up a <code>push_back(T&amp;&amp;)</code> member function that accepts a universal reference <code>T&amp;&amp;</code>. If <code>T</code> is move constructible, then the value will be moved. If <code>T</code> is copy constructible then the value will be copied.</p>
<p>The <code>emplace_back(Args...)</code> will take a variadic pack of constructor arguments, and then perfectly forward them to the constructor of a <code>T</code> object, that will be placed at the end of the container. A reference to the newly constructed object is returned by <code>emplace_back()</code>, for convenience, in case the user-code would like to use it right away.</p>
<p>We would like to first check whether the container is full. We have a dichotomy. If the container is full, we take the so-called slow path, else we take the fast lane.</p>
<section id="push_back_slow_pathvalue" class="level3">
<h3 class="anchored" data-anchor-id="push_back_slow_pathvalue"><code>push_back_slow_path(value)</code></h3>
<p>In this case, we would like to grow our container; we allocate more memory, than what the container currently holds. We leave the memory uninitialized. Memory allocation, can of course, fail.</p>
<p>We then add the new value at the index <code>m_size</code>. Appending the new element may fail.</p>
<p>We copy/move construct the existing elements of the container from the old storage to the new block of storage.</p>
<p>If all three steps were successful, we deallocate the old storage and return it back before replacing the values in the member variables <code>m_data</code>, <code>m_size</code> and <code>m_capacity</code>.</p>
<p>If either of the last couple of steps fail, we free the newly obtained block of storage.</p>
</section>
<section id="push_back_fast_pathvalue" class="level3">
<h3 class="anchored" data-anchor-id="push_back_fast_pathvalue"><code>push_back_fast_path(value)</code></h3>
<p>In this case, we simply copy/move construct <code>value</code> at the end of the container and update the size of the container.</p>
</section>
<section id="edge-case" class="level3">
<h3 class="anchored" data-anchor-id="edge-case">Edge-case</h3>
<p>Consider the following edge-case, where the <code>value</code> to be added is an element of the vector itself. If there is a reallocation, then the elements of the container are relocated to a new region. So, <code>value</code> might become a dangling reference.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1">dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-3">    vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb14-4">    EXPECT_EQ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Our design takes care of this edge case.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb15-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb15-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// allocate more memory</span></span>
<span id="cb15-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb15-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> growth_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb15-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-8"></span>
<span id="cb15-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy-construct the new value at the index m_size</span></span>
<span id="cb15-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb15-13">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow                </span></span>
<span id="cb15-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-16">    </span>
<span id="cb15-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy/move construct the existing elements </span></span>
<span id="cb15-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of the container from the old storage </span></span>
<span id="cb15-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the new block of storage.</span></span>
<span id="cb15-21">        copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb15-23">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-24">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb15-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-27"></span>
<span id="cb15-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// deallocate the old storage, if we are here</span></span>
<span id="cb15-29">    deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-30"></span>
<span id="cb15-31">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-32">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-33">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_capacity</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-34"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-35"></span>
<span id="cb15-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb15-37"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb15-38">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-39">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-40"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>        </span>
<span id="cb15-41"></span>
<span id="cb15-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb15-43"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb15-44"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb15-46">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-47">        push_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb15-48">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-50">        push_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb15-51">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-52"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="coding-up-emplace_back" class="level3">
<h3 class="anchored" data-anchor-id="coding-up-emplace_back">Coding up <code>emplace_back</code></h3>
<p>Again we have a fork - <code>emplace_back_slow_path</code> and <code>emplace_back_fast_path</code>.</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb16-2">reference emplace_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb16-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// allocate more memory</span></span>
<span id="cb16-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb16-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> new_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> growth_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb16-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-8"></span>
<span id="cb16-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// copy/move construct the existing elements </span></span>
<span id="cb16-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of the container from the old storage </span></span>
<span id="cb16-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the new block of storage.</span></span>
<span id="cb16-13">        copy_old_storage_to_new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>exception<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb16-15">        deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">throw</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// rethrow</span></span>
<span id="cb16-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-18"></span>
<span id="cb16-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_new_blk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb16-20">    deallocate_helper<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb16-21">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ptr_new_blk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb16-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-25"></span>
<span id="cb16-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb16-27">reference emplace_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb16-28">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>construct_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb16-29">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb16-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb16-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-32"></span>
<span id="cb16-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb16-34">reference emplace_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb16-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb16-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> emplace_back_slow_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb16-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb16-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> emplace_back_fast_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...);</span></span>
<span id="cb16-39"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
</section>
<section id="implementing-pop_back" class="level2">
<h2 class="anchored" data-anchor-id="implementing-pop_back">Implementing <code>pop_back()</code></h2>
<p><code>pop_back()</code> should call the destructor of the element at index <code>m_size - 1</code>. <code>std::destroy_at(T* p)</code> calls the destructor of the object pointed to by <code>p</code>. It is equivalent to <code>p-&gt;~T()</code>. We must not forget to decrement the size of the container.</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> pop_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb17-2">    T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr_to_last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_data</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>destroy_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptr_to_last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb17-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="implementing-insertconst_iterator-position-it-first-it-last" class="level2">
<h2 class="anchored" data-anchor-id="implementing-insertconst_iterator-position-it-first-it-last">Implementing <code>insert(const_iterator position, It first, It last)</code></h2>
<p>The <code>insert</code> function inserts the given value into the vector before the specified <code>position</code>, possibly using move-semantics. Note that, this kind of operation could be expensive for a vector, and if it is frequently used, it can trigger reallocation.</p>
<p>Our <code>insert</code> function will be generic enough with the following interface:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> It<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb18-2">iterator insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_iterator pos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> It first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> It last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<p>It inserts the range <code>[first,last)</code> at position <code>pos</code> (immediately prior to element currently at <code>pos</code>).</p>
<p>I spent some time thinking about <code>.insert</code>, and drawing some quick diagrams helped me generalize the algorithm.</p>
<p>Step 1. We first determine if the elements in the range <code>[first,last)</code> can fit into the <code>remaining_capacity = capacity() - size()</code>. If <code>n</code> exceeds the <code>remaining_capacity</code>, the <code>excess_capacity_reqd</code> we require is <code>std::max(n - remaining_capacity,0)</code>. So, we invoke <code>reserve(capacity() + excess_capacity_reqd)</code>.</p>
<p>Step 2. Assume that we have sufficient room for the range <code>[first,last)</code>.</p>
<p>How many elements should be copied from the <code>[begin(), end())</code> sequqence to the raw memory block at the end of the container?</p>
<p>Consider the scenario, where the range <code>[first,last)</code> is smaller than <code>[pos,end)</code>.</p>
<p><img src="http://quantdev.blog/posts/implementing_vector/Screenshot 2025-12-31 at 06.08.02.png" class="img-fluid"></p>
<p>In this scenario, the elements <code>[end()-n, end())</code> need to be copied or moved to the uninitialized memory.</p>
<p>If there are elements to copy or move from <code>[pos,end())</code> sequence as a replacement to existing objects in the container(there could be none), how many should be there? Looking at the figure below, the subsequence <code>[pos, end() - n)</code> will be mapped to <code>[pos + n, end())</code> upon insertion.</p>
<p><img src="http://quantdev.blog/posts/implementing_vector/Screenshot 2025-12-31 at 06.31.33.png" class="img-fluid"></p>
<p>Consider the scenario, where the range <code>[first,last)</code> is larger than <code>[pos,end)</code>.</p>
<p><img src="http://quantdev.blog/posts/implementing_vector/Screenshot 2025-12-31 at 06.38.57.png" class="img-fluid"></p>
<p>In this case, let’s define <code>num_tail</code> as the trailing number of elements from the source range <code>[first,last)</code> that would be copied/moved to uninitialized memory. Clearly, <code>num_tail = std::max(n - end() + pos,0)</code>. So, the tail <code>[last-num_tail,last)</code> will be mapped to <code>[end(),end()+num_tail)</code> upon insertion.</p>
<p>To make room for the insertion, the elements <code>[pos,end())</code> will have to be moved to <code>[end() + num_tail, end() + num_tail + end() - pos)</code>.</p>
<p>Here is a possible implementation based on our ideas above:</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> It<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb19-2">iterator insert<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>const_iterator pos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> It first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> It last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb19-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>iterator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>pos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-6"></span>
<span id="cb19-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-10">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-11">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> num_elems_to_shift <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-12">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> remaining_capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb19-13">        </span>
<span id="cb19-14">        dev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// handle self-referential insertion</span></span>
<span id="cb19-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span> </span>
<span id="cb19-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb19-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-19">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-20">                temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>it<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-21"></span>
<span id="cb19-22">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb19-23">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb19-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-25"></span>
<span id="cb19-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> remaining_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-28">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> excess_capacity_reqd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>max<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> remaining_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-29">            reserve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> excess_capacity_reqd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-30">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The iterator pos is invalidated. Update it.</span></span>
<span id="cb19-31">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> offset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-32">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-33"></span>
<span id="cb19-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// objects to displace (move or copy) from the </span></span>
<span id="cb19-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// [begin, end()] sequence into raw uninitialized</span></span>
<span id="cb19-36">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// memory </span></span>
<span id="cb19-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> num_elems_to_shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-38">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-39">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span></span>
<span id="cb19-40">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-41">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-42">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-43">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb19-44">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-45">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-46">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-47"></span>
<span id="cb19-48">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-49">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> num_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>max<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> num_elems_to_shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-50">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span></span>
<span id="cb19-51">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-52">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-53">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-54">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb19-55">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-56">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-57">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-58">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-59"></span>
<span id="cb19-60">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// objects to displace (copy or move) from [pos,end()]</span></span>
<span id="cb19-61">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the end of the container</span></span>
<span id="cb19-62">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> num_elems_to_shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-63">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-64">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span></span>
<span id="cb19-65">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-66">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move_backward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-67">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-68">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb19-69">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-70">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>copy_backward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-71">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-72">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-73"></span>
<span id="cb19-74">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// objects from [first,last) to insert into raw</span></span>
<span id="cb19-75">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// uninitialized memory</span></span>
<span id="cb19-76">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_type</span> num_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>max<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> num_elems_to_shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-77">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> num_elems_to_shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-78">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-79">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_nothrow_move_constructible_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;)</span></span>
<span id="cb19-80">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-81">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> num_tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-82">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-83">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span></span>
<span id="cb19-84">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-85">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>uninitialized_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> num_tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">());</span></span>
<span id="cb19-86">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-87">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-88">        </span>
<span id="cb19-89">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// objects to copy from [first,last) to pos</span></span>
<span id="cb19-90">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> num_elems_to_shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb19-91">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-92">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">last_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-93">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-94">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-95">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">first_</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> num_tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb19-96">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-97"></span>
<span id="cb19-98">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-99">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-100">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pos_</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-101"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Implementing a custom <code>vector&lt;T&gt;</code> from scratch is a rewarding exercise that deepens understanding of C++ fundamentals.</p>
<p>The standard library implementation handles additional complexities I haven’t addressed: custom allocator support, small object optimizations, and numerous other edge cases discovered through decades of production use.</p>
<p>However, the journey of building this container teaches invaluable lessons. You learn to think carefully about exception safety, understand the tradeoffs between copy and move operations, appreciate the elegance of algorithms like <code>std::uninitialized_copy</code>, and recognize why seemingly simple operations like <code>insert()</code> require careful reasoning about memory layout and iterator invalidation.</p>
<p>If you enjoyed this deep dive, I recommend exploring <code>deque</code>, <code>std::inplace_vector</code>, or the more complex associative containers. Each presents unique challenges and design decisions that will further sharpen your C++ skills.</p>
<p>You can find the complete source listing and unit tests online at <a href="https://compiler-explorer.com/z/Tvbs5Wc73">https://compiler-explorer.com/z/Tvbs5Wc73</a>.</p>
<p><img src="http://quantdev.blog/posts/implementing_vector/qr_code.png" width="200" height="200"></p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li>The deepest code review of the simplest data structure, <code>vector</code> <a href="https://www.youtube.com/watch?v=GfIxO_vpM4g">https://www.youtube.com/watch?v=GfIxO_vpM4g</a></li>
<li>libstdc++ <code>vector</code> test suite, <a href="https://gnu.googlesource.com/gcc/+/trunk/libstdc++-v3/testsuite/23_containers/vector">https://gnu.googlesource.com/gcc/+/trunk/libstdc++-v3/testsuite/23_containers/vector</a></li>
<li>STL <code>std::vector</code>, Modern Cpp Series Episode 116, <a href="https://www.youtube.com/watch?v=iM_rIWmq6cE">https://www.youtube.com/watch?v=iM_rIWmq6cE</a></li>
</ul>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/implementing_vector/index.html</guid>
  <pubDate>Mon, 15 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/implementing_vector/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Lambda Functions</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/lambda_functions/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I’ve got my hands on the <a href="https://leanpub.com/cpplambda">C++ lambda story</a> by <a href="https://leanpub.com/u/fenbf">Bartłomiej Filipek</a> and wanted to try out a few of the examples.</p>
</section>
<section id="lambdas-in-c11" class="level1">
<h1>Lambdas in C++11</h1>
<p>An example of the most minimal lambda expression is:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 1. the simplest lambda</span></span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]{};</span></span></code></pre></div>
<p><code>[]</code> section is called the lambda introducer and the empty <code>{}</code> part is for the function body.</p>
<p>By capturing a variable, you create a member copy of that variable in the closure type. Then, inside the lambda body, you can access it.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// with a parameter</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> area <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> radius<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> *</span> radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> radius<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The arguments are passed into a lambda function like any regular function. The return type is not needed as the compiler will automatically deduce it.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">uz</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-5">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb3-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In the above example, we explicitly set a return type. The trailing return type is also available for regular function declaration since C++11.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-7">    rrtutn param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Before the body of the lambda, you can use other specifiers. In the code, we used <code>mutable</code> (so that we can change the captured variable) and also <code>noexcept</code>. The third lambda uses <code>mutable</code> and <code>noexcept</code> and they have to appear in that order (you cannot write <code>noexcept mutable</code> as the compiler will reject it).</p>
<p>While the <code>()</code> part is optional, if you want to apply <code>mutable</code> or <code>noexcept</code> then <code>()</code> needs to be in the expression.</p>
<section id="core-definitions" class="level2">
<h2 class="anchored" data-anchor-id="core-definitions">Core Definitions</h2>
<p>The core definition from the C++ standard from <a href="https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#2">expr.prim.lambda#2</a> says:</p>
<blockquote class="blockquote">
<p>The evaluation of a lambda-expression results in a <em>prvalue</em> temporary. This temporary is called the <em>closure object</em>.</p>
</blockquote>
<p>From the above definition, we can understand that the compiler generates a unique wrapper class (closure type) from a lambda expression.</p>
<p>Consider the following code snip:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cmath&gt;</span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> cum_normal_cdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb5-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>erf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(-</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)))</span></span>
<span id="cb5-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://cppinsights.io/s/4f8ddfcc">CppInsights</a> reveals that the C++ compiler creates the following class, where the function call operator <code>()</code> is overloaded.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1">class __lambda_4_23</span>
<span id="cb6-2">{</span>
<span id="cb6-3">  public: </span>
<span id="cb6-4">  inline /*constexpr */ double operator()(double x) const</span>
<span id="cb6-5">  {</span>
<span id="cb6-6">    return 0.5 * (1.0 - erf(-x / sqrt(2.0)));</span>
<span id="cb6-7">  }  </span>
<span id="cb6-8"></span>
<span id="cb6-9">  /* ... */</span>
<span id="cb6-10">};</span>
<span id="cb6-11"></span>
<span id="cb6-12">__lambda_4_23 cum_normal_cdf = __lambda_4_23{};</span></code></pre></div>
</section>
<section id="constructors-and-copying" class="level2">
<h2 class="anchored" data-anchor-id="constructors-and-copying">Constructors and copying</h2>
<p>In the specification of the feature at <a href="https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#19">expr.prim.lambda</a>, we can also read the following:</p>
<blockquote class="blockquote">
<p>The closure-type associated with a lambda expression has a deleted default constructor and a deleted copy assignment operator.</p>
</blockquote>
<p>That’s why you cannot write:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb7-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> fooCopy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/7q9bbhro1">Compiler Explorer</a></p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1">&lt;source&gt;: In function 'int main()':</span>
<span id="cb8-2">&lt;source&gt;:9:19: error: use of deleted function 'main()::&lt;lambda()&gt;::&lt;lambda&gt;()'</span>
<span id="cb8-3">    9 |     decltype(foo) fooCopy;</span>
<span id="cb8-4">      |                   ^~~~~~~</span>
<span id="cb8-5">&lt;source&gt;:5:23: note: a lambda closure type has a deleted default constructor</span>
<span id="cb8-6">    5 |     auto foo = [&amp;x, &amp;y] {</span>
<span id="cb8-7">      |                       ^</span>
<span id="cb8-8">&lt;source&gt;:9:19: note: use '-fdiagnostics-all-candidates' to display considered candidates</span>
<span id="cb8-9">    9 |     decltype(foo) fooCopy;</span>
<span id="cb8-10">      |  </span></code></pre></div>
<p>However, we can copy lambdas:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cmath&gt;</span></span>
<span id="cb9-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb9-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;type_traits&gt;</span></span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;;</span></span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span>Point x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Point y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>first<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-10">                    pow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>second <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>second<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb9-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-12"></span>
<span id="cb9-13">    Point p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-14">    Point origin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb9-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distance to (3,4) from the origin = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> origin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb9-16"></span>
<span id="cb9-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> distance_copy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_same_v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>distance_copy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;);</span></span>
<span id="cb9-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/nf7MWaY4z">Compiler Explorer</a></p>
</section>
<section id="captures" class="level2">
<h2 class="anchored" data-anchor-id="captures">Captures</h2>
<p>The <code>[]</code> does not only introduce the lambda but also holds the list of <em>captured variables</em>. It’s called the <em>capture clause</em>. By capturing a variable from outside the scope of the lambda, you create a non-static data member in the closure type. Then, inside the lambda body, you can access it.</p>
<p>The syntax for captures in C++11 are:</p>
<div id="tbl-lambda-syntax" class="anchored">
<table class="table">
<caption>Table&nbsp;1: Lambda capture syntax in C++</caption>
<colgroup>
<col style="width: 38%">
<col style="width: 61%">
</colgroup>
<thead>
<tr class="header">
<th>Syntax</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>[&amp;]</code></td>
<td>Capture by reference all automatic storage duration variables declared in the reaching scope.</td>
</tr>
<tr class="even">
<td><code>[=]</code></td>
<td>Capture by value (create a copy) all automatic storage duration variables declared in the reaching scope.</td>
</tr>
<tr class="odd">
<td><code>[x, &amp;y]</code></td>
<td>Capture <code>x</code> by value, capture <code>y</code> by reference</td>
</tr>
<tr class="even">
<td><code>[args...]</code></td>
<td>Capture a template argument pack all by value</td>
</tr>
<tr class="odd">
<td><code>[&amp;args...]</code></td>
<td>Capture a template argument pack all by reference</td>
</tr>
<tr class="even">
<td><code>[this]</code></td>
<td>Captures the <code>this</code> pointer inside the member function</td>
</tr>
</tbody>
</table>
</div>
<p>Note that for <code>[=]</code> and <code>[&amp;]</code> cases, the compiler generates data members for all used variables inside the lambda body. This is a convenient syntax where you don’t want to explicitly mention which variables you capture.</p>
<section id="the-mutable-keyword" class="level3">
<h3 class="anchored" data-anchor-id="the-mutable-keyword">The <code>mutable</code> keyword</h3>
<p>By default the <code>operator()</code> of the closure type is marked as <code>const</code> and you cannot modify the captured variables inside the body of the lambda. If you want to change this behavior, you need to add the <code>mutable</code> keyword after the parameter list. This syntax removes the <code>const</code> from the call operator declaration in the closure type.</p>
<p>If you have a simple lambda expression with a <code>mutable</code>:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>It will be expanded into the following function object:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1">struct __lambda_x1 {</span>
<span id="cb11-2">    void operator()() { ++x; }</span>
<span id="cb11-3">    int x;</span>
<span id="cb11-4">};</span></code></pre></div>
<p>The call operator can change the value of the member-fields(capture variables).</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> print <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">": "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-7"></span>
<span id="cb12-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-9">    print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in main"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-11">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-12">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-13">        print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in foo"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb12-15">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb12-16">    print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in main()"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/9Tncca1do">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1">in main: 1 1</span>
<span id="cb13-2">in foo: 2 2</span>
<span id="cb13-3">in main(): 1 1</span></code></pre></div>
<p>In the above example, we can change the values of <code>x</code> and <code>y</code>. Since those are only the copies of <code>x</code> and <code>y</code> from the enclosing scope, we don’t see their new values after <code>foo</code> is invoked.</p>
<p>On the other hand, if you capture by reference, you don’t need to apply the <code>mutable</code> keyword to modify the value. This is because the captured data members are references which means that you cannot rebound them to a new object anyway, but you can change the referenced values.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb14-7">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb14-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Yjjqdd3zf">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb15-1">Program stdout</span>
<span id="cb15-2">1</span>
<span id="cb15-3">2</span></code></pre></div>
<p>In the above example, the lambda is not specified with <code>mutable</code> but it can change the referenced value.</p>
<p>One important thing is that when you apply <code>mutable</code>, then you canot mark your resulting closure object with <code>const</code> as it prevents you from invoking the lambda!</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// lam(); // compile eror</span></span></code></pre></div>
<p>The last line won’t compile as we cannot call a non-<code>const</code> member function on a <code>const</code> object.</p>
</section>
<section id="capturing-global-variables" class="level3">
<h3 class="anchored" data-anchor-id="capturing-global-variables">Capturing Global Variables</h3>
<p>If you have a global variable and you use <code>[=]</code> in your lambda, you might think that your global object is also captured by value. But, it’s not.</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb17-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[=]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-8">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb17-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> increaseGlobal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-11">    increaseGlobal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb17-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> moreIncreaseGlobal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-14">    moreIncreaseGlobal<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb17-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> global <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/aTG3qP5vM">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb18-1">10</span>
<span id="cb18-2">11</span>
<span id="cb18-3">12</span>
<span id="cb18-4">13</span></code></pre></div>
<p>In the above example, we have defined a static variable <code>global</code> and then used it with several lambdas defined in the <code>main()</code> function. If you run the code, then no matter the way you captgure, it will always point to the global object, and no local copies will be created.</p>
<p>Line 13 of the code causes the compiler to generate the following warning:</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb19-1">source&gt;: In function 'int main()':</span>
<span id="cb19-2">&lt;source&gt;:13:38: warning: capture of variable 'global' with non-automatic storage duration</span>
<span id="cb19-3">   13 |     const auto moreIncreaseGlobal = [global]() noexcept { ++global; };</span></code></pre></div>
<p>It’s because only variables with automatic storage duration can be captured.</p>
<p>If you use <code>[=]</code> explicitly, the compiler won’t help you and it generates an error.</p>
</section>
<section id="capturing-static-variables" class="level3">
<h3 class="anchored" data-anchor-id="capturing-static-variables">Capturing <code>static</code> variables</h3>
<p>Similar to capturing global variables, you’ll get the same issues with <code>static</code> objects:</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb20-2"></span>
<span id="cb20-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[=]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-7">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> increase <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-10">    increase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> moreIncrease <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>static_int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-13">    moreIncrease<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> static_int <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-16"></span>
<span id="cb20-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-18">    bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb20-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/xbGbh3hTW">Compiler Explorer</a></p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb21-1">10</span>
<span id="cb21-2">11</span>
<span id="cb21-3">12</span>
<span id="cb21-4">13</span></code></pre></div>
</section>
<section id="caturing-a-class-member-and-the-this-pointer" class="level3">
<h3 class="anchored" data-anchor-id="caturing-a-class-member-and-the-this-pointer">Caturing a class member and the <code>this</code> pointer</h3>
<p>Things get a bit more complicated where you’re in a class member function and you want to capture a data member. Since all non-static data members are related to the <code>this</code> pointer, it also has to be stored somewhere.</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb22-2"></span>
<span id="cb22-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb22-5">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb22-6">        lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb22-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb22-8"></span>
<span id="cb22-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb22-11"></span>
<span id="cb22-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb22-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb22-14">    Baz b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-15">    b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb22-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/x3b3GEnox">Compiler Explorer</a></p>
<p>The code tries to capture <code>s</code> which is a data-member. But the compiler will emit the following message:</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb23-1">&lt;source&gt;: In member function 'void Baz::foo()':</span>
<span id="cb23-2">&lt;source&gt;:5:27: error: capture of non-variable 'Baz::s'</span>
<span id="cb23-3">    5 |         const auto lam = [s]() { std::cout &lt;&lt; s; };</span>
<span id="cb23-4">      |                           ^</span>
<span id="cb23-5">&lt;source&gt;:9:17: note: 'std::string Baz::s' declared here</span>
<span id="cb23-6">    9 |     std::string s;</span>
<span id="cb23-7">      |                 ^</span>
<span id="cb23-8">&lt;source&gt;: In lambda function:</span>
<span id="cb23-9">&lt;source&gt;:5:47: error: 'this' was not captured for this lambda function</span>
<span id="cb23-10">    5 |         const auto lam = [s]() { std::cout &lt;&lt; s; };</span></code></pre></div>
<p>To solve this issue, we have to capture the <code>this</code> pointer. Then, we have access to the data members. We can updaten the code to:</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb24-2"></span>
<span id="cb24-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb24-5">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb24-6">        lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-8"></span>
<span id="cb24-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb24-11"></span>
<span id="cb24-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb24-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-14">    Baz b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-15">    b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/jxfEEaT1b">Compiler Explorer</a></p>
<p>There are no compiler errors now.</p>
<p>We can also use <code>[=]</code> or <code>[&amp;]</code> to capture <code>this</code>. They both have the same effect in C++11/14. Note that, we captured <code>this</code> by value to a pointer. That’s why we have access to the initial data-member and not its copy.</p>
<p>The value of the value-captured variable is the value at the time the lambda is defined - not when it is used. The value of a ref-captured variable is the value when the lambda is used - not when it is defined.</p>
<p>The C++ closures do not extend the lifetimes of the captured references. We must be sure that the capture variable still lives when the lambda is invoked.</p>
</section>
<section id="moveable-only-objects" class="level3">
<h3 class="anchored" data-anchor-id="moveable-only-objects">Moveable-only objects</h3>
<p>If you have an object that is moveable only(for example a <code>unique_ptr</code>), then we can move the object into a member of the closure type:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb25-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;memory&gt;</span></span>
<span id="cb25-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;utility&gt;</span></span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>unique_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Before definition pointer in main(): "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> bar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>move<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer in lambda: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value in lambda: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-12"></span>
<span id="cb25-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"After definition pointer in main(): "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-14">    bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb25-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Te795K88b">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb26-1">Before definition pointer in main(): 0x209772b0</span>
<span id="cb26-2">After definition pointer in main(): 0</span>
<span id="cb26-3">pointer in lambda: 0x209772b0</span>
<span id="cb26-4">value in lambda: 10</span></code></pre></div>
</section>
<section id="preserving-const" class="level3">
<h3 class="anchored" data-anchor-id="preserving-const">Preserving <code>const</code></h3>
<p>If you capture a <code>const</code> variable, then the <code>const</code>-ness is preserved:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb27-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;type_traits&gt;</span></span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb27-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb27-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mutable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb27-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>is_const<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;::</span>value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-8">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb27-10"></span>
<span id="cb27-11">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb27-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/GEGnYh81K">Compiler Explorer</a></p>
<p>This code will not compile.</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb28-1">&lt;source&gt;: In lambda function:</span>
<span id="cb28-2">&lt;source&gt;:9:15: error: assignment of read-only variable 'x'</span>
<span id="cb28-3">    9 |             x = 11;</span>
<span id="cb28-4">      |             ~~^~~~</span>
<span id="cb28-5">&lt;source&gt;: In function 'int main()':</span>
<span id="cb28-6">&lt;source&gt;:12:5: error: expected ',' or ';' before 'foo'</span>
<span id="cb28-7">   12 |     foo();</span>
<span id="cb28-8">      |     ^~~</span></code></pre></div>
</section>
<section id="capturing-a-parameter-pack" class="level3">
<h3 class="anchored" data-anchor-id="capturing-a-parameter-pack">Capturing a parameter pack</h3>
<p>We can also leverage captures with variadic templates. The compiler expands the pack into a list of non-static data members whihc might be handy, if you want to use lambda in templated code.</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb29-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;tuple&gt;</span></span>
<span id="cb29-3"></span>
<span id="cb29-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb29-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> captureTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-7">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> tup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>make_tuple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb29-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tuple size: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>tuple_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;::</span>value</span>
<span id="cb29-9">                  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tuple 1st: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>get<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>tup<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb29-12">    lambda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb29-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb29-14"></span>
<span id="cb29-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-16">    captureTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb29-17">    captureTest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello World"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb29-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/eGYEPxo8M">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb30-1">tuple size: 4</span>
<span id="cb30-2">tuple 1st: 1</span>
<span id="cb30-3">tuple size: 2</span>
<span id="cb30-4">tuple 1st: Hello World</span></code></pre></div>
</section>
</section>
<section id="return-type" class="level2">
<h2 class="anchored" data-anchor-id="return-type">Return Type</h2>
<p>In most cases, you can skip the return type of the lambda and the compiler will deduce the typename for you. The compiler is able to deduce the return type as long as all of your return statements are of the same type.</p>
</section>
<section id="iife---immediately-invoked-functional-expression" class="level2">
<h2 class="anchored" data-anchor-id="iife---immediately-invoked-functional-expression">IIFE - Immediately Invoked Functional Expression</h2>
<p>In most of the examples, we’ve seen so far, notice that we defined ht lambda and then immediately called it later. However, you can also invoke a lambda immediately.</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb31-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb31-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;]()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">noexcept</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}();</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// call</span></span>
<span id="cb31-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
</section>
<section id="lambdas-in-c14" class="level1">
<h1>Lambdas in C++14</h1>
<section id="default-parameters-for-lambda-functions" class="level2">
<h2 class="anchored" data-anchor-id="default-parameters-for-lambda-functions">Default parameters for lambda functions</h2>
<p>Let’s start with smaller updates. In C++14, you can use default parameters in a lambda function definition.</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb32-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb32-2"></span>
<span id="cb32-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb32-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb32-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> lam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb32-6">    lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb32-7">    lam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb32-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/W7ne1jKh5">Compiler Explorer</a></p>
</section>
<section id="captures-with-an-initialiser" class="level2">
<h2 class="anchored" data-anchor-id="captures-with-an-initialiser">Captures with an initialiser</h2>
<p>We recall that, in a lambda expression, we can capture variables form the outside scope. The compiler expands that capture syntax and creates corresponding non-static data members in the closure type.</p>
<p>In C++14, you can create new data-members and initialize them in the capture clause. Then, you can access those variables inside the lambda. It’s called <em>capture with an initialiser</em> or another name for this feature is <em>generalized lambda capture</em>.</p>
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb33-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb33-2"></span>
<span id="cb33-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb33-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb33-7">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-8">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb33-9">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb33-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/9czGEbY4v">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb34-1">42</span></code></pre></div>
<p>Keep in mind, that the new variable is initialized at the place where you define the lambda and not where you invoke it.</p>
<p>Creating variables through an initialiser is also flexible, since you can, for example, create references to variables from outside scope.</p>
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb35-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb35-2"></span>
<span id="cb35-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb35-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb35-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb35-6">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb35-7">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb35-8">    foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb35-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Output:</p>
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb36-1">30</span>
<span id="cb36-2">0</span></code></pre></div>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations</h3>
<p>Note, that while you can capture by reference with an initialiser, it’s not possible to write <em>rvalue</em> reference <code>&amp;&amp;</code>. So, the below code would be invalid.</p>
<div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb37-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;&amp;</span>z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//invalid syntax!</span></span></code></pre></div>
</section>
<section id="one-gotcha-with-stdfunction" class="level3">
<h3 class="anchored" data-anchor-id="one-gotcha-with-stdfunction">One gotcha with <code>std::function</code></h3>
<p>Having a moveable-only captured variable in a lambda makes the closure object not copyable. This might be an issue if you want to store such a lambda in <code>std::function</code> which accepts only copyable copy objects.</p>
</section>
</section>
<section id="optimisation" class="level2">
<h2 class="anchored" data-anchor-id="optimisation">Optimisation</h2>
<p>Another idea is to use capture initialisers as a potential optimisation technique. Rather than computing some value every time, we invoke a lambda, we can compute it once in. the initialiser:</p>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb38-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb38-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb38-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb38-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;vector&gt;</span></span>
<span id="cb38-5"></span>
<span id="cb38-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb38-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb38-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">namespace</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string_literals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>vector<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> vs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb38-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"apple"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb38-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foobar"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lemon"</span></span>
<span id="cb38-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb38-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo"</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">s</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-14"></span>
<span id="cb38-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>find_if<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb38-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[&amp;</span>prefix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb38-17">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bar"</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">s</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb38-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb38-20"></span>
<span id="cb38-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb38-22">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-something found!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-23"></span>
<span id="cb38-24">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> std<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>find_if<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span></span>
<span id="cb38-25">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>savedString <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bar"</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">s</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb38-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> savedString<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-27">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb38-28">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb38-29"></span>
<span id="cb38-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">())</span></span>
<span id="cb38-31">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> prefix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-something found!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-32"></span>
<span id="cb38-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb38-34"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The code above shows two calls to <code>std::find_if</code>. In the first scernario, we capture <code>prefix</code> and compare the input value against <code>prefix + "bar"s</code>. Everytime the lambda is invokes, a temporary value that stores the sum of those strings has to be created and computed.</p>
<p>The second call to <code>find_if</code> shows an optimisation: we create a captured variable <code>savedString</code> that computes the sum of the strings. then, we can safely refer to it in the lambda body. The sum of the strings will run only once and not with every invocation of the lambda.</p>
</section>
<section id="capturing-a-class-data-member" class="level2">
<h2 class="anchored" data-anchor-id="capturing-a-class-data-member">Capturing a class data member</h2>
<p>An initialiser can also be used to capture data members without worrying about <code>*this</code> pointer. We can capgture a copy of a data member and not bother with dangling references.</p>
<div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb39-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb39-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb39-3"></span>
<span id="cb39-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb39-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb39-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb39-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb39-8"></span>
<span id="cb39-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb39-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb39-11"></span>
<span id="cb39-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb39-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb39-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"abc"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> f2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Baz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xyz"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}.</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-16">    f1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-17">    f2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb39-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/TY98T8nxM">Compiler Explorer</a></p>
</section>
<section id="generic-lambdas" class="level2">
<h2 class="anchored" data-anchor-id="generic-lambdas">Generic Lambdas</h2>
<p>The early specification of lambda expressions allowed us to create anonymous function objects (closure types) and pass them to various generic algorithms from the standard library. However, closures were not generic on their own. For example, you couldn’t specify a template parameter as a lambda parameter.</p>
<p>Fortunately, since C++14, the Standard introduced <em>generic lambdas</em> and now we can write:</p>
<div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb40-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb40-2">foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb40-3">foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.1234</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb40-4">foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello world"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>Please notice <code>auto x</code> as a parameter to the lambda. This is equivalent to using a template declaration in the call operator of the closure type:</p>
<div class="sourceCode" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb41-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb41-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb41-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span>Tx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb41-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb41-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb41-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> someInstance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>If there are more <code>auto</code> arguments, then the code expands to separate template parameters:</p>
<div class="sourceCode" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb42-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> fooDouble <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>expands into:</p>
<div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb43-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb43-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> typenname U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb43-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()(</span>Tx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> U y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb43-4">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb43-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb43-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> someInstance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</section>
<section id="variadic-generic-arguments" class="level2">
<h2 class="anchored" data-anchor-id="variadic-generic-arguments">Variadic Generic Arguments</h2>
<p>If we need more function parameters, then we can also go <em>variadic</em>.</p>
<div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb44-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb44-2"></span>
<span id="cb44-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb44-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb44-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb44-7"></span>
<span id="cb44-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb44-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T1 s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb44-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb44-12"></span>
<span id="cb44-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> sumLambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb44-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sum of: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" numbers</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb44-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...);</span></span>
<span id="cb44-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb44-18"></span>
<span id="cb44-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> sumLambda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb44-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/z34cTcabh">Compiler Explorer</a></p>
</section>
<section id="perfect-forwarding-with-generic-lambdas" class="level2">
<h2 class="anchored" data-anchor-id="perfect-forwarding-with-generic-lambdas">Perfect forwarding with generic lambdas</h2>
<p>With generic lambdas, we’re not restricted to using <code>auto x</code>, we can add any qualifiers as with other <code>auto</code> variables such as <code>auto&amp;</code>, <code>const auto&amp;</code> or <code>auto&amp;&amp;</code>. One of the handy use cases is that we can specify <code>auto&amp;&amp; x</code> which becomes a forwarding(universal) reference.</p>
<div class="sourceCode" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb45-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb45-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb45-3"></span>
<span id="cb45-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo(const string&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb45-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;)</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo(std::string&amp;&amp;)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> </span>
<span id="cb45-6"></span>
<span id="cb45-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb45-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb45-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> callFoo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb45-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Calling foo() on: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb45-11">        foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">decltype</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;(</span>str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb45-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb45-13"></span>
<span id="cb45-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello World"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb45-15">    callFoo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb45-16">    callFoo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Helo World Ref Ref"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb45-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/rdEsPK8va">Compiler Explorer</a></p>
<p>Output:</p>
<div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb46-1">Calling foo() on: Hello World</span>
<span id="cb46-2">foo(const string&amp;)</span>
<span id="cb46-3">Calling foo() on: Helo World Ref Ref</span>
<span id="cb46-4">foo(std::string&amp;&amp;)</span></code></pre></div>
</section>
</section>
<section id="lambdas-in-c17" class="level1">
<h1>Lambdas in C++17</h1>
<p>C++17 brought one major enhancement to lambdas: they can be declared <code>constexpr</code>:</p>
<div class="sourceCode" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb47-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> square <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb47-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>square<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
<p>How about some more practical examples? It’s fun to write a simple compile-time hash function for strings.</p>
<div class="sourceCode" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb48-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;algorithm&gt;</span></span>
<span id="cb48-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;numeric&gt;</span></span>
<span id="cb48-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string_view&gt;</span></span>
<span id="cb48-4"></span>
<span id="cb48-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> hornerHash <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string_view<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb48-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> hash_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>accumulate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb48-7">        s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>begin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ull</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb48-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>accum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb48-9">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb48-10"></span>
<span id="cb48-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> hash_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb48-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb48-13"></span>
<span id="cb48-14"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb48-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> hashCode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hornerHash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello world"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb48-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb48-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/7hh15dbbo">Compiler Explorer</a></p>
<p>You can also capture <code>constexpr</code> variables in lambdas.</p>
<section id="overloaded-pattern" class="level2">
<h2 class="anchored" data-anchor-id="overloaded-pattern">Overloaded pattern</h2>
<p>It might be surprising to see, but you can derive from a lambda! Since the compiler expands a lambda expression into a function object with <code>operator()</code>, we can inherit from this type.</p>
<div class="sourceCode" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb49-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb49-2"></span>
<span id="cb49-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb49-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> ComplexFn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb49-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">explicit</span> ComplexFn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Callable f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){}</span></span>
<span id="cb49-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb49-7"></span>
<span id="cb49-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb49-9">ComplexFn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> MakeComplexFunctionObject<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb49-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> ComplexFn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>callable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb49-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb49-12"></span>
<span id="cb49-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb49-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb49-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MakeComplexFunctionObject<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb49-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]{</span></span>
<span id="cb49-17">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello, complex function object!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb49-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb49-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb49-20">    func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> </span>
<span id="cb49-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In the example, there’s the <code>ComplexFn</code> class which derives from <code>Callable</code> which is a template parameter. If we want to derive from a lambda, we need to do a little trick, as we cannot spell out the exact type of the closure type(unless we wrap it into a <code>std::function</code>). That’s why, we need the <code>MakeComplexFnObject</code> function that can perform template argument deduction and get the type of the lambda closure.</p>
<p>The <code>ComplexFn</code> apart from it’s name is just a simple wrapper without much of a use. Are there any use-cases for such code patterns?</p>
<p>We can extend the code above and inherit from two lambdas and create an overloaded set:</p>
<div class="sourceCode" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb50-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb50-2"></span>
<span id="cb50-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb50-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> SimpleOverloaded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb50-5">   <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb50-6">    SimpleOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>TCall tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb50-7"></span>
<span id="cb50-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb50-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb50-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb50-11"></span>
<span id="cb50-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb50-13">SimpleOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> MakeOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb50-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> SimpleOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>TCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>tf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb50-15">                                          <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>UCall<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>uf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb50-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb50-17"></span>
<span id="cb50-18"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb50-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MakeOverloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">([](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Int!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb50-20">                                     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Float!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">});</span></span>
<span id="cb50-21"></span>
<span id="cb50-22">    func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb50-23">    func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb50-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/81hM5cGbr">Compiler Explorer</a></p>
<p>This time we have more code and we derive from two template parameters, but we also need to expose their call operators explicitly. It’s because when looking for the correct function overload, the compiler requires the candidates to be in the same scope.</p>
<p>Now, how about using a variable number of base classes, which means a variable number of lambdas?</p>
</section>
<section id="deriving-from-multiple-lambdas" class="level2">
<h2 class="anchored" data-anchor-id="deriving-from-multiple-lambdas">Deriving from multiple lambdas</h2>
<p>In C++17, we have a handy pattern for this:</p>
<div class="sourceCode" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb51-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb51-2"></span>
<span id="cb51-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb51-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> overloaded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb51-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">operator</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()...;</span></span>
<span id="cb51-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb51-7"></span>
<span id="cb51-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb51-9">overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;;</span></span>
<span id="cb51-10"></span>
<span id="cb51-11"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb51-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb51-13">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb51-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb51-15">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[](</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>println<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb51-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb51-17"></span>
<span id="cb51-18">    test<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10.0f"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb51-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/5sf3We9zY">Compiler Explorer</a></p>
<p>Let’s deep-dive into the basic mechanics of this pattern. It benefits from three features:</p>
<ul>
<li>Pack expansions in <code>using</code> declarations.</li>
<li>Custom template argument deduction rules - that allows converting a list of lambda objects into a list of base classes for the <code>overloaded</code> class. (not needed in C++20!)</li>
<li>Extension to aggregate initialisation - before C++17, you couldn’t aggregate initialise type that derives from other types.</li>
</ul>
<p>The <code>using</code> declaration is important for bringing the function call operator - <code>operator()</code> into the same scope of the <code>overloaded</code> structure. In C++17, we got a syntax that supports variadic templates, which was not possible in the previous revisions of the language.</p>
<p>Let’s try and understand the remaining features:</p>
<section id="custom-template-argument-deduction-rules" class="level3">
<h3 class="anchored" data-anchor-id="custom-template-argument-deduction-rules">Custom Template Argument Deduction Rules</h3>
<p>We derive from lambdas, and then we expose their <code>operator()</code> as we saw in the previous section. But, how can we create objects of this <code>overload</code> type?</p>
<p>As you know, there’s no way to know up-front, the type of the lambda, as compiler has to generate some unique typename for each of them. For example, we cannot just write:</p>
<div class="sourceCode" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb52-1">overload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>LambdaType1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> LambdaType2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> myOverload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{...}</span></span></code></pre></div>
<p>The only way that could work would be some <code>make</code> function (as template argument deduction works for function templates):</p>
<div class="sourceCode" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb53-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb53-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">constexpr</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">auto</span> make_overloader<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;...</span> t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb53-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>forward<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)...};</span></span>
<span id="cb53-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>With the template argument deduction rules that were added in C++17, we can simplify the creation of common template types and the <code>make_overloader</code> function is not needed. For simple types, we can write:</p>
<div class="sourceCode" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb54-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>pair<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>strDouble<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>There’s also the option to define custom deduction guides. The standard library uses a lot of them, for exmaple, for <code>std::array</code>:</p>
<div class="sourceCode" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb55-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb55-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...(</span>U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)&gt;;</span></span></code></pre></div>
<p>and the above rules allows us to write:</p>
<div class="sourceCode" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb56-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>test<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>For the <code>overloaded</code> pattern, we can specify a custom deduction guide:</p>
<div class="sourceCode" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb57-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> overloaded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Ts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...&gt;;</span></span></code></pre></div>
</section>
<section id="extension-to-aggregate-initialisation" class="level3">
<h3 class="anchored" data-anchor-id="extension-to-aggregate-initialisation">Extension to aggregate initialisation</h3>
<p>The functionality is relatively straightforward: we can now aggregate initialise a type that derives from other types. From the specification:</p>
<blockquote class="blockquote">
<p>An aggregate is an array or a class with: - no user-provided, explicit or inherited constructors - no <code>private</code> or <code>protected</code> non-static data members - no <code>virtual</code> functions - no <code>virtual</code>, <code>private</code> or <code>protected</code> base classes.</p>
</blockquote>
<p>For example:</p>
<div class="sourceCode" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb58-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> base1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb58-2"></span>
<span id="cb58-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> base2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb58-4">    base2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb58-5">        b3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb58-7"></span>
<span id="cb58-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> b3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb58-10"></span>
<span id="cb58-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> derived <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> base1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> base2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb58-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb58-14"></span>
<span id="cb58-15">derived d1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{},</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb58-16">derived d2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{},</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{},</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>


</section>
</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/lambda_functions/index.html</guid>
  <pubDate>Sat, 13 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/lambda_functions/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Floating-point numbers</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/floating_point/index.html</link>
  <description><![CDATA[ 




<section id="floating-point-numbers" class="level1">
<h1>Floating-point numbers</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Computer memory has a finite capacity. Real numbers in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D">, do not, in general, however, have finite uniform representation. For example, consider representing the rational number <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B4%7D%7B3%7D"> as a decimal value: it is <img src="https://latex.codecogs.com/png.latex?(1.333%5Coverline%7B3%7D)_%7B10%7D"> – it is impossible to do so exactly! Since only a finite number of digits can be stored in computer memory, the reals have to be approximated in some fashion (rounded or truncated), when represented on a computer.</p>
<p>In this tutorial, we’ll go over the basic ideas of floating-point representation and learn the limits of floating-point accuracy, when doing practical numerical computing.</p>
</section>
<section id="rounding-and-chopping" class="level2">
<h2 class="anchored" data-anchor-id="rounding-and-chopping">Rounding and Chopping</h2>
<p>There are two distinguishable ways of rounding off a real number <img src="https://latex.codecogs.com/png.latex?x"> to a given number <img src="https://latex.codecogs.com/png.latex?t"> of decimals.</p>
<p>In chopping, we simply leave off all decimals to the right of the <img src="https://latex.codecogs.com/png.latex?t">th digit. For example, 56.555 truncated to <img src="https://latex.codecogs.com/png.latex?t=1"> decimal place yields 56.5.</p>
<p>In rounding to nearest, we choose a number with <img src="https://latex.codecogs.com/png.latex?t"> decimals, which is the closest to <img src="https://latex.codecogs.com/png.latex?x">. For example, consider rounding off 56.555 to <img src="https://latex.codecogs.com/png.latex?t=1"> decimal place. There are two possible candidates: 56.5 and 56.6. On the real number line, 56.5 is at a distance of <img src="https://latex.codecogs.com/png.latex?%7C56.555%20-%2056.5%7C=0.55%20%5Ctimes%2010%5E%7B-1%7D"> from 56.555, whilst 56.6 is at a distance of <img src="https://latex.codecogs.com/png.latex?%7C56.6%20-%2056.555%7C=0.45%20%5Ctimes%2010%5E%7B-1%7D">. So, 56.6 is the nearest and we round to 56.6.</p>
<p>Intuitively, we are comparing the fractional part of the number to the right of the <img src="https://latex.codecogs.com/png.latex?t">th digit, which is <img src="https://latex.codecogs.com/png.latex?0.055%20=%200.55%20%5Ctimes%2010%5E%7B-1%7D"> with <img src="https://latex.codecogs.com/png.latex?0.5%20%5Ctimes%2010%5E%7B-1%7D">. As <img src="https://latex.codecogs.com/png.latex?0.55%20%5Ctimes%2010%5E%7B-1%7D%20%3E%200.5%20%5Ctimes%2010%5E%7B-1%7D">, we incremented the <img src="https://latex.codecogs.com/png.latex?t">th digit, which is 5 by 1.</p>
<p>What if, we wished to round off 56.549 to <img src="https://latex.codecogs.com/png.latex?t=1"> decimal places? Observe that, the fractional part is <img src="https://latex.codecogs.com/png.latex?0.49%20%5Ctimes%2010%5E%7B-1%7D">. As <img src="https://latex.codecogs.com/png.latex?0.49%20%5Ctimes%2010%5E%7B-1%7D%20%3C%200.5%20%5Ctimes%2010%5E%7B-1%7D">, we leave the <img src="https://latex.codecogs.com/png.latex?t">th digit unchanged. So, the result is 56.5, which is indeed nearest to 56.549.</p>
<p>In general, let <img src="https://latex.codecogs.com/png.latex?p"> be the fractional part of the number to the right of <img src="https://latex.codecogs.com/png.latex?t">th digit (after the decimal point). If <img src="https://latex.codecogs.com/png.latex?p%3E0.5%20%5Ctimes%2010%5E%7B-t%7D">, we increment the <img src="https://latex.codecogs.com/png.latex?t">th digit. If <img src="https://latex.codecogs.com/png.latex?p%3C0.5%20%5Ctimes%2010%5E%7B-t%7D">, we leave the <img src="https://latex.codecogs.com/png.latex?t">th digit unchanged.</p>
<p>In the case of a tie, when <img src="https://latex.codecogs.com/png.latex?x"> is equidistant to two decimal <img src="https://latex.codecogs.com/png.latex?t">-digit numbers, we raise the <img src="https://latex.codecogs.com/png.latex?t">th decimal if it is odd or leave it unchanged if it is even. In this way, the error in rounding off a decimal number is positive or negative equally often.</p>
<p>Let’s see some more examples of rounding and chopping, to make sure, this sinks in. Assume that, we are interested in rounding off all quantities to <img src="https://latex.codecogs.com/png.latex?t=3"> decimal places:</p>
<div id="tbl-rounding" class="anchored">
<table class="table">
<caption>Table&nbsp;1: Examples of rounding and chopping to <img src="https://latex.codecogs.com/png.latex?t=3"> decimal places</caption>
<thead>
<tr class="header">
<th><img src="https://latex.codecogs.com/png.latex?x"></th>
<th>Rounding</th>
<th>Chopping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.2397</td>
<td>0.240</td>
<td>0.239</td>
</tr>
<tr class="even">
<td>0.23750</td>
<td>0.238</td>
<td>0.237</td>
</tr>
<tr class="odd">
<td>0.23650</td>
<td>0.236</td>
<td>0.236</td>
</tr>
<tr class="even">
<td>0.23652</td>
<td>0.237</td>
<td>0.236</td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?%5Cpi%20%5Capprox%203.1415926"></td>
<td>3.142</td>
<td>3.141</td>
</tr>
</tbody>
</table>
</div>
<p>The difference between chopping and rounding has real-world implications! The Vancouver stock exchange index began trading in 1982, with a base value of 1000.00. Although the underlying stocks were performing decent, the index began hitting the low 500s at the end of 1983. A computer program re-calculated the value of the index thousands of times each day, and the program used chopping instead of rounding to the nearest. A rounded calculation gave a value of 1082.00.</p>
</section>
<section id="computer-number-systems" class="level2">
<h2 class="anchored" data-anchor-id="computer-number-systems">Computer Number Systems</h2>
<p>In our daily life, we represent numbers using the decimal number system with base 10. In the decimal system, we’re aware, that if a digit <img src="https://latex.codecogs.com/png.latex?d_%7B-k%7D"> stands <img src="https://latex.codecogs.com/png.latex?k"> digits to the right of the decimal point, the value it contributes is <img src="https://latex.codecogs.com/png.latex?d_%7B-k%7D%20%5Ccdot%2010%5E%7B-k%7D">. For example the sequence of digits 4711.303 means:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A4%20%5Ccdot%2010%5E3%20+%207%20%5Ccdot%20%2010%5E2%20+%201%20%5Ccdot%2010%5E1%20+%201%5Ccdot%2010%5E0%20+%203%20%5Ccdot%2010%5E%7B-1%7D%20+%200%20%5Ccdot%2010%5E%7B-2%7D%20+%203%20%5Ccdot%2010%5E%7B-3%7D%20%5Cend%7Balign*%7D"></p>
<p>In fact any integer <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20%5Cgeq%202"> (or <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20%5Cleq%20-2">) can be used as a base. Analogously, every real number <img src="https://latex.codecogs.com/png.latex?x%20%5Cin%20%5Cmathbb%7BR%7D"> has a unique representation of the form:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20x%20=%20d_n%20%5Cbeta%5En%20+%20d_%7Bn-1%7D%5Cbeta%5E%7Bn-1%7D%20+%20%5Cldots%20+%20d_1%20%5Cbeta%5E%7B1%7D%20+%20d_0%20%5Cbeta%5E0%20+%20d_%7B-1%7D%5Cbeta%5E%7B-1%7D%20+%20d_%7B-2%7D%20%5Cbeta%5E%7B-2%7D%20+%20%5Cldots%20%5Cend%7Balign*%7D"></p>
<p>or compactly <img src="https://latex.codecogs.com/png.latex?d_%7Bn%7D%5Cldots%20d_1%20d_0.d_%7B-1%7D%20d_%7B-2%7D%20%5Cldots">, where the coefficients <img src="https://latex.codecogs.com/png.latex?d_i">, the digits in system <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, are positive integers such that <img src="https://latex.codecogs.com/png.latex?0%20%5Cleq%20d_i%20%3C%20%5Cbeta">.</p>
<section id="conversion-algorithm-between-two-number-systems" class="level3">
<h3 class="anchored" data-anchor-id="conversion-algorithm-between-two-number-systems">Conversion Algorithm Between Two Number Systems</h3>
<p>Consider the problem of conversion between two number systems with different bases. For the sake of concreteness, let’s try to convert <img src="https://latex.codecogs.com/png.latex?(250)_%7B10%7D"> to the binary format. We may write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20250%20=%20d_7%20%5Ccdot%202%5E7%20+%20d_6%5Ccdot%202%5E6%20+%20d_5%20%5Ccdot%202%5E5%20+%20d_4%5Ccdot%202%5E4%20+%20d_3%5Ccdot%202%5E3%20+%20d_2%5Ccdot%202%5E2%20+%20d_1%5Ccdot%202%5E1%20+%20d_0%20%5Cend%7Balign*%7D"></p>
<p>We can pull out a factor of 2 from each term, except the last, and equivalently write:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20250%20=%202%20%5Ctimes%20(d_7%20%5Ccdot%202%5E6%20+%20d_6%5Ccdot%202%5E5%20+%20d_5%20%5Ccdot%202%5E4%20+%20d_4%5Ccdot%202%5E3%20+%20d_3%5Ccdot%202%5E2%20+%20d_2%5Ccdot%202%5E1%20+%20d_1)%20+%20d_0%20%5Cend%7Balign*%7D"></p>
<p>Intuitively, therefore, if we were to divide <img src="https://latex.codecogs.com/png.latex?q_0=250"> by 2, the expression in brackets, let’s call it <img src="https://latex.codecogs.com/png.latex?q_1">, is the quotient and <img src="https://latex.codecogs.com/png.latex?d_0"> is the remainder of the division. Similarly, since <img src="https://latex.codecogs.com/png.latex?q_1%20=%202%20%5Ctimes%20(d_7%20%5Ccdot%202%5E5%20+%20d_6%5Ccdot%202%5E4%20+%20d_5%20%5Ccdot%202%5E3%20+%20d_4%5Ccdot%202%5E2%20+%20d_3%5Ccdot%202%5E1%20+%20d_2)%20+%20d_1">, division by 2 would return the expression in the brackets as the quotient; call it <img src="https://latex.codecogs.com/png.latex?q_2">, and <img src="https://latex.codecogs.com/png.latex?d_1"> as the remainder.</p>
<p>In general, if <img src="https://latex.codecogs.com/png.latex?a"> is an integer with base <img src="https://latex.codecogs.com/png.latex?%5Calpha"> and we want to determine it’s representation in a number system with base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, we perform successive divisions of <img src="https://latex.codecogs.com/png.latex?a"> with <img src="https://latex.codecogs.com/png.latex?%5Cbeta">: set <img src="https://latex.codecogs.com/png.latex?q_0%20=%20a"> and</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20q_k%20=%20%5Cbeta%20%5Ctimes%20q_%7Bk+1%7D%20+%20d_k,%20%5Cquad%20k%20=%200,1,2,%5Cldots%20%5Cend%7Balign*%7D"></p>
<p><img src="https://latex.codecogs.com/png.latex?q_%7Bk+1%7D"> is the quotient and <img src="https://latex.codecogs.com/png.latex?d_k"> is the remainder in the division.</p>
<p>Let’s look at the result of applying the algorithm to <img src="https://latex.codecogs.com/png.latex?(250)_%7B10%7D">:</p>
<p>k q_k q_k+1 d_k 0 250 250/2 = 125 0 1 125 125/2 = 62 1 2 62 62/2 = 31 0 3 31 31/2 = 15 1 4 15 15/2 = 7 1 5 7 7/2 = 3 1 6 3 3/2 = 1 1 7 1 1/2 = 0 1</p>
<p>Therefore, <img src="https://latex.codecogs.com/png.latex?(250)_%7B10%7D%20=%20(d_7%20d_6%20d_5%20d_4%20d_3%20d_2%20d_1%20d_0)_2%20=%201111%5C,1010">.</p>
</section>
<section id="converting-fractions-to-another-number-system" class="level3">
<h3 class="anchored" data-anchor-id="converting-fractions-to-another-number-system">Converting Fractions to Another Number System</h3>
<p>If the real number <img src="https://latex.codecogs.com/png.latex?a"> is not an integer, we write it as <img src="https://latex.codecogs.com/png.latex?a%20=%20b%20+%20c">, where <img src="https://latex.codecogs.com/png.latex?b"> is the integer part and</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ac%20=%20c_%7B-1%7D%5Cbeta%5E%7B-1%7D%20+%20c_%7B-2%7D%5Cbeta%5E%7B-2%7D%20+%20c_%7B-3%7D%5Cbeta%5E%7B-3%7D%20+%20%5Cldots%0A%5Cend%7Balign*%7D%0A"></p>
<p>is the fractional part, where <img src="https://latex.codecogs.com/png.latex?c_%7B-1%7D,c_%7B-2%7D,c_%7B-3%7D,%5Cldots"> are to be determined.</p>
<p>Observe that, multiplying both sides by the base <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> yields,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20c%20%5Ccdot%20%5Cbeta%20=%20%5Cunderbrace%7Bc_%7B-1%7D%7D_%7B%5Ctext%7BInteger%7D%7D%20+%20%5Cunderbrace%7Bc_%7B-2%7D%5Cbeta%5E%7B-1%7D%20+%20c_%7B-3%7D%5Cbeta%5E%7B-2%7D%20+%20%5Cldots%7D_%7B%5Ctext%7BFractional%20part%7D%7D%20%5Cend%7Balign*%7D"></p>
<p>an integer and a fractional portion. The integer portion is precisely <img src="https://latex.codecogs.com/png.latex?c_%7B-1%7D"> – the first digit of <img src="https://latex.codecogs.com/png.latex?c"> represented in base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">. Consecutive digits are obtained as the integer parts, when successively multiplying <img src="https://latex.codecogs.com/png.latex?c"> by <img src="https://latex.codecogs.com/png.latex?%5Cbeta">.</p>
<p>In general, if a fraction <img src="https://latex.codecogs.com/png.latex?c"> must be converted to another number system with base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, we perform successive multiplications of <img src="https://latex.codecogs.com/png.latex?c"> with <img src="https://latex.codecogs.com/png.latex?%5Cbeta">: set <img src="https://latex.codecogs.com/png.latex?p_0%20=%20c"> and</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20p_%7Bk%7D%20%5Ccdot%20%5Cbeta%20=%20c_%7Bk-1%7D%20+%20p_%7Bk-1%7D,%20%5Cquad%20k%20=%200,-1,-2,%5Cldots%20%5Cend%7Balign*%7D"></p>
<p>Let’s look at an example of converting <img src="https://latex.codecogs.com/png.latex?(0.15625)_%7B10%7D"> to binary number system:</p>
<p>k p_k p_k<img src="https://latex.codecogs.com/png.latex?%5Ccdot%20%5Cbeta"> c_k-1 p_k-1 0 0.15625 <img src="https://latex.codecogs.com/png.latex?0.15625%20%5Ctimes%202%20=0.3125"> 0 0.3125 -1 0.3125 <img src="https://latex.codecogs.com/png.latex?0.3125%20%5Ctimes%202%20=0.625"> 0 0.625 -2 0.625 <img src="https://latex.codecogs.com/png.latex?0.625%20%5Ctimes%202%20=1.25"> 1 0.25 -3 0.25 <img src="https://latex.codecogs.com/png.latex?0.25%20%5Ctimes%202%20=0.50"> 0 0.50 -4 0.50 <img src="https://latex.codecogs.com/png.latex?0.50%20%5Ctimes%202%20=1.00"> 1 0.00</p>
<p>freestar Therefore, <img src="https://latex.codecogs.com/png.latex?(0.15625)_%7B10%7D%20=%200.0010%5C,1000"> in the binary system.</p>
</section>
<section id="fixed-and-floating-point-representation" class="level3">
<h3 class="anchored" data-anchor-id="fixed-and-floating-point-representation">Fixed and Floating-Point Representation</h3>
<p>Computers are equipped to handle pieces of information of a fixed size called a word. Typical word lengths are 32-bits or 64-bits.</p>
<p>Early computers made numerical calculations in a fixed-point number system. That is, real numbers were represented using a fixed number of <img src="https://latex.codecogs.com/png.latex?t"> binary digits in the fractional part. If the word-length of the computer is <img src="https://latex.codecogs.com/png.latex?s+1"> bits, (including the sign bit), then only numbers in the bounded interval <img src="https://latex.codecogs.com/png.latex?I=%5B-2%5E%7Bs-t%7D,2%5E%7Bs-t%7D%5D"> are permitted. This limitation is problematic, since, for example, even when <img src="https://latex.codecogs.com/png.latex?x%20%5Cin%20I"> and <img src="https://latex.codecogs.com/png.latex?y%20%5Cin%20I">, it is possible that <img src="https://latex.codecogs.com/png.latex?x%20-%20y"> is outside the bounds of the interval <img src="https://latex.codecogs.com/png.latex?I">.</p>
<p>In a floating-point number system, a real number <img src="https://latex.codecogs.com/png.latex?a"> is represented as:</p>
<p>freestar <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20a%20=%20%5Cpm%20m%20%5Ccdot%20%5Cbeta%5Ee,%20%5Cquad%20m%20=%20(0.d_1%20d_2%20d_3%20%5Cldots)_%5Cbeta,%20%5Cquad%20e%20%5Ctext%7B%20an%20integer%20%7D%20%5Cend%7Balign*%7D"></p>
<p>The fractional part <img src="https://latex.codecogs.com/png.latex?m"> of the number is called the mantissa or significand. <img src="https://latex.codecogs.com/png.latex?e"> is called the exponent and <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> is the base. It’s clear that <img src="https://latex.codecogs.com/png.latex?d_1%20%5Cneq%200">, because if <img src="https://latex.codecogs.com/png.latex?d_1%20=%200">, then we can always decrease the exponent by 1 and shift the decimal point one place to the right.</p>
<p>The mantissa <img src="https://latex.codecogs.com/png.latex?m"> and the exponent <img src="https://latex.codecogs.com/png.latex?e"> are limited by the fixed word length in computers. <img src="https://latex.codecogs.com/png.latex?m"> is rounded off to a number <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bm%7D"> with <img src="https://latex.codecogs.com/png.latex?t"> digits and the exponent <img src="https://latex.codecogs.com/png.latex?e"> lies in a certain range.</p>
<p>Thus, we can only represent floating-point numbers of the form:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20a%20=%20%5Cpm%20%5Coverline%7Bm%7D%20%5Ccdot%20%5Cbeta%5Ee,%20%5Cquad%20%5Coverline%7Bm%7D%20=%20(0.d_1%20d_2%20d_3%20%5Cldots%20d_t)_%5Cbeta,%20%5Cquad%20e_%7Bmin%7D%20%5Cleq%20e%20%5Cleq%20e_%7Bmax%7D,%20%5Cquad%20e%20%5Cin%20%5Cmathbf%7BZ%7D%20%5Cend%7Balign*%7D"></p>
<p>A floating-point number system <img src="https://latex.codecogs.com/png.latex?F"> is completely characterized by the base <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, precision <img src="https://latex.codecogs.com/png.latex?t">, the numbers <img src="https://latex.codecogs.com/png.latex?e_%7Bmin%7D"> and <img src="https://latex.codecogs.com/png.latex?e_%7Bmax%7D">. Since <img src="https://latex.codecogs.com/png.latex?d_1%20%5Cneq%200">, the set <img src="https://latex.codecogs.com/png.latex?F">, contains, including the number 0,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%202%20(%5Cbeta%20-%201)%20%5Cbeta%5E%7Bt-1%7D(e_%7Bmax%7D%20-%20e_%7Bmin%7D%20+%201)%20+%201%20%5Cend%7Balign*%7D"></p>
<p>numbers. Intuitively, there are 2 choices for the sign. The digit <img src="https://latex.codecogs.com/png.latex?d_1"> can be chosen from the set <img src="https://latex.codecogs.com/png.latex?%5C%7B1,2,%5Cldots,%5Cbeta%20-%201%5C%7D">. Each of the successive <img src="https://latex.codecogs.com/png.latex?t-1"> digits can be chosen from <img src="https://latex.codecogs.com/png.latex?%5C%7B0,1,2,%5Cldots,%5Cbeta%20-%201%5C%7D">. The exponent can be chosen from <img src="https://latex.codecogs.com/png.latex?e_%7Bmax%7D%20-%20e_%7Bmin%7D%20+%201"> numbers. By the multiplication rule, there are <img src="https://latex.codecogs.com/png.latex?2%20(%5Cbeta%20-%201)%20%5Cbeta%5E%7Bt-1%7D(e_%7Bmax%7D%20-%20e_%7Bmin%7D%20+%201)"> distinguishable numbers. Including the number 0 gives us the expression above.</p>
</section>
</section>
<section id="why-are-floating-point-numbers-inaccurate" class="level2">
<h2 class="anchored" data-anchor-id="why-are-floating-point-numbers-inaccurate">Why Are Floating-Point Numbers Inaccurate?</h2>
<p>Consider a toy floating-point number system <img src="https://latex.codecogs.com/png.latex?F(%5Cbeta%20=%202,%20t%20=%203,%20e_%7Bmin%7D=-1,%20e_%7Bmax%7D=2)">. The set <img src="https://latex.codecogs.com/png.latex?F"> contains exactly <img src="https://latex.codecogs.com/png.latex?2%20%5Ccdot%2016%20+%201%20=%2033"> numbers. The positive numbers in the set <img src="https://latex.codecogs.com/png.latex?F"> are shown below:</p>
<p><img src="https://latex.codecogs.com/png.latex?(0.d_1%20d_2%20d_3)_2"> <img src="https://latex.codecogs.com/png.latex?2%5Ee"> Decimal representation <img src="https://latex.codecogs.com/png.latex?(0.d_1%20d_2%20d_3)_2"> <img src="https://latex.codecogs.com/png.latex?2%5Ee"> Decimal representation <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.25 <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.00 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.3125 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.25 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.375 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.50 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E%7B-1%7D"> 0.4375 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E1"> 1.75 <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.50 <img src="https://latex.codecogs.com/png.latex?(0.100)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 2.00 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.625 <img src="https://latex.codecogs.com/png.latex?(0.101)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 2.50 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.75 <img src="https://latex.codecogs.com/png.latex?(0.110)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 3.00 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E0"> 0.875 <img src="https://latex.codecogs.com/png.latex?(0.111)_2"> <img src="https://latex.codecogs.com/png.latex?2%5E2"> 3.50 It is apparent that not all real numbers, for instance in, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7B%5B1,2%5D%7D"> are present in <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BF%7D">. Moreover, not all floating-point numbers are equally spaced; the spacing jumps by a factor of <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> at each power of <img src="https://latex.codecogs.com/png.latex?%5Cbeta">.</p>
<p>The spacing of the floating-point numbers is characterized by the machine epsilon <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7B%5Cepsilon_M%7D">, which is the distance from 1.0 to the next largest floating-point number.</p>
<p>If a real number <img src="https://latex.codecogs.com/png.latex?x"> is in the range of the floating-point system, the obvious thing to do is to round off <img src="https://latex.codecogs.com/png.latex?x"> to <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bx%7D">, where <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bx%7D=%5Ctext%7Bfloat%7D(x)"> is the floating-point number in <img src="https://latex.codecogs.com/png.latex?F">, that is closest to <img src="https://latex.codecogs.com/png.latex?x">. It should already be clear that representing <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D"> by <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bfloat(x)%7D"> introduces an error.</p>
<p>One interesting question is, how large is this error? It would be great if we could guarantee, that the round-off error at no point exceeds a certain amount. Everybody loves a guarantee! In other words, we seek an upper bound for the relative error:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%5Cfrac%7B%7Cfl(x)%20-%20x%7C%7D%7B%7Cx%7C%7D%20%5Cend%7Balign*%7D"></p>
<p>Recall, from the earlier discussion, that when rounding <img src="https://latex.codecogs.com/png.latex?m"> to <img src="https://latex.codecogs.com/png.latex?t"> decimals, we leave the <img src="https://latex.codecogs.com/png.latex?t">th decimal unchanged, if the part <img src="https://latex.codecogs.com/png.latex?p">, of the number to right of the <img src="https://latex.codecogs.com/png.latex?t">th decimal, is smaller than <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7D%20%5Ctimes%2010%5E%7B-t%7D">, else raise the <img src="https://latex.codecogs.com/png.latex?t">th decimal by 1. Here, we are working with the generic base <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> instead of the decimal base 10. Consequently, the round-off error in the mantissa is bounded by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%7C%5Coverline%7Bm%7D%20-%20m%7C%20%5Cleq%20%5Cfrac%7B1%7D%7B2%7D%5Ccdot%20%5Cbeta%5E%7B-t%7D%20%5Cend%7Balign*%7D"></p>
<p>The relative round-off error in <img src="https://latex.codecogs.com/png.latex?x"> is thus bounded by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%5Cfrac%7B%7Cfl(x)%20-%20x%7C%7D%7B%7Cx%7C%7D%20&amp;=%20%5Cfrac%7B%7C%5Coverline%7Bm%7D%20-%20m%7C%20%5Ccdot%20%5Cbeta%5Ee%7D%7Bm%20%5Ccdot%20%5Cbeta%5Ee%7D%5C%5C%20&amp;%5Cleq%20%5Cfrac%7B%5Cfrac%7B1%7D%7B2%7D%5Ccdot%20%5Cbeta%5E%7B-t%7D%20%5Ccdot%20%5Cbeta%5Ee%7D%7B(0.1)_%5Cbeta%20%5Cbeta%5Ee%7D%20%5Cquad%20%5Cquad%20%5C%7B%20m%20%5Cgeq%20(0.1)_%5Cbeta%20%5C%7D%20%5C%5C%20&amp;=%20%5Cfrac%7B1%7D%7B2%7D%20%5Ccdot%20%5Cbeta%5E%7B-t%20+%201%7D%20%5Cend%7Balign*%7D"></p>
<p>Modern floating-point standards such as the IEEE guarantee this upper bound. This upper bound is called the rounding unit, denoted by <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bu%7D">.</p>
</section>
<section id="ieee-floating-point-standard-in-a-nutshell" class="level2">
<h2 class="anchored" data-anchor-id="ieee-floating-point-standard-in-a-nutshell">IEEE Floating-point Standard in a Nutshell</h2>
<p>Actual computer hardware implementations of floating-point systems differ from the toy system, we just designed. Most current computers conform to the IEEE 754 standard for binary floating-point arithmetic. There is two main basic formats – single and double precision, requiring 32-bit and 64-bit storage.</p>
<p>In single-precision, a floating-point number <img src="https://latex.codecogs.com/png.latex?a"> is stored as the sign <img src="https://latex.codecogs.com/png.latex?s"> (1 bit), the exponent <img src="https://latex.codecogs.com/png.latex?e"> (8 bits), the mantissa <img src="https://latex.codecogs.com/png.latex?m"> (23 bits).</p>
<p>In double-precision, 11 bits are allocated to the exponent <img src="https://latex.codecogs.com/png.latex?e">, whereas 52 bits are allocated to the mantissa <img src="https://latex.codecogs.com/png.latex?m">. The exponent is stored as <img src="https://latex.codecogs.com/png.latex?b=e+1023">.</p>
<p>Rendered by QuickLaTeX.com</p>
<p>The value <img src="https://latex.codecogs.com/png.latex?v"> of the floating-point number <img src="https://latex.codecogs.com/png.latex?a"> in the normal case is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20v%20=%20(-1)%5Es%20(1.m)_2%20%5Ccdot%202%5Ee,%20%5Cquad%20%5Cquad%20e_%7Bmin%7D%20%5Cleq%20e%20%5Cleq%20e_%7Bmax%7D%20%5Cend%7Balign*%7D"></p>
<p>Note, that the digit before the binary point is always 1, similar to the scientific notation we studied in high school. In that way, 1 bit is gained for the mantissa.</p>
<section id="quirks-in-floating-point-arithmetic" class="level3">
<h3 class="anchored" data-anchor-id="quirks-in-floating-point-arithmetic">Quirks in Floating-Point Arithmetic</h3>
<p>Consider the following comparison:</p>
<p>(0.10 + 0.20) == 0.30 Copy The result of this logical comparison is false. This abrupt behavior is expected because the floating-point system is broken. However, let’s take a deeper look at what’s going on.</p>
<p>Let’s put 0.10 in the double-precision format. Because 0.10 is positive, the sign bit <img src="https://latex.codecogs.com/png.latex?s=0">.</p>
<p>0.10 in base-2 scientific notation can be written as <img src="https://latex.codecogs.com/png.latex?(-1)%5E0%20(1%20+%20m)%202%5E%7Be%7D">. This means we must factor 0.10 into a number <img src="https://latex.codecogs.com/png.latex?(1%20+%20m)"> in the range <img src="https://latex.codecogs.com/png.latex?1%20%5Cleq%20m%20%3C%202"> and a power of 2. If we divide 0.10 by different powers of 2, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%200.10%20/%202%5E%7B-1%7D%20&amp;=%200.20%5C%5C%200.10%20/%202%5E%7B-2%7D%20&amp;=%200.40%5C%5C%200.10%20/%202%5E%7B-3%7D%20&amp;=%200.80%5C%5C%200.10%20/%202%5E%7B-4%7D%20&amp;=%201.60%20%5Cend%7Balign*%7D"></p>
<p>Therefore, <img src="https://latex.codecogs.com/png.latex?0.10%20=%201.60%20%5Ctimes%202%5E%7B-4%7D">. The exponent is stored as <img src="https://latex.codecogs.com/png.latex?e%20+%201023=-4%20+%201023%20=%201019">, so the bit pattern in the exponent part is <img src="https://latex.codecogs.com/png.latex?(011%5C,%201111%5C,%201011)_2">.</p>
<p>The mantissa <img src="https://latex.codecogs.com/png.latex?m"> is the fractional part 0.60 in the binary form. Successive multiplication by 2 quickly yields <img src="https://latex.codecogs.com/png.latex?m%20=%20(0.1001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%20%5Cldots)_2">. However, the double-precision format allocates <img src="https://latex.codecogs.com/png.latex?t=52"> bits to the mantissa, so we must round off <img src="https://latex.codecogs.com/png.latex?m"> to 52 digits. The fractional part <img src="https://latex.codecogs.com/png.latex?p">, after the 52nd digit, <img src="https://latex.codecogs.com/png.latex?(0.1001%20%5Cldots)_2%20%5Ctimes%202%5E%7B-52%7D"> exceeds <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7D%20%5Cbeta%5E%7B-t%7D%20=%20(0.1)_2%20%5Ctimes%202%5E%7B-52%7D">. So, we raise the <img src="https://latex.codecogs.com/png.latex?t">th decimal by 1. Thus, the rounded mantissa is <img src="https://latex.codecogs.com/png.latex?%5Coverline%7Bm%7D=%20(0.1001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201010)_2">.</p>
<p>Finally, we put the binary strings in the correct order. So, 0.10 in the IEEE double-precision format is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20%5Cunderbrace%7B0%7D_%7Bs%7D%5C,%5Cunderbrace%7B011%5C,%201111%5C,%201011%7D_%7Be+1023%7D%5C,%5Cunderbrace%7B1001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201001%5C,%201010%7D_%7B%5Coverline%7Bm%7D%7D%20%5Cend%7Balign*%7D"></p>
<p>This machine number is approximately 0.10000000000000000555 in base 10. In a similar fashion, the closest machine number to 0.2 in the floating-point system is approximately 0.2000000000000000111. Therefore, float(0.1) + float(0.2) &gt; 0.30. On the right hand side, the closest machine number to 0.3 is 0.29999999999999998889. So, float(0.30) &lt; 0.30.</p>
<p>To summarize, algebraically equivalent statements are not necessarily numerically equivalent.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this article, we’ve learned how the rules of chopping and rounding to the nearest work. We developed an algorithm for conversion between number systems. We also learnt that, any floating-point system is characterized by a quadruple <img src="https://latex.codecogs.com/png.latex?F(%5Cbeta,t,e_%7Bmin%7D,e_%7Bmax%7D)">. For example, the IEEE double-precision format is given as <img src="https://latex.codecogs.com/png.latex?F(%5Cbeta=2,t=52,e_%7Bmin%7D=-1022,e_%7Bmax%7D=1023)">. Because computers have finite memory capacity, the set of machine numbers, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BM%7D"> are only a subset of the real numbers <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BR%7D">. The spacing between machine numbers in technical speak is called the machine epsilon.</p>
<p>Further, any real number <img src="https://latex.codecogs.com/png.latex?x"> is always rounded off to the nearest machine number on a computer. The IEEE standards guarantee that the relative roundoff error is no more than a certain amount. Moreover, as programmers, we need to take proper care when doing floating-point operations.</p>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/floating_point/index.html</guid>
  <pubDate>Sat, 13 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/floating_point/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Objects, Pointers and References</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/objects-pointers-and-references/index.html</link>
  <description><![CDATA[ 




<section id="objects-pointers-and-references" class="level1">
<h1>Objects, pointers and references</h1>
<p>An object is something that has a lifetime and occupies storage. Even a humble <code>int</code> is an object, but a function is not.</p>
<p>A <em>pointer</em> is a typed address. It associates a type with what is found at some memory location.</p>
<p>Pointers allow us to do arithmetic, but that’s legitimately seen as a dangerous operation, as it can take us to arbitrary locations. Accessing the contents of arbitrary addresses is just asking for trouble.</p>
<p>C++ has special types for pointer manipulation:</p>
<ul>
<li><p><code>void*</code> means <em>address with no specific type</em> semantics. A <code>void*</code> is an address with no associated type. All pointers are implicitly convertible to <code>void*</code> ; an informal way to read this is <em>all pointers regardless of type are addresses</em>. The converse does not hold. For example, it’s not true that all addresses are implicitly convertible to <code>int</code> pointers.</p></li>
<li><p><code>char*</code> means pointer to a byte. Due to the C language roots of C++, a <code>char*</code> can alias any address in memory (the <code>char</code> type regardless of its name, which evocates character, really means <code>byte</code> in C and by extension in C++). There is an ongoing effort in C++ to to give <code>char</code> the meaning of character.</p></li>
<li><p><code>std::byte*</code> is the new <em>pointer to a byte</em>, atleast since C++17. The long term intent of <code>std::byte*</code> is to replace <code>char*</code> in those functions that do byte-per-byte manipulation or addressing, but since there’s so much code that uses <code>char*</code> to that effect, this will take time.</p></li>
</ul>
<section id="string-literals" class="level2">
<h2 class="anchored" data-anchor-id="string-literals">String literals</h2>
<p>A <em>string literal</em> is a character sequence enclosed within double quotes.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"this is a string"</span></span></code></pre></div>
<p>A string literal contains one more character than it appears to have; it is terminated by the <code>\0</code> null termination character (having integer value <code>0</code>). For example,</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bohr"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span></code></pre></div>
<p>The type of a string literal is <em>array of appropriate number of <code>const</code> characters</em>, so <code>"Bohr"</code> is of type <code>const char[5]</code>.</p>
<p>In C and older C++ code, you could assign a string literal to a non-<code>const</code> <code>char*</code>.</p>
<p>Modifying string literals is undefined behavior. In practice, the implementation can for instance store the string literal in read-only memory, such as the&nbsp;<code>.rodata</code>&nbsp;segment on Linux.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb3-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//char* p = "Cauchy";       // error, since C++11</span></span>
<span id="cb3-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cauchy"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb3-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//s[4] = 'e';               // error, assignment to const</span></span>
<span id="cb3-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Having string literals as immutable is not only obvious but also allows implementations to do significant optimizations in the way string literals are stored and accessed.</p>
<p>If we want a string that we are guaranteed to be able to modify, we must place the characters in a non-<code>const</code> array.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Schwarz"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// p is an array of 8 char</span></span>
<span id="cb4-2">p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'s'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span></code></pre></div>
<p>A string literal is statically allocated so it is safe to return one from a function. It is an <em>lvalue</em>.</p>
<p>Whether two identical strings are allocated as one array, or as two is implementation defined. For example:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carl Friedrich Gauss"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carl Friedrich Gauss"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb5-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one!"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Implementation defined</span></span></code></pre></div>
<p>Note that, <code>==</code> compares addresses (pointer values) when applied to pointers, and not the objects pointed to.</p>
</section>
<section id="challenge-puzzle" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle">Challenge puzzle</h2>
<p>Observe the code snippet below. What is printed?</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb6-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// string literals</span></span>
<span id="cb6-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> s1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'h'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'e'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'o'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\0</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> s2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> s3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"world"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-9"></span>
<span id="cb6-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s1 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s2 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s3 = "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> s3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-13"></span>
<span id="cb6-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C++"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"general"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"purpose"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb6-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"programming"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span></span>
<span id="cb6-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-18"></span>
<span id="cb6-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 0 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 1 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 2 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c + 3 : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                           </span>
<span id="cb6-23"></span>
<span id="cb6-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[0] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[1] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-26">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[2] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-27">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c[3] : "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-28"></span>
<span id="cb6-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> cp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb6-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span> cpp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-31">    </span>
<span id="cb6-32"></span>
<span id="cb6-33">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>cpp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-34">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(*(*(</span>cpp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-35">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>cpp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-36">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>cpp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-38"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/vqbb6xYqx">Compiler Explorer</a></p>
</section>
<section id="challenge-puzzle-1" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle-1">Challenge puzzle</h2>
<p>Which of the following can be used to print the address of a <code>char</code> variable?</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> ch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">???;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// print address of ch</span></span></code></pre></div>
<ol type="a">
<li><p><code>&amp;ch[0]</code></p></li>
<li><p><code>(char*)&amp;ch</code></p></li>
<li><p><code>(void*)&amp;ch</code></p></li>
<li><p><code>&amp;ch</code></p></li>
</ol>
<p><code>&amp;ch</code> is of type <code>char*</code>. The <code>&lt;&lt;</code> operator for <code>std::cout</code> has an overload for <code>char*</code> that interprets it as a pointer to a null-terminated C-style string, so it attempts to print characters starting from the address of ch until it encounters a null terminator <code>(\0)</code>.</p>
<p>A pointer has to be able address all memory space. On 64-bit architecture, <code>sizeof(T*)</code> is therefore, <img src="https://latex.codecogs.com/png.latex?8"> bytes = <img src="https://latex.codecogs.com/png.latex?64"> bits.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb8-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok : implicit conversion of `int*` to `void*`</span></span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// *pv;         // error: can't dereference void*</span></span>
<span id="cb8-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>pv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// error: can't increment void*</span></span>
<span id="cb8-6">    </span>
<span id="cb8-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pi2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>pv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// explicit conversion back to `int*`</span></span>
<span id="cb8-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//double* pd1 = pv;                   // error</span></span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//double* pd2 = pi;                   // error</span></span>
<span id="cb8-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pd3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>pv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// unsafe</span></span>
<span id="cb8-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In general, it is not safe to use a pointer that has been converted to a type that differs from the type of the object pointed to.</p>
<p>The primary use for <code>void*</code> is for passing pointers to functions that are not allowed to make assumptions about the type of the object and for returning untyped objects from functions.</p>
</section>
<section id="pointer-declarations" class="level2">
<h2 class="anchored" data-anchor-id="pointer-declarations">Pointer declarations</h2>
<p>Use the spiral rule, when reading pointer declarations. Start at the inner-most level and work your way outwards spiralling in a counter-clockwise direction.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Pointer to array of 5 double(s)</span></span>
<span id="cb9-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ptr is an array of pointers to double of size 5</span></span></code></pre></div>
</section>
<section id="dereferencing-null-pointers" class="level2">
<h2 class="anchored" data-anchor-id="dereferencing-null-pointers">Dereferencing null pointers</h2>
<p>Trying to dereference a null pointer is an error. On most platforms, it generally causes a signal, usually SIGSEGV (see Signals).</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>foo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NULL<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-2">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>foo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* This causes a signal and terminates.  */</span></span></code></pre></div>
<p>Likewise a pointer that has the wrong alignment for the target data type (on most types of computer), or points to a part of memory that has not been allocated in the process’s address space.</p>
</section>
<section id="pointer-comparisons" class="level2">
<h2 class="anchored" data-anchor-id="pointer-comparisons">Pointer comparisons</h2>
<p>Two pointer values are equal if they point to the same memory address or they are both <code>nullptr</code>. Ordering comparisons such as <code>&gt;</code> and <code>&gt;=</code> operate on pointers by converting them to unsigned integers.</p>
</section>
<section id="pointers-into-arrays" class="level2">
<h2 class="anchored" data-anchor-id="pointers-into-arrays">Pointers into arrays</h2>
<p>In C++, pointers and arrays are closely related. The name of the array holds the starting address of the array can be used as a pointer to the initial element.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb11-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pointer to initial element</span></span>
<span id="cb11-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pointer to initial element</span></span>
<span id="cb11-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// pointer to one beyond the last element</span></span></code></pre></div>
<p>Taking a pointer to the element one beyond the end of an array is guaranteed to work. This is important for many algorithms. However, since such a pointer does not in fact point to an element of the array, it should not be used for dereferencing, reading or writing values.</p>
<p>The result of taking the address of the element before the initial element or beyond one-past-the-last element is undefined and should be avoided.</p>
<p>For example:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// int* p4 = v - 1;    // before the beginning, undefined</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// int* p5 = v + 7;    // beyond the end, undefined</span></span></code></pre></div>
</section>
<section id="navigating-arrays" class="level2">
<h2 class="anchored" data-anchor-id="navigating-arrays">Navigating arrays</h2>
<p>Efficient and elegant access to arrays and similar data-structures is the key to many algorithms. Access can be achieved either through pointer to an array plus an integer index or through a pointer to an element.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> fi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb13-6">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> </span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> fp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb13-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Subscripting a built-in array is defined in terms of pointer operations <code>+</code> and <code>*</code>. For every built-in array <code>a</code> and integer <code>j</code> within the range of <code>a</code>, we have:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb14-1">a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(&amp;</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]+</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*(</span>j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>It usually surprises people to find that <code>a[j] == j[a]</code>. For example, <code>3["Texas"] == "Texas"[3] == 'a'</code>. Although such cleverness has no place in production code, from an interview perspective its good to know these low-level equivalences.</p>
<p>The result of applying the arithmetic operators <code>+</code>, <code>-</code>, <code>++</code> or <code>--</code> to pointers depends on the type of the object pointed to. When an arithmetic operator is applied to a pointer <code>p</code> of type <code>T*</code>, <code>p</code> is assumed to point to an element of an array of objects of type <code>T</code>; <code>p+1</code> points to the next element of that array, <code>p-1</code> points to the previous element. This implies that the integer value of <code>p+1</code> will be <code>sizeof(T)</code> larger than the integer value of <code>p</code>.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb15-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb15-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> byte_diff<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">reinterpret_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>q<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">reinterpret_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-6"></span>
<span id="cb15-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> vi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb15-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb15-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> byte_diff<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>vi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>vi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" bytes diff"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> byte_diff<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">],</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>vs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">])</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" bytes diff"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/rhqYbzr9f">Compiler Explorer</a></p>
<p>Subtraction of pointers is defined only when both pointers point to elements of the same array. When subtracting a <code>p</code> pointer from another pointer <code>q</code>, <code>q-p</code> is the number of array elements in the sequence <code>[p:q)</code>. One can add an integer to a pointer or subtract an integer from a pointer, in both cases, the result is a pointer value. If that value does not point to an element of the same array as the original array or one beyond, the result of using that value is UB.</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb16-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb16-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> v2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>v1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// i1 = 2</span></span>
<span id="cb16-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//int i2 = &amp;v1[5] - &amp;v2[3];   // UB</span></span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// p1 = &amp;v2[2]</span></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//int* p2 = v2 - 2;   // UB</span></span></code></pre></div>
<p>Complicated pointer arithmetic is usually unnecessary and best avoided. Addition of pointers makes no sense and is not allowed.</p>
<p>Arrays are not self-describing because the number of elements of an array is not guaranteed to be stored with the array. This implies that to traverse an array that does not contain a terminator, the way C-style strings do, we must somehow supply the elements. ## Precedence of operators</p>
<p>The precedence of operators in C++ is:</p>
<table class="table">
<thead>
<tr class="header">
<th>Operators</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>[]</code> <code>()</code> <code>.</code> <code>-&gt;</code></td>
<td>Postfix operators, left-to-right</td>
</tr>
<tr class="even">
<td><code>x++</code> <code>x--</code></td>
<td>Postfix, left-to-right</td>
</tr>
<tr class="odd">
<td><code>++x</code> <code>--x</code> <code>*</code> <code>&amp;</code></td>
<td>Prefix, right-to-left</td>
</tr>
<tr class="even">
<td><code>*</code> <code>/</code> <code>%</code></td>
<td>Multiplicative</td>
</tr>
<tr class="odd">
<td><code>+</code> <code>-</code></td>
<td>Additive</td>
</tr>
</tbody>
</table>
<section id="example-1" class="level3">
<h3 class="anchored" data-anchor-id="example-1">Example 1</h3>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb17-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb17-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb17-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// x = 10, p now points to arr[1]</span></span></code></pre></div>
<p>Consider the expression <code>*ptr++</code> . Post-increment <code>++</code> has a higher precedence than the dereference operator <code>*</code>, so it’s parsed as <code>*(ptr++)</code>. <code>ptr++</code> returns the old value that <code>ptr</code> pointed to, but moves <code>ptr</code> forward at a future time. ### Example 2</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb18-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*++</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// p moves to arr[1], then x = 20</span></span></code></pre></div>
<p>Consider the expression <code>*++p</code>. Both the dereference operator <code>*</code> and pre-increment <code>++</code> are prefix operators and have the same precedence. Since, they have right-to-left associativity, we read them right-to-left. <code>*++p</code> is parsed as <code>*(++p)</code>. ### Example 3</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb19-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb19-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++*</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// arr[0] becomes 11, p unchanged</span></span></code></pre></div>
<p>Consider the expression <code>++*p</code>. Using right-to-left associativity rule, we first dereference and then increment. ## Challenge puzzle</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb20-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-4"></span>
<span id="cb20-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// What are the values of:</span></span>
<span id="cb20-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a) p - q</span></span>
<span id="cb20-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// b) q - p</span></span>
<span id="cb20-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// c) *p++</span></span>
<span id="cb20-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// d) *++p (after the previous operation)</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/cGvEnnEd3">Compiler Explorer</a> <code>p - q</code> evaluates to <img src="https://latex.codecogs.com/png.latex?-2">, <code>q - p</code> evaluates to <img src="https://latex.codecogs.com/png.latex?2">.</p>
</section>
</section>
<section id="challenge-puzzle-2" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle-2">Challenge puzzle</h2>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-4"></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// What happens with each line?</span></span>
<span id="cb21-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">nullptr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Can you still access x? What's its value?</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/7n8zbd9c9">Compiler Explorer</a> After the line <code>*pp=20</code>, the variable <code>x</code> has been assigned a new value <code>20</code>. <code>*p = nullptr</code> will reset the value in pointer variable <code>p</code> to a <code>nullptr</code>. We cannot access the contents of the variable <code>x</code> through the pointer variables <code>p</code> and <code>pp</code>.</p>
</section>
<section id="challenge-puzzle-3" class="level2">
<h2 class="anchored" data-anchor-id="challenge-puzzle-3">Challenge Puzzle</h2>
<p>Observe the code snippet below. What is printed?</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Headers</span></span>
<span id="cb22-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb22-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb22-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AAAAA"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BBBBB"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCCCC"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DDDDD"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> </span>
<span id="cb22-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> sptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> </span>
<span id="cb22-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">***</span> pp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-7">    pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>pp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**++</span>pp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> </span>
<span id="cb22-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Initially, <code>pp</code> is incremented to point to the address of <code>sptr[1]</code>.</p>
<p>In the order of precedence, from high to low, we have:</p>
<ol type="1">
<li><code>*</code> dereference and <code>++</code> pre-increment operator (Right-to-left)</li>
<li><code>+</code> - Addition binary operator (Left-to-right)</li>
</ol>
<p>So, <code>**++pp + 2</code> would be parsed as <code>*(*(+pp)) + 2</code>. Thus, <code>pp</code> is now incremented to point to the address of <code>str+1</code>. Then, it is dereferenced twice to yield the string literal <code>BBBBB</code> which is a <code>char*</code>. Finally, an offset of <code>2</code>, will print the text <code>BBB</code>. ## Passing C-style arrays</p>
<p>Arrays cannot be directly passed by value. Instead, an array is as a pointer to its first element.</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb23-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> vec_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb23-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>  </span>
<span id="cb23-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb23-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb23-6">        sum_of_squares <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> vec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb23-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb23-8">    </span>
<span id="cb23-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb23-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Multi-dimensional arrays can be passed in a similar fashion.</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> frobenius_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>num_rows<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>size_t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>num_cols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span> sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span>  </span>
<span id="cb24-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb24-7">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-8">            sum_of_squares <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> mat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">][</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb24-9">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-11">    </span>
<span id="cb24-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sqrt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>sum_of_squares<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>The C++ language supports two families of indirections: pointers and references. A reference can be seen as an alias for an existing entity. We deliberately did not use the word object, since one could refer to a function and we already know that a function is not an object.</p>
<p>Pointers are objects. As such they occupy storage. References, on the other hand, are not objects, they do not use any storage of their own.</p>
<p>The <code>sizeof</code> operator applied to a reference, will yield the size of whatever it refers to. In C++, a reference is always bound to an object and remains bound to that object until the end of the reference’s lifetime. A pointer, on the other hand, can point to numerous distinct objects during its lifetime.</p>
<p>Another difference between pointers and references is that, contrary to the situation, there is no such thing as reference arithmetic. This makes references safer than pointers.</p>
</section>
<section id="understanding-the-fundamental-properties-of-objects" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-fundamental-properties-of-objects">Understanding the fundamental properties of objects</h2>
<p>We saw earlier that in C++, an object has a type and an address. It occupies a region of storage from the beginning of it’s construction to the end of it’s destruction.</p>
<section id="object-lifetime" class="level3">
<h3 class="anchored" data-anchor-id="object-lifetime">Object lifetime</h3>
<p>In C++, generally speaking, automatic objects are destructed at the end of their scope in a well-defined order. Static(global) objects are destructed on program termination in a somewhat well-defined order. Dynamically allocated objects are destroyed when your program says so.</p>
<p>Let’s examine some aspects of object lifetime with the following very simple program:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb25-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;string&gt;</span></span>
<span id="cb25-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb25-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;format&gt;</span></span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-7">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>string_view<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span>s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X::X(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-11"></span>
<span id="cb25-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb25-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>print<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~X::X() for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb25-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-16"></span>
<span id="cb25-17">X glob<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"glob"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-18"></span>
<span id="cb25-19"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb25-20">    X xg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"g()"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb25-22"></span>
<span id="cb25-23"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb25-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb25-25">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p0"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maybe_unused</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// will leak</span></span>
<span id="cb25-27">    X xmain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main()"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb25-28">    g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb25-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> p0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// oops, forgot to delete p1</span></span>
<span id="cb25-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-32"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/jEo3anfso">Compiler Explorer</a></p>
<p>When executed, the program will print the following:</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb26-1">X::X(glob)</span>
<span id="cb26-2">X::X(p0)</span>
<span id="cb26-3">X::X(p1)</span>
<span id="cb26-4">X::X(main())</span>
<span id="cb26-5">X::X(g())</span>
<span id="cb26-6">~X::X() for g()</span>
<span id="cb26-7">~X::X() for p0</span>
<span id="cb26-8">~X::X() for main()</span>
<span id="cb26-9">~X::X() for glob</span></code></pre></div>
<p>The fact that the number of constructors and destructors do not match is a sign that we did something wrong. More specifically, in this example, we manually created an object (pointed to by <code>p1</code>) with the operator <code>new</code> but never manually destructed that object afterward. This is a <em>memory leak</em>.</p>
</section>
</section>
<section id="object-size-alignment-and-padding" class="level2">
<h2 class="anchored" data-anchor-id="object-size-alignment-and-padding">Object size, alignment and padding</h2>
<p>Since each object occupies storage, the space associated with an object is an important(if low-level) property of C++ types. For example, look at the following code:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// fporward declaraion: there will be a class B</span></span>
<span id="cb27-2">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// at some point in the future</span></span>
<span id="cb27-3">            </span>
<span id="cb27-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// fine, we know what NB is, even if don't know the details yet,</span></span>
<span id="cb27-5">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// and all object addresses are of the same size</span></span>
<span id="cb27-6"></span>
<span id="cb27-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// oops! This is the definition of class D. To determine</span></span>
<span id="cb27-8">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// sizeof(D), we have to know how big sizeof(B) is and what</span></span>
<span id="cb27-9">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a B object contains since a D is a B</span></span></code></pre></div>
<p>In the above example, trying to define the <code>D</code> class would not compile. This is because in order to create a<code>D</code> object, the compiler needs to reserve enough space for a <code>D</code> object, but a <code>D</code> object is also a <code>B</code> object and as such we cannot kn ow the size of a <code>D</code> object without knowing the size of <code>B</code> object.</p>
<p>The size of an object or equivalently of a type can be obtained through the <code>sizeof</code> operator. This operator yields a compile-time, non-zero unsigned integral value corresponding to the number of bytes required to store an object.</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb28-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb28-2"></span>
<span id="cb28-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb28-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb28-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// a  char precisely occupies one byte of storage, per</span></span>
<span id="cb28-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standard wording</span></span>
<span id="cb28-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb28-8"></span>
<span id="cb28-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> Tiny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb28-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// all C++ types occupy non-zero bytes of storage by </span></span>
<span id="cb28-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// definition, even if they are empty like type Tiny</span></span>
<span id="cb28-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Tiny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb28-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>In the preceding example, the <code>Tiny</code> class is empty because it has no data-member. A class could have member functions and still be empty.</p>
<p>A C++ object always occupies atleast one byte of storage, even in the case of empty classes such as <code>Tiny</code>. That’s because if the object’s size was zero, that object could be at the same memory location as its immediate neighbor, which would be somewhat hard to reason about.</p>
<p>C++ differs from many other languages in that it does not standardize the size of all fundamental types. For example, <code>sizeof(int)</code> can yield different values depending on the compiler and the platform. Still there are rules concerning the size of objects:</p>
<ul>
<li>The size reported by operator <code>sizeof</code> for objects of type <code>signed char</code>, <code>unsigned char</code> and <code>char</code> is <img src="https://latex.codecogs.com/png.latex?1">, and the same goes for <code>sizeof(std::byte)</code> as each of these types can be used to represent a single byte.</li>
<li>The standard specifies a minimum width for the fundamental types:
<ul>
<li>Signed Integer Types : Signed integers are represented in two’s complement form. The rules of binary arithmetic are the same for two’s complement as the standard base-2 representation. Hence, the same binary adder hardware circuits can be used for signed integer addition.</li>
</ul></li>
</ul>
<table class="table">
<thead>
<tr class="header">
<th>Type</th>
<th>Minimum width <img src="https://latex.codecogs.com/png.latex?N"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>signed char</code></td>
<td><img src="https://latex.codecogs.com/png.latex?1"> byte</td>
</tr>
<tr class="even">
<td><code>short</code></td>
<td><img src="https://latex.codecogs.com/png.latex?2"> bytes</td>
</tr>
<tr class="odd">
<td><code>int</code></td>
<td><img src="https://latex.codecogs.com/png.latex?2"> bytes</td>
</tr>
<tr class="even">
<td><code>long</code></td>
<td><img src="https://latex.codecogs.com/png.latex?4"> bytes</td>
</tr>
<tr class="odd">
<td><code>long long</code></td>
<td><img src="https://latex.codecogs.com/png.latex?8"> bytes</td>
</tr>
</tbody>
</table>
<ul>
<li>For each of the signed integer types, there exists the corresponding, but different, <em>standard unsigned integer</em> types. An unsigned integer type has the same width <img src="https://latex.codecogs.com/png.latex?N"> as the corresponding unsigned integer type. The range of representable values for an unsigned type is <img src="https://latex.codecogs.com/png.latex?0"> to <img src="https://latex.codecogs.com/png.latex?2%5EN%20-%201">. Arithmetic for the unsigned type is performed modulo <img src="https://latex.codecogs.com/png.latex?2%5EN">. Unsigned arithmetic does not overflow. Each value <img src="https://latex.codecogs.com/png.latex?x"> of an unsigned integer type with <img src="https://latex.codecogs.com/png.latex?N"> has a unique representation <img src="https://latex.codecogs.com/png.latex?x%20=%20x_0%202%5E0%20+%20x_1%202%5E1%20+%20%5Cldots%20+%20x_%7BN-1%7D2%5E%7BN-1%7D">, where each coefficient <img src="https://latex.codecogs.com/png.latex?x_i"> is either <img src="https://latex.codecogs.com/png.latex?0"> or <img src="https://latex.codecogs.com/png.latex?1">: this is called the base-2 representation of <img src="https://latex.codecogs.com/png.latex?x">.</li>
<li>The size occupied by an object of any <code>struct</code> or <code>class</code> cannot be less than the sum of the size of its data-members.</li>
</ul>
<section id="empty-base-class-optimization-ebco" class="level3">
<h3 class="anchored" data-anchor-id="empty-base-class-optimization-ebco">Empty base class optimization (EBCO)</h3>
<p>Consider the following code snippet:</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb29-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// private inheritance</span></span>
<span id="cb29-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb29-5"></span>
<span id="cb29-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb29-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb29-8">    Y y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb29-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/desWebdYE">Compiler Explorer</a> Since the base class is empty, and objects of the derived class <code>Y</code> occupy atleast one byte of storage, the base class can be flattened, when creating objects of the derived class <code>Y</code>. Note that, since the presence of <code>X</code> in <code>Y</code> is an implementation detail, not something that participates in the interface of <code>class Y</code>, I used private inheritance.</p>
</section>
</section>
<section id="alignment" class="level2">
<h2 class="anchored" data-anchor-id="alignment">Alignment</h2>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb30-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 1 byte</span></span>
<span id="cb30-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 2 bytes</span></span>
<span id="cb30-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 2 bytes</span></span>
<span id="cb30-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> ll<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// atleast 8 bytes</span></span>
<span id="cb30-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb30-7"></span>
<span id="cb30-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb30-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb30-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>We know that <code>sizeof(X)</code> will be atleast <img src="https://latex.codecogs.com/png.latex?13"> bytes. In practice however, <code>sizeof(X)</code> is likely to be equal to <img src="https://latex.codecogs.com/png.latex?32"> bytes. This might seem surprising at first, but it’s a logical consequence of something called <strong>alignment</strong>.</p>
<p>The alignment of an object tells us where that object can be placed in memory. The <code>char</code> type has an alignment of <img src="https://latex.codecogs.com/png.latex?1">, and as such one can place a <code>char</code> object literally anywhere (as long as one can access that memory). <code>short</code> has an alignment of <code>2</code>. If a type has an alignment <img src="https://latex.codecogs.com/png.latex?n">, then objects of that type must be placed at an address that is a multiple of <img src="https://latex.codecogs.com/png.latex?n">.</p>
<p>The alignment has to be a strictly positive power of <img src="https://latex.codecogs.com/png.latex?2">.</p>
<p>The C++ language offers two operators related to alignment: - The <code>alignof</code> operator, which yields the natural alignment of a type <code>T</code> or of an object of that type. - The <code>alignas</code> operator, which lets the programmers impose the alignment of an object. this is often useful, when playing tricks with memory(as we will), or when interfacing wit with exotic hardware. Of course, <code>alignas</code> can only reasonably increase the natural alignment of a type <code>T</code>, not reduce it.</p>
<p>For some fundamental type <code>T</code>, we can expect the assertion <code>sizeof(T)</code> is equal to <code>alignof(T)</code> to hold, but that assertion does not generalize to composite types. For example, consider again the <code>struct X</code>:</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb31-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(c) == 1</span></span>
<span id="cb31-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">short</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(s) == 2</span></span>
<span id="cb31-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(i) == 4 (most probable)</span></span>
<span id="cb31-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">long</span> ll<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignof(ll) == 8 (most probable)</span></span>
<span id="cb31-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Generally, speaking for a composite type, the alignment will correspond to the worst alignment of the data members. Here, worst means biggest. For <code>struct X</code>, the worst-aligned data member is type <code>long long</code>, and as such <code>X</code> objects will be aligned on <img src="https://latex.codecogs.com/png.latex?8">-byte boundaries, so it can be placed at an address <img src="https://latex.codecogs.com/png.latex?8">, <img src="https://latex.codecogs.com/png.latex?16">, <img src="https://latex.codecogs.com/png.latex?24"> and so forth. It is highly probable <code>sizeof(X) == 16</code> bytes.</p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb32-1">Offset  Content</span>
<span id="cb32-2">------  -------</span>
<span id="cb32-3">  0     | c  |  (char, 1 byte)</span>
<span id="cb32-4">        +----+</span>
<span id="cb32-5">  1     |pad |  (padding, 1 byte)</span>
<span id="cb32-6">        +----+</span>
<span id="cb32-7">  2     | s  |  (short, 2 bytes)</span>
<span id="cb32-8">  3     |    |</span>
<span id="cb32-9">        +----+</span>
<span id="cb32-10">  4     | i  |  (int, 4 bytes)</span>
<span id="cb32-11">  5     |    |</span>
<span id="cb32-12">  6     |    |</span>
<span id="cb32-13">  7     |    |</span>
<span id="cb32-14">        +----+</span>
<span id="cb32-15">  8     | ll |  (long long, 8 bytes)</span>
<span id="cb32-16">  9     |    |</span>
<span id="cb32-17"> 10     |    |</span>
<span id="cb32-18"> 11     |    |</span>
<span id="cb32-19"> 12     |    |</span>
<span id="cb32-20"> 13     |    |</span>
<span id="cb32-21"> 14     |    |</span>
<span id="cb32-22"> 15     |    |</span>
<span id="cb32-23">        +----+</span></code></pre></div>
<p>Now, that we know about alignment, just changing the order of the elements in a <code>struct</code> can affect memory consumption. We should always code <code>struct</code>s in the order of largest to smallest data-members.</p>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/objects-pointers-and-references/index.html</guid>
  <pubDate>Fri, 12 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/objects-pointers-and-references/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>The C++ casts</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/the_cpp_casts/index.html</link>
  <description><![CDATA[ 




<section id="the-c-casts" class="level1">
<h1>The C++ casts</h1>
<p>Traditionally, C++ has supported four ways to perform those explicit type conversions we call casts - <code>static_cast</code>, <code>dynamic_cast</code>, <code>const_cast</code> and <code>reinterprete_cast</code>. C++11 added a fifth one <code>duration_cast</code>. Finally, C++20 introduced a sixth case <code>bit_cast</code>.</p>
<section id="your-best-friend-most-of-the-time---static_cast" class="level2">
<h2 class="anchored" data-anchor-id="your-best-friend-most-of-the-time---static_cast">Your best friend (most of the time) - <code>static_cast</code></h2>
<p>The best, most efficient tool in our type-casting toolset is <code>static_cast</code>. <code>static_cast</code> performs compile-time conversion between related types. It is mostly safe, costs essentially nothing in most cases, and can be used in a <code>constexpr</code> context.</p>
<p>You can also use <code>static_cast</code> in situations involving potential risks, such as converting an <code>int</code> to a <code>float</code> or vice versa. In the latter case, it explicitly acknowledges the loss of the decimal part.</p>
<p>You can can use <code>static_cast</code> to cast a pointer or a reference from a derived class to one of its direct or indirect base classes (as long as there is no ambiguity), which is totally safe.</p>
<p>Casting from a base class to a derived class is extremely risky if the cast is incorrect, as it does not perform runtime checks.</p>
<p>Here are some examples:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;print&gt;</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> </span>
<span id="cb1-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">default</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*...*/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb1-12">    X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">double</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){}</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*){}</span></span>
<span id="cb1-16"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*){}</span></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb1-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.14159</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok, no warning</span></span>
<span id="cb1-22"></span>
<span id="cb1-23">    X x0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-24"></span>
<span id="cb1-25">    X x1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compiles, </span></span>
<span id="cb1-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// probably warns (narrowing conversion)</span></span>
<span id="cb1-27"></span>
<span id="cb1-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//X x2{3.5, 0}; // does not compile</span></span>
<span id="cb1-29">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// narrowing is not allowed within braces</span></span>
<span id="cb1-30"></span>
<span id="cb1-31">    X x3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-32"></span>
<span id="cb1-33">    D0 d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// illegal, no base-derived relatonship between D0 and D1</span></span>
<span id="cb1-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//D1* d1 = static_cast&lt;D1*&gt;(&amp;d0);</span></span>
<span id="cb1-36"></span>
<span id="cb1-37">    B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(&amp;</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// f(*b)                         // illegal</span></span>
<span id="cb1-39">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span>         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb1-40">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span>         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compiles, but very dangerous</span></span>
<span id="cb1-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-42"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/Y7684n73e">Compiler Explorer</a> Pay special attention to the last use of <code>static_cast</code> of the preceding example - converting from a base class to one of its derived classes is appropriately done with <code>static_cast</code>. However, you must ensure that the conversion leads to an object of the chosen type, as there is no run-time verification made of the validity of that conversion. Only compile-time checks are done.</p>
</section>
<section id="a-sign-somethings-wrong---dynamic_cast" class="level2">
<h2 class="anchored" data-anchor-id="a-sign-somethings-wrong---dynamic_cast">A sign something’s wrong - <code>dynamic_cast</code></h2>
<p>There will be cases where you have a pointer or a reference to an object of some class type and that happens to be different (but related to) the type needed. This often happens - for example, in game engines where most classes derive from some <code>Component</code> base and functions tend to take <code>Component*</code> arguments but need to access members from an object of the derived class they expect.</p>
<p>The main problem here is, typically that the function’s interface is wrong - it accepts arguments of types that are insufficiently precise. Still, we all have software to deliver, and sometimes we need to make things work even though we made some choices along the way, that we will revisit later on.</p>
<p>The safe way to do such casts is <code>dynamic_cast</code>. This cast lets you convert a pointer or reference from one type to another, related type in a way that lets you test whether the conversion worked or not; with pointers, an incorrect conversion yields <code>nullptr</code>, whereas with references, an incorrect conversion throws <code>std::bad_cast</code>. The relatedness of types with <code>dynamic_cast</code> is not limited to base-derived relationships and includes casting from one base to another base in a multiple inheritance design. However, note that in most cases, <code>dynamic_cast</code> requires that the expression that is cast to another type is of the polymorphic type, in the sense that it must have atleast one <code>virtual</code> member function.</p>
<p>Here are some examples:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">default</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">virtual</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>B1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">default</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-15">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">override</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-19"></span>
<span id="cb2-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> B1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-22">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">override</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-25"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span> D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{};</span></span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// g has the wrong interfacce: it accepts a D0&amp; but </span></span>
<span id="cb2-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// tries to use it as a D1&amp;, which makes sense if the </span></span>
<span id="cb2-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// referred object is publiclly D0 and D1 (for example)</span></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// class D</span></span>
<span id="cb2-37"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>D0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-38">    D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> d1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">dynamic_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&gt;(</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//throws if wrong</span></span>
<span id="cb2-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-40"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-41"></span>
<span id="cb2-42"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb2-43"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-44">    D d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-45">    f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok</span></span>
<span id="cb2-46">    g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ok, D is a D0</span></span>
<span id="cb2-47">    D0 d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// calls f(nullptr) as &amp;d0 does not point to a D</span></span>
<span id="cb2-49">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> f<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">dynamic_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*&gt;(&amp;</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-50"></span>
<span id="cb2-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-52">        g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compile, but will throw std::bad_cast</span></span>
<span id="cb2-53">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">catch</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>bad_cast<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb2-54">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cerr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> &lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nice try!"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-55">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-57"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p><a href="https://compiler-explorer.com/z/fdq4qYaKE">Compiler Explorer</a></p>
<p>Note that, even though this example displays a message when <code>std::bad_cast</code> ism thrown, this is in no way what we could call exception handling; we did not solve the problem, and code execution continues in a potentially corrupt state, which could make things worse in more serious code. In a toy example such as this, just letting the code fail and stop executing would also have been a more reasonable choice.</p>
<p>Note that, the use of <code>dynamic_cast</code> requires binaries to be compiled with <strong>runtime type information(RTTI)</strong> included, leading to larger binaries. Unsurprisingly; due to these costs, some application domains will tend to avoid this cost.</p>
</section>
<section id="playing-tricks-with-safety---const_cast" class="level2">
<h2 class="anchored" data-anchor-id="playing-tricks-with-safety---const_cast">Playing tricks with safety - <code>const_cast</code></h2>
<p>Neither <code>static_cast</code> nor <code>dynamic_cast</code>, can change <em>cv</em>-qualifiers of an expression. To do this, you need <code>const_cast</code>. With <code>const_cast</code>, you can add or remove the <code>const</code> or <code>volatile</code> qualifiers from an expression. As you might guess, this only makes sense on a pointer or a reference.</p>
</section>
<section id="believe-me-compiler---reinterprete_cast" class="level2">
<h2 class="anchored" data-anchor-id="believe-me-compiler---reinterprete_cast"><em>Believe me compiler</em> - <code>reinterprete_cast</code></h2>
<p>Sometimes, you just have to make the compiler believe you. For example, knowing <code>sizeof(int) == 4</code> on your platform, you might want to treat <code>int</code> as <code>char[4]</code> to interoperate with an existing API that expects that type. Note that, you should ensure that this property holds (maybe through <code>static_assert</code>), rather than relying on the belief that the property holds on all platforms (it does not).</p>
<p>That’s what <code>reinterpret_cast</code> gives you - the ability to cast a pointer of some type to a pointer of an unrelated type. This can be used in situations where you seek to benefit from pointer-interconvertibility, just as this this can be used to lie to the type system in several rather dangerous and non-portable ways.</p>
<p>Also note that, <code>reinterpret_cast</code> only changes the type associated with an expression - for example, it does not perform the slight address adjustments, that <code>static_cast</code> would make when converting from a derived class to a base class in multiple inheritance situations.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> B0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span></code></pre></div>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://amzn.eu/d/7bRAPXQ">C++ Memory Management</a> by <em>Patrice Roy</em>, Packt Publishers</li>
</ul>


</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/the_cpp_casts/index.html</guid>
  <pubDate>Fri, 12 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/the_cpp_casts/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Lock-free SPSC Queue</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/spsc_lockfree_queue/index.html</link>
  <description><![CDATA[ 




<section id="designing-the-spsc_queue-data-structure" class="level1">
<h1>Designing the <code>spsc_queue</code> data-structure</h1>
<p>I would like to present my implementation for an SPSC lock-free queue in this blog-post.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext itikz</span></code></pre></div>
</div>
<section id="what-makes-an-operation-atomic" class="level2">
<h2 class="anchored" data-anchor-id="what-makes-an-operation-atomic">What makes an operation atomic?</h2>
<p>When a programmer says that an operation is atomic, there are atleast two properties to which they might be referring:</p>
<ul>
<li><em>Non-preemptible</em> - The operation can’t be pre-empted in the middle (e.g.&nbsp;by another thread).</li>
<li><em>Synchronizable</em> - The results of the operation can be made visible to other threads of execution in a controllable fashion.</li>
</ul>
</section>
<section id="setup---how-the-queue-works" class="level2">
<h2 class="anchored" data-anchor-id="setup---how-the-queue-works">Setup - How the queue works</h2>
<ul>
<li>Bounded size. The elements are stored in a fixed-length buffer.</li>
<li>Single-producer, Single-consumer applications.</li>
<li>Circular buffer. The <code>head</code> and <code>tail</code> cursors after reaching the maximum index of the buffer wrap around to the start of the buffer.</li>
</ul>
<p>The <code>spsc_queue</code> type contains a fixed-length array - a buffer to store the elements of the queue and it also contains two indices into the array:</p>
<ul>
<li><code>m_head</code> - The index of the <code>front</code> element, if any.</li>
<li><code>m_tail</code> - The index where a new element would be inserted at the back of the queue.</li>
</ul>
<p>In an initially empty container, both the <code>m_head</code> and <code>m_tail</code> start at zero:</p>
<div class="{text-center}">
<div class="cell" data-execution_count="2">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb2-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb2-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb2-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (Empty)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6">    </span>
<span id="cb2-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb2-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-9">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb2-10">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11">    }</span>
<span id="cb2-12">    </span>
<span id="cb2-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb2-14">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-15">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb2-16">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-17">    }</span>
<span id="cb2-18">    </span>
<span id="cb2-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Pointers</span>
<span id="cb2-20">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-21">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-22">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.6</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-23">    </span>
<span id="cb2-24">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb2-25">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>) {Status: Empty (m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> m\_tail)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-26">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-3-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Then I have a <code>spsc_queue::push_back()</code> function that is used to append a new element to the queue. If the queue is not full, this operation should succeed, and it will go ahead and write a new element to the tail location and move the <code>m_tail</code> index forward.</p>
<p>For example, if do <code>push_back(1)</code> the queue looks something like this.</p>
<div class="{text-center}">
<div class="cell" data-execution_count="3">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb3-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb3-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb3-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> element)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-6">    </span>
<span id="cb3-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb3-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-10">    </span>
<span id="cb3-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb3-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb3-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-15">    }</span>
<span id="cb3-16">    </span>
<span id="cb3-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb3-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb3-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-21">    }</span>
<span id="cb3-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill first cell</span>
<span id="cb3-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-24">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-25">    </span>
<span id="cb3-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb3-27">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-28">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-29">    </span>
<span id="cb3-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb3-31">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.8</span>) {Status: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> element (m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> m\_head)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-32">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-4-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Here’s the queue with a few more elements added:</p>
<div class="{text-center}">
<div class="cell" data-execution_count="4">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb4-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb4-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb4-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> elements)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-6">    </span>
<span id="cb4-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb4-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-10">    </span>
<span id="cb4-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb4-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb4-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-15">    }</span>
<span id="cb4-16">    </span>
<span id="cb4-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb4-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb4-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-21">    }</span>
<span id="cb4-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill cells <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb4-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-24">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-25">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-26">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-27">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-28">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-29">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-30">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-31">    </span>
<span id="cb4-32">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb4-33">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-34">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-35">    </span>
<span id="cb4-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb4-37">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.8</span>) {Status: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> elements (m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> m\_head)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-38">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-5-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Once I have got some elements into the queue, I can go ahead and call the <code>pop()</code> function, which is going to try to read and remove the first element from the front of the queue.</p>
<p>If the queue isn’t empty, it :</p>
<ul>
<li>Advances <code>m_head</code> thereby implicitly discard the element at the front of the queue</li>
</ul>
<div class="{text-center}">
<div class="cell" data-execution_count="5">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb5-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb5-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb5-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> elements)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-6">    </span>
<span id="cb5-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb5-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-10">    </span>
<span id="cb5-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb5-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb5-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-15">    }</span>
<span id="cb5-16">    </span>
<span id="cb5-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb5-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb5-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-21">    }</span>
<span id="cb5-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill cells <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb5-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-24">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-25">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-26">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-27">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-28">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-29">    </span>
<span id="cb5-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb5-31">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-32">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-33">    </span>
<span id="cb5-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Status</span>
<span id="cb5-35">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.8</span>) {Status: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> elements (m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> m\_head)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-36">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>) {Note: Index <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> now <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stale"</span> (logically removed)}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-37">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-6-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>Most of the time, when we advance an index like this, it is a simple increment. But, as I stated earlier, the buffer slots are used in a a circular fashion. If that increment would place that <code>index</code> out of bounds, it wraps around to the zeroeth slot (that’s what makes it a ring) of the queue buffer.</p>
<div class="{text-center}">
<div class="cell" data-execution_count="6">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>itikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>packages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tikz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>tikz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>libraries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arrows.meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span>implicit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>standalone</span>
<span id="cb6-2">\begin{tikzpicture}[font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>\small\ttfamily]</span>
<span id="cb6-3">    \fill[white] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Title</span>
<span id="cb6-5">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {\textbf{SPSC Ring Buffer (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span> elements)}}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-6">    </span>
<span id="cb6-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_head pointer (above)</span>
<span id="cb6-8">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>south] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) {m\_head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-9">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-10">    </span>
<span id="cb6-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Index labels</span>
<span id="cb6-12">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {Index:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-13">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb6-14">        \node at (\i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {\i}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-15">    }</span>
<span id="cb6-16">    </span>
<span id="cb6-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Buffer cells</span>
<span id="cb6-18">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>east] at (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {Buffer:}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-19">    \foreach \i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,...,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>} {</span>
<span id="cb6-20">        \draw (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (\i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-21">    }</span>
<span id="cb6-22">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> Fill cells <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span></span>
<span id="cb6-23">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-24">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-25">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-26">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-27">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-28">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-29">    \fill[lightgray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>) rectangle (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-30">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-31">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-32">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-33">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-34">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-35">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-36">    \node at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-37">    </span>
<span id="cb6-38">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> m_tail pointer (below)</span>
<span id="cb6-39">    \draw[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span>, thick] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-40">    \node[anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>north] at (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>) {m\_tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-41">\end{tikzpicture}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/index_files/figure-html/cell-7-output-1.svg" class="img-fluid"></p>
</div>
</div>
</div>
<p>As we’ll see, it turns out that the indices <code>m_head</code> and <code>m_tail</code> will need to be <code>atomic</code> objects. We’ll understand why this is the case.</p>
<p>The storage for a ring buffer consists of a fixed-capacity array of elements and the indices for <code>head</code> and <code>tail</code>. We shall write <code>spsc_queue</code> as a templated class having the capacity as a template parameter.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The capacity must be a power of two.</span></span>
<span id="cb7-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb7-6">    T <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb7-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb7-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* ... */</span></span>
<span id="cb7-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>We would like to enforce the capacity to be a power of <img src="https://latex.codecogs.com/png.latex?2"> for efficiency reasons. Remember, that with this design, there’s always atleast one unused element in the array, because <code>m_head == m_tail + 1</code> is the queue full condition. So, the effective capacity equals <code>capacity - 1</code>.</p>
</section>
<section id="the-class-interface" class="level2">
<h2 class="anchored" data-anchor-id="the-class-interface">The <code>class</code> interface</h2>
<p>Here is the class interface:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The capacity must be a power of two.</span></span>
<span id="cb8-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb8-6">    T <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb8-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-10">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-11">        spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb8-12">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-13">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> pop_front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb8-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
</section>
</section>
<section id="push_back-and-pop_front-take-1" class="level1">
<h1><code>push_back()</code> and <code>pop_front()</code> take 1</h1>
<p>Here’s a first attempt at implementing <code>pop()</code>:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(++</span>idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_size</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-4">        idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> pop_front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb9-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>is_empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb9-12">        v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb9-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb9-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-19"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Unfortunately, this section of code for advancing <code>m_head</code> has a couple of problems. The increment of <code>m_head</code> could be pre-empted in the middle. And that’s a problem because the <code>push</code> thread also reads the <code>m_head</code> index in order to figure out, whether the queue is full.</p>
<p>Note that, <code>push_back()</code> is always called by the producer thread while <code>pop_front()</code> is always called by the consumer thread.</p>
<p>That’s why, the <code>spsc_queue</code>’s design depends on:</p>
<ul>
<li>Reading and writing the indices non-pre-emptively.</li>
<li>Having only one producer thread and one consumer thread.</li>
</ul>
<p>if the consumer thread is pre-empted while writing <code>m_head</code>, the producer thread may read a half-written nonsense value.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb10-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()){</span></span>
<span id="cb10-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb10-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb10-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb10-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>If the producer thread is pre-empted while writing <code>m_tail</code>, the consumer thread may read a half-written nonsense value.</p>
<section id="using-atomic-indices" class="level2">
<h2 class="anchored" data-anchor-id="using-atomic-indices">Using atomic indices</h2>
<p>This is my implementation for SPSC lock-free queue with atomic indices.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;atomic&gt;</span></span>
<span id="cb11-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;thread&gt;</span></span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">template</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">typename</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb11-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">private</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb11-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The capacity must be a power of two.</span></span>
<span id="cb11-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_assert</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>    </span>
<span id="cb11-9">    T <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alignas</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hardware_destructive_interference_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alignas</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>hardware_destructive_interference_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>atomic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-12"></span>
<span id="cb11-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">public</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb11-14">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">using</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-15">        spsc_queue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb11-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb11-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-18">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb11-20"></span>
<span id="cb11-21">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_empty<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-22">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb11-23">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-25"></span>
<span id="cb11-26">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_full<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb11-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-29"></span>
<span id="cb11-30">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> get_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb11-31">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-32">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-33"></span>
<span id="cb11-34">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> get_capacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(){</span></span>
<span id="cb11-35">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-36">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-37"></span>
<span id="cb11-38">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodiscard</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]]</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> current_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-39">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> current_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>capacity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-41">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> next_idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-42">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-43"></span>
<span id="cb11-44">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> push_back<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-45">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> tail <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-46">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_write_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-47">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>next_write_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_acquire<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb11-48">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-49"></span>
<span id="cb11-50">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-51">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>next_write_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_release<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-52">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-53">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-54"></span>
<span id="cb11-55">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> pop_front<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">){</span></span>
<span id="cb11-56">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_relaxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-57">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>head <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_tail</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>load<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_acquire<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb11-58">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-59"></span>
<span id="cb11-60">            v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_buffer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>head<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb11-61">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_read_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-62">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">m_head</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>next_read_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>memory_order_release<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb11-63">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-64">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb11-65"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<section id="why-do-we-use-a-power-of-2-buffer-size" class="level3">
<h3 class="anchored" data-anchor-id="why-do-we-use-a-power-of-2-buffer-size">Why do we use a power of <img src="https://latex.codecogs.com/png.latex?2"> buffer size?</h3>
<p>For a buffer of fixed capacity <img src="https://latex.codecogs.com/png.latex?N">, with current index <code>idx</code>, the index to the next element can be calculated as:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb12-1">next_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>curr_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> N</span></code></pre></div>
<p>This is because our queue is a ring buffer, so after the last slot, we will go back to the zeroeth one, then the first one and so on.</p>
<p>We can use the above method to get the next index for any buffer size <img src="https://latex.codecogs.com/png.latex?N">. Why do we then only use capacity that are powers of <img src="https://latex.codecogs.com/png.latex?2">? The answer is easy: performance. The modulo (<code>%</code>) operator requires a division instruction, which is expensive. When the size <img src="https://latex.codecogs.com/png.latex?N"> is a power of <img src="https://latex.codecogs.com/png.latex?2">, we can just do the following:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">size_t</span> next_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> curr_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div>
</section>
<section id="buffer-access-synchronization" class="level3">
<h3 class="anchored" data-anchor-id="buffer-access-synchronization">Buffer access synchronization</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://quantdev.blog/posts/spsc_lockfree_queue/diagram-20251206.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Synchronization</figcaption>
</figure>
</div>
<p>Here’s what the actual execution order looks like after we make the indices atomic.</p>
<p>If we look at the push thread, the incremented value of the tail, <code>next_write_index</code> written to <code>m_tail</code> index is a release operation. Over on the pop thread, when we load the <code>m_tail</code> index (take a snapshot of it), this is an acquire operation. The combination of release and acquire on the same atomic variable implies that <code>m_tail</code> store in the push thread synchronizes with <code>m_tail</code> load on the pop thread.</p>
<p>The instruction <code>m_buffer[tail] = item</code> cannot be moved to after the release barrier in actual CPU execution order. The instrusction <code>v=m_buffer[head]</code> cannot be moved to before the acquire barrier in actual CPU exection order. So, we have happens-before relationship between these two instructions.</p>
<p>The release of <code>m_head</code> in the pop thread synchronizes with the acquire of <code>m_head</code> in the push thread.</p>


</section>
</section>
</section>

 ]]></description>
  <category>C++</category>
  <guid>http://quantdev.blog/posts/spsc_lockfree_queue/index.html</guid>
  <pubDate>Fri, 05 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/spsc_lockfree_queue/cpp.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Pymalloc - Down the rabit hole</title>
  <dc:creator>Quasar </dc:creator>
  <link>http://quantdev.blog/posts/pymalloc_deep_dive/index.html</link>
  <description><![CDATA[ 




<section id="prerequisites" class="level1">
<h1>Prerequisites</h1>
<p>Download the CPython source and build it in the debug mode to step into the interpreter’s internals.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1">git clone https://github.com/python/cpython.git</span>
<span id="cb1-2">cd cpython</span>
<span id="cb1-3"></span>
<span id="cb1-4"># Configure with debug options</span>
<span id="cb1-5">./configure --with-pydebug</span>
<span id="cb1-6"></span>
<span id="cb1-7"># Build (feel free to adjust -j)</span>
<span id="cb1-8">make -j8</span></code></pre></div>
<p>This will produce a local python binary.</p>
</section>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>CPython is one of the many implementations of the Python runtime written in C code. There are other implementations such as PyPy, Jython. PyPy is a python compiler written in Python. PyPy’s logo is an Ouroboros to represent the self-hosting nature of the compiler. In this blog post, I summarize how object memory is alllocated and freed and how CPython manages memory leaks.</p>
<p>Python is a dynamically-typed language. The size of variables can’t be calculated at compile-time. Most of Python’s core types are dynamically sized. The <code>list</code> type can be of any size, a <code>dict</code> can have any number of keys, and even <code>int</code> is dynamic. The user never has to specify the size of these types. Names in Python can be reused for values of different types.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1">a_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-2">a_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Now, I'm a string"</span></span>
<span id="cb2-3">a_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Now"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"am"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>]</span></code></pre></div>
</div>
<p>To overcome these constraints, CPython relies heavily on dynamic memory allocation, but adds safety rails to automate the freeing of memory using the garbage collection and reference counting algorithms.</p>
<p>Instead of the Python developer having to allocate memory, Python object memory is allocated automatically by a single, unified API. This design requires that the entire CPython standard library and core modules(written in C) use this API.</p>
</section>
<section id="allocation-domains" class="level1">
<h1>Allocation Domains</h1>
<ul>
<li><p>The raw domain is used for allocation from the system heap and large, or non-object related memory.</p></li>
<li><p>The object domain is used for the allocation of all Python object related memory.</p></li>
<li><p>The PyMem domain is the same as <code>PYMEM_DOMAIN_OBJ</code>. this exists for legacy purposes.</p></li>
</ul>
<p>Each domain implements the same interface of frunctions:</p>
<ul>
<li><p><code>_Alloc(size_t size)</code> allocates memory of <code>size</code> bytes and returns a pointer.</p></li>
<li><p><code>_Calloc(size_t nelem, size_t el_size)</code> allocates <code>nelem</code> elements each of size <code>el_size</code> and returns a pointer.</p></li>
<li><p><code>_Realloc(void* ptr, size_t new_size)</code> reallocates memory of size <code>new_size</code>.</p></li>
<li><p><code>_Free(void* ptr)</code> frees memory at <code>ptr</code> back to the heap.</p></li>
</ul>
<p>The <code>PyMemAllocatorDomain</code> enumeration represents the three domains in CPython as <code>PYMEM_DOMAIN_RAW</code>, <code>PYMEM_DOMAIN_OBJ</code> and <code>PYMEM_DOMAIN_MEM</code>.</p>
<p>CPython uses <img src="https://latex.codecogs.com/png.latex?2"> memory allocators:</p>
<ul>
<li><code>malloc</code> is the operating system allocator for the raw memory domain.</li>
<li><code>pymalloc</code> is the CPython allocator the PyMem and object domains.</li>
</ul>
</section>
<section id="the-cpython-memory-allocator" class="level1">
<h1>The CPython memory allocator</h1>
<p>The CPython memory alloctor sit on top of the OS memory allocator and has an algorithm for allocation.</p>
<ul>
<li><p>Most of the memory allocation requests are small and of a fixed size, because <code>PyObject</code> is <img src="https://latex.codecogs.com/png.latex?16"> bytes, <code>PyASCIIObject</code> is <img src="https://latex.codecogs.com/png.latex?42"> bytes, <code>PyCompactUnicodeObject</code> is <img src="https://latex.codecogs.com/png.latex?72"> bytes.</p></li>
<li><p>The <code>pymalloc</code> allocator allocates memory blocks only upto <img src="https://latex.codecogs.com/png.latex?256"> KB. Anything larger is sent to the OS allocator.</p></li>
<li><p><code>pymalloc</code> uses the GIL instead of the system thread-safety check.</p></li>
</ul>
<p>To help clarify this situation, you can imagine a sports stadium, home of CPython FC, as an analogy. To help manage crowds, CPython FC has implemented a system breaking the stadium up into sections A to E, each with seating in rows <img src="https://latex.codecogs.com/png.latex?1"> to <img src="https://latex.codecogs.com/png.latex?40">.</p>
<p>At the front of the stadium, rows <img src="https://latex.codecogs.com/png.latex?1"> to <img src="https://latex.codecogs.com/png.latex?10"> are the roomier premium seats, with <img src="https://latex.codecogs.com/png.latex?80"> seats in each row. At the back rows <img src="https://latex.codecogs.com/png.latex?31"> to <img src="https://latex.codecogs.com/png.latex?40"> are the conomy seats with <img src="https://latex.codecogs.com/png.latex?150"> seats per row.</p>
<p>The Python memory allocation algorithm has similar characteristics:</p>
<ul>
<li>Just like the stadium as seats, the <code>pymalloc</code> algorithm has memory blocks.</li>
<li>Just like the seats can be premium, regular, or economy, memory blocks are all of range of fixed sizes. You can’t bring your desk chair!</li>
<li>Just like seats of the same size are put into rows, blocks of the same size are put into pools.</li>
</ul>
<p>A central register keeps a record of where blocks are and the number of blocks available in a pool, just as the stadium allocates seating. When a row in the stadium is full, the next row is used. When a pool of blocks is full, the next pool is used. Pools are groups into arenas, just like the stadium groups the rows into sections.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext itikz</span></code></pre></div>
</div>
<p>There are several advantages to this strategy:</p>
<ul>
<li>The algorithm is more performant for CPython’s main use case: small, short-lived objects.</li>
<li>The algorithm uses the GIL instead of system thread-lock detection.</li>
<li>The algorithm uses memory mapping <code>mmap()</code> syscall instead of heap allocations.</li>
</ul>
<p>The requested memory is always matched to a block size. Blocks of the same size are all put into the same <strong>pool</strong> of memory. Pools are grouped into arenas.</p>
<section id="blocks-pools-and-arenas" class="level2">
<h2 class="anchored" data-anchor-id="blocks-pools-and-arenas">Blocks, Pools and Arenas</h2>
<p><code>pymalloc</code> allocates large memory regions called arenas from the system, then divides them into pools.</p>
<section id="arenas" class="level3">
<h3 class="anchored" data-anchor-id="arenas">Arenas</h3>
<p>Arenas are allocated from the system heap using <code>mmap</code> when available otherwise <code>malloc</code>. CPython arenas are <img src="https://latex.codecogs.com/png.latex?256">-KB on 32-bit systems and <img src="https://latex.codecogs.com/png.latex?1"> MB on 64-bit systems. Each arena contains multiple pools.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#ifdef USE_LARGE_ARENAS</span></span>
<span id="cb4-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_BITS              </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                    </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 1 MiB */</span></span>
<span id="cb4-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#else</span></span>
<span id="cb4-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_BITS              </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                    </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 256 KiB */</span></span>
<span id="cb4-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#endif</span></span>
<span id="cb4-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_SIZE              </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span>ARENA_BITS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define ARENA_SIZE_MASK         </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ARENA_SIZE<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<p>Arenas are scattered in the main memory. Each arena is a contiguous chunk of memory. CPython maintains a doubly linked list <code>usable_arenas</code> that tracks all the arena objects, that have atleast one pool available for allocation. The <code>usable_arenas</code> list is maintained in ascending order of each arena’s <code>nfreepools</code> (number of free pools). This sorting ensures that allocations preferentially use arenas with fewest free pools.</p>
<p>Our main book-keeping data structure of interest is the <code>arena_object</code>. The <code>usable_arenas</code> doubly linked list strings together <code>arena_object</code> nodes . These contain meta-information of each arena with <code>prevarena</code> and <code>nextarena</code> pointers. Each of these nodes have a <code>address</code> field which is a pointer to the actual contiguous block of memory (<img src="https://latex.codecogs.com/png.latex?256">KB / <img src="https://latex.codecogs.com/png.latex?1">MB) returned by <code>malloc</code>.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Record keeping for arenas. */</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> arena_object <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* The address of the arena, as returned by malloc.  Note that 0</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * will never be returned by a successful malloc, and is used</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * here to mark an arena_object that doesn't correspond to an</span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * allocated arena.</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     */</span></span>
<span id="cb5-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uintptr_t</span> address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9"></span>
<span id="cb5-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Pool-aligned pointer to the next pool to be carved off. */</span></span>
<span id="cb5-11">    pymem_block<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pool_address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-12"></span>
<span id="cb5-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* The number of available pools in the arena:  free pools + never-</span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * allocated pools.</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     */</span></span>
<span id="cb5-16">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> nfreepools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-17"></span>
<span id="cb5-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* The total number of pools in the arena, whether or not available. */</span></span>
<span id="cb5-19">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> ntotalpools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-20"></span>
<span id="cb5-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Singly-linked list of available pools. */</span></span>
<span id="cb5-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> freepools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Whenever this arena_object is not associated with an allocated</span></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * arena, the nextarena member is used to link all unassociated</span></span>
<span id="cb5-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * arena_objects in the singly-linked `unused_arena_objects` list.</span></span>
<span id="cb5-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * The prevarena member is unused in this case.</span></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     *</span></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * When this arena_object is associated with an allocated arena</span></span>
<span id="cb5-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * with at least one available pool, both members are used in the</span></span>
<span id="cb5-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * doubly-linked `usable_arenas` list, which is maintained in</span></span>
<span id="cb5-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * increasing order of `nfreepools` values.</span></span>
<span id="cb5-32"></span>
<span id="cb5-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     *</span></span>
<span id="cb5-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * Else this arena_object is associated with an allocated arena</span></span>
<span id="cb5-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * all of whose pools are in use.  `nextarena` and `prevarena`</span></span>
<span id="cb5-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     * are both meaningless in this case.</span></span>
<span id="cb5-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     */</span></span>
<span id="cb5-38"></span>
<span id="cb5-39">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> arena_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nextarena<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-40">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> arena_object<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prevarena<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-41"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p><code>pool_address</code> serves as the arena’s <strong>high water mark</strong> pointer that tracks where to carve off the next pool. It’s initialized when an arena is created and advances as pools are allocated.</p>
<p>Each <code>arena_object</code> node also contains a field <code>freepools</code> of the type <code>pool_header*</code> which points to the head of a linked list which tracks available pools in the arena.</p>
<p>When an arena’s <code>nfreepools</code> reaches zero (all pools allocated), it’s removed from <code>usable_arenas</code> linked list. Conversely, when a pool becomes empty and is added to an arena’s freepools, the arena may be added back to <code>usable_arenas</code> if it was previously full.</p>
</section>
<section id="pools" class="level3">
<h3 class="anchored" data-anchor-id="pools">Pools</h3>
<p>Pools are <img src="https://latex.codecogs.com/png.latex?4">KB subdivisions (or <img src="https://latex.codecogs.com/png.latex?16"> Kb on large systems) of arenas. Normally, the size of the pool is equal to the size of a memory page. Limiting pool to the fixed size of blocks helps with fragmentation. Each pool manages blocks of single size class and can be in three states:</p>
<ul>
<li>Used : Partially allocated blocks.</li>
<li>Full : All blocks allocated.</li>
<li>Empty : All blocks available.</li>
</ul>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * Size of the pools used for small blocks.  Must be a power of 2.</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#ifdef USE_LARGE_POOLS</span></span>
<span id="cb6-6"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define POOL_BITS               </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 16 KiB */</span></span>
<span id="cb6-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#else</span></span>
<span id="cb6-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define POOL_BITS               </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">                  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* 4 KiB */</span></span>
<span id="cb6-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#endif</span></span>
<span id="cb6-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define POOL_SIZE               </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span>POOL_BITS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<p>Each pool has a special header structure:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* Pool for small blocks. */</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-3"></span>
<span id="cb7-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">union</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> pymem_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>_padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-5">            <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> ref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* number of allocated blocks    */</span></span>
<span id="cb7-6"></span>
<span id="cb7-7">    pymem_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>freeblock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* pool's free list head         */</span></span>
<span id="cb7-8"></span>
<span id="cb7-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>nextpool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* next pool of this size class  */</span></span>
<span id="cb7-10"></span>
<span id="cb7-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> pool_header <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>prevpool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* previous pool of this size class                             */</span></span>
<span id="cb7-12"></span>
<span id="cb7-13">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> arenaindex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* index into arenas of base adr */</span></span>
<span id="cb7-14"></span>
<span id="cb7-15">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> szidx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* block size class index        */</span></span>
<span id="cb7-16"></span>
<span id="cb7-17">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> nextoffset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* bytes to virgin block         */</span></span>
<span id="cb7-18"></span>
<span id="cb7-19">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uint</span> maxnextoffset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* largest valid nextoffset      */</span></span>
<span id="cb7-20"></span>
<span id="cb7-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<p>Pools of the same sized blocks are linked together using doubly linked list (the <code>nextpool</code> and <code>prevpool</code> fields). The <code>szidx</code> field keeps the size class index, whereas <code>ref.count</code> keeps the number of used blocks. The <code>arenaindex</code> stores the number of an arena in which this pool was created.</p>
<p>In order to efficient manage pools, a pool table called <code>usedpools</code> is maintained. A pool table is an array of pointers. It is segmented by the size class index <code>i</code>. For an index <code>i</code>, <code>usedpools[i+1]</code> points to the head of linked list of all partial used pools of the same size class <code>i</code>. Each node of this linked list is of type <code>pool_header</code>.</p>
<p>If a full pool has a block freed, then the pool is put back in the used state. The newly freed pool is added to the front of the approapriate <code>usedpools[]</code> list, so the next allocation for its size class will use the freed block.</p>
<p>On transition to empty, a pool is unlinked from its <code>usedpools[]</code> list and added to the front of the arena’s singly linked <code>freepools</code> list.</p>
</section>
<section id="blocks" class="level3">
<h3 class="anchored" data-anchor-id="blocks">Blocks</h3>
<p>Blocks are the actual allocated units, with sizes ranging from <img src="https://latex.codecogs.com/png.latex?8"> to <img src="https://latex.codecogs.com/png.latex?512"> bytes in <img src="https://latex.codecogs.com/png.latex?8">-byte increments.</p>
<table class="table">
<thead>
<tr class="header">
<th>Request in bytes</th>
<th>Size of the allocated block</th>
<th>Size class index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1-8</td>
<td>8</td>
<td>0</td>
</tr>
<tr class="even">
<td>9-16</td>
<td>16</td>
<td>1</td>
</tr>
<tr class="odd">
<td>17-24</td>
<td>24</td>
<td>2</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>505-512</td>
<td>512</td>
<td>63</td>
</tr>
</tbody>
</table>
<p>On a 64-bit system, since an arena is <img src="https://latex.codecogs.com/png.latex?1"> MB, there will always be <img src="https://latex.codecogs.com/png.latex?64"> pools each of size <img src="https://latex.codecogs.com/png.latex?16">KB.</p>
<p>Within a pool, blocks of fixed size can be allocated and freed. Available blocks within a pool are listed in the singly linked list <code>freeblock</code>. Whenever a block is freed, its inserted at the front of the <code>freeblock</code> list. When a pool is initialized, only the first two blocks are linked within the <code>freeblock</code> list.</p>
</section>
<section id="block-allocation-api" class="level3">
<h3 class="anchored" data-anchor-id="block-allocation-api">Block allocation API</h3>
<p>When a block of memory is requested by a memory domain that uses <code>pymalloc</code>, the API function <code>pymalloc_alloc()</code> is invoked. This function is a good place to insert a break-point and step through the code to test your knowledge of blocks, pools and arenas.</p>
</section>
</section>
</section>
<section id="cpython-interning" class="level1">
<h1>CPython interning</h1>
<p>The general rule is that objects are allocated on assignment. Variables just point to objects. There is an exception to this general rule. This is python runtime implementation specific. Often commonly used objects are preallocated and are shared instead of costly new allocations. This is mainly done for performance optimization.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb8-2">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb8-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> y, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> y)</span>
<span id="cb8-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb8-5">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb8-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> y, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> y)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True True
False True</code></pre>
</div>
</div>
<p><code>int</code>s in the range <img src="https://latex.codecogs.com/png.latex?%5B-5,257)">, empty tuples and all empty or single length strings are preallocated.</p>
<section id="string-interning-explained" class="level2">
<h2 class="anchored" data-anchor-id="string-interning-explained"><code>string</code> interning explained</h2>
<p>String interning is a method of storing only one copy of each distinct string value, which must be immutable. In Python3, we have a function <code>sys.intern()</code> and if we use this function, we can enter a string in the table of interned strings. We get a reference to the interned string.</p>
<p>So, we can gain a little extra performance on dictionary lookup (key comparisons after hashing can be done by a pointer compare instead of a string compare).</p>
<p>Names used in programs are automatically interned. Dictionaries used to hold module, class or instance attributes have interned keys.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sys <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">intern</span></span>
<span id="cb10-2">a, b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"strin"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb10-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'g'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Returns false</span></span>
<span id="cb10-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">intern</span>(a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'g'</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">intern</span>(b) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># returns True</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>False</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
<section id="mutable-containers-memory-allocationn-strategy" class="level1">
<h1>Mutable containers memory allocationn strategy</h1>
<p>There are different mutable containers in Python - <code>list</code>s, <code>set</code>s and <code>dict</code>s. Behind the scenes, there is a strategy for allocating these containers.</p>
<p>A good strategy will plan for growth and shrinkage. It will slightly overallocate memory needed by the container, to leave room for growth. Each time we append to a <code>list</code>, we won’t have to reallocate the memory. We also have to remember that sometimes we have to shrink the memory for a mutable container. This can help reduce the number of expensive function calls for instance to <code>realloc</code> or <code>memcpy</code>.</p>
</section>
<section id="list-allocation-strategy" class="level1">
<h1>List allocation strategy</h1>
<p>Lists are stored as fixed length array of pointers. So, we just point to objects. By design, we overallocate for list growth by append.</p>
<ul>
<li>The capacity growth pattern is roughly <img src="https://latex.codecogs.com/png.latex?4,8,16,25,35,46,%5Cldots"></li>
</ul>
<p>If we put something at the end of the list, these operations are cheap. But, if we put something in the middle or the beginning, we’ll have to copy/shift the elements in memory to perform this operation.</p>
<p>On my 64-bit machine, with Python 3.13.7, the list allocation size is:</p>
<ul>
<li>64 bits : <code>56 + 8 * length</code></li>
</ul>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb13-2">l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb13-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>):</span>
<span id="cb13-4">    l.append(i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"List len = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(l)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, size = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getsizeof(l)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> bytes"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List len = 1, size = 88 bytes
List len = 2, size = 88 bytes
List len = 3, size = 88 bytes
List len = 4, size = 88 bytes
List len = 5, size = 120 bytes
List len = 6, size = 120 bytes
List len = 7, size = 120 bytes
List len = 8, size = 120 bytes
List len = 9, size = 184 bytes
List len = 10, size = 184 bytes
List len = 11, size = 184 bytes
List len = 12, size = 184 bytes
List len = 13, size = 184 bytes
List len = 14, size = 184 bytes
List len = 15, size = 184 bytes
List len = 16, size = 184 bytes
List len = 17, size = 248 bytes</code></pre>
</div>
</div>
<p>There is a fixed overhead of <img src="https://latex.codecogs.com/png.latex?56"> bytes (the object header, type pointer, reference count ) etc.</p>
<p>For each size tier, the calculation is approximately:</p>
<ul>
<li>88 bytes = 56 + 32(4 slots)</li>
<li>120 bytes = 56 + 64(8 slots)</li>
<li>184 bytes = 56 + 128(16 slots)</li>
<li>248 bytes =56 + 192(24 slots)</li>
</ul>
<p>We shrink when the list size goes below <img src="https://latex.codecogs.com/png.latex?1/2"> of the allocated storage. This is why appending to Python lists is <img src="https://latex.codecogs.com/png.latex?O(1)"> amortized time - most appends just fill unused capacity, and only occasional appends trigger a reallocation.</p>
</section>
<section id="overallocation-of-dictionaries-and-sets" class="level1">
<h1>Overallocation of dictionaries and sets</h1>
<p>These are represented as fixed-length hash tables. We overallocate when we reach <img src="https://latex.codecogs.com/png.latex?2/3">rd of the capacity of a dictionary of set. For small dictionaries or sets, we quadruple the capacity else we double the capacity.</p>


</section>

 ]]></description>
  <category>Python</category>
  <guid>http://quantdev.blog/posts/pymalloc_deep_dive/index.html</guid>
  <pubDate>Thu, 27 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="http://quantdev.blog/posts/pymalloc_deep_dive/python.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
